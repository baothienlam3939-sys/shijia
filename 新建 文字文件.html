

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>朱门绣户 · 养成札记</title>
<link 
href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ======================================================================= */
/* ===================== 【新增】古筝小游戏专属样式 (v3) =================== */
/* ======================================================================= */
.guzheng-game-container {
    width: 100%;
    max-width: 400px;
    height: 450px;
    background: linear-gradient(to bottom, #2c3e50, #46425e);
    border: 2px solid #bda27e;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    margin: 15px auto 5px;
    display: flex;
    justify-content: space-around;
    padding: 0 10px;
}

.guzheng-string {
    width: 2px;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.2);
    position: relative;
}

.guzheng-note {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: transparent;
    font-size: 30px;
    color: var(--particle-color);
    text-align: center;
    line-height: 40px;
    animation: fall linear forwards;
}

@keyframes fall {
    from { top: -40px; transform: translateX(-50%) rotate(0deg); }
    to { top: 100%; transform: translateX(-50%) rotate(360deg); }
}

.guzheng-hit-line {
    position: absolute;
    bottom: 10%;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(255, 215, 0, 0.8);
    box-shadow: 0 0 10px 2px #FFD700;
    z-index: 2; /* 确保判定线在最上层 */
}

/* [核心新增] 完美区域的样式 */
.guzheng-perfect-zone {
    position: absolute;
    bottom: calc(10% - 18px); /* (判定线位置 - 区域高度的一半) + 判定线高度一半 */
    left: 0;
    width: 100%;
    height: 40px; /* 完美区域的高度 */
    background: rgba(255, 255, 255, 0.1);
    border-top: 1px dashed rgba(255, 255, 255, 0.3);
    border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
    z-index: 1;
}

.guzheng-hit-buttons-container {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-around;
    padding: 0 10px;
}

.guzheng-hit-button {
    flex: 1;
    height: 60px;
    margin: 0 5px;
    border: 2px solid var(--decorator-color);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.1s ease;
}

.guzheng-hit-button:active, .guzheng-hit-button.active {
    background: var(--highlight-strong);
    transform: scale(0.98);
}

.guzheng-feedback {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    font-weight: bold;
    color: white;
    text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
    opacity: 0;
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    pointer-events: none;
    z-index: 3;
}
.guzheng-feedback.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
}

/* 【新增】这段CSS代码可以放在<style>标签的任意位置 */
.quantity-slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
}
.quantity-slider-container input[type="range"] {
    flex-grow: 1;
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: var(--progress-bg);
    border-radius: 5px;
    outline: none;
}
.quantity-slider-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--highlight-strong);
    cursor: pointer;
    border-radius: 50%;
}
.quantity-slider-container input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--highlight-strong);
    cursor: pointer;
    border-radius: 50%;
}
.quantity-slider-container input[type="number"] {
    width: 70px;
    text-align: center;
    font-size: 1.1rem;
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    padding: 5px;
}
.inventory-container { display: flex; flex-direction: column; gap: 10px; max-height: 250px; overflow-y: auto; padding-right: 5px;}
.inventory-item { display: flex; align-items: center; background: var(--event-bg); padding: 10px; border-radius: 8px; border-left: 4px solid var(--decorator-color); }
.inventory-item-icon { font-size: 1.5rem; margin-right: 15px; color: var(--highlight-strong); width: 30px; text-align:center; }
.inventory-item-details { flex-grow: 1; }
.inventory-item-name { font-weight: bold; }
.inventory-item-type { font-size: 0.8em; background: var(--progress-bg); padding: 2px 6px; border-radius: 10px; margin-left: 5px; color: var(--text-color); }
.inventory-item-desc { font-size: 0.9em; color: var(--text-comment); margin-top: 4px; }
/* --- 全局与基础样式 --- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Noto Serif SC', serif;
    transition: all 0.3s ease;
}

html {
    width: 100%;
    height: 100%;
}
body {
    width: 100%;
    min-height: 100%; /* 允许内容超出屏幕时页面可以滚动 */
    overflow-x: hidden; /* 防止横向滚动 */
    color: var(--text-color);
    padding: 10px;
    font-size: 16px;
    position: relative;
    background: var(--bg-gradient);
    display: flex;
    flex-direction: column;
}
.container-wrapper {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--decorator-color) transparent;
}
.container-wrapper::-webkit-scrollbar {
    width: 5px;
}
.container-wrapper::-webkit-scrollbar-track {
    background: transparent;
}
.container-wrapper::-webkit-scrollbar-thumb {
    background-color: var(--decorator-color);
    border-radius: 10px;
    border: 3px solid transparent;
}


.container {
    max-width: 100%;
    margin: 0 auto;
    padding-bottom: 20px;
}

/* --- 主题切换 --- */
.theme-switcher {
    position: absolute;
    top: 18px;
    right: 18px;
    display: flex;
    gap: 5px;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px;
    border-radius: 20px;
    z-index: 100;
    backdrop-filter: blur(5px);
}
.theme-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
}
.theme-icon.active {
    border-color: var(--accent-color-deep);
    transform: scale(1.2);
}
#theme-spring { background: #ffc0cb; color: #fff; }
#theme-summer { background: #98fb98; color: #fff; }
#theme-autumn { background: #ffdab9; color: #fff; }
#theme-winter { background: #add8e6; color: #fff; }
#theme-night { background: #46425e; color: #fff; }


/* --- 游戏主卡片样式 --- */
.game-block {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 20px;
    padding: 18px;
    margin-bottom: 18px;
    font-family: 'Noto Serif SC', serif;
    color: var(--text-color);
    line-height: 1.8;
    box-shadow: 0 6px 20px var(--shadow-color);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    overflow-x: hidden;
    word-wrap: break-word;
}

.game-block p { margin-bottom: 8px; }
.game-block strong { color: var(--highlight-strong); }
.game-block .value { color: var(--highlight-value); font-weight: bold; }
.game-block .comment { color: var(--text-comment); font-style: italic; font-size: 0.9em; }
.game-block .highlight-npc { color: var(--highlight-npc); font-weight: bold; cursor: pointer; }
.game-block .highlight-npc:hover { text-decoration: underline; }
.game-block .highlight-secret { color: #c0392b; font-weight: bold; text-shadow: 0 0 5px rgba(255, 100, 100, 0.7); }


/* --- 卡片通用样式 --- */
.card-header {
    text-align: center;
    margin-bottom: 20px;
    color: var(--header-color);
    font-size: 1.6rem;
    font-weight: bold;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color-light);
    position: relative;
    font-family: 'Ma Shan Zheng', cursive;
}

.card-header::before, .card-header::after {
    content: var(--header-decorator);
    margin: 0 10px;
    color: var(--decorator-color);
    font-size: 1.2rem;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* --- 动态飘洒效果 --- */
.particle-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; overflow: hidden; z-index: 9999;
}

.particle {
    position: absolute;
    opacity: 0.7;
    animation: fall linear forwards;
    background-size: contain;
    background-repeat: no-repeat;
    font-size: 20px;
    color: var(--particle-color);
    user-select: none;
}

@keyframes fall {
    to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* --- 玩家信息与属性条 --- */
.character-info { display: flex; align-items: center; margin-bottom: 20px; gap: 18px; }
.avatar-wrapper {
    position: relative;
    width: 100px; height: 100px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: var(--avatar-bg);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 4px solid #fff;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
}
.avatar-image {
    width: 100%; height: 100%; object-fit: cover;
    position: absolute; top: 0; left: 0;
    display: none; /* 默认隐藏 */
}
.avatar-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
.info-details { flex: 1; position: relative; }
.info-row { display: flex; margin-bottom: 8px; font-size: 0.95rem; align-items: center; }
.info-label { width: 80px; font-weight: bold; color: var(--info-label-color); }
.attributes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 15px;}
.attribute { margin-bottom: 15px; }
.attribute-name { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.95rem; }
.progress-bar { height: 14px; background-color: var(--progress-bg); border-radius: 7px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
.progress-fill { height: 100%; border-radius: 7px; background: var(--progress-fill-talent); transition: width 0.5s ease-out; }
.talent-fill { background: var(--progress-fill-talent); }
.etiquette-fill { background: var(--progress-fill-etiquette); }
.wisdom-fill { background: var(--progress-fill-wisdom); }
.health-fill { background: var(--progress-fill-health); }
.virtue-fill { background: var(--progress-fill-virtue); }
.charm-fill { background: var(--progress-fill-charm); }
.martial-fill { background: var(--progress-fill-martial); }


/* --- 顶部状态栏 --- */
.status-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}
.status-item {
    background: var(--status-item-bg);
    padding: 10px 15px; border-radius: 20px; font-size: 0.9rem;
    display: flex; align-items: center; border: 1px solid var(--status-border-color);
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
}
.status-item i { margin-right: 8px; color: var(--status-icon-color); }
.status-item.disease { background: linear-gradient(to right, #fff0f0, #ffe8e8); border-color: #ffcccc; color: #c0392b; }
.status-item.disease i { color: #c0392b; }

/* --- 标签页系统 --- */
.tab-container {
    display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--tab-border-color); overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
}
.tab-container::-webkit-scrollbar { display: none; }
.tab {
    padding: 12px 18px; cursor: pointer; border-bottom: 4px solid transparent;
    white-space: nowrap; font-size: 1rem; border-radius: 8px 8px 0 0;
    flex-shrink: 0;
    color: var(--tab-color);
}
.tab:hover { background-color: var(--tab-hover-bg); color: var(--tab-hover-color); }
.tab.active { border-bottom: 4px solid var(--tab-active-border); color: var(--tab-active-color); font-weight: bold; background-color: var(--tab-active-bg); }
.tab.disabled {
    color: var(--text-comment);
    cursor: not-allowed;
    background-color: transparent;
    opacity: 0.6;
}
.tab.disabled:hover { background-color: transparent; }
.tab-content { display: none; animation: fadeIn 0.5s forwards; }
.tab-content.active { display: block; }

.section-header {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.1rem;
    color: var(--highlight-strong);
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--border-color-light);
    display:flex; align-items:center;
}
.section-header i { margin-right:8px; font-size:1.2rem; }


/* --- 选项与控制按钮 --- */
.options { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
.option {
    background: var(--option-bg);
    color: white; border: none; border-radius: 30px;
    padding: 15px 22px; width: 100%;
    text-align: left; cursor: pointer; font-size: 1rem;
    box-shadow: 0 5px 15px var(--option-shadow);
    display: flex; align-items: center; position: relative; overflow: hidden;
}
.option:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--option-shadow-hover); }
.option:active { transform: translateY(0); box-shadow: 0 2px 5px var(--option-shadow-active); }
.option i { margin-right: 12px; font-size: 1.3rem; width: 20px; text-align: center; }
.option .option-text { flex-grow: 1; }
.option .option-text small { display: block; opacity: 0.85; font-size: 0.8em; margin-top: 4px; }
.option:disabled {
    background: #dcdcdc !important;
    cursor: not-allowed;
    box-shadow: none; transform: none; opacity: 0.7;
}

.controls { display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; flex-wrap: wrap; }
.control-btn {
    background: var(--control-bg);
    color: white; border: none; border-radius: 30px;
    padding: 14px 18px; cursor: pointer; font-size: 0.95rem; flex: 1;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 5px 15px var(--control-shadow);
    min-width: 120px;
    transition: all 0.2s ease-in-out;
}
.control-btn i { margin-right: 8px;}
.control-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--control-shadow-hover); }
.control-btn:active { transform: translateY(0); box-shadow: 0 2px 5px var(--control-shadow-active); }

/* --- 内容样式 --- */
.event-log { max-height: 400px; overflow-y: auto; padding-right: 10px; }
.event-log::-webkit-scrollbar { width: 6px; }
.event-log::-webkit-scrollbar-thumb { background-color: var(--decorator-color); border-radius: 10px; }
.event {
    background: var(--event-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px;
    border-left: 5px solid var(--event-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    animation: fadeIn 0.3s ease-out;
}
.event-content { line-height: 1.7; font-size: 0.98rem; }

/* --- 婚恋与子嗣卡片 --- */
.suitor {
    display: flex; padding: 15px; margin-bottom: 12px;
    background: var(--suitor-bg);
    border-radius: 12px; border: 1px solid var(--suitor-border); align-items: center; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: all 0.2s ease-in-out;
}
.suitor:hover { box-shadow: 0 4px 12px var(--suitor-shadow-hover); transform: translateY(-3px); }
.suitor-avatar-wrapper {
    width: 60px; height: 60px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-right: 15px; flex-shrink: 0;
    overflow: hidden;
    position: relative;
    border: 3px solid rgba(255,255,255,0.8);
    background:var(--avatar-bg);
}
.suitor-avatar { width: 100%; height: 100%; object-fit: cover; }
.suitor-avatar-text { font-size: 2.2rem; color: white; font-family: 'Ma Shan Zheng', cursive; }
.suitor-details { flex: 1; }
.suitor-name { font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; }
.suitor-desc { font-size: 0.9rem; color: var(--text-comment); line-height: 1.5; }
.suitor-stats { display: flex; margin-top: 8px; gap: 10px; flex-wrap: wrap; }
.stat { font-size: 0.8rem; background: var(--stat-bg); padding: 4px 10px; border-radius: 15px; color: var(--stat-color); }
.stat i { margin-right: 5px; }

.child-card {
    background: linear-gradient(to right, #fffcf0, #fff5e6);
    padding: 15px; border-radius: 12px; margin-bottom: 12px;
    border-left: 5px solid #ffd47a;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    display: flex; align-items: center; gap: 15px;
}
.child-name { font-weight: bold; color: #cc8433; margin-bottom: 8px; display: flex; align-items: center; font-size: 1.1rem; }
.child-name i { margin-right: 10px; font-size: 1.2rem; }
.child-details { font-size: 0.95rem; line-height: 1.6; flex: 1;}
.child-btn-group { display: flex; flex-direction: column; gap: 8px;}
.child-cultivate-btn {
    background: linear-gradient(135deg, #f4a261, #e76f51); color: white;
    border: none; border-radius: 20px; padding: 10px 15px;
    font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    flex-shrink: 0;
}
.concubine-card {
    background: linear-gradient(to right, #fcfcfc, #fef5f8);
    padding: 15px; border-radius: 12px; margin-bottom: 12px;
    border-left: 5px solid #ffbfd3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.concubine-name { font-weight: bold; color: #e06c9e; margin-bottom: 8px; display: flex; align-items: center; font-size: 1.1rem; }
.concubine-name i { margin-right: 10px; font-size: 1.2rem; }
.concubine-details { font-size: 0.95rem; line-height: 1.6; }
.intimate-scene {
    font-size: 0.95em; color: #880044; background: #fff0f5;
    padding: 12px; border-radius: 8px; margin-top: 10px;
    border-left: 4px solid #ff69b4; font-style: italic;
}
.intimate-scene i { color: #d84381; margin-right: 5px; }

/* --- 华丽婚礼 & 传承界面 --- */
.overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--overlay-bg);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 10000; animation: fadeIn 0.5s forwards;
    display: none; padding: 10px;
}
.overlay-card {
    background: var(--card-bg);
    border-radius: 25px; padding: 35px; text-align: center; width: 100%; max-width: 500px;
    box-shadow: 0 12px 35px var(--overlay-shadow); border: 2px solid var(--overlay-border);
    position: relative; overflow: hidden;
}
.overlay-close-btn {
    position: absolute; top: 15px; right: 15px;
    background: rgba(0,0,0,0.1); color: var(--text-color);
    border: none; width: 30px; height: 30px;
    border-radius: 50%; font-size: 1.2rem;
    cursor: pointer; line-height:30px;
}
.overlay-close-btn:hover { background: rgba(0,0,0,0.2); }
.overlay-content-wrapper {
    max-height: calc(85vh - 150px);
    overflow-y: auto;
    padding: 0 15px;
    margin-bottom: 20px;
    scrollbar-width: thin;
    scrollbar-color: var(--highlight-strong) transparent;
}
.overlay-content-wrapper::-webkit-scrollbar { width: 5px; }
.overlay-content-wrapper::-webkit-scrollbar-thumb { background-color: var(--highlight-strong); border-radius: 10px;}

.overlay-header { font-size: 2.2rem; color: var(--overlay-header-color); margin-bottom: 25px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); font-family: 'Ma Shan Zheng', cursive; }
.overlay-content { line-height: 1.8; margin-bottom: 15px; color: var(--text-color); }
.overlay-name { font-weight: bold; color: var(--overlay-header-color); font-size: 1.4rem; margin: 10px 0; display: inline-block; }
.overlay-animation { font-size: 3.5rem; margin: 20px 0; animation: float 3s infinite ease-in-out; color: var(--overlay-animation-color); }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

/* NPC Detail & Other Specific Overlays */
#npcDetailOverlay .overlay-card, #clinicOverlay .overlay-card, #careerChallengeOverlay .overlay-card, #debugOverlay .overlay-card, #fengYueJianOverlay .overlay-card, #arrangedMarriageOverlay .overlay-card, #childMarriageOverlay .overlay-card, #newFriendEncounterOverlay .overlay-card, #matchmakerOverlay .overlay-card {
    text-align: left; padding: 30px;
}
#npcDetailOverlay .overlay-header, #clinicOverlay .overlay-header, #careerChallengeOverlay .overlay-header, #debugOverlay .overlay-header, #fengYueJianOverlay .overlay-header, #arrangedMarriageOverlay .overlay-header, #childMarriageOverlay .overlay-header, #newFriendEncounterOverlay .overlay-header, #matchmakerOverlay .overlay-header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; }
#npcDetailOverlay .npc-detail-section {
    margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color-light);
}
#npcDetailOverlay .npc-detail-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
#npcDetailOverlay .npc-detail-section h4 {
    color: var(--highlight-strong); font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center;
}
#npcDetailOverlay .npc-detail-section h4 i { margin-right: 8px; font-size: 1.2rem; }
#npcDetailOverlay .npc-detail-section p { font-size: 0.95rem; line-height: 1.6; margin-bottom: 5px; }
#npcDetailOverlay .npc-detail-section .attribute { margin-bottom: 8px; }
#debugOverlay .input-group { margin-top: 15px; }
#debugOverlay .input-group input, #debugOverlay .input-group select {
    width: calc(100% - 20px); padding: 10px; border-radius: 8px; display: block;
    border: 1px solid var(--border-color-light); margin: 0 auto 10px; font-size:1rem;
}

/* Child Naming Overlay */
#nameChildOverlay .overlay-card { max-width: 80%; padding: 25px; }
#nameChildOverlay input {
    width: calc(100% - 20px); padding: 12px; margin: 15px auto; display: block;
    border-radius: 10px; border: 1px solid var(--border-color-light);
    font-size: 1.1rem; color: var(--text-color); text-align: center;
}
#nameChildOverlay input:focus {
    outline: none; border-color: var(--highlight-strong);
    box-shadow: 0 0 5px var(--shadow-color);
}
#rankingsOverlay .ranking-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color-light); align-items: center; }
#rankingsOverlay .ranking-item.player { background: var(--border-color-light); font-weight: bold; }
.rank-num { font-weight: bold; color: var(--highlight-strong); width: 30px; text-align: center;}


/* --- 其他 --- */
.loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--loading-bg);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 10001; font-size: 1.3rem; color: var(--loading-text);
}
.loading-spinner {
    width: 60px; height: 60px; border: 6px solid var(--loading-spinner-bg);
    border-radius: 50%; border-top-color: var(--loading-spinner-fg);
    animation: spin 1s linear infinite; margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background-color: rgba(90, 45, 82, 0.9); color: white;
    padding: 15px 30px; border-radius: 30px; z-index: 10002;
    opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 1rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    pointer-events: none;
}
.toast.show { opacity: 1; bottom: 50px; }
.marketplace-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 0; border-bottom: 1px dashed var(--border-color-light);
}
.marketplace-item:last-child { border-bottom: none; }
.marketplace-item span { color: var(--text-color); }
.marketplace-item button {
    background: var(--control-bg); color: white; border: none; padding: 8px 12px;
    border-radius: 20px; cursor: pointer; font-size: 0.85rem;
    flex-shrink: 0;
    margin-left: 10px;
}

/* Save/Load Overlay */
.save-slot {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid var(--border-color);
    border-radius: 15px; padding: 15px; margin-bottom: 12px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer;
}
.save-slot:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.save-slot.empty { background: rgba(255, 255, 255, 0.4); font-style: italic; color: #888; }
.slot-info { flex-grow: 1; }
.slot-info .slot-title { font-weight: bold; color: var(--highlight-strong); margin-bottom: 5px; }
.slot-info .slot-details { font-size: 0.9em; color: var(--text-comment); }
.slot-actions button {
    background: none; border: none; font-size: 1.2rem; cursor: pointer;
    margin-left: 10px; color: #ff6b6b;
}
.slot-actions button:hover { color: #e74c3c; }

.decision-options {
    display: flex; justify-content: center; gap: 20px; margin-top: 25px; flex-wrap: wrap;
}

/* [替换] 移动端优化代码 */
@media (max-width: 768px) { /* 使用 768px 兼容更多设备 */
    body {
        padding: 5px;
        font-size: 15px; /* 调整基础字号 */
    }
    .game-block {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 15px; /* 更圆润的卡片 */
    }
    .card-header {
        font-size: 1.5rem;
    }
    .character-info {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    .info-details {
        width: 100%;
    }
    .info-row {
        justify-content: center;
    }
    .attributes-grid {
        grid-template-columns: 1fr; /* 属性单列显示 */
        gap: 0;
    }
    .status-bar {
        grid-template-columns: 1fr 1fr; /* 状态栏两列显示 */
    }
    .tab-container {
        flex-wrap: wrap; /* 标签页允许换行 */
        justify-content: center;
    }
    .tab {
        padding: 10px 15px;
        font-size: 0.95rem;
    }
    .options {
        gap: 10px;
    }
    .option {
        padding: 12px 20px;
        font-size: 0.95rem;
    }
    .controls {
        flex-direction: row;
        flex-wrap: wrap;
    }
    .control-btn {
        min-width: calc(50% - 5px); /* 确保一行两个按钮 */
        padding: 12px 15px;
    }
    .suitor {
        flex-direction: column;
        text-align: center;
    }
    .suitor-avatar-wrapper {
        margin: 0 auto 15px;
    }
    .suitor-stats {
        justify-content: center;
    }
    .child-card {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    .child-btn-group {
        margin-top: 10px;
        flex-direction: row;
        justify-content: center;
    }
    .overlay-card {
        padding: 25px 15px;
        width: 95%;
        max-height: 90vh;
    }
    .overlay-header {
        font-size: 1.8rem;
        margin-bottom: 15px;
}
/* 【修复】粘贴这段代码到 @media (max-width: 768px) { ... } 代码块的内部 */
.tab-container {
    flex-direction: column; /* 让主标签组和工具标签组垂直堆叠 */
    align-items: center;    /* 让两组在垂直轴线上居中 */
    gap: 5px;               /* 在两行标签之间增加一点间距 */
}
.main-tabs-group, .utility-tabs-group {
    width: 100%;             /* 让每个组都占据全部宽度，以便内部居中 */
    justify-content: center; /* 内部的标签居中排列 */
    margin-left: 0 !important; /* 强制覆盖JS添加的 margin-left: auto */
    flex-direction: row !important; /* 强制覆盖JS添加的 flex-direction: column */
}
    .theme-switcher {
        top: 8px; right: 8px;
        padding: 4px;
    }
    .theme-icon {
        width: 22px; height: 22px; font-size: 12px;
    }
}
/* 按钮加载状态 */
.button-loading {
    position: relative;
    pointer-events: none;
    color: transparent !important;
}
.button-loading i {
    color: transparent !important;
}
.button-loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

:root {
    --bg-gradient: linear-gradient(135deg, #fdf6f9 0%, #fff0f5 100%);
    --text-color: #5a2d52;
    --text-comment: #b3a7a9;
    --card-bg: rgba(255, 255, 255, 0.7);
    --border-color: #ffe8f0;
    --border-color-light: #ffcee7;
    --shadow-color: rgba(255, 192, 203, 0.35);
    --highlight-strong: #d84381;
    --highlight-value: #8e44ad;
    --highlight-npc: #e06c9e;
    --header-color: #d84381;
    --header-decorator: "❀";
    --decorator-color: #ff91ad;
    --particle-content: '🌸';
    --particle-color: #ffb6c1;
    --avatar-bg: linear-gradient(135deg, #ffc0cb 0%, #db7093 100%);
    --info-label-color: #c71585;
    --progress-bg: #ffe5e5;
    --progress-fill-talent: linear-gradient(to right, #ff66b2, #ff4da6);
    --progress-fill-etiquette: linear-gradient(to right, #9370db, #7b68ee);
    --progress-fill-wisdom: linear-gradient(to right, #20b2aa, #48d1cc);
    --progress-fill-health: linear-gradient(to right, #3cb371, #2e8b57);
    --progress-fill-virtue: linear-gradient(to right, #f4a261, #e76f51);
    --progress-fill-charm: linear-gradient(to right, #a7c957, #6a9ac9);
    --progress-fill-martial: linear-gradient(to right, #e74c3c, #c0392b);
    --status-item-bg: linear-gradient(to right, #fff8fb, #ffe8f0);
    --status-border-color: #ffd8e8;
    --status-icon-color: #e06c9e;
    --tab-border-color: #ffb6c1;
    --tab-color: #8c7386;
    --tab-hover-bg: #fff9fc;
    --tab-hover-color: #ff85c1;
    --tab-active-border: #ff69b4;
    --tab-active-color: #ff69b4;
    --tab-active-bg: #fffafb;
    --option-bg: linear-gradient(135deg, #ff9ebf, #ff69b4);
    --option-shadow: rgba(219, 112, 147, 0.25);
    --option-shadow-hover: rgba(219, 112, 147, 0.35);
    --option-shadow-active: rgba(219, 112, 147, 0.2);
    --control-bg: linear-gradient(135deg, #9bbde0, #6a9ac9);
    --control-shadow: rgba(132, 169, 192, 0.35);
    --control-shadow-hover: rgba(132, 169, 192, 0.45);
    --control-shadow-active: rgba(132, 169, 192, 0.2);
    --event-bg: #fffcfc;
    --event-border: #ff9dbd;
    --suitor-bg: linear-gradient(to right, #f0f8ff, #e6f7ff);
    --suitor-border: #c0d8ff;
    --suitor-shadow-hover: rgba(65, 105, 225, 0.12);
    --stat-bg: #e6f0ff;
    --stat-color: #4169e1;
    --overlay-bg: rgba(255, 245, 247, 0.98);
    --overlay-card-bg: linear-gradient(135deg, #ffd1e4 0%, #ffa7c9 100%);
    --overlay-shadow: rgba(219, 112, 147, 0.4);
    --overlay-border: #ff85c1;
    --overlay-header-color: #c71585;
    --overlay-animation-color: #ff69b4;
    --loading-bg: rgba(255, 245, 247, 0.98);
    --loading-text: #db7093;
    --loading-spinner-bg: #ffb6c1;
    --loading-spinner-fg: #db7093;
    --accent-color-deep: #d84381;
}

[data-theme="summer"] {
    --bg-gradient: linear-gradient(135deg, #f0fff0 0%, #e6ffe6 100%);
    --text-color: #2e8b57;
    --text-comment: #556b2f;
    --card-bg: rgba(255, 255, 255, 0.8);
    --border-color: #c1ffc1;
    --border-color-light: #b4eeb4;
    --shadow-color: rgba(60, 179, 113, 0.3);
    --highlight-strong: #3cb371;
    --highlight-value: #20b2aa;
    --highlight-npc: #2e8b57;
    --header-color: #2e8b57;
    --header-decorator: "🌿";
    --decorator-color: #3cb371;
    --particle-content: '🍃';
    --particle-color: #98fb98;
    --avatar-bg: linear-gradient(135deg, #98fb98 0%, #3cb371 100%);
    --info-label-color: #2e8b57;
    --progress-bg: #e0eee0;
    --status-item-bg: linear-gradient(to right, #f5fff5, #e6ffe6);
    --status-border-color: #c1ffc1;
    --status-icon-color: #3cb371;
    --tab-border-color: #90ee90;
    --tab-color: #556b2f;
    --tab-hover-bg: #fafffa;
    --tab-hover-color: #3cb371;
    --tab-active-border: #2e8b57;
    --tab-active-color: #2e8b57;
    --tab-active-bg: #f0fff0;
    --option-bg: linear-gradient(135deg, #8fbc8f, #3cb371);
    --option-shadow: rgba(60, 179, 113, 0.25);
    --option-shadow-hover: rgba(60, 179, 113, 0.35);
    --option-shadow-active: rgba(60, 179, 113, 0.2);
    --event-bg: #fafffa;
    --event-border: #66cdaa;
    --overlay-bg: rgba(240, 255, 240, 0.98);
    --overlay-card-bg: linear-gradient(135deg, #c1ffc1 0%, #90ee90 100%);
    --overlay-shadow: rgba(46, 139, 87, 0.4);
    --overlay-border: #3cb371;
    --overlay-header-color: #2e8b57;
    --overlay-animation-color: #32cd32;
    --loading-bg: rgba(240, 255, 240, 0.98);
    --loading-text: #2e8b57;
    --loading-spinner-bg: #98fb98;
    --loading-spinner-fg: #2e8b57;
    --accent-color-deep: #2e8b57;
}

[data-theme="autumn"] {
    --bg-gradient: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    --text-color: #8d6e63;
    --text-comment: #a1887f;
    --card-bg: rgba(255, 255, 255, 0.8);
    --border-color: #ffe082;
    --border-color-light: #ffd54f;
    --shadow-color: rgba(255, 167, 38, 0.3);
    --highlight-strong: #d35400;
    --highlight-value: #bf360c;
    --highlight-npc: #e65100;
    --header-color: #f57c00;
    --header-decorator: "🍁";
    --decorator-color: #ffa726;
    --particle-content: '🍂';
    --particle-color: #ffb74d;
    --avatar-bg: linear-gradient(135deg, #ffcc80 0%, #ff9800 100%);
    --info-label-color: #d84315;
    --progress-bg: #fff3e0;
    --status-item-bg: linear-gradient(to right, #fffaf2, #ffecb3);
    --status-border-color: #ffe0b2;
    --status-icon-color: #f57c00;
    --tab-border-color: #ffca28;
    --tab-color: #795548;
    --tab-hover-bg: #fff8e1;
    --tab-hover-color: #fb8c00;
    --tab-active-border: #f57c00;
    --tab-active-color: #f57c00;
    --tab-active-bg: #fffde7;
    --option-bg: linear-gradient(135deg, #ffb74d, #ff9100);
    --option-shadow: rgba(255, 145, 0, 0.25);
    --option-shadow-hover: rgba(255, 145, 0, 0.35);
    --option-shadow-active: rgba(255, 145, 0, 0.2);
    --event-bg: #fffaf0;
    --event-border: #ffab40;
    --overlay-bg: rgba(255, 248, 225, 0.98);
    --overlay-card-bg: linear-gradient(135deg, #ffe0b2 0%, #ffca28 100%);
    --overlay-shadow: rgba(239, 108, 0, 0.4);
    --overlay-border: #ffa000;
    --overlay-header-color: #e65100;
    --overlay-animation-color: #ff6d00;
    --loading-bg: rgba(255, 248, 225, 0.98);
    --loading-text: #e65100;
    --loading-spinner-bg: #ffcc80;
    --loading-spinner-fg: #e65100;
    --accent-color-deep: #e65100;
}

[data-theme="winter"] {
    --bg-gradient: linear-gradient(135deg, #f0f8ff 0%, #e6e6fa 100%);
    --text-color: #4682b4;
    --text-comment: #708090;
    --card-bg: rgba(255, 255, 255, 0.85);
    --border-color: #d1e3ff;
    --border-color-light: #b0c4de;
    --shadow-color: rgba(100, 149, 237, 0.3);
    --highlight-strong: #4169e1;
    --highlight-value: #0000cd;
    --highlight-npc: #1e90ff;
    --header-color: #00bfff;
    --header-decorator: "❄️";
    --decorator-color: #87cefa;
    --particle-content: '❅';
    --particle-color: #e0ffff;
    --avatar-bg: linear-gradient(135deg, #b0e0e6 0%, #4682b4 100%);
    --info-label-color: #483d8b;
    --progress-bg: #e6f0ff;
    --status-item-bg: linear-gradient(to right, #f5faff, #e6f7ff);
    --status-border-color: #d6eaff;
    --status-icon-color: #6495ed;
    --tab-border-color: #add8e6;
    --tab-color: #607b8b;
    --tab-hover-bg: #f0f8ff;
    --tab-hover-color: #4682b4;
    --tab-active-border: #1e90ff;
    --tab-active-color: #1e90ff;
    --tab-active-bg: #f5faff;
    --option-bg: linear-gradient(135deg, #87ceeb, #4682b4);
    --option-shadow: rgba(70, 130, 180, 0.25);
    --option-shadow-hover: rgba(70, 130, 180, 0.35);
    --option-shadow-active: rgba(70, 130, 180, 0.2);
    --event-bg: #f8faff;
    --event-border: #87cefa;
    --overlay-bg: rgba(240, 248, 255, 0.98);
    --overlay-card-bg: linear-gradient(135deg, #d4e8ff 0%, #a7c7e7 100%);
    --overlay-shadow: rgba(70, 130, 180, 0.4);
    --overlay-border: #4169e1;
    --overlay-header-color: #00008b;
    --overlay-animation-color: #1e90ff;
    --loading-bg: rgba(240, 248, 255, 0.98);
    --loading-text: #4682b4;
    --loading-spinner-bg: #add8e6;
    --loading-spinner-fg: #4682b4;
    --accent-color-deep: #00008b;
}

[data-theme="night"] {
    --bg-gradient: linear-gradient(135deg, #262626 0%, #171717 100%);
    --text-color: #e2e8f0;
    --text-comment: #94a3b8;
    --card-bg: rgba(39, 39, 42, 0.75);
    --border-color: #404040;
    --border-color-light: #525252;
    --shadow-color: rgba(0, 0, 0, 0.6);
    --highlight-strong: #facc15;
    --highlight-value: #fbbf24;
    --highlight-npc: #60a5fa;
    --header-color: #fde047;
    --header-decorator: "🌙";
    --decorator-color: #facc15;
    --particle-content: '✨';
    --particle-color: #fde047;
    --avatar-bg: linear-gradient(135deg, #475569, #1e293b);
    --info-label-color: #93c5fd;
    --progress-bg: #404040;
    --status-item-bg: linear-gradient(to right, #262626, #404040);
    --status-border-color: #525252;
    --status-icon-color: #facc15;
    --tab-border-color: #525252;
    --tab-color: #94a3b8;
    --tab-hover-bg: #404040;
    --tab-hover-color: #e2e8f0;
    --tab-active-border: #facc15;
    --tab-active-color: #fde047;
    --tab-active-bg: #262626;
    /* 【修改】选项按钮改为参考图片中的靛蓝色 */
    --option-bg: linear-gradient(135deg, #6366f1, #4f46e5);
    --option-shadow: rgba(79, 70, 229, 0.4);
    --option-shadow-hover: rgba(79, 70, 229, 0.6);
    --option-shadow-active: rgba(79, 70, 229, 0.3);
    /* 【修改】控制按钮改为参考图片中的亮金色 */
    --control-bg: linear-gradient(135deg, #fde047, #facc15);
    --control-shadow: rgba(250, 204, 21, 0.3);
    --control-shadow-hover: rgba(250, 204, 21, 0.4);
    --control-shadow-active: rgba(250, 204, 21, 0.2);
    --event-bg: #262626;
    --event-border: #4f46e5; /* 事件边框也改为蓝色系以匹配选项按钮 */
    --suitor-bg: linear-gradient(to right, #404040, #262626);
    --suitor-border: #525252;
    --suitor-shadow-hover: rgba(96, 165, 250, 0.3);
    --stat-bg: #404040;
    --stat-color: #fde047;
    --overlay-bg: rgba(23, 23, 23, 0.98);
    --overlay-card-bg: linear-gradient(135deg, #262626 0%, #171717 100%);
    --overlay-shadow: rgba(0, 0, 0, 0.7);
    --overlay-border: #facc15;
    --overlay-header-color: #fde047;
    --overlay-animation-color: #fde047;
    --loading-bg: rgba(23, 23, 23, 0.98);
    --loading-text: #e2e8f0;
    --loading-spinner-bg: #525252;
    --loading-spinner-fg: #e2e8f0;
    --accent-color-deep: #facc15;
}
/* 徒弟卡片样式 */
.apprentice-card {
  background: linear-gradient(to right, #f0f8ff, #e6f7ff);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 12px;
  border-left: 5px solid #6a9ac9;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  display: flex;
  align-items: center;
  gap: 15px;
}

.apprentice-name {
  font-weight: bold;
  color: #4169e1;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.apprentice-name i {
  margin-right: 10px;
  font-size: 1.2rem;
}

.apprentice-details {
  font-size: 0.95rem;
  line-height: 1.6;
  flex: 1;
}

.apprentice-btn-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.apprentice-interact-btn {
  background: linear-gradient(135deg, #6a9ac9, #4169e1);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 10px 15px;
  font-size: 0.9rem;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  flex-shrink: 0;
}

/* 收徒弹窗样式 */
#apprenticeSystemOverlay .overlay-card {
  max-width: 90%;
  padding: 25px;
}

.apprentice-option {
  background: var(--option-bg);
  color: white;
  border: none;
  border-radius: 30px;
  padding: 15px 22px;
  width: 100%;
  text-align: left;
  cursor: pointer;
  font-size: 1rem;
  box-shadow: 0 5px 15px var(--option-shadow);
  display: flex;
  align-items: center;
  position: relative;
  overflow: hidden;
  margin-bottom: 10px;
}

.apprentice-option:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px var(--option-shadow-hover);
}

.apprentice-option i {
  margin-right: 12px;
  font-size: 1.3rem;
  width: 20px;
  text-align: center;
}
 /* --- 子女婚嫁界面专属样式 --- */
#childMarriageProposalOverlay .suitor {
    background: var(--suitor-bg);
    border: 1px solid var(--suitor-border);
    margin-bottom: 12px;
    padding: 15px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
}
#childMarriageProposalOverlay .suitor-name {
    font-size: 1.1rem;
    font-weight: bold;
}
#childMarriageProposalOverlay .suitor-desc {
    font-size: 0.95rem;
    line-height: 1.5;
    color: var(--text-comment);
}
.hidden-trait {
    background-color: var(--progress-bg);
    padding: 8px;
    margin-top: 10px;
    border-radius: 8px;
    font-style: italic;
}
.trait-positive {
    color: #27ae60; /* 绿色 */
    border-left: 3px solid #27ae60;
}
.trait-negative {
    color: #c0392b; /* 红色 */
    border-left: 3px solid #c0392b;
}
/* ======================================================================= */
/* ======================= 新版商会交易玩法专属样式 ====================== */
/* ======================================================================= */
#tradeSimOverlay .overlay-card {
    max-width: 95%;
    width: 800px; /* 给一个固定宽度，在大屏幕上更好看 */
    height: 90vh;
    display: flex;
    flex-direction: column;
}
#tradeSimOverlay .overlay-content-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* 防止内部滚动条影响布局 */
}
.trade-sim-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.trade-sim-header {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color-light);
}
.trade-sim-header-item {
    background: var(--status-item-bg);
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 0.9rem;
    border: 1px solid var(--status-border-color);
    text-align: center;
}
.trade-sim-news {
    background: var(--event-bg);
    padding: 10px;
    border-radius: 8px;
    font-size: 0.9em;
    border-left: 4px solid var(--decorator-color);
    max-height: 80px;
    overflow-y: auto;
}
.trade-sim-body {
    flex-grow: 1;
    overflow-y: auto; /* 核心滚动区 */
    border: 1px solid var(--border-color);
    border-radius: 10px;
}
.trade-sim-table {
    width: 100%;
    border-collapse: collapse;
}
.trade-sim-table th, .trade-sim-table td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid var(--border-color-light);
    font-size: 0.9rem;
}
.trade-sim-table th {
    background: var(--tab-active-bg);
    position: sticky;
    top: 0;
}
.trade-sim-table tr:hover {
    background: var(--tab-hover-bg);
}
.trade-sim-table .price-up { color: #c0392b; font-weight: bold; }
.trade-sim-table .price-down { color: #27ae60; font-weight: bold; }
.trade-sim-table input[type="number"] {
    width: 60px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    text-align: center;
}
.trade-sim-table .btn-buy, .trade-sim-table .btn-sell {
    padding: 5px 10px;
    border: none;
    color: white;
    border-radius: 15px;
    cursor: pointer;
    font-size: 0.8rem;
}
.trade-sim-table .btn-buy { background-color: #27ae60; }
.trade-sim-table .btn-sell { background-color: #c0392b; }
.trade-sim-footer {
    display: flex;
    justify-content: space-between;
    padding-top: 10px;
    border-top: 1px solid var(--border-color-light);
    gap: 10px;
}
.trade-sim-footer .control-btn {
    flex: 1;
}
/* 放置在您 <style> 标签的末尾，或者商会小游戏专属样式区域 */

/* --- 商会交易系统专属样式 --- */
.trading-main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}
.trading-info-box {
    background: var(--status-item-bg);
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    border: 1px solid var(--status-border-color);
}
.trading-info-box h4 {
    margin-bottom: 8px;
    color: var(--highlight-strong);
}
.trading-info-box .value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--header-color);
}
.market-fluctuation-card {
    grid-column: 1 / -1; /* 跨两列 */
    background: var(--event-bg);
    border-left: 5px solid var(--decorator-color);
}
.market-fluctuation-card ul {
    list-style: none;
    padding: 0;
}
.market-fluctuation-card li {
    padding: 5px 0;
    border-bottom: 1px dashed var(--border-color-light);
}
.market-fluctuation-card li:last-child {
    border-bottom: none;
}
.text-gain { color: #27ae60; }
.text-loss { color: #c0392b; }

.guild-button {
    background: var(--option-bg);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    box-shadow: 0 4px 10px var(--option-shadow);
}
.guild-button:hover {
    transform: translateY(-3px);
}
.guild-favor-bar {
    width: 100%;
    height: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
    margin-top: 8px;
    overflow: hidden;
}
.guild-favor-fill {
    height: 100%;
    background: #f1c40f;
    border-radius: 4px;
}
.trading-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 20px;
}
/* --- 新版 NPC 社交卡片样式 --- */
#npcDetailOverlay .overlay-card {
    max-width: 90%;
    width: 500px;
    padding: 0;
    background: transparent;
    border: none;
    box-shadow: none;
    overflow: visible; /* 允许卷轴装饰超出边界 */
    /* 【核心修改】让卡片在手机上能自适应高度 */
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* 最大高度不超过屏幕的90% */
}

.social-card-scroll {
    width: 100%;
    background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg'); /* 淡雅宣纸纹理 */
    background-size: cover;
    background-position: center;
    border: 2px solid #bda27e;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 25px;
    color: #4a3c2b;
    position: relative;
    border-radius: 5px;
    /* 【核心修改】让卷轴内容区可以滚动 */
    overflow-y: auto; /* 当内容超出时，出现垂直滚动条 */
    flex-grow: 1; /* 占据所有可用空间 */
    -webkit-overflow-scrolling: touch; /* 在iOS上实现流畅滚动 */
}
/* 【新增】美化滚动条样式 */
.social-card-scroll::-webkit-scrollbar {
    width: 6px;
}
.social-card-scroll::-webkit-scrollbar-track {
    background: transparent;
}
.social-card-scroll::-webkit-scrollbar-thumb {
    background-color: rgba(189, 162, 126, 0.5);
    border-radius: 10px;
}


/* 卷轴装饰 */
.social-card-scroll::before, .social-card-scroll::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 30px;
    background-image: url('https://www.transparentpng.com/thumb/scroll/KaUj4u-scroll-paper-clipart-transparent.png'); /* 卷轴头图片 */
    background-size: 100% 100%;
    background-repeat: no-repeat;
    z-index: 10;
    flex-shrink: 0; /* 防止装饰被压缩 */
}

.social-card-scroll::before { top: -31px; transform: rotate(180deg); }
.social-card-scroll::after { bottom: -31px; }

/* 主题适配装饰 */
.theme-decorator {
    position: absolute;
    width: 80px;
    height: 80px;
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 0.15;
    pointer-events: none;
}
[data-theme="spring"] .theme-decorator { background-image: url('https://png.pngtree.com/png-vector/20220721/ourmid/pngtree-falling-sakura-petals-with-pink-background-png-image_6021509.png'); }
[data-theme="summer"] .theme-decorator { background-image: url('https://png.pngtree.com/png-vector/20220625/ourmid/pngtree-summer-green-lotus-leaf-decoration-png-image_5426177.png'); }
[data-theme="autumn"] .theme-decorator { background-image: url('https://png.pngtree.com/png-vector/20220516/ourmid/pngtree-beautiful-hand-painted-watercolor-maple-leaf-material-png-image_4682490.png'); }
[data-theme="winter"] .theme-decorator { background-image: url('https://png.pngtree.com/png-vector/20220921/ourmid/pngtree-simple-blue-six-petal-snowflake-png-image_6208351.png'); }
[data-theme="night"] .theme-decorator { background-image: url('https://png.pngtree.com/png-vector/20230303/ourmid/pngtree-gold-star-clipart-transparent-background-png-image_6629740.png'); }

.theme-decorator.top-right { top: 10px; right: 10px; transform: rotate(20deg); }
.theme-decorator.bottom-left { bottom: 10px; left: 10px; transform: rotate(-160deg); }


/* --- 顶部区域 --- */
.social-card-header {
    display: flex;
    gap: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(189, 162, 126, 0.4);
    margin-bottom: 15px;
    align-items: center;
}
.npc-avatar-container {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.npc-avatar-frame {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    padding: 4px;
    background: linear-gradient(135deg, #e4d2b1, #bda27e); /* 玉石/金色描边 */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.npc-avatar-frame img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
}
.npc-avatar-halo {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    z-index: -1;
}
.rarity-common { box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.7); }
.rarity-rare { box-shadow: 0 0 15px 5px rgba(173, 216, 230, 0.9); }
.rarity-legendary { box-shadow: 0 0 20px 8px rgba(255, 215, 0, 0.8); }

.npc-identity-tag {
    background-color: rgba(189, 162, 126, 0.8);
    color: white;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-top: 8px;
    display: inline-block;
}

.npc-info-basic {
    flex-grow: 1;
}
.npc-info-basic .name {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 2rem;
    color: #3a2d1b;
    margin: 0;
}
.npc-info-basic .title {
    font-size: 0.9rem;
    color: #a1887f;
    margin-top: -5px;
    margin-bottom: 8px;
}
.npc-info-basic .description {
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 10px;
}
.personality-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.personality-tag {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 4px;
    color: white;
}
.tag-温柔 { background: #ffc0cb; color: #5a2d52; }
.tag-果敢 { background: #e74c3c; }
.tag-聪慧 { background: #3498db; }
.tag-活泼 { background: #f1c40f; color: #5a2d52; }
.tag-内敛 { background: #95a5a6; }

/* --- 中部区域 --- */
.social-card-middle {
    display: flex;
    gap: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(189, 162, 126, 0.4);
    margin-bottom: 15px;
}
.attributes-vertical-container {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.attribute-vertical {
    display: flex;
    align-items: center;
    gap: 10px;
}
.attribute-vertical .name {
    writing-mode: vertical-lr;
    font-size: 0.9rem;
    letter-spacing: 2px;
}
.progress-bar-vertical-wrapper {
    height: 100px;
    width: 12px;
    background-color: rgba(0,0,0,0.08);
    border-radius: 6px;
    display: flex;
    flex-direction: column-reverse; /* 从下往上填充 */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.progress-bar-vertical-fill {
    width: 100%;
    border-radius: 6px;
    background: var(--decorator-color);
    transition: height 0.5s ease-out;
}
.attribute-vertical .value {
    font-size: 1.1rem;
    font-weight: bold;
}

.relationship-container {
    flex-basis: 120px;
    text-align: center;
}
.relationship-container .heart-meter {
    font-size: 50px;
    color: #e57373; /* 爱心颜色 */
    position: relative;
    display: inline-block;
    margin-bottom: 10px;
}
.heart-fill {
    position: absolute;
    top: 0; left: 0; width: 100%;
    background: currentColor;
    overflow: hidden;
    transition: height 0.5s ease-out;
}
.heart-icon { position: relative; z-index: 1; }

.relationship-tag { font-weight: bold; font-size: 1rem; margin-bottom: 5px; }
.relationship-trend i { font-size: 0.9rem; }
.trend-up { color: #27ae60; }
.trend-down { color: #c0392b; }
.trend-stable { color: #7f8c8d; }

.special-status-display {
    text-align: center;
    background: var(--event-bg);
    border-radius: 8px;
    padding: 8px;
    margin-top: 10px;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
}

/* --- 底部互动区 --- */
.social-card-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
}
.action-button {
    background: linear-gradient(135deg, #c5a880, #a88a60);
    color: white;
    border: 1px solid #8e6e4a;
    border-radius: 12px;
    padding: 10px;
    cursor: pointer;
    text-align: center;
    box-shadow: 0 3px 8px rgba(100,80,50,0.2);
}
.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(100,80,50,0.3);
}
.action-button i { display: block; font-size: 1.5rem; margin-bottom: 5px; }
.action-button.disabled {
    background: #ccc;
    color: #888;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}
.action-button.disabled i {
    position: relative;
}
.action-button.disabled i::after {
    content: "\f023"; /* fa-lock */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.8rem;
    color: white;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    padding: 4px;
}
/* --- 隐藏面板 --- */
.expand-info-toggle {
    text-align: center;
    padding: 8px;
    margin-top: 15px;
    background: rgba(189, 162, 126, 0.2);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    border-top: 1px solid rgba(189, 162, 126, 0.4);
}
.expand-info-toggle:hover {
    background: rgba(189, 162, 126, 0.4);
}

.expandable-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.7s ease-in-out, padding 0.5s ease;
    padding: 0 10px;
}
.expandable-panel.active {
    max-height: 500px; /* 足够大的值 */
    padding: 15px 10px;
}
.expandable-panel h5 { margin-top: 10px; margin-bottom: 5px; color: var(--highlight-strong); }
.expandable-panel ul { list-style: none; padding-left: 10px; }
.expandable-panel li { padding: 3px 0; }
.expandable-panel li i { margin-right: 8px; }
/* ======================================================================= */
/* ===================== 【新功能】深度社交 & 小游戏 CSS =================== */
/* ======================================================================= */

/* --- 雅集聚会场景 --- */
#gatheringOverlay {
    background-size: cover;
    background-position: center;
    transition: background-image 1s ease-in-out;
}
#gatheringOverlay::before {
    content: '';
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
}
.gathering-container {
    position: relative;
    width: 95%;
    height: 95%;
    max-width: 800px;
    max-height: 600px;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
}
.gathering-npc {
    position: absolute;
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s ease;
}
.gathering-npc:hover {
    transform: scale(1.1);
}
.gathering-npc img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.8);
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.gathering-npc .name {
    margin-top: 5px;
    background: rgba(0,0,0,0.5);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.9em;
}
.gathering-ui {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: rgba(0,0,0,0.6);
    border-radius: 15px;
    padding: 15px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.2);
}
.gathering-desc {
    margin-bottom: 15px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px;
}
.gathering-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
}

/* --- 婚礼场景 --- */
.wedding-stage {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}
.wedding-guest {
    display: inline-block;
    text-align: center;
    margin: 10px;
    cursor: pointer;
}
.wedding-guest img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid var(--highlight-strong);
}

/* --- 棋局小游戏 --- */
#goGameContainer {
    display: flex;
    justify-content: center;
    align-items: center;
}
.go-board {
    display: grid;
    grid-template-columns: repeat(5, 50px);
    grid-template-rows: repeat(5, 50px);
    border: 2px solid #6b4e3d;
    background-color: #e4d2b1;
}
.go-cell {
    width: 50px;
    height: 50px;
    border: 1px solid #bda27e;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 30px;
}
/* ======================================================================= */
/* ===================== 【新功能】特殊关系专属互动样式 ==================== */
/* ======================================================================= */

.special-actions-card {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(189, 162, 126, 0.4);
}

.special-actions-card .section-header {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 1.5rem;
    text-align: center;
    margin-bottom: 15px;
    border-bottom: none;
}

.special-actions-card .lover-header {
    color: #c0392b; /* 红色，代表情人 */
}

.special-actions-card .sworn-header {
    color: #d35400; /* 橙色，代表结义 */
}

.special-actions-card .comment {
    text-align: center;
    font-size: 0.9rem;
    margin-bottom: 15px;
    color: #a1887f;
}

/* 使用 .social-card-actions 样式来统一按钮风格 */
.special-actions-card .social-card-actions {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* 调整按钮布局 */
}

/* ===================== 【新增】特殊互动弹窗专属样式 ===================== */
#specialInteractionOverlay .overlay-card {
    background: linear-gradient(135deg, #fff0f5, #fdf6f9); /* 淡雅的粉色渐变 */
    border: 2px solid var(--decorator-color);
    box-shadow: 0 8px 25px var(--shadow-color);
    max-width: 480px;
}

#specialInteractionOverlay .overlay-header {
    font-family: 'Ma Shan Zheng', cursive;
    color: var(--highlight-strong);
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
}

#specialInteractionOverlay .overlay-content {
    text-align: center;
    color: var(--text-color);
    font-size: 1rem;
    line-height: 1.7;
    margin-bottom: 20px;
}

/* 特殊互动选项按钮的样式 */
#specialInteractionOptions .option {
    background: var(--option-bg);
    transition: all 0.2s ease-in-out;
}
#specialInteractionOptions .option:hover {
    background: var(--highlight-strong);
    transform: scale(1.03);
}
/* ======================================================================= */
/* ===================== 【新增】义结金兰仪式专属样式 ===================== */
/* ======================================================================= */
#oathCeremonyOverlay .overlay-card {
    background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg'); /* 淡雅宣纸纹理 */
    background-size: cover;
    background-position: center;
    border: 2px solid #bda27e; /* 古铜色边框 */
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    color: #4a3c2b; /* 深褐色文字 */
    max-width: 500px;
}

#oathCeremonyOverlay .overlay-header {
    font-family: 'Ma Shan Zheng', cursive;
    color: #8B4513; /* 赭石色 */
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
}

#oathCeremonyOverlay blockquote {
    border-left: 3px solid #bda27e;
    padding-left: 15px;
    margin: 20px;
    font-style: italic;
    color: #6b4e3d;
    line-height: 2;
    text-align: center;
}
/* ======================================================================= */
/* ===================== [新增] 红笺寄情系统专属样式 ====================== */
/* ======================================================================= */

/* --- 情诗编辑器 --- */
#poetryEditorOverlay .overlay-card {
    background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.png');
    background-size: cover;
    border: 2px solid #bda27e;
    color: #4a3c2b;
    max-width: 600px;
    width: 95%;
}
.poetry-editor-container {
    display: flex;
    gap: 20px;
}
.poetry-scroll {
    flex: 1;
    border: 1px solid #d3c4a3;
    padding: 15px;
    height: 200px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
}
.poetry-line {
    border-bottom: 1px dashed #bda27e;
    min-height: 30px;
    padding: 5px;
    cursor: grab;
    text-align: center;
    font-size: 1.1rem;
}
.poetry-line.filled {
    font-family: 'Ma Shan Zheng', cursive;
    font-weight: bold;
}
.poetry-fragments {
    flex: 1;
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.fragment {
    background: var(--suitor-bg);
    padding: 8px;
    border-radius: 5px;
    cursor: grab;
    border: 1px solid var(--suitor-border);
}
.self-compose-input {
    width: 100%;
    padding: 8px;
    margin-top: 10px;
    border-radius: 5px;
    border: 1px solid #bda27e;
    background: rgba(255,255,255,0.7);
}

/* --- 信物制作 --- */
.token-option {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid var(--border-color-light);
}
.token-option:hover {
    background: var(--tab-hover-bg);
}
.token-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #eee;
}
.token-icon { font-size: 2rem; color: var(--highlight-strong); }
.token-details { flex-grow: 1; }
.token-details small { color: var(--text-comment); }

/* --- 表白场景 --- */
#confessionSceneOverlay {
    background-size: cover;
    background-position: center;
    transition: background-image 1s ease-in-out;
}
#confessionSceneOverlay::before {
    content: '';
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
}
#confessionSceneOverlay .overlay-card {
    background: rgba(0,0,0,0.5);
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    border-color: rgba(255,255,255,0.5);
}
.confession-animation {
    width: 100%;
    height: 150px; /* 根据需要调整 */
    margin-bottom: 20px;
    /* 可用于后续添加动画效果 */
}
/* ======================================================================= */
/* ======================= 【新增】全新婚礼界面样式 ======================== */
/* ======================================================================= */
#weddingOverlay .overlay-card {
    background: linear-gradient(135deg, #ffdde1 0%, #ee9ca7 100%);
    border-color: #c71585;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.wedding-stage {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    text-align: center;
}
.wedding-couples {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    align-items: flex-end;
}
.wedding-person {
    text-align: center;
}
.wedding-person .avatar-wrapper {
    width: 80px; height: 80px;
    border-color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.wedding-person .name {
    font-weight: bold;
    margin-top: 8px;
    font-size: 1.1rem;
    color: var(--header-color);
}
.wedding-guests {
    margin-top: 20px;
    border-top: 1px dashed var(--border-color-light);
    padding-top: 15px;
    width: 100%;
}
.wedding-guests h4 {
    margin-bottom: 10px;
}
.guest-list {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}
.wedding-guest {
    text-align: center;
    font-size: 0.9rem;
}
.wedding-guest .avatar-wrapper {
    width: 50px;
    height: 50px;
    border-width: 2px;
    margin: 0 auto 5px;
}
/* ======================================================================= */
/* ===================== 【新增】天命轮回录专属样式 ====================== */
/* ======================================================================= */
#dustyMirrorOverlay .overlay-card,
#inheritanceBookOverlay .overlay-card {
    background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg');
    background-size: cover;
    border: 2px solid #4a3c2b;
    color: #4a3c2b;
    max-width: 95%;
    width: 600px;
    height: 90vh;
    padding: 25px;
    display: flex;
    flex-direction: column;
}

.mirror-title {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 2.5rem;
    color: #8B4513;
    text-align: center;
    margin-bottom: 10px;
}

.posthumous-title {
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    background: linear-gradient(to right, #bda27e, #8e6e4a);
    -webkit-background-clip: text;
    color: transparent;
    padding: 5px 15px;
    border: 1px solid #bda27e;
    border-radius: 10px;
    margin: 0 auto 15px;
    display: inline-block;
}

.mirror-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    overflow-y: auto;
    padding: 10px;
    flex-grow: 1;
}

.dimension-card {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid #d3c4a3;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.dimension-header {
    margin-bottom: 10px;
}

.dimension-rating {
    font-size: 3rem;
    font-weight: bold;
    margin-bottom: 5px;
}
.rating-S { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
.rating-A { color: #c0392b; }
.rating-B { color: #2980b9; }
.rating-C { color: #7f8c8d; }
.rating-D { color: #34495e; }

.dimension-name {
    font-size: 1.3rem;
    font-family: 'Ma Shan Zheng', cursive;
}

.dimension-comment {
    font-size: 0.9em;
    font-style: italic;
    color: #6b4e3d;
    line-height: 1.6;
    flex-grow: 1;
}

/* 承世书样式 */
#inheritanceBookOverlay .overlay-content-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.heir-selection-container {
    padding-bottom: 15px;
    border-bottom: 1px solid #d3c4a3;
    margin-bottom: 10px;
    text-align: center;
}

.heir-selection-container h4 { margin-bottom: 10px; }

.heir-list {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.heir-card {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 8px;
    transition: all 0.2s ease;
}
.heir-card:hover {
    border-color: #a88a60;
}
.heir-card.selected {
    border-color: #d35400;
    background: rgba(255, 235, 205, 0.7);
    transform: scale(1.05);
}

.talent-tree-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
}
.points-display {
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 15px;
}

.talent-branch {
    margin-bottom: 20px;
}
.talent-branch-header {
    font-size: 1.2rem;
    font-weight: bold;
    color: #8B4513;
    padding-bottom: 8px;
    border-bottom: 1px dashed #bda27e;
    margin-bottom: 10px;
}
.talent-tier {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: flex-start;
}

.talent-node {
    flex: 1;
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid #d3c4a3;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    min-width: 120px;
}
.talent-node strong {
    display: block;
    margin-bottom: 5px;
}
.talent-node small {
    display: block;
    color: #6b4e3d;
    line-height: 1.4;
    min-height: 40px;
}
.talent-node button {
    margin-top: 8px;
    width: 100%;
    padding: 6px;
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
}
.talent-node .btn-buy { background-color: #27ae60; }
.talent-node .btn-bought { background-color: #7f8c8d; cursor: not-allowed; }
.talent-node .btn-locked { background-color: #bdc3c7; cursor: not-allowed; }

.relics-container {
    margin-top: 20px;
    border-top: 1px solid #d3c4a3;
    padding-top: 15px;
}
.relic-item {
    display: flex;
    gap: 15px;
    align-items: center;
    background: linear-gradient(135deg, #fff8e1, #ffecb3);
    padding: 10px;
    border-radius: 8px;
    border-left: 4px solid #ffa726;
}
.relic-icon { font-size: 1.5rem; color: #d35400; }
.relic-details { flex-grow: 1; }

</style>
</head>
<body data-theme="spring">
<audio id="bgm-fengqiuhaung" loop src="https://vgmdownloads.com/soundtracks/genshin-impact-the-stellar-moments-vol.-4/htumrpmgje/2-09.%20A%20Merry-Go-Round%20of%20Life.mp3"></audio>
<audio id="bgm-gaoshanliushui" loop src="https://vgmdownloads.com/soundtracks/genshin-impact-the-stellar-moments-vol.-4/xflqfglonm/2-04.%20Bard%27s%20Adventure.mp3"></audio>
<audio id="bgm-shimianmaifu" loop src="https://vgmdownloads.com/soundtracks/genshin-impact-the-stellar-moments-vol.-4/zofhmdkbsz/3-04.%20For%20Riddles%2C%20for%20Wonders.mp3"></audio>

<audio id="sfx-perfect-hit" src="https://opengameart.org/sites/default/files/audio_preview/OGA-135930030_1.mp3"></audio>
<audio id="sfx-good-hit" src="https://opengameart.org/sites/default/files/audio_preview/OGA-1031388880.mp3"></audio>
<audio id="sfx-miss" src="https://opengameart.org/sites/default/files/audio_preview/OGA-1294979155.mp3"></audio>

<div class="particle-container" id="particle-container"></div>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div id="loadingText">✨ 罗绮自飘香，朱门又深藏…… ✨</div>
</div>

<div class="toast" id="toast"></div>

<div id="genderSelectionOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">请择汝命</div>
        <div class="overlay-animation">🎭</div>
        <div class="overlay-content">
            即将开始一段全新的人生，你希望生于此世，是……
        </div>
        <div class="options" style="flex-direction: row; justify-content: center; gap: 15px;">
            <button class="option" onclick="startNewGame('male')">
                <i class="fas fa-male"></i> 世家公子
            </button>
            <button class="option" onclick="startNewGame('female')">
                <i class="fas fa-female"></i> 名门闺秀
            </button>
        </div>
    </div>
</div>

<div id="weddingOverlay" class="overlay">
    <div class="overlay-card" style="background: linear-gradient(135deg, #ffdde1 0%, #ee9ca7 100%); border-color: #c71585;">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🌸 大婚之喜 🌸</div>
        <div class="overlay-animation" style="animation: float 2.5s infinite ease-in-out; font-size: 4.5rem; text-shadow: 2px 2px 5px rgba(0,0,0,0.2);">囍</div>
        <div class="overlay-content-wrapper">
        <div class="overlay-content">
            红烛高照，喜气盈门，今日是<span class="overlay-name" id="weddingGroom"></span>与
            <span class="overlay-name" id="weddingBride"></span>大喜之日。<br>
            花轿临门，鼓乐喧天，新人拜堂成亲，结为百年之好，从此琴瑟和鸣，共赴白首。
        </div>
        </div>
        <button class="control-btn" onclick="closeAllOverlays()" style="margin-top: 20px; background: linear-gradient(135deg, #d84381, #c71585);">
            <i class="fas fa-check"></i> 开启新生活 ✨
        </button>
    </div>
</div>

<div id="inheritanceOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🕯️ 生死簿 🕯️</div>
        <div class="overlay-animation">📜</div>
        <div class="overlay-content-wrapper">
            <div class="overlay-content" id="finalGameSummary"></div>
            <div id="heir-selection" class="options"></div>
        </div>
        <div class="decision-options">
            <button class="control-btn" onclick="startNewGame(gameState.player.gender, null)" style="background: linear-gradient(135deg, #fab1a0, #e17055);">
                <i class="fas fa-redo"></i> 开启全新人生
            </button>
        </div>
    </div>
</div>

<div id="nameChildOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" id="closeBirthOverlayBtn" style="display:none;" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">喜得麟儿</div>
        <div class="overlay-content-wrapper">
            <div id="birthResultContent" class="overlay-content"></div>
            <div id="childNamingSection"></div>
            <div id="secretChildDecision" class="options" style="display:none; flex-direction:column;"></div>
        </div>
    </div>
</div>
<div id="renameChildOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">为子嗣更名</div>
        <div class="overlay-content-wrapper">
            <div class="overlay-content" id="renameChildContent">
                <p>请为<strong id="renameChildOldName"></strong>输入新名（不含姓氏）：</p>
                <div class="input-group">
                    <input type="text" id="renameChildInput" placeholder="请输入新名..." maxlength="3">
                </div>
            </div>
        </div>
        <div class="decision-options">
            <button class="control-btn" id="confirmRenameBtn" onclick="">
                <i class="fas fa-check"></i> 确认
            </button>
        </div>
    </div>
</div>
<div id="childRearingOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">👶 稚子教养 👶</div>
        <div class="overlay-content-wrapper" id="childRearingContent"></div>
    </div>
</div>

<div id="assetsOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🏠 我的资产 🏠</div>
        <div class="overlay-content-wrapper" id="assetsContent"></div>
    </div>
</div>

<div id="rankingsOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="rankingsHeader">🏆 京城贵女榜 🏆</div>
        <div class="overlay-content-wrapper" id="rankingsContent"></div>
    </div>
</div>

<div id="guzhengGameOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header" id="guzheng-song-name">一曲凤求凰</div>
        <div class="guzheng-game-container" id="guzheng-game-container">
            <div class="guzheng-perfect-zone"></div>
            <div class="guzheng-hit-line"></div>
            <div id="guzheng-feedback" class="guzheng-feedback"></div>
        </div>
        <div class="guzheng-hit-buttons-container" id="guzheng-hit-buttons-container">
            </div>
        <div id="guzheng-score-display" style="text-align:center; margin-top:15px; font-size: 1.2rem;">得分: 0</div>
    </div>
</div>

<div id="tradeSimOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">京城商会</div>
        <div class="overlay-content-wrapper" id="tradeSimContent">
            </div>
    </div>
</div>

<div id="merchantGuildOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🤝 商会经营 🤝</div>
         <div class="overlay-content-wrapper" id="merchantGuildContent">
            
            <div id="miniGameContainer" style="display: none;">
                </div>

        </div>
    </div>
</div>

<div id="npcDetailOverlay" class="overlay">
    <div class="overlay-card" id="npc-card-container">
        </div>
</div>

<div id="dateSceneOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="dateSceneHeader"></div>
        <div class="overlay-animation" id="dateSceneAnimation">💖</div>
        <div class="overlay-content-wrapper">
            <div id="dateSceneContent" class="overlay-content"></div>
        </div>
        <button class="control-btn" onclick="closeAllOverlays()">
            <i class="fas fa-heart"></i> 心动了 💖
        </button>
    </div>
</div>

<div id="marketOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🛒 琳琅市集 🛒</div>
        <div class="overlay-content-wrapper" id="marketContent"></div>
    </div>
</div>

<div id="restaurantOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🍻 琳琅食肆 🍻</div>
        <div class="overlay-content-wrapper" id="restaurantContent"></div>
    </div>
</div>

<div id="wishingWellOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🏞️ 仙池秘境 🏞️</div>
        <div class="overlay-animation">✨</div>
        <div class="overlay-content-wrapper">
            <div id="wishingWellContent" class="overlay-content"></div>
        </div>
        <div id="wishingWellOptions" class="decision-options"></div>
    </div>
</div>

<div id="careerChallengeOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="careerChallengeHeader"></div>
        <div class="overlay-animation" id="careerChallengeAnimation"></div>
        <div class="overlay-content-wrapper">
            <div class="overlay-content" id="careerChallengeContent"></div>
             <div class="options" id="careerChallengeOptions"></div>
        </div>
        <button class="control-btn" id="closeCareerChallengeResultBtn" style="display:none;" onclick="closeAllOverlays()"><i class="fas fa-check"></i> 知道了</button>
    </div>
</div>

<div id="clinicOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🏥 仁心医馆 🏥</div>
        <div class="overlay-content-wrapper" id="clinicContent"></div>
    </div>
</div>

<div id="debugOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">⚙️ 创世主模式 ⚙️</div>
        <div class="overlay-content-wrapper" id="debugContent"></div>
        <button class="control-btn" onclick="applyDebugChanges()" style="margin-top:10px;">应用修改</button>
    </div>
</div>

<div id="saveLoadOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="saveLoadHeader">管理存档</div>
        <div class="overlay-content-wrapper" id="saveLoadContent"></div>
    </div>
</div>

<div id="fengYueJianOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🏮 风月鉴 🏮</div>
        <div class="overlay-content-wrapper" id="fengYueJianContent"></div>
    </div>
</div>

<div id="arrangedMarriageOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">❤️ 门当户对 ❤️</div>
        <div class="overlay-content-wrapper" id="arrangedMarriageContent"></div>
    </div>
</div>

<div id="childMarriageOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">💍 子女婚事 💍</div>
        <div class="overlay-content-wrapper" id="childMarriageContent"></div>
    </div>
</div>

<div id="eventCardOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="eventCardHeader">事件发生</div>
        <div class="overlay-animation" id="eventCardAnimation">🎉</div>
        <div class="overlay-content-wrapper">
            <div id="eventCardContent" class="overlay-content"></div>
        </div>
        <button class="control-btn" onclick="closeAllOverlays()">
            <i class="fas fa-check"></i> 知晓了
        </button>
    </div>
</div>

<div id="decisionCardOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="decisionCardHeader">请君定夺</div>
        <div class="overlay-animation" id="decisionCardAnimation">🤔</div>
        <div class="overlay-content-wrapper">
            <div id="decisionCardContent" class="overlay-content"></div>
            <div id="decisionCardOptions" class="options" style="flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="newFriendEncounterOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header" id="newFriendEncounterHeader">萍水相逢</div>
        <div class="overlay-content-wrapper">
            <div id="newFriendEncounterContent" class="overlay-content"></div>
            <div id="newFriendEncounterOptions" class="options" style="flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="matchmakerOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">🤝 金牌媒婆 🤝</div>
         <div class="overlay-content-wrapper" id="matchmakerContent"></div>
    </div>
</div>

  <div id="apprenticeSystemOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">&times;</button>
        <div class="overlay-header">👨‍🎓 收徒系统 👩‍🎓</div>
        <div class="overlay-content-wrapper" id="apprenticeSystemContent"></div>
    </div>
</div>
<div class="container-wrapper">
    <div class="container" id="game-container">
        <!-- Game content is rendered here by JavaScript -->
    </div>
</div>

<div id="renameChildOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">为子嗣更名</div>
        <div class="overlay-content-wrapper">
            <div class="overlay-content" id="renameChildContent">
                <p>请为<strong id="renameChildOldName"></strong>输入新名（不含姓氏）：</p>
                <div class="input-group">
                    <input type="text" id="renameChildInput" placeholder="请输入新名..." maxlength="3">
                </div>
            </div>
        </div>
        <div class="decision-options">
            <button class="control-btn" id="confirmRenameBtn" onclick="">
                <i class="fas fa-check"></i> 确认
            </button>
        </div>
    </div>
</div>

<div id="specialInteractionOverlay" class="overlay">
    <div class="overlay-card" id="specialInteractionCard">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header" id="specialInteractionHeader"></div>
        <div class="overlay-content-wrapper">
            <div id="specialInteractionContent" class="overlay-content"></div>
            <div id="specialInteractionOptions" class="options" style="flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="poetryQuizOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">心有灵犀</div>
        <div class="overlay-content-wrapper">
            <div id="poetryQuizContent" class="overlay-content" style="text-align: center;">
                <p id="poetryQuestion" style="font-size: 1.2rem; margin-bottom: 20px;"></p>
                <div id="poetryOptions" class="options" style="flex-direction:column;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 放置在最后一个 overlay 之后, </body> 之前 -->
<div id="tradingOverlay" class="overlay">
    <div class="overlay-card" id="tradingOverlayCard" style="text-align: left; max-width: 95%;">
        <!-- 内容将由JS动态生成 -->
    </div>
</div>

<div id="gatheringOverlay" class="overlay">
    </div>

<div id="eventHubOverlay" class="overlay">
    <div class="overlay-card" style="max-width: 600px; width: 95%;">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">💌 信息中心 💌</div>
        <div id="event-hub-tracker" style="text-align: center; margin-bottom: 15px; font-size: 1.2rem;">
            </div>
        <div class="overlay-content-wrapper" id="eventHubContent" style="padding: 0;">
            </div>
    </div>
</div>

<div id="goGameOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">手谈对弈</div>
        <div id="goGameContainer" class="overlay-content">
            </div>
        <p id="goGameStatus" style="text-align:center; margin-top:15px;"></p>
    </div>
</div>

<div id="oathCeremonyOverlay" class="overlay">
    <div class="overlay-card" id="oathCeremonyCard">
        <div class="overlay-header" id="oathCeremonyHeader">义结金兰</div>
        <div class="overlay-animation" id="oathCeremonyAnimation">🤝</div>
        <div class="overlay-content-wrapper">
            <div id="oathCeremonyContent" class="overlay-content">
                </div>
            <div id="oathCeremonyOptions" class="options" style="flex-direction:column;">
                </div>
        </div>
        <button class="control-btn" id="oathCeremonyConfirmBtn" style="display:none;" onclick="completeOath()">
            <i class="fas fa-heart"></i> 礼成 · 此生不负
        </button>
    </div>
</div>
<div id="poetryEditorOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">书写情诗</div>
        <div id="poetryEditorContent" class="overlay-content-wrapper">
            <!-- 内容由JS动态生成 -->
        </div>
    </div>
</div>

<div id="tokenCraftingOverlay" class="overlay">
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">准备信物</div>
        <div id="tokenCraftingContent" class="overlay-content-wrapper">
            <!-- 内容由JS动态生成 -->
        </div>
    </div>
</div>

<div id="confessionSceneOverlay" class="overlay">
    <div class="overlay-card">
         <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div id="confessionSceneContent" class="overlay-content-wrapper">
            <!-- 内容由JS动态生成 -->
        </div>
    </div>
</div>

<div id="dustyMirrorOverlay" class="overlay">
    </div>

<div id="inheritanceBookOverlay" class="overlay">
    </div>

<script>
// =======================================================================
// ========================= GAME CORE & CONFIG ==========================
// =======================================================================
'use strict';
// --- DATA: Financial Tiers (As per detailed specification) ---
const financialTiers = [
    { level: 1, name: "赤贫如洗", threshold: 1000, expenses: { personal: 200, spouse: 100, concubine: 0, parent: 80, child_base: 60, child_edu: [{name: "无法上学", cost: 0, effect: {etiquette: 1, wisdom: 1, talent: 1, virtue: 1, reputation: 1, martial: 1, health: 1}}] } },
    { level: 2, name: "勉强度日", threshold: 10000, expenses: { personal: 600, spouse: 300, concubine: 0, parent: 240, child_base: 180, child_edu: [{name: "村塾", cost: 300, effect: {etiquette: 2, wisdom: 2, talent: 2, virtue: 2, reputation: 2, martial: 2, health: 2}}, {name: "公立学堂", cost: 480, effect: {etiquette: 3, wisdom: 3, talent: 3, virtue: 3, reputation: 3, martial: 3, health: 3}}] } },
    { level: 3, name: "小康之家", threshold: 50000, expenses: { personal: 1800, spouse: 900, concubine: 720, parent: 720, child_base: 540, child_edu: [{name: "私立书院", cost: 1440, effect: {etiquette: 5, wisdom: 5, talent: 5, virtue: 5, reputation: 5, martial: 5, health: 5}}, {name: "专项学艺", cost: 900, effect: {etiquette: 4, wisdom: 4, talent: 4, virtue: 4, reputation: 4, martial: 4, health: 4}}] } },
    { level: 4, name: "殷实富足", threshold: 200000, expenses: { personal: 6000, spouse: 3000, concubine: 1800, parent: 2400, child_base: 1800, child_edu: [{name: "精英家塾", cost: 4800, effect: {etiquette: 7, wisdom: 7, talent: 7, virtue: 7, reputation: 7, martial: 7, health: 7}}, {name: "贵族技艺", cost: 3000, effect: {etiquette: 6, wisdom: 6, talent: 6, virtue: 6, reputation: 6, martial: 6, health: 6}}] } },
    { level: 5, name: "豪门巨富", threshold: 500000, expenses: { personal: 24000, spouse: 12000, concubine: 7200, parent: 9600, child_base: 7200, child_edu: [{name: "名师一对一", cost: 10000, effect: {etiquette: 9, wisdom: 9, talent: 9, virtue: 9, reputation: 9, martial: 9, health: 9}}, {name: "武学大师", cost: 8000, effect: {etiquette: 8, wisdom: 8, talent: 8, virtue: 8, reputation: 8, martial: 8, health: 8}}] } },
    { level: 6, name: "富可敌国", threshold: 1000000, expenses: { personal: 50000, spouse: 25000, concubine: 15000, parent: 20000, child_base: 15000, child_edu: [{name: "进入宫学", cost: 25000, effect: {etiquette: 11, wisdom: 11, talent: 11, virtue: 11, reputation: 11, martial: 11, health: 11}}, {name: "海外游学", cost: 20000, effect: {etiquette: 10, wisdom: 10, talent: 10, virtue: 10, reputation: 10, martial: 10, health: 10}}] } },
    { level: 7, name: "皇室宗亲", threshold: Infinity, expenses: { personal: 100000, spouse: 50000, concubine: 30000, parent: 40000, child_base: 30000, child_edu: [{name: "太子伴读", cost: 50000, effect: {etiquette: 15, wisdom: 15, talent: 15, virtue: 15, reputation: 15, martial: 15, health: 15}}, {name: "御前侍卫", cost: 40000, effect: {etiquette: 13, wisdom: 13, talent: 13, virtue: 13, reputation: 13, martial: 13, health: 13}}] } }
];
let gameState = {};
let oathCeremonyState = {}; // 用于存储结拜仪式的临时状态
let isProcessing = false;
let avatarClickCount = 0;
let lastAvatarClickTime = 0;
const SAVE_SLOT_KEY_PREFIX = 'zhumenxiuhu_save_v10_slot_';
const TOTAL_SAVE_SLOTS = 5;
// ADD THESE NEW FUNCTIONS
// ADD THESE NEW FUNCTIONS
// ▼▼▼ 在这里粘贴全新的JS代码 ▼▼▼

// =======================================================================
// ========================= 【新功能】信息中心核心逻辑 ========================
// =======================================================================
let pendingEvents = [];

function addPendingEvent(eventData) {
    // eventData 结构: { title, icon, description, options }
    // options 结构: [{ htmlContent, disabled, callback, ... }]
    pendingEvents.push(eventData);
}

function openEventHub() {
    if (pendingEvents.length === 0) {
        showToast("当前没有需要处理的信息。");
        return;
    }
    renderEventHub();
    showOverlay('eventHubOverlay');
}
function openFengYueJian() {
    const content = document.getElementById('fengYueJianContent');
    let html = '<div class="options" style="flex-direction:column;">';

    if (gameState.player.gender === 'female') {
        const potentialLovers = Object.values(gameState.npcs).filter(npc =>
            npc.gender === 'male' &&
            !npc.isFamily &&
            npc.age > 16 &&
            !npc.isDead &&
            (gameState.social.relationships[npc.id]?.type !== 'lover' && gameState.social.relationships[npc.id]?.type !== 'spouse')
        );

        if (potentialLovers.length > 0) {
            potentialLovers.forEach(npc => {
                html += `
                    <div class.option" onclick="interactWithFengYueJianNpc('${npc.id}')">
                        <div class="suitor-details">
                            <div class="suitor-name">${npc.name} <span class="comment">(${npc.title})</span></div>
                            <div class="suitor-desc">好感: ${gameState.social.relationships[npc.id]?.favor || 0}</div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p class="comment">暂无合适的交往人选。</p>';
        }
    } else { // **<-- 新增的男性玩家逻辑**
        const potentialConcubines = Object.values(gameState.npcs).filter(npc =>
            npc.gender === 'female' &&
            !npc.isFamily &&
            npc.age > 16 &&
            !npc.isDead &&
            npc.title.includes('歌姬') || npc.title.includes('舞姬')
        );

        if (potentialConcubines.length > 0) {
            potentialConcubines.forEach(npc => {
                const favor = gameState.social.relationships[npc.id]?.favor || 0;
                html += `
                    <div class="option" style="justify-content: space-between;">
                        <div class="suitor-details">
                            <div class="suitor-name">${npc.name} <span class="comment">(${npc.title})</span></div>
                            <div class="suitor-desc">好感: ${favor}</div>
                        </div>
                        <button class="control-btn" onclick="proposeToConcubine('${npc.id}')" ${favor < 100 ? 'disabled' : ''}>
                            <i class="fas fa-heart"></i> ${favor < 100 ? `好感需100` : '纳为妾室'}
                        </button>
                    </div>
                `;
            });
        } else {
            html += '<p class="comment">风月场中暂无合适的姑娘。</p>';
        }
    }

    html += '</div>';
    content.innerHTML = html;
    showOverlay('fengYueJianOverlay');
}
function renderEventHub() {
    const tracker = document.getElementById('event-hub-tracker');
    const content = document.getElementById('eventHubContent');

    // 更新待办事件计数（星星）
    let starsHTML = '';
    for (let i = 0; i < pendingEvents.length; i++) {
        starsHTML += `<i class="fas fa-star" style="color: #f1c40f; margin: 0 2px;"></i>`;
    }
    tracker.innerHTML = `待处理信息: ${starsHTML}`;

    if (pendingEvents.length > 0) {
        // 【核心修改】将所有待办事件以列表形式展示
        content.innerHTML = `
            <div class="inventory-container" style="padding: 10px;">
                ${pendingEvents.map((event, index) => `
                    <div class="inventory-item" style="cursor: pointer;" onclick="showHubEventDetails(${index})">
                        <div class="inventory-item-icon"><i class="fas ${event.icon || 'fa-info-circle'}"></i></div>
                        <div class="inventory-item-details">
                            <div class="inventory-item-name">${event.title}</div>
                            <div class="inventory-item-desc">${event.description.substring(0, 40)}...</div>
                        </div>
                        <div><i class="fas fa-chevron-right"></i></div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        // 所有事件都处理完了
        tracker.innerHTML = `<i class="fas fa-check-circle" style="color: green;"></i> 全部处理完毕`;
        content.innerHTML = `<p class="comment" style="text-align:center; padding: 20px;">所有信息均已处理完毕，请点击右上角关闭。</p>`;
    }
}

/**
 * 【全新函数】当玩家点击信息中心列表中的某一个事件时，弹出该事件的详细处理窗口
 * @param {number} eventIndex 玩家点击的事件在待办队列中的索引
 */
function showHubEventDetails(eventIndex) {
    const event = pendingEvents[eventIndex];
    if (!event) return;

    // 为弹窗的选项按钮重新包装回调函数
    const decisionOptions = event.options.map((opt) => {
        return {
            htmlContent: opt.htmlContent,
            disabled: opt.disabled,
            callback: () => {
                // 1. 先执行选项本身的效果（如加属性、显示结果等）
                if (opt.callback) {
                    opt.callback();
                }
                
                // 2. 从待办队列中移除这个已处理的事件
                //    必须在执行完回调后再移除，以防索引错乱
                const originalIndex = pendingEvents.findIndex(p => p === event);
                if (originalIndex !== -1) {
                    pendingEvents.splice(originalIndex, 1);
                }
                
                // 3. 重新渲染信息中心，列表和星星会随之更新
                renderEventHub();

                // 4. 关闭当前的详细事件弹窗
                //    注意：showEventCard 本身就是一个弹窗，所以这里不需要再手动关闭
                //    如果 opt.callback 没有调用 showEventCard, 则需要手动关闭
                if (!opt.callback || !opt.callback.toString().includes('showEventCard')) {
                    closeAllOverlays();
                    // 并且重新打开信息中心，因为可能被关闭了
                    showOverlay('eventHubOverlay');
                }
            }
        };
    });

    // 使用游戏已有的决策弹窗来显示事件详情
    showDecisionCard(event.title, event.icon || 'fa-info-circle', event.description, decisionOptions);
}
function handleEventHubChoice(eventIndex, optionIndex) {
    const event = pendingEvents[eventIndex];
    const option = event.options[optionIndex];

    if (option.callback) {
        option.callback();
    }

    // 从队列中移除已处理的事件
    pendingEvents.splice(eventIndex, 1);

    // 刷新信息中心，显示下一个事件或完成状态
    renderEventHub();
}
// [替换] HUB_EVENTS 对象
// [替换] HUB_EVENTS 对象
const HUB_EVENTS = {
    // 父母互动事件
    parent_health_concern: {
        type: 'parent',
        condition: (gs) => gs.family.members.motherId && gs.npcs[gs.family.members.motherId] && !gs.npcs[gs.family.members.motherId].isDead,
        generate: (gs) => {
            const mother = gs.npcs[gs.family.members.motherId];
            return {
                title: "母亲的嘱托", icon: "fa-user-md", description: `母亲捎信给你，说最近天气转凉，感觉身体有些不适，让你多注意身体，也盼着你回家看看。`,
                options: [
                    { htmlContent: "【送去500两银票】", disabled: gs.finances.wealth < 500, callback: () => {
                        applyEffects({ wealth: -500, relationship: { targetId: mother.id, favor: 10 }, attributes: { virtue: 5 } });
                        showEventCard("拳拳孝心", "fa-money-bill-wave", "你送去银两，母亲夸你孝顺。");
                    }},
                    { htmlContent: "【亲自回家探望】", callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: 15 }, attributes: { virtue: 8, health: 5 } });
                        showEventCard("承欢膝下", "fa-home", "你的探望让母亲非常开心，你们共度了一段温馨的时光。");
                    }},
                    { htmlContent: "【回信问候】", callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: 3 } });
                        showEventCard("纸短情长", "fa-envelope", "你写了一封长信，母亲读后倍感欣慰。");
                    }}
                ]
            };
        }
    },
    father_career_advice: {
        type: 'parent',
        condition: (gs) => gs.family.members.fatherId && gs.npcs[gs.family.members.fatherId] && !gs.npcs[gs.family.members.fatherId].isDead && gs.career.path,
        generate: (gs) => {
            const father = gs.npcs[gs.family.members.fatherId];
            return {
                title: "父亲的教诲", icon: "fa-gavel", description: `父亲唤你去书房，考校你最近在事业上的进展，并对你未来的道路提出了一些建议。`,
                options: [
                    { htmlContent: "【虚心请教】", callback: () => {
                        applyEffects({ relationship: { targetId: father.id, favor: 10 }, attributes: { wisdom: 5 } });
                        gs.career.performance += 10;
                        showEventCard("受益匪浅", "fa-lightbulb", "父亲的经验之谈让你茅塞顿开。");
                    }},
                    { htmlContent: "【不以为然】", callback: () => {
                        applyEffects({ relationship: { targetId: father.id, favor: -5 } });
                        showEventCard("固执己见", "fa-times-circle", "你觉得父亲的看法已经过时，父亲对你的态度有些失望。");
                    }},
                ]
            };
        }
    },
    parent_reminisce: {
        type: 'parent',
        condition: (gs) => gs.family.members.fatherId && gs.npcs[gs.family.members.fatherId] && !gs.npcs[gs.family.members.fatherId].isDead,
        generate: (gs) => {
            const father = gs.npcs[gs.family.members.fatherId];
            return {
                title: "追忆往昔", icon: "fa-history", description: `父亲与你聊起他年轻时的光辉岁月，言语间颇为自豪。`,
                options: [
                    { htmlContent: "【认真倾听，表示崇拜】", callback: () => {
                        applyEffects({ relationship: { targetId: father.id, favor: 10 } });
                        showEventCard("父子情深", "fa-user-friends", "你的崇拜让父亲非常受用。");
                    }},
                    { htmlContent: "【听得不耐烦】", callback: () => {
                        applyEffects({ relationship: { targetId: father.id, favor: -5 } });
                        showEventCard("代沟", "fa-meh", "你觉得这些事已经听过很多遍了。");
                    }}
                ]
            };
        }
    },
    parent_investment_advice: {
        type: 'parent',
        condition: (gs) => gs.family.members.fatherId && gs.npcs[gs.family.members.fatherId] && !gs.npcs[gs.family.members.fatherId].isDead,
        generate: (gs) => {
            const father = gs.npcs[gs.family.members.fatherId];
            return {
                title: "父亲的投资建议", icon: "fa-chart-line", description: `父亲告诉你，他最近看好城南的一处地产，建议你投资。`,
                options: [
                    { htmlContent: "【听从建议，投资5000两】", disabled: gs.finances.wealth < 5000, callback: () => {
                        applyEffects({ wealth: -5000 });
                        if (Math.random() < 0.6) {
                            applyEffects({ wealth: 7500 });
                            showEventCard("投资成功", "fa-arrow-up", "你听从了父亲的建议，投资获得了丰厚回报！");
                        } else {
                            showEventCard("投资失败", "fa-arrow-down", "不幸的是，那处地产并未如预期般增值。");
                        }
                    }},
                    { htmlContent: "【婉言谢绝】", callback: () => {
                        applyEffects({ relationship: { targetId: father.id, favor: -3 } });
                        showEventCard("另有打算", "fa-times", "你表示自己另有投资计划，父亲略感失望。");
                    }}
                ]
            };
        }
    },
    parent_family_gossip: {
        type: 'parent',
        condition: (gs) => gs.family.members.motherId && gs.npcs[gs.family.members.motherId] && !gs.npcs[gs.family.members.motherId].isDead,
        generate: (gs) => {
            const mother = gs.npcs[gs.family.members.motherId];
            return {
                title: "母亲的闲谈", icon: "fa-comments", description: `母亲与你闲聊时，说起一位远房表亲的婚事不顺，言语间颇为感慨。`,
                options: [
                    { htmlContent: "【一同感慨】", callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: 5 }, attributes: { charm: 2 } });
                        showEventCard("感同身受", "fa-sad-tear", "你与母亲一同感慨世事无常，你们的关系更近了。");
                    }},
                    { htmlContent: "【出谋划策】", callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: 8 }, attributes: { wisdom: 3 } });
                        showEventCard("贤内助", "fa-lightbulb", "你为表亲的婚事出了些主意，母亲夸你聪慧。");
                    }}
                ]
            };
        }
    },
    // 子女互动事件
    child_education_progress: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead && c.age >= 4 && c.age < 18),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead && c.age >= 4 && c.age < 18));
            return {
                title: "子嗣的学业", icon: "fa-book-reader", description: `你孩子的老师派人传话，说 <strong class="highlight-npc">${child.name}</strong> 最近在学业上遇到了瓶颈，希望你能多加关心。`,
                options: [
                    { htmlContent: "【亲自辅导】", req: { wisdom: 60 }, callback: () => {
                        child.attributes.wisdom = (child.attributes.wisdom || 0) + 5;
                        child.favor = (child.favor || 50) + 10;
                        showEventCard("悉心教导", "fa-chalkboard-teacher", "在你的帮助下，孩子克服了难关。");
                    }},
                    { htmlContent: "【严厉斥责】", callback: () => {
                        child.favor = (child.favor || 50) - 10;
                        showEventCard("严厉的爱", "fa-angry", "你斥责了孩子，TA看起来很委屈。");
                    }},
                    { htmlContent: "【请更好的老师】", disabled: gs.finances.wealth < 1000, callback: () => {
                        applyEffects({ wealth: -1000 });
                        child.attributes.wisdom = (child.attributes.wisdom || 0) + 3;
                        showEventCard("重金投入", "fa-money-check-alt", "你花费千金为孩子请了名师。");
                    }}
                ]
            };
        }
    },
    child_play_together: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead && c.age >= 4),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead && c.age >= 4));
            return {
                title: "亲子时光", icon: "fa-puzzle-piece", description: `<strong class="highlight-npc">${child.name}</strong> 抱着一个玩具，眼巴巴地望着你，希望你能陪TA玩一会儿。`,
                options: [
                    { htmlContent: "【欣然同意】", callback: () => {
                        child.favor = (child.favor || 50) + 15;
                        gs.player.health += 5;
                        showEventCard("其乐融融", "fa-grin-hearts", "你和孩子度过了一段快乐的时光，感觉身心都放松了。");
                    }},
                    { htmlContent: "【“下次一定”】", callback: () => {
                        child.favor = (child.favor || 50) - 5;
                        showEventCard("失落的眼神", "fa-sad-tear", "孩子失望地走开了。");
                    }}
                ]
            };
        }
    },
    child_fight: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead && c.age >= 6),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead && c.age >= 6));
            return {
                title: "孩童的争执", icon: "fa-fist-raised", description: `你的孩子 <strong class="highlight-npc">${child.name}</strong> 与邻居家的孩子打架了，对方家长找上门来。`,
                options: [
                    { htmlContent: "【袒护自己的孩子】", callback: () => {
                        child.favor = (child.favor || 50) + 10;
                        applyEffects({attributes: {virtue: -5}});
                        showEventCard("护犊情深", "fa-shield-alt", "你袒护了孩子，TA觉得你很伟大。");
                    }},
                    { htmlContent: "【赔礼道歉】", callback: () => {
                        applyEffects({wealth: -50, attributes: {virtue: 5}});
                        showEventCard("息事宁人", "fa-handshake", "你赔偿了对方，平息了事端。");
                    }},
                    { htmlContent: "【让孩子们自己解决】", callback: () => {
                        child.attributes.wisdom = (child.attributes.wisdom || 0) + 2;
                        showEventCard("锻炼成长", "fa-child", "你让孩子自己面对，这对他也是一种锻炼。");
                    }}
                ]
            };
        }
    },
    child_illness: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead));
            return {
                title: "子嗣抱恙", icon: "fa-thermometer", description: `你的孩子 <strong class="highlight-npc">${child.name}</strong> 突然发起高烧，看起来很难受。`,
                options: [
                    { htmlContent: "【亲自照料】", callback: () => {
                        child.favor += 20;
                        child.attributes.health += 10;
                        gs.player.health -= 5;
                        showEventCard("悉心照料", "fa-bed", "在你的悉心照料下，孩子很快康复了，但你也累坏了。");
                    }},
                    { htmlContent: "【请名医】", disabled: gs.finances.wealth < 300, callback: () => {
                        applyEffects({ wealth: -300 });
                        child.attributes.health += 15;
                        showEventCard("药到病除", "fa-pills", "你请来的名医很快治好了孩子。");
                    }}
                ]
            };
        }
    },
    child_found_item: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead && c.age >= 8),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead && c.age >= 8));
            return {
                title: "意外的发现", icon: "fa-gem", description: `你的孩子 <strong class="highlight-npc">${child.name}</strong> 在后院玩耍时，挖出了一件看起来很值钱的旧物，兴冲冲地拿给你看。`,
                options: [
                    { htmlContent: "【收下并表扬】", callback: () => {
                        applyEffects({ wealth: getRandomInt(100, 500) });
                        child.favor += 10;
                        showEventCard("意外之财", "fa-coins", "你收下了这件旧物，发现竟值不少钱，并表扬了孩子。");
                    }},
                    { htmlContent: "【物归原主】", callback: () => {
                        applyEffects({ attributes: { virtue: 10 } });
                        child.attributes.virtue += 5;
                        showEventCard("拾金不昧", "fa-hand-holding-heart", "你教导孩子要拾金不昧，并一同找到了失主。");
                    }}
                ]
            };
        }
    },
    // 情人互动事件
    lover_secret_gift: {
        type: 'lover',
        condition: (gs) => gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            return {
                title: "秘密赠礼", icon: "fa-gift", description: `你的情人 <strong class="highlight-npc">${lover.name}</strong> 托人给你送来一件礼物，并附上一张纸条：“见物如面”。`,
                options: [
                    { htmlContent: "【欣然收下】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: 10 } });
                        if(Math.random() < 0.5) applyEffects({wealth: 200});
                        showEventCard("心有灵犀", "fa-heart", "一份贴心的礼物让你们的情感升温。");
                    }},
                    { htmlContent: "【悄悄退回】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: -5 } });
                        showEventCard("保持距离", "fa-hand-paper", "你认为过于频繁的礼物交换会增加暴露的风险。");
                    }}
                ]
            };
        }
    },
    lover_jealousy: {
        type: 'lover',
        condition: (gs) => gs.marriage.isMarried && gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            return {
                title: "情人的醋意", icon: "fa-fire", description: `你与正妻/夫君一同出行的事传到了 <strong class="highlight-npc">${lover.name}</strong> 的耳中，TA似乎有些不悦。`,
                options: [
                    { htmlContent: "【写信安抚】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: 8 } });
                        showEventCard("甜言蜜语", "fa-pen-fancy", "你的情书化解了TA的醋意。");
                    }},
                    { htmlContent: "【赠送礼物】", disabled: gs.finances.wealth < 300, callback: () => {
                        applyEffects({ wealth: -300, relationship: { targetId: lover.id, favor: 12 } });
                        showEventCard("物质补偿", "fa-gem", "没有什么是一个礼物解决不了的。");
                    }},
                    { htmlContent: "【不予理会】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: -10 } });
                        showEventCard("关系冷淡", "fa-snowflake", "你的冷处理让TA更加伤心。");
                    }}
                ]
            };
        }
    },
    lover_meet_secretly: {
        type: 'lover',
        condition: (gs) => gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            return {
                title: "危险的邀约", icon: "fa-mask", description: `<strong class="highlight-npc">${lover.name}</strong> 邀你在城外破庙私会，此举颇为冒险。`,
                options: [
                    { htmlContent: "【赴约】", callback: () => {
                        if (Math.random() > 0.1) {
                            applyEffects({ relationship: { targetId: lover.id, favor: 20 } });
                            showEventCard("惊心动魄", "fa-heartbeat", "你们度过了一个刺激而缠绵的夜晚。");
                            if(gs.player.gender === 'female') triggerBirth(lover.id, true);
                        } else {
                            if(gs.marriage.isMarried) {
                                const spouse = gs.npcs[gs.marriage.spouseId];
                                spouse.suspicionValue = (spouse.suspicionValue || 0) + 30;
                                showEventCard("东窗事发", "fa-exclamation-circle", "你们的私情被发现了！");
                            }
                        }
                    }},
                    { htmlContent: "【拒绝】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: -8 } });
                        showEventCard("谨慎为上", "fa-user-shield", "你拒绝了这次危险的约会。");
                    }}
                ]
            };
        }
    },
    lover_dream: {
        type: 'lover',
        condition: (gs) => gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            return {
                title: "梦中的你", icon: "fa-cloud-moon", description: `你的情人 <strong class="highlight-npc">${lover.name}</strong> 告诉你，昨夜梦到了你，梦里的你们...`,
                options: [
                    { htmlContent: "【追问梦境细节】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: 10, devotion: 5 } });
                        showEventCard("梦境低语", "fa-kiss", "TA在你耳边低语了梦中的细节，你们的关系更加亲密。");
                    }},
                    { htmlContent: "【一笑置之】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: 2 } });
                        showEventCard("日有所思", "fa-smile", "你笑着说这不过是日有所思夜有所梦罢了。");
                    }}
                ]
            };
        }
    },
    lover_family_pressure: {
        type: 'lover',
        condition: (gs) => gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            return {
                title: "家中的压力", icon: "fa-users", description: `情人 <strong class="highlight-npc">${lover.name}</strong> 最近看起来心事重重，原来是家中正在为TA安排婚事。`,
                options: [
                    { htmlContent: "【承诺会给TA一个名分】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: 15, devotion: 10 } });
                        showEventCard("海誓山盟", "fa-ring", "你的承诺让TA暂时安心。");
                    }},
                    { htmlContent: "【劝TA为了家族妥协】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: -20, devotion: -15 } });
                        showEventCard("无言的结局", "fa-heart-broken", "你的劝说让TA彻底心碎，你们的关系走到了尽头。");
                        // 关系破裂逻辑
                        delete gs.social.relationships[lover.id];
                        gs.social.secretLovers = gs.social.secretLovers.filter(id => id !== lover.id);
                    }}
                ]
            };
        }
    },
    // 结义互动
    sworn_sibling_drink: {
        type: 'sworn',
        condition: (gs) => gs.social.swornSiblings && gs.social.swornSiblings.length > 0,
        generate: (gs) => {
            const sibling = gs.npcs[getRandomElement(gs.social.swornSiblings)];
            return {
                title: "金兰之约", icon: "fa-wine-glass-alt", description: `你的结义兄弟/姐妹 <strong class="highlight-npc">${sibling.name}</strong> 邀你一同去酒楼痛饮一番。`,
                options: [
                    { htmlContent: "【欣然赴约】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: 10 }, attributes: { health: -2, charm: 2 } });
                        showEventCard("不醉不归", "fa-glass-cheers", "你们一醉方休，诉说衷肠。");
                    }},
                    { htmlContent: "【婉言谢绝】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: -3 } });
                        showEventCard("下次再约", "fa-times", "你因故谢绝，对方表示理解。");
                    }}
                ]
            };
        }
    },
    sworn_sibling_trouble: {
        type: 'sworn',
        condition: (gs) => gs.social.swornSiblings && gs.social.swornSiblings.length > 0,
        generate: (gs) => {
            const sibling = gs.npcs[getRandomElement(gs.social.swornSiblings)];
            return {
                title: "义兄/妹的麻烦", icon: "fa-exclamation-triangle", description: `你的结义兄弟/姐妹 <strong class="highlight-npc">${sibling.name}</strong> 在外惹了麻烦，被仇家追杀，向你求助。`,
                options: [
                    { htmlContent: "【倾力相助】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: 25, devotion: 15 }, attributes: { health: -10, martial: 5 } });
                        showEventCard("两肋插刀", "fa-shield-alt", "你为兄弟/姐妹出头，虽然受了些伤，但你们的情谊更加深厚。");
                    }},
                    { htmlContent: "【假装不知】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: -30, devotion: -20 } });
                        showEventCard("明哲保身", "fa-user-shield", "你选择了袖手旁观，对方对你失望透顶。");
                    }}
                ]
            };
        }
    },
    sworn_sibling_opportunity: {
        type: 'sworn',
        condition: (gs) => gs.social.swornSiblings && gs.social.swornSiblings.length > 0,
        generate: (gs) => {
            const sibling = gs.npcs[getRandomElement(gs.social.swornSiblings)];
            return {
                title: "共同的机遇", icon: "fa-handshake", description: `你的结义兄弟/姐妹 <strong class="highlight-npc">${sibling.name}</strong> 发现了一个商业/事业上的好机会，邀请你一同参与。`,
                options: [
                    { htmlContent: "【共同投资】", disabled: gs.finances.wealth < 2000, callback: () => {
                        applyEffects({ wealth: -2000 });
                        if(Math.random() < 0.7) {
                            applyEffects({ wealth: 4000 });
                            showEventCard("合作共赢", "fa-chart-pie", "你们的合作非常成功，获得了双倍回报！");
                        } else {
                            showEventCard("投资失利", "fa-chart-area", "不幸的是，这次投资失败了。");
                        }
                    }},
                    { htmlContent: "【谢绝好意】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: -5 } });
                        showEventCard("错失良机", "fa-times", "你谢绝了对方的好意。");
                    }}
                ]
            };
        }
    },
    // NPC 互动
    npc_gift: {
        type: 'npc',
        condition: (gs) => Object.keys(gs.social.relationships).length > 0,
        generate: (gs) => {
            const friendId = getRandomElement(Object.keys(gs.social.relationships));
            const friend = gs.npcs[friendId];
            const giftAmount = 50 + Math.floor(friend.favor);
            return {
                title: "友人赠礼", icon: "fa-box-open", description: `你的友人 <strong class="highlight-npc">${friend.name}</strong> 前来拜访，并为你带来一份价值约 <span class="value">${giftAmount}</span> 两的薄礼。`,
                options: [
                    { htmlContent: "【欣然收下】", callback: () => {
                        applyEffects({ wealth: giftAmount, relationship: { targetId: friend.id, favor: 5 } });
                        showEventCard("礼尚往来", "fa-handshake", "你收下了礼物，并与对方相谈甚欢。");
                    }},
                    { htmlContent: "【回赠等价礼物】", disabled: gs.finances.wealth < giftAmount, callback: () => {
                         applyEffects({ relationship: { targetId: friend.id, favor: 10 } });
                         showEventCard("君子之交", "fa-balance-scale", "你的举动让对方颇为欣赏。");
                    }}
                ]
            };
        }
    },
    npc_invitation: {
        type: 'npc',
        condition: (gs) => Object.keys(gs.social.relationships).length > 1,
        generate: (gs) => {
            const friend = gs.npcs[getRandomElement(Object.keys(gs.social.relationships))];
            return {
                title: "友人邀约", icon: "fa-envelope-open-text", description: `友人 <strong class="highlight-npc">${friend.name}</strong> 邀请你参加一场文会雅集。`,
                options: [
                    { htmlContent: "【欣然赴约】", callback: () => {
                        applyEffects({ relationship: { targetId: friend.id, favor: 5 }, attributes: { charm: 2, talent: 2 } });
                        showEventCard("高朋满座", "fa-users", "你在雅集上结识了新朋友，收获颇丰。");
                    }},
                    { htmlContent: "【托故推辞】", callback: () => {
                        applyEffects({ relationship: { targetId: friend.id, favor: -2 } });
                        showEventCard("分身乏术", "fa-bed", "你因故未能赴约。");
                    }}
                ]
            };
        }
    },
    npc_seek_help: {
        type: 'npc',
        condition: (gs) => gs.career.path && Object.keys(gs.social.relationships).length > 0,
        generate: (gs) => {
            const friend = gs.npcs[getRandomElement(Object.keys(gs.social.relationships))];
            return {
                title: "友人求助", icon: "fa-question-circle", description: `你的友人 <strong class="highlight-npc">${friend.name}</strong> 在事业上遇到了困难，前来向你求助。`,
                options: [
                    { htmlContent: "【倾囊相助】", callback: () => {
                        applyEffects({ relationship: { targetId: friend.id, favor: 15, devotion: 10 }, attributes: { reputation: 5 } });
                        showEventCard("雪中送炭", "fa-hands-helping", "你帮助友人渡过了难关，你们的友谊更加牢固。");
                    }},
                    { htmlContent: "【爱莫能助】", callback: () => {
                        applyEffects({ relationship: { targetId: friend.id, favor: -8 } });
                        showEventCard("心有余力不足", "fa-times", "你表示无能为力，对方有些失望。");
                    }}
                ]
            };
        }
    },
    // 职业突发事件
    career_emergency: {
        type: 'career',
        condition: (gs) => gs.career.path && gs.career.level > 1,
        generate: (gs) => {
            const careerName = PROFESSION_DATA[gs.career.path].name;
            return {
                title: `${careerName}突发事件`, icon: "fa-exclamation-triangle", description: `你的上司交给你一个紧急且棘手的任务，要求你在短时间内完成，此事关系到你的考评。`,
                options: [
                    { htmlContent: "【全力以赴】", callback: () => {
                        gs.career.performance += 30;
                        applyEffects({ attributes: { health: -5 } });
                        showEventCard("迎难而上", "fa-chart-line", "你出色地完成了任务，获得了上司的赞赏。");
                    }},
                    { htmlContent: "【寻求同僚帮助】", callback: () => {
                        gs.career.performance += 15;
                        showEventCard("团队合作", "fa-users", "在同僚的帮助下，你们顺利完成了任务。");
                    }},
                    { htmlContent: "【敷衍了事】", callback: () => {
                        gs.career.performance -= 20;
                        showEventCard("得过且过", "fa-thumbs-down", "你的敷衍态度让上司非常不满。");
                    }}
                ]
            };
        }
    },
    career_competition: {
        type: 'career',
        condition: (gs) => gs.career.path && gs.career.level > 2,
        generate: (gs) => {
            return {
                title: "职场竞争", icon: "fa-user-tie", description: `一位同僚与你竞争同一个晋升名额，对方似乎在暗中给你下绊子。`,
                options: [
                    { htmlContent: "【用实力说话】", callback: () => {
                        gs.career.performance += 25;
                        showEventCard("实力碾压", "fa-award", "你用出色的业绩回应了所有质疑。");
                    }},
                    { htmlContent: "【以牙还牙】", callback: () => {
                        if (gs.player.attributes.wisdom > 70) {
                            showEventCard("反将一军", "fa-chess-knight", "你巧妙地识破并反击了对方的计谋。");
                        } else {
                            gs.career.performance -= 15;
                            showEventCard("弄巧成拙", "fa-frown", "你的计谋被识破，反而让自己陷入被动。");
                        }
                    }}
                ]
            };
        }
    },
    career_windfall: {
        type: 'career',
        condition: (gs) => gs.career.path,
        generate: (gs) => {
            return {
                title: "意外之喜", icon: "fa-gift", description: `你因一项出色的工作表现，获得了上司的额外嘉奖。`,
                options: [
                    { htmlContent: "【欣然接受】", callback: () => {
                        applyEffects({ wealth: 500 });
                        gs.career.performance += 10;
                        showEventCard("天道酬勤", "fa-money-bill", "你获得了500两的额外奖赏。");
                    }},
                    { htmlContent: "【与团队分享】", callback: () => {
                        applyEffects({ wealth: 250, attributes: { charm: 5, virtue: 5 } });
                        gs.career.performance += 10;
                        showEventCard("团队精神", "fa-users", "你将一半奖赏分给了团队，赢得了人心。");
                    }}
                ]
            };
        }
    },
    // 修身事件
    self_cultivation_book: {
        type: 'self',
        condition: (gs) => true,
        generate: (gs) => {
            return {
                title: "修身养性", icon: "fa-book", description: `闲暇之时，你得到一本古籍，似乎蕴含着深刻的智慧。`,
                options: [
                    { htmlContent: "【潜心研读】", callback: () => {
                        applyEffects({ attributes: { wisdom: 3, talent: 1 } });
                        showEventCard("开卷有益", "fa-lightbulb", "书中智慧让你获益匪浅。");
                    }},
                    { htmlContent: "【一目十行】", callback: () => {
                         applyEffects({ attributes: { wisdom: 1 } });
                         showEventCard("囫囵吞枣", "fa-glasses", "你快速翻阅了一遍。");
                    }}
                ]
            };
        }
    },
    self_reflection: {
        type: 'self',
        condition: (gs) => true,
        generate: (gs) => {
            return {
                title: "静夜反思", icon: "fa-moon", description: "夜深人静，你回顾最近的得失，对自己的人生有了新的思考。",
                options: [
                    { htmlContent: "【反思人际关系】", callback: () => {
                        applyEffects({ attributes: { charm: 2, wisdom: 1 } });
                        showEventCard("人情练达", "fa-users", "你对人情世故的理解更深了。");
                    }},
                    { htmlContent: "【反思事业规划】", callback: () => {
                        applyEffects({ attributes: { wisdom: 3 } });
                        gs.career.performance += 5;
                        showEventCard("运筹帷幄", "fa-chess", "你对未来的事业道路更加清晰。");
                    }},
                    { htmlContent: "【放空自己】", callback: () => {
                        applyEffects({ attributes: { health: 5 } });
                        showEventCard("无事小神仙", "fa-leaf", "什么都不想，也是一种修行。");
                    }}
                ]
            };
        }
    },
    self_encounter_master: {
        type: 'self',
        condition: (gs) => true,
        generate: (gs) => {
            return {
                title: "偶遇高人", icon: "fa-user-ninja", description: "你在山中偶遇一位仙风道骨的高人，对方似乎愿意指点你一二。",
                options: [
                    { htmlContent: "【请教武学】", callback: () => {
                        applyEffects({ attributes: { martial: 8 } });
                        showEventCard("武学精进", "fa-khanda", "高人指点了你几招，你的武学大有长进。");
                    }},
                    { htmlContent: "【请教棋艺】", callback: () => {
                        applyEffects({ attributes: { wisdom: 8 } });
                        showEventCard("棋力大增", "fa-chess-board", "与高人对弈一局，你的智慧和棋力都提升了。");
                    }}
                ]
            };
        }
    },
    // ============= 新增事件 START ===============
    parent_marriage_suggestion: {
        type: 'parent',
        condition: (gs) => gs.family.members.motherId && !gs.marriage.isMarried && gs.player.age >= 16,
        generate: (gs) => {
            const mother = gs.npcs[gs.family.members.motherId];
            return {
                title: "母亲的安排", icon: "fa-ring", description: `母亲看你已到适婚年龄，特地为你物色了一门亲事，对方是 <strong class="highlight-npc">吏部侍郎家的公子/千金</strong>，家世人品俱佳。`,
                options: [
                    { htmlContent: "【同意相看】", callback: () => {
                        const partnerGender = gs.player.gender === 'male' ? 'female' : 'male';
                        const newSuitor = generateNPC({
                            gender: partnerGender,
                            age: gs.player.age + 1,
                            attributes: { family: 75, charm: 70, etiquette: 75, wisdom: 65 },
                            title: `吏部侍郎家的${partnerGender === 'male' ? '公子' : '千金'}`,
                            role: '相亲对象'
                        });
                        gs.suitors.push(newSuitor.id);
                        applyEffects({ relationship: { targetId: mother.id, favor: 10 } });
                        showEventCard("听从安排", "fa-handshake", `你同意了母亲的安排，不久后便见到了${newSuitor.name}，对方似乎对你印象不错。`);
                    }},
                    { htmlContent: "【婉言谢绝】", callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: -5 } });
                        showEventCard("自由的向往", "fa-dove", "你表示自己的婚事想自己做主，母亲虽然有些失望，但也尊重你的想法。");
                    }}
                ]
            };
        }
    },
    child_special_talent: {
        type: 'child',
        condition: (gs) => gs.children.some(c => !c.isDead && c.age >= 8 && c.age < 15),
        generate: (gs) => {
            const child = getRandomElement(gs.children.filter(c => !c.isDead && c.age >= 8 && c.age < 15));
            const talentType = Math.random() < 0.5 ? 'martial' : 'talent';
            const talentName = talentType === 'martial' ? '武学' : '艺术';
            const cost = 2000;
            return {
                title: "子嗣的天赋", icon: "fa-star", description: `你发现你的孩子 <strong class="highlight-npc">${child.name}</strong> 在 <strong class="value">${talentName}</strong> 方面展现出了惊人的天赋，远超同龄人。`,
                options: [
                    { htmlContent: `【花费${cost}两，请名师指导】`, disabled: gs.finances.wealth < cost, callback: () => {
                        applyEffects({ wealth: -cost });
                        child.attributes[talentType] += 15;
                        child.favor += 10;
                        showEventCard("因材施教", "fa-award", `在名师的指导下，${child.name}的天赋得到了极大的发展！`);
                    }},
                    { htmlContent: "【顺其自然】", callback: () => {
                        child.attributes[talentType] += 5;
                        showEventCard("静待花开", "fa-seedling", `${child.name}继续依靠自己的兴趣发展，也小有成就。`);
                    }}
                ]
            };
        }
    },
    lover_in_trouble: {
        type: 'lover',
        condition: (gs) => gs.social.secretLovers.length > 0,
        generate: (gs) => {
            const lover = gs.npcs[getRandomElement(gs.social.secretLovers)];
            const cost = 1000;
            return {
                title: "情人的求助", icon: "fa-hand-holding-usd", description: `你的情人 <strong class="highlight-npc">${lover.name}</strong> 似乎遇到了麻烦，急需 <span class="value">${cost}</span> 两银子周转，向你开口求助。`,
                options: [
                    { htmlContent: "【慷慨解囊】", disabled: gs.finances.wealth < cost, callback: () => {
                        applyEffects({ wealth: -cost, relationship: { targetId: lover.id, favor: 15, devotion: 10 } });
                        showEventCard("雪中送炭", "fa-hand-holding-heart", "你帮助TA渡过了难关，TA对你感激不尽，更加倾心。");
                    }},
                    { htmlContent: "【表示无能为力】", callback: () => {
                        applyEffects({ relationship: { targetId: lover.id, favor: -15 } });
                        showEventCard("爱莫能助", "fa-times", "你的拒绝让TA感到失望，你们的关系出现了裂痕。");
                    }}
                ]
            };
        }
    },
    sworn_sibling_share_treasure: {
        type: 'sworn',
        condition: (gs) => gs.social.swornSiblings && gs.social.swornSiblings.length > 0,
        generate: (gs) => {
            const sibling = gs.npcs[getRandomElement(gs.social.swornSiblings)];
            const treasure = Math.random() < 0.5 ? { id: 'gu_ji_shan_ben', name: '古籍善本' } : { id: 'cang_bao_tu_can_pian', name: '藏宝图残片' };
            return {
                title: "福祸与共", icon: "fa-gem", description: `你的结义兄弟/姐妹 <strong class="highlight-npc">${sibling.name}</strong> 得到了一件宝物，特地前来与你分享。`,
                options: [
                    { htmlContent: "【一同研究】", callback: () => {
                        addItemToInventory(treasure.id, 1);
                        applyEffects({ relationship: { targetId: sibling.id, favor: 10 } });
                        showEventCard("有福同享", "fa-box-open", `你们一同研究了这件【${treasure.name}】，并将其妥善保管。`);
                    }},
                    { htmlContent: "【让TA独享】", callback: () => {
                        applyEffects({ relationship: { targetId: sibling.id, favor: 5 }, attributes: { virtue: 3 } });
                        showEventCard("高风亮节", "fa-user-check", "你认为宝物应由TA独享，这份气度让TA更加敬重你。");
                    }}
                ]
            };
        }
    },
    npc_farewell: {
        type: 'npc',
        condition: (gs) => {
            const friends = (gs.social.friends || []).map(id => gs.npcs[id]).filter(f => f && !f.isDead);
            return friends.length > 0;
        },
        generate: (gs) => {
            const friends = (gs.social.friends || []).map(id => gs.npcs[id]).filter(f => f && !f.isDead);
            const friend = getRandomElement(friends);
            return {
                title: "友人远行", icon: "fa-map-signs", description: `你的友人 <strong class="highlight-npc">${friend.name}</strong> 因故需要远行一年，特地前来向你辞行。`,
                options: [
                    { htmlContent: "【为其设宴践行】", cost: { wealth: 100 }, callback: () => {
                        applyEffects({ wealth: -100, relationship: { targetId: friend.id, favor: 10 } });
                        showEventCard("长亭送别", "fa-wine-glass-alt", "你们在酒宴上依依惜别，约定一年后再会。");
                    }},
                    { htmlContent: "【赠送盘缠】", cost: { wealth: 300 }, callback: () => {
                        applyEffects({ wealth: -300, relationship: { targetId: friend.id, favor: 15, devotion: 5 } });
                        showEventCard("情深义重", "fa-money-bill-wave", "你赠送的盘缠让TA在异乡也能感受到温暖。");
                    }},
                    { htmlContent: "【简单道别】", callback: () => {
                        applyEffects({ relationship: { targetId: friend.id, favor: 2 } });
                        showEventCard("后会有期", "fa-hand-paper", "你向TA简单道别，祝其一路顺风。");
                    }}
                ]
            };
        }
    }
    // ============= 新增事件 END =================
};

// [新增此对象]
const CAREER_CORE_STATS = {
    civilian: ['wisdom', 'virtue'],
    warrior: ['martial', 'health'],
    merchant: ['wisdom', 'charm'],
    scholar: ['talent', 'charm'],
    ranger: ['martial', 'virtue'],
    matron: ['etiquette', 'virtue'],
    embroiderer: ['talent', 'charm'],
    doctor: ['wisdom', 'virtue'],
    spy_master: ['scheming', 'wisdom']
};
// 【修复核心】定义 ATTR_MAP, 用于将属性英文名转为中文
const ATTR_MAP = {talent:"才情", wisdom:"智慧", health:"健康", virtue:"品德", charm:"魅力", etiquette:"礼仪", martial:"武学", reputation:"声望", scheming:"心计", strategy:"权谋", prestige:"家威"};

const ITEM_DATA = {
    // 文官物品
    'ming_shi_qing_jian': { name: '名士的请柬', type: '消耗', icon: 'fa-envelope', desc: '一张由京城名士签发的请柬，可用于拜访一位高阶文官。', performance_boost: 20 },
    'shi_zheng_xin_de': { name: '施政心得', type: '文书', icon: 'fa-book-open', desc: '前朝某位宰相的施政心得手稿，蕴含着高深的政治智慧。', performance_boost: 50 },
    'tan_fu_xian_suo': { name: '贪腐线索', type: '文书', icon: 'fa-file-invoice-dollar', desc: '一份记录着某位官员贪腐行为的关键线索。', performance_boost: 30 },
    'yu_ci_wen_fang_si_bao': { name: '御赐文房四宝', type: '珍品', icon: 'fa-gem', desc: '皇帝亲赐的文房四宝，是无上的荣耀。持有此物，每年会自动提升才情与声望。' },
    'qing_bao_si_sheng_huo': { name: '情报：私生活', type: '文书', icon: 'fa-mask', desc: '一份关于某位大臣私生活的秘密情报。' },
    'qing_bao_cai_wu': { name: '情报：财务问题', type: '文书', icon: 'fa-mask', desc: '一份关于某位大臣财务问题的秘密情报。' },
    // 武将物品
    'bai_lian_bu_ren_jia': { name: '百炼步人甲', type: '珍品', icon: 'fa-shield-alt', desc: '厚重的步兵重甲，能极大提升战场生存率。', performance_boost: 20 },
    'ji_feng_chi_hou_jia': { name: '疾风斥候甲', type: '珍品', icon: 'fa-shield-alt', desc: '轻便的皮甲，提升战场移动力和侦查成功率。' },
    'bai_fu_chang_pei_dao': { name: '百夫长的佩刀', type: '珍品', icon: 'fa-khanda', desc: '一把跟随百夫长多年的旧佩刀，锋利异常。', performance_boost: 25 },
    'mi_lin_di_xing_tu': { name: '密林地形图', type: '文书', icon: 'fa-map-marked-alt', desc: '记录了可以绕到敌人后方的秘密小路。', performance_boost: 40 },
    'shen_jun_zhan_ma': { name: '神骏的战马', type: '珍品', icon: 'fa-horse', desc: '一匹百里挑一的良驹，能增强战场突击能力。' },
    'chi_dian': { name: '赤电', type: '珍品', icon: 'fa-horse-head', desc: '传说中有“汗血”血统的宝马，神骏非凡。' },
    'xiao_wei_tie_fu': { name: '校尉的铁符', type: '珍品', icon: 'fa-id-card-alt', desc: '用于调动百人队以下士兵的信物。', performance_boost: 20 },
    'shuai_yin': { name: '帅印', type: '珍品', icon: 'fa-stamp', desc: '護國將軍的帥印，能大幅提升部隊士氣和你的威望。' },
    'wu_mu_bing_fa': { name: '武穆兵法', type: '珍品', icon: 'fa-book', desc: '你親手撰寫的曠世兵書，可被子嗣繼承。' },
    // 商贾物品
    'shang_deng_cha_ye': { name: '上等茶叶', type: '珍品', icon: 'fa-leaf', desc: '产自江南的上等茶叶，是赠礼佳品。' },
    'jiang_nan_gong_huo_shang': { name: '江南供货商名录', type: '文书', icon: 'fa-address-book', desc: '记录了一条隐藏的低价进货渠道。', performance_boost: 30 },
    'si_chou_zhi_lu_can_pian': { name: '丝绸之路地图残片', type: '文书', icon: 'fa-map', desc: '通往传说中遍地黄金的西域之路的线索。', performance_boost: 20 },
    'yu_ci_le_shan_hao_shi': { name: '御赐“乐善好施”牌匾', type: '珍品', icon: 'fa-award', desc: '皇帝御赐的牌匾，是身份和声望的象征。' },
    'liang_huai_yan_yin': { name: '两淮盐引（五年）', type: '文书', icon: 'fa-file-signature', desc: '未来五年两淮地区的食盐独家经营权，价值连城。', performance_boost: 20 },
    'hai_dao_cang_bao_tu': { name: '海盗的藏宝图', type: '文书', icon: 'fa-treasure-chest', desc: '一张描绘了海外某处巨大宝藏的地图。' },
    'hong_ding_shang_ren_guan_mao': { name: '红顶商人官帽', type: '珍品', icon: 'fa-user-tie', desc: '官居一品的证明，商人的至高荣誉。' },
    // 文人墨客物品
    'chuan_jia_yu_pei': { name: '传家玉佩', type: '珍品', icon: 'fa-gem', desc: '家族流传下来的玉佩，价值不菲但意义非凡。' },
    'hu_zhou_bi_hui_zhou_mo': { name: '湖州笔、徽州墨', type: '珍品', icon: 'fa-paint-brush', desc: '一套顶级的文房四宝，能提升创作质量。' },
    'yan_hui_qing_jian': { name: '宴会请柬', type: '消耗', icon: 'fa-envelope-open-text', desc: '京中权贵举办宴会的请柬。', performance_boost: 15 },
    'wen_cai_feng_liu_pai_bian': { name: '御赐“文采风流”牌匾', type: '珍品', icon: 'fa-award', desc: '皇帝对你才华的最高认可。', performance_boost: 30 },
    'gu_ji_shan_ben': { name: '古籍善本', type: '珍品', icon: 'fa-book-reader', desc: '一本珍稀的古代书籍刻本。', performance_boost: 35 },
    'chuan_shi_zhi_zuo': { name: '传世之作', type: '珍品', icon: 'fa-scroll', desc: '你呕心沥血创作出的不朽名作。' },
    // 江湖游侠物品
    'tong_ji_fan_xing_zong': { name: '通缉犯的行踪', type: '文书', icon: 'fa-user-secret', desc: '一份记录了某个高额悬赏通缉犯位置的情报。', performance_boost: 30 },
    'cang_bao_tu_can_pian': { name: '藏宝图残片', type: '文书', icon: 'fa-map', desc: '指向前朝大将军宝藏的地图碎片。' },
    'zhai_zhu_gui_tou_dao': { name: '寨主的鬼头刀', type: '珍品', icon: 'fa-khanda', desc: '黑风寨总寨主的武器，势大力沉。' },
    'jiu_yang_can_ye': { name: '《九阳神功》残页', type: '文书', icon: 'fa-book-dead', desc: '传说中的顶级内功心法残页，会引来无数人的觊觎。' },
    'shen_bing': { name: '神兵', type: '珍品', icon: 'fa-meteor', desc: '由天外陨铁为你量身打造的独一无二的神兵利器。' },
    'tian_xia_di_yi_xin_wu': { name: '天下第一的信物', type: '珍品', icon: 'fa-crown', desc: '华山论剑胜者的信物，是武林至尊的象征。' },
    // 主母物品
    'zi_bu_tang_pin': { name: '滋补汤品', type: '消耗', icon: 'fa-utensil-spoon', desc: '亲手制作的滋补汤品，是表达孝心的好方法。', performance_boost: 10 },
    'mu_qin_ti_ji_shou_shi': { name: '母亲的体己首饰', type: '珍品', icon: 'fa-ring', desc: '母亲在你回门时悄悄塞给你的私房首饰。' },
    'fu_ku_yao_chi': { name: '府库的钥匙', type: '珍品', icon: 'fa-key', desc: '象征主母权力的府库钥匙。', performance_boost: 20 },
    'huang_hou_shang_ci_zhu_chai': { name: '皇后赏赐的珠钗', type: '珍品', icon: 'fa-gem', desc: '皇后娘娘亲手赏赐的珠钗，在贵妇圈中是地位的象征。' },
    'chuan_jia_jia_xun': { name: '传家家训', type: '珍品', icon: 'fa-scroll', desc: '你一生治家经验的结晶，可被后代继承。' },
    // 绣娘物品
    'jing_zhi_he_bao': { name: '精致荷包', type: '消耗', icon: 'fa-wallet', desc: '你亲手缝制的荷包，是化解邻里矛盾的小礼物。', performance_boost: 10 },
    'gui_fu_ren_xin_wu': { name: '贵夫人的信物', type: '珍品', icon: 'fa-stamp', desc: '安国公夫人的信物，是你进入上流社会的敲门砖。' },
    'chu_ru_gong_jin_jin_pai': { name: '出入宫禁金牌', type: '珍品', icon: 'fa-id-badge', desc: '拥有此金牌，你可以自由出入后宫，面见嫔妃。' },
    // 女医物品
    'yi_zhong_cao_yao': { name: '异种草药', type: '材料', icon: 'fa-leaf', desc: '一种未被医书记载的奇特草药，也许有特殊功效。', performance_boost: 20 },
    'du_jia_yao_fang': { name: '独家药方', type: '文书', icon: 'fa-file-medical', desc: '你独创的专治风湿的偏方。', performance_boost: 40 },
    'bai_nian_ling_zhi': { name: '百年灵芝', type: '材料', icon: 'fa-magic', desc: '极为罕见的珍稀药材，是炼制高级丹药的主料。' },
    'nan_hai_zhen_zhu': { name: '南海珍珠', type: '珍品', icon: 'fa-gem', desc: '侯爵夫人赠予的谢礼，圆润饱满，价值连城。' },
    'yang_yan_dan': { name: '养颜丹', type: '消耗', icon: 'fa-pills', desc: '你研制的独家丹药，能让容颜焕发。' },
    'xu_ming_wan': { name: '续命丸', type: '消耗', icon: 'fa-capsules', desc: '能在危急时刻吊住性命的保命之物。' },
    'xing_lin_yi_an': { name: '杏林医案', type: '珍品', icon: 'fa-book-medical', desc: '你一生行医经验的结晶，可被子嗣继承。' },
    'tai_yi_yuan_jin_pai': { name: '太医院金牌', type: '珍品', icon: 'fa-id-badge', desc: '作为太医院第一位女医官的身份象征。', performance_boost: 10 },
    // 情报首领物品
    'mi_ma_ben': { name: '密码本', type: '文书', icon: 'fa-key', desc: '一种无人能破的密码术，能极大提升情报的安全性。', performance_boost: 45 },
    'ming_shi_bian_e': { name: '名师匾额', type: '珍品', icon: 'fa-award', desc: '由出师高徒所赠，是你桃李满天下的证明。持有此物，声望会潜移默化地提升。' },
    'huang_di_mi_mi_xin_wu': { name: '皇帝的秘密信物', type: '珍品', icon: 'fa-dragon', desc: '新皇登基后交给你的信物，见此物如见皇帝本人。' },
    'oath_bamboo_slip': { id: 'oath_bamboo_slip', name: '盟誓竹简', icon: 'fa-scroll', type: '材料', desc: '文官处理公务时用以记录盟誓的竹简，质地坚韧，象征着不变的承诺。' },
    'battle_worn_tassel': { id: 'battle_worn_tassel', name: '历战剑穗', icon: 'fa-khanda', type: '材料', desc: '从百战不挠的佩剑上取下的剑穗，浸染着沙场豪情与守护之意。' },
    'abacus_bead_bracelet': { id: 'abacus_bead_bracelet', name: '玲珑算盘珠', icon: 'fa-calculator', type: '材料', desc: '商贾们用最名贵的木料打磨的算盘珠，象征着精打细算的爱意。' },
    'ink_heart_stone': { id: 'ink_heart_stone', name: '墨心石', icon: 'fa-paint-brush', type: '材料', desc: '文人墨客视若珍宝的石砚，磨出的墨带有奇香，用以书写情诗最佳。' },
    'heroic_wine_gourd': { id: 'heroic_wine_gourd', name: '侠义酒葫', icon: 'fa-wine-bottle', type: '材料', desc: '江湖游侠随身携带的酒葫芦，装过最烈的酒，也装着最真的情。' },
    'seven_ingenuity_thread': { id: 'seven_ingenuity_thread', name: '七巧丝线', icon: 'fa-ribbon', type: '材料', desc: '主母在乞巧节时求得的七彩丝线，据说能编织出世上最牢固的同心结。' },
    'phoenix_tail_pin': { id: 'phoenix_tail_pin', name: '凤尾金针', icon: 'fa-cut', type: '材料', desc: '绣娘梦寐以求的御赐金针，能绣出栩栩如生的凤凰，象征着至高无上的爱。' },
    'longevity_herb': { id: 'longevity_herb', name: '长生草', icon: 'fa-leaf', type: '材料', desc: '女医踏遍千山寻得的珍稀草药，虽不能长生，却代表着愿对方一世安康的心意。' },
    'invisible_ink': { id: 'invisible_ink', name: '无迹墨', icon: 'fa-feather-alt', type: '材料', desc: '情报首领用独门秘法调制的墨水，写下的情书唯有真爱之人可见。' }
};

const APPRENTICE_GRADUATION_REQUIREMENTS = {
    'civilian': { wisdom: 80, etiquette: 70, virtue: 70, desc: "成为栋梁之才 (需智慧、礼仪、品德达标)" },
    'warrior': { martial: 80, health: 90, virtue: 60, desc: "成为勇武之将 (需武学、健康、品德达标)" },
    'merchant': { wisdom: 80, charm: 70, desc: "成为商界奇才 (需智慧、魅力达标)" },
    'scholar': { talent: 90, charm: 70, reputation: 60, desc: "成为一代名士 (需才情、魅力、声望达标)" },
    'ranger': { martial: 90, virtue: 70, health: 80, desc: "成为江湖大侠 (需武学、品德、健康达标)" },
    'matron': { etiquette: 80, virtue: 80, wisdom: 60, desc: "成为持家典范 (需礼仪、品德、智慧达标)" },
    'embroiderer': { talent: 90, charm: 70, etiquette: 60, desc: "成为织造大家 (需才情、魅力、礼仪达标)" },
    'doctor': { wisdom: 80, virtue: 80, talent: 60, desc: "成为杏林圣手 (需智慧、医德、才情达标)" },
    'spy_master': { wisdom: 90, charm: 80, desc: "成为暗影之主 (需智慧、魅力达标)" },
    'default': { wisdom: 60, talent: 60, desc: "学有所成 (需智慧、才情达标)" } // 师傅无职业时的备用条件
};
// =======================================================================
// ===================== 【新增】义结金兰专属事件库 =====================
// =======================================================================
const SWORN_SIBLING_EVENTS = {
    'teach_skill': [
        {
            title: "传授技艺",
            desc: "你与义兄/妹切磋武艺后，对方见你于某一招式上颇有窒碍，主动提出为你指点一二。",
            options: [
                { text: "虚心求教", effects: { attributes: { martial: 10 } }, log: "在TA的指点下，你茅塞顿开，武学大进！" },
                { text: "探讨交流", effects: { attributes: { martial: 5, wisdom: 5 } }, log: "你们互相印证，各有收获。" },
                { text: "心高气傲", effects: { relationship: { favor: -10 } }, log: "你认为自己的武学别具一格，婉拒了对方的好意。" }
            ]
        },
        {
            title: "人生经验",
            desc: "见你近日为某事烦忧，你的义兄/妹与你月下小酌，向你传授了TA行走江湖多年的经验。",
            options: [
                { text: "认真倾听", effects: { attributes: { wisdom: 8, charm: 5 } }, log: "TA的经验之谈让你受益匪浅，你看待问题的方式也更成熟了。" },
                { text: "不以为然", effects: { relationship: { favor: -8 } }, log: "你觉得TA的经验已经过时，对方见你听不进去，便不再多言。" },
                { text: "反过来安慰TA", effects: { relationship: { favor: 10 } }, log: "你表示自己并无大碍，反过来安慰TA不要为你担心，对方对你的体贴很受用。" }
            ]
        }
    ],
    'overcome_difficulty': [
        {
            title: "共渡难关：流言蜚语",
            desc: "最近京城中出现了一些对你不利的流言，让你声望受损。你的义兄/妹得知后，立刻前来寻你商议对策。",
            options: [
                { text: "请TA帮忙调查源头", effects: { reputation: 10 }, log: "TA动用自己的人脉，很快帮你查清了流言源头，并助你澄清了事实。" },
                { text: "一同借酒消愁", effects: { relationship: { favor: 10 }, attributes: { health: -5 } }, log: "你们痛饮一番，虽无益于事，但这份情谊让你倍感温暖。" },
                { text: "表示无需担心", effects: { attributes: { virtue: 5 } }, log: "你表示清者自清，这份坦荡让TA颇为欣赏。" }
            ]
        },
        {
            title: "共渡难关：财务危机",
            desc: "你因一笔投资失败，陷入了财务危机。对方得知后，二话不说带着一箱银两前来。",
            options: [
                { text: "感激收下", effects: { wealth: 5000, relationship: { favor: 20 } }, log: "“你我之间，何须言谢！”TA为你雪中送炭，解了你的燃眉之急。" },
                { text: "只借一部分", effects: { wealth: 1000, relationship: { favor: 10 }, attributes: { virtue: 5 } }, log: "你只借了一部分应急，这份风骨让TA更加敬重。" },
                { text: "婉言谢绝", effects: { relationship: { favor: -10, devotion: -15 } }, log: "你不想因为金钱让这份情谊蒙尘，但你的拒绝也让TA觉得你太过见外。" }
            ]
        }
    ],
    'ask_help': [
        {
            title: "两肋插刀：寻人",
            desc: "你需要寻找一位失散多年的故人，但毫无头绪，只好求助于人脉广阔的义兄/妹。",
            options: [
                { text: "请求帮助", effects: { reputation: 5 }, log: "不出半月，TA便帮你找到了那人，让你了却了一桩心事。" },
                { text: "提供酬金", effects: { wealth: -500, reputation: 5 }, log: "你坚持支付酬金，对方虽不情愿，但还是收下了。" },
                { text: "还是算了", effects: {}, log: "你觉得此事太过麻烦，最终没有开口。" }
            ]
        },
        {
            title: "两肋插刀：寻物",
            desc: "你需要一味珍稀药材救急，听闻你的义兄/妹恰好知晓其下落。",
            options: [
                { text: "开口求助", effects: { item: { id: 'bai_nian_ling_zhi', amount: 1 } }, log: "TA听闻后立刻将自己的珍藏赠予你，并祝你渡过难关。" },
                { text: "高价求购", effects: { wealth: -1000, item: { id: 'bai_nian_ling_zhi', amount: 1 } }, log: "你花费重金从TA手中购得此物，虽解了燃眉之急，但关系略显生分。" },
                { text: "另寻他法", effects: { relationship: { favor: -5 } }, log: "你没有向TA求助，TA事后得知，觉得你信不过TA。" }
            ]
        }
    ],
    'discuss_plan': [
        {
            title: "共商大事：事业规划",
            desc: "你对未来的事业发展有些迷茫，便找来义兄/妹一同商议。",
            options: [
                { text: "听取TA的建议", effects: { career_performance: 20, wisdom: 5 }, log: "TA的建议一针见血，为你的事业指明了方向。" },
                { text: "各抒己见", effects: { wisdom: 8 }, log: "你们的讨论激发了彼此的灵感，对未来都有了更清晰的规划。" },
                { text: "最终还是自己决定", effects: { relationship: { favor: -5 } }, log: "你听了一圈，最后还是决定按自己的想法来，让TA觉得白费了一番口舌。" }
            ]
        },
        {
            title: "共商大事：子女婚事",
            desc: "你正在为子女的婚事发愁，便请义兄/妹来帮忙参详。",
            options: [
                { text: "请TA帮忙物色", effects: {}, log: "TA拍胸脯保证，此事包在TA身上。不久后便为你引荐了一位不错的候选人。" },
                { text: "只是吐吐苦水", effects: { relationship: { favor: 5 } }, log: "你只是想找个人倾诉，TA认真地听你抱怨了一下午。" }
            ]
        }
    ],
    'borrow_money': [
        {
            title: "倾囊相助：借钱",
            desc: "你最近手头拮据，想向义兄/妹借一笔钱周转。",
            options: [
                { text: "借500两", effects: { wealth: 500, relationship: { favor: -2 } }, log: "TA很爽快地借给了你。" },
                { text: "借2000两", effects: { wealth: 2000, relationship: { favor: -8 } }, log: "TA虽然有些为难，但还是凑了钱给你。" },
                { text: "算了，不开口了", effects: {}, log: "你最终还是没能拉下脸。" }
            ]
        },
        {
            title: "倾囊相助：还钱",
            desc: "你准备好了一笔钱，打算还给之前资助过你的义兄/妹。",
            options: [
                { text: "连本带利还", effects: { wealth: -600, relationship: { favor: 10 } }, log: "TA对你的信义赞不绝口。" },
                { text: "只还本金", effects: { wealth: -500 }, log: "你还清了欠款，你们的帐两清了。" },
                { text: "请求宽限几日", effects: { relationship: { favor: -15 } }, log: "TA虽然同意了，但眼神中难掩失望。" }
            ]
        }
    ]
};
// =======================================================================
// ===================== 【新增】女性视角青梅竹马事件库 ======================
// =======================================================================
// [替换] 请用这个完整的代码块替换您文件中现有的 CHILDHOOD_SWEETHEART_EVENTS 对象
const CHILDHOOD_SWEETHEART_EVENTS = {
    'event_1_fishing': {
        id: 'event_1_fishing',
        age_range: [12, 13], // 修复点：年龄从10-12岁改为12-13岁
        description: "春日午后，你与青梅竹马在后山的小溪边玩耍。她提议比赛捕鱼，看谁抓得又多又快。",
        options: [
            { text: "【一展身手】", req: { martial: 20 }, effects: { bond: 5 }, log: "你轻松地抓了好几条鱼，引得她拍手称赞，对你的崇拜之情溢于言表。" },
            { text: "【故意让着她】", req: {}, effects: { bond: 8 }, log: "你假装失手，让她赢得了比赛，看她开心的样子，你觉得很满足。" },
            { text: "【不慎滑倒】", req: {}, effects: { bond: 10 }, log: "你不小心脚下一滑，摔进了水里，样子十分狼狈。她急忙拉你上来，用手帕为你擦拭，一次小小的意外，却让你们的心贴得更近。" }
        ]
    },
    'event_2_lantern': {
        id: 'event_2_lantern',
        age_range: [14, 15], // 修复点：微调年龄范围
        description: "元宵佳节，你与她相约逛灯会。人潮汹涌中，你们不慎走散。",
        options: [
            { text: "【在原地等她】", req: {}, effects: { random: [{ chance: 0.5, bond: 5, log: "她很快找到了你，你们相视一笑。" }, { chance: 0.5, bond: -3, log: "你们错过了彼此，感到失落。" }] } },
            { text: "【去猜灯谜赢花灯】", req: { talent: 40 }, effects: { bond: 12 }, log: "你成功赢得她最喜欢的那盏走马灯，并送给了她，她感动不已。" },
            { text: "【去约定地点】", req: { wisdom: 30 }, effects: { bond: 10 }, log: "你们曾戏言，若走散了就在湖边的柳树下碰头。你在柳树下找到了同样焦急的她，默契油然而生。" }
        ]
    },
    'event_3_blame': {
        id: 'event_3_blame',
        age_range: [15, 16], // 修复点：微调年龄范围
        description: "她因一件小事被长辈误会并责罚，独自在花园垂泪。",
        options: [
            { text: "【为她辩解】", req: {}, effects: { bond: 15, attributes: { health: -5 } }, log: "你将责任揽到自己身上，可能因此受到惩罚，但她视你为唯一的依靠。" },
            { text: "【默默陪伴】", req: {}, effects: { bond: 8 }, log: "无声的陪伴给了她最大的安慰。" },
            { text: "【带她去吃好吃的】", req: {}, effects: { bond: 6 }, log: "你偷偷从厨房拿来她最爱的桂花糕，她破涕为笑，觉得有你在真好。" }
        ]
    },
    'event_4_loveletter': {
        id: 'event_4_loveletter',
        age_range: [16, 17], // 修复点：微调年龄范围
        description: "你无意中发现，另一位世家子弟正在热烈地追求她，甚至送来了情诗。",
        options: [
            { text: "【假装不知】", req: {}, effects: { bond: -5 }, log: "你选择尊重她的选择，内心却五味杂陈，你们的关系可能因此疏远。" },
            { text: "【质问她】", req: {}, effects: { random: [{ chance: 0.6, bond: -8, log: "她对你的霸道感到不满。" }, { chance: 0.4, bond: 5, log: "她窃喜你的在乎。" }] } },
            { text: "【写一首更好的诗】", req: { talent: 60 }, effects: { bond: 10, attributes: { talent: 2 } }, log: "你写了一首远胜对方的诗作匿名送给她，她内心对你更加倾慕。" }
        ]
    },
    'event_5_promise': {
        id: 'event_5_promise',
        age_range: [17, 18],
        description: "你们在山顶看日出，谈及未来，她有些迷茫地问你，以后会是什么样子。",
        options: [
            { text: "【许下承诺】", req: {}, effects: { bond: 20, flag: 'proposal_bonus' }, log: "“无论未来如何，我都会在你身边。”一个坚定的承诺，让她对未来充满信心，并解锁了提亲成功率加成。" },
            { text: "【谈论事业】", req: {}, effects: { bond: 3 }, log: "你意气风发地描述自己未来的事业蓝图。她欣赏你的志向，但内心有一丝失落。" },
            { text: "【沉默】", req: {}, effects: { bond: -10 }, log: "你的沉默让她感到不安。" }
        ]
    },
    'event_6_visit': {
        id: 'event_6_visit',
        age_range: [12, 18], // 修复点：年龄从10-18岁改为12-18岁
        is_random: true,
        description: "你生了一场小病，卧床休养。她得知后，带着亲手熬的汤药前来探望。",
        options: [
            { text: "【逞强说无事】", req: {}, effects: { bond: 7 }, log: "她看穿了你的逞强，有些心疼。" },
            { text: "【坦然接受照顾】", req: {}, effects: { bond: 10, attributes: { health: 5 } }, log: "病中的脆弱让你们的情感迅速升温。" }
        ]
    },
    'event_7_secret': {
        id: 'event_7_secret',
        age_range: [12, 18], // 修复点：年龄从10-18岁改为12-18岁
        is_random: true,
        description: "你在与朋友闲聊时，得知他知道一个关于你和青梅竹马小时候的糗事，并以此取笑你们。",
        options: [
            { text: "【联手回击】", req: {}, effects: { bond: 8, attributes: { charm: 1 } }, log: "你和她默契地对视一眼，用另一个更大的秘密回击了朋友，共同的秘密阵线让你们关系更铁。" },
            { text: "【一笑置之】", req: {}, effects: { bond: 5 }, log: "你们并不在意，反而觉得这段回忆很有趣。" }
        ]
    },
    'event_8_gift': {
        id: 'event_8_gift',
        age_range: [16, 18], // 远行时触发
        is_career_related: true,
        description: "你因事业需要即将远行，她连夜为你缝制了一个平安符。",
        options: [
            { text: "【贴身收藏】", req: {}, effects: { bond: 12, item: { id: 'talisman_sweetheart', name: '贴身的平安符', desc: '青梅竹马为你缝制的平安符，能在随机负面事件中豁免一次。', type: '珍品', icon: 'fa-shield-alt' } }, log: "你郑重地将平安符放入怀中，承诺一定会戴着它回来。" },
            { text: "【回赠礼物】", req: {}, effects: { bond: 10, wealth: -100 }, log: "你将一支名贵的发簪回赠给她作为念想，花费了100两。" }
        ]
    },
    'event_9_family': {
        id: 'event_9_family',
        age_range: [17, 18],
        bond_req: 60,
        description: "你的母亲在闲聊时提起她，言语间颇为赞许，并询问你的想法。",
        options: [
            { text: "【表明心意】", req: {}, effects: { bond: 15, flag: 'mother_support' }, log: "“母亲，孩儿非她不娶。”你获得了母亲的支持，极大提升了提亲事件的成功率。" },
            { text: "【含糊其辞】", req: {}, effects: { bond: -8 }, log: "“我们只是从小一起长大罢了。”母亲有些失望，她若得知此事，也会伤心。" }
        ]
    },
    'event_10_choice': {
        id: 'event_10_choice',
        age_range: [18, 19],
        is_final: true,
        description: "她已年满18，待字闺中。她的家人也开始为她物色人家。这是你必须做出选择的时刻了。",
        options: [] // 选项动态生成
    }
};
const GOSSIP_DATA = [
    "听说安国公最近在朝堂上和礼部尚书为了一点小事吵得不可开交。",
    "城西的张屠夫，原来是二十年前退隐江湖的‘血手人屠’！",
    "据说忠武将军家的小儿子，偷偷爱慕着翰林学士家的千金。",
    "最近市面上的江南丝绸价格疯涨，好像是运河出了问题。",
    "皇上最近龙体欠安，好几位皇子都在暗中活动呢。",
    "大理寺卿秦大人铁面无私，连自己夫人的娘家亲戚犯了法都照抓不误。",

    "你可知晓，那‘醉仙楼’的头牌菜‘佛跳墙’，秘方竟是宫里传出来的。",
    "前朝有位公主的陵墓，据说就在京城西郊的某个山谷里，藏着无数珍宝。",
    "风月鉴的柳拂衣姑娘，好像不是普通人家的女儿，有大来头。",
    "最近京城夜里不太平，好几家富户都被一个叫‘一阵风’的飞贼光顾了。",
    "兵部正在秘密招募一批武林高手，不知要去做什么大事。",
    "听闻海外来了使臣，带的贡品里有会自己报时的西洋钟，稀奇得很。",

    "城南的‘济世堂’药铺，最近研制出一种新药，对风湿有奇效。",
    "上次科举的状元郎，才华是有，但听说私下里品行不太端正。",
    "国子监最近在整顿学风，好几个不学无术的世家子弟都被斥退了。",
    "西域来的商队，这次带来了一批上好的和田玉，价格不菲。",
    "吏部侍郎家正在为女儿的婚事发愁，门槛都快被媒婆踏破了。",
    "据说皇帝想在京郊新建一座皇家园林，户部正为钱的事头疼呢。",

    "有人在城外的破庙里见过一道剑光，快如闪电，疑有绝世高手隐居。",
    "最近漕运总督换了人，京城的米价都跟着涨了三分。",
    "‘霓裳坊’的老板，最近和‘锦绣阁’为了抢一个大客户，都快打起来了。",
    "据说太医院的院首，正在寻找一味叫‘龙涎香’的珍稀药材。",
    "北境传来消息，好像和蛮族又有了些小摩擦。",
    "长公主的驸马，表面上与公主恩爱，私下里却养着外室。",

    "最近京中流行一种新的发髻样式，据说是从宫里一位贵妃那儿传出来的。",
    "有个疯疯癫癫的道士在街上说，十年后京城会有一场大劫。",
    "‘振远镖局’的总镖头，年轻时曾是御前侍卫，武功深不可测。",
    "工部在修缮城墙时，挖出了一块前朝的石碑，上面刻着些看不懂的文字。",
    "听说有位皇子在民间寻访一位失散多年的妹妹。",
    "城东首富王员外，最近在低价收购城郊的荒地，不知打的什么算盘。",
    "‘风月鉴’的苏合姑娘，好像和几个商界大亨关系匪浅。",
    "太傅大人看似清廉，但听说他收藏的古玩字画，价值连城。"
];
// =======================================================================
// ===================== 【新功能】宅斗系统数据 START ======================
// =======================================================================

// [用这个新版本替换]
const INNER_COURT_STRUGGLES = {
    male: {
        // ... (您的男性宅斗部分代码非常完善，此处予以保留，不做任何修改) ...
        'jealousy': {
            title: "争风吃醋",
            trigger: (gs) => {
                if (gs.marriage.familyHarmony > 60) return false;
                const concubines = gs.marriage.concubines.map(id => gs.npcs[id]).filter(c => c && !c.isDead && c.jealousy > 40);
                if (concubines.length < 2) return false;
                concubines.sort((a, b) => b.jealousy - a.jealousy);
                const involved = [concubines[0], concubines[1]];
                return {
                    involved: involved,
                    description: `你的两位妾室 <strong class="highlight-npc">${involved[0].name}</strong> 和 <strong class="highlight-npc">${involved[1].name}</strong> 因一件首饰发生激烈争吵，闹到你面前让你评理。`
                };
            },
            options: [
                {
                    text: "各打五十大板",
                    req: (player) => player.attributes.prestige > 50,
                    action: (involved) => {
                        applyEffects({ relationship: { targetId: involved[0].id, favor: -5 } });
                        applyEffects({ relationship: { targetId: involved[1].id, favor: -5 } });
                        gameState.marriage.familyHarmony -= 5;
                        return `你暂时压制了事态，但两人对你的好感均下降了。`;
                    }
                },
                {
                    text: "偏袒受宠一方",
                    req: () => true,
                    action: (involved) => {
                        const favored = involved[0].favor > involved[1].favor ? involved[0] : involved[1];
                        const unfavored = favored === involved[0] ? involved[1] : involved[0];
                        applyEffects({ relationship: { targetId: favored.id, favor: 5 } });
                        applyEffects({ relationship: { targetId: unfavored.id, favor: -15 } });
                        unfavored.jealousy = (unfavored.jealousy || 0) + 20;
                        unfavored.ambition = (unfavored.ambition || 0) + 10;
                        gameState.marriage.familyHarmony -= 10;
                        return `你偏袒了${favored.name}，她的好感提升，但${unfavored.name}的嫉妒与野心大幅提升。`;
                    }
                },
                {
                    text: "讲道理，查明真相",
                    req: (player) => player.attributes.strategy > 40,
                    action: (involved) => {
                        const instigator = Math.random() < 0.5 ? involved[0] : involved[1];
                        const victim = instigator === involved[0] ? involved[1] : involved[0];
                        applyEffects({ relationship: { targetId: victim.id, favor: 10 } });
                        applyEffects({ relationship: { targetId: instigator.id, favor: -10 } });
                        gameState.marriage.familyHarmony += 3;
                        return `你通过询问下人，发现是${instigator.name}先挑衅。你惩罚了她，安抚了${victim.name}，彰显了你的公正。`;
                    }
                },
                {
                    text: "交由正妻处理",
                    req: () => gameState.marriage.isMarried && gameState.npcs[gameState.marriage.spouseId],
                    action: (involved) => {
                        const wife = gameState.npcs[gameState.marriage.spouseId];
                        if ((wife.attributes.virtue || 50) > 70 && (wife.attributes.wisdom || 50) > 60) {
                            gameState.marriage.familyHarmony += 5;
                            return `你的正妻处理得当，后宅和谐度提升。`;
                        } else {
                            gameState.marriage.familyHarmony -= 8;
                            return `你的正妻偏袒一方，激化了矛盾。`;
                        }
                    }
                }
            ]
        },
        'framing': {
            title: "构陷栽赃",
            trigger: (gs) => {
                if (gs.marriage.familyHarmony > 50) return false;
                const plotters = gs.marriage.concubines.map(id => gs.npcs[id]).filter(c => c && !c.isDead && c.ambition > 60 && c.jealousy > 50);
                const victims = gs.marriage.concubines.map(id => gs.npcs[id]).filter(c => c && !c.isDead && c.favor > 50 && plotters.every(p => p.id !== c.id));
                if (plotters.length === 0 || victims.length === 0) return false;
                const plotter = getRandomElement(plotters);
                const victim = getRandomElement(victims);
                return {
                    involved: [plotter, victim],
                    description: `妾室 <strong class="highlight-npc">${plotter.name}</strong> 突然哭诉，说她珍爱的宠物猫被受宠的 <strong class="highlight-npc">${victim.name}</strong> 毒死了，并拿出了“证据”。`
                };
            },
            options: [
                {
                    text: "勃然大怒，立刻惩罚",
                    req: () => true,
                    action: (involved) => {
                        const [plotter, victim] = involved;
                        applyEffects({ relationship: { targetId: victim.id, favor: -30 } });
                        gameState.marriage.familyHarmony -= 15;
                        gameState.family.reputation -= 10;
                        return `你惩罚了含冤的${victim.name}，她对你好感骤降，并发誓报复。事后你发现是${plotter.name}栽赃，你的声望也因此受损。`;
                    }
                },
                {
                    text: "怀疑此事有诈，暗中调查",
                    req: (player) => player.attributes.strategy > 60,
                    action: (involved) => {
                        const [plotter, victim] = involved;
                        applyEffects({ attributes: { strategy: 3 } });
                        plotter.ambition = Math.max(0, plotter.ambition - 10);
                        return `你派心腹查明真相，果然是${plotter.name}栽赃。你掌握了这个把柄，可以用来控制她。`;
                    }
                },
                {
                    text: "用钱安抚，息事宁人",
                    req: (player) => gameState.finances.wealth > 1000,
                    action: (involved) => {
                        const [plotter, victim] = involved;
                        applyEffects({ wealth: -1000, relationship: { targetId: victim.id, favor: -5 } });
                        plotter.ambition += 5;
                        gameState.marriage.familyHarmony -= 5;
                        return `你用钱安抚了${plotter.name}，她尝到了甜头，未来可能故技重施。${victim.name}对你的不作为感到失望。`;
                    }
                }
            ]
        },
        'heir_struggle': {
            title: "夺嫡之争",
            trigger: (gs) => {
                const wife = gs.npcs[gs.marriage.spouseId];
                if (!wife || !gs.children.some(c => c.motherId === wife.id)) return false; // Must have a legitimate heir
                const ambitiousMothers = gs.marriage.concubines.map(id => gs.npcs[id]).filter(c => c && !c.isDead && c.ambition > 70 && gs.children.some(child => child.motherId === c.id));
                if (ambitiousMothers.length === 0) return false;
                const plotter = getRandomElement(ambitiousMothers);
                return {
                    involved: [plotter, wife],
                    description: `妾室 <strong class="highlight-npc">${plotter.name}</strong> 为了让自己的儿子获得你更多的关注，在背后散播正妻嫡子的谣言，称其“资质平庸，不堪为继”。`
                };
            },
            options: [
                {
                    text: "严厉警告",
                    req: (player) => player.attributes.prestige > 80,
                    action: (involved) => {
                        const [plotter] = involved;
                        plotter.ambition = Math.max(0, plotter.ambition - 20);
                        return `你当众斥责了${plotter.name}，她的野心被暂时压制，但对你的嫡子怀恨在心。`;
                    }
                },
                {
                    text: "考校所有子嗣",
                    req: () => true,
                    action: (involved) => {
                        const [plotter, wife] = involved;
                        if (Math.random() < 0.6) {
                             applyEffects({ attributes: { prestige: 5 } });
                             return `你举办了一场家庭考核，嫡子表现出色，谣言不攻自破，家威提升。`;
                        } else {
                            applyEffects({ relationship: { targetId: wife.id, favor: -10 } });
                            return `考核中，${plotter.name}的儿子表现更优，她的气焰更加嚣张，正妻对你感到不满。`;
                        }
                    }
                },
                {
                    text: "将计就计，考验嫡子",
                    req: (player) => player.attributes.strategy > 70,
                    action: (involved) => {
                        return `你假装相信谣言，故意冷落嫡子，观察他的反应。这或许能磨练出一位心性坚韧的继承人，也可能让你们父子产生隔阂。`;
                    }
                }
            ]
        }
    },
    female: {
    'flattery_trap': {
        title: "捧杀之计",
        trigger: (gs) => {
            if (gs.marriage.householdAuthority.progress >= 20) return false;
            const husband = gs.npcs[gs.marriage.spouseId];
            if (!husband || !husband.concubines || husband.concubines.length === 0) return false;
            const plotter = husband.concubines.map(id => gs.npcs[id]).find(c => c && !c.isDead && ((c.personality && c.personality.includes('腹黑')) || c.ambition > 60));
            return plotter ? { involved: [plotter], description: `你刚过门不久，妾室 <strong class="highlight-npc">${plotter.name}</strong> 便在你向婆婆请安时，当众大肆夸赞你的嫁妆何等丰厚，言语间暗示你“财大气粗，不习节俭”。` } : false;
        },
        options: [
            { text: "顺着她的话自夸", action: () => { 
                applyEffects({relationship: { targetId: 'mother_in_law', favor: -10 }, attributes: {scheming: -2}});
                return '婆婆果然对你产生了不喜之心，认为你不够谦逊。';
             } },
            { text: "谦虚并回捧婆婆", req: (p) => p.attributes.scheming > 50, action: (involved) => { 
                applyEffects({relationship: { targetId: 'mother_in_law', favor: 5 }, relationship: { targetId: involved[0].id, favor: -5 }, attributes: {scheming: 2}});
                return `你谦虚地表示嫁妆皆是父母恩赐，并称赞婆婆持家有道才是你的榜样。婆婆对你颇为满意，${involved[0].name}的计谋落空。`;
            } },
            { text: "转移话题，提及家乡趣闻", req: (p) => p.attributes.charm > 60, action: () => { 
                applyEffects({relationship: { targetId: 'mother_in_law', favor: 2 }, attributes: {charm: 1}});
                return '你巧妙地用家乡趣闻引开了话题，成功化解了尴尬。';
            } }
        ]
    },
    'stolen_pin': {
        title: "失窃的珠钗",
        trigger: (gs) => {
            if (gs.marriage.favor <= 40) return false;
            const husband = gs.npcs[gs.marriage.spouseId];
            if (!husband || !husband.concubines || husband.concubines.length < 2) return false;
            const plotters = husband.concubines.map(id => gs.npcs[id]).filter(c => c && !c.isDead && c.favor < gs.marriage.favor && c.ambition > 50);
            if (plotters.length < 2) return false;
            const mainPlotter = plotters.sort((a,b) => b.ambition - a.ambition)[0];
            const accomplice = plotters.find(p => p.id !== mainPlotter.id);
            return mainPlotter && accomplice ? { involved: [mainPlotter, accomplice], description: `丈夫赏赐给你一支名贵的南海珍珠钗。次日，<strong class="highlight-npc">${mainPlotter.name}</strong> 的丫鬟突然带人冲进你的院子，声称是你的丫鬟偷了她的珠钗，并“搜”出了一模一样的钗子。` } : false;
        },
        options: [
            { text: "百口莫辩，请求丈夫裁决", action: (involved) => {
                applyEffects({marriage: {favor: -15}});
                return '丈夫见后院不宁，心生烦闷，对你好感下降。此事最终不了了之。';
             } },
            { text: "指出破绽，要求对质", req: (p) => p.attributes.scheming > 70, action: (involved) => {
                const [mainPlotter, accomplice] = involved;
                applyEffects({ attributes: { scheming: 5 }, marriage: { favor: 15 } });
                return `你指出“这钗子我昨夜还见夫君赏给了${accomplice.name}一支”，${mainPlotter.name}和${accomplice.name}脸色大变。你成功识破了她们的联合陷害，丈夫对你的智慧刮目相看。`;
            }},
            { text: "主动认罚，展现大度", action: (involved) => { 
                applyEffects({attributes: {virtue: 5}, marriage: {favor: 5}});
                return '你主动承担了“管教下人不严”的责任，并自罚月钱。你的大度让丈夫颇为欣赏，但妾室们可能觉得你软弱可欺。';
            } }
        ]
    },
    'poisoned_soup': {
        title: "一碗燕窝",
        trigger: (gs) => {
            if (!gs.player.isPregnant) return false;
            const husband = gs.npcs[gs.marriage.spouseId];
            if (!husband || !husband.concubines) return false;
            const plotter = husband.concubines.map(id => gs.npcs[id]).find(c => c && !c.isDead && c.ambition > 80 && c.personality.includes('腹黑'));
            return plotter ? { involved: [plotter], description: `你怀孕后，<strong class="highlight-npc">${plotter.name}</strong> 每日亲手为你炖燕窝送来，今日的燕窝似乎颜色有些不对...` } : false;
        },
        options: [
            { text: "信任她，直接喝下", action: (involved) => { 
                applyEffects({attributes: {health: -20}});
                gameState.player.miscarriageChance = (gameState.player.miscarriageChance || 0) + 0.3;
                return '喝下后你腹痛不止，险些流产！健康大幅下降。';
            } },
            { text: "不动声色，请医验药", req: (p) => p.career.path === 'doctor' || p.attributes.wisdom > 80, action: (involved) => {
                const [plotter] = involved;
                gameState.flags.hasConcubineEvidence = plotter.id;
                return `你托故留下燕窝，查出其中含有少量红花。你掌握了${plotter.name}的致命把柄，可以在夫君面前揭发她。`;
            }},
            { text: "借花献佛，转赠她人", req: (p) => p.attributes.scheming > 80, action: (involved) => {
                const husband = gameState.npcs[gameState.marriage.spouseId];
                const otherConcubine = husband.concubines.map(id => gameState.npcs[id]).find(c => c && !c.isDead && c.id !== involved[0].id);
                if (otherConcubine) {
                    applyEffects({relationship: {targetId: otherConcubine.id, favor: -30}});
                    return `你将燕窝转送给${otherConcubine.name}，引发了她与${involved[0].name}的火并，你可坐山观虎斗。`;
                }
                return "府上暂无其他妾室可转赠。";
            }}
        ]
    }
}
};
const HOUSEHOLD_TASKS_EVENTS = {
    procurement: [
        {
            title: '采办布料',
            desc: '府中需要为下人添置四季衣物，你去布庄采买布料。',
            options: [
                { text: '选择耐磨的粗棉布', effects: { finance: 5, wisdom: 1 }, result: '你为府中节省了开支，婆婆称赞你精打细算。' },
                { text: '选择体面的细棉布', effects: { procurement: 3, charm: 1 }, result: '下人们穿上新衣十分体面，夫家脸上有光。' },
                { text: '听信布庄老板推荐', effects: { procurement: -5, scheming: -1 }, result: '你买回的布料看似光鲜，一洗水就缩了，被婆婆责备。' }
            ]
        },
        // ... (此处添加更多采办事件)
        {
            title: '年节礼品',
            desc: '临近年节，需要准备送往各家亲友的礼品。',
            options: [
                { text: '亲自挑选，各不相同', effects: { procurement: 8, etiquette: 2 }, result: '你根据各家喜好准备了礼物，人人都称赞你心思玲珑。' },
                { text: '统一采买，省时省力', effects: { finance: 3 }, result: '虽然礼物不出彩，但也挑不出错处，还节省了开支。' },
                { text: '让管事代办', effects: { personnel: 2, scheming: -1 }, result: '你将此事交由管事，锻炼了下人，但可能出现疏漏。' }
            ]
        }
    ],
    personnel: [
        {
            title: '丫鬟争执',
            desc: '两个一等丫鬟为了谁能去伺候嫡子而起了争执，闹到你面前。',
            options: [
                { text: '各打五十大板', effects: { personnel: -5, virtue: -1 }, result: '你虽平息了争吵，但两个丫鬟都心有怨言。' },
                { text: '考察能力，择优而用', effects: { personnel: 8, wisdom: 2 }, result: '你设下考验，选出更合适的人选，众人心服口服。' },
                { text: '安抚并另作安排', effects: { personnel: 5, charm: 1 }, result: '你安抚了二人，并为另一人安排了同样体面的差事，皆大欢喜。' }
            ]
        },
         // ... (此处添加更多人事事件)
        {
            title: '老仆告老',
            desc: '一位在府中伺候多年的老妈妈想要告老还乡。',
            options: [
                { text: '给予丰厚赏钱', effects: { personnel: 5, virtue: 2 }, result: '你厚赏了老妈妈，府里的下人看到都觉得心里安稳。' },
                { text: '安排其家人入府当差', effects: { personnel: 7 }, result: '你卖了个人情，不仅安抚了老仆，还解决了人手问题。' },
                { text: '按规矩办事', effects: { personnel: -3, finance: 2 }, result: '你按规矩给了赏钱，虽合情理，但略显凉薄。' }
            ]
        }
    ],
    finance: [
        {
            title: '田庄收租',
            desc: '又到了一年田庄收租的日子，管事将账本呈了上来。',
            options: [
                { text: '仔细核对账目', effects: { finance: 8, wisdom: 1 }, result: '你发现一处不易察觉的错漏，为府中挽回了损失。' },
                { text: '询问收成情况', effects: { finance: 3, virtue: 1 }, result: '你关心佃户的收成，并酌情减免了部分租子，获得了仁善的名声。' },
                { text: '全权交予管事', effects: { personnel: 3, finance: -2 }, result: '你信任管事，但也给了他可乘之机。' }
            ]
        },
         // ... (此处添加更多财务事件)
        {
            title: '意外开销',
            desc: '府中花园的池塘漏水，需要一笔不小的开支进行修缮。',
            options: [
                { text: '从账上支取', effects: { finance: -5 }, result: '公事公办，但账面上的开支变大了。' },
                { text: '动用自己的私产补贴', effects: { finance: 10, favor: 5, privateAssets: -200 }, result: '你用私产补贴了家用，婆婆和丈夫都对你另眼相看。' },
                { text: '想办法节省开支', effects: { finance: 3, wisdom: 1 }, result: '你货比三家，找到了更实惠的工匠，节省了开支。' }
            ]
        }
    ]
};
// ===================== 【新功能】宅斗系统数据 END =======================

const PROFESSION_DATA = {
    'civilian': {
        name: "文官",
        icon: "fa-feather-alt",
        gender: "male",
        core_resources: ["zheng_sheng", "men_sheng", "qing_bao"],
        dashboard_name: "我的案牍",
        acts: [
            {
                title: "第一幕：崭露头角",
                level_range: [1, 4],
                goal: "积累学识，金榜题名，获得入场券，并寻找一位可靠的政治引路人。",
                events: [
                    {
                        title: "同窗的请托",
                        desc: "一位家境贫寒但才华横溢的同窗，因凑不齐盘缠，请求你资助他参加乡试。",
                        options: [
                            { text: "【倾囊相助】", cost: { wealth: 200 }, effects: { attributes: { virtue: 5 }, npc_relationship: { npc_key: 'poor_classmate', favor: 50, type: 'ally' } }, result_text: "他对你感激涕零，视你为至交。他若中举，未来将成为你在朝堂上的一大助力。" },
                            { text: "【婉言拒绝】", effects: { npc_relationship: { npc_key: 'poor_classmate', favor: -20 } }, result_text: "你们的关系变得冷淡。他若靠自己另寻他法中举，未来可能会在官场上与你作对。" }
                        ]
                    },
                    {
                        title: "恩师的考验",
                        desc: "你的授业恩师问你对“为政以德”的看法。",
                        options: [
                            { text: "【阐述德政的重要性】", requirements: { virtue: 50 }, effects: { core_resources: { zheng_sheng: 10 }, npc_relationship: { npc_key: 'mentor', favor: 15 } }, result_text: "恩师对你的见解大加赞赏。" },
                            { text: "【论述法理与权术的必要性】", requirements: { wisdom: 50 }, effects: { attributes: { wisdom: 2 }, npc_relationship: { npc_key: 'mentor', favor: -5 } }, result_text: "恩师认为你虽有才智但略显刻薄。" }
                        ]
                    },
                    {
                        title: "书院的雅集",
                        desc: "京城最大的“兰亭书院”举办雅集，文人云集。",
                        options: [
                            { text: "【赋诗一首，技惊四座】", requirements: { talent: 70 }, effects: { attributes: { talent: 3, reputation: 10 }, item: { id: 'ming_shi_qing_jian', amount: 1 } }, result_text: "你的诗作成为了全场焦点，并获得了一张[名士的请柬]。" },
                            { text: "【低调行事，结交新友】", effects: { social: 'expand' }, result_text: "你成功结识了一两位有潜力的同辈，人脉图谱得到扩张，但未能在名士中留下印象。" }
                        ]
                    },
                    {
                        title: "古籍店的奇遇",
                        desc: "你在一家旧书店发现一本蒙尘的古籍。",
                        options: [
                            {
                                text: "【花费500两买下】", cost: { wealth: 500 },
                                getOutcome: (gs) => {
                                    if (Math.random() < 0.5) {
                                        return { text: "书中夹着前朝某位宰相的[施政心得]！", effects: { attributes: { wisdom: 10 }, core_resources: { zheng_sheng: 20 }, item: { id: 'shi_zheng_xin_de', amount: 1 } } };
                                    } else {
                                        return { text: "只是一本普通的古书，你白花了钱。", effects: {} };
                                    }
                                }
                            },
                            { text: "【认为不值，转身离开】", effects: {}, result_text: "无事发生，但也错失了机遇。" }
                        ]
                    },
                    {
                        title: "贫民的求助",
                        desc: "一位老妇拦住你，哭诉她的儿子被恶霸冤枉入狱。",
                        options: [
                            { text: "【仗义执言，为其写状纸】", requirements: { virtue: 40 }, effects: { attributes: { virtue: 10, reputation: 5 } }, result_text: "你的状纸引起了官府的注意，最终沉冤得雪。你获得了城中平民的爱戴。" },
                            { text: "【爱莫能助，赠予银两】", cost: { wealth: 50 }, effects: { attributes: { virtue: 2 } }, result_text: "你给了她一些钱，她感谢你的善良，但她的儿子仍在狱中。" }
                        ]
                    },
                    {
                        title: "整理内阁旧档",
                        desc: "你被安排去整理尘封已久的内阁旧档，工作枯燥且看不到前途。",
                        options: [
                            { text: "【耐心整理，寻找价值】", requirements: { wisdom: 40 }, effects: { attributes: { wisdom: 3 }, core_resources: { qing_bao: 5 } }, result_text: "你在故纸堆中发现了前朝的一些施政得失记录，对为官之道有了更深的理解。" },
                            { text: "【抱怨差事，敷衍了事】", effects: { npc_relationship: { npc_key: 'supervisor', favor: -10 } }, result_text: "你的抱怨被上司听到，给你留下了不好的印象。" }
                        ]
                    },
                    {
                        title: "旁听大理寺审案",
                        desc: "你获得了一个旁听大理寺审理要案的机会。",
                        options: [
                            { text: "【认真观摩，学习断案技巧】", effects: { attributes: { wisdom: 5 } }, result_text: "大理寺卿的审案逻辑让你大开眼界，智慧有所提升。" },
                            { text: "【结交刑名师爷】", requirements: { charm: 50 }, effects: { social: 'expand' }, result_text: "你与一位经验丰富的刑名师爷攀谈起来，为自己增添了一条特殊的人脉。" }
                        ]
                    },
                    {
                        title: "乡绅的请宴",
                        desc: "一位本地的乡绅听闻你的才名，设宴款待，席间他对你大加赞赏，并暗示希望你能为他的家族在乡里行些方便。",
                        options: [
                            { text: "【义正辞严，当场拒绝】", effects: { attributes: { virtue: 5 }, core_resources: { zheng_sheng: 5 } }, result_text: "你维护了官声，但也得罪了这位在地方上颇有势力的乡绅。" },
                            { text: "【含糊其辞，不置可否】", effects: { attributes: { wisdom: 2 } }, result_text: "你用太极推手应付了过去，对方没讨到好处，但也未与你交恶。" },
                            { text: "【心领神会，收下礼金】", effects: { wealth: 1000, attributes: { virtue: -10 } }, result_text: "你收下了乡绅的“心意”，此事可能成为你未来的隐患。" }
                        ]
                    },
                    {
                        title: "参加“曲水流觞”",
                        desc: "京郊举办了一场“曲水流觞”的文人雅集，参与者非富即贵。",
                        options: [
                            { text: "【以文会友】", requirements: { talent: 60 }, effects: { attributes: { talent: 2, reputation: 5 } }, result_text: "你的文采获得了一些赞誉，并结识了一位吏部官员的儿子。" },
                            { text: "【以酒会友】", requirements: { health: 60 }, effects: { attributes: { charm: 2 }, social: 'expand' }, result_text: "你酒量过人，为人豪爽，结交了几位武将子弟。" }
                        ]
                    },
                    {
                        title: "皇帝出巡",
                        desc: "皇帝前往太庙祭祀，你作为随行的小官，有机会近距离观察天颜。",
                        options: [
                            { text: "【恪尽职守，不出差错】", effects: { npc_relationship: { npc_key: 'supervisor', favor: 5 } }, result_text: "你圆满地完成了任务，虽然未引起皇帝注意，但获得了上司的好评。" },
                            { text: "【寻找机会，展现自己】", getOutcome: (gs) => {
                                if (gs.player.attributes.charm > 80 && Math.random() < 0.3) {
                                    return { text: "你的仪表堂堂引起了皇帝的注意，他随口问了你的名字。", effects: { npc_relationship: { npc_key: 'emperor', favor: 5 }, attributes: { reputation: 10 } } };
                                }
                                return { text: "你的举动被视为冒失，遭到了侍卫的呵斥。", effects: { attributes: { reputation: -5 } } };
                            }}
                        ]
                    }
                ],
                milestone_event: {
                    title: "人生转折点 I：科举大考",
                    trigger: { career_level: 2, text_desc: "官阶达到举人，且“才情”与“智慧”总和 > 100", condition: (gs) => (gs.player.attributes.talent + gs.player.attributes.wisdom) > 100 },
                    desc: "贡院大门缓缓打开，数千名考生肃然进入。考场内，号角声长鸣，气氛庄严肃穆。你坐在狭小的号房内，面对着决定你一生命运的考卷。",
                    success: { text: "金榜题名！皇帝亲自接见，根据你的殿试排名赏赐官职、府邸和[御赐文房四宝]。", effects: { career_level_set: 3, wealth: 5000, item: {id: 'yu_ci_wen_fang_si_bao', amount: 1} } },
                    failure: { text: "名落孙山，声望大跌。你需要再等三年，或另寻出路。", effects: { attributes: { reputation: -20 } } }
                }
            },
            {
                title: "第二幕：中流砥柱",
                level_range: [5, 7],
                goal: "在具体的政务中做出成绩，巧妙地进行派系站队，成为朝堂上不可忽视的新生力量。",
                events: [
                    {
                        title: "处理积压卷宗",
                        desc: "你的案牍上堆满了前任留下的陈年旧案，枯燥乏味。",
                        options: [
                            {
                                text: "【花费数日，仔细审阅】",
                                getOutcome: (gs) => {
                                    if (Math.random() < 0.2) {
                                        return { text: "你在卷宗的蛛丝马迹中，发现了前任与某位高官勾结的[贪腐线索]！这是扳倒政敌的绝佳武器。", effects: { item: { id: 'tan_fu_xian_suo', amount: 1 } } };
                                    } else {
                                        return { text: "无事发生，但你获得了上司的赏识，认为你踏实肯干。", effects: { core_resources: { zheng_sheng: 5 } } };
                                    }
                                }
                            },
                            { text: "【敷衍了事，直接归档】", effects: { attributes: { reputation: -5 } }, result_text: "节省了时间，但上司对你的评价降低，且有几率因处理不当导致民怨。" }
                        ]
                    },
                    {
                        title: "同僚的“协助”请求",
                        desc: "一位同僚负责的项目遇到困难，请求你“协助”，但功劳可能全归他。",
                        options: [
                             { text: "【慨然应允】", effects: { npc_relationship: { npc_key: 'requesting_colleague', favor: 30, type: 'ally' }, core_resources: { zheng_sheng: 10 } }, result_text: "你消耗了大量精力，项目成功了。该同僚对你非常感激，成为你的盟友。" },
                             { text: "【要求平分功劳】", effects: { core_resources: { zheng_sheng: 25 }, npc_relationship: { npc_key: 'requesting_colleague', favor: 5 } }, result_text: "对方同意了，你们共同完成了项目。你获得了不错的政声，但对方觉得你斤斤计较。" },
                             { text: "【借故推辞】", effects: { npc_relationship: { npc_key: 'requesting_colleague', favor: -25 } }, result_text: "你与该同僚关系恶化，他可能会在未来给你下绊子。" }
                        ]
                    },
                    {
                        title: "上司的试探",
                        desc: "你的上司在一次私下谈话中，询问你对“太子”和“雍王”的看法。",
                        options: [
                            { text: "【旗帜鲜明地支持太子】", getOutcome: (gs) => ({ text: "你的选择将决定你在派系斗争中的位置。", effects: { political_event: { type: 'align', faction: 'prince' } } }) },
                            { text: "【隐晦地表达对雍王的好感】", getOutcome: (gs) => ({ text: "你的选择将决定你在派系斗争中的位置。", effects: { political_event: { type: 'align', faction: 'yong_wang' } } }) },
                            { text: "【滴水不漏地回答“只忠于皇上”】", effects: {}, result_text: "一个安全但平庸的回答。上司认为你城府很深，但你暂时没有被卷入残酷的派系斗争。" }
                        ]
                    },
                    {
                        title: "地方官员的“冰敬炭敬”",
                        desc: "一位来京述职的地方官，私下给你送来一个沉甸甸的礼盒。",
                        options: [
                             { text: "【欣然收下】", effects: { wealth: 5000, attributes: { virtue: -15 } }, result_text: "打开后是五千两银票。此事有几率成为政敌攻击你的把柄。" },
                             { text: "【严词拒绝并上报】", effects: { attributes: { virtue: 10 }, core_resources: { zheng_sheng: 10 } }, result_text: "你维护了清廉，但也得罪了这位官员和他背后的势力。" },
                             { text: "【退回礼物，但暗示未来可以合作】", requirements: { charm: 70 }, effects: { npc_relationship: { npc_key: 'local_official', favor: 10, type: 'neutral' } }, result_text: "你既保住了清名，又为自己留了条后路。" }
                        ]
                    },
                    {
                        title: "来自风月鉴的情报",
                        desc: "如果你在风月鉴有人脉，一位红颜知己会向你透露一个秘密。",
                        options: [
                            { text: "【仔细聆听】", requirements: { has_fyj_contact: true }, getOutcome: (gs) => {
                                const infoType = Math.random() < 0.5 ? 'si_sheng_huo' : 'cai_wu';
                                return { text: "你获得了一份关于某位大臣的秘密情报。", effects: { item: { id: `qing_bao_${infoType}`, amount: 1 } } }
                            }}
                        ]
                    },
                    {
                        title: "主持乡试",
                        desc: "你被任命为乡试的副考官，这是一个肥差，也是一个烫手山芋。",
                        options: [
                            { text: "【秉公选拔，不徇私情】", effects: { attributes: { virtue: 10, reputation: 10 }, core_resources: { men_sheng: 5 } }, result_text: "你选拔了几位真正的有才之士，他们对你感恩戴德，成为了你的门生。" },
                            { text: "【收受“关节”银】", cost: { wealth: -5000 }, effects: { attributes: { virtue: -15 }, core_resources: { men_sheng: 2 } }, result_text: "你录取了几个世家子弟，获得了大笔钱财，但也留下了把柄。" },
                            { text: "【提拔寒门弟子】", requirements: { virtue: 60 }, effects: { attributes: { virtue: 15 }, core_resources: { men_sheng: 10 } }, result_text: "你的举动赢得了清流的赞誉，并收获了一批忠诚的寒门门生。" }
                        ]
                    },
                    {
                        title: "制定新税法",
                        desc: "户部尚书命你参与制定一项新的税法，可能会触及多方利益。",
                        options: [
                            { text: "【为农民减负】", effects: { core_resources: { zheng_sheng: 15 }, political_event: { type: 'offend', faction: 'landowners' } }, result_text: "新税法获得了民众的支持，但你得罪了地主阶层。" },
                            { text: "【为商人减负】", effects: { wealth: 3000, political_event: { type: 'offend', faction: 'nobles' } }, result_text: "你获得了商人们的政治献金，但得罪了保守的贵族。" },
                            { text: "【维持现状，小修小补】", effects: {}, result_text: "一个安全的选择，但也毫无建树。" }
                        ]
                    },
                    {
                        title: "下放地方",
                        desc: "朝廷提供了一个外放地方，担任知府的机会。",
                        options: [
                            { text: "【前往富庶的江南】", effects: { flag: 'go_to_jiangnan' }, result_text: "你将获得更多的财政收入，但也远离了权力中心。" },
                            { text: "【前往贫瘠的西北】", effects: { flag: 'go_to_xibei' }, result_text: "这是一个艰苦但容易出政绩的地方。" },
                            { text: "【留在京城】", effects: {}, result_text: "你选择留在京城，继续在权力的漩涡中博弈。" }
                        ]
                    },
                    {
                        title: "编撰史书",
                        desc: "你被抽调去参与编撰本朝的史书。",
                        options: [
                            { text: "【秉笔直书】", getOutcome: (gs) => {
                                if (gs.player.attributes.virtue > 100) {
                                    return { text: "你的正直获得了史官们的尊敬，政声+10。", effects: { core_resources: { zheng_sheng: 10 } } };
                                }
                                return { text: "你的直笔得罪了某位权贵，为你树立了敌人。", effects: { political_event: { type: 'offend', faction: 'powerful_minister' } } };
                            }},
                            { text: "【为尊者讳】", effects: { npc_relationship: { npc_key: 'emperor', favor: 5 } }, result_text: "你的“懂事”获得了皇帝的些许好感。" }
                        ]
                    },
                    {
                        title: "皇子们的示好",
                        desc: "太子与雍王都派人私下送来名贵的礼物，向你示好。",
                        options: [
                            { text: "【收下太子的礼物】", effects: { political_event: { type: 'align', faction: 'prince' }, wealth: 1500 }, result_text: "你接受了太子的示好，从此被贴上了“太子党”的标签。" },
                            { text: "【收下雍王的礼物】", effects: { political_event: { type: 'align', faction: 'yong_wang' }, wealth: 1500 }, result_text: "你接受了雍王的示好，从此被视为“雍王党”的一员。" },
                            { text: "【全部退回】", effects: {}, result_text: "你保持了中立，但也可能被双方都视为不识抬举。" }
                        ]
                    }
                ],
                milestone_event: {
                    title: "人生转折点 II：主理黄河大案",
                    trigger: { career_level: 6, text_desc: "官阶达到侍郎，且政声 > 150", condition: (gs) => (gs.career.core_resources.zheng_sheng || 0) > 150 },
                    desc: "黄河决堤，圣上命你彻查此案，背后可能涉及工部与地方官员的惊天贪腐网络。",
                    success: { text: "你成功查明真相，惩治了贪官，安抚了灾民，政声达到顶峰！", effects: { career_level_set: 7, core_resources: { zheng_sheng: 100 }, attributes: { reputation: 50 } } },
                    failure: { text: "调查受阻，你反遭诬陷，被贬斥离京。", effects: { career_level_set: 5, core_resources: { zheng_sheng: -50 } } }
                }
            },
            {
                title: "第三幕：登峰造极",
                level_range: [8, 10],
                goal: "成为派系领袖或孤臣，左右国策，实现自己的政治抱负。",
                events: [
                    {
                        title: "门生的背叛",
                        desc: "你最信任的一位门生，被政敌用高官厚禄收买，掌握了你的一个致命把柄。",
                        options: [
                            { text: "【先发制人，将其灭口】", requirements: { virtue: -50 }, effects: { attributes: { virtue: -50 }, end_game_risk: 0.1 }, result_text: "你解决了后患，但内心被黑暗吞噬，此事若败露，万劫不复。" },
                            { text: "【动之以情，试图挽回】", getOutcome: (gs) => {
                                if ((gs.npcs['trusted_protege']?.favor || 0) > 80) {
                                    return { text: "他幡然醒悟，回到你的阵营，并为你提供了政敌的反向情报！", effects: { item: { id: 'qing_bao_cai_wu', amount: 1 } } };
                                } else {
                                    return { text: "他铁了心背叛你，将在下次大朝会上反戈一击！", effects: { flag: 'protege_betrayal_pending' } };
                                }
                            }},
                            { text: "【壮士断腕，自我牺牲】", effects: { core_resources: { zheng_sheng: -100 }, attributes: { reputation: 50 } }, result_text: "你主动向皇帝请罪，承担部分责任，虽被降职，但保全了整个派系，派系内声望达到顶峰。" }
                        ]
                    },
                    {
                        title: "皇帝的猜忌",
                        desc: "你权势过大，皇帝开始对你心生忌惮，在一次谈话中询问你“是否想告老还乡”。",
                        options: [
                            { text: "【立刻上表请求辞官】", effects: { career_status: 'retired' }, result_text: "皇帝的疑心打消。你暂时退隐，但保留了所有人脉，数年后可能被重新启用。" },
                            { text: "【献上重宝】", effects: { inventory_prompt: 'present_treasure' }, result_text: "你从百宝阁中献上一件价值连城的珍品，皇帝龙颜大悦，暂时忘记了猜忌。" },
                            { text: "【推荐政敌担任要职】", requirements: { wisdom: 150 }, effects: { attributes: { wisdom: 5 } }, result_text: "一招成功的“祸水东引”，转移了皇帝的注意力。但风险极高。" }
                        ]
                    },
                    {
                        title: "外戚干政",
                        desc: "皇后的娘家势力日益庞大，开始插手朝政，与你所在的文官集团产生激烈冲突。",
                        options: [
                             { text: "【联合文官集团，正面硬刚】", effects: { flag: 'war_with_consort_clan' }, result_text: "一场持续数年的“朝堂内战”开启了。" },
                             { text: "【与外戚联姻或合作】", effects: { attributes: { virtue: -30 } }, result_text: "短期内你的权势会更加巩固，但会失去清流文官的支持。" }
                        ]
                    },
                    {
                        title: "储君的请求",
                        desc: "你支持的太子/皇子，私下请求你帮他处理一个“不光彩”的私人问题。",
                        options: [
                            { text: "【代为处理】", effects: { npc_relationship: { npc_key: 'crown_prince', favor: 50 } }, result_text: "你成功后，将成为储君未来的“第一心腹”，但他也会永远掌握你的这个把柄。" },
                            { text: "【劝谏储君】", effects: { npc_relationship: { npc_key: 'crown_prince', favor: -10 }, attributes: { virtue: 10 } }, result_text: "储君可能听从，也可能认为你迂腐而疏远你。" }
                        ]
                    },
                    {
                        title: "天灾与民意",
                        desc: "国内发生大面积天灾，民怨沸腾，流言直指当朝宰辅（也就是你）“德不配位”。",
                        options: [
                             { text: "【下令强力赈灾，并自请降罪】", effects: { attributes: { reputation: 100, virtue: 20 }, core_resources: { zheng_sheng: 50 } }, result_text: "你以退为进，赢得了天下民心和皇帝的倚重。" },
                             { text: "【将责任推给下级或政敌】", effects: { attributes: { reputation: -50, virtue: -20 } }, result_text: "你暂时保住了相位，但失去了民心。" }
                        ]
                    },
                    {
                        title: "推行新政",
                        desc: "你希望推行一项深刻的社会改革（如“一条鞭法”），但必然会触动旧势力的利益。",
                        options: [
                            { text: "【联合新锐官员，强力推行】", requirements: { men_sheng: 50 }, effects: { flag: 'major_reform_started' }, result_text: "改革开始了，这是一场你死我活的政治斗争。若成功，你将名留青史；若失败，你将万劫不复。" },
                            { text: "【寻求皇帝的绝对支持】", requirements: { 'npc_favor_above': {'npc_key': 'emperor', favor: 80} }, effects: { flag: 'major_reform_started_easy' }, result_text: "有了皇帝的支持，你的改革阻力大减。" },
                            { text: "【时机未到，暂缓推行】", effects: {}, result_text: "你选择了稳妥，但也错过了最佳的改革时机。" }
                        ]
                    },
                    {
                        title: "修建私家园林",
                        desc: "你位极人臣，打算修建一座彰显身份的私家园林。",
                        options: [
                            { text: "【耗费巨资，极尽奢华】", cost: { wealth: 50000 }, effects: { attributes: { reputation: 10, virtue: -10 } }, result_text: "你的园林冠绝京城，但也引来了“生活奢靡”的批评。" },
                            { text: "【修建一座简朴的书院式园林】", cost: { wealth: 10000 }, effects: { attributes: { reputation: 5, virtue: 5 } }, result_text: "你的园林清雅脱俗，被誉为“文人风骨”的典范。" }
                        ]
                    },
                    {
                        title: "高丽使臣来访",
                        desc: "高丽使臣前来朝贡，但在殿上言语倨傲，似有轻视之意。",
                        options: [
                            { text: "【以德服人，展现天朝气度】", requirements: { etiquette: 120 }, effects: { attributes: { reputation: 10 } }, result_text: "你的气度折服了对方，不卑不亢地维护了国体。" },
                            { text: "【针锋相对，寸步不让】", requirements: { wisdom: 120 }, effects: { attributes: { reputation: 5 }, core_resources: { zheng_sheng: 10 } }, result_text: "你用犀利的言辞驳得对方哑口无言，大振国威。" }
                        ]
                    },
                    {
                        title: "辞官归隐的同僚",
                        desc: "一位与你关系不错的同僚，因看破官场黑暗，决定辞官归隐。他前来向你辞行。",
                        options: [
                            { text: "【设宴送别】", effects: { npc_relationship: { npc_key: 'retired_colleague', favor: 10 }, attributes: { virtue: 2 } }, result_text: "你们痛饮一番，相约江湖再见。你保留了这份友谊。" },
                            { text: "【劝他留下】", effects: { npc_relationship: { npc_key: 'retired_colleague', favor: 5 } }, result_text: "你劝他留下，但他去意已决。" },
                            { text: "【划清界限】", effects: { npc_relationship: { npc_key: 'retired_colleague', favor: -20 } }, result_text: "你担心受到牵连，与他划清了界限。" }
                        ]
                    },
                    {
                        title: "皇帝的家事",
                        desc: "皇帝就一位皇子的婚事问题，私下征求你的意见。",
                        options: [
                            { text: "【从政治角度分析利弊】", requirements: { wisdom: 150 }, effects: { npc_relationship: { npc_key: 'emperor', favor: 10 } }, result_text: "你的分析深得帝心，皇帝认为你堪为国之柱石。" },
                            { text: "【从人伦角度劝说】", requirements: { virtue: 120 }, effects: { npc_relationship: { npc_key: 'emperor', favor: 5 }, attributes: { virtue: 5 } }, result_text: "你的建议充满了人情味，皇帝虽未采纳，但对你的人品颇为赞许。" }
                        ]
                    }
                ],
                milestone_event: {
                    title: "人生转折点 III：国本之争",
                    trigger: { career_level: 9, text_desc: "官居尚书，且派系斗争白热化", condition: (gs) => (gs.flags.faction_conflict_level > 80) },
                    desc: "皇帝病重，太子与雍王对储位的争夺已到图穷匕见的时刻。你作为一方势力的核心，你的每一个决策都将决定帝国的未来。",
                    success: { text: "你支持的皇子成功登基！你被尊为帝师，拜为内阁首辅，权倾朝野，实现了文官的终极抱负！", effects: { career_level_set: 10, end_game_title: "一代名相" } },
                    failure: { text: "你站错了队，在新皇登基后被清算，或抄家流放，或身首异处。", effects: { end_game: 'execution' } }
                }
            }
        ]
},
'warrior': {
    name: "武将",
    icon: "fa-shield-alt",
    gender: "male",
    core_resources: ["bing_yuan", "liang_cao", "jing_rui_du", "shi_qi", "wei_wang"],
    dashboard_name: "军务沙盘",
    acts: [
        {
            title: "第一幕：浴血新兵",
            level_range: [1, 4],
            goal: "在残酷的军营中活下来，证明您并非弱不禁风的世家子弟，通过实力和智慧赢得尊重，并为自己争取到第一支可以指挥的部队。",
            events: [
                {
                    title: "新兵营的立威",
                    desc: "新兵营中鱼龙混杂，您需要尽快确立自己的地位。",
                    options: [
                        { 
                            text: "【挑战最强的刺头兵痞】", 
                            requirements: { martial: 30 },
                            getOutcome: (gs) => {
                                if(gs.player.attributes.martial > 50 || Math.random() < 0.7) {
                                    return { text: "你干净利落地将他击倒在地。全营新兵对你心生敬畏。", effects: { core_resources: { wei_wang: 10 }, attributes: { martial: 2 } } };
                                } else {
                                    return { text: "你被对方轻松击败，沦为笑柄。", effects: { core_resources: { wei_wang: -5 }, attributes: { health: -5 } } };
                                }
                            }
                        },
                        { text: "【分享你的家信和食粮】", effects: { attributes: { virtue: 3 }, core_resources: { shi_qi: 5 } }, result_text: "你的善举赢得了人心，结识了2-3名“袍泽”（忠诚的战友），他们未来可能成为你心腹副将的候选人。" },
                        { text: "【在操练中表现突出】", requirements: { health: 80 }, effects: { npc_relationship: { npc_key: 'sergeant', favor: 15 } }, result_text: "你惊人的耐力和技巧引起了百夫长的注意，他可能会在【夺旗大比武】中给你一个有利的位置。" }
                    ]
                },
                {
                    title: "军械库的抉择",
                    desc: "百夫长允许你从军械库为自己挑选一套装备。",
                    options: [
                        { text: "【选择厚重的步兵重甲】", effects: { item: { id: 'bai_lian_bu_ren_jia', amount: 1 } }, result_text: "你获得[百炼步人甲]，装备后健康上限+10，战场生存率提升，但个人突击能力下降。" },
                        { text: "【选择轻便的斥候皮甲】", effects: { item: { id: 'ji_feng_chi_hou_jia', amount: 1 } }, result_text: "你获得[疾风斥候甲]，装备后战场移动力提升，突袭/侦查成功率提升，但防御力较弱。" },
                        { text: "【请求一把上好的武器】", getOutcome: (gs) => {
                            if ((gs.npcs['sergeant']?.favor || 0) > 30) {
                                return { text: "他将自己的旧佩刀赠予你，装备后武学+3。", effects: { item: { id: 'bai_fu_chang_pei_dao', amount: 1 } } };
                            }
                            return { text: "百夫长表示武器需按军功分配，拒绝了你的请求。", effects: {} };
                        }}
                    ]
                },
                {
                    title: "斥候任务的风险",
                    desc: "你被派去侦查一片从未涉足过的密林。",
                    options: [
                        { text: "【选择安全的官道路线】", effects: { core_resources: { wei_wang: 2 } }, result_text: "你安全返回，带回了普通的情报，获得了少量战功。" },
                        { text: "【选择危险的林中小径】", requirements: { wisdom: 40 }, getOutcome: (gs) => {
                            if(Math.random() > 0.4){
                                return { text: "你发现了一条可以绕到敌人后方的秘密小路！", effects: { item: { id: 'mi_lin_di_xing_tu', amount: 1 } } };
                            }
                            return { text: "你遭遇了野兽或陷阱，负伤而归。", effects: { attributes: { health: -10 } } };
                        }}
                    ]
                },
                {
                    title: "战马的挑选",
                    desc: "一批新的战马运抵军营，你有优先挑选权。",
                    options: [
                        { text: "【凭感觉挑选一匹】", getOutcome: (gs) => {
                            if(Math.random() < 0.3){
                                 return { text: "你运气不错，挑到一匹良驹[神骏的战马]！", effects: { item: { id: 'shen_jun_zhan_ma', amount: 1 } } };
                            }
                            return { text: "你挑了一匹普通的战马，无事发生。", effects: {}}
                        }},
                        { text: "【向马夫请教并赠礼】", cost: { wealth: 100 }, effects: { item: { id: 'shen_jun_zhan_ma', amount: 1 } }, result_text: "马夫对你表示感谢，并为你挑选了一匹上好的战马。" },
                        { text: "【使用[相马经]挑选】", requirements: { has_item: 'xiang_ma_jing' }, effects: { item: { id: 'chi_dian', amount: 1 } }, result_text: "你运用知识，竟在马群中发现了一匹有“汗血”血统的宝马[赤电]！" }
                    ]
                },
                {
                    title: "首次领取军饷",
                    desc: "军需官“不小心”多给了你一份军饷。",
                    options: [
                         { text: "【当场退还】", effects: { attributes: { virtue: 5 }, npc_relationship: { npc_key: 'quartermaster', favor: 20 } }, result_text: "军需官对你的诚实印象深刻，这对你未来的粮草补给效率至关重要。" },
                         { text: "【不动声色地收下】", effects: { wealth: 200, attributes: { virtue: -5 } }, result_text: "你额外获得了200两。但军需官可能是在试探你，若如此，他对你的评价会降低。" },
                         { text: "【用多余的钱请全队喝酒】", effects: { core_resources: { shi_qi: 10, wei_wang: 5 }, attributes: { virtue: -2 } }, result_text: "你在队里的威信大增，士气高涨。" }
                    ]
                },
                {
                    title: "边境摩擦",
                    desc: "一小股敌军越过边境进行骚扰，百夫长命你带一队人前去驱逐。",
                    options: [
                        { text: "【奋勇当先，斩获首级】", requirements: { martial: 40 }, effects: { core_resources: { wei_wang: 5 }, attributes: { martial: 1 } }, result_text: "你成功驱逐敌军并小有斩获，获得了第一次军功。" },
                        { text: "【稳妥为上，驱逐即可】", effects: { core_resources: { wei_wang: 2 } }, result_text: "你成功完成了任务，但表现平平。" },
                        { text: "【追击过深，遭遇埋伏】", effects: { attributes: { health: -15 }, core_resources: { wei_wang: -5 } }, result_text: "你因贪功而冒进，导致小队受损，自己也受了伤。" }
                    ]
                },
                {
                    title: "老兵的刁难",
                    desc: "一位看不起你世家子弟身份的老兵，在训练时处处给你使绊子。",
                    options: [
                        { text: "【忍气吞声】", effects: { attributes: { health: -2 } }, result_text: "你选择忍耐，但这让对方更加变本加厉。" },
                        { text: "【向百夫长报告】", effects: { npc_relationship: { npc_key: 'veteran_soldier', favor: -15 } }, result_text: "百夫长训斥了老兵，但他从此恨上了你。" },
                        { text: "【用实力说话】", requirements: { martial: 50 }, effects: { npc_relationship: { npc_key: 'veteran_soldier', favor: 20 } }, result_text: "你在一次对练中堂堂正正地击败了他，赢得了他的尊重。" }
                    ]
                },
                {
                    title: "学习兵法",
                    desc: "军中藏书室有一些基础兵法可供阅读。",
                    options: [
                        { text: "【研读《孙子兵法》】", effects: { attributes: { wisdom: 3 } }, result_text: "你对战争的宏观策略有了初步了解。" },
                        { text: "【学习《练兵实纪》】", effects: { core_resources: { jing_rui_du: 1 } }, result_text: "你学习了如何更有效地训练士兵。" }
                    ]
                },
                {
                    title: "家书与包裹",
                    desc: "你收到了家人寄来的包裹，里面有一些家乡特产和一封嘘寒问暖的信。",
                    options: [
                        { text: "【与袍泽分享】", effects: { core_resources: { shi_qi: 8 }, attributes: { virtue: 2 } }, result_text: "你的分享让整个小队都感受到了温暖，士气提升。" },
                        { text: "【独自享用】", effects: {}, result_text: "你感受到了家人的关爱，缓解了思乡之情。" }
                    ]
                },
                {
                    title: "修补盔甲",
                    desc: "你的盔甲在上次训练中有些破损。",
                    options: [
                        { text: "【向军需官申请新的】", getOutcome: (gs) => {
                            if ((gs.npcs['quartermaster']?.favor || 0) > 10) {
                                return { text: "军需官爽快地为你更换了更好的盔甲。", effects: {} };
                            }
                            return { text: "军需官以物资紧张为由拒绝了你。", effects: {} };
                        }},
                        { text: "【自己动手修补】", effects: { attributes: { health: 1 } }, result_text: "虽然辛苦，但你对自己的装备更加了解，也锻炼了动手能力。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：沙场夺帅",
                trigger: { career_level: 3, text_desc: "武举人, 武学>80, 威望>50", condition: (gs) => gs.player.attributes.martial > 80 && (gs.career.core_resources.wei_wang || 0) > 50 },
                desc: "尘土飞扬的巨大演武场上，两个百人队分列两端。你身处阵前，对面是你的竞争对手。这不是个人比武，而是你作为指挥官的第一次大考。",
                success: { text: "你赢得了演武！被将军当众提拔为“校尉”，正式成为军官，获得兵权，可以指挥一支百人队，并获得[校尉的铁符]！", effects: { career_level_set: 4, item: { id: 'xiao_wei_tie_fu', amount: 1 } } },
                failure: { text: "演武失败，你失去了晋升机会，被调往后勤部队一年，竞争对手成为你的上司。", effects: { career_level_set: 3 } }
            }
        },
        {
            title: "第二幕：百战之将",
            level_range: [5, 8],
            goal: "真正指挥一场战役，学会后勤与战术的结合，赢得一场决定性的胜利，并建立自己的威望。",
            events: [
                {
                    title: "军中赌局",
                    desc: "你发现你的士兵在私下聚赌，士气高昂但军纪涣散。",
                    options: [
                        { text: "【严厉禁止并惩罚】", effects: { core_resources: { jing_rui_du: 2, shi_qi: -10 } }, result_text: "军纪得到整肃，部队精锐度微升。但士气下降，你与部分士兵关系下降。" },
                        { text: "【睁一只眼闭一只眼】", effects: { core_resources: { shi_qi: 5 } }, result_text: "士气上升，但有几率触发“士兵因赌债内斗”的负面事件。" },
                        { text: "【亲自下场，赢光他们的钱再还给他们】", requirements: { wisdom: 90, charm: 80 }, effects: { core_resources: { wei_wang: 15, shi_qi: 10 } }, result_text: "你用高超的技巧震慑了所有人，又用仁义收买了人心。部队忠诚度大幅提升。" }
                    ]
                },
                {
                    title: "攻城器械的筹备",
                    desc: "为准备下一次攻城战，你需要建造攻城器械。",
                    options: [
                        { text: "【使用标准图纸和材料】", cost: { wealth: 2000 }, effects: {}, result_text: "你正常完成了任务。" },
                        { text: "【使用[墨家图纸]】", requirements: { has_item: 'mo_jia_tu_zhi' }, cost: { wealth: 10000 }, effects: { flag: 'super_weapon_ready' }, result_text: "你建造出威力巨大的“神机弩车”！在下次攻城战中，你将获得巨大的优势。" },
                        { text: "【强征民夫，加速建造】", effects: { attributes: { virtue: -10 }, flag: 'civilian_resentment' }, result_text: "建造速度提升，但当地民怨沸腾，有几率在战时遭遇后勤补给线被破坏的事件。" }
                    ]
                },
                {
                    title: "审问高级战俘",
                    desc: "你俘虏了一名敌军的百夫长。",
                    options: [
                        { text: "【以其家人性命相威胁】", effects: { attributes: { virtue: -15, wei_wang: -5 } }, result_text: "你获得了情报，但手段为人不齿。" },
                        { text: "【许诺高官厚禄进行策反】", requirements: { charm: 90 }, cost: { wealth: 1000 }, getOutcome: (gs) => {
                            if (gs.player.attributes.charm > 100 || Math.random() < 0.6) {
                                return { text: "他被你说动，同意成为你安插在敌军中的间谍。", effects: { flag: 'enemy_spy_planted' } };
                            }
                            return { text: "对方不为所动，在你转身后自尽，你一无所获。", effects: {} };
                        }},
                        { text: "【以礼相待，晓以大义】", requirements: { virtue: 100 }, effects: { attributes: { virtue: 5 } }, result_text: "他被你的气度折服，吐露了部分情报。" }
                    ]
                },
                {
                    title: "夜巡营地",
                    desc: "深夜，你决定亲自巡视营地。",
                    options: [
                        { text: "【开始巡视】", getOutcome: (gs) => {
                            const rand = Math.random();
                            if(rand < 0.33) return { text: "你发现哨兵在打瞌睡。你选择严惩，军纪提升，但该哨兵憎恨你。", effects: { core_resources: { jing_rui_du: 1 } } };
                            if(rand < 0.66) return { text: "你听到几个士兵在讨论家乡，思乡情切。你上前安慰了几句，士气有所回升。", effects: { core_resources: { shi_qi: 5 } } };
                            return { text: "你撞见你的心腹副将在独自加练，你很欣慰。", effects: { npc_relationship: { npc_key: 'deputy', favor: 10 }, attributes: { martial: 2 } } };
                        }}
                    ]
                },
                {
                    title: "朝廷的使者",
                    desc: "皇帝派来的使者（监军）抵达你的军营，传达“圣意”。",
                    options: [
                         { text: "【盛情款待，重金贿赂】", cost: { wealth: 3000 }, effects: { flag: 'imperial_court_impressed' }, result_text: "监军在给皇帝的报告中对你大加赞赏，你在朝中的评价提升。" },
                         { text: "【展示军威，强调军情紧急】", effects: { core_resources: { wei_wang: 10 } }, result_text: "监军被你的军威震慑，不敢过多干涉你的军务。" },
                         { text: "【哭诉艰难，请求补给】", getOutcome: (gs) => {
                             if(gs.player.attributes.charm > 80){
                                 return {text: "监军深表同情，回京后会为你争取更多的兵源和粮草。", effects: {}}
                             }
                             return {text: "监军认为你是在夸大其词，推脱责任，对你印象变差。", effects: {}}
                         }}
                    ]
                },
                {
                    title: "粮草告急",
                    desc: "因大雨冲毁道路，你的粮草补给线被切断，军中断粮三日。",
                    options: [
                        { text: "【开仓放粮，与士卒同食】", requirements: { virtue: 80 }, effects: { core_resources: { shi_qi: 20, wei_wang: 10 }, attributes: { health: -5 } }, result_text: "你的举动极大鼓舞了士气，士兵们愿为你死战。" },
                        { text: "【派兵劫掠附近村庄】", effects: { core_resources: { liang_cao: 50 }, attributes: { virtue: -20 }, flag: 'civilian_hate' }, result_text: "你解决了燃眉之急，但失去了民心，品德大降。" },
                        { text: "【派敢死队强行打通补给线】", effects: { core_resources: { bing_yuan: -10 } }, result_text: "你损失了一部分士兵，但成功恢复了补给。" }
                    ]
                },
                {
                    title: "敌将的挑战信",
                    desc: "敌方主将派人送来挑战信，约你三日后在阵前单挑。",
                    options: [
                        { text: "【欣然应战】", requirements: { martial: 120 }, effects: { flag: 'duel_pending' }, result_text: "一场决定两军士气的决斗即将展开。" },
                        { text: "【称病不出】", effects: { core_resources: { shi_qi: -15, wei_wang: -10 } }, result_text: "你的避战行为让全军士气大跌。" },
                        { text: "【设下埋伏】", requirements: { wisdom: 100 }, effects: { attributes: { virtue: -10 } }, result_text: "你计划在决斗地点设下埋伏，此举虽不光彩但或许有效。" }
                    ]
                },
                {
                    title: "瘟疫的蔓延",
                    desc: "军中开始蔓延一种可怕的疾病，病倒的士兵越来越多。",
                    options: [
                        { text: "【隔离病患，焚烧尸体】", requirements: { virtue: 50 }, effects: { core_resources: { bing_yuan: -20 }, attributes: { health: -10 } }, result_text: "你果断的措施控制了瘟疫，但损失了部分兵员。" },
                        { text: "【向朝廷请求名医】", effects: {}, result_text: "朝廷可能会派来医官，但这需要时间。" },
                        { text: "【隐瞒不报】", effects: { core_resources: { bing_yuan: -50, shi_qi: -20 } }, result_text: "瘟疫彻底失控，你的军队战斗力大减。" }
                    ]
                },
                {
                    title: "部将的矛盾",
                    desc: "你的两位心腹部将因战功分配问题产生激烈矛盾，几近火并。",
                    options: [
                        { text: "【各打五十大板】", effects: { core_resources: { shi_qi: -5 } }, result_text: "你暂时压制了矛盾，但两人心中都有怨气。" },
                        { text: "【查明真相，公正裁决】", requirements: { wisdom: 90 }, effects: { core_resources: { wei_wang: 5 } }, result_text: "你的公正赢得了全军的尊重。" },
                        { text: "【偏袒一方】", effects: { npc_relationship: { npc_key: 'unfavored_deputy', favor: -30 } }, result_text: "你安抚了一方，却彻底失去了另一位部将的忠心。" }
                    ]
                },
                {
                    title: "发现敌军间谍",
                    desc: "你通过蛛丝马迹，发现军中藏有敌军的间谍。",
                    options: [
                        { text: "【公开处决】", effects: { core_resources: { jing_rui_du: 2 } }, result_text: "你用雷霆手段震慑了全军，军纪得到提升。" },
                        { text: "【将计就计，传递假情报】", requirements: { wisdom: 110 }, effects: { flag: 'false_intel_sent' }, result_text: "你开始利用这名间谍，为下一次大战布局。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：固守孤城",
                trigger: { career_level: 7, text_desc: "官阶达到都司，威望>400", condition: (gs) => (gs.career.core_resources.wei_wang || 0) > 400 },
                desc: "乌云蔽日，风雪交加。你站在孤城的城楼上，关外是黑压压一片、望不到尽头的敌国大军。这是决定帝国北境命运的血战。",
                success: { text: "你奇迹般地守住了孤城！一战成名，被册封为“护国将军”，官阶升为总兵，并获赐[帅印]！", effects: { career_level_set: 8, item: { id: 'shuai_yin', amount: 1 }, attributes: { reputation: 100 } } },
                failure: { text: "守城失败，北境门户大开，你被定罪，流放三千里。武将生涯基本结束。", effects: { end_game: 'exile' } }
            }
        },
        {
            title: "第三幕：帝国之壁",
            level_range: [9, 10],
            goal: "成为帝国军魂，你的名字能令敌军闻风丧胆，你的决策不仅关乎战争胜负，更关乎国家命运和权力更迭。",
            events: [
                {
                    title: "设立私属卫队",
                    desc: "你的地位显赫，需要一支绝对忠于你个人的卫队。",
                    options: [
                        { text: "【从追随你多年的老兵中选拔】", requirements: { wei_wang: 800 }, effects: { core_resources: { jing_rui_du: 20 }, flag: 'imperial_court_suspicion' }, result_text: "你组建了一支忠诚度极高的“百战死士”，但此事会引起朝廷的猜忌。" },
                        { text: "【从江湖上招募亡命之徒】", cost: { wealth: 10000 }, effects: { attributes: { virtue: -10 } }, result_text: "你获得了一支战斗力极强但纪律涣散的“江湖客卿”，他们能帮你处理一些“脏活”。" }
                    ]
                },
                {
                    title: "异族公主的和亲",
                    desc: "为了边境的长期和平，朝廷希望你迎娶曾是敌对部落的公主。",
                    options: [
                        { text: "【为了国家，接受联姻】", effects: { flag: 'horde_alliance', npc_relationship: { npc_key: 'spouse', favor: -50 } }, result_text: "你与该部落关系变为“盟友”，在未来的国战中可召唤他们作为援军。但你的正妻好感大降。" },
                        { text: "【以已有家室为由，断然拒绝】", effects: { npc_relationship: { npc_key: 'spouse', favor: 30 } }, result_text: "你的忠贞赢得了家人的赞赏，但和谈破裂，边境战火重燃。" },
                        { text: "【推荐你的心腹副将迎娶】", effects: {}, result_text: "一个两全其美的方案，但该副将将成为该部落在军中的代言人，未来可能成为你的潜在威胁。" }
                    ]
                },
                {
                    title: "战功封赏的分配",
                    desc: "一场大胜后，朝廷赐下大片封地和爵位，由你来分配。",
                    options: [
                        { text: "【优先封赏心腹将领】", effects: { core_resources: { shi_qi: -5 } }, result_text: "你的核心团队忠诚度爆表，成为牢不可破的军事集团。但普通士兵会感到不公。" },
                        { text: "【将大部分土地分给阵亡士兵家属】", effects: { core_resources: { wei_wang: 50, shi_qi: 20 }, attributes: { virtue: 20 } }, result_text: "你在军中被誉为“仁帅”，威望和品德达到顶峰，全军士气高涨。但你的心腹将领会觉得你“不够意思”。" },
                        { text: "【为自己的家族谋取最大利益】", effects: { core_resources: { wei_wang: -30 }, attributes: { virtue: -20 } }, result_text: "你的家族获得大量土地和财富，但你在军中的威望和品德大幅下降。" }
                    ]
                },
                {
                    title: "来自京城的“恩赏”",
                    desc: "皇帝派人送来美酒佳肴，并“关心”地询问你的健康状况。",
                    options: [
                         { text: "【立刻上表称病，请求回京休养】", effects: { career_status: 'retired' }, result_text: "这是“杯酒释兵权”的信号。你选择放权，保全了富贵。武将生涯结束，进入半退休状态。" },
                         { text: "【回信称将在外君命有所不受】", effects: { flag: 'imperial_rebellion_imminent' }, result_text: "你与皇帝的关系彻底破裂，进入高度紧张状态，人生转折点将被立刻触发。" }
                    ]
                },
                {
                    title: "兵书的撰写",
                    desc: "戎马一生，你决定将自己的用兵心得著书立说。",
                    options: [
                        { text: "【花费一年时间，倾心撰写】", getOutcome: (gs) => {
                            if(gs.player.attributes.wisdom > 120 && gs.player.attributes.martial > 150) {
                                return {text: "你成功写出了旷世兵书！", effects: {item: {id:'wu_mu_bing_fa', amount: 1}}};
                            }
                            return {text: "你写的兵书漏洞百出，被兵家耻笑。", effects: {core_resources: {wei_wang: -20}}};
                        }}
                    ]
                },
                {
                    title: "兔死狗烹",
                    desc: "天下太平，皇帝开始裁撤军队，你的兵权被大幅削减。",
                    options: [
                        { text: "【主动上交兵权】", effects: { career_status: 'retired' }, result_text: "你以退为进，打消了皇帝的疑心，被封为虚职国公，安享晚年。" },
                        { text: "【暗中抵制，保留实力】", effects: { flag: 'military_tension' }, result_text: "你与朝廷的关系变得紧张，皇帝对你的猜忌与日俱增。" }
                    ]
                },
                {
                    title: "边患再起",
                    desc: "已经归隐的你，听闻边关再次燃起战火，朝中无人能敌。",
                    options: [
                        { text: "【上书请求挂帅出征】", getOutcome: (gs) => {
                            if ((gs.npcs['emperor']?.favor || 0) > 30) {
                                return { text: "皇帝准奏，你将再次披甲上阵！", effects: { career_status: 'active' } };
                            }
                            return { text: "皇帝驳回了你的请求，宁愿割地赔款也不愿再让你手握兵权。", effects: {} };
                        }}
                    ]
                },
                {
                    title: "养子与亲子",
                    desc: "你勇猛的养子与你才华横溢的亲生儿子，都希望能成为你的继承人。",
                    options: [
                        { text: "【立亲生儿子为继承人】", effects: { npc_relationship: { npc_key: 'adopted_son', favor: -50 } }, result_text: "你的养子感到无比失望，可能会离开你。" },
                        { text: "【立养子为继承人】", effects: { npc_relationship: { npc_key: 'biological_son', favor: -50 } }, result_text: "你的亲生儿子感到被抛弃，与你产生隔阂。" },
                        { text: "【让他们公平竞争】", effects: {}, result_text: "一个考验你智慧的长期挑战开始了。" }
                    ]
                },
                {
                    title: "最后的练兵",
                    desc: "你将自己最后的心得传授给你最精锐的部队。",
                    options: [
                        { text: "【传授“陷阵之志”】", effects: { core_resources: { jing_rui_du: 10, shi_qi: 5 } }, result_text: "你的部队获得了“陷阵”特性，在攻城战中拥有巨大优势。" },
                        { text: "【传授“不动如山”】", effects: { core_resources: { jing_rui_du: 10, shi_qi: 5 } }, result_text: "你的部队获得了“不动”特性，在守城战中坚不可摧。" }
                    ]
                },
                {
                    title: "故人来访",
                    desc: "一位早已解甲归田的老部下，不远千里前来探望你。",
                    options: [
                        { text: "【与其彻夜长谈】", effects: { core_resources: { wei_wang: 10 }, attributes: { virtue: 5 } }, result_text: "你们回忆往昔峥嵘岁月，感慨万千。你仁义待人的名声再次远播。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：龙椅之前",
                trigger: { career_level: 10, text_desc: "官阶达到大都督，且与皇帝关系破裂", condition: (gs) => (gs.flags.imperial_rebellion_imminent) },
                desc: "功高震主，鸟尽弓藏。你手握帝国最精锐的军队，是选择成为拯救王朝的忠臣，还是开创自己王朝的枭雄？",
                success: { text: "你选择了“清君侧”，黄袍加身，登基为帝，开创了新的王朝！", effects: { end_game: 'emperor' } },
                failure: { text: "你选择放下兵权，以换取皇帝的信任。你被封为异姓王，但从此远离权力中心，做一个富贵闲人。", effects: { end_game: 'peaceful_retirement' } }
            }
        }
    ]
},
'merchant': {
    name: "商贾",
    icon: "fa-store-alt",
    gender: "male",
    core_resources: ["ben_jin", "xin_yu", "shang_lu", "qing_bao"],
    dashboard_name: "商行账本",
    acts: [
        {
            title: "第一幕：崭露头角",
            level_range: [1, 4],
            goal: "学会经商的基本手腕，积累第一桶金，在京城商圈中建立最初的“信誉”。",
            events: [
                {
                    title: "地痞的“保护费”",
                    desc: "你的小店铺开张不久，几个地痞流氓前来收取“保护费”。",
                    options: [
                        { text: "【破财消灾】", cost: { wealth: 300 }, effects: { core_resources: { xin_yu: -5 } }, result_text: "你暂时获得了安宁，但此事传开，人人都觉得你好欺负。下个季度他们会要求更多。" },
                        { 
                            text: "【报官处理】", 
                            getOutcome: (gs) => {
                                // 假设存在一个与官府的关系值
                                if ((gs.social.government_favor || 0) > 10) {
                                    return { text: "官府派人驱逐了地痞，你与该区域衙役好感+10。", effects: { social_favor: { group: 'constables', change: 10 } } };
                                } else {
                                    return { text: "官府敷衍了事，地痞的报复变本加厉，你的店铺被骚扰，损失了200两。", effects: { wealth: -200 } };
                                }
                            }
                        },
                        { text: "【雇佣打手】", cost: { wealth: 500 }, effects: { }, result_text: "你雇佣的打手将地痞打跑，一劳而逸。你获得“手段强硬”的名声，该区域无人再敢骚扰。" }
                    ]
                },
                {
                    title: "收到伪造的银票",
                    desc: "在一次繁忙的交易中，你收到了一张难以分辨真伪的大额银票。",
                    options: [
                        { text: "【自认倒霉，销毁银票】", effects: { wealth: -500, core_resources: { xin_yu: 10 }, attributes: { virtue: 5 } }, result_text: "你损失了这笔钱，但保住了名声。" },
                        { 
                            text: "【想办法花出去】", 
                            getOutcome: (gs) => {
                                if (gs.player.attributes.wisdom > 60 || (gs.player.attributes.wisdom > 40 && Math.random() < 0.5)) {
                                    return { text: "你成功地将伪钞用在了原料采购上，无人发觉。", effects: { attributes: { wisdom: 2, virtue: -10 } } };
                                } else {
                                    return { text: "被当场识破，你的店铺被认为“售假”，信誉大跌。", effects: { core_resources: { xin_yu: -30 }, attributes: { reputation: -10 } } };
                                }
                            }
                        }
                    ]
                },
                {
                    title: "老掌柜的提点",
                    desc: "一位经验丰富的老掌柜，在茶馆里对你最近的几笔生意进行了点评。",
                    options: [
                        { text: "【虚心请教】", effects: { flag: 'unlock_skill_careful_storage', npc_relationship: { npc_key: 'old_manager', favor: 20 } }, result_text: "老掌柜对你的谦逊颇为欣赏，向你传授了“货物储存”的诀窍（永久被动：商品损耗率降低5%）。" },
                        { text: "【赠送[上等茶叶]】", requirements: { has_item: 'shang_deng_cha_ye' }, effects: { item: { id: 'jiang_nan_gong_huo_shang', amount: 1 } }, result_text: "老掌柜非常高兴，不仅传授你经验，还为你介绍了一个新的[江南供货商名录]，解锁了隐藏的低价进货渠道。" }
                    ]
                },
                {
                    title: "发现新的货源",
                    desc: "一位来自蜀地的行脚商向你兜售一批质地新颖的蜀锦，但价格不菲。",
                    options: [
                        { text: "【投入本金，全部吃下】", cost: { wealth: 1000 }, effects: { wealth: 1500, flag: 'shudi_trader_contact' }, result_text: "这批蜀锦在京城大受欢迎，你大赚一笔。你与这位行脚商建立了联系，有几率在未来开启“蜀地商路”。" },
                        { text: "【谨慎试探，只买样品】", cost: { wealth: 100 }, effects: { wealth: 50 }, result_text: "样品让你小赚一笔，但也错过了最大的利润。" }
                    ]
                },
                {
                    title: "第一次长途运货",
                    desc: "你需要亲自押送一批货物到邻近的州府。",
                    options: [
                        { text: "【雇佣最便宜的镖局】", getOutcome: (gs) => {
                            if (Math.random() < 0.5) {
                                return { text: "路上遭遇劫匪，你的货物和本金全部损失！", effects: { wealth: -gs.finances.wealth } }; // 假设损失全部
                            }
                            return { text: "虽然一路提心吊胆，但总算安全抵达。", effects: {} };
                        }},
                        { text: "【雇佣最贵的[振远镖局]】", cost: { wealth: 500 }, effects: { core_resources: { xin_yu: 5 } }, result_text: "路上绝对安全，但利润也相应降低。" },
                        { text: "【跟随其他大商队一起走】", requirements: { npc_favor_above: { npc_key: 'merchant_friend', favor: 30 } }, effects: { npc_relationship: { npc_key: 'merchant_friend', favor: 10 } }, result_text: "你安全抵达，并加深了与该商人的关系。" }
                    ]
                },
                {
                    title: "囤积居奇",
                    desc: "因天气原因，城中的米价开始上涨，你仓库里还有一批陈米。",
                    options: [
                        { text: "【立即平价出售】", effects: { wealth: 100, core_resources: { xin_yu: 10 }, attributes: { virtue: 5 } }, result_text: "你获得了微薄的利润和良好的信誉。" },
                        { text: "【等待价格最高点再出售】", getOutcome: (gs) => {
                            if (Math.random() < 0.7) {
                                return { text: "你赌对了时机，大赚一笔！", effects: { wealth: 1000, attributes: { virtue: -5 } } };
                            }
                            return { text: "官府突然开仓放粮，米价暴跌，你血本无归。", effects: { wealth: -300 } };
                        }}
                    ]
                },
                {
                    title: "学徒的建议",
                    desc: "你店里的一个小学徒，向你提出了一个关于店铺陈列的建议。",
                    options: [
                        { text: "【采纳并奖励】", effects: { core_resources: { xin_yu: 5 }, attributes: { charm: 2 } }, result_text: "新的陈列方式果然吸引了更多顾客。你的开明让学徒们更加忠心。" },
                        { text: "【不予理会】", effects: {}, result_text: "你认为一个学徒懂什么，错失了一个改进的机会。" }
                    ]
                },
                {
                    title: "商会入门",
                    desc: "本地商会邀请你参加入会晚宴，你需要缴纳会费。",
                    options: [
                        { text: "【缴纳会费，正式入会】", cost: { wealth: 500 }, effects: { flag: 'guild_member', social: 'expand' }, result_text: "你成功加入商会，获得了更多的人脉和情报来源。" },
                        { text: "【认为不值，拒绝加入】", effects: {}, result_text: "你选择单打独斗，但也失去了庇护和机会。" }
                    ]
                },
                {
                    title: "第一笔贷款",
                    desc: "你看到了一个极好的机会，但本金不足，需要向钱庄贷款。",
                    options: [
                        { text: "【贷款一千两】", effects: { wealth: 1000, flag: 'debt_1000' }, result_text: "你获得了资金，但需要在年底前连本带利偿还。" },
                        { text: "【放弃机会】", effects: {}, result_text: "你选择了稳妥，但也错失了发展的良机。" }
                    ]
                },
                {
                    title: "竞争对手的挑衅",
                    desc: "对家店铺的掌柜在酒楼里公然嘲讽你的生意“小打小闹”。",
                    options: [
                        { text: "【一笑置之】", effects: { attributes: { wisdom: 2 } }, result_text: "你的气度让旁观者暗自点头。" },
                        { text: "【唇枪舌剑，当场反击】", requirements: { charm: 50 }, effects: { core_resources: { xin_yu: 5 } }, result_text: "你巧妙地反击，既维护了自家声誉，又让对方下不来台。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：首次独立行商",
                trigger: { career_level: 3, text_desc: "成为掌柜, 本金>5000, 信誉>50", condition: (gs) => (gs.career.core_resources.ben_jin || gs.finances.wealth) > 5000 && (gs.career.core_resources.xin_yu || 0) > 50 },
                desc: "你站在码头上，身后是满载货物的骡马队。江南的富庶在召唤你，但前路漫漫，充满了未知的风险。这是你从“坐商”到“行商”的第一次蜕变。",
                success: { text: "你成功完成首次行商，利润丰厚！最重要的是，你打通了关系，正式解锁了【商路】系统！获得第一条[商路]：京城-江南。", effects: { wealth: 3000, flag: 'unlock_trade_routes', core_resources: { shang_lu: 1 } } },
                failure: { text: "货物损失惨重，本金大亏，你几乎破产。", effects: { wealth: -4000 } }
            }
        },
        {
            title: "第二幕：中流砥柱",
            level_range: [5, 7],
            goal: "扩大商业版图，通过信息和资本优势击败竞争对手，开始将商业影响力转化为社会地位。",
            events: [
                {
                    title: "对手的恶意竞争",
                    desc: "你的宿敌【四海商行】在你的店铺对面开了一家分店，并以低于你成本价的价格倾销同类商品！",
                    options: [
                        { text: "【跟进价格战，血拼到底】", cost: { wealth: 10000 }, getOutcome: (gs) => {
                            // 假设四海商行财力为15000
                            if (gs.finances.wealth > 15000) {
                                return { text: "你的财力更胜一筹，【四海商行】资金断裂，宣告破产！你大获全胜。", effects: { wealth: 5000, attributes: { reputation: 20 } } };
                            }
                            return { text: "价格战耗尽了你的资金，你被迫宣告破产...", effects: { end_game: 'bankruptcy' } };
                        }},
                        { text: "【推出独家新品】", requirements: { has_item_type: '材料' }, effects: { attributes: { reputation: 30 } }, result_text: "你用“人无我有”的商品吸引了所有高端客户，【四海商行】的低价策略无人问津。你大获全胜！" },
                        { text: "【釜底抽薪，买断其供货源】", cost: { wealth: 8000 }, effects: {}, result_text: "你成功买断了他们的货源，【四海商行】无货可卖，不战自败。你成功地整合了产业链。" }
                    ]
                },
                {
                    title: "商路遇险",
                    desc: "你最重要的[京城-江南]商路，因沿途爆发匪乱而中断。",
                    options: [
                         { text: "【花费重金，请求官府剿匪】", cost: { wealth: 5000 }, effects: { social_favor: { group: 'government', change: 10 } }, result_text: "数月后商路恢复，你付出了巨大的金钱成本，但获得了官府人脉。" },
                         { text: "【与匪首谈判，交买路钱】", cost: { wealth: 2000 }, effects: { attributes: { virtue: -10 } }, result_text: "你用钱换取了暂时的和平，商路恢复。但匪首未来会不断勒索。" },
                         { text: "【亲自招募护卫，打通商路】", cost: { wealth: 6000 }, effects: { core_resources: { wei_wang: 20 }, flag: 'unlock_private_escort' }, result_text: "你建立了自己的私人武装，不仅打通了商路，还获得了周边商户的尊敬，解锁了“私人镖局”业务。" }
                    ]
                },
                {
                    title: "与西域商人的交易",
                    desc: "一位满脸风霜的西域商人，带来一批闻所未闻的货物，比如“琉璃”和“香料”。",
                    options: [
                        { text: "【视其为骗子，赶走】", effects: {}, result_text: "你将他赶走，无事发生。" },
                        { text: "【谨慎地交易少量货物】", cost: { wealth: 500 }, effects: { wealth: 800 }, result_text: "这批货物在京城大受欢迎，你赚了一笔，并与西域商人建立了初步联系。" },
                        { text: "【招待该商人，探听西域情报】", requirements: { charm: 100 }, cost: { wealth: 200 }, effects: { item: { id: 'si_chou_zhi_lu_can_pian', amount: 1 } }, result_text: "你不仅获得了独家货源，还从他口中得知了[丝绸之路地图残片]，开启了通往西域的史诗任务线。" }
                    ]
                },
                {
                    title: "投资新的发明",
                    desc: "一位落魄的工匠向你展示了他改良的“新式纺车”，声称能让织布效率提升三倍，希望获得你的投资。",
                    options: [
                        { text: "【认为不切实际，拒绝投资】", effects: { flag: 'missed_spinning_jenny' }, result_text: "你拒绝了他。数年后，你的对手【四海商行】凭借此技术将你彻底击败。" },
                        { text: "【投资少量资金】", cost: { wealth: 1000 }, effects: { flag: 'partial_spinning_jenny' }, result_text: "你获得了新纺车的部分使用权，你的丝绸生意成本降低。" },
                        { text: "【买断发明，并为其建立工坊】", cost: { wealth: 10000 }, effects: { flag: 'monopolize_spinning_jenny' }, result_text: "你垄断了这项技术，你的丝绸成本降至全行业最低！你获得了持续的巨大竞争优势。" }
                    ]
                },
                {
                    title: "官府的“劝捐”",
                    desc: "户部以“修缮宫殿”为由，向京城各大商号“劝捐”，指标是5万两。",
                    options: [
                         { text: "【足额捐赠】", cost: { wealth: 50000 }, effects: { item: { id: 'yu_ci_le_shan_hao_shi', amount: 1 }, attributes: { reputation: 20 } }, result_text: "你慷慨解囊，获得[御赐“乐善好施”牌匾]，声望大增。" },
                         { text: "【哭穷，只捐1万两】", cost: { wealth: 10000 }, getOutcome: (gs) => {
                             if(gs.player.attributes.charm > 90){
                                 return { text: "你声泪俱下地哭诉生意艰难，户部官员竟也信了，成功过关。", effects: {} };
                             }
                             return { text: "你的哭穷被视为不敬，户部将在未来一年对你的商行进行“税务稽查”，导致你持续亏损。", effects: { flag: 'tax_audit_debuff' } };
                         }}
                    ]
                },
                {
                    title: "合股生意",
                    desc: "另一位与你实力相当的商人，提议与你合股做一笔跨国的大生意。",
                    options: [
                        { text: "【同意合作】", effects: { flag: 'joint_venture' }, result_text: "你们的合作将带来巨大的利润，但也可能因利益分配不均而产生矛盾。" },
                        { text: "【趁机吞并对方】", requirements: { wisdom: 120 }, effects: { wealth: 10000 }, result_text: "你利用谈判的机会，摸清了对方的底细，并成功将其吞并，你的商业版图大大扩张。" },
                        { text: "【拒绝合作】", effects: {}, result_text: "你认为独占利润更好，拒绝了对方。" }
                    ]
                },
                {
                    title: "家族子弟的请求",
                    desc: "你的一位不成器的家族子弟，请求你让他在你的商行里当一个管事。",
                    options: [
                        { text: "【同意】", effects: { core_resources: { xin_yu: -10 }, npc_relationship: { npc_key: 'family_elder', favor: 10 } }, result_text: "你获得了家族长辈的好感，但这位子弟可能会搞砸你的生意。" },
                        { text: "【拒绝】", effects: { npc_relationship: { npc_key: 'family_elder', favor: -10 } }, result_text: "你得罪了家族的长辈。" }
                    ]
                },
                {
                    title: "培养接班人",
                    desc: "你的长子对经商表现出浓厚的兴趣。",
                    options: [
                        { text: "【亲自教导】", effects: { npc_relationship: { npc_key: 'son', favor: 20 }, attributes: { wisdom: 2 } }, result_text: "你将毕生所学倾囊相授，父子关系更加亲密。" },
                        { text: "【让他从学徒做起】", effects: { npc_relationship: { npc_key: 'son', favor: -5 } }, result_text: "一个磨练他心性的决定，但他可能觉得你对他不够关爱。" }
                    ]
                },
                {
                    title: "开设票号",
                    desc: "随着生意越做越大，你觉得需要开设自己的票号（古代银行）来方便资金流转。",
                    options: [
                        { text: "【投入巨资开设】", cost: { wealth: 50000 }, effects: { flag: 'bank_opened' }, result_text: "你开启了金融业务，这是一个全新的利润增长点，但也伴随着巨大的风险。" },
                        { text: "【时机未到】", effects: {}, result_text: "你选择了谨慎。" }
                    ]
                },
                {
                    title: "购买官爵",
                    desc: "朝廷为了筹款，开始卖官鬻爵。你可以捐一个“员外郎”的虚衔。",
                    options: [
                        { text: "【捐钱买官】", cost: { wealth: 30000 }, effects: { attributes: { reputation: 20 }, flag: 'official_rank' }, result_text: "你获得了官身，社会地位大大提升，与官府打交道也更方便了。" },
                        { text: "【认为不值】", effects: {}, result_text: "你觉得这是个亏本买卖。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：两淮盐引",
                trigger: { career_level: 6, text_desc: "成为总行东家, 本金>10万, 信誉>300", condition: (gs) => (gs.career.core_resources.ben_jin || gs.finances.wealth) > 100000 && (gs.career.core_resources.xin_yu || 0) > 300 },
                desc: "你坐在一间被重兵把守的巨大厅堂内，与全国最富有的商人们竞夺未来五年“两淮地区”的食盐独家经营权。",
                success: { text: "你成功获得了[两淮盐引（五年）]！这是全游戏最赚钱的资产之一，将在五年内为你带来海啸般的财富。你的社会地位发生质变！", effects: { item: { id: 'liang_huai_yan_yin', amount: 1 }, attributes: { reputation: 100 } } },
                failure: { text: "竞标失败，你投入的保证金被没收。", effects: { wealth: -10000 } }
            }
        },
        {
            title: "第三幕：登峰造极",
            level_range: [8, 10],
            goal: "你的财富已成为一种力量。你需要用这种力量去改变规则、投资未来，并为你的商业帝国寻找一位合格的继承人。",
            events: [
                {
                    title: "建立私人票号",
                    desc: "你的生意遍布全国，资金流转成了大问题。你决定建立自己的金融网络。",
                    options: [
                        { text: "【投入巨资，建立[自家姓氏]票号】", cost: { wealth: 100000 }, effects: { flag: 'unlock_banking_system' }, result_text: "你开启了全新的金融玩法。你可以放贷给其他NPC、进行汇兑业务，但也承担了“坏账”的风险。" },
                        { text: "【与[晋阳票号]深度合作】", cost: { wealth: 50000 }, effects: { flag: 'jinyang_partnership' }, result_text: "你成为【晋阳票号】的最大股东，安全稳定，但利润需要分成。" }
                    ]
                },
                {
                    title: "资助夺嫡皇子",
                    desc: "一位失势的皇子秘密与你接触，希望获得你的资金支持，并许诺成功后让你成为“国商”。",
                    options: [
                        { text: "【这是一场豪赌，我投了！】", cost: { wealth: 50000 }, effects: { flag: 'support_prince_rebellion' }, result_text: "你与该皇子深度绑定。他若成功，你的家族将迎来百年富贵；他若失败，你将被满门抄斩。" },
                        { text: "【风险太大，婉言拒绝】", effects: { npc_relationship: { npc_key: 'rebel_prince', favor: -30 } }, result_text: "你保持了中立和安全，但也得罪了这位皇子。" }
                    ]
                },
                {
                    title: "遭遇海外巨舶海盗",
                    desc: "你的远洋贸易船队，在海外遭遇了装备精良、数量庞大的海盗舰队。",
                    options: [
                        { text: "【授权船长，不惜一切代价作战】", getOutcome: (gs) => {
                            if (Math.random() < 0.3) {
                                return { text: "一场惨胜！你缴获了[海盗的藏宝图]！", effects: { wealth: -20000, item: { id: 'hai_dao_cang_bao_tu', amount: 1 } } };
                            }
                            return { text: "你的船队全军覆没...", effects: { wealth: -50000, flag: 'trade_route_destroyed' } };
                        }},
                        { text: "【缴纳赎金】", cost: { wealth: 30000 }, effects: {}, result_text: "你损失了巨额本金，但保住了船队和商路。" }
                    ]
                },
                {
                    title: "组织慈善，名留青史",
                    desc: "国内发生大饥荒，你决定挺身而出。",
                    options: [
                        { text: "【开设粥棚，救济灾民】", cost: { wealth: 50000 }, effects: { attributes: { reputation: 100, virtue: 50 } }, result_text: "你的声望和品德达到顶峰，被百姓誉为“大善人”。" },
                        { text: "【以工代赈，兴修水利】", cost: { wealth: 80000 }, effects: { attributes: { reputation: 80, virtue: 40, wisdom: 10 } }, result_text: "不仅救了灾，还为自己未来的生意疏通了河道，一举两得。" }
                    ]
                },
                {
                    title: "家族内斗，争夺家产",
                    desc: "你的几位亲族/子嗣，为了争夺你庞大产业的继承权，在暗中互相攻击。",
                    options: [
                         { text: "【铁腕手段，罢黜所有不忠者】", effects: {}, result_text: "你巩固了自己的权威，但家族关系破裂。" },
                         { text: "【设立[家族信托]，明确分配规则】", requirements: { wisdom: 150 }, effects: { flag: 'family_trust_established' }, result_text: "你用现代商业的智慧解决了继承问题，确保了家族的长盛不衰。" },
                         { text: "【选择一位最优秀的继承人】", effects: { flag: 'start_heir_training' }, result_text: "你将开启“继承人培养”模式，你的部分操作将由你和你的继承人共同完成。" }
                    ]
                },
                {
                    title: "来自同行的拜访",
                    desc: "另一位巨商前来拜访，希望与你联手，垄断全国的丝绸市场。",
                    options: [
                        { text: "【同意联手】", effects: { flag: 'silk_monopoly' }, result_text: "你们成功垄断了市场，获得了巨大的利润，但也引起了官府的警惕。" },
                        { text: "【拒绝并向官府举报】", effects: { attributes: { virtue: 10 }, npc_relationship: { npc_key: 'government', favor: 20 } }, result_text: "你获得了官府的赏识，但与整个商界为敌。" }
                    ]
                },
                {
                    title: "资助科学研究",
                    desc: "一位西洋传教士向你展示了蒸汽机的模型，希望能获得你的资助进行研究。",
                    options: [
                        { text: "【进行投资】", cost: { wealth: 100000 }, effects: { flag: 'industrial_revolution_seed' }, result_text: "这是一项看不清未来的长远投资，但如果成功，你将改变整个世界。" },
                        { text: "【认为这是奇技淫巧】", effects: {}, result_text: "你错过了开启一个新时代的机会。" }
                    ]
                },
                {
                    title: "皇帝的借款",
                    desc: "皇帝因国库空虚，私下向你“借”一笔巨款用于修建皇家园林。",
                    options: [
                        { text: "【慷慨解囊】", cost: { wealth: 200000 }, effects: { npc_relationship: { npc_key: 'emperor', favor: 50 } }, result_text: "皇帝对你非常满意，你成为了皇帝的“钱袋子”，权势滔天。" },
                        { text: "【哭穷婉拒】", effects: { npc_relationship: { npc_key: 'emperor', favor: -30 } }, result_text: "皇帝对你非常不满，你的生意未来可能会受到打压。" }
                    ]
                },
                {
                    title: "影响国策",
                    desc: "你如今有足够的影响力，可以向朝廷提议某项对你有利的政策。",
                    options: [
                        { text: "【提议降低商税】", effects: { flag: 'tax_reform' }, result_text: "你的提议将在朝堂上引起巨大争议。" },
                        { text: "【提议重开丝绸之路】", effects: { flag: 'reopen_silk_road' }, result_text: "这将为你带来巨大的商机，但也伴随着巨大的风险。" }
                    ]
                },
                {
                    title: "富可敌国的烦恼",
                    desc: "你的财富已经多到无法计算，你开始思考金钱的意义。",
                    options: [
                        { text: "【建立慈善基金】", cost: { wealth: 500000 }, effects: { attributes: { virtue: 100 } }, result_text: "你将财富用于回馈社会，获得了万民敬仰。" },
                        { text: "【追求长生不老】", cost: { wealth: 500000 }, effects: { attributes: { health: 10 } }, result_text: "你用金钱换来了各种珍稀药材，健康获得提升，但长生终究是虚妄。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：开海禁之议",
                trigger: { career_level: 7, text_desc: "成为皇商, 财富/信誉/声望达到顶峰", condition: (gs) => (gs.finances.wealth > 1000000 && (gs.career.core_resources.xin_yu || 0) > 800 && gs.player.attributes.reputation > 500) },
                desc: "你作为“天下第一富商”被请入皇宫的议政殿。你面对的是整个帝国的文武百官，你的每一句话，都可能开启一个全新的大航海时代。",
                success: { text: "皇帝被你说服，下旨“开关通商”！你被册封为史无前例的“红顶商人”，官居一品，总领天下市舶司。你的人生，已是传奇。", effects: { item: { id: 'hong_ding_shang_ren_guan_mao', amount: 1 }, flag: 'unlock_global_trade', end_game_title: '红顶商人' } },
                failure: { text: "你的提议被视为“蛊惑君心，唯利是图”，你的所有海外资产被查抄，你被禁止再进行远洋贸易。", effects: { wealth: -100000, flag: 'banned_from_sea_trade' } }
            }
        }
    ]
},
'scholar': {
    name: "文人墨客",
    icon: "fa-paint-brush",
    gender: "male",
    core_resources: ["ling_gan", "reputation", "xin_jing"],
    dashboard_name: "我的书斋",
    acts: [
        {
            title: "第一幕：声名未显",
            level_range: [1, 4],
            goal: "解决生计问题，磨练基础技艺，创作出第一部能让自己在本地文人圈中获得认可的作品。",
            events: [
                {
                    title: "为人代笔",
                    desc: "一位附庸风雅的富家子弟，私下请你为他代笔一首诗，用于在诗会上博取名声。",
                    options: [
                        { text: "【慨然应允，尽展才华】", cost: { core_resources: { ling_gan: 20 } }, effects: { wealth: 500, attributes: { reputation: -5 }, core_resources: { xin_jing: '悲郁' } }, result_text: "你写出一首上佳之作，获得500两。此事若传出有损你的风骨，心境变为“悲郁”。" },
                        { text: "【敷衍了事，略作应付】", cost: { core_resources: { ling_gan: 5 } }, effects: { wealth: 100 }, result_text: "你交出一首平庸之作，获得100两。该子弟虽不满意，但也无法指责你。" },
                        { text: "【严词拒绝，持守风骨】", effects: { attributes: { virtue: 5 }, core_resources: { xin_jing: '激昂' } }, result_text: "你保住了文人的气节，心境变为“激昂”，但也得罪了这位富家子弟。" }
                    ]
                },
                {
                    title: "知音难觅",
                    desc: "你携新作拜访一位略有名气的前辈，希望得到点评。",
                    options: [
                        { text: "【虚心请教其画作之道】", effects: { npc_relationship: { npc_key: 'senior_artist', favor: 15 }, attributes: { talent: 2 } }, result_text: "你的谦逊赢得了对方的好感，他指点了你几处关键的笔法。" },
                        { text: "【意气风发，与其辩论艺术见解】", getOutcome: (gs) => {
                            if (gs.player.attributes.talent > 60) {
                                return { text: "你的独到见解令对方刮目相看，你们的关系变为“亦敌亦友”。", effects: { attributes: { reputation: 10 } } };
                            }
                            return { text: "对方认为你狂妄自大，不欢而散。", effects: { npc_relationship: { npc_key: 'senior_artist', favor: -20 } } };
                        }}
                    ]
                },
                {
                    title: "典当家产",
                    desc: "为了购买一套名贵的[文房四宝]以提升创作质量，你的钱不够了。",
                    options: [
                        { text: "【典当[传家玉佩]】", requirements: { has_item: 'chuan_jia_yu_pei' }, cost: { item: 'chuan_jia_yu_pei' }, effects: { wealth: 1000, item: { id: 'hu_zhou_bi_hui_zhou_mo', amount: 1 }, attributes: { virtue: -5 }, core_resources: { xin_jing: '悲郁' } }, result_text: "你获得1000两，成功购得[湖州笔、徽州墨]。但变卖祖产让你内心不安。" },
                        { text: "【售卖自己不够满意的几幅旧作】", effects: { wealth: 300 }, result_text: "你获得300两。虽然杯水车薪，但你保住了最重要的东西。" }
                    ]
                },
                {
                    title: "参加小型文会",
                    desc: "城中举办了一场普通的文人聚会，鱼龙混杂。",
                    options: [
                        { text: "【寻找机会，朗诵新作】", getOutcome: (gs) => {
                            if (gs.player.attributes.charm > 50) {
                                return { text: "你的作品获得了一些赞誉。", effects: { attributes: { reputation: 5 }, core_resources: { ling_gan: 10 } } };
                            }
                            return { text: "无人理会你的作品，场面十分尴尬。", effects: { attributes: { charm: -1 } } };
                        }},
                        { text: "【结交新友，拓展人脉】", effects: { social: 'expand' }, result_text: "你成功结识了一位落魄但有才的画师和一位家境殷实的秀才。" }
                    ]
                },
                {
                    title: "与画舫歌妓对诗",
                    desc: "秦淮河上的画舫中，当红歌妓弹唱一曲后，邀请客人对诗助兴。",
                    options: [
                        { text: "【上前应对】", getOutcome: (gs) => {
                            if (gs.player.attributes.talent > 65) {
                                return { text: "你即兴创作的诗句与乐曲完美契合，技惊四座。该歌妓对你青眼有加，成为你的红颜知己。", effects: { attributes: { reputation: 10, charm: 3 }, npc_relationship: { npc_key: 'courtesan_poet', favor: 30, type: 'confidante' } } };
                            }
                            return { text: "你的诗作平平，贻笑大方。", effects: { attributes: { reputation: -5 } } };
                        }}
                    ]
                },
                {
                    title: "书画摊的机遇",
                    desc: "你为了生计，在街边摆摊售卖自己的书画。",
                    options: [
                        { text: "【坚持风格，等待知音】", getOutcome: (gs) => {
                            if (Math.random() < 0.2) {
                                return { text: "一位微服私访的王爷买走了你的一幅画，并对你大加赞赏！", effects: { wealth: 1000, attributes: { reputation: 15 }, npc_relationship: { npc_key: 'prince_patron', favor: 30 } } };
                            }
                            return { text: "一整天无人问津，你对自己的才能产生了怀疑。", effects: { core_resources: { xin_jing: '悲郁' } } };
                        }},
                        { text: "【画一些迎合市场的作品】", effects: { wealth: 200 }, result_text: "你画的“福禄寿”图很受欢迎，赚了些钱，但感觉失去了艺术追求。" }
                    ]
                },
                {
                    title: "灵感来源",
                    desc: "你感到灵感枯竭，无法创作。",
                    options: [
                        { text: "【游历名山大川】", cost: { wealth: 300 }, effects: { core_resources: { ling_gan: 50 }, attributes: { health: 5 } }, result_text: "壮丽的自然风光激发了你的创作灵感。" },
                        { text: "【在市井中观察生活】", effects: { core_resources: { ling_gan: 30 }, attributes: { wisdom: 2 } }, result_text: "市井百态让你对人生有了新的感悟。" }
                    ]
                },
                {
                    title: "藏书楼的偶遇",
                    desc: "你在藏书楼查阅资料时，与一位同样在此读书的姑娘因一本古籍相识。",
                    options: [
                        { text: "【与她探讨学问】", requirements: { talent: 50 }, effects: { npc_relationship: { npc_key: 'scholar_lady', favor: 20, type: 'friend' } }, result_text: "你们相谈甚欢，互相引为知己。" },
                        { text: "【默默谦让】", effects: { attributes: { virtue: 3 } }, result_text: "你的风度给对方留下了不错的印象。" }
                    ]
                },
                {
                    title: "笔墨的选择",
                    desc: "工欲善其事，必先利其器。你需要一套好的笔墨纸砚。",
                    options: [
                        { text: "【花费重金购买】", cost: { wealth: 800 }, effects: { item: { id: 'hu_zhou_bi_hui_zhou_mo', amount: 1 } }, result_text: "你购得一套[湖州笔、徽州墨]，创作效率提升。" },
                        { text: "【自己动手制作】", requirements: { wisdom: 50 }, effects: { attributes: { talent: 2 } }, result_text: "虽然粗糙，但你从中领悟到了制笔的诀窍。" }
                    ]
                },
                {
                    title: "醉酒后的创作",
                    desc: "你在一次大醉后，挥毫泼墨，醒来后发现了一幅自己都不认识的作品。",
                    options: [
                        { text: "【将其展示给朋友】", getOutcome: (gs) => {
                            if (gs.player.attributes.talent > 70) {
                                return { text: "此作竟是你平生未有之佳作！朋友们惊为天人！", effects: { core_resources: { ling_gan: 30, reputation: 10 } } };
                            }
                            return { text: "朋友们表示看不懂你画的/写的是什么。", effects: {} };
                        }},
                        { text: "【认为不成体统，将其烧毁】", effects: {}, result_text: "你销毁了这幅作品。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：金陵诗会",
                trigger: { career_level: 3, text_desc: "成为知名书生, 才情>80, 声望>50", condition: (gs) => gs.player.attributes.talent > 80 && gs.player.attributes.reputation > 50 },
                desc: "金陵夫子庙前，人山人海，彩旗飘扬。江南所有的大儒、名士、才子佳人齐聚一堂。这是你鲤鱼跃龙门的第一道关卡。",
                success: { text: "你在此次诗会中夺得魁首，被誉为“金陵才子”！声望暴涨，并被一位大儒收为入室弟子，正式进入京城核心文化圈。", effects: { career_level_set: 4, attributes: { reputation: 100, talent: 10 }, item: { id: 'wen_cai_feng_liu_pai_bian', amount: 1 } } },
                failure: { text: "默默无闻，你的作品被淹没在人海中，灵感耗尽，心境变为“悲郁”，持续数月。", effects: { core_resources: { ling_gan: -50, xin_jing: '悲郁' } } }
            }
        },
        {
            title: "第二幕：名动京华",
            level_range: [5, 7],
            goal: "确立自己独一无二的艺术风格，结交更高层次的权贵与名士，并创作出第一部真正意义上的重要作品。",
            events: [
                {
                    title: "权贵的邀约",
                    desc: "吏部侍郎请你为其花园作一幅画，并暗示酬劳丰厚。",
                    options: [
                        { text: "【按其要求，画一幅富贵牡丹图】", effects: { wealth: 2000, npc_relationship: { npc_key: 'shi_lang', favor: 20 }, attributes: { reputation: -5 } }, result_text: "侍郎非常满意，但圈内人认为你的画“匠气有余，灵气不足”。" },
                        { text: "【坚持本心，画一幅雨后芭蕉图】", effects: { wealth: 500, npc_relationship: { npc_key: 'shi_lang', favor: 5 }, attributes: { reputation: 15 } }, result_text: "侍郎虽不悦，但被你的艺术风骨折服。你的画在名士圈中大受好评。" }
                    ]
                },
                {
                    title: "与名家辩艺",
                    desc: "在一次雅集中，你与一位成名已久的书法家在“笔法”上产生了分歧。",
                    options: [
                        { text: "【锋芒毕露，与其公开辩论】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 100 && gs.player.attributes.talent > 100) {
                                return { text: "你的理论更胜一筹，声望大增，但也彻底得罪了这位名家。", effects: { attributes: { reputation: 20 }, npc_relationship: { npc_key: 'master_calligrapher', favor: -40 } } };
                            }
                            return { text: "你被驳得体无完肤，沦为笑柄。", effects: { attributes: { reputation: -10 } } };
                        }},
                        { text: "【私下交流，点到为止】", effects: { attributes: { talent: 2, wisdom: 2 }, npc_relationship: { npc_key: 'master_calligrapher', favor: 10 } }, result_text: "你们互相交流，各有收获。" }
                    ]
                },
                {
                    title: "开设私塾授课",
                    desc: "你的名气吸引了一些年轻人前来拜师。",
                    options: [
                        { text: "【束脩百两，倾囊相授】", effects: { wealth: 100, flag: 'start_private_school' }, result_text: "你获得稳定的银两收入。你教导的学生中，有几率出现“天才”，未来会为你带来巨大的声望回报。" },
                        { text: "【分文不取，只教有缘人】", effects: { attributes: { virtue: 10, reputation: 10 }, flag: 'start_free_school' }, result_text: "你的高洁之名远扬，你的学生对你绝对忠诚。" }
                    ]
                },
                {
                    title: "遭遇“文贼”",
                    desc: "你发现你未发表的一首诗，被一个无耻文人剽窃，并凭此诗获得了赞誉。",
                    options: [
                        { text: "【拿出[手稿]，当众揭发】", requirements: { has_item: 'poem_manuscript' }, effects: { attributes: { reputation: 15 } }, result_text: "你成功揭露了对方，声望提升，但也陷入了无休止的骂战。" },
                        { text: "【私下警告，令其致歉】", effects: { wealth: 1000 }, result_text: "对方私下赔偿你1000两，并承诺不再犯。" },
                        { text: "【一笑置之，再作一首更好的】", requirements: { xin_jing: '恬淡', talent: 120 }, effects: { attributes: { reputation: 20 } }, result_text: "你的气度被传为佳话，并消耗灵感立即创作出一首品质更高的作品。" }
                    ]
                },
                {
                    title: "受邀品鉴古玩",
                    desc: "一位大收藏家请你帮忙鉴定一件新得的古董。",
                    options: [
                        { text: "【凭借学识进行鉴定】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 110) {
                                return { text: "你准确地鉴定出此乃真品，令收藏家大为赞赏。", effects: { npc_relationship: { npc_key: 'collector', favor: 20 }, item: { id: 'gu_ji_shan_ben', amount: 1 } } };
                            }
                            return { text: "你判断失误，颜面尽失。", effects: { attributes: { reputation: -10 } } };
                        }},
                        { text: "【使用[鉴定秘籍]】", requirements: { has_item: 'jian_ding_mi_ji' }, effects: { npc_relationship: { npc_key: 'collector', favor: 40 } }, result_text: "你100%鉴定成功，并能说出其背后不为人知的典故，令收藏家大为惊叹。" }
                    ]
                },
                {
                    title: "风格的瓶颈",
                    desc: "你的创作风格广为人知，但也开始被人批评“一成不变”。",
                    options: [
                        { text: "【闭关寻求突破】", effects: { flag: 'seclusion_for_art' }, result_text: "你决定闭关一年，寻求艺术上的突破。成功则风格大成，失败则可能走火入魔。" },
                        { text: "【与其他艺术家交流】", effects: { core_resources: { ling_gan: 20 }, attributes: { talent: 5 } }, result_text: "与不同流派的艺术家交流让你获得了新的灵感。" }
                    ]
                },
                {
                    title: "成为皇子之师",
                    desc: "一位皇子听闻你的才名，希望拜你为师，学习书画。",
                    options: [
                        { text: "【接受】", effects: { npc_relationship: { npc_key: 'prince_student', favor: 50 }, political_event: { type: 'align', faction: 'prince_student' } }, result_text: "你成为了皇子之师，从此与皇家扯上关系，这是一份荣耀，也是一份危险。" },
                        { text: "【婉拒】", effects: {}, result_text: "你以“闲云野鹤”为由婉拒了，保持了自由身。" }
                    ]
                },
                {
                    title: "作品被禁",
                    desc: "你的一部作品因针砭时弊，被官府列为禁书。",
                    options: [
                        { text: "【上书申辩】", getOutcome: (gs) => {
                            if (gs.player.attributes.virtue > 100) {
                                return { text: "你的申辩引起了清流官员的共鸣，禁令最终被解除。", effects: { attributes: { reputation: 20 } } };
                            }
                            return { text: "你的申辩被驳回，并被官府警告。", effects: {} };
                        }},
                        { text: "【让作品在地下流传】", effects: { attributes: { reputation: 30, virtue: -5 } }, result_text: "你的作品在民间获得了更大的声望，但也让你成为了朝廷的眼中钉。" }
                    ]
                },
                {
                    title: "修复古画",
                    desc: "一幅价值连城的前朝古画受损，无人能修。你决定尝试一下。",
                    options: [
                        { text: "【耗费心力进行修复】", requirements: { talent: 130, wisdom: 110 }, getOutcome: (gs) => {
                            if (Math.random() < 0.8) {
                                return { text: "你成功修复了古画，技艺震动京城！", effects: { attributes: { reputation: 50, talent: 10 } } };
                            }
                            return { text: "修复失败，古画彻底损毁，你将面临巨额赔偿。", effects: { wealth: -10000 } };
                        }}
                    ]
                },
                {
                    title: "红颜知己的请求",
                    desc: "你的红颜知己（如画舫歌妓）陷入困境，向你求助。",
                    options: [
                        { text: "【为她赎身】", cost: { wealth: 5000 }, effects: { npc_relationship: { npc_key: 'confidante', favor: 100 } }, result_text: "你为她赎身，她对你死心塌地，你们的关系更进一步。" },
                        { text: "【为她写一首词】", requirements: { talent: 120 }, effects: { npc_relationship: { npc_key: 'confidante', favor: 30 } }, result_text: "你为她写的词传遍京城，令她身价倍增，暂时摆脱了困境。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：呕心沥血",
                trigger: { career_level: 6, text_desc: "名动京华, 灵感>500, 才情>150", condition: (gs) => (gs.career.core_resources.ling_gan || 0) > 500 && gs.player.attributes.talent > 150 },
                desc: "你决定将毕生所学倾注于一部作品之上。你关闭书斋，谢绝所有访客。日复一日，你废寝忘食，与笔墨为伴，与孤独为伍。",
                success: { text: "你创作出了一部[传世之作]！它为你提供了巨额的持续声望加成。你可以选择献给皇帝、高价出售或自己珍藏。你的称号变为“大家”。", effects: { item: { id: 'chuan_shi_zhi_zuo', amount: 1 }, attributes: { reputation: 200 } } },
                failure: { text: "灵感或健康耗尽，创作失败。你心力交瘁，大病一场，健康上限永久-10。", effects: { attributes: { health: -20, health_max: -10 } } }
            }
        },
        {
            title: "第三幕：一代宗师",
            level_range: [8, 10],
            goal: "你的作品已经不朽，现在你要让你的思想和风格传承下去，成为一个时代的文化符号。",
            events: [
                {
                    title: "受皇命编撰典籍",
                    desc: "皇帝下令编撰一部《XX大典》，并任命你为副主编。",
                    options: [
                        { text: "【欣然领命】", effects: { attributes: { reputation: 50 }, flag: 'imperial_editor_duty' }, result_text: "你进入了官方学术体系，声望和政治影响力大增。但你将长期被繁杂的公务缠身，几乎没有时间进行个人创作。" },
                        { text: "【以“潜心艺术”为由婉拒】", effects: { npc_relationship: { npc_key: 'emperor', favor: -10 } }, result_text: "你保持了文人的独立性，但可能触怒皇帝。" }
                    ]
                },
                {
                    title: "评价时政",
                    desc: "朝廷推行一项新政，民间议论纷纷，一份有影响力的报刊向你约稿。",
                    options: [
                        { text: "【撰文支持新政】", effects: { flag: 'support_new_policy' }, result_text: "你获得当权派的赏识。若新政成功，你声望大涨。若失败，你则会一同被批评。" },
                        { text: "【撰文批评新政】", effects: { attributes: { virtue: 15, reputation: 20 }, flag: 'criticize_new_policy' }, result_text: "你成为百姓和清流的代言人，但被当权派视为眼中钉。" }
                    ]
                },
                {
                    title: "开宗立派",
                    desc: "你的艺术风格已经成熟，追随者众多。",
                    options: [
                        { text: "【创立[自家姓氏]流派】", effects: { attributes: { reputation: 100 }, flag: 'school_founded' }, result_text: "你正式开宗立派！你的声望达到顶峰。你的“门生”将遍布天下，在文化界形成一股巨大的势力。" },
                        { text: "【认为为时尚早】", effects: {}, result_text: "你错失了良机，你的几位天才弟子可能会自立门户。" }
                    ]
                },
                {
                    title: "拒绝入仕邀请",
                    desc: "宰相亲自登门，许以“礼部尚书”之位，邀请你入仕。",
                    options: [
                        { text: "【接受邀请，由文转官】", effects: { change_profession: 'civilian', start_level: 8 }, result_text: "你的职业路径发生改变，转为【文官】路线，直接从高级官员开始。" },
                        { text: "【感谢厚爱，但志不在此】", effects: { attributes: { virtue: 30, reputation: 50 } }, result_text: "你的风骨被天下传颂，品德和声望达到顶峰。" }
                    ]
                },
                {
                    title: "寻访故人",
                    desc: "功成名就后，你感到一丝疲惫，想起了年轻时的知己。",
                    options: [
                        { text: "【放下一切，前去寻访】", effects: { core_resources: { xin_jing: '恬淡' }, attributes: { health: 20 } }, result_text: "你与故友在山水间重逢，对酌长谈。你的心境永久变为“恬淡”，健康上限+20，进入半隐退状态。" },
                        { text: "【俗事缠身，无法脱身】", effects: {}, result_text: "你继续留在名利场中，但内心感到一丝失落。" }
                    ]
                },
                {
                    title: "作品的争议",
                    desc: "你的[传世之作]引发了巨大的争议，保守派认为其“惊世骇俗”，改革派则奉为圭臬。",
                    options: [
                        { text: "【与保守派公开辩论】", effects: {}, result_text: "一场席卷整个文化界的“新旧之争”开始了。" },
                        { text: "【保持沉默】", effects: {}, result_text: "你选择让作品自己说话。" }
                    ]
                },
                {
                    title: "皇帝的墨宝",
                    desc: "皇帝邀请你入宫，与你探讨书法，并希望你为他新得的一幅画题跋。",
                    options: [
                        { text: "【欣然题跋】", requirements: { talent: 180 }, effects: { npc_relationship: { npc_key: 'emperor', favor: 20 } }, result_text: "你的书法与古画相得益彰，龙颜大悦。" },
                        { text: "【借机劝谏】", requirements: { virtue: 150 }, effects: { npc_relationship: { npc_key: 'emperor', favor: -10 } }, result_text: "你借题跋的机会劝谏皇帝，皇帝虽不悦，但对你的胆识印象深刻。" }
                    ]
                },
                {
                    title: "弟子的成就",
                    desc: "你最得意的一位弟子，在科举中高中状元。",
                    options: [
                        { text: "【为其设宴庆祝】", effects: { attributes: { reputation: 30 }, core_resources: { men_sheng: 1 } }, result_text: "“名师出高徒”的佳话传遍京城，你的声望大涨，并正式收获一位官场门生。" }
                    ]
                },
                {
                    title: "海外的知音",
                    desc: "一位东瀛来的学者，携带你的作品摹本，前来向你请教。",
                    options: [
                        { text: "【与之交流】", effects: { flag: 'overseas_fame' }, result_text: "你的思想和艺术开始在海外传播，影响力进一步扩大。" }
                    ]
                },
                {
                    title: "最后的画卷",
                    desc: "你感到生命将尽，决定画下最后一幅画。",
                    options: [
                        { text: "【画下故乡的山水】", effects: { core_resources: { xin_jing: '恬淡' } }, result_text: "落叶归根，你的心境归于平静。" },
                        { text: "【画下自己的自画像】", effects: { core_resources: { xin_jing: '激昂' } }, result_text: "你将自己一生的精气神都融入了画中。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：受封“文宗”",
                trigger: { career_level: 9, text_desc: "声望顶峰, 有传世之作, 且有学生高中", condition: (gs) => gs.player.attributes.reputation > 1000 && gs.flags.has_masterpiece && gs.flags.student_is_successful },
                desc: "皇宫太和殿前，举行了史无前例的盛大仪式。皇帝亲自为你赐下“文宗”的封号。你的学生们——如今已是朝廷栋梁或艺坛名家——集体向你跪拜行礼。",
                success: { text: "你达到了文人墨客职业的终点，成为不朽的传奇！解锁特殊能力【举荐】，可以向皇帝推荐人才。你的家族也因此被封为“书香门第”。", effects: { flag: 'unlock_recommendation_ability', end_game_title: '一代文宗' } },
                failure: { text: "", effects: {} } // 达成型，无失败
            }
        }
    ]
},
'ranger': {
    name: "江湖游侠",
    icon: "fa-khanda",
    gender: "male",
    core_resources: ["xia_yi_zhi", "reputation", "nei_li"],
    dashboard_name: "江湖舆图",
    acts: [
        {
            title: "第一幕：初出茅庐",
            level_range: [1, 4],
            goal: "学会江湖的生存法则，完成几次有影响力的事件，结交第一批朋友与敌人，为自己赢得一个行走江湖的初步名号。",
            events: [
                {
                    title: "路见不平",
                    desc: "一伙地痞正在向一个行商索要钱财。",
                    location: ["官道", "乡野"],
                    options: [
                        { text: "【拔刀相助，教训地痞】", effects: { core_resources: { xia_yi_zhi: 10 }, attributes: { reputation: 5 }, wealth: 300 }, result_text: "一场简单的战斗后，你教训了地痞。商人感激你，赠予你300两。" },
                        { text: "【暗中出手，惊走地痞】", requirements: { wisdom: 50 }, effects: { core_resources: { xia_yi_zhi: 5 }, attributes: { wisdom: 2 } }, result_text: "你用石子等技巧，制造混乱吓跑了地痞，兵不血刃。" },
                        { text: "【与地痞讲“道理”】", requirements: { charm: 60 }, effects: { attributes: { charm: 2, reputation: 5 } }, result_text: "你用言语震慑了对方，让他们知难而退。" }
                    ]
                },
                {
                    title: "黑店风波",
                    desc: "你喝了一口茶，感觉头晕目眩，立刻意识到茶里有蒙汗药。",
                    location: ["龙门客栈"],
                    options: [
                        { text: "【将计就计，假装晕倒】", effects: { core_resources: { xia_yi_zhi: 5 }, attributes: { wisdom: 2 }, wealth: 1000, item: { id: 'tong_ji_fan_xing_zong', amount: 1 } }, result_text: "在店家搜刮你财物时，你暴起发难，将之一网打尽。你缴获1000两和一张[通缉犯的行踪]。" },
                        { text: "【运功逼出药物，直接掀桌】", cost: { core_resources: { nei_li: 50 } }, effects: { attributes: { health: -10 } }, result_text: "你陷入了围攻，虽然最终获胜，但也消耗巨大，内力耗尽。" }
                    ]
                },
                {
                    title: "听书人的故事",
                    desc: "茶馆里的说书人正在讲一段关于“前朝大将军宝藏”的评书。",
                    location: ["扬州城", "茶馆"],
                    options: [
                        { text: "【打赏100两，私下询问细节】", cost: { wealth: 100 }, effects: { item: { id: 'cang_bao_tu_can_pian', amount: 1 }, flag: 'treasure_hunt_quest_started' }, result_text: "你获得了[藏宝图残片一]。说书人告诉你，另外的残片可能在“丐帮”和“某个古墓”里。" },
                        { text: "【认为无稽之谈，一笑了之】", effects: {}, result_text: "无事发生，错失了开启史诗任务的机会。" }
                    ]
                },
                {
                    title: "切磋武艺",
                    desc: "当地武馆的馆主听闻你的名声，希望与你切磋。",
                    location: ["城镇武馆"],
                    options: [
                        { text: "【欣然应允】", getOutcome: (gs) => {
                            if (gs.player.attributes.martial > 60) {
                                // 胜利后的子选项
                                return {
                                    sub_decision: {
                                        desc: "你轻松取胜，馆主对你抱拳认输。你打算...",
                                        options: [
                                            { text: "【点到为止】", effects: { npc_relationship: { npc_key: 'gym_master', favor: 20 }, attributes: { martial: 2 } }, result_text: "你的气度赢得了馆主的尊敬。" },
                                            { text: "【将其重创】", effects: { core_resources: { xia_yi_zhi: -15 }, attributes: { reputation: 5 } }, result_text: "你的手段狠辣，令人畏惧，与该武馆结仇。" }
                                        ]
                                    }
                                };
                            }
                            return { text: "你学艺不精，败下阵来。", effects: { attributes: { health: -5 } } };
                        }}
                    ]
                },
                {
                    title: "悬赏榜",
                    desc: "城门口贴着官府和江湖门派的悬赏令。",
                    location: ["任意城镇"],
                    options: [
                        { text: "【接取“剿灭野狼帮”】", effects: { flag: 'start_quest_wolf_gang' }, result_text: "你接下了任务，开启了一段战斗任务。" },
                        { text: "【接取“寻回《兰亭序》”】", effects: { flag: 'start_quest_lanting_scroll' }, result_text: "你接下了任务，开启了一段需要智慧和人脉的侦查任务。" }
                    ]
                },
                {
                    title: "深山奇遇",
                    desc: "你在深山中迷路，无意间发现一个隐秘的山洞。",
                    options: [
                        { text: "【进入山洞探索】", getOutcome: (gs) => {
                            if (Math.random() < 0.3) {
                                return { text: "山洞中竟有前人留下的武功秘籍！你获得了[《基础内功》]。", effects: { item: { id: 'basic_neigong', amount: 1 }, core_resources: { nei_li: 10 } } };
                            } else if (Math.random() < 0.6) {
                                return { text: "你在山洞中发现了一株珍稀的药草。", effects: { item: { id: 'rare_herb', amount: 1 } } };
                            }
                            return { text: "山洞里空无一物。", effects: {} };
                        }}
                    ]
                },
                {
                    title: "结识一位捕快",
                    desc: "你因一次见义勇为，结识了一位官府的捕快。",
                    options: [
                        { text: "【与其结交】", effects: { social: 'expand' }, result_text: "你与官府建立初步联系，未来或许能获得一些帮助。" },
                        { text: "【保持距离】", effects: {}, result_text: "你认为“江湖朝堂，两不相干”。" }
                    ]
                },
                {
                    title: "酒馆里的冲突",
                    desc: "酒馆里，两个江湖门派的弟子因口角将要动手。",
                    options: [
                        { text: "【出面调解】", requirements: { charm: 60 }, effects: { core_resources: { xia_yi_zhi: 5 }, attributes: { reputation: 5 } }, result_text: "你的调解平息了纷争，双方都对你心存感激。" },
                        { text: "【帮助弱势一方】", effects: { core_resources: { xia_yi_zhi: 10 } }, result_text: "你行侠仗义，但得罪了另一个门派。" },
                        { text: "【坐山观虎斗】", effects: {}, result_text: "你选择不介入，冷眼旁观。" }
                    ]
                },
                {
                    title: "伪装与潜行",
                    desc: "为了探听一个山寨的情报，你需要伪装潜入。",
                    options: [
                        { text: "【伪装成伙夫】", requirements: { wisdom: 50 }, getOutcome: (gs) => {
                            if (Math.random() < 0.8) {
                                return { text: "你成功潜入，并探听到了山寨的布防图。", effects: { core_resources: { qing_bao: 10 } } };
                            }
                            return { text: "你的伪装被识破，一番苦战后才得以脱身。", effects: { attributes: { health: -10 } } };
                        }}
                    ]
                },
                {
                    title: "购买兵器",
                    desc: "你需要一把趁手的兵器。",
                    options: [
                        { text: "【在铁匠铺购买】", cost: { wealth: 300 }, effects: { item: { id: 'good_sword', amount: 1 } }, result_text: "你获得了一把不错的钢剑。" },
                        { text: "【寻找传说中的铸剑师】", effects: { flag: 'quest_for_master_smith' }, result_text: "你开启了一条寻找传说铸剑师的任务线。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：血战黑风寨",
                trigger: { career_level: 3, text_desc: "武学>100, 侠义值>50", condition: (gs) => gs.player.attributes.martial > 100 && (gs.career.core_resources.xia_yi_zhi || 0) > 50 },
                desc: "黑风寨盘踞险山，为祸一方。你决定联络本地乡勇，亲自导演一场以弱胜强的经典战役。",
                success: { text: "你成为了方圆百里的英雄！声望暴涨，获得江湖名号“黑风克星”，并从山寨宝库中获得大量银两和[寨主的鬼头刀]！", effects: { career_level_set: 4, attributes: { reputation: 150 }, core_resources: { xia_yi_zhi: 50 }, wealth: 5000, item: { id: 'zhai_zhu_gui_tou_dao', amount: 1 } } },
                failure: { text: "剿匪失败，你重伤而归，联络的乡勇死伤惨重，你在当地的声誉一落千丈。", effects: { attributes: { reputation: -20, health_max: -5 } } }
            }
        },
        {
            title: "第二幕：名动一方",
            level_range: [5, 7],
            goal: "你的名字开始在江湖流传。你需要结交名门正派，挑战成名高手，卷入更深层次的江湖恩怨，并寻找属于自己的神兵或秘籍。",
            events: [
                {
                    title: "门派的邀请",
                    desc: "武当派听闻你的侠名，掌门亲书一封，邀请你上山做客。",
                    options: [
                        { text: "【欣然赴约】", effects: { attributes: { wisdom: 5 }, core_resources: { nei_li: 10 } }, result_text: "你在武当山盘桓数月，与道长们论道谈武，内力上限增加。" },
                        { text: "【赠送厚礼并赴约】", cost: { wealth: 1000 }, effects: { flag: 'wudang_skill_learned' }, result_text: "掌门大悦，甚至允许你进入藏经阁阅读，你有几率学到武当派的一招强力技能。" },
                        { text: "【婉言谢绝】", effects: {}, result_text: "你保持了独行侠的身份，但也错失了与名门正派结交的最好机会。" }
                    ]
                },
                {
                    title: "英雄大会",
                    desc: "丐帮广发英雄帖，于君山召开英雄大会，共商江湖大事。",
                    options: [
                        { text: "【高调参与，竞选职位】", requirements: { reputation: 300 }, getOutcome: (gs) => {
                            if(gs.player.attributes.charm > 100 && (gs.career.core_resources.wei_wang || 0) > 100) {
                                return { text: "你成功当选为“副舵主”，获得调动部分丐帮弟子的能力。", effects: { attributes: { reputation: 50 } } };
                            }
                            return { text: "你不自量力，遭到群雄耻笑。", effects: {} };
                        }},
                        { text: "【广交朋友，打探消息】", effects: { social: 'expand', item: {id: 'qing_bao_si_sheng_huo', amount: 1} }, result_text: "你结识了数位江湖豪杰，人脉图谱极大扩张，并获得一份关于魔教动向的情报。" }
                    ]
                },
                {
                    title: "秘籍的残页",
                    desc: "你从一个濒死的恶贼身上，搜到了一张[《九阳神功》残页]！",
                    options: [
                        { text: "【消息泄露，被众人追杀】", effects: { flag: 'hunted_for_scroll' }, result_text: "在接下来的游历中，你会不断遭到各路高手的追杀，但若能全部击败，武学将飞速成长。" },
                        { text: "【寻找隐秘之地，潜心修炼】", effects: { flag: 'player_in_seclusion_2_years' }, result_text: "你将闭关两年。成功后，内力大增，并学会部分神功。" }
                    ]
                },
                {
                    title: "神兵的线索",
                    desc: "你在探访“铸剑山庄”时，听闻庄主正在为寻访天外陨铁而烦恼。",
                    options: [
                        { text: "【助其寻访陨铁】", effects: { flag: 'start_quest_divine_weapon' }, result_text: "你开启了一条艰难的寻物任务。完成后，庄主会为你锻造一柄独一无二的神兵。" },
                        { text: "【试图盗取山庄的宝剑】", getOutcome: (gs) => {
                            if(gs.player.attributes.wisdom > 100 && gs.player.attributes.health > 80) {
                                return { text: "你成功盗取一把宝剑，但与铸剑山庄结为死敌。", effects: { item: { id: 'fine_sword', amount: 1 } } };
                            }
                            return { text: "你被发现，重伤逃走。", effects: { attributes: { health: -20 } } };
                        }}
                    ]
                },
                {
                    title: "来自朝廷的关注",
                    desc: "你所在地的知府，派人请你去府衙一叙。",
                    options: [
                        { text: "【前往赴宴，探其虚实】", getOutcome: (gs) => ({
                            sub_decision: {
                                desc: "知府对你进行“招安”，许诺给你“都尉”之职。你是否接受？",
                                options: [
                                    { text: "【接受招安】", effects: { change_profession: 'warrior', start_level: 5 }, result_text: "你的人生轨迹改变，成为了一名武将。" },
                                    { text: "【婉言拒绝】", effects: {}, result_text: "你拒绝了知府，与官府关系变得紧张。" }
                                ]
                            }
                        })},
                        { text: "【认为这是陷阱，拒不前往】", effects: { flag: 'government_wanted' }, result_text: "知府认为你藐视朝廷，将你列为“不安定分子”，你在该地区的行动会受到官府的监视和阻挠。" }
                    ]
                },
                {
                    title: "魔教的踪迹",
                    desc: "你发现有魔教中人在附近活动，行踪诡秘。",
                    options: [
                        { text: "【通报正道门派】", effects: { npc_relationship: { npc_key: 'wudang_master', favor: 10 } }, result_text: "你获得了正道门派的感谢。" },
                        { text: "【独自跟踪】", requirements: { wisdom: 100 }, effects: { core_resources: { qing_bao: 20 } }, result_text: "你艺高人胆大，成功探听到了魔教的一个秘密据点。" }
                    ]
                },
                {
                    title: "拯救被劫镖银",
                    desc: "振远镖局的一趟镖被劫，你决定出手相助。",
                    options: [
                        { text: "【追回镖银】", requirements: { martial: 130 }, effects: { wealth: 2000, core_resources: { xia_yi_zhi: 20 }, npc_relationship: { npc_key: 'biao_ju_master', favor: 30 } }, result_text: "你成功追回镖银，获得了丰厚的报酬和振远镖局的友谊。" }
                    ]
                },
                {
                    title: "古墓探险",
                    desc: "你根据[藏宝图残片]的线索，找到了一个前朝将军的陵墓。",
                    options: [
                        { text: "【进入探险】", effects: { flag: 'tomb_raiding' }, result_text: "陵墓中机关重重，但也可能藏有绝世珍宝。" }
                    ]
                },
                {
                    title: "名医的求助",
                    desc: "一位名医需要一味生长在悬崖峭壁上的珍稀药材，希望你能帮忙采摘。",
                    options: [
                        { text: "【慨然相助】", requirements: { health: 120 }, effects: { core_resources: { xia_yi_zhi: 15 }, item: { id: 'rare_medicine', amount: 1 }, npc_relationship: { npc_key: 'famous_doctor', favor: 40 } }, result_text: "你成功采回药材，不仅获得了名医的友谊，还得到了一些保命丹药。" }
                    ]
                },
                {
                    title: "旧友的背叛",
                    desc: "一位你曾经信任的朋友，为了利益出卖了你，将你的行踪泄露给了你的仇家。",
                    options: [
                        { text: "【清理门户】", effects: { core_resources: { xia_yi_zhi: -10 }, attributes: { virtue: -10 } }, result_text: "你杀死了背叛者，但也让你的名声染上了血腥。" },
                        { text: "【与之一刀两断】", effects: {}, result_text: "你选择与他恩断义绝，从此江湖不见。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：泰山之巅",
                trigger: { career_level: 6, text_desc: "名动一方, 声望>500, 有高级武学", condition: (gs) => gs.player.attributes.reputation > 500 && gs.flags.has_advanced_skill },
                desc: "泰山之巅，云海翻涌。你与成名已久的“嵩山剑派掌门”相对而立。山下，无数江湖人士前来观战。这一战，将决定谁才是中原剑术的翘楚。",
                success: { text: "你赢了！正式跻身江湖一流高手的行列，名号变得更加响亮。", effects: { career_level_set: 7, attributes: { reputation: 100 }, core_resources: { xia_yi_zhi: 30 } } },
                failure: { text: "你败了。重伤退隐半年，武学和声望大幅下降。", effects: { attributes: { reputation: -50, martial: -10 } } }
            }
        },
        {
            title: "第三幕：武林神话",
            level_range: [8, 10],
            goal: "你的存在本身就是一段传奇。你要么成为维系武林秩序的泰山北斗，要么成为颠覆一切的绝世枭雄。",
            events: [
                {
                    title: "组建自己的势力",
                    desc: "追随你的江湖豪杰越来越多，你可以选择建立自己的门派。",
                    options: [
                        { text: "【在[黑风寨]旧址，创立[你的姓氏]门】", cost: { wealth: 20000 }, effects: { flag: 'unlock_sect_management' }, result_text: "你开启了“门派经营”玩法，需要管理门派资源、招募弟子、应对其他门派的挑战。" },
                        { text: "【保持现状，继续独行】", effects: {}, result_text: "你保持了自由，但也失去了一股可以依靠的势力。" }
                    ]
                },
                {
                    title: "外族入侵，侠之大者",
                    desc: "外族大举入侵，国家陷入危机，朝廷军队节节败退。",
                    options: [
                        { text: "【振臂一呼，共御外敌】", requirements: { xia_yi_zhi: 500 }, effects: { attributes: { reputation: 200 }, core_resources: { xia_yi_zhi: 100 } }, result_text: "你组织了一支义军，在敌后展开游击，为朝廷争取了宝贵的时间。你被尊为“大侠”。" },
                        { text: "【认为这是朝廷的事，江湖不应插手】", effects: { attributes: { reputation: -50 } }, result_text: "你在江湖中的声望会因“缺乏民族大义”而受损。" }
                    ]
                },
                {
                    title: "武林浩劫的阴谋",
                    desc: "你发现一个神秘的“天理教”正在暗中挑拨各大门派，并试图用毒药控制整个武林。",
                    options: [
                        { text: "【联合各大门派，共同对抗】", effects: { flag: 'start_quest_wulin_holocaust' }, result_text: "你开启了一条史诗任务链，需要穿梭于各大门派之间，化解恩怨，说服他们联手。" },
                        { text: "【单枪匹马，直捣黄龙】", effects: { flag: 'start_quest_solo_holocaust' }, result_text: "你选择了一条极度危险但充满个人英雄主义的路线。" }
                    ]
                },
                {
                    title: "金盆洗手",
                    desc: "厌倦了江湖纷争，你决定退隐。",
                    options: [
                        { text: "【举办金盆洗手大会】", effects: { career_status: 'retired' }, result_text: "在大会上，你的所有朋友和宿敌都会前来。这是你江湖生涯的最终总结。之后，你将进入“隐退”状态。" },
                        { text: "【悄然离去，不告而别】", effects: { career_status: 'vanished' }, result_text: "你消失在江湖中，成为一个真正的传说。" }
                    ]
                },
                {
                    title: "天山寻道",
                    desc: "你听闻天山之巅有“武道之极”，可以让人超凡入圣。",
                    options: [
                        { text: "【放弃一切，前往天山】", effects: { end_game: 'ascended' }, result_text: "这是一场漫长而孤独的旅程。成功后，你的武学和内力将突破凡人极限，解锁“破碎虚空”的传说结局。" }
                    ]
                },
                {
                    title: "争夺武林盟主",
                    desc: "武林大会再次召开，你决定争夺武林盟主之位。",
                    options: [
                        { text: "【以武服人】", requirements: { martial: 200 }, effects: { flag: 'wulin_leader' }, result_text: "你击败了所有挑战者，成为了新的武林盟主。" },
                        { text: "【以德服人】", requirements: { virtue: 180, reputation: 1000 }, effects: { flag: 'wulin_leader' }, result_text: "你的德行和声望让你众望所归，被推举为武林盟主。" }
                    ]
                },
                {
                    title: "朝廷的刺杀",
                    desc: "你的存在让皇帝感到不安，他派出了大内高手前来刺杀你。",
                    options: [
                        { text: "【正面迎战】", getOutcome: (gs) => {
                            if (gs.player.attributes.martial > 220) {
                                return { text: "你击退了所有刺客，从此与朝廷彻底决裂。", effects: { flag: 'court_enemy' } };
                            }
                            return { text: "你死于围攻之下。", effects: { end_game: 'assassinated' } };
                        }}
                    ]
                },
                {
                    title: "传承你的武学",
                    desc: "你决定将自己的武学传承下去。",
                    options: [
                        { text: "【写入秘籍，流传后世】", effects: { item: { id: 'your_martial_arts_book', amount: 1 } }, result_text: "你将自己的武学心得写成书，此书将成为江湖中人人都想得到的宝物。" },
                        { text: "【只传给你的亲传弟子】", effects: { flag: 'heir_training' }, result_text: "你开始悉心教导你的继承人。" }
                    ]
                },
                {
                    title: "海外的挑战者",
                    desc: "一位来自东瀛的剑客，号称“剑圣”，前来挑战中原武林。",
                    options: [
                        { text: "【接受挑战】", effects: { flag: 'duel_with_kensai' }, result_text: "一场赌上两国武术尊严的对决开始了。" }
                    ]
                },
                {
                    title: "归隐山林",
                    desc: "你最终看破红尘，决定归隐山林，不问世事。",
                    options: [
                        { text: "【选择归隐】", effects: { end_game: 'hermit' }, result_text: "你找到一处山清水秀之地，从此与山林为伴，度过余生。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：华山论剑",
                trigger: { career_level: 9, text_desc: "武林神话, 声望顶峰, 击败过3位高手", condition: (gs) => gs.player.attributes.reputation > 1500 && (gs.flags.defeated_masters || 0) >= 3 },
                desc: "华山之巅，雪花纷飞。当世最强的五位武林神话人物（包括你）齐聚于此，为自己、为武道而战的巅峰对决。",
                success: { text: "你击败了所有对手，被公认为“天下第一”，并成为新的“武林盟主”！你获得了决定整个江湖命运的权力，你的名字成为不朽的神话。", effects: { end_game_title: '天下第一', item: {id: 'tian_xia_di_yi_xin_wu', amount: 1} } },
                failure: { text: "技不如人，但能与当世最强者交手亦无憾。你虽败犹荣，仍是江湖中受人敬仰的宗师。", effects: {} }
            }
        }
    ]
},

'matron': {
    name: "主母",
    icon: "fa-chess-queen",
    gender: "female",
    core_resources: ["nei_ku_zi_jin", "jia_zu_sheng_wang", "ren_qing", "dang_jia_quan"],
    dashboard_name: "内务府名册",
    acts: [
        {
            title: "第一幕：深闺新妇",
            level_range: [1, 4],
            goal: "在复杂的夫家站稳脚跟，赢得丈夫的爱与信任，在与婆婆的权力交接中取得上风，并诞下嫡系子嗣以巩固自己的核心地位。",
            events: [
                {
                    title: "晨昏定省",
                    desc: "每日向公婆请安是你身为新妇的必修课。",
                    options: [
                        { text: "【言谈恭敬，举止得体】", getOutcome: (gs) => {
                            if (gs.player.attributes.etiquette > 50 || (gs.player.attributes.etiquette > 30 && Math.random() < 0.7)) {
                                return { text: "婆婆对你的知书达理颇为满意。", effects: { npc_relationship: { npc_key: 'mother_in_law', favor: 5 } } };
                            }
                            return { text: "你在细节上出了差错，被婆婆当众提点，认为你“小家子气”。", effects: { npc_relationship: { npc_key: 'mother_in_law', favor: -5 }, attributes: { etiquette: 1 } } };
                        }},
                        { text: "【亲手制作滋补汤品孝敬】", effects: { npc_relationship: { npc_key: 'mother_in_law', favor: 10 }, attributes: { virtue: 2 } }, result_text: "你的孝心让公婆非常感动。" }
                    ]
                },
                {
                    title: "妾室的请安",
                    desc: "丈夫的一位妾室前来向你请安，言语间似有试探之意。",
                    options: [
                        { text: "【温和安抚，彰显大度】", effects: { core_resources: { jia_zu_sheng_wang: 5 }, npc_relationship: { npc_key: 'concubine_A', favor: 5 } }, result_text: "你展现了正妻的气度，下人们对你颇为敬佩。" },
                        { text: "【敲山震虎，立下规矩】", requirements: { etiquette: 60 }, effects: {}, result_text: "你用滴水不漏的话术确立了主次。该妾室被你的威严震慑，短时间内不敢造次。" },
                        { text: "【赏赐首饰，收买人心】", cost: { wealth: 200 }, effects: { npc_relationship: { npc_key: 'concubine_A', favor: 15 } }, result_text: "妾室对你感激涕零。但此举可能让她气焰更盛。" }
                    ]
                },
                    {
                        title: "初见管事",
                        desc: "府中的张管事倚老卖老，在分配月例时，言语间对你这位新妇颇有轻视。",
                        options: [
                            { text: "【温和敲打】", requirements: { etiquette: 50 }, effects: { attributes: { virtue: 3 }, core_resources: { dang_jia_quan: 2 } }, result_text: "你用滴水不漏的话术点明了主次，张管事不敢再小觑你。" },
                            { text: "【暂且隐忍】", effects: { attributes: { scheming: 2 } }, result_text: "你选择暂避锋芒，心中已暗暗记下此事。" },
                            { text: "【向婆婆求助】", effects: { npc_relationship: { npc_key: 'mother_in_law', favor: 5 } }, result_text: "婆婆为你撑了腰，但也会觉得你无法独当一面。" }
                        ]
                    },
                    {
                        title: "丫鬟的私心",
                        desc: "你发现陪嫁丫鬟中的一人，似乎在暗中与夫家的下人传递关于你娘家的消息。",
                        options: [
                            { text: "【严厉惩处，以儆效尤】", effects: { attributes: { prestige: 5 } }, result_text: "你严惩了该丫鬟，下人们都看到了你的治家手腕。" },
                            { text: "【私下谈话，了解缘由】", requirements: { wisdom: 50 }, effects: { npc_relationship: { npc_key: 'traitor_maid', favor: 20, type: 'ally' } }, result_text: "原来她是为家人所迫。你帮她解决了困难，从此她对你死心塌地，成为你的心腹。" },
                            { text: "【将计就计，传递假消息】", requirements: { scheming: 60 }, effects: { attributes: { scheming: 5 } }, result_text: "你利用她传递了一些无关痛痒的假消息，暂时稳住了局面。" }
                        ]
                    },
                    {
                        title: "夫君的旧物",
                        desc: "你在整理夫君书房时，发现了一只做工精致却略显陈旧的荷包，似乎是女子所赠。",
                        options: [
                            { text: "【不动声色放回原处】", effects: { attributes: { virtue: 5 } }, result_text: "你选择相信夫君，此事并未在你心中留下芥蒂。" },
                            { text: "【旁敲侧击地询问】", requirements: { charm: 60 }, effects: { npc_relationship: { npc_key: 'spouse', favor: 5 } }, result_text: "原来是夫君已故的妹妹所赠，你的关心让他很受用，夫妻感情加深。" },
                            { text: "【心中生疑】", effects: { npc_relationship: { npc_key: 'spouse', favor: -5 } }, result_text: "你心中种下了怀疑的种子，夫妻感情略有裂痕。" }
                        ]
                    },
                    {
                        title: "学习插花",
                        desc: "为了陶冶情操并装点内室，你决定学习插花艺术。",
                        options: [
                            { text: "【请宫里的花匠指点】", cost: { wealth: 300 }, effects: { attributes: { talent: 5, charm: 3 } }, result_text: "你的插花技艺大有长进，夫君回家看到房中清雅的陈设，心情也好了许多。" },
                            { text: "【自行钻研】", effects: { attributes: { talent: 2 } }, result_text: "虽无人指点，但凭你的聪慧，也摸索出了一些门道。" }
                        ]
                    },
                    {
                        title: "亲族的拜访",
                        desc: "夫家一位远房表姑前来拜访，言语间总是在打探你的嫁妆几何。",
                        options: [
                            { text: "【巧妙应对，滴水不漏】", requirements: { etiquette: 60 }, effects: { attributes: { reputation: 5 } }, result_text: "你应对得体，既未透露家底，也未失了礼数，人人都称赞你大气。" },
                            { text: "【如实相告】", effects: { attributes: { virtue: -2 } }, result_text: "你的坦诚让对方满意，但也可能引来不必要的觊觎。" }
                        ]
                    },
// =================== 主母：第一幕新增事件 END ===================
                {
                    title: "学习理账",
                    desc: "婆婆将一本陈年旧账交给你，让你“学习学习”，实则考验你的能力。",
                    options: [
                        { text: "【熬夜核算，找出错漏】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 60) {
                                return { text: "你找出了账目中的几处错漏，让婆婆刮目相看。", effects: { attributes: { wisdom: 2 }, core_resources: { dang_jia_quan: 10 } } };
                            }
                            return { text: "你看得一头雾水，婆婆对你颇为失望。", effects: { core_resources: { dang_jia_quan: -5 } } };
                        }},
                        { text: "【向丈夫求助】", effects: { npc_relationship: { npc_key: 'spouse', favor: 10 } }, result_text: "丈夫帮你解决了问题，夫妻感情升温。但婆婆认为你无法独当一面。" }
                    ]
                },
                {
                    title: "回门之日",
                    desc: "成婚一月，你按例回娘家。",
                    options: [
                        { text: "【向母亲哭诉在夫家的不易】", effects: { wealth: 500, item: { id: 'mu_qin_ti_ji_shou_shi', amount: 1 } }, result_text: "母亲安慰你，并私下赠你一笔私房钱和[母亲的体己首饰]。但此事传到婆家，会认为你“爱告状”。" },
                        { text: "【报喜不报忧，彰显夫家恩宠】", effects: { core_resources: { jia_zu_sheng_wang: 5 }, attributes: { virtue: 3 } }, result_text: "你的言行让娘家人放心，也让夫家有光。" }
                    ]
                },
                {
                    title: "丈夫的晚归",
                    desc: "你的丈夫最近常常深夜才从同僚的宴席上醉醺醺地回来。",
                    options: [
                        { text: "【默默准备醒酒汤，温柔照料】", effects: { npc_relationship: { npc_key: 'spouse', favor: 10 } }, result_text: "你的体贴让丈夫心中一暖，夫妻感情升温。" },
                        { text: "【旁敲侧击，询问宴席详情】", getOutcome: (gs) => {
                             if(gs.player.attributes.charm > 70) {
                                 return { text: "你从丈夫口中得知了一些关于朝堂的[情报]。", effects: { item: { id: 'qing_bao_cai_wu', amount: 1 } } };
                             }
                             return { text: "丈夫觉得你疑心太重，与你好感下降。", effects: { npc_relationship: { npc_key: 'spouse', favor: -5 } } };
                        }}
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：嫡子诞生",
                trigger: { career_level: 2, text_desc: "与丈夫好感度>80，并成功诞下嫡子", condition: (gs) => gs.marriage.favor > 80 && gs.flags.has_given_birth_to_heir },
                desc: "经历了十月怀胎和生产的凶险，一声响亮的啼哭为你的人生带来了全新的意义。你的时代，正式来临。",
                success: { text: "嫡子诞生，你的地位稳如泰山。婆婆在全族人的见证下，将象征主母权力的[府库的钥匙]和【内务府名册】正式交给你。你获得了完全的当家权！", effects: { item: { id: 'fu_ku_yao_chi', amount: 1 }, core_resources: { dang_jia_quan: 100 } } },
                failure: { text: "生产失败可能导致子嗣夭折或自身健康大损。未能抓住权力交接的机会，将让你在婆婆手下继续隐忍多年。", effects: { attributes: { health_max: -10 } } }
            }
        },
        {
            title: "第二幕：管家主母",
            level_range: [5, 7],
            goal: "运用你手中的权力，对外通过社交拓展家族影响力，对内管理后宅、平衡关系、悉心培养下一代，将家族打理得井井有条。",
            events: [
                {
                    title: "处理下人私情",
                    desc: "你发现你最得力的一个丫鬟和府里的护院私通。",
                    options: [
                        { text: "【将二人痛打一顿后赶出府】", effects: { attributes: { virtue: -5 } }, result_text: "你维护了府规的森严。但手段过于酷烈，下人忠诚度普遍下降。" },
                        { text: "【成全他们，为他们操办婚事】", cost: { wealth: 300 }, effects: { attributes: { virtue: 10 }, core_resources: { jia_zu_sheng_wang: 5 } }, result_text: "你的仁慈被传为佳话。这对夫妇会对你死心塌地，成为你最忠诚的眼线和帮手。" }
                    ]
                },
// =================== 主母：第二幕新增事件 START ===================
                    {
                        title: "田庄歉收",
                        desc: "负责田庄的管事来报，今年雨水不好，田庄歉收，可能无法交足额定的租子。",
                        options: [
                            { text: "【安抚并减免部分租子】", requirements: { virtue: 60 }, effects: { attributes: { virtue: 5 }, core_resources: { jia_zu_sheng_wang: 5 } }, result_text: "你的仁德之名在佃户中传扬开来，家族声望提升。" },
                            { text: "【坚持按契约办事】", effects: { attributes: { virtue: -3 } }, result_text: "你维护了规矩，但佃户们怨声载道。" },
                            { text: "【派心腹前去调查】", requirements: { wisdom: 70 }, effects: { attributes: { wisdom: 2 }, core_resources: { dang_jia_quan: 5 } }, result_text: "你发现管事谎报灾情，私吞了部分收成。你借此机会撤换了管事，进一步掌握了庄子的实权。" }
                        ]
                    },
                    {
                        title: "妾室间的“意外”",
                        desc: "一位不受宠的妾室“不慎”落水，而当时在场的只有另一位受宠的妾室。",
                        options: [
                            { text: "【相信是意外，安抚了事】", effects: { marriage: { familyHarmony: -5 } }, result_text: "你的处置让其中一方心怀怨恨，后宅和谐度下降。" },
                            { text: "【各打五十大板】", effects: { attributes: { prestige: 5 } }, result_text: "无论真相如何，你借此事敲打了所有人，家威提升。" },
                            { text: "【暗中调查真相】", requirements: { scheming: 70 }, effects: { attributes: { scheming: 5 } }, result_text: "你发现这竟是一场苦肉计！你掌握了她们的把柄，后宅尽在你的掌控之中。" }
                        ]
                    },
                    {
                        title: "为夫君的生辰做准备",
                        desc: "即将是你夫君的生辰，你打算如何为他庆祝？",
                        options: [
                            { text: "【举办家宴，邀请亲友】", cost: { wealth: 500 }, effects: { npc_relationship: { npc_key: 'spouse', favor: 10 }, core_resources: { ren_qing: 10 } }, result_text: "一场温馨的家宴让夫君倍感温暖，也维系了亲族关系。" },
                            { text: "【亲手缝制一件衣袍】", requirements: { talent: 60 }, effects: { npc_relationship: { npc_key: 'spouse', favor: 15 } }, result_text: "一针一线皆是情意，夫君对你的爱意更深了。" },
                            { text: "【二人世界，小酌几杯】", effects: { npc_relationship: { npc_key: 'spouse', favor: 12 } }, result_text: "你们享受了难得的二人时光，感情升温。" }
                        ]
                    },
                    {
                        title: "娘家的求助",
                        desc: "你的娘家兄弟生意上遇到困难，母亲写信希望你能从夫家周转一些资金。",
                        options: [
                            { text: "【动用自己的私产相助】", cost: { privateAssets: 1000 }, effects: { attributes: { virtue: 5 } }, result_text: "你用自己的私房钱帮助了娘家，未动用夫家分毫。" },
                            { text: "【说服夫君动用家库】", requirements: { charm: 80 }, effects: { npc_relationship: { npc_key: 'spouse', favor: 5 }, core_resources: { nei_ku_zi_jin: -1000 } }, result_text: "在你的软语相求下，夫君同意了。你们的家库减少了1000两。" },
                            { text: "【婉言拒绝】", effects: { attributes: { virtue: -5 } }, result_text: "你以夫家为重，拒绝了娘家的请求，心中有些愧疚。" }
                        ]
                    },
                    {
                        title: "慈善活动",
                        desc: "京中大户联合举办为贫民施粥的慈善活动，邀请各家主母参加。",
                        options: [
                            { text: "【捐钱不出席】", cost: { wealth: 500 }, effects: { attributes: { virtue: 2 } }, result_text: "你捐了500两，尽了一份心意。" },
                            { text: "【亲自前往，操持事务】", requirements: { virtue: 70 }, effects: { attributes: { virtue: 10, reputation: 10 } }, result_text: "你的亲力亲为赢得了极好的名声，人人都称赞你是“活菩萨”。" }
                        ]
                    },
// =================== 主母：第二幕新增事件 END ===================
                {
                    title: "妾室争宠风波",
                    desc: "两位受宠的妾室为了争夺丈夫的关注，在花园中大打出手。",
                    options: [
                        { text: "【各打五十大板，罚抄女诫】", effects: {}, result_text: "公平但无效的处理，她们的梁子越结越深，后宅不得安宁。" },
                        { text: "【暗中调查，扶持一方打压一方】", requirements: { wisdom: 80 }, effects: { attributes: { wisdom: 3 } }, result_text: "你成功地分化了她们，巩固了你独一无二的地位。" }
                    ]
                },
                {
                    title: "打理嫁妆产业",
                    desc: "你的一个陪嫁铺子，掌柜前来报告今年的经营状况。",
                    options: [
                        { text: "【听取报告，维持现状】", effects: { wealth: 1000 }, result_text: "你的陪嫁铺子今年为你带来1000两私房钱收入。" },
                        { text: "【投入更多私房钱，扩大经营】", cost: { wealth: 2000 }, getOutcome: (gs) => {
                            if (Math.random() < 0.7) {
                                return { text: "投资成功！未来数年收入翻倍。", effects: { flag: 'dowry_business_upgraded' } };
                            }
                            return { text: "投资失败，血本无归。", effects: {} };
                        }}
                    ]
                },
                {
                    title: "贵妇圈的茶会",
                    desc: "你受邀参加安国公夫人的茶会，在座皆是京城顶级权贵的妻女。",
                    options: [
                        { text: "【佩戴[皇后赏赐的珠钗]出席】", requirements: { has_item: 'huang_hou_shang_ci_zhu_chai' }, effects: { attributes: { charm: 5, reputation: 10 } }, result_text: "你的地位和品味得到所有人的认可，成功融入了京城的顶级贵妇圈。" },
                        { text: "【低调出席，多听少说】", effects: { item: { id: 'qing_bao_cai_wu', amount: 1 } }, result_text: "你在茶会上听到了关于“朝廷盐铁改革”的情报，可以告知你当官的丈夫。" }
                    ]
                },
                {
                    title: "子女的教育",
                    desc: "你的儿子到了启蒙的年龄。",
                    options: [
                        { text: "【聘请当世大儒作为老师】", cost: { wealth: 5000 }, effects: { flag: 'son_has_great_tutor' }, result_text: "你的儿子将获得最好的教育，智慧和才情成长率大幅提升。" },
                        { text: "【亲自教导】", requirements: { talent: 100, wisdom: 100 }, effects: { npc_relationship: { npc_key: 'son', favor: 20 } }, result_text: "节省了开支，且你与儿子的亲密度大幅提升。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：名动京华的寿宴",
                trigger: { career_level: 6, text_desc: "完全执掌中馈，家族声望>300", condition: (gs) => (gs.career.core_resources.dang_jia_quan || 0) >= 100 && (gs.career.core_resources.jia_zu_sheng_wang || 0) > 300 },
                desc: "为了庆祝公公的六十大寿，你决定举办一场前所未有的盛大宴会，邀请满朝文武与京城名流。每一个细节都考验着你的财力、品味和社交手腕。",
                success: { text: "你的宴会举办得无懈可击，被誉为“京城第一贤内助”！家族声望暴涨，你丈夫的官场之路因此变得顺遂无比。", effects: { core_resources: { jia_zu_sheng_wang: 100, ren_qing: 50 }, attributes: { reputation: 50 } } },
                failure: { text: "宴会中出了差错，得罪了权贵，沦为笑柄。家族声望大跌，你丈夫也因此受到牵连。", effects: { core_resources: { jia_zu_sheng_wang: -50 } } }
            }
        },
        {
            title: "第三幕：登峰造极",
            level_range: [8, 10],
            goal: "你已是家族的绝对核心。你的目标不再是管理琐事，而是为家族的未来进行长远的战略布局，通过子女的婚配和你的社交影响力，将家族推向权力的巅峰。",
            events: [
                {
                    title: "皇后的秘密茶会",
                    desc: "你被皇后秘密召入宫中，她屏退左右，向你询问一件关于前朝的秘闻。",
                    options: [
                        { text: "【知无不言】", effects: { npc_relationship: { npc_key: 'empress', favor: 50 } }, result_text: "你获得了皇后的绝对信任，成为她在宫外的代言人。" },
                        { text: "【有所保留】", effects: { npc_relationship: { npc_key: 'empress', favor: 10 } }, result_text: "你没有卷入宫廷最深的秘密，保全了自身，但也失去了更进一步的机会。" }
                    ]
                },
// =================== 主母：第三幕新增事件 START ===================
                    {
                        title: "扶持娘家势力",
                        desc: "你的娘家有子弟准备参加科举，希望你能利用夫家的影响力为其铺路。",
                        options: [
                            { text: "【向夫君引荐，请其关照】", requirements: { favor: 90 }, effects: { npc_relationship: { npc_key: 'spouse', favor: 5 }, core_resources: { ren_qing: 20 } }, result_text: "夫君看在你的面子上，关照了你的娘家子弟。你欠下夫君一份人情。" },
                            { text: "【动用自己的人脉打点】", requirements: { reputation: 300 }, effects: { attributes: { reputation: -10 } }, result_text: "你动用自己的人脉网，为娘家子弟铺平了道路，但消耗了你部分声望。" }
                        ]
                    },
                    {
                        title: "嫡庶之争",
                        desc: "你的嫡子与一位受宠妾室所生的庶子，在继承家业的问题上产生了明显的竞争关系。",
                        options: [
                            { text: "【打压庶子，为嫡子铺路】", requirements: { scheming: 80 }, effects: { attributes: { virtue: -10 } }, result_text: "你用手段打压了庶子，确保了嫡子的地位，但后宅因此不得安宁。" },
                            { text: "【公平竞争，择优而立】", requirements: { virtue: 90 }, effects: { attributes: { virtue: 10 } }, result_text: "你的公正赢得了所有人的尊重，但也可能让能力不足的嫡子失去继承权。" },
                            { text: "【分化家产，各立门户】", requirements: { wisdom: 90 }, effects: { core_resources: { jia_zu_sheng_wang: -20 } }, result_text: "你为他们分别置办产业，避免了内斗，但也分散了家族的整体实力。" }
                        ]
                    },
                    {
                        title: "投资未来",
                        desc: "你通过敏锐的观察，发现朝中一位不起眼的年轻官员极具潜力。",
                        options: [
                            { text: "【以家族名义暗中资助】", cost: { wealth: 5000 }, effects: { npc_relationship: { npc_key: 'future_star', favor: 60, type: 'ally' } }, result_text: "你进行了一次长线投资。若此人未来平步青云，将成为你家族最坚实的盟友。" },
                            { text: "【将一位庶女许配给他】", effects: { npc_relationship: { npc_key: 'future_star', favor: 80, type: 'ally' } }, result_text: "你用联姻的方式将他彻底绑在了你家的船上。" }
                        ]
                    },
                    {
                        title: "夫君的“红颜知己”",
                        desc: "你发现夫君最近常常与一位才名远播的女诗人“探讨诗词”，举止颇为亲密。",
                        options: [
                            { text: "【大吵大闹】", effects: { npc_relationship: { npc_key: 'spouse', favor: -20 } }, result_text: "你的吵闹让夫君颜面尽失，夫妻关系降至冰点。" },
                            { text: "【私下会见那位女诗人】", requirements: { charm: 100, scheming: 90 }, effects: { attributes: { scheming: 5 } }, result_text: "你与女诗人进行了一场没有硝烟的交锋，最终兵不血刃地劝退了对方。" },
                            { text: "【提升自己，稳固地位】", effects: { npc_relationship: { npc_key: 'spouse', favor: 10 }, attributes: { charm: 5, talent: 5 } }, result_text: "你将精力放在提升自己和打理家事上，夫君最终还是认识到谁才是他离不开的人。" }
                        ]
                    },
                    {
                        title: "太后的召见",
                        desc: "因你持家有道、声名远播，太后特召你入宫叙话。",
                        options: [
                            { text: "【应对得体，博得欢心】", requirements: { etiquette: 120 }, effects: { attributes: { reputation: 30 }, item: { id: 'huang_hou_shang_ci_zhu_chai', amount: 1 } }, result_text: "你的言谈举止深得太后喜爱，赏赐了你[皇后赏赐的珠钗]，你在贵妇圈中的地位无人能及。" },
                            { text: "【无意中卷入宫廷秘闻】", requirements: { wisdom: 100 }, effects: { attributes: { scheming: 10 } }, result_text: "你在与太后的交谈中，无意间得知了一桩关于皇子们的宫廷秘闻，这或许是机遇，也是危险。" }
                        ]
                    },
// =================== 主母：第三幕新增事件 END ===================
                {
                    title: "为子女议亲",
                    desc: "你的长子/长女到了议亲的年龄，媒人送来了几家的资料。",
                    options: [
                        { text: "【开始筛选】", effects: { flag: 'trigger_child_marriage_sequence' }, result_text: "你开始动用情报和人脉，对候选人进行背景调查，这将决定子女一生的幸福和家族未来的盟友。" }
                    ]
                },
                {
                    title: "调解姻亲纷争",
                    desc: "你出嫁的女儿哭着回娘家，说被夫家欺负。",
                    options: [
                        { text: "【亲自前往亲家问罪】", effects: {}, result_text: "你为女儿讨回了公道，但与亲家关系破裂。" },
                        { text: "【备上厚礼，私下调解】", cost: { wealth: 1000 }, effects: { core_resources: { ren_qing: 20 } }, result_text: "你用你的智慧和手腕化解了矛盾，与亲家关系更加稳固，并获得了人情。" }
                    ]
                },
                {
                    title: "家族继承权的暗流",
                    desc: "你的几个儿子为了未来的继承权，在暗中互相较劲。",
                    options: [
                        { text: "【明确立长子为核心】", effects: {}, result_text: "稳固了继承秩序，但其他儿子的忠诚度和好感度会下降。" },
                        { text: "【分家产，让他们各自发展】", effects: {}, result_text: "避免了内斗，但家族的整体实力被削弱。" }
                    ]
                },
                {
                    title: "编撰家书/族谱",
                    desc: "你年事已高，决定将一生的治家经验和人生智慧写下来。",
                    options: [
                        { text: "【开始编撰】", effects: { item: {id: 'chuan_jia_jia_xun', amount: 1} }, result_text: "这是一个长期的项目。完成后，你将获得独一无二的[传家家训]，可以被你的后代在下一轮游戏中继承，为其提供强大的初始属性加成。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：一门荣耀",
                trigger: { career_level: 9, text_desc: "丈夫官居一品或子女达成辉煌成就", condition: (gs) => gs.flags.family_peak_glory },
                desc: "浩荡的皇家仪仗队来到你的府前，宫中派来的太监展开圣旨，高声宣读对你的册封。你一生的隐忍、智慧和经营，在这一刻得到了最高的回报。",
                success: { text: "你被册封为“一品诰命夫人”！你的家族声望达到顶峰。解锁最终能力【向皇后/皇帝举荐】。你，就是这个家族的活传奇。", effects: { end_game_title: '一品诰命', flag: 'unlock_imperial_recommendation' } },
                failure: { text: "", effects: {} } // 达成型，无失败
            }
        }
    ]
},

'embroiderer': {
    name: "绣娘",
    icon: "fa-cut",
    gender: "female",
    core_resources: ["ben_jin", "pin_pai_sheng_wang", "du_jia_cai_liao", "reputation"],
    dashboard_name: "云裳织台",
    acts: [
        {
            title: "第一幕：筚路蓝缕",
            level_range: [1, 4],
            goal: "在竞争激烈的市场中生存下来，积累第一桶金，找到自己的独特风格，并拥有一家属于自己的小小店铺。",
            events: [
                {
                    title: "招募绣娘",
                    desc: "你的小作坊需要人手。",
                    options: [
                        { text: "【招募手艺平平但工钱低的】", effects: { }, result_text: "你的本金压力较小，但产品质量一般，品牌声望提升缓慢。" },
                        { text: "【咬牙招募一位手艺精湛的老师傅】", cost: { wealth: 500 }, effects: { core_resources: { pin_pai_sheng_wang: 10 } }, result_text: "你的产品质量远超同行，很快吸引了第一批客户。" }
                    ]
                },
// =================== 绣娘：第一幕新增事件 START ===================
                    {
                        title: "珍稀染料",
                        desc: "一位西域商人向你兜售一种从未见过的蓝色染料，色泽纯净，但价格昂贵。",
                        options: [
                            { text: "【倾尽所有买下】", cost: { wealth: 500 }, effects: { item: { id: 'xiyu_dye', amount: 1 }, core_resources: { du_jia_cai_liao: 1 } }, result_text: "你赌赢了！用这种染料制成的“天水碧”系列大受欢迎，为你带来了第一桶金。" },
                            { text: "【谨慎购买样品】", cost: { wealth: 50 }, effects: {}, result_text: "你花50两购买了样品，证实了其价值，但错过了独占的机会。" }
                        ]
                    },
                    {
                        title: "绣艺大赛",
                        desc: "城中举办了一场小型的绣艺比赛，胜者可以获得一笔奖金。",
                        options: [
                            { text: "【拿出看家本领参赛】", requirements: { talent: 60 }, effects: { wealth: 300, core_resources: { pin_pai_sheng_wang: 15 } }, result_text: "你的作品技惊四座，不仅赢得奖金，也为你小小的作坊打响了名气。" },
                            { text: "【认为时机未到，选择观摩】", effects: { attributes: { talent: 2 } }, result_text: "你在观摩中学习到了几种新的针法。" }
                        ]
                    },
                    {
                        title: "被大商铺欺压",
                        desc: "城中最大的布庄“锦绣阁”老板警告你，不许再从他的渠道进货。",
                        options: [
                            { text: "【忍气吞声，另寻他法】", effects: {}, result_text: "你被迫寻找新的、更昂贵的货源，经营成本增加。" },
                            { text: "【与小商户联合抵制】", requirements: { charm: 50 }, effects: { attributes: { reputation: 10 } }, result_text: "你联合了其他小商户，共同抵制“锦绣阁”，此事在城中引起不小的波澜。" }
                        ]
                    },
                    {
                        title: "修改旧衣",
                        desc: "一位家境贫寒的姑娘，拿着母亲的旧嫁衣前来，希望你能帮忙修改成她出嫁时穿的礼服。",
                        options: [
                            { text: "【分文不取，精心修改】", effects: { attributes: { virtue: 10, talent: 3 }, core_resources: { pin_pai_sheng_wang: 10 } }, result_text: "你的善举和巧手被传为佳话，许多平民客户慕名而来。" },
                            { text: "【收取少量费用】", cost: { wealth: -50 }, effects: { attributes: { virtue: 3 } }, result_text: "你只收取了成本费，也算是一桩善行。" }
                        ]
                    },
                    {
                        title: "官府订单",
                        desc: "衙门需要为女眷定制一批制服，这是一笔稳定但利润微薄的生意。",
                        options: [
                            { text: "【接下订单】", effects: { wealth: 200, npc_relationship: { npc_key: 'ya_men_master', favor: 10 } }, result_text: "你虽然没赚多少钱，但与官府搭上了线，以后办事方便了许多。" },
                            { text: "【婉言拒绝】", effects: {}, result_text: "你认为利润太低，拒绝了这笔生意。" }
                        ]
                    },
// =================== 绣娘：第一幕新增事件 END ===================
                {
                    title: "第一笔订单",
                    desc: "一位富商的妻子前来，希望能为她的女儿定制一件与众不同的生日礼服。",
                    options: [
                        { text: "【使用店里最好的材料】", effects: { core_resources: { pin_pai_sheng_wang: 20 }, npc_relationship: { npc_key: 'rich_merchant_wife', favor: 30, type: 'ally' } }, result_text: "礼服精美绝伦，客户非常满意。你虽没赚多少钱，但赢得了口碑和一位重要客户。" },
                        { text: "【在不影响外观的地方使用普通材料】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 70) {
                                return { text: "你保证了外观，获得了极高的利润。", effects: { wealth: 500, attributes: { wisdom: 1 } } };
                            }
                            return { text: "被客户发现，认为你是“奸商”，品牌声望受损。", effects: { core_resources: { pin_pai_sheng_wang: -10 } } };
                        }}
                    ]
                },
                {
                    title: "面料市场的“陷阱”",
                    desc: "一位布料商人向你低价兜售一批色泽极为艳丽的“西域布料”。",
                    options: [
                        { text: "【全部买下】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom < 80) {
                                return { text: "这批布料一经水洗就严重褪色，你的投资血本无归。", effects: { wealth: -300 } };
                            }
                            return { text: "你在购买前进行了测试，识破了骗局，避免了损失。", effects: { attributes: { wisdom: 2 } } };
                        }}
                    ]
                },
                {
                    title: "邻里商铺的排挤",
                    desc: "隔壁的男性老板们对你一个女人家抛头露面做生意指指点点，甚至抢你的客源。",
                    options: [
                        { text: "【赠送亲手制作的[精致荷包]示好】", effects: { social_favor: { group: 'neighbor_shops', change: 10 } }, result_text: "你的善意和巧手赢得了他们的尊重，关系有所改善。" },
                        { text: "【推出“女性专属”折扣，精准营销】", effects: { core_resources: { pin_pai_sheng_wang: 5 } }, result_text: "你吸引了城中大部分女性客户，让隔壁老板们无可奈何。" }
                    ]
                },
                {
                    title: "灵感的枯竭",
                    desc: "你最近感觉设计不出新东西了。",
                    options: [
                        { text: "【前往郊外/寺庙游玩】", effects: { core_resources: { ling_gan: 30, xin_jing: '恬淡' } }, result_text: "你在自然与宁静中获得了启发。" },
                        { text: "【去竞争对手的店铺“考察”】", effects: { core_resources: { ling_gan: 15 }, attributes: { virtue: -2 } }, result_text: "你借鉴了对方的优点，但此举有失风骨。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：一绣成名",
                trigger: { career_level: 3, text_desc: "成为掌柜, 才情>80, 品牌声望>50", condition: (gs) => gs.player.attributes.talent > 80 && (gs.career.core_resources.pin_pai_sheng_wang || 0) > 50 },
                desc: "一位穿着朴素但气质不凡的侍女，悄然来到你简陋的作坊，言称自家主子厌倦了京城千篇一律的风格，想寻一件真正“别致”的小物件。",
                success: { text: "你的作品深得安国公夫人的喜爱！她成为了你的第一位大客户和保护人，并赠予你[贵夫人的信物]。你获得了足够资金在京城最繁华的地段开设一家真正的店铺！", effects: { core_resources: { pin_pai_sheng_wang: 100 }, wealth: 2000, item: { id: 'gui_fu_ren_xin_wu', amount: 1 } } },
                failure: { text: "你的作品未能打动对方，她客气地付了钱便再无下文。你错失了进入上流社会的机会。", effects: {} }
            }
        },
        {
            title: "第二幕：名动京华",
            level_range: [5, 7],
            goal: "将店铺打造成京城知名品牌，开设分店，管理日益增多的绣娘团队，并在与宿敌的竞争中脱颖而出。",
            events: [
                {
                    title: "应对“霓裳坊”的挑战",
                    desc: "你的宿敌【霓裳坊】开始全面模仿你的风格，并以更低的价格出售。",
                    options: [
                        { text: "【发起价格战】", cost: { wealth: 5000 }, effects: { core_resources: { ben_jin: -5000 } }, result_text: "一场惨烈的资本消耗战。你的本金和霓裳坊的本金同时大量减少，胜负难料。" },
                        { text: "【举办“高级定制”茶会】", cost: { wealth: 1000 }, effects: { core_resources: { pin_pai_sheng_wang: 30 } }, result_text: "你推出“一人一版”的高端定制服务，彻底占领了高端市场，利润率大幅提升。" },
                        { text: "【暗中调查其“黑料”】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 100) {
                                return { text: "你发现霓裳坊使用劣质染料。你可以选择“曝光”彻底击垮对方（品德-5），或“以此要挟”获得赔偿和市场份额。", effects: { flag: 'found_competitor_dirt' } };
                            }
                            return { text: "你一无所获。", effects: {} };
                        }}
                    ]
                },
// =================== 绣娘：第二幕新增事件 START ===================
                    {
                        title: "创立品牌",
                        desc: "你的店铺已经小有名气，你决定为它取一个正式的名字，创立自己的品牌。",
                        options: [
                            { text: "【以自己的名字命名】", effects: { core_resources: { pin_pai_sheng_wang: 20 } }, result_text: "你的名字从此与高品质的绣品紧紧联系在一起。" },
                            { text: "【取一个风雅的名字】", requirements: { talent: 80 }, effects: { core_resources: { pin_pai_sheng_wang: 15 } }, result_text: "一个雅致的品牌名，吸引了许多文人雅士的夫人前来光顾。" }
                        ]
                    },
                    {
                        title: "来自宫廷的试探",
                        desc: "一位宫里的公公来到你的店里，不言明身份，只说要定制一件“贵人”穿的衣服。",
                        options: [
                            { text: "【倾尽心力，不问来路】", requirements: { talent: 100 }, effects: { attributes: { reputation: 20 }, npc_relationship: { npc_key: 'palace_eunuch', favor: 30, type: 'ally' } }, result_text: "你的作品深得宫中某位娘娘的喜爱，这位公公也成了你在宫中的眼线。" },
                            { text: "【担心惹祸，婉言拒绝】", effects: {}, result_text: "你拒绝了这笔订单，虽然安全，但也错失了天大的机遇。" }
                        ]
                    },
                    {
                        title: "山寨风波",
                        desc: "你发现市面上出现了大量仿冒你设计的廉价绣品，严重影响了你的生意。",
                        options: [
                            { text: "【与对方对簿公堂】", cost: { wealth: 500 }, effects: { core_resources: { pin_pai_sheng_wang: 10 } }, result_text: "你花费500两打赢了官司，维护了品牌的声誉。" },
                            { text: "【开发防伪标识】", requirements: { wisdom: 80 }, effects: { core_resources: { du_jia_cai_liao: 1 } }, result_text: "你设计出一种独特的防伪绣印，彻底杜绝了仿冒品。" },
                            { text: "【降价竞争】", effects: { core_resources: { ben_jin: -1000 } }, result_text: "你被迫卷入价格战，虽然赶走了仿冒者，但也损失了不少利润。" }
                        ]
                    },
                    {
                        title: "异域风情",
                        desc: "一位西域舞女来到你的店里，希望能定制一件充满异域风情的舞衣。",
                        options: [
                            { text: "【大胆尝试，融合风格】", requirements: { talent: 90 }, effects: { attributes: { talent: 5 }, core_resources: { pin_pai_sheng_wang: 25 } }, result_text: "你设计的舞衣惊艳了全城，开创了新的流行风潮。" },
                            { text: "【坚持本土风格】", effects: {}, result_text: "你拒绝了请求，坚持自己的设计理念。" }
                        ]
                    },
                    {
                        title: "收授徒弟",
                        desc: "你的名气吸引了一些年轻姑娘前来拜师学艺。",
                        options: [
                            { text: "【择优录取，倾囊相授】", effects: { attributes: { virtue: 5 }, flag: 'unlock_apprentices' }, result_text: "你开办了绣班，培养出的绣娘将成为你最得力的助手。（解锁徒弟系统）" },
                            { text: "【担心技术外流而拒绝】", effects: {}, result_text: "你拒绝了所有请求，选择独自发展。" }
                        ]
                    },
// =================== 绣娘：第二幕新增事件 END ===================
                {
                    title: "季节性爆款的赌注",
                    desc: "根据市场传闻，今年秋季的流行元素可能是“西域风情”或“简约素雅”。",
                    options: [
                        { text: "【全力生产“西域风”服饰】", getOutcome: (gs) => {
                            if (Math.random() < 0.5) {
                                return { text: "你赌对了！你的服饰引领潮流，本季度利润翻三倍！", effects: { wealth: 10000 } };
                            }
                            return { text: "你赌错了。货物大量积压，本金严重亏损。", effects: { wealth: -5000 } };
                        }},
                        { text: "【两种风格都少量生产】", effects: { wealth: 2000 }, result_text: "无论哪种流行，你都能小赚一笔，但无法获得爆发性增长。" }
                    ]
                },
                {
                    title: "与供应商的博弈",
                    desc: "江南的丝绸供应商告知你，今年最好的那一批“雪蚕丝”数量有限。",
                    options: [
                        { text: "【支付溢价，全部买断】", cost: { wealth: 8000 }, effects: { core_resources: { du_jia_cai_liao: 1 } }, result_text: "你获得了[顶级雪蚕丝]，可以制作出最高品质的服装。你的对手无米下锅。" },
                        { text: "【与对手竞价】", effects: {}, result_text: "导致材料价格飞涨，无论谁赢，利润都将受损。" }
                    ]
                },
                {
                    title: "开设分店的选址",
                    desc: "你的生意蒸蒸日上，需要开设分店。",
                    options: [
                        { text: "【选在权贵聚集的“朱雀大街”】", cost: { wealth: 15000 }, effects: { core_resources: { pin_pai_sheng_wang: 50 } }, result_text: "租金极高，但品牌声望大幅提升，能吸引到最高端的客户。" },
                        { text: "【选在商铺林立的“东市”】", cost: { wealth: 8000 }, effects: { flag: 'east_market_branch' }, result_text: "竞争激烈，但能获得最大的客流量，利润率较低。" }
                    ]
                },
                {
                    title: "绣娘的“跳槽”危机",
                    desc: "你手下最能干的绣娘被【霓裳坊】以三倍工钱挖角。",
                    options: [
                        { text: "【匹配薪酬】", cost: { wealth: 500 }, effects: {}, result_text: "你留住了人，但经营成本永久性上升。" },
                        { text: "【情感挽留】", getOutcome: (gs) => {
                            if (gs.player.attributes.charm > 120) {
                                return { text: "她被你的情谊和理想打动，决定留下。她对你死心塌地。", effects: { npc_relationship: { npc_key: 'top_embroiderer', favor: 50 } } };
                            }
                            return { text: "她感谢你的看重，但还是选择了更高的薪水。", effects: {} };
                        }},
                        { text: "【提拔副手，祝她前程似锦】", effects: {}, result_text: "你展现了气度，并提拔了新人。虽有短期阵痛，但长期来看，你拥有了更忠诚的团队。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：京城时尚风向标",
                trigger: { career_level: 6, text_desc: "名动京华, 品牌声望>500", condition: (gs) => (gs.career.core_resources.pin_pai_sheng_wang || 0) > 500 },
                desc: "在你自家的后花园，你举办了一场华美的时装秀，京城所有贵妇名媛悉数到场。你将向整个京城宣告：潮流，由我定义！",
                success: { text: "你的时装秀大获成功！你的设计成为未来一年的绝对潮流。你的商铺正式升级为“品牌”，所有商品售价永久提升20%！", effects: { core_resources: { pin_pai_sheng_wang: 200 }, flag: 'brand_established' } },
                failure: { text: "时装秀沦为笑柄，投入的本金全部打水漂，品牌声望大跌。", effects: { wealth: -5000, core_resources: { pin_pai_sheng_wang: -100 } } }
            }
        },
        {
            title: "第三幕：富甲一方",
            level_range: [8, 10],
            goal: "你的品牌已是帝国顶流。你的目标是获得皇室的认可，成为御用商人，并将你的影响力从商业领域扩展到更广阔的天地。",
            events: [
                {
                    title: "宫廷的垄断订单",
                    desc: "内务府需要为宫中所有宫女采办四季的制服，这是一笔巨额订单。",
                    options: [
                        { text: "【不计成本，拿下订单】", effects: { core_resources: { pin_pai_sheng_wang: 50 }, flag: 'imperial_supplier' }, result_text: "你虽然利润微薄，但成为了“宫廷供应商”，品牌声望和政治地位大幅提升。" },
                        { text: "【与几家商行联手，共同承办】", effects: { flag: 'form_textile_guild' }, result_text: "你组建了京城第一个“服装行会”，你成为会长，控制了整个行业的原材料和定价。" }
                    ]
                },
// =================== 绣娘：第三幕新增事件 START ===================
                    {
                        title: "编撰《女红图鉴》",
                        desc: "你决定将自己一生的绣艺心得和设计图样编撰成书，流传后世。",
                        options: [
                            { text: "【开始编撰】", effects: { item: { id: 'nv_hong_tu_jian', amount: 1 }, attributes: { reputation: 50 } }, result_text: "这是一个长期的项目。完成后，你将获得独一无二的[《女红图鉴》]，可以被后代继承，为其提供强大的才情加成。" }
                        ]
                    },
                    {
                        title: "皇后的寿礼",
                        desc: "皇后即将举办寿宴，内务府向所有顶级商号征集寿礼设计，这是一个巨大的荣耀。",
                        options: [
                            { text: "【设计“百鸟朝凤”图】", requirements: { talent: 150 }, effects: { core_resources: { pin_pai_sheng_wang: 100 }, npc_relationship: { npc_key: 'empress', favor: 50, type: 'ally' } }, result_text: "你的设计屏雀中选！你获得了为皇后制作寿礼的资格，从此成为皇商。" },
                            { text: "【联合其他商号共同献礼】", requirements: { charm: 120 }, effects: { attributes: { reputation: 30 } }, result_text: "你联合了其他珠宝、木器商号，共同设计了一份大礼，展现了你的领导才能。" }
                        ]
                    },
                    {
                        title: "开设男装线",
                        desc: "有富家公子前来询问，是否能为他们定制同样高品质的男士长袍。",
                        options: [
                            { text: "【开拓新市场】", cost: { wealth: 10000 }, effects: { core_resources: { ben_jin: 5000 } }, result_text: "你成功开拓了男装市场，店铺的收入来源更加多样化。" },
                            { text: "【专注女性市场】", effects: {}, result_text: "你认为应该专注于自己最擅长的领域。" }
                        ]
                    },
                    {
                        title: "海外订单",
                        desc: "一位海外使臣对你的绣品大加赞赏，希望能订购一批运回他的国家。",
                        options: [
                            { text: "【接下订单，走向世界】", effects: { wealth: 15000, attributes: { reputation: 50 } }, result_text: "你的品牌从此名扬海外，为你带来了巨大的财富和声望。" },
                            { text: "【担心运输风险而拒绝】", effects: {}, result_text: "你错过了让品牌走向世界的机会。" }
                        ]
                    },
                    {
                        title: "继承人的抉择",
                        desc: "你年事已高，需要为这个庞大的商业帝国寻找一位继承人。",
                        options: [
                            { text: "【从子女中挑选】", effects: { flag: 'start_heir_training_embroiderer' }, result_text: "你将开启“继承人培养”模式，将你的技艺和商业头脑传授给下一代。" },
                            { text: "【从最得力的徒弟中提拔】", effects: {}, result_text: "你的选择确保了品牌的专业性，但也可能引起家族内部的不满。" }
                        ]
                    },
// =================== 绣娘：第三幕新增事件 END ===================
                {
                    title: "丝绸之路的机遇",
                    desc: "一位【商贾】职业的男性巨头，邀请你合股投资一支前往西域的驼队。",
                    options: [
                        { text: "【接受合作】", effects: { flag: 'unlock_overseas_trade' }, result_text: "你开启了海外贸易。你获得了全新的独家材料，并有机会将你的品牌影响力扩展到海外。" },
                        { text: "【担心风险，选择拒绝】", effects: {}, result_text: "你错过了让品牌国际化的机会。" }
                    ]
                },
                {
                    title: "建立女子织造学院",
                    desc: "你感念创业不易，决定为贫家女子提供一技之长。",
                    options: [
                        { text: "【投入巨资，建立学院】", cost: { wealth: 50000 }, effects: { attributes: { virtue: 50, reputation: 100 } }, result_text: "你被誉为“女中尧舜”，品德和声望达到顶峰。学院将源源不断地为你提供最忠诚、最有才华的绣娘。" }
                    ]
                },
                {
                    title: "礼部的“风化”指责",
                    desc: "一位保守的礼部官员上奏，指责你的服装设计“过于暴露，有伤风化”。",
                    options: [
                        { text: "【通过贵妇人脉，向其施压】", cost: { core_resources: { ren_qing: 30 } }, effects: {}, result_text: "那些穿着你衣服的王妃、公主们向皇帝抱怨，该官员被申饬，危机解除。" },
                        { text: "【设计一款“道德标兵”系列】", effects: { core_resources: { pin_pai_sheng_wang: 20 } }, result_text: "你用一款极为端庄典雅的设计堵住了悠悠之口，展现了你高超的设计驾驭能力。" }
                    ]
                },
                {
                    title: "家族的压力",
                    desc: "你的男性亲族以“女子不应掌管如此大的家业”为由，要求你将生意交给他们打理。",
                    options: [
                        { text: "【用钱财安抚，分出部分利润】", cost: { wealth: 10000 }, effects: {}, result_text: "暂时平息了纷争，但你的收入减少。" },
                        { text: "【寻求官场/贵妇人脉的庇护】", cost: { core_resources: { ren_qing: 50 } }, effects: {}, result_text: "你的强大盟友让家族不敢再轻举妄动。" },
                        { text: "【培养一位女性继承人】", effects: { flag: 'start_heir_training' }, result_text: "你选择培养你的女儿或一位得力女徒弟，将你的事业和独立精神传承下去。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：凤袍加身",
                trigger: { career_level: 9, text_desc: "品牌声望顶峰, 与皇室关系“信赖”", condition: (gs) => (gs.career.core_resources.pin_pai_sheng_wang || 0) > 1000 && (gs.social.royal_favor || 0) > 80 },
                desc: "内务府总管亲自来到你的店铺，宣读皇后懿旨：命你为即将到来的“天寿节”制作一件全新的凤袍。这既是无上的荣耀，也是万丈深渊。",
                success: { text: "你的凤袍在天寿节大典上华光万丈，皇后大悦。你的商行被正式册封为“一品御商”，垄断所有皇室纺织品供应，并获得[出入宫禁金牌]！", effects: { item: { id: 'chu_ru_gong_jin_jin_pai', amount: 1 }, flag: 'imperial_monopoly', end_game_title: '一品御商' } },
                failure: { text: "你的作品出了差错，被视为“欺君之罪”，店铺查封，家人流放。", effects: { end_game: 'execution' } }
            }
        }
    ]
},

'doctor': {
    name: "女医",
    icon: "fa-clinic-medical",
    gender: "female",
    core_resources: ["yi_de", "reputation", "zhen_xi_yao_cai", "yi_shu"],
    dashboard_name: "百草药庐",
    acts: [
        {
            title: "第一幕：杏林新秀",
            level_range: [1, 4],
            goal: "学习医药基础，克服行医的初步障碍，通过治疗常见病症，在街坊邻里间建立最初的信任。",
            events: [
                {
                    title: "药铺学徒",
                    desc: "你在一家老药铺里当学徒，每日的工作是繁杂的炮制药材。",
                    options: [
                        { text: "【勤奋地研磨药材】", getOutcome: (gs) => {
                            let outcome = { text: "你的勤劳被老药师看在眼里。", effects: { attributes: { health: 1 }, npc_relationship: { npc_key: 'old_pharmacist', favor: 5 } } };
                            if (Math.random() < 0.1) {
                                outcome.text += " 你在研磨时发现一株未被识别的[异种草药]！";
                                outcome.effects.item = { id: 'yi_zhong_cao_yao', amount: 1 };
                            }
                            return outcome;
                        }},
                        { text: "【偷偷翻阅药柜后的医书】", getOutcome: (gs) => {
                            if (gs.player.attributes.wisdom > 40) {
                                return { text: "你学到了一些基础药理。", effects: { core_resources: { yi_shu: 2 } } };
                            }
                            return { text: "被发现并遭到斥责，认为你好高骛远。", effects: { npc_relationship: { npc_key: 'old_pharmacist', favor: -5 } } };
                        }}
                    ]
                },
// =================== 女医：第一幕新增事件 START ===================
                    {
                        title: "药材炮制",
                        desc: "老药师让你处理一批附子，此药有剧毒，炮制过程稍有不慎便会中毒。",
                        options: [
                            { text: "【严格遵循古法，小心翼翼】", requirements: { wisdom: 50 }, effects: { core_resources: { yi_shu: 3 }, npc_relationship: { npc_key: 'old_pharmacist', favor: 10 } }, result_text: "你成功完成了炮制，老药师对你的严谨十分赞赏。" },
                            { text: "【稍有不慎，手指发麻】", effects: { attributes: { health: -5 }, core_resources: { yi_shu: 1 } }, result_text: "你中了轻微的毒，但也亲身体会了药性，对附子的理解更深了。" }
                        ]
                    },
                    {
                        title: "贫苦的病人",
                        desc: "一位衣衫褴褛的老妇前来求医，但她付不起药钱。",
                        options: [
                            { text: "【免费为她医治】", effects: { core_resources: { yi_de: 10 }, attributes: { virtue: 5 } }, result_text: "你的善举在坊间传开，医德和声望都得到了提升。" },
                            { text: "【让她用劳动抵债】", effects: { core_resources: { yi_de: 2 } }, result_text: "一个公平的解决办法。" }
                        ]
                    },
                    {
                        title: "一本残破的医书",
                        desc: "你在旧书摊上发现一本作者不详的医书残卷，上面记载了一些闻所未闻的治疗思路。",
                        options: [
                            { text: "【花费100两买下】", cost: { wealth: 100 }, effects: { attributes: { wisdom: 5 }, core_resources: { yi_shu: 5 } }, result_text: "你买下了医书，其中的奇思妙想让你大开眼界，医术提升。" },
                            { text: "【认为是无稽之谈】", effects: {}, result_text: "你错过了这次机会。" }
                        ]
                    },
                    {
                        title: "助产",
                        desc: "邻居家的产妇难产，稳婆束手无策，情急之下请你去帮忙。",
                        options: [
                            { text: "【运用所学，大胆尝试】", requirements: { wisdom: 60, virtue: 40 }, effects: { attributes: { reputation: 15 }, core_resources: { yi_de: 10 } }, result_text: "你成功帮助产妇诞下婴儿，母子平安。你“送子观音”的名声不胫而走。" },
                            { text: "【表示无能为力】", effects: {}, result_text: "你不敢冒险，最终产妇虽然保住了性命，但孩子夭折了。" }
                        ]
                    },
                    {
                        title: "宠物的疾病",
                        desc: "一位贵妇人抱着她生病的爱猫前来，希望你能治好它。",
                        options: [
                            { text: "【触类旁通，为其治疗】", requirements: { wisdom: 50 }, effects: { wealth: 200, npc_relationship: { npc_key: 'cat_lady', favor: 20 } }, result_text: "你成功治好了小猫，贵妇人十分感激，给了你丰厚的报酬，并成为你的常客。" },
                            { text: "【表示只医人，不医畜】", effects: {}, result_text: "你拒绝了贵妇人，她失望地离开了。" }
                        ]
                    },
// =================== 女医：第一幕新增事件 END ===================
                {
                    title: "第一次出诊",
                    desc: "邻家三岁的孩童深夜高烧不退，男大夫出远门未归，孩子的母亲焦急地前来求你。",
                    options: [
                        { text: "【自信前往，为其诊治】", getOutcome: (gs) => {
                            if ((gs.career.core_resources.yi_shu || 0) + gs.player.attributes.wisdom > 50) {
                                return { text: "你成功为孩子退了烧，获得了街坊的初步信任。", effects: { attributes: { reputation: 10 }, core_resources: { yi_de: 5 } } };
                            }
                            return { text: "孩子病情加重，你遭到邻里的指责。", effects: { attributes: { reputation: -10 } } };
                        }}
                    ]
                },
                {
                    title: "古籍中的偏方",
                    desc: "你在整理一本破旧医书时，发现了一个治疗风湿的奇怪偏方，需要用到蝎子和蜈蚣。",
                    options: [
                        { text: "【为一位饱受风湿之苦的老人尝试】", getOutcome: (gs) => {
                            if (Math.random() < 0.5) {
                                return { text: "偏方有奇效！你将此方剂收录，获得[独家药方]。", effects: { core_resources: { yi_shu: 5 }, attributes: { reputation: 10 }, item: { id: 'du_jia_yao_fang', amount: 1 } } };
                            }
                            return { text: "毫无效果，甚至加重了病情。", effects: { attributes: { reputation: -5 }, core_resources: { yi_de: -5 } } };
                        }},
                        { text: "【认为风险太高，放弃尝试】", effects: {}, result_text: "你选择了稳妥，但也错失了精进医术的机会。" }
                    ]
                },
                {
                    title: "来自同行的轻视",
                    desc: "城里的男大夫公开声称“女子阴柔，不宜行阳刚之医术”，导致你的病人减少。",
                    options: [
                        { text: "【与其公开辩论】", effects: { attributes: { reputation: -5 } }, result_text: "无论输赢，这场风波都会让你的名声受损。" },
                        { text: "【用疗效说话，不予理会】", effects: { attributes: { virtue: 3, reputation: 5 } }, result_text: "你专心治病救人。一段时间后，你的疗效让流言不攻自破。" }
                    ]
                },
                {
                    title: "上山采药",
                    desc: "为了补充药材，你亲自进入深山。",
                    options: [
                        { text: "【在外围采摘常见草药】", effects: { item: { id: 'common_herbs', amount: 10 } }, result_text: "安全返回，获得了甘草、金银花等常用药材。" },
                        { text: "【冒险进入深山】", getOutcome: (gs) => {
                            if (gs.player.attributes.health > 70) {
                                return { text: "你躲过了毒蛇猛兽，成功采到了[百年灵芝]！", effects: { item: { id: 'bai_nian_ling_zhi', amount: 1 } } };
                            }
                            return { text: "你受伤而归，需要休养。", effects: { attributes: { health: -20 } } };
                        }}
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：妙手回春",
                trigger: { career_level: 3, text_desc: "成为医女, 医术>80, 医德>50", condition: (gs) => (gs.career.core_resources.yi_shu || 0) > 80 && (gs.career.core_resources.yi_de || 0) > 50 },
                desc: "你所在的街区爆发了一场大规模的“痢疾”，家家户户病倒，哀嚎声不断。官府的药铺收效甚微。这是你证明自己、获得立身之本的绝佳机会。",
                success: { text: "你力挽狂澜，成为了整片街区的救命恩人！你获得了足够的资金和名望，正式开设了属于自己的【百草药庐】！", effects: { career_level_set: 4, attributes: { reputation: 150 }, core_resources: { yi_de: 50 }, wealth: 1000, flag: 'clinic_opened' } },
                failure: { text: "疫情失控，你束手无策，之前的努力付诸东流。你的行医生涯遭遇重大打击。", effects: { attributes: { reputation: -30 } } }
            }
        },
        {
            title: "第二幕：小有医名",
            level_range: [5, 7],
            goal: "你的名声开始传到上流社会。你需要治疗更复杂的病症，并处理随之而来的、更加复杂的伦理和人际关系挑战。",
            events: [
                {
                    title: "权贵家的“隐疾”",
                    desc: "一位侯爵夫人派心腹秘密请你过府，为她诊治一种“难以启齿”的妇科疾病。",
                    options: [
                        { text: "【尽心诊治，守口如瓶】", effects: { core_resources: { yi_shu: 3 }, npc_relationship: { npc_key: 'marquise', favor: 40, type: 'ally' }, item: { id: 'nan_hai_zhen_zhu', amount: 1 } }, result_text: "你成功治愈了夫人，她对你感激不尽，成为你的盟友，并为你介绍了大量贵妇病人。" },
                        { text: "【以此为要挟，索取好处】", effects: { wealth: 5000, core_resources: { yi_de: -20 } }, result_text: "你获得了一大笔钱，但医德受损，侯爵夫人视你为心腹大患，可能会在未来对你不利。" }
                    ]
                },
                {
                    title: "疑难杂症的会诊",
                    desc: "太医院为一位重臣的怪病束手无策，听闻你的名声后，不情愿地邀请你参与会诊。",
                    options: [
                        { text: "【提出关键诊断，功劳让给太医】", effects: { attributes: { reputation: 20 }, social_favor: { group: 'imperial_doctors', change: 15 } }, result_text: "病人被治愈。你赢得了太医院众人的敬佩，与太医院关系改善。" },
                        { text: "【当众指出谬误，独自开方】", effects: { attributes: { reputation: 50 }, social_favor: { group: 'imperial_doctors', change: -30 } }, result_text: "你成功治愈了病人，名声大噪，但也彻底得罪了整个太医院。" }
                    ]
                },
                {
                    title: "开设义诊",
                    desc: "每月一次，你可以选择是否在药庐前开设义诊。",
                    options: [
                        { text: "【坚持义诊】", cost: { wealth: 100 }, effects: { core_resources: { yi_de: 10 }, attributes: { reputation: 5 } }, result_text: "虽然没有收入，但你的医德和民间声望持续稳定地增长。" },
                        { text: "【暂停一次】", effects: {}, result_text: "你选择休息，无事发生。" }
                    ]
                },
                {
                    title: "研制新的丹药",
                    desc: "在【百草药庐】中，你可以投入珍稀药材和灵感，进行研发。",
                    options: [
                        { text: "【研发[养颜丹]】", cost: { item: 'zhen_xi_yao_cai', amount: 1 }, getOutcome: (gs) => {
                            if(gs.player.attributes.talent > 100) return {text: "你成功制作出[养颜丹]！在贵妇圈中大受欢迎，成为一项重要的收入来源。", effects: {item: {id:'yang_yan_dan', amount: 5}}};
                            return {text: "研发失败，浪费了宝贵的药材。", effects:{}};
                        }},
                        { text: "【研发[续命丸]】", cost: { item: 'bai_nian_ling_zhi', amount: 1 }, getOutcome: (gs) => {
                             if(gs.player.attributes.talent > 120 && gs.career.core_resources.yi_shu > 100) return {text: "你成功制作出[续命丸]！是价值连城的保命之物。", effects: {item: {id:'xu_ming_wan', amount: 1}}};
                            return {text: "研发失败，浪费了宝贵的药材。", effects:{}};
                        }}
                    ]
                },// =================== 女医：第二幕新增事件 START ===================
                    {
                        title: "制作成药",
                        desc: "许多病人反映煎药麻烦，你决定尝试制作一些方便服用的成药（如药丸、药膏）。",
                        options: [
                            { text: "【开始研发】", cost: { wealth: 1000 }, effects: { attributes: { wisdom: 5 }, flag: 'unlock_pills_crafting' }, result_text: "经过多次尝试，你成功研发出几种成药，可以批量出售，为你带来了稳定的收入。" }
                        ]
                    },
                    {
                        title: "被人质疑",
                        desc: "一位病人在接受你的治疗后病情加重，其家属前来你的药庐大闹，声称你是“庸医”。",
                        options: [
                            { text: "【冷静分析，找出病因】", requirements: { wisdom: 90 }, effects: { attributes: { reputation: 20 } }, result_text: "你发现病人是因私下服用了与药方相冲的食物所致。真相大白后，你的名声反而更高了。" },
                            { text: "【赔钱道歉，息事宁人】", cost: { wealth: 500 }, effects: { attributes: { reputation: -10 } }, result_text: "你赔了500两，暂时平息了事端，但你的声誉受到了影响。" }
                        ]
                    },
                    {
                        title: "同行的合作请求",
                        desc: "一位男大夫在治疗一位疑难杂症病人时遇到瓶颈，私下前来向你请教。",
                        options: [
                            { text: "【倾囊相授】", effects: { attributes: { virtue: 5 }, npc_relationship: { npc_key: 'colleague_doctor', favor: 30, type: 'ally' } }, result_text: "你的慷慨赢得了对方的尊重，你们化敌为友，成为杏林佳话。" },
                            { text: "【有所保留】", effects: {}, result_text: "你指点了他几句，但保留了核心的医术。" }
                        ]
                    },
                    {
                        title: "编写医案",
                        desc: "你决定将自己治疗过的一些典型病例记录下来，整理成医案。",
                        options: [
                            { text: "【开始整理】", effects: { attributes: { wisdom: 5 }, core_resources: { yi_shu: 10 } }, result_text: "在整理医案的过程中，你温故而知新，医术又精进了不少。" }
                        ]
                    },
                    {
                        title: "预防时疫",
                        desc: "根据你的观察，今年夏秋之交可能会有疫病流行。",
                        options: [
                            { text: "【公开预警，并公布预防药方】", requirements: { virtue: 70 }, effects: { attributes: { reputation: 30, virtue: 10 } }, result_text: "你的预警和药方让许多人免受疫病之苦，你在民间的声望达到了顶峰。" },
                            { text: "【暗中储备相关药材】", requirements: { wisdom: 80 }, effects: { wealth: 2000 }, result_text: "疫病爆发后，药材价格飞涨，你大赚了一笔。" }
                        ]
                    },
// =================== 女医：第二幕新增事件 END ===================

                {
                    title: "产妇的求助",
                    desc: "一位产妇难产，情况危急，稳婆束手无策。",
                    options: [
                        { text: "【冒险进行外科手术】", getOutcome: (gs) => {
                            if((gs.career.core_resources.yi_shu || 0) > 120 && gs.player.attributes.wisdom > 100) {
                                return { text: "你成功地保住了母子平安，你的医术被传为神技！", effects: { attributes: { reputation: 50 }, core_resources: { yi_de: 20 } } };
                            }
                            return { text: "产妇死亡，你被其家人告上官府，陷入巨大危机。", effects: { flag: 'malpractice_lawsuit' } };
                        }}
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：遏制城西瘟疫",
                trigger: { career_level: 6, text_desc: "成为良医, 声望>500, 医德>300", condition: (gs) => gs.player.attributes.reputation > 500 && (gs.career.core_resources.yi_de || 0) > 300 },
                desc: "京城西区爆发了恐怖的瘟疫，官府将其彻底封锁，里面的人只能等死。你的医者之心，面临着生死抉择。",
                success: { text: "你成为了拯救了数万生命的城市英雄！皇帝亲自召见并赏赐你，官府特批你的药庐升级为京城最大的药局。你获得名号“济世神医”！", effects: { career_level_set: 7, attributes: { reputation: 200 }, core_resources: { yi_de: 100 }, wealth: 5000 } },
                failure: { text: "你或因感染瘟疫而死，或因无法控制疫情而心力交瘁，医术倒退，健康上限永久下降。", effects: { attributes: { health_max: -20 }, core_resources: { yi_shu: -20 } } }
            }
        },
        {
            title: "第三幕：一代神医",
            level_range: [8, 10],
            goal: "你的医术已是全国顶尖。你的影响力开始触及宫廷，你的目标是著书立说，传承医道，成为真正的医学权威。",
            events: [
                {
                    title: "被召入宫，为贵妃诊脉",
                    desc: "最受宠的贵妃患上“怪病”，太医院束手无策，你被秘密召入宫中。",
                    options: [
                        { text: "【全力诊治】", getOutcome: (gs) => ({
                            sub_decision: {
                                desc: "你发现贵妃并非生病，而是中了慢性毒药！你该如何是好？",
                                options: [
                                    { text: "【上报皇帝】", effects: { npc_relationship: { npc_key: 'emperor', favor: 30 } }, result_text: "你获得了皇帝的信任，但得罪了下毒的后宫势力。" },
                                    { text: "【只治病不说原因】", effects: { npc_relationship: { npc_key: 'consort', favor: 50 } }, result_text: "你保全了自身，获得了贵妃的绝对信任。" },
                                    { text: "【与下毒者交易】", effects: { wealth: 20000, core_resources: { yi_de: -100 } }, result_text: "你获得了巨大利益，但医德归零。" }
                                ]
                            }
                        })},
                        { text: "【称病推辞】", effects: {}, result_text: "你避开了巨大的风险，但也失去了进入宫廷的机会。" }
                    ]
                },
// =================== 女医：第三幕新增事件 START ===================
                    {
                        title: "改良古方",
                        desc: "你发现一张治疗心悸的古方用药霸道，对身体有损，决定对其进行改良。",
                        options: [
                            { text: "【花费数月，潜心研究】", effects: { attributes: { wisdom: 10 }, core_resources: { yi_shu: 20 } }, result_text: "你成功改良了药方，药效更佳，副作用更小，医术达到了新的境界。" }
                        ]
                    },
                    {
                        title: "军中疫情",
                        desc: "边关军中爆发疫情，朝廷向民间征召名医前往支援。",
                        options: [
                            { text: "【自告奋勇，前往边关】", requirements: { virtue: 100 }, effects: { attributes: { reputation: 80, health: -10 }, npc_relationship: { npc_key: 'general', favor: 60, type: 'ally' } }, result_text: "你不畏艰险前往边关，成功控制了疫情，赢得了全军将士的尊敬，并与当朝大将军结下深厚情谊。" },
                            { text: "【献上药方】", effects: { attributes: { reputation: 20 } }, result_text: "你献上了治疗疫情的药方，也为国家尽了一份力。" }
                        ]
                    },
                    {
                        title: "外族奇毒",
                        desc: "一位被外族刺客用奇毒所伤的重臣，被抬到了你的药庐前，已是奄奄一息。",
                        options: [
                            { text: "【以身试毒，研发解药】", requirements: { health: 90, wisdom: 120 }, effects: { core_resources: { yi_shu: 30 }, attributes: { reputation: 50, health: -20 } }, result_text: "你冒着生命危险，终于成功研发出解药，救活了重臣。你的医术被誉为“神技”。" },
                            { text: "【束手无策】", effects: { core_resources: { yi_shu: -10 } }, result_text: "你对这种奇毒束手无策，只能眼睁睁地看着重臣死去，这成了你行医生涯的一大遗憾。" }
                        ]
                    },
                    {
                        title: "皇帝的赏识",
                        desc: "你的名声传到了皇帝耳中，他欲赏赐你黄金千两，并封你为“御医”。",
                        options: [
                            { text: "【接受封赏，进入太医院】", effects: { change_profession: 'doctor', start_level: 4 }, result_text: "你的职业路径发生改变，成为太医院第一位女医官。" },
                            { text: "【谢绝封赏，只求为民治病】", effects: { attributes: { virtue: 20, reputation: 50 } }, result_text: "你的高风亮节被天下传颂，品德和声望达到顶峰。" }
                        ]
                    },
                    {
                        title: "无国界行医",
                        desc: "一位异国使臣恳求你随他回国，去治疗他们身患重病的国王。",
                        options: [
                            { text: "【慨然应允】", effects: { end_game: 'healer_abroad' }, result_text: "你决定将你的医术带往更远的地方。你的名字，将成为不同国度之间的和平桥梁。" },
                            { text: "【婉言谢绝】", effects: {}, result_text: "你选择留在这片生你养你的土地。" }
                        ]
                    },
// =================== 女医：第三幕新增事件 END ===================
                {
                    title: "太医院的挑战",
                    desc: "太医院院首，一位思想保守的老御医，公开挑战你，要求进行一场公开的“三局两胜”诊病比赛。",
                    options: [
                        { text: "【欣然应战】", getOutcome: (gs) => {
                            if ((gs.career.core_resources.yi_shu || 0) > 150) {
                                return { text: "你彻底征服了这些骄傲的男人，声望达到顶峰，太医院向你敞开大门。", effects: { attributes: { reputation: 100 }, social_favor: { group: 'imperial_doctors', change: 50 } } };
                            }
                            return { text: "你的名声受损，被认为是“野路子”。", effects: { attributes: { reputation: -30 } } };
                        }}
                    ]
                },
                {
                    title: "著书立说：《杏林医案》",
                    desc: "你决定将自己一生的行医经验和疑难杂症案例编撰成书。",
                    options: [
                        { text: "【开始编撰】", effects: { item: { id: 'xing_lin_yi_an', amount: 1 } }, result_text: "这是一个长期的项目。完成后，你将获得独一无二的[杏林医案]，装备后医术+10，该物品可被子嗣继承。" }
                    ]
                },
                {
                    title: "收授女徒，传承医道",
                    desc: "许多年轻女子因你而受到鼓舞，希望能拜你为师，学习医术。",
                    options: [
                        { text: "【顶住压力，开设女子医馆】", cost: { wealth: 10000 }, effects: { flag: 'unlock_disciple_system' }, result_text: "你开启了“弟子”系统，培养出的女弟子将在未来为你带来巨大的声望和人脉回报。这是一项足以改变历史的伟大事业。" }
                    ]
                },
                {
                    title: "“长生不老”的诱惑",
                    desc: "年迈的皇帝沉迷于道教，秘密召见你，命令你用你的医术为他炼制“长生丹”。",
                    options: [
                        { text: "【冒死直谏，阐述养生之道】", getOutcome: (gs) => {
                            if (gs.player.attributes.virtue > 150 && gs.player.attributes.wisdom > 120) {
                                return { text: "皇帝被你的正直和学识打动，放弃了荒谬的想法。你被尊为“国师”。", effects: { attributes: { reputation: 100 } } };
                            }
                            return { text: "龙颜大怒，你被打入天牢。", effects: { end_game: 'imprisoned' } };
                        }},
                        { text: "【用名贵药材炼制安慰剂】", cost: { item: 'bai_nian_ling_zhi', amount: 1 }, effects: { wealth: 20000 }, result_text: "你暂时糊弄了过去，获得了巨额赏赐，但谎言总有被揭穿的一天。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：杏林圣手",
                trigger: { career_level: 9, text_desc: "声望顶峰, 成功治愈过皇室核心成员", condition: (gs) => gs.player.attributes.reputation > 1000 && gs.flags.cured_royal_family },
                desc: "金銮殿上，皇帝面对所有大臣的反对，力排众议，亲自为你赐下官服。你将作为第一位女性，走进那座千百年来只有男人才能进入的殿堂——太医院。",
                success: { text: "你奇迹般地救活了重病的外国使臣，所有反对者哑口无言。皇帝亲自授予你“医官”之职，并赐予[太医院金牌]！你的人生，已成为不朽的传奇。", effects: { end_game_title: '杏林圣手', item: { id: 'tai_yi_yuan_jin_pai', amount: 1 } } },
                failure: { text: "救治失败，你虽不会被定罪，但将永远失去进入体制的机会，作为一位伟大的“民间神医”被人铭记。", effects: {} }
            }
        }
    ]
},

'spy_master': {
    name: "情报首领",
    icon: "fa-user-secret",
    gender: "female",
    core_resources: ["mi_tan", "qing_bao", "ying_xiang_li"],
    dashboard_name: "静语茶室",
    acts: [
        {
            title: "第一幕：蛛丝马迹",
            level_range: [1, 4],
            goal: "发展您的第一批核心密探，学会如何收集、甄别和利用基础情报，并完成第一次足以自保的“小型布局”。",
            events: [
                {
                    title: "一个“多嘴”的丫鬟",
                    desc: "您发现府里一个新来的小丫鬟，特别喜欢打听和传播各种小道消息。",
                    options: [
                        { text: "【严厉申斥，将其赶走】", effects: {}, result_text: "你消除一个隐患，但错过了一个人才。" },
                        { text: "【巧妙引导，收为己用】", getOutcome: (gs) => {
                            if(gs.player.attributes.charm > 50 && gs.player.attributes.wisdom > 50) {
                                return { text: "你成功地将她发展为你的第一位密探，擅长收集“流言”等级的情报。", effects: { core_resources: { mi_tan: 1 } } };
                            }
                            return { text: "她对你的动机产生怀疑，并在府内散播对你不利的谣言。", effects: { attributes: { reputation: -5 } } };
                        }}
                    ]
                },
// =================== 情报首领：第一幕新增事件 START ===================
                    {
                        title: "茶馆里的说书人",
                        desc: "你发现茶馆里的说书人，总能知道一些不为人知的官场秘闻。",
                        options: [
                            { text: "【将其发展为线人】", cost: { wealth: 300 }, effects: { core_resources: { mi_tan: 1 } }, result_text: "你成功将说书人发展为线人，他将为你提供源源不断的“流言”级情报。" },
                            { text: "【只是听书】", effects: { attributes: { wisdom: 1 } }, result_text: "你从他的故事里听到了一些有趣的信息。" }
                        ]
                    },
                    {
                        title: "破译密码",
                        desc: "你截获了一封密信，但上面写满了看不懂的符号。",
                        options: [
                            { text: "【尝试自行破译】", requirements: { wisdom: 70 }, effects: { attributes: { wisdom: 5 }, core_resources: { qing_bao: 5 } }, result_text: "经过一番推敲，你成功破译了密信，得知了某位官员的行程安排。" },
                            { text: "【寻求专业人士帮助】", cost: { wealth: 400 }, effects: { core_resources: { qing_bao: 5 } }, result_text: "你花钱请人破译了密信。" }
                        ]
                    },
                    {
                        title: "伪装与潜入",
                        desc: "你需要进入一场不对外开放的宴会，以探听消息。",
                        options: [
                            { text: "【伪装成侍女潜入】", requirements: { charm: 60, scheming: 50 }, effects: { core_resources: { qing_bao: 10 } }, result_text: "你成功潜入宴会，并听到了一个关于“盐铁专卖”的绝密消息。" },
                            { text: "【潜入失败】", effects: { attributes: { reputation: -5 } }, result_text: "你的伪装被识破，被当作闹事者赶了出去。" }
                        ]
                    },
                    {
                        title: "流言的威力",
                        desc: "你打算散播一则流言，来试探其影响力。",
                        options: [
                            { text: "【散播某官员好男风的流言】", effects: { core_resources: { ying_xiang_li: 5 }, attributes: { virtue: -3 } }, result_text: "流言很快传开，该官员焦头烂额，你初步见识到了情报的力量。" },
                            { text: "【散播某地有宝藏的流言】", effects: { wealth: 200 }, result_text: "许多人信以为真前去寻宝，你趁机在必经之路上卖水和干粮，赚了一笔。" }
                        ]
                    },
                    {
                        title: "第一次被“反侦察”",
                        desc: "你派出的密探在跟踪一个目标时，被对方发现并甩掉了。",
                        options: [
                            { text: "【意识到目标不简单】", effects: { attributes: { wisdom: 3 } }, result_text: "你意识到这个目标有很强的反侦察能力，需要更周密的计划。" },
                            { text: "【惩罚失手的密探】", effects: { core_resources: { mi_tan_loyalty: -10 } }, result_text: "你的惩罚让密探感到委屈，忠诚度下降。" }
                        ]
                    },
// =================== 情报首领：第一幕新增事件 END ===================
                {
                    title: "后巷的交易",
                    desc: "一位神秘的中间人联系你，声称有“好东西”要卖给你。",
                    options: [
                        { text: "【花费500两，购买一份[情报]】", cost: { wealth: 500 }, getOutcome: (gs) => {
                            if (Math.random() < 0.7) {
                                return { text: "你买到了一份真实的“秘闻”，例如某官员的贪腐证据。", effects: { core_resources: { qing_bao: 10 }, item: { id: 'tan_fu_xian_suo', amount: 1 } } };
                            }
                            return { text: "你买到了一份假情报，钱打水漂了。", effects: {} };
                        }},
                        { text: "【威胁对方，强索情报】", requirements: { martial: 40 }, getOutcome: (gs) => {
                            if (gs.player.attributes.martial > 60) {
                                return { text: "对方被你震慑，交出了情报。", effects: { core_resources: { qing_bao: 10 }, item: { id: 'tan_fu_xian_suo', amount: 1 } } };
                            }
                            return { text: "对方早有防备，你未能得手，并与该情报贩子结仇。", effects: {} };
                        }}
                    ]
                },
                {
                    title: "情报的价值",
                    desc: "你手中有一份关于“吏部侍郎喜爱古画”的流言。",
                    options: [
                        { text: "【将此情报卖给古董商人】", effects: { wealth: 300 }, result_text: "你轻松赚取了300两银子。" },
                        { text: "【亲自购买古画，投其所好】", cost: { wealth: 400 }, effects: { npc_relationship: { npc_key: 'li_bu_shi_lang', favor: 30 } }, result_text: "你成功地与吏部侍郎搭上了线，为未来铺下重要的人脉。" },
                        { text: "【与“侍郎政敌”交换另一份情报】", effects: { core_resources: { qing_bao: 5 } }, result_text: "你不花一分钱，换来了一份价值更高的“秘闻”。" }
                    ]
                },
                {
                    title: "建立安全屋",
                    desc: "你的情报活动需要一个安全的接头和储藏地点。",
                    options: [
                        { text: "【利用你的嫁妆铺子作为掩护】", effects: { flag: 'safehouse_set_shop' }, result_text: "足够安全，但如果铺子出事，你的情报网也会受到牵连。" },
                        { text: "【在城外购买一处偏僻的民宅】", cost: { wealth: 1000 }, effects: { flag: 'safehouse_set_remote' }, result_text: "更安全，但也更容易被官府注意到。" }
                    ]
                },
                {
                    title: "密探的危机",
                    desc: "你的一位密探在打探消息时，被目标察觉，身陷险境。",
                    options: [
                        { text: "【花费银两，疏通关系，将其捞出】", cost: { wealth: 1500 }, effects: { core_resources: { mi_tan_loyalty: 10 } }, result_text: "你救出了密探，该密探对你死心塌地。" },
                        { text: "【壮士断腕，切断所有联系】", effects: { core_resources: { mi_tan: -1, mi_tan_loyalty: -20 } }, result_text: "你保全了自己，但失去了这位密探，且其他密探的忠诚度普遍下降。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 I：一封信的威力",
                trigger: { career_level: 3, text_desc: "拥有至少3名密探，并掌握一份“秘闻”", condition: (gs) => (gs.career.core_resources.mi_tan || 0) >= 3 && (gs.career.core_resources.qing_bao || 0) >= 10 },
                desc: "你的丈夫（或家族某位男性亲属）在官场上被一个同僚处处打压。你决定在暗中用你手中的秘密，下一盘小小的棋。",
                success: { text: "该官员因私德不修被御史弹劾，灰溜溜地被贬斥。你的家族扫清了障碍，你首次体会到操纵他人命运的快感！", effects: { career_level_set: 4, core_resources: { ying_xiang_li: 50 }, attributes: { wisdom: 5 } } },
                failure: { text: "你的操作被识破，对方虽然受了些影响，但将你视为死敌，在未来会不惜一切代价报复你的家族。", effects: { flag: 'powerful_enemy_created' } }
            }
        },
        {
            title: "第二幕：织网之人",
            level_range: [5, 7],
            goal: "你的情报网已初具规模。你需要开始涉足更高层级的秘密，通过几次成功的“布局”在京城暗影中立威，并开始与其他情报势力进行交锋。",
            events: [
                {
                    title: "密探的晋升",
                    desc: "你的一位忠诚密探，有机会进入某个关键部门（如王府、兵部）当差。",
                    options: [
                        { text: "【投入巨资为其打点】", cost: { wealth: 5000 }, effects: { core_resources: { mi_tan: 1 } }, result_text: "你的密探成功“晋升”，能为你带来“绝密”等级的情报。" },
                        { text: "【认为风险太高而放弃】", effects: {}, result_text: "你选择稳妥，但也错失了良机。" }
                    ]
                },
// =================== 情报首领：第二幕新增事件 START ===================
                    {
                        title: "设立“鸽房”",
                        desc: "为了更快速、更隐秘地传递情报，你决定建立一个信鸽网络。",
                        options: [
                            { text: "【投入资金，开始训练】", cost: { wealth: 2000 }, effects: { flag: 'pigeon_network_established' }, result_text: "你成功建立了自己的信鸽网络，情报传递效率和安全性大幅提升。" }
                        ]
                    },
                    {
                        title: "情报市场的“黑市”",
                        desc: "你得知城中有一个地下的情报交易市场，三教九流汇集，真假消息难辨。",
                        options: [
                            { text: "【深入其中，寻找机会】", requirements: { wisdom: 100 }, effects: { core_resources: { qing_bao: 20 } }, result_text: "你凭借过人的智慧，在黑市中去伪存真，获得了一份关于“科举考题”的绝密情报。" },
                            { text: "【被假情报所骗】", effects: { wealth: -1000 }, result_text: "你花1000两买了一份假情报，蒙受了损失。" }
                        ]
                    },
                    {
                        title: "策反敌对密探",
                        desc: "你发现一位属于敌对势力的密探，似乎对他的主子心怀不满。",
                        options: [
                            { text: "【许以重利，将其策反】", cost: { wealth: 3000 }, effects: { core_resources: { mi_tan: 1 } }, result_text: "你成功策反了对方，他将成为你安插在敌人内部最重要的一颗棋子。" },
                            { text: "【这是一个陷阱】", requirements: { scheming: 90 }, effects: { attributes: { scheming: 5 } }, result_text: "你识破了对方的伪装，避免了损失。" }
                        ]
                    },
                    {
                        title: "制造“意外”",
                        desc: "一位掌握了你部分秘密的官员，即将被调往外地，可能会对你不利。",
                        options: [
                            { text: "【制造一场“马车失控”的意外】", requirements: { virtue: -20 }, effects: { flag: 'enemy_eliminated' }, result_text: "这位官员“意外”身亡，你的秘密被永远地埋葬了。但你的品德大幅下降。" },
                            { text: "【让他平安离去】", effects: {}, result_text: "你选择不冒风险，但也留下了一个未来的隐患。" }
                        ]
                    },
                    {
                        title: "来自同行的挑战",
                        desc: "京城另一股神秘的情报势力，开始在你的地盘上活动，并向你发出了挑战。",
                        options: [
                            { text: "【正面迎战，一较高下】", effects: { flag: 'start_spy_war' }, result_text: "一场无声的战争开始了。在接下来的几个回合里，你们将围绕一份重要情报展开激烈争夺。" },
                            { text: "【寻求合作】", requirements: { charm: 90 }, effects: { core_resources: { ying_xiang_li: 20 } }, result_text: "你成功说服了对方，化敌为友，共同瓜分了京城的情报市场。" }
                        ]
                    },
// =================== 情报首领：第二幕新增事件 END ===================
                {
                    title: "双面间谍",
                    desc: "你发现你的一位密探，同时也在为另一股势力（可能是某位皇子或权臣）工作。",
                    options: [
                        { text: "【秘密处决，以儆效尤】", effects: { core_resources: { mi_tan: -1, mi_tan_loyalty: 10 } }, result_text: "你巩固了内部的忠诚，但也损失了一名有价值的密探。" },
                        { text: "【将计就计，利用他传递假情报】", requirements: { wisdom: 120 }, getOutcome: (gs) => {
                            if (Math.random() < (gs.player.attributes.wisdom / 200)) { // 智慧越高成功率越高
                                return { text: "你成功地误导了你的竞争对手，在一次关键博弈中获得巨大优势。", effects: { core_resources: { ying_xiang_li: 30 } } };
                            }
                            return { text: "对方识破了你的计策，你的情报网受到重创。", effects: { core_resources: { mi_tan: -2, qing_bao: -20 } } };
                        }}
                    ]
                },
                {
                    title: "购买加密技术",
                    desc: "一位落魄的密码学者，声称发明了一种无人能破的“密码术”。",
                    options: [
                        { text: "【买下[密码本]】", cost: { wealth: 2000 }, effects: { item: { id: 'mi_ma_ben', amount: 1 } }, result_text: "你所有情报的安全性大幅提升，不易被对手截获。" },
                        { text: "【将学者软禁，供自己驱使】", effects: { attributes: { virtue: -10 }, flag: 'scholar_imprisoned' }, result_text: "你获得了持续的技术支持，但也做下了不义之举。" }
                    ]
                },
                {
                    title: "一场“意外”的火灾",
                    desc: "你需要销毁一份对你极为不利的证据，这份证据存放在某官员的书房里。",
                    options: [
                        { text: "【派遣密探潜入，制造火灾】", effects: { core_resources: { mi_tan_loyalty: -5 } }, result_text: "证据被销毁，但有几率“失手”导致火势过大，造成伤亡，引起官府彻查。" },
                        { text: "【通过人脉，调开官员再盗取】", cost: { core_resources: { ren_qing: 20 } }, effects: {}, result_text: "更安全，但需要消耗宝贵的人情。" }
                    ]
                },
                {
                    title: "投资“风月鉴”",
                    desc: "风月鉴的老鸨（红姨）遇到了资金困难。",
                    options: [
                        { text: "【注资成为其幕后股东】", cost: { wealth: 15000 }, effects: { flag: 'invest_in_brothel' }, result_text: "你获得了京城最大的情报集散地。风月鉴中的所有姑娘都将成为你的“信息节点”，为你源源不断地提供来自各阶层男人的秘密。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 II：布局朝堂",
                trigger: { career_level: 6, text_desc: "影响力>300，并掌握一份“绝密”情报", condition: (gs) => (gs.career.core_resources.ying_xiang_li || 0) > 300 && gs.inventory.some(item => item.id.includes('jue_mi')) },
                desc: "户部侍郎的职位因故出缺，太子和雍王都想安插自己的人上位。你决定亲自下场，推动一位对你最有利的人坐上那个位置。",
                success: { text: "你支持的人成功上位！你不仅获得了这位新任侍郎的绝对忠诚，更向所有政治势力展现了你的恐怖实力！", effects: { career_level_set: 7, core_resources: { ying_xiang_li: 200 }, flag: 'planted_official_in_ministry' } },
                failure: { text: "你的布局被识破或因意外失败。你和你支持的人都遭到了得势一方的残酷打压。", effects: { flag: 'powerful_enemy_created' } }
            }
        },
        {
            title: "第三幕：暗影女王",
            level_range: [8, 10],
            goal: "你的名字无人知晓，但你的力量无处不在。你不再满足于影响人事，而是要操纵国运，甚至决定龙椅上坐的是谁。",
            events: [
                {
                    title: "边关军情",
                    desc: "你的密探从敌国传回一份[敌军南侵计划]。",
                    options: [
                        { text: "【将情报匿名交给兵部】", effects: { attributes: { virtue: 50 } }, result_text: "帝国因此避免了一场大败。你拯救了无数人的性命。" },
                        { text: "【将情报卖给边关将领】", effects: { wealth: 30000, npc_relationship: { npc_key: 'border_general', favor: 80, type: 'ally' } }, result_text: "该将领因此大获全胜，成为你的死忠盟友，你在军方有了巨大的影响力。" },
                        { text: "【隐瞒情报，做空相关产业】", effects: { wealth: 100000, attributes: { virtue: -100 } }, result_text: "你获得了泼天的财富，但代价是无数人的鲜血。" }
                    ]
                },
// =================== 情报首领：第三幕新增事件 START ===================
                    {
                        title: "操控市场",
                        desc: "你提前得知了今年漕运将因天灾受阻的消息。",
                        options: [
                            { text: "【暗中囤积粮食，高价卖出】", effects: { wealth: 50000, attributes: { virtue: -30 } }, result_text: "你利用情报大发国难财，赚取了巨额利润，但品德大幅下降。" },
                            { text: "【将消息告知朝廷】", effects: { attributes: { reputation: 30, virtue: 20 } }, result_text: "朝廷因此提前做好了准备，避免了一场大饥荒。你积下了阴德。" }
                        ]
                    },
                    {
                        title: "扶持傀儡",
                        desc: "你打算在朝中扶持一位完全听命于你的官员。",
                        options: [
                            { text: "【选择一位有才但无背景的寒门子弟】", cost: { wealth: 20000 }, effects: { core_resources: { ying_xiang_li: 50 } }, result_text: "你花费巨资，成功将他推上了高位。从此，你在朝堂上有了自己的代言人。" }
                        ]
                    },
                    {
                        title: "邻国的情报网",
                        desc: "你发现邻国在你朝中布下了一张巨大的间谍网，意图窃取军机。",
                        options: [
                            { text: "【将其连根拔起，献给皇帝】", effects: { npc_relationship: { npc_key: 'emperor', favor: 80, type: 'ally' } }, result_text: "你为国家立下不世之功，获得了皇帝的绝对信任。" },
                            { text: "【接管这张网络，为己所用】", requirements: { scheming: 150 }, effects: { core_resources: { mi_tan: 10 } }, result_text: "你艺高人胆大，成功接管了这张网络，你的情报势力扩展到了国外。" }
                        ]
                    },
                    {
                        title: "一份足以改朝换代的密诏",
                        desc: "你的人从一位前朝老太监的故居中，发现了一份关于当今皇帝身世的惊天密诏！",
                        options: [
                            { text: "【交给一位有野心的皇子】", effects: { flag: 'trigger_civil_war' }, result_text: "天下将因此大乱，但你支持的皇子若能成功，你将成为新王朝的“从龙之功”第一人。" },
                            { text: "【永远销毁这份密诏】", effects: { attributes: { virtue: 50 } }, result_text: "你为了天下苍生，亲手销毁了这份足以颠覆一切的密诏。" }
                        ]
                    },
                    {
                        title: "被遗忘的名字",
                        desc: "你决定为自己准备最终的退路。",
                        options: [
                            { text: "【开始抹去自己存在过的所有痕迹】", effects: { end_game: 'vanished_queen' }, result_text: "这是一个漫长的过程。成功后，你将彻底从这个世界上“消失”，成为一个只存在于传说中的影子。" }
                        ]
                    },
// =================== 情报首领：第三幕新增事件 END ===================
                {
                    title: "废立太子的阴谋",
                    desc: "你发现一位深受皇帝宠信的妃子与外臣勾结，意图构陷太子，扶持自己的儿子上位。",
                    options: [
                        { text: "【帮助太子，揭发阴谋】", effects: { flag: 'support_crown_prince' }, result_text: "你保住了国本。太子登基后，你的家族将获得“从龙之功”，享受百年富贵。" },
                        { text: "【帮助妃子，推波助澜】", effects: { flag: 'support_rebel_prince' }, result_text: "一场高风险的政治投资。成功则你将成为新皇帝背后真正的“影子内阁”。" }
                    ]
                },
                {
                    title: "刺客组织的接触",
                    desc: "江湖上最顶尖的刺客组织，希望能与你合作，他们出人，你出情报。",
                    options: [
                        { text: "【接受合作】", effects: { flag: 'unlock_assassination', attributes: { virtue: -20 } }, result_text: "你解锁了“物理清除”选项，可以悄无声息地让你的敌人“意外”死亡。" },
                        { text: "【拒绝并将其剿灭】", effects: { attributes: { virtue: 30 } }, result_text: "你动用你的情报网和官府力量，端掉了这个组织，获得了巨大的正面声望。" }
                    ]
                },
                {
                    title: "培养继承人",
                    desc: "你需要为这个庞大的地下王国，寻找一位继承者。",
                    options: [
                        { text: "【从你的子女中挑选】", effects: { flag: 'start_heir_training_spy' }, result_text: "你开启“继承人培养”模式，你需要教导TA情报技巧和权谋之术。" },
                        { text: "【从最忠诚的密探中提拔】", effects: {}, result_text: "你的组织将更加专业化，但也脱离了家族的掌控。" }
                    ]
                },
                {
                    title: "金盆洗手，归于平静",
                    desc: "你厌倦了这一切，渴望回归普通人的生活。",
                    options: [
                        { text: "【开始布局“假死”脱身】", effects: { end_game: 'faked_death' }, result_text: "你开启了终极的“金蝉脱壳”计划。成功后，你将携带着巨额财富远走高飞，获得真正的自由。" },
                        { text: "【解散组织，销毁所有情报】", effects: { end_game: 'peaceful_retirement' }, result_text: "你亲手埋葬了这个庞大的帝国，回归为一个普通的贵妇，安度余生。" }
                    ]
                }
            ],
            milestone_event: {
                title: "人生转折点 III：天下为棋",
                trigger: { career_level: 10, text_desc: "影响力顶峰，并深度参与储位之争", condition: (gs) => (gs.career.core_resources.ying_xiang_li || 0) > 1000 && (gs.flags.support_crown_prince || gs.flags.support_rebel_prince) },
                desc: "老皇帝驾崩，京城戒严。所有势力的动向都以信鸽和密报的形式，源源不断地汇集到你的手中。你，就是这场决定天下归属的棋局中，唯一的上帝。",
                success: { text: "你支持的皇子成功登基！新皇的所有重大决策，都需要先秘密征求你的意见。你手持[皇帝的秘密信物]，成为帝国真正的“无冕之王”！", effects: { end_game_title: '无冕之王', item: {id: 'huang_di_mi_mi_xin_wu', amount: 1} } },
                failure: { text: "你的布局棋差一着，满盘皆输。新皇登基后，你的整个网络被连根拔起，等待你的，将是帝国机器最残酷的清洗。", effects: { end_game: 'execution' } }
            }
        }
    ]
}
};
// --- UTILITY: Logging ---
function logEvent(content, isYear = false) {
    if (!gameState.log) gameState.log = [];
    const ageDisplay = `${Math.floor(gameState.player.age)}岁${gameState.date.turn === 1 ? '上半年' : '下半年'}`;
    const dateStamp = isYear ? `${content}` : `${ageDisplay}: ${content}`;
    gameState.log.unshift({ content: dateStamp, isYear });
    if (gameState.log.length > 200) gameState.log.pop();
}

// --- DATA: Unique Names & Personalities ---
const nameData = {
    surnames: ["沈", "卫", "秦", "崔", "裴", "谢", "萧", "顾", "傅", "温", "慕容", "上官", "欧阳", "司徒", "赫连", "尉迟", "闻人", "端木", "百里", "公孙", "拓跋", "轩辕", "令狐", "皇甫", "宇文", "长孙", "元", "程", "狄", "燕", "纪", "席", "庄", "容", "霍", "岑", "喻", "莫", "戚", "苏", "陆", "柳", "唐", "宋", "姜", "范", "薛", "韩", "冯", "周", "吴", "郑", "黄", "毛", "赵", "孙", "简", "阮", "江", "孟", "梁", "魏", "白", "袁"],
    girlNames: ["静姝", "芷兮", "云初", "清晏", "思润", "昭华", "语堂", "佩玖", "瑾瑜", "灵犀", "瑶光", "锦瑟", "凝香", "惜澜", "挽风", "知画", "若渝", "青梧", "扶苏", "未央", "卿尘", "流萤", "碧落", "棠华", "徽音", "剪秋", "玉茗", "檀樱", "扶光", "怀信", "知微", "含章", "佩环", "归燕", "婉清", "月瑶", "思韵", "若雪", "语嫣", "诗涵", "梦洁", "静璇", "芷若", "晴雪", "初云", "依诺", "采薇", "青黛", "暮雪", "寻阳", "念真", "染霜", "倾城", "安歌", "书兰", "画意", "听雪", "枕琴", "攸宁", "南絮", "朝露"],
    boyNames: ["修远", "子谦", "景行", "伯庸", "望舒", "逾明", "亦诚", "秉君", "怀瑾", "思衡", "昭华", "君临", "清和", "弈辰", "风朔", "墨言", "玄戈", "玉衡", "景琰", "长庚", "无咎", "秉烛", "青阳", "书逸", "怀安", "知节", "云澈", "柏舟", "观南", "承稷", "去病", "惊鸿", "慕白", "辞九", "浩然", "星河", "瑾瑜", "子墨", "逸轩", "凌云", "承恩", "知行", "敬亭", "云帆", "致远", "守拙", "思齐", "临渊", "秉文", "溯光", "佩璋", "玄策", "书恒", "景辞", "应酌", "青山", "南浦", "扶风", "之舟", "世章"]
};
const personalityTraits = {
    positive: ["温柔", "聪慧", "内敛", "活泼", "端庄", "坚韧", "善良", "敏锐", "谨慎", "乐观", "果敢", "清冷", "洒脱"],
    negative: ["叛逆", "腹黑", "多疑", "自负", "善妒", "现实", "凉薄"]
};

// 【新增】随机立绘库 (请在此处替换为您自己的图片链接)
// [替换] 请用这个完整的代码块替换您文件中现有的 avatarPools 对象
const avatarPools = {
    male: [
        'https://i.pravatar.cc/150?u=a042581f4e29026704d',
        'https://i.pravatar.cc/150?u=a042581f4e29026705d',
        'https://i.pravatar.cc/150?u=a042581f4e29026706d',
        'https://i.pravatar.cc/150?u=a042581f4e29026707d',
        'https://i.pravatar.cc/150?u=a042581f4e29026708d'
    ],
    female: [
        'https://i.pravatar.cc/150?u=a042581f4e29026709d',
        'https://i.pravatar.cc/150?u=a042581f4e2902670ad',
        'https://i.pravatar.cc/150?u=a042581f4e2902670bd',
        'https://i.pravatar.cc/150?u=a042581f4e2902670cd',
        'https://i.pravatar.cc/150?u=a042581f4e2902670dd'
    ]
};
// --- DATA: Financial Tiers (As per detailed specification) ---
// --- DATA: Family & Social ---
const familyTemplates = [
    { title: "礼部尚书", surname: "裴", reputation: 70, wealth: 8000, color: "#8e44ad", annualIncome: 2400 },
    { title: "安国公", surname: "卫", reputation: 90, wealth: 15000, color: "#c0392b", annualIncome: 4000 },
    { title: "大理寺卿", surname: "秦", reputation: 65, wealth: 6000, color: "#2980b9", annualIncome: 2000 },
    { title: "翰林学士", surname: "谢", reputation: 60, wealth: 5000, color: "#27ae60", annualIncome: 1600 },
    { title: "忠武将军", surname: "萧", reputation: 85, wealth: 10000, color: "#d35400", annualIncome: 3000 }
];
const suitorBackgrounds = [ // Male suitors for female protagonist
    { desc: "太傅之孙，温润如玉，才华横溢。", family: 90, attributes: {talent: 85, charm: 88, wisdom: 82}, color: '#4169e1', personality: "温柔" },
    { desc: "将军之子，英武不凡，忠勇果敢。", family: 75, attributes: {talent: 65, charm: 78, martial: 80}, color: '#c0392b', personality: "果敢" },
    { desc: "皇商独子，富可敌国，精明机敏。", family: 80, attributes: {talent: 70, charm: 82, wisdom: 90}, color: '#27ae60', personality: "敏锐" },
    { desc: "闲散王爷，风流倜傥，擅长丹青。", family: 95, attributes: {talent: 80, charm: 92, etiquette: 75}, color: '#8e44ad', personality: "活泼" },
    { desc: "国子监学子，清雅脱俗，诗才卓绝。", family: 60, attributes: {talent: 90, charm: 80, wisdom: 85}, color: '#3498db', personality: "清冷" }
];
const ladyBackgrounds = [ // Female suitors for male protagonist
    { desc: "丞相嫡女，蕙质兰心，才貌双全。", family: 95, attributes: {talent: 85, charm: 90, etiquette: 92}, color: '#e06c9e', personality: "端庄" },
    { desc: "将军之女，巾帼英姿，不让须眉。", family: 80, attributes: {talent: 70, charm: 82, martial: 70}, color: '#c0392b', personality: "活泼" },
    { desc: "江南首富千金，精通商道，娇俏可人。", family: 85, attributes: {talent: 75, charm: 88, wisdom: 85}, color: '#27ae60', personality: "聪慧" },
    { desc: "太医独女，温柔娴静，精通医理。", family: 65, attributes: {talent: 80, charm: 85, wisdom: 88}, color: '#3cb371', personality: "温柔" },
    { desc: "书香门第小姐，知书达理，温婉可人。", family: 70, attributes: {talent: 90, charm: 80, etiquette: 85}, color: '#6a9ac9', personality: "内敛" }
];

// --- DATA: Career ---
const careerPaths = {
    male: {
        civilian: { // 对应'文官'
            name: "文官", icon: "fa-feather-alt",
            levels: [
                { title: "童生", salary: 400, req: { wisdom: 20 }, promotion_points: 100 },
                { title: "秀才", salary: 1000, req: { wisdom: 40 }, promotion_points: 120 },
                { title: "举人", salary: 2000, req: { wisdom: 60, virtue: 40 }, promotion_points: 150 },
                { title: "进士", salary: 4000, req: { wisdom: 85, etiquette: 60 }, promotion_points: 200 },
                { title: "翰林院编修", salary: 6000, req: { wisdom: 100, talent: 80 }, promotion_points: 250 },
                { title: "六部主事", salary: 10000, req: { wisdom: 120, virtue: 80 }, promotion_points: 300 },
                { title: "郎中", salary: 16000, req: { wisdom: 140, charm: 100 }, promotion_points: 400 },
                { title: "侍郎", salary: 24000, req: { wisdom: 160, virtue: 120 }, promotion_points: 500 },
                { title: "尚书", salary: 40000, req: { wisdom: 180, reputation: 500 }, promotion_points: 700 },
                { title: "内阁大学士", salary: 60000, req: { wisdom: 200, virtue: 150, reputation: 1000 }, promotion_points: Infinity }
            ]
        },
        warrior: { // 对应'武将'
            name: "武将", icon: "fa-shield-alt",
            levels: [
                { title: "武童生", salary: 600, req: { health: 30, martial: 20 }, promotion_points: 100 },
                { title: "武秀才", salary: 1200, req: { health: 50, martial: 40 }, promotion_points: 120 },
                { title: "武举人", salary: 2400, req: { health: 70, martial: 60 }, promotion_points: 150 },
                { title: "武进士", salary: 5000, req: { health: 85, martial: 80 }, promotion_points: 200 },
                { title: "御前侍卫", salary: 8000, req: { health: 100, martial: 100, virtue: 60 }, promotion_points: 250 },
                { title: "营千总", salary: 12000, req: { health: 120, martial: 120 }, promotion_points: 300 },
                { title: "守备", salary: 18000, req: { health: 140, martial: 140 }, promotion_points: 400 },
                { title: "都司", salary: 26000, req: { health: 160, martial: 160 }, promotion_points: 500 },
                { title: "总兵", salary: 44000, req: { health: 180, martial: 180, reputation: 600 }, promotion_points: 700 },
                { title: "大都督", salary: 70000, req: { health: 200, martial: 200, reputation: 1200 }, promotion_points: Infinity }
            ]
        },
        merchant: { // 对应'商贾'
            name: "商贾", icon: "fa-store-alt",
            levels: [
                { title: "学徒", salary: 200, req: { wisdom: 10 }, promotion_points: 100 },
                { title: "账房", salary: 800, req: { wisdom: 30 }, promotion_points: 120 },
                { title: "管事", salary: 1600, req: { wisdom: 50, charm: 40 }, promotion_points: 150 },
                { title: "掌柜", salary: 3000, req: { wisdom: 70, charm: 60 }, promotion_points: 200 },
                { title: "分行东家", salary: 6000, req: { wisdom: 90, charm: 80, reputation: 100 }, promotion_points: 300 },
                { title: "总行东家", salary: 20000, req: { wisdom: 120, charm: 100, reputation: 500 }, promotion_points: 500 },
                { title: "皇商", salary: 100000, req: { wisdom: 150, charm: 120, reputation: 1000 }, promotion_points: Infinity }
            ]
        },
        scholar: { // 对应'文人墨客'
            name: "文人墨客", icon: "fa-paint-brush",
            levels: [
                { title: "无名书生", salary: 100, req: { talent: 20 }, promotion_points: 100 },
                { title: "小有名气", salary: 400, req: { talent: 40 }, promotion_points: 150 },
                { title: "知名书生", salary: 1000, req: { talent: 70, reputation: 50 }, promotion_points: 200 },
                { title: "金陵才子", salary: 2000, req: { talent: 100, charm: 80 }, promotion_points: 300 },
                { title: "名动京华", salary: 4000, req: { talent: 120, reputation: 200 }, promotion_points: 400 },
                { title: "大家", salary: 8000, req: { talent: 150, wisdom: 120, reputation: 500 }, promotion_points: 600 },
                { title: "一代宗师", salary: 16000, req: { talent: 180, virtue: 100, reputation: 1000 }, promotion_points: Infinity }
            ]
        },
        ranger: { // 对应'江湖游侠'
            name: "江湖游侠", icon: "fa-khanda",
            levels: [
                { title: "初出茅庐", salary: 300, req: { martial: 30 }, promotion_points: 100 },
                { title: "薄有侠名", salary: 800, req: { martial: 60 }, promotion_points: 150 },
                { title: "黑风克星", salary: 1600, req: { martial: 90, health: 80 }, promotion_points: 200 },
                { title: "名动一方", salary: 3000, req: { martial: 120, reputation: 300 }, promotion_points: 300 },
                { title: "武林高手", salary: 6000, req: { martial: 150, wisdom: 80 }, promotion_points: 500 },
                { title: "一代大侠", salary: 12000, req: { martial: 180, virtue: 120, reputation: 800 }, promotion_points: 700 },
                { title: "武林神话", salary: 20000, req: { martial: 200, reputation: 1500 }, promotion_points: Infinity }
            ]
        }
    },
    female: {
        matron: {
            name: "主母", icon: "fa-chess-queen",
            levels: [
                { title: "新妇", salary: 150, req: { etiquette: 30 }, promotion_points: 100 },
                { title: "管事媳妇", salary: 500, req: { wisdom: 50 }, promotion_points: 150 },
                { title: "当家主母", salary: 1200, req: { virtue: 80 }, promotion_points: 200 },
                { title: "一品诰命", salary: 3000, req: { reputation: 500 }, promotion_points: Infinity }
            ]
        },
        embroiderer: {
            name: "绣娘", icon: "fa-cut",
            levels: [
                { title: "绣坊学徒", salary: 160, req: { talent: 30 }, promotion_points: 100 },
                { title: "绣娘", salary: 500, req: { talent: 60 }, promotion_points: 150 },
                { title: "掌柜", salary: 1200, req: { talent: 100, wisdom: 50 }, promotion_points: 250 },
                { title: "织造大家", salary: 2400, req: { talent: 150, reputation: 300 }, promotion_points: 350 },
                { title: "一品御商", salary: 5000, req: { talent: 200, reputation: 800 }, promotion_points: Infinity }
            ]
        },
        doctor: {
            name: "女医", icon: "fa-clinic-medical",
            levels: [
                { title: "医馆学徒", salary: 160, req: { wisdom: 30 }, promotion_points: 100 },
                { title: "医女", salary: 500, req: { wisdom: 60, virtue: 40 }, promotion_points: 150 },
                { title: "坐堂女医", salary: 1200, req: { wisdom: 100, reputation: 100 }, promotion_points: 250 },
                { title: "杏林名手", salary: 2400, req: { wisdom: 150, reputation: 300 }, promotion_points: 350 },
                { title: "太医院医官", salary: 5000, req: { wisdom: 200, reputation: 800 }, promotion_points: Infinity }
            ]
        },
        spy_master: {
            name: "情报首领", icon: "fa-user-secret",
            levels: [
                { title: "茶楼侍女", salary: 200, req: { charm: 30 }, promotion_points: 100 },
                { title: "情报贩子", salary: 600, req: { wisdom: 60 }, promotion_points: 150 },
                { title: "织网之人", salary: 1600, req: { wisdom: 100, charm: 70 }, promotion_points: 250 },
                { title: "暗影之主", salary: 4000, req: { wisdom: 150, reputation: 400 }, promotion_points: 350 },
                { title: "无冕之王", salary: 10000, req: { wisdom: 200, reputation: 1000 }, promotion_points: Infinity }
            ]
        }
    }
};
// --- DATA: Health & Medical ---
const diseases = {
    'common_cold': { name: "伤寒", severity: 'mild', duration: 4, health_decline: 2, treatment_cost: 30, initial_cure_chance: 0.95, death_chance: 0 },
    'malaria': { name: "疟疾", severity: 'mild', duration: 6, health_decline: 3, treatment_cost: 50, initial_cure_chance: 0.90, death_chance: 0 },
    'plague': { name: "时疫", severity: 'severe', duration: 8, health_decline: 15, treatment_cost: 800, initial_cure_chance: 0.50, death_chance: 0.05 },
    'smallpox': { name: "天花", severity: 'critical', duration: 10, health_decline: 20, treatment_cost: 1500, initial_cure_chance: 0.20, death_chance: 0.20 },
    'tuberculosis': { name: "肺痨", severity: 'critical', duration: 12, health_decline: 12, treatment_cost: 1200, initial_cure_chance: 0.30, death_chance: 0.20 },
    'syphilis': { name: "梅病", severity: 'critical', duration: 20, health_decline: 8, treatment_cost: 1000, initial_cure_chance: 0.40, death_chance: 0.20, source: 'intimate' }
};

const famousDoctors = [
    { name: "华佗", fee: 1000, success_rate_bonus: 0.30, desc: "外科圣手，刮骨疗毒。" },
    { name: "张仲景", fee: 700, success_rate_bonus: 0.20, desc: "医中之圣，善治伤寒。" },
    { name: "孙思邈", fee: 600, success_rate_bonus: 0.18, desc: "药王，精通养生。" },
    { name: "李时珍", fee: 500, success_rate_bonus: 0.15, desc: "本草纲目，识尽天下药。" },
    { name: "普通郎中", fee: 100, success_rate_bonus: 0, desc: "城中坐堂大夫，经验尚可。" }
];

// --- DATA: Events & Interactions ---
const marketItems = {
    female: [
        { id: 'silk_dress', name: '云锦连衣裙', price: 800, effect: { charm: 8, etiquette: 3 }, desc: '华美异常，能极大提升你的魅力与气质。' },
        { id: 'pearl_hairpin', name: '珍珠发簪', price: 450, effect: { charm: 5, etiquette: 2 }, desc: '温润的珍珠衬托出你典雅的气质。' },
        { id: 'ancient_qin', name: '名家琴谱', price: 600, effect: { talent: 7 }, desc: '一本失传的古琴谱，能极大启发你的才情。' }
    ],
    male: [
        { id: 'fine_sword', name: '龙泉宝剑', price: 1200, effect: { martial: 8 }, desc: '削铁如泥的宝剑，是习武之人的最爱。' },
        { id: 'war_strategy_book', name: '兵法要略', price: 750, effect: { wisdom: 7, martial: 2 }, desc: '一部兵法奇书，助你运筹帷幄。' },
        { id: 'good_wine', name: '杜康佳酿', price: 300, desc: '一壶绝世佳酿，是结交朋友的利器。 (可用于赠礼)' }
    ],
    common: [
        { id: 'ginseng', name: '百年人参', price: 1500, effect: { health: 15 }, desc: '大补元气的珍贵药材，危急时刻可吊命。' },
        { id: 'antique_vase', name: '前朝花瓶', price: 2500, type: 'collectible', baseAppreciation: 0.01, currentValue: 2500, purchasePrice: 2500, desc: '一件雅致的古董，可收藏增值。' },
        { id: 'famous_painting', name: '名家字画', price: 4000, type: 'collectible', baseAppreciation: 0.02, currentValue: 4000, purchasePrice: 4000, desc: '一幅传世画作，颇具收藏价值。' },
    ]
};
const restaurantMenu = [
    { id: 'tea', name: '雨前龙井', price: 10, effect: { health: 1 }, desc: '一杯清茶，神清气爽。' },
    { id: 'dimsum', name: '桂花糖糕', price: 25, effect: { charm: 1 }, desc: '甜糯的点心，心情愉悦。'},
    { id: 'meal', name: '四方食盒', price: 50, effect: { health: 2, charm: 1 }, desc: '精致的菜肴，一饱口福。'},
{ id: 'banquet', name: '琼林盛宴', price: 200, effect: { charm: 2, etiquette: 2 }, desc: '宴请宾客的上佳之选。' },
{ id: 'golden_fries', name: '黄金薯条', price: 3000, effect: { performance: 20, talent: 10, martial: 10 }, desc: '神秘的异域美食，蕴含着奇特的力量。' }
];
const wishingWellItems = [
    { id: 'beauty_fruit', name: '朱颜果', effect: { charm: 30 }, desc: '传说中的仙果，食之可令容颜焕发，魅力大增。' },
    { id: 'wisdom_spring', name: '智慧泉', effect: { wisdom: 30 }, desc: '饮下此泉水，便能茅塞顿开，智慧超群。' },
    { id: 'longevity_peach', name: '长寿桃', effect: { health: 30 }, desc: '仙池边的蟠桃，能祛病延年，身强体健。' },
    { id: 'career_charm', name: '晋升符', effect: { career_progress: 50 }, desc: '一道神秘的符咒，能助你在事业上取得进展。' },
    { id: 'love_knot', name: '声望卡', effect: { reputation: 30 }, desc: '可让你家喻户晓，是升职条件的必备之选。' }
];

const romanticEvents = [
    "TA带你去了城郊的一片桃花林，风吹过，花瓣如雨，落在你们的发间。", "你们在月下泛舟，TA为你轻声吟唱了一首情诗，湖面波光粼粼，映着你们的身影。",
    "TA在庙会为你赢得了一支精致的珠钗，亲手为你簪上。", "下雨天，你们共撑一把油纸伞，在青石板路上缓缓走着，肩膀几乎靠在一起。",
    "TA说你笑起来的时候，眼睛里像有星星。", "你们在茶楼听书，讲到动情处，TA悄悄握住了你的手。",
    "TA记得你不爱吃葱，每次都会细心地帮你挑出来。", "你生了一场小病，TA日夜守在你床前，为你端茶送药。",
    "TA为你画了一幅肖像，说要把你最美的样子记下来。", "你遇到危险时，TA毫不犹豫地挡在了你的身前。",
    "TA偷偷为你准备了一场烟火，绚烂的烟花下，TA的眼眸比烟火更亮。"
];
const husbandInteractionEvents = [
    { favor_change: 2, text: '你与夫君月下对酌，相谈甚欢，只觉岁月静好。' },
    { favor_change: 3, text: '夫君谈及公务上的烦心事，你温言软语地开解他，他眼中满是感激。' },
    { favor_change: 1, text: '你为夫君整理书房，他看到后，笑着夸你贤惠。' },
    { favor_change: 5, text: '夫君外出归来，特地为你带了你最爱吃的桂花糕，你心中一暖。' }
];
const wifeInteractionEvents = [
    { favor_change: 2, text: '你与夫人在花园中散步，她为你簪上一朵刚摘的鲜花。' },
    { favor_change: 3, text: '夫人为你缝制的衣袍送到了，针脚细密，满含情意。' },
    { favor_change: 1, text: '你处理完公务回到房中，发现夫人已为你备好热茶点心。' },
    { favor_change: 5, text: '你为夫人买了一支她心仪已久的珠钗，她喜不自胜。' }
];

// --- DATA: Children & Cultivation ---
const childPersonalityEvents = {
     '1': {
        title: "周岁抓周",
        desc: "在你的周岁宴上，父母将各种物品摆在面前，让你抓取。",
        options: [
            { text: "抓了书本，看来将来是个读书的料。", trait: "聪慧", effects: { attributes: { wisdom: 5 } } },
            { text: "抓了算盘，看来对数字很敏感。", trait: "敏锐", effects: { attributes: { wisdom: 5 } } },
            { text: "抓了玉佩，似有君子之风。", trait: "端庄", effects: { attributes: { etiquette: 5 } } },
            { text: "抓了木剑，看来是个活泼好动的孩子。", trait: "活泼", effects: { attributes: { martial: 5 } } }
        ]
    },
    '5': {
        title: "初入蒙学",
        desc: "你的孩子初入蒙学，面对陌生的环境和同学，TA有些不知所措。",
        options: [
            { text: "你鼓励TA主动结交新朋友。", trait: "乐观", effects: { attributes: { charm: 5 } } },
            { text: "你教导TA要谦逊有礼，不与人争吵。", trait: "内敛", effects: { attributes: { etiquette: 5 } } },
            { text: "你让TA将家中点心分给同学。", trait: "善良", effects: { attributes: { virtue: 5 } } }
        ]
    },
    '7': {
        title: "课堂风波",
        desc: "你的孩子在课堂上因一篇课文与同学产生了激烈的争执。",
        options: [
            { text: "鼓励TA坚持自己的观点，但要讲究方法。", trait: "果敢", effects: { attributes: { wisdom: 5 } } },
            { text: "让TA向同学道歉，以和为贵。", trait: "内敛", effects: { attributes: { virtue: 5 } } },
            { text: "调查争执的起因，找出真相。", trait: "敏锐", effects: { attributes: { wisdom: 5 } } }
        ]
    },
    '10': {
        title: "少年心事",
        desc: "你的孩子最近似乎心事重重，经常独自一人发呆。",
        options: [
            { text: "耐心地询问TA的心事。", trait: "温柔", effects: { favor: 10 } },
            { text: "带TA去郊外游玩，放松心情。", trait: "乐观", effects: { attributes: { health: 5, charm: 5 } } },
            { text: "交给老师，让老师去开导。", trait: "现实", effects: { favor: -5 } }
        ]
    },
    '12': {
        title: "才艺抉择",
        desc: "你的孩子在琴棋书画和武学之间，不知如何选择。",
        options: [
            { text: "鼓励TA学习琴棋书画，提升才情。", trait: "聪慧", effects: { attributes: { talent: 5 } } },
            { text: "鼓励TA修习武学，强身健体。", trait: "武勇", effects: { attributes: { martial: 5 } } },
            { text: "让TA自己选择，尊重TA的意愿。", trait: "独立", effects: { favor: 10 } }
        ]
    },
    '14': {
        title: "朋友之义",
        desc: "你的孩子的朋友被人欺负，TA想为朋友出头，但又担心惹麻烦。",
        options: [
            { text: "支持TA为朋友出头，彰显侠义。", trait: "坚韧", effects: { attributes: { martial: 5, virtue: 5 } } },
            { text: "劝说TA寻求大人的帮助，避免不必要的冲突。", trait: "谨慎", effects: { attributes: { wisdom: 5 } } },
            { text: "不插手，让TA自己处理。", trait: "独立", effects: { favor: 5 } }
        ]
    },
    '16': {
        title: "及笄/冠礼",
        desc: "你的孩子已到及笄/冠礼之年，你为TA举办了隆重的仪式。",
        options: [
            { text: "提醒TA要时刻注意言行，成为家族的表率。", trait: "端庄", effects: { attributes: { etiquette: 5, virtue: 5 } } },
            { text: "鼓励TA勇敢追求自己的理想，不被世俗所拘。", trait: "洒脱", effects: { attributes: { charm: 5, talent: 5 } } },
            { text: "询问TA对未来的规划，给予支持。", trait: "敏锐", effects: { attributes: { wisdom: 5 } } }
        ]
    },
    '18': {
        title: "成人之礼",
        desc: "你的孩子已经成年，你决定给TA一笔钱，让TA自己去闯荡。",
        options: [
            { text: "给予大笔钱财，让TA衣食无忧。", trait: "现实", effects: { wealth: 1000, favor: 10 } },
            { text: "给予少量钱财，让TA自己去奋斗。", trait: "坚韧", effects: { wealth: 200, favor: 5 } },
            { text: "鼓励TA留在家中，继承家业。", trait: "传统", effects: { favor: 15 } }
        ]
    }
};
// ===================== 【新功能】子女成长事件库 =====================
// ===================== 【新功能】子女成长事件库 =====================
const CHILD_LIFE_EVENTS = {
    6: [
        { id: 'first_day_school', title: '开蒙之日', desc: '你的孩子 {childName} 到了开蒙的年纪，你送TA去了学堂。第一天回来后，TA看起来...', options: [
            { text: '兴高采烈，说交到了新朋友。', effects: { charm: 2, favor: 5 }, log: '{childName}展现了良好的社交能力。' },
            { text: '有些沮丧，说功课太难了。', effects: { wisdom: -1, health: -1 }, log: '{childName}似乎对学业有些畏难情绪。' },
            { text: '与人争执，衣服都弄脏了。', effects: { martial: 1, etiquette: -2 }, log: '{childName}性格似乎有些好斗。' }
        ]}
    ],
    7: [
        { id: 'found_pet', title: '偶遇灵宠', desc: '孩子 {childName} 从外面抱回来一只受伤的小动物，眼神期盼地看着你，希望可以收养它。', options: [
            { text: '【同意收养】并一同医治。', effects: { virtue: 3, favor: 10 }, log: '你和孩子一同照料小动物，培养了TA的爱心。' },
            { text: '【严厉拒绝】认为玩物丧志。', effects: { virtue: -2, favor: -5 }, log: '你拒绝了孩子的请求，TA看起来很难过。' },
            { text: '【教导知识】告诉TA如何处理。', effects: { wisdom: 2, virtue: 1 }, log: '你借此机会教导了孩子相关的知识。' }
        ]}
    ],
    8: [
        { id: 'bully_incident', title: '学堂纷争', desc: '你听说孩子 {childName} 在学堂被高年级的孩子欺负了。', options: [
            { text: '【教TA打回去】男子汉不能受欺负！', effects: { martial: 3, virtue: -1 }, log: '你教导孩子要强硬，TA的武学略有提升。' },
            { text: '【亲自去学堂】找先生和对方家长理论。', effects: { reputation: 2, favor: 5 }, log: '你的出面解决了问题，孩子觉得很有安全感。' },
            { text: '【教TA用计】让他们自食其果。', effects: { wisdom: 3 }, log: '你教导孩子要用智慧解决问题。' }
        ]},
        // ============= 新增事件 START ===============
        { id: 'saving_money', title: '攒私房钱', desc: '你发现孩子 {childName} 在偷偷攒钱，似乎在计划着什么。', options: [
            { text: '【假装不知】给予TA隐私。', effects: { wisdom: 1 }, log: '你选择尊重孩子的秘密。' },
            { text: '【询问用途】并表示可以支持。', effects: { favor: 8 }, log: '你的关心让孩子很感动，并告诉了你TA的“小计划”。' },
            { text: '【没收充公】认为小孩不该有秘密。', effects: { favor: -10, virtue: -2 }, log: '你的做法严重伤害了孩子的感情。' }
        ]}
        // ============= 新增事件 END =================
    ],
    9: [
        { id: 'interest_develop', title: '兴趣萌芽', desc: '孩子 {childName} 最近对某一领域表现出了浓厚的兴趣。', options: [
            { text: '对【诗词歌赋】十分着迷。', effects: { talent: 4 }, log: '你决定支持孩子的兴趣，TA的才情获得了成长。' },
            { text: '喜欢【舞刀弄枪】。', effects: { martial: 4 }, log: '你为孩子请了武学师傅，TA的身体更强健了。' },
            { text: '热衷于【市集算账】。', effects: { wisdom: 4 }, log: '你发现孩子颇有经商头脑，决定加以引导。' }
        ]}
    ],
    10: [
        { id: 'friend_trouble', title: '朋友之难', desc: '孩子 {childName} 的一位好友家中突遭变故，TA想用自己的零花钱去帮助对方。', options: [
            { text: '【大力支持】并额外给予资助。', effects: { virtue: 5, charm: 2, favor: 10 }, log: '你的善举让孩子明白了为人之道。' },
            { text: '【口头鼓励】但认为这是TA自己的事。', effects: { virtue: 2 }, log: '孩子用自己的力量帮助了朋友。' },
            { text: '【表示反对】认为不应多管闲事。', effects: { virtue: -3, favor: -5 }, log: '你的态度让孩子感到不解和失望。' }
        ]}
    ],
    11: [
        { id: 'academic_competition', title: '书院小比', desc: '书院举行了一次经义小比，你的孩子 {childName} 也参加了。', options: [
            { text: '获得了【优胜】，得了先生的夸奖。', effects: { wisdom: 3, reputation: 2 }, log: '{childName}在书院小比中崭露头角。' },
            { text: '表现【平平】，但认识了差距。', effects: { wisdom: 1 }, log: '{childName}在小比后更加努力了。' },
            { text: '因【紧张】而发挥失常。', effects: { health: -1, wisdom: -1 }, log: '{childName}似乎不太适应竞争的场合。' }
        ]},
        // ============= 新增事件 START ===============
        { id: 'found_love_letter', title: '发现情书', desc: '你打扫房间时，无意中发现了 {childName} 写给别人的情书。', options: [
            { text: '【偷看】并了解TA的心事。', effects: { wisdom: 2, virtue: -3 }, log: '你满足了好奇心，但也侵犯了孩子的隐私。' },
            { text: '【放回原处】当做什么都没发生。', effects: { virtue: 2 }, log: '你选择了尊重孩子。' },
            { text: '【当面询问】开诚布公地谈一谈。', effects: { favor: 5, charm: 1 }, log: '你与孩子进行了一次开诚布公的谈话。' }
        ]}
        // ============= 新增事件 END =================
    ],
    12: [
        { id: 'first_crush', title: '情窦初开', desc: '你发现孩子 {childName} 最近总是和一个异性同学出双入对，似乎是情窦初开了。', options: [
            { text: '【正确引导】告知分寸，不加干涉。', effects: { charm: 2, wisdom: 1, favor: 5 }, log: '你的开明让孩子很感激，亲子关系更好了。' },
            { text: '【严厉禁止】认为为时尚早。', effects: { favor: -8, etiquette: 2 }, log: '你的禁止让孩子产生了逆反心理。' },
            { text: '【暗中观察】对方的家世品行。', effects: { wisdom: 2 }, log: '你决定先观察一段时间再说。' }
        ]}
    ],
    13: [
        { id: 'rebellious_phase', title: '少年叛逆', desc: '孩子 {childName} 开始有些叛逆，对你的管教时常顶嘴。', options: [
            { text: '【耐心沟通】尝试理解TA的想法。', effects: { favor: 10, wisdom: 1 }, log: '耐心沟通化解了矛盾。' },
            { text: '【加强管教】用规矩约束TA。', effects: { favor: -5, etiquette: 3 }, log: '严厉的管教让TA表面上顺从了。' },
            { text: '【冷处理】给彼此一些空间。', effects: { favor: -2 }, log: '你选择暂时不与TA计较。' }
        ]}
    ],
    14: [
        { id: 'career_dream', title: '立下志向', desc: '孩子 {childName} 与你畅谈未来，TA告诉你，TA的梦想是成为一名...', options: [
            { text: '【文官】，为国为民。', effects: { virtue: 2, wisdom: 2 }, log: '{childName}立下了成为国之栋梁的志向。' },
            { text: '【武将】，保家卫国。', effects: { martial: 2, health: 2 }, log: '{childName}渴望在沙场上建功立业。' },
            { text: '【富商】，富甲一方。', effects: { charm: 2, wisdom: 2 }, log: '{childName}对商业经营产生了浓厚的兴趣。' }
        ]},
        // ============= 新增事件 START ===============
        { id: 'helping_poor', title: '帮助穷人', desc: '你看到 {childName} 将自己的食物分给了路边的乞丐。', options: [
            { text: '【加以赞赏】并给予更多食物。', effects: { virtue: 4, favor: 5 }, log: '你的鼓励让孩子的善良品质得以成长。' },
            { text: '【默许】但不发表意见。', effects: { virtue: 1 }, log: '你看到了孩子的善举。' },
            { text: '【告诫TA】不要随便和陌生人说话。', effects: { wisdom: 1, virtue: -1 }, log: '你的告诫让孩子学会了保护自己，但也有些困惑。' }
        ]}
        // ============= 新增事件 END =================
    ],
    15: [
        { id: 'part_time_work', title: '初涉世事', desc: '孩子 {childName} 想要利用课余时间去一家店铺当学徒，体验生活。', options: [
            { text: '【欣然同意】这是难得的锻炼。', effects: { wisdom: 2, virtue: 1, favor: 5 }, log: '孩子在实践中学到了很多。' },
            { text: '【担心安全】但最终还是同意了。', effects: { favor: 2 }, log: '你虽有担忧，但还是尊重了孩子的决定。' },
            { text: '【坚决反对】认为应当以学业为重。', effects: { favor: -5 }, log: '你拒绝了孩子的请求。' }
        ]}
    ],
    // 更多事件...
    16: [
        { id: 'coming_of_age', title: '及笄/冠礼', desc: '为庆祝 {childName} 成年，你为其举办了盛大的及笄/冠礼。', options: [
            { text: '【场面宏大】，宾客云集。', effects: { reputation: 5, charm: 3 }, log: '盛大的典礼让家族非常有面子。' },
            { text: '【温馨雅致】，只请至亲好友。', effects: { virtue: 2, favor: 8 }, log: '温馨的家宴让孩子感受到了浓浓的亲情。' },
            { text: '【赠予重礼】，作为成年礼物。', effects: { favor: 12 }, log: '一份重礼让孩子明白了你对TA的重视。' }
        ]}
    ],
    17: [
        { id: 'bad_influence', title: '误交损友', desc: '你发现 {childName} 最近与一些不务正业的纨绔子弟走得很近，学坏了。', options: [
            { text: '【严令禁止】TA再与那些人来往。', effects: { virtue: 3, etiquette: 2, favor: -6 }, log: '你及时阻止了孩子滑向深渊。' },
            { text: '【旁敲侧击】引导TA自己疏远。', effects: { wisdom: 2, virtue: 1 }, log: '你的引导让孩子自己意识到了问题。' },
            { text: '【教训损友】让对方不敢再接近。', effects: { martial: 2, reputation: -2 }, log: '你用强硬的手段解决了问题，但也留下了霸道的名声。' }
        ]}
    ],
     8: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'saving_money', title: '攒私房钱', desc: '你发现孩子 {childName} 在偷偷攒钱，似乎在计划着什么。', options: [
            { text: '【假装不知】给予TA隐私。', effects: { wisdom: 1 }, log: '你选择尊重孩子的秘密。' },
            { text: '【询问用途】并表示可以支持。', effects: { favor: 8 }, log: '你的关心让孩子很感动，并告诉了你TA的“小计划”。' },
            { text: '【没收充公】认为小孩不该有秘密。', effects: { favor: -10, virtue: -2 }, log: '你的做法严重伤害了孩子的感情。' }
        ]}
    ],
    11: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'found_love_letter', title: '发现情书', desc: '你打扫房间时，无意中发现了 {childName} 写给别人的情书。', options: [
            { text: '【偷看】并了解TA的心事。', effects: { wisdom: 2, virtue: -3 }, log: '你满足了好奇心，但也侵犯了孩子的隐私。' },
            { text: '【放回原处】当做什么都没发生。', effects: { virtue: 2 }, log: '你选择了尊重孩子。' },
            { text: '【当面询问】开诚布公地谈一谈。', effects: { favor: 5, charm: 1 }, log: '你与孩子进行了一次开诚布公的谈话。' }
        ]}
    ],
    14: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'helping_poor', title: '帮助穷人', desc: '你看到 {childName} 将自己的食物分给了路边的乞丐。', options: [
            { text: '【加以赞赏】并给予更多食物。', effects: { virtue: 4, favor: 5 }, log: '你的鼓励让孩子的善良品质得以成长。' },
            { text: '【默许】但不发表意见。', effects: { virtue: 1 }, log: '你看到了孩子的善举。' },
            { text: '【告诫TA】不要随便和陌生人说话。', effects: { wisdom: 1, virtue: -1 }, log: '你的告诫让孩子学会了保护自己，但也有些困惑。' }
        ]}
    ],
    10: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'failed_exam', title: '考试失利', desc: '孩子 {childName} 这次考试成绩不理想，情绪低落。', options: [
            { text: '【温言安慰】并帮助TA分析原因。', effects: { favor: 10, wisdom: 2 }, log: '你的安慰和帮助让孩子重拾信心。' },
            { text: '【严厉批评】认为TA不够努力。', effects: { favor: -8, martial: 1 }, log: '你的批评让孩子压力倍增。' },
            { text: '【物质激励】承诺下次考好有奖励。', effects: { charm: 1 }, log: '你试图用物质奖励来激励孩子。' }
        ]}
    ],
    13: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'secret_hobby', title: '秘密爱好', desc: '你发现 {childName} 有一个秘密爱好（例如唱戏、斗蛐蛐），这在世人看来有些“不务正业”。', options: [
            { text: '【尊重并支持】TA的爱好。', effects: { talent: 2, favor: 12 }, log: '你的理解和支持让孩子非常感动。' },
            { text: '【表示担忧】但不强行禁止。', effects: { favor: 2 }, log: '你表达了自己的担忧，但仍尊重孩子的选择。' },
            { text: '【强行禁止】并销毁相关物品。', effects: { favor: -15, virtue: -3 }, log: '你的粗暴做法在孩子心中留下了深深的创伤。' }
        ]}
    ],
    7: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'telling_lie', title: '第一次撒谎', desc: '{childName} 为了逃避惩罚，对你撒了一个很明显的谎。', options: [
            { text: '【严厉戳穿】并加倍惩罚。', effects: { etiquette: 2, favor: -5 }, log: '你让孩子明白了撒谎的严重后果。' },
            { text: '【温和引导】告诉TA诚实更重要。', effects: { virtue: 3, favor: 5 }, log: '你引导孩子认识到了错误，并主动承认。' },
            { text: '【不动声色】看TA如何收场。', effects: { wisdom: 2 }, log: '你决定观察孩子的应对方式，以更好地了解TA。' }
        ]}
    ],
    15: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'first_income', title: '第一笔收入', desc: '{childName} 通过自己的努力（如抄书、帮工）赚到了第一笔钱，兴高采烈地拿给你看。', options: [
            { text: '【为TA高兴】并让TA自己支配。', effects: { wisdom: 2, favor: 10 }, log: '你的信任让孩子学会了理财。' },
            { text: '【替TA保管】认为TA会乱花。', effects: { favor: -5 }, log: '你出于好意替TA保管，但TA觉得不被信任。' },
            { text: '【鼓励TA】用这笔钱做些有意义的事。', effects: { virtue: 2, favor: 5 }, log: '在你的鼓励下，孩子用这笔钱做了件好事。' }
        ]}
    ],
    17: [ // 额外补充 (这里是您原有的，予以保留)
        { id: 'defending_family', title: '维护家族', desc: '在外听到有人非议你的家族，{childName} 挺身而出，与对方辩驳。', options: [
            { text: '【大加赞赏】TA的家族荣誉感。', effects: { reputation: 3, virtue: 2, favor: 8 }, log: '你对孩子的行为感到非常骄傲。' },
            { text: '【告诫TA】不要冲动，注意安全。', effects: { wisdom: 1, favor: 3 }, log: '你提醒孩子要用更聪明的方式维护家族。' },
            { text: '【认为TA多事】让你有些难堪。', effects: { favor: -5 }, log: '你觉得孩子的做法有些鲁莽。' }
        ]}
    ],
    // ============= 新增事件 START ===============
    12: [ // 新增事件
        { id: 'family_chore', title: '分担家务', desc: '孩子 {childName} 主动提出想要帮你分担一些家务。', options: [
            { text: '【欣慰接受】并教导TA。', effects: { virtue: 3, favor: 8, health: 1 }, log: '{childName}学会了新的生活技能，并为你分担了辛劳。' },
            { text: '【拒绝】认为TA应以学业为重。', effects: { favor: -3 }, log: '你的拒绝让孩子有些失落，觉得不被需要。' }
        ]}
    ],
    16: [ // 新增事件
        { id: 'future_anxiety', title: '未来的迷茫', desc: '{childName} 即将成年，对自己的未来感到有些迷茫和焦虑，前来寻求你的建议。', options: [
            { text: '【分享你的经验】并鼓励TA。', effects: { wisdom: 2, favor: 12 }, log: '你的经验之谈给了孩子莫大的鼓励和启发。' },
            { text: '【带TA拜访名士】开阔眼界。', effects: { reputation: 2, charm: 2, favor: 8 }, log: '拜访名士后，孩子眼界大开，对未来有了更清晰的规划。' },
            { text: '【让TA自己摸索】。', effects: { favor: -5 }, log: '你认为这是成长的必经之路，但孩子觉得你不够关心TA。' }
        ]}
    ]
    // ============= 新增事件 END =================
};

const childCareerAssignment = {
    male: { 
        "文官": { req: { wisdom: 60, virtue: 50 }, path: 'civilian' }, 
        "武将": { req: { health: 60, martial: 50 }, path: 'warrior' }, 
        "商贾": { req: { wisdom: 70 }, path: 'merchant' }, 
        "文人墨客": { req: { talent: 70, charm: 60 }, path: 'scholar' },
        "江湖游侠": { req: { health: 50, martial: 60 }, path: 'ranger' },
        "待业": { req: {}, path: 'unemployed' } 
    },
    female: { 
        "主母": { req: { etiquette: 70, virtue: 60 }, path: 'matron' }, 
        "绣娘": { req: { talent: 70 }, path: 'embroiderer' }, 
        "女医": { req: { wisdom: 60, virtue: 50 }, path: 'doctor' }, 
        "情报首领": { req: { wisdom: 70, charm: 60 }, path: 'spy_master' },
        "待业": { req: {}, path: 'unemployed' } 
    }
};
// --- DATA: Merchant Guild & Farming ---
// ===================== 【新功能】商会特殊事件库 =====================

const FARMING_EVENTS = [
    // 7个正面事件
    { title: '天降甘霖', type: 'positive', desc: '今年雨水充沛，你的田地长势喜人，预计将迎来大丰收！', options: [
        { text: '追加投资，购买肥料。', req: { wisdom: 30 }, outcome: { text: '精心的照料让收成远超预期！', effects: { multiplier: 1.5, cost: 200 } } },
        { text: '保持现状，顺其自然。', req: {}, outcome: { text: '你获得了一次不错的丰收。', effects: { multiplier: 1.2, cost: 0 } } },
        { text: '提前联系商路，准备外销。', req: { charm: 40 }, outcome: { text: '你提前锁定了买家，以高价卖出了所有收成！', effects: { multiplier: 1.4, cost: 50 } } }
    ]},
    { title: '发现良种', type: 'positive', desc: '一位云游的老农给了你一些改良过的种子，据说产量更高。', options: [
        { text: '【花费500两】全部换用良种。', req: { wealth: 500 }, outcome: { text: '老农所言非虚！你的产量暴增！', effects: { multiplier: 1.6, cost: 500 } } },
        { text: '【小范围试种】。', req: {}, outcome: { text: '试种的田地收成喜人，你决定明年再大规模推广。', effects: { multiplier: 1.1, cost: 0 } } },
        { text: '【心存疑虑】不敢使用。', req: { wisdom: 50 }, outcome: { text: '你错过了这次机会，收成与往年无异。', effects: { multiplier: 1.0, cost: 0 } } }
    ]},
    { title: '贵人巡视', type: 'positive', desc: '一位微服私访的贵人路过你的田庄，对你井井有条的农事管理大加赞赏。', options: [
        { text: '【盛情款待】。', req: { etiquette: 50 }, outcome: { text: '贵人十分高兴，赏赐了你一笔钱。', effects: { wealth: 1000, reputation: 5 } } },
        { text: '【借机请教】农桑政策。', req: { wisdom: 60 }, outcome: { text: '你独到的见解让贵人刮目相看，并为你提供了一些政策便利。', effects: { multiplier: 1.2, reputation: 10 } } },
        { text: '【不卑不亢】，正常接待。', req: {}, outcome: { text: '贵人对你的沉稳表示欣赏。', effects: { reputation: 2 } } }
    ]},
    { title: '农具革新', type: 'positive', desc: '你手下的一个巧手农户改良了曲辕犁，耕作效率大大提升。', options: [
        { text: '【重赏农户】并推广新犁。', req: { virtue: 40 }, outcome: { text: '农户们感激你的仁德，干劲十足，收成大增。', effects: { multiplier: 1.3, cost: 300, virtue: 5 } } },
        { text: '【买断技术】据为己有。', req: {}, outcome: { text: '你独占了新技术，收成增加，但失去了人心。', effects: { multiplier: 1.25, virtue: -3 } } },
        { text: '【申请专利】与官府合作推广。', req: { wisdom: 70 }, outcome: { text: '你的长远眼光获得了官府的赏识，不仅获得奖励，还提升了声望。', effects: { wealth: 500, reputation: 15 } } }
    ]},
    { title: '土地肥力恢复', type: 'positive', desc: '你采用了新的休耕方法，今年土地的肥力惊人地好。', options: [
        { text: '【种植高产作物】。', req: {}, outcome: { text: '肥沃的土地带来了惊人的产量！', effects: { multiplier: 1.4 } } },
        { text: '【种植经济作物】。', req: { wisdom: 50 }, outcome: { text: '你种出的经济作物品质上乘，卖出了高价。', effects: { multiplier: 1.35 } } },
        { text: '【出租部分土地】。', req: {}, outcome: { text: '你将部分土地出租，获得了一笔稳定的租金。', effects: { wealth: 800 } } }
    ]},
    { title: '市场需求旺盛', type: 'positive', desc: '因邻近州府歉收，京城对粮食的需求大增，粮价飞涨。', options: [
        { text: '【抓住时机】全部出售。', req: {}, outcome: { text: '你大赚了一笔！', effects: { multiplier: 1.8 } } },
        { text: '【囤积居奇】等待更高价格。', req: { wisdom: 70 }, outcome: { text: '你的胆识获得了回报，价格又涨了一成！', effects: { multiplier: 2.0, virtue: -5 } } },
        { text: '【平价出售】给百姓，赚取声望。', req: { virtue: 60 }, outcome: { text: '你的善举被传为佳话，获得了百姓的爱戴。', effects: { multiplier: 1.1, reputation: 20, virtue: 10 } } }
    ]},
    { title: '祥瑞之兆', type: 'positive', desc: '你的田里竟然长出了一株并蒂莲/灵芝，被认为是祥瑞之兆。', options: [
        { text: '【献给官府】。', req: {}, outcome: { text: '官府大喜，赏赐了你并提升了你的声望。', effects: { wealth: 1200, reputation: 10 } } },
        { text: '【高价出售】给富商。', req: {}, outcome: { text: '你将祥瑞卖出了一个好价钱。', effects: { wealth: 2000 } } },
        { text: '【自己保留】希望带来好运。', req: {}, outcome: { text: '你保留了祥瑞，感觉未来一年的运气都会很好。', effects: { luck_boost: 1 } } } // 假设有幸运值
    ]},

    // 8个负面事件
    { title: '蝗灾来袭', type: 'negative', desc: '遮天蔽日的蝗虫向你的田地袭来！', options: [
        { text: '【花费巨资】雇人捕蝗。', req: { wealth: 800 }, outcome: { text: '虽然花费巨大，但你保住了大部分收成。', effects: { multiplier: 0.8, cost: 800 } } },
        { text: '【听天由命】祈求神明保佑。', req: {}, outcome: { text: '你的田地损失惨重，几乎颗粒无收。', effects: { multiplier: 0.1, cost: 0 } } },
        { text: '【使用偏方】以烟熏驱赶。', req: { wisdom: 40 }, outcome: { text: '偏方有一定效果，但仍有不小的损失。', effects: { multiplier: 0.5, cost: 100 } } }
    ]},
    { title: '遭遇旱灾', type: 'negative', desc: '连续数月未下雨，土地干裂，作物枯黄。', options: [
        { text: '【重金雇人】从远处运水灌溉。', req: { wealth: 1000 }, outcome: { text: '高昂的成本让你几乎没有利润，但总算保住了收成。', effects: { multiplier: 0.9, cost: 1000 } } },
        { text: '【向龙王庙】求雨。', req: {}, outcome: { text: '求雨并未成功，你的作物大部分都枯死了。', effects: { multiplier: 0.2, cost: 50 } } },
        { text: '【变卖部分土地】换取资金保住核心田产。', req: { wisdom: 60 }, outcome: { text: '你壮士断腕，保住了最重要的田地，但损失了一部分产业。', effects: { multiplier: 0.8, land_loss: 1 } } }
    ]},
    { title: '恶霸觊觎', type: 'negative', desc: '附近的地主恶霸看上了你的良田，派人前来滋事，阻挠耕作。', options: [
        { text: '【报官处理】。', req: {}, outcome: { text: '官府敷衍了事，问题没有解决，还耽误了农时。', effects: { multiplier: 0.7, cost: 100 } } },
        { text: '【雇佣护院】武力对抗。', req: { wealth: 500 }, outcome: { text: '你成功赶走了恶霸，但双方结下了梁子。', effects: { multiplier: 0.9, cost: 500 } } },
        { text: '【托关系】请一位乡绅出面调解。', req: { charm: 60 }, outcome: { text: '你花费人情和金钱，暂时平息了事端。', effects: { multiplier: 0.85, cost: 300 } } }
    ]},
    { title: '农户生变', type: 'negative', desc: '你手下的农户们因工钱问题集体怠工，威胁要离开。', options: [
        { text: '【强硬镇压】并另寻农户。', req: {}, outcome: { text: '你的强硬导致农户全部离开，新找的人不熟悉田地，收成大减。', effects: { multiplier: 0.4, virtue: -5 } } },
        { text: '【承诺加薪】安抚人心。', req: { wealth: 400 }, outcome: { text: '你增加了支出，稳住了农户，但利润降低了。', effects: { multiplier: 0.8, cost: 400 } } },
        { text: '【画大饼】承诺丰收后有重赏。', req: { charm: 70 }, outcome: { text: '你成功说服了农户，但如果年底无法兑现，你的信誉将破产。', effects: { multiplier: 0.9, reputation_risk: 1 } } }
    ]},
    { title: '田契纠纷', type: 'negative', desc: '有人拿着一张旧地契找上门来，声称这片土地是他们家的，要求你归还。', options: [
        { text: '【对簿公堂】。', req: {}, outcome: { text: '漫长的官司耗费了你大量金钱和精力，无论输赢都影响了收成。', effects: { multiplier: 0.6, cost: 600 } } },
        { text: '【破财消灾】给对方一笔钱了事。', req: { wealth: 1000 }, outcome: { text: '你花钱买了个清静。', effects: { cost: 1000 } } },
        { text: '【暗中调查】对方的底细。', req: { wisdom: 70 }, outcome: { text: '你发现对方是职业骗子，成功揭穿了他们！', effects: { reputation: 5, wisdom: 2 } } }
    ]},
    { title: '莫名瘟病', type: 'negative', desc: '你的田里爆发了一场奇怪的植物瘟病，迅速蔓延。', options: [
        { text: '【请教老农】使用土方。', req: {}, outcome: { text: '土方效果有限，损失依然不小。', effects: { multiplier: 0.6 } } },
        { text: '【忍痛焚烧】病株，防止蔓延。', req: { virtue: 30 }, outcome: { text: '你果断的决定保住了大部分田地，但烧毁的部分颗粒无收。', effects: { multiplier: 0.7 } } },
        { text: '【寻访名医】配置药水。', req: { wealth: 600 }, outcome: { text: '昂贵的药水控制住了病情，但成本高昂。', effects: { multiplier: 0.8, cost: 600 } } }
    ]},
    { title: '官府加税', type: 'negative', desc: '朝廷财政紧张，突然宣布加征农业税。', options: [
        { text: '【足额缴纳】。', req: {}, outcome: { text: '你缴纳了额外的税款，利润大幅减少。', effects: { multiplier: 0.75 } } },
        { text: '【试图瞒报】部分田产。', req: { wisdom: 60 }, outcome: { text: '你侥幸成功，但一旦被发现将面临重罚。', effects: { multiplier: 0.9, risk: 'heavy_fine' } } },
        { text: '【联络乡绅】共同向官府请愿。', req: { charm: 70 }, outcome: { text: '你们的请愿有了一定效果，税率略有下调。', effects: { multiplier: 0.85, reputation: 5 } } }
    ]},
    { title: '仓库失火', type: 'negative', desc: '存放种子的仓库意外失火，大量储备被烧毁。', options: [
        { text: '【紧急高价】从市场购入种子。', req: {}, outcome: { text: '你不得不高价买入种子，严重影响了本季的利润。', effects: { multiplier: 0.8, cost: 500 } } },
        { text: '【减少播种】面积。', req: {}, outcome: { text: '你被迫减少了播种面积，本季收成注定惨淡。', effects: { multiplier: 0.5 } } },
        { text: '【向邻里】求助借种。', req: { virtue: 50 }, outcome: { text: '你的好人缘让你借到了种子，但欠下了人情。', effects: { multiplier: 0.9, reputation: -5 } } }
    ]}
];

const INVESTMENT_EVENTS = [
    // 7个正面事件
    { title: '市场新潮', type: 'positive', desc: '你经营的产业突然成了京城的新风尚，顾客盈门！', options: [
        { text: '【趁机涨价】。', req: { wisdom: 40 }, outcome: { text: '你抓住了商机，大赚一笔。', effects: { multiplier: 1.5, reputation: -2 } } },
        { text: '【扩大规模】满足需求。', req: { wealth: 1000 }, outcome: { text: '你果断投资，占据了更大的市场份额。', effects: { multiplier: 1.4, cost: 1000 } } },
        { text: '【保持品质】维护口碑。', req: { virtue: 50 }, outcome: { text: '你坚持品质，赢得了顾客的长期信赖。', effects: { multiplier: 1.2, reputation: 10 } } }
    ]},
    { title: '官府扶持', type: 'positive', desc: '官府推行新政，对你所在的行业有税收减免等扶持政策。', options: [
        { text: '【享受政策】红利。', req: {}, outcome: { text: '你享受了税收减免，利润提升。', effects: { multiplier: 1.3 } } },
        { text: '【借机扩张】。', req: { wisdom: 60 }, outcome: { text: '你利用政策优势，迅速扩张了产业。', effects: { multiplier: 1.2, cost: 500 } } },
        { text: '【与官府】加深合作。', req: { charm: 60 }, outcome: { text: '你与官府建立了良好关系，为未来铺平了道路。', effects: { reputation: 15 } } }
    ]},
    { title: '对手失误', type: 'positive', desc: '你的主要竞争对手因经营失误，声誉大跌，大量客户流向了你这边。', options: [
        { text: '【全盘接收】客户。', req: {}, outcome: { text: '你的生意异常火爆！', effects: { multiplier: 1.6 } } },
        { text: '【趁机收购】对方的店铺。', req: { wealth: 2000, wisdom: 70 }, outcome: { text: '你以低价收购了对手的产业，实力大增！', effects: { cost: 2000, asset_gain: 1 } } },
        { text: '【引以为戒】。', req: {}, outcome: { text: '你从对手的失败中吸取了教训，提升了管理水平。', effects: { wisdom: 5 } } }
    ]},
    { title: '发现新渠道', type: 'positive', desc: '你偶然发现了一条新的原材料渠道，成本可以大大降低。', options: [
        { text: '【立即更换】供应商。', req: {}, outcome: { text: '你的成本降低，利润大幅提升！', effects: { multiplier: 1.4 } } },
        { text: '【以此为筹码】与老供应商谈判。', req: { charm: 60 }, outcome: { text: '你成功压低了进货价。', effects: { multiplier: 1.3 } } },
        { text: '【垄断渠道】。', req: { wealth: 1500, wisdom: 70 }, outcome: { text: '你买断了新渠道，不仅自己获利，还打击了对手。', effects: { multiplier: 1.35, cost: 1500 } } }
    ]},
    { title: '掌柜献策', type: 'positive', desc: '你雇佣的掌柜想出了一个绝妙的营销点子。', options: [
        { text: '【采纳并授权】。', req: {}, outcome: { text: '新点子大获成功，生意兴隆！', effects: { multiplier: 1.3, virtue: 2 } } },
        { text: '【亲自执行】。', req: {}, outcome: { text: '你亲自操刀，效果同样出色。', effects: { multiplier: 1.25 } } },
        { text: '【论功行赏】重赏掌柜。', req: { wealth: 500 }, outcome: { text: '掌柜感激涕零，更加忠心耿耿。', effects: { multiplier: 1.2, cost: 500, loyalty_boost: 1 } } }
    ]},
    { title: '文化名人光顾', type: 'positive', desc: '一位著名的文人墨客光顾了你的店铺，并留下了赞美的诗句。', options: [
        { text: '【大肆宣传】。', req: {}, outcome: { text: '你的店铺名声大噪，成了“网红店”。', effects: { multiplier: 1.25, reputation: 15 } } },
        { text: '【赠送厚礼】感谢。', req: { wealth: 300 }, outcome: { text: '你与这位名人结下了善缘。', effects: { multiplier: 1.1, cost: 300 } } },
        { text: '【装裱起来】作为镇店之宝。', req: {}, outcome: { text: '此举提升了店铺的格调。', effects: { multiplier: 1.15, reputation: 5 } } }
    ]},
    { title: '节日特需', type: 'positive', desc: '恰逢重大节日，民众消费欲望高涨，你的产业迎来了销售旺季。', options: [
        { text: '【提前备货】。', req: { wisdom: 50 }, outcome: { text: '你精准的预判让你赚得盆满钵满！', effects: { multiplier: 1.7 } } },
        { text: '【举办促销】活动。', req: { charm: 50 }, outcome: { text: '促销活动吸引了大量顾客，薄利多销。', effects: { multiplier: 1.5, cost: 200 } } },
        { text: '【维持原样】。', req: {}, outcome: { text: '你依然获得了不错的收益。', effects: { multiplier: 1.3 } } }
    ]},

    // 8个负面事件
    { title: '遭遇勒索', type: 'negative', desc: '一群地痞流氓来店里闹事，声称要收“保护费”。', options: [
        { text: '【破财消灾】。', req: { wealth: 500 }, outcome: { text: '你花钱买了个暂时的安宁。', effects: { cost: 500 } } },
        { text: '【强硬对抗】。', req: {}, outcome: { text: '你赶走了地痞，但店铺被打砸，损失不小。', effects: { multiplier: 0.8, cost: 300 } } },
        { text: '【寻求官府】庇护。', req: { charm: 50 }, outcome: { text: '你打点官府，解决了麻烦，但也花了不少钱。', effects: { cost: 700 } } }
    ]},
    { title: '出现仿冒品', type: 'negative', desc: '市场上出现了大量仿冒你的产品的劣质货，影响了你的声誉。', options: [
        { text: '【登报澄清】。', req: {}, outcome: { text: '澄清有一定效果，但声誉损失难以完全挽回。', effects: { multiplier: 0.9, cost: 100 } } },
        { text: '【降价竞争】。', req: {}, outcome: { text: '降价导致利润大减，得不偿失。', effects: { multiplier: 0.7 } } },
        { text: '【暗中调查】源头并报官。', req: { wisdom: 70 }, outcome: { text: '你成功端掉了仿冒窝点，维护了品牌。', effects: { cost: 400, reputation: 5 } } }
    ]},
    { title: '内部失窃', type: 'negative', desc: '你发现店里的账目不对，似乎有内部人员监守自盗。', options: [
        { text: '【不动声色】暗中观察。', req: { wisdom: 60 }, outcome: { text: '你成功抓住了内鬼，但部分损失已无法追回。', effects: { multiplier: 0.9 } } },
        { text: '【公开审查】所有人员。', req: {}, outcome: { text: '人心惶惶，影响了正常经营。', effects: { multiplier: 0.85, virtue: -2 } } },
        { text: '【自认倒霉】加强管理。', req: {}, outcome: { text: '你损失了一笔钱。', effects: { multiplier: 0.8 } } }
    ]},
    { title: '流行变迁', type: 'negative', desc: '京城的流行风向突然转变，你的产品不再受欢迎，库存大量积压。', options: [
        { text: '【亏本清仓】。', req: {}, outcome: { text: '你亏本处理了库存，及时回笼了部分资金。', effects: { multiplier: 0.6 } } },
        { text: '【等待风向】转回来。', req: {}, outcome: { text: '你的等待是徒劳的，库存最终一文不值。', effects: { multiplier: 0.2 } } },
        { text: '【二次改造】迎合新潮流。', req: { talent: 60, wealth: 500 }, outcome: { text: '你巧妙地改造了产品，挽回了部分损失。', effects: { multiplier: 0.8, cost: 500 } } }
    ]},
    { title: '供应商涨价', type: 'negative', desc: '你的主要供应商突然宣布原材料价格上涨。', options: [
        { text: '【接受涨价】。', req: {}, outcome: { text: '你的成本上升，利润降低。', effects: { multiplier: 0.8 } } },
        { text: '【寻找新的】供应商。', req: {}, outcome: { text: '寻找新供应商需要时间，期间的断货造成了损失。', effects: { multiplier: 0.75 } } },
        { text: '【尝试自己】生产原料。', req: { wisdom: 80, wealth: 2000 }, outcome: { text: '这是一项长期投资，短期内造成了巨大亏损。', effects: { multiplier: 0.5, cost: 2000 } } }
    ]},
    { title: '政策变动', type: 'negative', desc: '官府出台新政策，对你所在的行业进行严格管制，经营成本大大增加。', options: [
        { text: '【遵守规定】。', req: {}, outcome: { text: '你的经营成本增加，利润下降。', effects: { multiplier: 0.7 } } },
        { text: '【打点官员】寻求通融。', req: { charm: 70, wealth: 1000 }, outcome: { text: '你花钱搞定了关系，但有潜在风险。', effects: { multiplier: 0.9, cost: 1000, virtue: -5 } } },
        { text: '【转行】。', req: {}, outcome: { text: '你决定转行，变卖了现有产业，损失巨大。', effects: { multiplier: 0.4, asset_loss: 1 } } }
    ]},
    { title: '安全事故', type: 'negative', desc: '你的店铺发生了一起安全事故（如火灾、伤人），需要赔偿并停业整顿。', options: [
        { text: '【足额赔偿】并积极整改。', req: { virtue: 50 }, outcome: { text: '你的负责态度挽回了一些声誉，但损失依然惨重。', effects: { multiplier: 0.5, cost: 1500, reputation: -5 } } },
        { text: '【推卸责任】。', req: {}, outcome: { text: '你的声誉一落千丈，店铺被强制关闭。', effects: { multiplier: 0.1, reputation: -20, virtue: -10 } } },
        { text: '【私了】。', req: { wealth: 1000 }, outcome: { text: '你花钱私了，将事件压了下去。', effects: { multiplier: 0.6, cost: 1000, reputation: -10 } } }
    ]},
    { title: '风水问题', type: 'negative', desc: '一位风水先生说你的店铺风水不好，导致客流稀少，人心不稳。', options: [
        { text: '【请大师】作法改运。', req: { wealth: 800 }, outcome: { text: '你花钱请人作法，似乎并无效果。', effects: { cost: 800 } } },
        { text: '【重新装修】改变布局。', req: { wealth: 1200 }, outcome: { text: '重新装修后，店铺面貌一新，生意略有起色。', effects: { multiplier: 1.1, cost: 1200 } } },
        { text: '【不信鬼神】。', req: {}, outcome: { text: '你对此嗤之以鼻，但流言却让你的生意更差了。', effects: { multiplier: 0.8 } } }
    ]}
];

const SEA_EXPLORATION_EVENTS = [
    // 7个正面事件
    { title: '发现新航路', type: 'positive', desc: '你的船队意外发现了一条未知的新航路，大大缩短了航程！', options: [
        { text: '【记录航路】并立即使用。', req: { wisdom: 60 }, outcome: { text: '新航路让你节省了大量成本，本次航行利润大增！', effects: { multiplier: 1.6 } } },
        { text: '【将航路图】高价卖给其他商会。', req: {}, outcome: { text: '你卖掉了航路图，获得了一笔巨款。', effects: { wealth: 5000 } } },
        { text: '【上报朝廷】。', req: { virtue: 50 }, outcome: { text: '你的贡献得到了朝廷的嘉奖。', effects: { reputation: 20, wealth: 1000 } } }
    ]},
    { title: '偶遇异国商船', type: 'positive', desc: '你的船队在海上遇到了一支友好的异国商船，他们希望与你交换货物。', options: [
        { text: '【进行交换】。', req: {}, outcome: { text: '你用廉价的货物换来了珍稀的异域特产，大赚一笔！', effects: { multiplier: 1.5 } } },
        { text: '【邀请对方】到京城做客。', req: { charm: 70 }, outcome: { text: '你与异国商人建立了长期合作关系。', effects: { multiplier: 1.2, trade_partner: 1 } } },
        { text: '【保持警惕】拒绝交易。', req: { wisdom: 50 }, outcome: { text: '你选择安全为上，错过了这次机会。', effects: {} } }
    ]},
    { title: '发现无人岛', type: 'positive', desc: '船队因躲避风暴，意外发现了一座物产丰富的无人岛。', options: [
        { text: '【采集资源】。', req: {}, outcome: { text: '你在岛上发现了珍贵的香料和木材，价值不菲。', effects: { multiplier: 1.4 } } },
        { text: '【建立据点】。', req: { wealth: 2000, wisdom: 80 }, outcome: { text: '你投资建立了中转据点，未来的航行将更加安全高效。', effects: { cost: 2000, exploration_bonus: 1 } } },
        { text: '【绘制海图】记录位置。', req: {}, outcome: { text: '你获得了宝贵的海图资料。', effects: { wisdom: 5 } } }
    ]},
    { title: '救助遇难船只', type: 'positive', desc: '你在海上救助了一艘遇难的商船，船主是位大人物。', options: [
        { text: '【不求回报】。', req: { virtue: 60 }, outcome: { text: '你的善举赢得了对方的感激，他承诺将来必有重报。', effects: { virtue: 10, reputation: 5, future_favor: 1 } } },
        { text: '【索要报酬】。', req: {}, outcome: { text: '你获得了一笔丰厚的报酬。', effects: { wealth: 3000 } } },
        { text: '【邀请入股】。', req: { charm: 80 }, outcome: { text: '对方欣赏你的胆识，决定投资你的船队。', effects: { wealth: 5000, cost: -5000 } } } // 相当于直接给了5000
    ]},
    { title: '一帆风顺', type: 'positive', desc: '本次航行得到了海神的眷顾，一路顺风顺水，比预期早了半个月抵达。', options: [
        { text: '【节省开销】。', req: {}, outcome: { text: '提前抵达为你节省了大量的人员和补给开销。', effects: { multiplier: 1.25 } } },
        { text: '【利用时间】进行额外交易。', req: { wisdom: 60 }, outcome: { text: '你利用多出来的时间做了一笔额外的生意，收益颇丰。', effects: { multiplier: 1.35 } } },
        { text: '【让船员】休整。', req: { virtue: 40 }, outcome: { text: '船员们士气大振，对你更加忠诚。', effects: { multiplier: 1.1, loyalty_boost: 1 } } }
    ]},
    { title: '捕获珍奇海兽', type: 'positive', desc: '你的船员意外捕获了一头传说中的珍奇海兽！', options: [
        { text: '【献给皇帝】。', req: {}, outcome: { text: '龙颜大悦，你获得了丰厚的赏赐和无上的荣耀。', effects: { wealth: 4000, reputation: 25 } } },
        { text: '【高价拍卖】。', req: {}, outcome: { text: '这头海兽在黑市上卖出了天价！', effects: { wealth: 8000 } } },
        { text: '【放生】。', req: { virtue: 70 }, outcome: { text: '你将海兽放归大海，船员们都认为你积了阴德。', effects: { virtue: 15, luck_boost: 1 } } }
    ]},
    { title: '打捞到沉船宝藏', type: 'positive', desc: '船队在浅海区意外打捞到了一个前朝的沉船宝箱！', options: [
        { text: '【打开宝箱】。', req: {}, outcome: { text: '宝箱里装满了金银珠宝！', effects: { wealth: 10000 } } },
        { text: '【将宝箱】上交。', req: {}, outcome: { text: '你将宝藏上交，获得了官府的奖励。', effects: { wealth: 5000, reputation: 10 } } },
        { text: '【私下分给】船员。', req: { virtue: 60 }, outcome: { text: '你将财宝分给了船员，他们愿为你赴汤蹈火！', effects: { wealth: 2000, loyalty_boost: 2 } } }
    ]},

    // 8个负面事件
    { title: '遭遇海盗', type: 'negative', desc: '一支凶狠的海盗船队包围了你！', options: [
        { text: '【奋力一搏】。', req: { martial: 50 }, outcome: { text: '一场血战后，你惨胜逃脱，但货物损失大半。', effects: { multiplier: 0.4, health: -10 } } },
        { text: '【缴纳赎金】。', req: { wealth: 3000 }, outcome: { text: '你花钱买路，保全了船只和人员。', effects: { cost: 3000 } } },
        { text: '【扬帆跑路】。', req: { wisdom: 60 }, outcome: { text: '你凭借高超的航海技术甩掉了海盗，但被迫丢弃了部分货物减重。', effects: { multiplier: 0.7 } } }
    ]},
    { title: '遭遇风暴', type: 'negative', desc: '突如其来的海上风暴几乎要将你的船撕碎！', options: [
        { text: '【全力应对】。', req: {}, outcome: { text: '在船员的努力下，你们勉强穿过了风暴，但船只和货物都严重受损。', effects: { multiplier: 0.5, health: -5 } } },
        { text: '【躲入小岛】。', req: { wisdom: 50 }, outcome: { text: '你及时找到了避风港，但耽误了航期，部分货物变质。', effects: { multiplier: 0.6 } } },
        { text: '【祈祷】。', req: {}, outcome: { text: '你们在风暴中损失惨重，几乎船毁人亡。', effects: { multiplier: 0.2, health: -20 } } }
    ]},
    { title: '船员哗变', type: 'negative', desc: '因补给不足和航行枯燥，部分船员发生了哗变！', options: [
        { text: '【武力镇压】。', req: { martial: 60 }, outcome: { text: '你镇压了叛乱，但船队人心涣散。', effects: { multiplier: 0.9, virtue: -5 } } },
        { text: '【承诺重赏】安抚。', req: {}, outcome: { text: '你承诺分出部分利润，暂时稳住了局面。', effects: { multiplier: 0.8 } } },
        { text: '【找出首恶】杀鸡儆猴。', req: { wisdom: 70 }, outcome: { text: '你精准地处理了带头者，震慑了其他人。', effects: { multiplier: 0.95, virtue: -8 } } }
    ]},
    { title: '遭遇鬼船', type: 'negative', desc: '你们在浓雾中遇到了一艘无人驾驶的破旧鬼船，船员们士气大跌。', options: [
        { text: '【绕道而行】。', req: {}, outcome: { text: '你们绕开了鬼船，但恐惧依然在蔓延。', effects: { multiplier: 0.9 } } },
        { text: '【登船探查】。', req: { martial: 50 }, outcome: { text: '船上空无一人，只有一些不值钱的旧物，虚惊一场。', effects: {} } },
        { text: '【开炮示警】驱散不详。', req: {}, outcome: { text: '炮声壮了胆，但巨大的声响引来了附近的海盗。', effects: { multiplier: 0.6 } } } // 触发海盗事件
    ]},
    { title: '触礁搁浅', type: 'negative', desc: '船只在夜航中不慎触礁，船底破了个大洞！', options: [
        { text: '【全力抢修】。', req: {}, outcome: { text: '你们堵住了漏洞，但必须抛弃一半货物才能继续航行。', effects: { multiplier: 0.5 } } },
        { text: '【弃船求生】。', req: {}, outcome: { text: '你们被迫弃船，乘坐小艇漂流，最终被救，但血本无归。', effects: { multiplier: 0 } } },
        { text: '【发出求救】信号。', req: {}, outcome: { text: '附近的商船前来救援，但他们要求分走你剩下货物的三分之二作为报酬。', effects: { multiplier: 0.33 } } }
    ]},
    { title: '染上瘟疫', type: 'negative', desc: '船上爆发了可怕的瘟疫，船员们接二连三地病倒。', options: [
        { text: '【隔离病患】。', req: { wisdom: 50 }, outcome: { text: '你及时控制了疫情，但病死的船员和耽误的航程造成了损失。', effects: { multiplier: 0.7, virtue: 2 } } },
        { text: '【使用草药】治疗。', req: {}, outcome: { text: '船上的草药效果有限，情况不容乐观。', effects: { multiplier: 0.6 } } },
        { text: '【加速返航】。', req: {}, outcome: { text: '你决定放弃航行提前返航，将损失降到最低。', effects: { multiplier: 0.8 } } }
    ]},
    { title: '遭遇水怪', type: 'negative', desc: '一个巨大的黑影在船底游弋，掀起滔天巨浪！传说中的水怪出现了！', options: [
        { text: '【投掷货物】吸引其注意力。', req: {}, outcome: { text: '你丢弃了部分货物，成功引开了水怪。', effects: { multiplier: 0.7 } } },
        { text: '【集火攻击】。', req: { martial: 70 }, outcome: { text: '你们的攻击激怒了水怪，船只遭到了严重破坏！', effects: { multiplier: 0.3 } } },
        { text: '【全速逃离】。', req: {}, outcome: { text: '你们侥幸逃脱，但船只也受到了一些损伤。', effects: { multiplier: 0.8 } } }
    ]},
    { title: '目的地市场崩溃', type: 'negative', desc: '你辛辛苦苦运达的货物，在目的地因某些原因价格暴跌。', options: [
        { text: '【含泪抛售】。', req: {}, outcome: { text: '你亏本出售了所有货物，避免了更大的损失。', effects: { multiplier: 0.4 } } },
        { text: '【转运到】其他港口。', req: { wisdom: 60, wealth: 1000 }, outcome: { text: '长途转运成本高昂，最终只是略有亏损。', effects: { multiplier: 0.9, cost: 1000 } } },
        { text: '【就地仓储】等待时机。', req: { wealth: 500 }, outcome: { text: '你赌了一把，但价格并未回升，仓储费用让亏损雪上加霜。', effects: { multiplier: 0.3, cost: 500 } } }
    ]}
];
const merchantInvestmentData = {
    types: [
        { 
            id: 'silk_shop', name: '绸缎庄', 
            levels: [
                { name: '绸缎庄', cost: 1000, base_return: 150, upgrade_cost: 3000 },
                { name: '锦绣坊', cost: 3000, base_return: 500, upgrade_cost: 10000 },
                { name: '天衣阁', cost: 10000, base_return: 2000, upgrade_cost: 0 }
            ],
            attribute_boost: { talent: 1 }
        },
        { 
            id: 'teahouse', name: '茶楼',
            levels: [
                { name: '茶楼', cost: 1500, base_return: 200, upgrade_cost: 4500 },
                { name: '雅轩', cost: 4500, base_return: 700, upgrade_cost: 15000 },
                { name: '品茗楼', cost: 15000, base_return: 2500, upgrade_cost: 0 }
            ],
            attribute_boost: { etiquette: 1 }
        },
        {
            id: 'bank', name: '钱庄',
            levels: [
                { name: '钱庄', cost: 5000, base_return: 600, upgrade_cost: 15000 },
                { name: '票号', cost: 15000, base_return: 2500, upgrade_cost: 50000 },
                { name: '通源总号', cost: 50000, base_return: 10000, upgrade_cost: 0 }
            ],
             attribute_boost: { wisdom: 1 }
        }
    ],
    managers: [
        { id: 'frugal', name: '普通伙计', salary: 50, effect: { return_mod: 1.0, risk_mod: 1.0, reputation: 1 } },
        { id: 'steady', name: '忠厚掌柜', salary: 200, effect: { return_mod: 1.2, risk_mod: 0.8, reputation: 5 } },
        { id: 'shrewd', name: '精明管事', salary: 500, effect: { return_mod: 1.5, risk_mod: 1.3, reputation: -2 } }
    ],
    strategies: [
        { id: 'stable', name: '薄利多销', desc: '收益稳定，风险较低', effect: { return_mod: 0.9, risk_mod: 0.7 } },
        { id: 'gamble', name: '奇货可居', desc: '收益波动大，风险高', effect: { return_mod: 1.5, risk_mod: 2.0 } },
        { id: 'promote', name: '投入宣传', desc: '本年收益降低，提升声望', cost: 300, effect: { return_mod: 0.5, risk_mod: 1.0, reputation: 10 } }
    ]
};
const landData = [
    { id: 'farmland', name: '肥沃良田', cost: 200, icon: '🏞️', desc: '京郊最常见的田地。适合种植各类主粮作物。', reputation_req: 0 },
    { id: 'paddy', name: '江南水田', cost: 350, icon: '💧', desc: '引活水灌溉，是种植水稻的绝佳之选。', reputation_req: 20 },
    { id: 'hill', name: '山地丘陵', cost: 300, icon: '⛰️', desc: '云雾缭绕，是种植茶叶、特定药材的宝地。', reputation_req: 40 }
];
const cropData = [
    { id: 'rice', name: '水稻', icon: '🌾', cost: 10, cycle: 2, yield: 50, desc: '百姓餐桌上的主食，需求稳定。' },
    { id: 'wheat', name: '小麦', icon: '🌽', cost: 10, cycle: 2, yield: 45, desc: '北方常见的主食，耐旱。' },
    { id: 'tea', name: '茶叶', icon: '🌿', cost: 30, cycle: 3, yield: 120, desc: '文人雅士的最爱，价值不菲。' },
    { id: 'peony', name: '牡丹', icon: '🌸', cost: 50, cycle: 4, yield: 200, desc: '花中之王，雍容华贵。', effect: { charm: 1 } },
    { id: 'herb', name: '珍稀药材', icon: '💎', cost: 80, cycle: 6, yield: 300, desc: '生长周期漫长，风险极高，但价值连城。', effect: { wisdom: 1 } }
];
const adaptationMatrix = {
    farmland: { rice: 1, wheat: 1.5, tea: 0.5, peony: 1.2, herb: 0.5 },
    paddy:    { rice: 1.5, wheat: 0.5, tea: 0.5, peony: 0.8, herb: 0.5 },
    hill:     { rice: 0.5, wheat: 1, tea: 1.5, peony: 1, herb: 1.5 }
};
const MARITIME_TRADE_DATA = {
    fleetLevels: [
        { level: 0, name: "未组建舰队", upgradeCost: 5000, req: { reputation: 50 }, desc: "组建一支基础的近海船队，开启你的航海事业。" },
        { level: 1, name: "近海船队", upgradeCost: 25000, req: { reputation: 200 }, desc: "升级为更可靠的远洋船队，以探索更广阔的海域。" },
        { level: 2, name: "远洋船队", upgradeCost: 100000, req: { reputation: 500 }, desc: "升级为拥有官方背景的皇家舰队，承接最高风险与回报的任务。" },
        { level: 3, name: "皇家舰队", upgradeCost: 0, req: {}, desc: "你的舰队已是海上霸主。" }
    ],
    investmentTiers: [
        { level: 1, name: "近海贸易", desc: "往返于邻近港口，风险低，回报稳定。", investment: 5000, cycle: 2, roi_range: [0.1, 0.4] }, // roi: Return on Investment
        { level: 2, name: "远洋香料", desc: "前往南洋，寻求珍贵的香料，风险与回报并存。", investment: 25000, cycle: 4, roi_range: [0.2, 0.8] },
        { level: 3, name: "皇家贡品", desc: "为皇室寻找传说中的海外奇珍，风险极高，但可能一本万利。", investment: 100000, cycle: 6, roi_range: [-0.2, 2.0] } // 可能会亏损
    ]
};
// ===================== 【新增并扩充】远洋探索过程事件库 =====================
const VOYAGE_EVENTS = {
    positive: [
        { id: 'good_wind', name: '天助顺风', desc: '你的船队遇到了持续的顺风，航行速度大增，预计可以提前抵达！', effect: { turnsLeft: -1 }, log: '航程缩短了一回合！' },
        { id: 'friendly_ship', name: '偶遇商船', desc: '你们遇到了一支友好的异国商船，对方与你们交换了一些特产。', effect: { profit_bonus: 500 }, log: '你额外获利500两。' },
        { id: 'big_catch', name: '渔获丰收', desc: '船员们捕获了大量的鱼群，不仅改善了伙食，还节省了补给开销。', effect: { supply_cost_reduction: 100 }, log: '补给开销减少100两。' },
        { id: 'treasure_map_fragment', name: '发现漂流瓶', desc: '船员在海面上发现一个漂流瓶，里面竟是一张藏宝图的残片！', effect: { item: 'cang_bao_tu_can_pian' }, log: '获得物品【藏宝图残片】！' }
    ],
    negative: [
        { id: 'minor_storm', name: '遭遇风浪', desc: '一场不大不小的風暴来袭，部分货物被打湿损坏。', effect: { cargo_integrity: -10, morale: -5 }, log: '货物完好度-10%，船员士气-5。' },
        { id: 'becalmed', name: '陷入无风带', desc: '船只陷入了无风带，只能原地等待，白白消耗了补给。', effect: { turnsLeft: 1, morale: -8 }, log: '航程延长了一回合，船员士气-8。' },
        { id: 'crew_sickness', name: '船员染病', desc: '部分船员因水土不服染上了疾病，需要额外的医药开销。', effect: { supply_cost_increase: 200, morale: -10 }, log: '医药费导致补给开销增加200两，船员士气-10。' },
        { id: 'minor_pirates', name: '遭遇小股海盗', desc: '你们遭遇了一小股海盗的骚扰！', effect: { cargo_integrity: -5, morale: -5 }, log: '你们击退了海盗，但损失了少量货物。' },
        { id: 'navigational_error', name: '航向错误', desc: '因天气原因，船队偏离了预定航线，需要花费额外时间修正。', effect: { turnsLeft: 1, supply_cost_increase: 150 }, log: '航程延长一回合，补给开销增加150两。' }
    ],
    neutral: [
        { id: 'dolphins', name: '海豚伴游', desc: '一群海豚追逐着你们的船只嬉戏，船员们士气高涨。', effect: { morale: 5 }, log: '船员士气+5。' },
        { id: 'aurora', name: '目睹奇景', desc: '你们在夜间目睹了绚丽的奇景，此等景象令人终身难忘。', effect: { morale: 8 }, log: '船员士气+8。' },
        { id: 'old_sailor_story', name: '老水手的故事', desc: '船上的一位老水手讲述着他年轻时遭遇海怪的离奇故事，听得众人心惊胆战。', effect: { morale: -2 }, log: '船员士气微降。' }
    ]
};
const seaExplorationData = {
    captains: [
        { id: 'veteran', name: '老练的航海家', desc: '经验丰富，能大概率避开风暴。', cost: 1500, effect: { storm_chance_modifier: -0.2 } },
        { id: 'general', name: '退役的水师将领', desc: '骁勇善战，能有效对抗海盗。', cost: 2500, effect: { pirate_chance_modifier: -0.2, combat_bonus: 10 } },
        { id: 'local', name: '本地的渔民向导', desc: '熟悉近海水文，总能找到富饶之地。', cost: 800, effect: { base_profit_modifier: 1.2, high_reward_chance_modifier: -0.3 } }
    ],
    routes: [
        { id: 'east', name: '东方航线', desc: '前往盛产丝绸与瓷器的富庶之地，风平浪静，收益稳定。', risk: 'low', reward: 'medium', attribute: 'charm' },
        { id: 'south', name: '南方航线', desc: '前往遍地香料与宝石的异域，路途遥远，时有风暴。', risk: 'medium', reward: 'high', attribute: 'wisdom' },
        { id: 'unknown', name: '未知海域', desc: '探索迷雾笼罩的神秘海域，或是惊天宝藏，或是万丈深渊。', risk: 'high', reward: 'very_high', attribute: 'martial' }
    ],
    cargos: [
        { id: 'silk', name: '丝绸瓷器', space: 20, value: 150 },
        { id: 'grain', name: '粮食药材', space: 30, value: 100 },
        { id: 'tools', name: '铁器工具', space: 25, value: 120 }
    ],
    events: {
    success: [
         { desc: "发现异域奇珍，高价拍卖获利", multiplier: 2.0, bonus: { charm: 2 } },
         { desc: "进献权贵，声望大涨", multiplier: 1.2, bonus: { reputation: 20 } },
         { desc: "发现黄金航线，获得巨额回报", multiplier: 3.5, bonus: {} }
    ],
    failure: [
         { id: 'storm', desc: "遭遇风暴，断尾求生", loss_percent: 0.3, penalty: { health: -5 } },
         { id: 'pirate', desc: "遭遇海盗，血战逃脱", loss_percent: 0.5, penalty: { health: -15, martial: 2 } },
         { id: 'reef', desc: "船只触礁，损失惨重", loss_percent: 0.6, penalty: { health: -10 } }
    ]
}
};
// --- DATA: Feng Yue Jian (For Male Protagonist) ---
const fengYueJianData = {
    entry_cost: 50,
    courtesans: [
        { id: 'fyj_liu', name: '柳拂衣', title: '雪骨冰心', specialty: '琴艺诗词', personality: '清冷孤高', color: '#add8e6', redemption_cost: 20000, check_attribute: 'talent' },
        { id: 'fyj_su', name: '苏合', title: '玉面玲珑', specialty: '交际商道', personality: '八面玲珑', color: '#98fb98', redemption_cost: 15000, check_attribute: 'charm'},
        { id: 'fyj_yu', name: '虞美人', title: '人间尤物', specialty: '身世成谜', personality: '妩媚动人', color: '#ffc0cb', redemption_cost: 30000, check_attribute: 'wealth'},
        // ============= 新增NPC START =============
        { id: 'fyj_xue', name: '薛灵芸', title: '洛神临水', specialty: '一舞倾城', personality: '清冷', color: '#a0d2eb', redemption_cost: 25000, check_attribute: 'charm' },
        { id: 'fyj_qin', name: '秦梦卿', title: '醉卧红尘', specialty: '酒令棋局', personality: '洒脱', color: '#c3aed6', redemption_cost: 22000, check_attribute: 'wisdom' },
        { id: 'fyj_bai', name: '白玉奴', title: '红袖添香', specialty: '书画双绝', personality: '聪慧', color: '#f9d5a7', redemption_cost: 18000, check_attribute: 'talent' }
        // ============= 新增NPC END ===============
    ],
    interactions: [
        {id: 'chat', name: "聊天", cost: 30, favor: [2,4]},
        {id: 'dance', name: "看舞", cost: 100, favor: [4,8]},
        {id: 'music', name: "听琴", cost: 80, favor: [3,7]},
        {id: 'chess', name: "对弈", cost: 50, favor: [3,6]},
    ],
    sleep: { unlock_favor: 85, first_cost: 10000, subsequent_cost_factor: 0.5 },
    redeem: { unlock_favor: 95 }
};

// --- DATA: Career Challenges ---
const careerChallenges = {
    wen: [
        { level: 0, title: "书院辩经", desc: "书院举行辩经大会，你需要就'人性本善或本恶'立论。", options: [
            { text: "人性本善，皆可教化。", req: { virtue: 30 }, success: { performance: 10, virtue: 2 }, failure: { performance: -5 } },
            { text: "人性本恶，需礼法约束。", req: { wisdom: 30 }, success: { performance: 10, wisdom: 2 }, failure: { performance: -5 } },
            { text: "善恶交织，在于引导。", req: { wisdom: 20, virtue: 20 }, success: { performance: 15, wisdom: 1, virtue: 1 }, failure: { performance: -5 } },
        ]},
        { level: 2, title: "赈灾策论", desc: "淮河泛滥，灾民遍野。圣上命你十日内拟定赈灾章程。", options: [
             { text: '以工代赈，修堤筑坝。', req: { wisdom: 60 }, success: { performance: 30, reputation: 5 }, failure: { reputation: -5 } },
             { text: '开仓放粮，安抚民心。', req: { virtue: 50 }, success: { performance: 20, virtue: 5 }, failure: { reputation: -10 } },
             { text: '请求拨款，联络商贾。', req: { charm: 50 }, success: { performance: 25, wealth: 500 }, failure: { virtue: -5 } }
        ]},
          {
            level: 1,
            title: "科举应试",
            desc: "三年一度的科举考试即将开始，你需要做好准备参加考试。",
            options: [
                { 
                    text: "刻苦攻读，全力备考", 
                    req: { wisdom: 40 }, 
                    success: { performance: 25, wisdom: 3 }, 
                    failure: { performance: -10, health: -5 } 
                },
                { 
                    text: "拜访考官，打点关系", 
                    req: { charm: 35, wealth: 300 }, 
                    success: { performance: 30, reputation: -5 }, 
                    failure: { performance: -15, virtue: -10 } 
                },
                { 
                    text: "与同窗切磋交流", 
                    req: { talent: 30 }, 
                    success: { performance: 20, talent: 2 }, 
                    failure: { performance: -5 } 
                }
            ]
        },
        {
            level: 3,
            title: "处理民间纠纷",
            desc: "两村因水源问题发生争执，村民请求官府裁决。",
            options: [
                { 
                    text: "实地考察，公正裁决", 
                    req: { wisdom: 60, virtue: 50 }, 
                    success: { performance: 35, reputation: 10 }, 
                    failure: { performance: -15, reputation: -10 } 
                },
                { 
                    text: "安抚双方，寻求妥协", 
                    req: { charm: 55 }, 
                    success: { performance: 30, virtue: 5 }, 
                    failure: { performance: -10 } 
                },
                { 
                    text: "强势镇压，维护秩序", 
                    req: { martial: 45 }, 
                    success: { performance: 25 }, 
                    failure: { performance: -20, virtue: -10, reputation: -15 } 
                }
            ]
        },
        // 可以继续添加更多事件...
    ],
    wu: [
        { level: 1, title: "校场比武", desc: "将军检阅新兵，你被选中上台比武，展示武艺。", options: [
            { text: "猛虎下山，主动抢攻。", req: { martial: 30 }, success: { performance: 15, martial: 2 }, failure: { health: -5 } },
            { text: "稳扎稳打，后发制人。", req: { health: 30 }, success: { performance: 10, health: 2 }, failure: { martial: -2 } },
            { text: "虚晃一招，智取对手。", req: { wisdom: 20, martial: 20 }, success: { performance: 20, wisdom: 1, martial: 1 }, failure: { performance: -5 } },
        ]},
        { level: 3, title: "剿匪先锋", desc: "一伙山匪盘踞黑风岭，劫掠商队。你奉命带队清剿。", options: [
            { text: "正面强攻，势如破竹。", req: { health: 70 }, success: { performance: 40, martial: 5 }, failure: { health: -10 } },
            { text: "夜间奇袭，擒贼擒王。", req: { wisdom: 60 }, success: { performance: 30, wisdom: 5 }, failure: { performance: -10 } },
            { text: "劝降招安，兵不血刃。", req: { charm: 55 }, success: { performance: 25, charm: 5 }, failure: { reputation: -5 } }
        ]},
    ],
    shang: [
        { level: 2, title: "商会谈判", desc: "与'岭南珠市'的谈判陷入僵局，对方在珍珠价格上寸步不让。", options: [
            { text: "威逼利诱，暗示转向对手。", req: { charm: 60, wisdom: 50 }, success: { performance: 30, charm: 2 }, failure: { reputation: -5 } },
            { text: "情感投资，只交朋友不谈生意。", req: { virtue: 55 }, success: { performance: 20, virtue: 2, relation_favor: 20 }, failure: { wealth: -100 } },
            { text: "技术分析，指出其报价不合理。", req: { wisdom: 70 }, success: { performance: 35, wisdom: 2 }, failure: { wisdom: -2 } }
        ]}, {
            level: 1,
            title: "开拓新市场",
            desc: "发现一个潜在的商业机会，需要决定如何开拓新市场。",
            options: [
                { 
                    text: "大胆投资，迅速占领", 
                    req: { wisdom: 40, wealth: 500 }, 
                    success: { performance: 35, wealth: 200 }, 
                    failure: { performance: -15, wealth: -300 } 
                },
                { 
                    text: "谨慎试探，逐步推进", 
                    req: { wisdom: 50 }, 
                    success: { performance: 25, wisdom: 3 }, 
                    failure: { performance: -10, wealth: -100 } 
                },
                { 
                    text: "寻找合作伙伴", 
                    req: { charm: 45 }, 
                    success: { performance: 30, charm: 2 }, 
                    failure: { performance: -5 } 
                }
            ]
        }
        // 更多商贾事件... 
    ]
};


// =======================================================================
// ======================== 收徒系统实现 ================================
// =======================================================================

// 徒弟数据结构
const apprenticeData = {
    // 徒弟属性配置
    baseAttributes: {
        talent: { min: 10, max: 30 },
        wisdom: { min: 10, max: 30 },
        health: { min: 70, max: 90 },
        virtue: { min: 10, max: 30 },
        charm: { min: 10, max: 30 },
        etiquette: { min: 10, max: 30 },
        martial: { min: 10, max: 30 }
    },
    
    // 徒弟成长配置
    growthRates: {
        talent: 0.8,
        wisdom: 1.0,
        health: 0.3,
        virtue: 0.7,
        charm: 0.9,
        etiquette: 0.6,
        martial: 1.1
    },
    
    // 徒弟类型
    types: [
        {
            name: "聪慧型",
            desc: "天资聪颖，悟性极高，擅长智慧型工作",
            attributesBonus: { wisdom: 10, talent: 5 },
            growthBonus: { wisdom: 0.2, talent: 0.1 },
            assistBonus: { wisdom: 5 }
        },
        {
            name: "勤奋型",
            desc: "刻苦努力，脚踏实地，各项能力均衡发展",
            attributesBonus: { virtue: 10, health: 5 },
            growthBonus: { virtue: 0.2, health: 0.1 },
            assistBonus: { virtue: 5 }
        },
        {
            name: "灵巧型",
            desc: "心灵手巧，才艺出众，擅长创意型工作",
            attributesBonus: { talent: 10, charm: 5 },
            growthBonus: { talent: 0.2, charm: 0.1 },
            assistBonus: { talent: 5 }
        },
        {
            name: "武勇型",
            desc: "体魄强健，勇武过人，擅长体力型工作",
            attributesBonus: { martial: 10, health: 5 },
            growthBonus: { martial: 0.2, health: 0.1 },
            assistBonus: { martial: 5 }
        }
    ],
    
    // 互动选项
    interactions: [
        {
            id: "teach",
            name: "传授知识",
            desc: "花费时间指导徒弟，提升其属性",
            cost: { action: true },
            effect: { apprentice: { attributes: { wisdom: 7, talent: 4 } }, master: { attributes: { wisdom: 4 } } }
        },
        {
            id: "practice",
            name: "共同修炼",
            desc: "与徒弟一起修炼，提升武学与健康",
            cost: { action: true },
            effect: { apprentice: { attributes: { martial: 7, health: 4 } }, master: { attributes: { martial: 4, health: 4 } } }
        },
        {
            id: "socialize",
            name: "社交礼仪",
            desc: "教导徒弟社交礼仪，提升魅力与礼仪",
            cost: { action: true, wealth: 50 },
            effect: { apprentice: { attributes: { charm: 7, etiquette: 7 } }, master: { attributes: { charm: 4 } } }
        },
        {
            id: "assign_work",
            name: "指派工作",
            desc: "让徒弟协助完成工作，获得额外收益",
            cost: { action: true },
            effect: { master: { career_performance: 40, wealth: 400 } }
        },
        // 新增互动选项
        {
            id: "mentor",
            name: "人生指导",
            desc: "给予徒弟人生建议，提升品德与智慧",
            cost: { action: true },
            effect: { apprentice: { attributes: { virtue: 7, wisdom: 7 } }, master: { attributes: { virtue: 4 } } }
        },
        {
            id: "gift_money",
            name: "赠予银钱",
            desc: "给予徒弟一些银钱，大幅提升好感度",
            cost: { wealth: 400 },
            effect: { apprentice: { favor: 45 } }
        }
    ],
    
    // 出师条件
    graduationConditions: [
        { type: "age", value: 18, desc: "年满18岁" },
        { type: "attribute", attribute: "wisdom", value: 60, desc: "智慧达到60" },
        { type: "attribute", attribute: "talent", value: 60, desc: "才情达到60" }
    ],
    
    // 出师奖励
    graduationRewards: {
        wealth: 2000,
        reputation: 50,
        items: ["名师匾额", "谢师礼"]
    }
};

// 师徒试炼事件 (新增)
const apprenticeTrials = {
    talent: {
        title: "才情试炼",
        desc: "爱徒的才情似遇瓶颈，神色郁郁。你听闻城中即将举办诗会，或许这正是个展现实力的好机会？",
        options: [
            {
                text: "亲自指点 (消耗1行动点)",
                cost: { action: true },
                effect: { apprentice: { attributes: { talent: 8 } }, master: { attributes: { talent: 1 } }, favor: 5 },
                successRate: 1.0
            },
            {
                text: "安排历练 (消耗100两)",
                cost: { wealth: 100 },
                effect: { apprentice: { attributes: { talent: 5 } }, reward: { wealth: 50 } },
                successRate: 0.8,
                failureEffect: { apprentice: { attributes: { health: -5 } }, favor: -5 }
            },
            {
                text: "置之不理",
                cost: {},
                effect: { apprentice: { attributes: { talent: 2 } } },
                successRate: 0.3,
                failureEffect: { apprentice: { growthRate: { talent: -0.2 } }, favor: -5 }
            }
        ]
    },
    martial: {
        title: "武学试炼",
        desc: "爱徒的武学似遇瓶颈，神色郁郁。你听闻城郊有恶霸滋扰百姓，或许这正是个实战历练的好机会？",
        options: [
            {
                text: "亲自指点 (消耗1行动点)",
                cost: { action: true },
                effect: { apprentice: { attributes: { martial: 8 } }, master: { attributes: { martial: 1 } }, favor: 5 },
                successRate: 1.0
            },
            {
                text: "安排历练 (消耗100两)",
                cost: { wealth: 100 },
                effect: { apprentice: { attributes: { martial: 5 } }, reward: { reputation: 10 } },
                successRate: 0.7,
                failureEffect: { apprentice: { attributes: { health: -10 } }, favor: -10 }
            },
            {
                text: "置之不理",
                cost: {},
                effect: { apprentice: { attributes: { martial: 2 } } },
                successRate: 0.4,
                failureEffect: { apprentice: { growthRate: { martial: -0.2 } }, favor: -5 }
            }
        ]
    }
};

// 师徒社交事件 (新增)
const apprenticeSpecialEvents = [
    {
        title: "徒弟的困惑",
        desc: "你的徒弟在修炼中遇到了难题，前来向你请教。",
        options: [
            {
                text: "耐心解答 (消耗1行动点)",
                cost: { action: true },
                effect: { apprentice: { attributes: { wisdom: 5 } }, master: { attributes: { wisdom: 2 } } },
                result_text: "你耐心解答，徒弟豁然开朗，并对你更为崇敬。"
            },
            {
                text: "让TA自行领悟",
                effect: { apprentice: { attributes: { wisdom: 2 } }, favor: -5 },
                result_text: "你选择让徒弟独自面对，TA虽然有所领悟，但内心对你有些疏远。"
            }
        ]
    },
    {
        title: "徒弟的成长",
        desc: "你注意到徒弟在某方面有了显著的进步。",
        options: [
            {
                text: "给予奖励 (消耗50两)",
                cost: { wealth: 50 },
                effect: { apprentice: { favor: 10, attributes: { talent: 3 } } },
                result_text: "你给了徒弟50两作为奖励，TA对你的好感度大增。"
            },
            {
                text: "提出更高要求",
                effect: { apprentice: { attributes: { talent: 5, virtue: 2 } }, favor: -3 },
                result_text: "你对徒弟提出了更高的要求，虽然TA的潜力被激发，但有些不开心。"
            }
        ]
    },
    {
        title: "徒弟的比试",
        desc: "你的徒弟与其他门下的弟子约定了一场比试，前来请求你的指导。",
        options: [
            {
                text: "进行特训 (消耗1行动点)",
                cost: { action: true },
                effect: { apprentice: { attributes: { martial: 10, health: 5 } }, favor: 10 },
                result_text: "你对徒弟进行了特训，TA在比试中大获全胜，名声大噪！"
            },
            {
                text: "赠送金疮药 (消耗100两)",
                cost: { wealth: 100 },
                effect: { apprentice: { attributes: { health: 10 } }, favor: 5 },
                result_text: "你给了徒弟100两银钱，并叮嘱TA小心，TA感到十分暖心。"
            },
            {
                text: "放任其自由发挥",
                effect: { apprentice: { attributes: { wisdom: 5 } }, favor: -5 },
                result_text: "你让徒弟自行处理，虽然TA最终赢了，但觉得自己没有得到你的重视。"
            }
        ]
    },
    {
        title: "徒弟的瓶颈",
        desc: "你的徒弟在学业上遇到了瓶颈，向你诉说自己的苦恼。",
        options: [
            {
                text: "带其出游散心 (消耗200两)",
                cost: { wealth: 200 },
                effect: { apprentice: { attributes: { wisdom: 5, charm: 5 } }, favor: 15 },
                result_text: "你带徒弟出游，不仅解决了TA的瓶颈，还让TA身心愉悦。"
            },
            {
                text: "鼓励其自行克服",
                effect: { apprentice: { attributes: { virtue: 8 } }, favor: -5 },
                result_text: "你鼓励徒弟，虽然没有直接帮助，但磨炼了TA的意志。"
            },
            {
                text: "不予理会",
                effect: { apprentice: { attributes: { virtue: -5 } }, favor: -10 },
                result_text: "你对徒弟的苦恼不予理会，TA感到被冷落，品德和好感度均有下降。"
            }
        ]
    },
    {
        title: "徒弟的求助",
        desc: "你的徒弟家中突遭变故，急需一笔钱来渡过难关。",
        options: [
            {
                text: "慷慨解囊 (消耗500两)",
                cost: { wealth: 500 },
                effect: { apprentice: { favor: 30, virtue: 10 }, master: { attributes: { virtue: 5 } } },
                result_text: "你慷慨解囊，帮助徒弟渡过难关。徒弟对你忠心耿耿，你的品德也得到提升。"
            },
            {
                text: "借出银钱 (消耗500两)",
                cost: { wealth: 500 },
                effect: { apprentice: { favor: 15 } },
                result_text: "你借给徒弟500两，但徒弟心中有压力，好感度提升不大。"
            },
            {
                text: "表示无能为力",
                effect: { apprentice: { favor: -20 } },
                result_text: "你表示无能为力，徒弟感到失望，好感度大幅下降。"
            }
        ]
    },
    {
        title: "徒弟的仰慕者",
        desc: "你的徒弟因才貌出众，引来了城中某位公子的追求，TA对此感到困扰。",
        options: [
            {
                text: "出面解决麻烦 (消耗1行动点)",
                cost: { action: true },
                effect: { apprentice: { favor: 15, attributes: { charm: 3 } } },
                result_text: "你出面解决了这个麻烦，徒弟对你充满感激，魅力也得到提升。"
            },
            {
                text: "让TA自行处理",
                effect: { apprentice: { attributes: { wisdom: 5 } } },
                result_text: "你让徒弟自行应对，TA最终巧妙化解了困扰，智慧有所成长。"
            },
            {
                text: "撮合这门亲事 (消耗200两)",
                cost: { wealth: 200 },
                effect: { apprentice: { favor: -10 } },
                result_text: "你擅自做主撮合了这门亲事，徒弟感到被控制，好感度下降。"
            }
        ]
    },
    {
        title: "徒弟的秘密",
        desc: "你无意中发现了徒弟的一个秘密，TA似乎身怀异宝，但又害怕被人发现。",
        options: [
            {
                text: "替TA保守秘密",
                effect: { apprentice: { favor: 20, attributes: { virtue: 10 } } },
                result_text: "你选择为徒弟保守秘密，TA对你无比信赖，你的品德也得到提升。"
            },
            {
                text: "劝TA上交异宝",
                effect: { apprentice: { favor: -15 } },
                result_text: "你劝徒弟上交异宝，TA虽然听从了，但对你产生了隔阂。"
            },
            {
                text: "夺取异宝",
                effect: { apprentice: { favor: -50, virtue: -20 } },
                result_text: "你夺取了异宝，但永远失去了徒弟的信任，你的品德也受到严重损害。"
            }
        ]
    },
    {
        title: "徒弟的善行",
        desc: "你发现徒弟在城外为流浪儿施粥，但此举会消耗TA的不少精力。",
        options: [
            {
                text: "支持并提供资金 (消耗300两)",
                cost: { wealth: 300 },
                effect: { apprentice: { favor: 10, attributes: { virtue: 15 } }, master: { attributes: { reputation: 5 } } },
                result_text: "你支持徒弟的善行，提供了300两银钱。你们的善举得到世人称赞，声望有所提升。"
            },
            {
                text: "鼓励但不支持",
                effect: { apprentice: { favor: 5, attributes: { virtue: 5 } } },
                result_text: "你口头鼓励了徒弟，TA的品德得到小幅提升，但你没有提供实际帮助。"
            },
            {
                text: "阻止其浪费精力",
                effect: { apprentice: { favor: -5, attributes: { virtue: -5 } } },
                result_text: "你阻止了徒弟的善行，TA感到非常不解，品德和好感度均有下降。"
            }
        ]
    },
    {
        title: "徒弟的才华",
        desc: "你的徒弟创作出了一部非常优秀的作品，但因为缺乏名气，无人问津。",
        options: [
            {
                text: "以你的名义举荐",
                effect: { apprentice: { favor: 20, attributes: { talent: 10 } }, master: { attributes: { reputation: 10 } } },
                result_text: "你以你的名义举荐了徒弟的作品，作品大卖，你们师徒二人的名声都得到了提升。"
            },
            {
                text: "花钱为TA宣传 (消耗150两)",
                cost: { wealth: 150 },
                effect: { apprentice: { favor: 10, attributes: { talent: 5 } } },
                result_text: "你花费150两为徒弟的作品进行宣传，作品得到关注，徒弟的才情和好感度都有提升。"
            },
            {
                text: "让TA自己努力",
                effect: { apprentice: { attributes: { talent: 2 } }, favor: -5 },
                result_text: "你让徒弟自己去努力，TA虽然有所成长，但觉得你不够重视TA。"
            }
        ]
    }
];

// ================== [新增] 红笺寄情 & 情人系统核心数据 (V2-职业联动版) ===================
// =======================================================================================
const POETRY_DATA = {
    婉约: ["月下初见君", "愿为画中人", "此情可待成追忆", "人面桃花相映红", "只愿君心似我心", "玲珑骰子安红豆"],
    豪放: ["一见倾心，再见倾城", "愿为君披甲", "与君共饮江湖酒", "我寄愁心与明月", "大风起兮云飞扬", "醉卧沙场君莫笑"],
    承诺: ["执子之手，与子偕老", "共赴白首约", "此生不负相思意", "山无棱，天地合", "结发为夫妻", "恩爱两不疑"]
};

// 【核心修改】为每个职业定义专属的信物制作材料
const CAREER_CRAFTING_ITEMS = {
    'civilian': { id: 'oath_bamboo_slip', name: '盟誓竹简', icon: 'fa-scroll', type: '材料', desc: '文官处理公务时用以记录盟誓的竹简，质地坚韧，象征着不变的承诺。' },
    'warrior': { id: 'battle_worn_tassel', name: '历战剑穗', icon: 'fa-khanda', type: '材料', desc: '从百战不挠的佩剑上取下的剑穗，浸染着沙场豪情与守护之意。' },
    'merchant': { id: 'abacus_bead_bracelet', name: '玲珑算盘珠', icon: 'fa-calculator', type: '材料', desc: '商贾们用最名贵的木料打磨的算盘珠，象征着精打细算的爱意。' },
    'scholar': { id: 'ink_heart_stone', name: '墨心石', icon: 'fa-paint-brush', type: '材料', desc: '文人墨客视若珍宝的石砚，磨出的墨带有奇香，用以书写情诗最佳。' },
    'ranger': { id: 'heroic_wine_gourd', name: '侠义酒葫', icon: 'fa-wine-bottle', type: '材料', desc: '江湖游侠随身携带的酒葫芦，装过最烈的酒，也装着最真的情。' },
    'matron': { id: 'seven_ingenuity_thread', name: '七巧丝线', icon: 'fa-ribbon', type: '材料', desc: '主母在乞巧节时求得的七彩丝线，据说能编织出世上最牢固的同心结。' },
    'embroiderer': { id: 'phoenix_tail_pin', name: '凤尾金针', icon: 'fa-cut', type: '材料', desc: '绣娘梦寐以求的御赐金针，能绣出栩栩如生的凤凰，象征着至高无上的爱。' },
    'doctor': { id: 'longevity_herb', name: '长生草', icon: 'fa-leaf', type: '材料', desc: '女医踏遍千山寻得的珍稀草药，虽不能长生，却代表着愿对方一世安康的心意。' },
    'spy_master': { id: 'invisible_ink', name: '无迹墨', icon: 'fa-feather-alt', type: '材料', desc: '情报首领用独门秘法调制的墨水，写下的情书唯有真爱之人可见。' }
};

// 【核心修改】将信物制作的要求从“金钱”改为“职业专属材料”
const TOKEN_DATA = {
    'tongxinjie': { name: '同心结香囊', req: { item: 'seven_ingenuity_thread' }, quality_attr: 'talent', target: ['温柔', '端庄'], stats: { romance: 15, sincerity: 20 } },
    'yup佩': { name: '双鱼玉佩', req: { item: 'abacus_bead_bracelet' }, quality_attr: 'random', target: ['权贵', '富商'], stats: { sincerity: 25 } },
    'muzhan': { name: '亲刻木簪', req: { item: 'ink_heart_stone' }, quality_attr: 'talent', target: ['清冷', '才女'], stats: { romance: 20, sincerity: 15 } },
    'jiansui': { name: '宝剑剑穗', req: { item: 'battle_worn_tassel' }, quality_attr: 'random', target: ['武将', '侠客'], stats: { sincerity: 20 } },
    'shiji': { name: '手抄诗集', req: { item: 'oath_bamboo_slip' }, quality_attr: 'talent', target: ['文人', '书生'], stats: { romance: 25 } },
    // 你可以继续为 ranger, doctor, spy_master 等职业添加专属信物
    'wine_gourd_pendant': { name: '酒葫芦挂坠', req: { item: 'heroic_wine_gourd' }, quality_attr: 'random', target: ['侠客', '洒脱'], stats: { sincerity: 22 } },
    'herbal_sachet': { name: '安神药包', req: { item: 'longevity_herb' }, quality_attr: 'wisdom', target: ['体弱', '内敛'], stats: { romance: 10, sincerity: 28 } },
    'secret_letter': { name: '密文情信', req: { item: 'invisible_ink' }, quality_attr: 'wisdom', target: ['聪慧', '多疑'], stats: { romance: 30 } }
};

let confessionState = {}; // 用于存储表白过程中的临时数据

/**
 * 核心功能1：开始表白流程的总入口
 * 当玩家点击“红笺寄情”时，此函数被调用。
 */
function startConfessionProcess(npcId) {
    // 【新增】检查本回合是否已经表白过
    if (gameState.flags.confessionAttemptedThisTurn) {
        showToast("你今日已表白过心意，请待下回分晓。");
        return;
    }

    // 每次开始都重置状态，防止数据残留
    confessionState = { targetNpcId: npcId, poem: null, token: null };
    
    // 显示一个决策弹窗，让玩家选择先准备哪一项
    showDecisionCard(
        '红笺寄情', 
        'fa-pen-fancy', 
        '你决定向对方表明心意，此事需精心准备，方显诚意。', 
        [
            { htmlContent: '✍️ 书写情诗', callback: () => showPoetryEditor(npcId) },
            { htmlContent: '🎁 准备信物', callback: () => showTokenCrafting(npcId) }
        ]
    );
}
function showPoetryEditor(npcId) {
    const playerTalent = gameState.player.attributes.talent || 0;
    let fragmentsHTML = '';
    
    // [修改] 为每个诗句碎片增加 onclick 事件
    const addFragmentToLine = (text) => {
        const firstEmptySlot = document.querySelector('.poetry-line:not(.filled)');
        if (firstEmptySlot) {
            firstEmptySlot.textContent = text;
            firstEmptySlot.classList.add('filled');
        } else {
            showToast("诗笺已满。");
        }
    };
    
    window.addFragmentToLine = addFragmentToLine; // 将函数挂载到 window，以便 onclick 可以调用

    ['婉约', '豪放', '承诺'].forEach(style => {
        fragmentsHTML += `<h5>${style}派</h5>`;
        for(let i=0; i<2; i++) {
            const isGoodVerse = Math.random() < playerTalent / 150;
            const verse = getRandomElement(POETRY_DATA[style]);
            // 在这里添加 onclick="window.addFragmentToLine(\`${verse}\`)"
            fragmentsHTML += `<div class="fragment" draggable="true" ondragstart="drag(event)" onclick="window.addFragmentToLine(\`${verse}\`)" style="${isGoodVerse ? 'color: var(--highlight-strong); font-weight: bold;' : ''}">${verse}</div>`;
        }
    });

    const content = `
        <p class="comment" style="text-align:center;">可以拖拽或点击右侧诗句来填写诗笺。</p>
        <div class="poetry-editor-container">
            <div class="poetry-scroll">
                <div class="poetry-line" ondrop="drop(event, this)" ondragover="allowDrop(event)"></div>
                <div class="poetry-line" ondrop="drop(event, this)" ondragover="allowDrop(event)"></div>
                <div class="poetry-line" ondrop="drop(event, this)" ondragover="allowDrop(event)"></div>
                <div class="poetry-line" ondrop="drop(event, this)" ondragover="allowDrop(event)"></div>
            </div>
            <div class="poetry-fragments">${fragmentsHTML}</div>
        </div>
        <input type="text" id="selfComposeInput" class="self-compose-input" placeholder="或可自拟一句... (按回车确认)">
        <button class="control-btn" style="margin-top:15px;" onclick="craftPoem('${npcId}')">完成诗作</button>
    `;
    
    document.getElementById('poetryEditorContent').innerHTML = content;
    showOverlay('poetryEditorOverlay');

    document.getElementById('selfComposeInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            const line = this.value.trim();
            if (line) {
                window.addFragmentToLine(line); // 调用通用函数
                this.value = '';
            }
        }
    });
} 
function craftPoem(npcId) {
    const lines = Array.from(document.querySelectorAll('.poetry-line')).map(el => el.textContent.trim()).filter(Boolean);
    if (lines.length < 1) {
        showToast("至少需有一句诗。");
        return;
    }
    
    // 根据诗句内容和玩家才情计算诗歌的“浪漫值”和“承诺值”
    let romance = 0, commitment = 0;
    lines.forEach(line => {
        if (POETRY_DATA.婉约.includes(line) || POETRY_DATA.豪放.includes(line)) romance += 5;
        if (POETRY_DATA.承诺.includes(line)) commitment += 8; // 承诺的诗句更显诚意
        if (!Object.values(POETRY_DATA).flat().includes(line)) romance += 3; // 自拟的诗句加分
    });

    romance += Math.floor(gameState.player.attributes.talent / 10);
    
    const poem = { 
        name: `情意绵绵的诗笺`, 
        desc: `一封寄托着你心意的诗笺。`, 
        type: '珍品', 
        icon: 'fa-scroll', 
        romance: romance, 
        commitment: commitment 
    };
    confessionState.poem = poem;
    
    showEventCard('诗作成', 'fa-check', `你已完成诗作。<br><strong class="value">浪漫+${romance}, 承诺+${commitment}</strong>`);
    
    // 【核心修改】检查信物是否已准备好，如果没有，则引导玩家去准备信物
    // 延迟执行以确保 showEventCard 的弹窗可以先关闭
    setTimeout(() => {
        if (confessionState.token) {
            checkConfessionReady(); // 如果信物已备好，直接进入最后一步
        } else {
            showTokenCrafting(confessionState.targetNpcId); // 否则，引导去制作信物
        }
    }, 300); // 延迟300毫秒
}
// [用这个新版本替换] showTokenCrafting 函数
function showTokenCrafting(npcId) {
    let content = Object.entries(TOKEN_DATA).map(([id, data]) => {
        const requiredItemId = data.req.item;
        const requiredItemDef = ITEM_DATA[requiredItemId];
        const canCraft = hasItemInInventory(requiredItemId);

        // ▼▼▼【核心代码】这部分逻辑是您当前文件中缺失的 ▼▼▼
        let sourceText = '职业事件'; // 默认的获取途径文本
        
        // 查找这个材料是由哪个职业产出的
        const sourceCareerId = Object.keys(CAREER_CRAFTING_ITEMS).find(
            careerId => CAREER_CRAFTING_ITEMS[careerId].id === requiredItemId
        );
        
        // 如果找到了对应的职业信息
        if (sourceCareerId && PROFESSION_DATA[sourceCareerId]) {
            const careerName = PROFESSION_DATA[sourceCareerId].name;
            // 更新途径文本，使其更具体，并使用我们修正后的“及以上”
            sourceText = `${careerName} (需Lv.2及以上)`;
        }
        // ▲▲▲ 缺失的逻辑到此结束 ▲▲▲

        let reqText = '';
        if (!canCraft) {
            reqText += `缺少材料: ${requiredItemDef ? requiredItemDef.name : '未知材料'}`;
        }
        
        return `
        <div class="token-option ${!canCraft ? 'disabled' : ''}" onclick="${canCraft ? `craftToken('${npcId}', '${id}')` : ''}">
            <div class="token-icon"><i class="fas fa-gift"></i></div>
            <div class="token-details">
                <strong>${data.name}</strong><br>
                {/* ▼▼▼【核心代码】使用上面生成的 sourceText 替换掉写死的文本 ▼▼▼ */}
                <small>需要: <span class="value">${requiredItemDef ? requiredItemDef.name : '特殊材料'}</span> | 来自: <span class="value">${sourceText}</span></small>
                ${!canCraft ? `<br><small style="color:red;">${reqText}</small>` : ''}
            </div>
        </div>`;
    }).join('');

    // 【保留功能】这部分是您已有的“豪掷千金”选项，完全保留
    const moneyOptionCost = 5000;
    const canAffordMoneyOption = gameState.finances.wealth >= moneyOptionCost;
    content += `
        <div style="text-align: center; color: var(--text-comment); margin: 15px 0;">— 或 —</div>
        <div class="token-option ${!canAffordMoneyOption ? 'disabled' : ''}" onclick="${canAffordMoneyOption ? `craftTokenWithMoney('${npcId}')` : ''}">
            <div class="token-icon"><i class="fas fa-gem"></i></div>
            <div class="token-details">
                <strong>豪掷千金</strong><br>
                <small>花费 <span class="value">${moneyOptionCost}</span> 两，准备一份万能的奇珍异宝作为信物。</small>
                ${!canAffordMoneyOption ? `<br><small style="color:red;">资金不足</small>` : ''}
            </div>
        </div>
    `;
    document.getElementById('tokenCraftingContent').innerHTML = content;
    showOverlay('tokenCraftingOverlay');
}
function craftTokenWithMoney(npcId) {
    const cost = 5000;
    if (gameState.finances.wealth < cost) {
        showToast("资金不足！");
        return;
    }

    applyEffects({ wealth: -cost });

    // 创建一个属性不错的通用信物
    const token = { 
        name: `稀世奇珍`, 
        desc: `你花费重金购得的宝物，足以代表你的心意。`, 
        type: '珍品', 
        icon: 'fa-gem', 
        sincerity: 30 + Math.floor(gameState.player.attributes.charm / 10) // 魅力越高，挑选的礼物越好
    };

    confessionState.token = token;

    showEventCard('信物备妥', 'fa-check', `你花费 <strong class="value">${cost}</strong> 两，成功购得了 <strong class="value">${token.name}</strong>。<br><strong class="value">心意+${token.sincerity}</strong>`);

    // 这部分逻辑和 craftToken 函数保持一致，确保流程顺畅
    setTimeout(() => {
        if (confessionState.poem) {
            checkConfessionReady();
        } else {
            showPoetryEditor(confessionState.targetNpcId);
        }
    }, 300);
}
// [用这个新版本替换]
function craftToken(npcId, tokenId) {
    const data = TOKEN_DATA[tokenId];
    const requiredItemId = data.req.item;

    // 【核心修改】消耗物品栏中的材料，而不是扣钱
    if (!removeItemFromInventory(requiredItemId, 1)) {
        showToast("制作失败，材料不足！");
        return;
    }

    let qualityBonus = 0;
    if (data.quality_attr === 'random') {
        qualityBonus = getRandomInt(-5, 10);
    } else {
        // 确保属性存在，避免错误
        const attrValue = gameState.player.attributes[data.quality_attr] || 0;
        qualityBonus = Math.floor(attrValue / 10);
    }

    const token = { 
        name: `精致的${data.name}`, 
        desc: `你精心准备的信物。`, 
        type: '珍品', 
        icon: 'fa-gift', 
        ...data.stats 
    };
    if (token.sincerity) {
        token.sincerity += qualityBonus;
    }

    confessionState.token = token;

    showEventCard('信物备妥', 'fa-check', `你使用了<strong class="value">【${ITEM_DATA[requiredItemId].name}】</strong>，成功制作了 <strong class="value">${token.name}</strong>。<br><strong class="value">心意+${token.sincerity || 0}</strong>`);

    // 【核心修改】检查情诗是否已准备好，如果没有，则引导玩家去写诗
    // 延迟执行以确保 showEventCard 的弹窗可以先关闭
    setTimeout(() => {
        if (confessionState.poem) {
            checkConfessionReady(); // 如果情诗已备好，直接进入最后一步
        } else {
            showPoetryEditor(confessionState.targetNpcId); // 否则，引导去写诗
        }
    }, 300); // 延迟300毫秒
} 
function checkConfessionReady() {
    // 只有当诗和信物都存在时，才进行下一步
    if (confessionState.poem && confessionState.token) {
        // 关闭当前可能打开的编辑器/制作台
        closeAllOverlays();
        
        // 延迟一点点，让UI关闭动画完成，防止闪烁
        setTimeout(() => {
            showDecisionCard('准备妥当', 'fa-paper-plane', '情诗与信物均已备好，你打算如何将这份心意传达给TA？', [
                { htmlContent: '托心腹转交', callback: () => handleConfessionDelivery('servant') },
                { htmlContent: '飞鸽传书', callback: () => handleConfessionDelivery('pigeon') },
                { htmlContent: '当面递交', callback: () => handleConfessionDelivery('in_person') },
            ]);
        }, 300);

    } else {
        // 如果只完成了一项，就回到最初的选项界面，让玩家继续准备另一项
        startConfessionProcess(confessionState.targetNpcId);
    }
}

/**
 * 核心功能7：处理最终的表白递送和结果判定
 */
function handleConfessionDelivery(method) {
    // 【新增】在表白流程开始时，立刻设置标记，阻止本回合再次表白
    gameState.flags.confessionAttemptedThisTurn = true;

    const npc = gameState.npcs[confessionState.targetNpcId];
    let successRate = 0.5; // 基础成功率
    let resultLog = [];

    // 根据递送方式调整成功率
    switch(method) {
        case 'servant': successRate += 0.05; resultLog.push('你将信物与诗笺交予心腹，托其转交。'); break;
        case 'pigeon': successRate -= 0.1; resultLog.push('你将信与物系于鸽足，放飞于天际，心中不免有些忐忑。'); break;
        case 'in_person': successRate += 0.2; resultLog.push('你鼓起勇气，决定当面将这份心意交予对方。'); break;
    }

    // 根据诗和信物的总属性计算成功率加成
    const totalScore = (confessionState.poem.romance || 0) + (confessionState.poem.commitment || 0) + (confessionState.token.sincerity || 0);
    successRate += totalScore / 150; // 总分越高，加成越多
    resultLog.push(`你的诗文与信物共计提供了 <strong class="value">${Math.round(totalScore / 150 * 100)}%</strong> 的成功率加成。`);

    // 根据好感度计算成功率加成
    successRate += npc.favor / 250;
    resultLog.push(`你们的当前好感提供了 <strong class="value">${Math.round(npc.favor / 250 * 100)}%</strong> 的成功率加成。`);
    
    successRate = Math.min(0.98, successRate); // 最高98%成功率

    if (Math.random() < successRate) {
        // 表白成功
        resultLog.push(`<br><strong><span style="color:green;">表白成功！</span></strong>`);
        resultLog.push(`对方收下了你的心意，面若桃花，含羞应允。你们的关系正式确立！`);
        
        showEventCard('两情相悦', 'fa-heart', resultLog.join('<br>'));
        
        // 自动转为情人关系
        applyEffects({ relationship: { targetId: npc.id, favor: 50, emotionValue: 100 } });
        const rel = gameState.social.relationships[npc.id];
        if (rel) {
            rel.type = 'lover';
            rel.level = 1; // 关系等级提升
            if(!gameState.social.secretLovers.includes(npc.id)) {
                gameState.social.secretLovers.push(npc.id);
            }
        }
    } else {
        // 表白失败
        resultLog.push(`<br><strong><span style="color:red;">表白失败...</span></strong>`);
        resultLog.push(`“承蒙厚爱，然你我...有缘无分。”对方婉拒了你的心意。`);
        showEventCard('有缘无分', 'fa-heart-broken', resultLog.join('<br>'));
        applyEffects({ relationship: { targetId: npc.id, favor: -20 } });
    }
    
    // 清空本次表白的状态
    confessionState = {};
}// 初始化徒弟系统
function initApprenticeSystem() {
    if (!gameState.apprentices) {
        gameState.apprentices = [];
    }
    if (!gameState.apprenticeSlots) {
        gameState.apprenticeSlots = 1; // 初始徒弟槽位
    }
}

// 【已修复】检查是否可以收徒 (改回声望判断)
function canTakeApprentice() {
    // 过滤掉已出师的徒弟来计算当前占用的槽位数
    const activeApprentices = gameState.apprentices.filter(a => a.state !== 'graduated').length;
    return activeApprentices < gameState.apprenticeSlots;
}
// 【已修复】生成随机徒弟 (补上成长率)
function generateRandomApprentice() {
    const gender = Math.random() > 0.5 ? 'male' : 'female';
    const type = getRandomElement(apprenticeData.types);
    const surname = getRandomElement(nameData.surnames);
    const givenName = gender === 'female' ?
        getRandomElement(nameData.girlNames) :
        getRandomElement(nameData.boyNames);

    const attributes = {};
    for (const [attr, range] of Object.entries(apprenticeData.baseAttributes)) {
        attributes[attr] = getRandomInt(range.min, range.max);
    }

    for (const [attr, bonus] of Object.entries(type.attributesBonus)) {
        attributes[attr] += bonus;
    }
    
    // 复制基础成长率
    const growthRates = { ...apprenticeData.growthRates };
    // 应用类型成长加成
    for (const [attr, bonus] of Object.entries(type.growthBonus)) {
        growthRates[attr] += bonus;
    }

    return {
        id: `apprentice_${Date.now()}_${getRandomInt(1000, 9999)}`,
        name: `${surname}${givenName}`,
        gender: gender,
        age: 14,
        type: type.name,
        attributes: attributes,
        growthRates: growthRates, // <--- 补上这一行
        favor: 50,
        state: 'learning',
        avatar: getRandomElement(avatarPools[gender]),
    };
}

// 【已修复】显示收徒界面 (改回收徒条件判断)
function showApprenticeSystem() {
    const content = document.getElementById('apprenticeSystemContent');
    let html = '';

    // 使用修复后的 canTakeApprentice 逻辑
    if (gameState.family.reputation < 50) {
        html = `
            <div class="overlay-content">
                <p>收徒功能尚未解锁。</p>
                <p>需要声望达到50点方可收徒。</p>
                <p>当前声望: ${gameState.family.reputation}</p>
            </div>
        `;
    } else {
        if (gameState.apprentices.length > 0) {
            html += `<div class="section-header"><i class="fas fa-users"></i> 我的徒弟</div>`;
            gameState.apprentices.forEach(apprentice => {
                html += renderApprenticeCard(apprentice);
            });
        }
        
        // ▼▼▼ 核心修改部分 ▼▼▼
        if (gameState.apprentices.length < gameState.apprenticeSlots) {
            html += `
                <div class="section-header"><i class="fas fa-user-plus"></i> 招收新徒</div>
                <p>你可以招收一名新徒弟：</p>
                <button class="apprentice-option" onclick="takeNewApprentice()">
                    <i class="fas fa-graduation-cap"></i> 招收徒弟
                </button>
            `;
        } else {
            const nextUpgrade = APPRENTICE_SLOT_UPGRADES.find(u => u.slot === gameState.apprenticeSlots + 1);
            if (nextUpgrade) {
                // 玩家看到的职业等级是 career.level 索引 + 1
                const playerCareerLevel = gameState.career.path !== null ? gameState.career.level + 1 : 0;
                const canUpgrade = playerCareerLevel >= nextUpgrade.req.level;
                html += `
                    <div class="section-header"><i class="fas fa-unlock-alt"></i> 扩充师门</div>
                    <button class="apprentice-option" ${!canUpgrade ? 'disabled' : ''} onclick="upgradeApprenticeSlot()">
                        <i class="fas fa-unlock-alt"></i> 
                        <span class="option-text">升级徒弟槽位</span>
                    </button>
                    <p class="comment" style="text-align:center;">${nextUpgrade.desc}</p>
                `;
            } else {
                html += `<p class="comment" style="text-align:center;">徒弟名额已达上限。</p>`;
            }
        }
        // ▲▲▲ 修改结束 ▲▲▲
    }
    
    content.innerHTML = html;
    showOverlay('apprenticeSystemOverlay');
}

// 【已修复】渲染徒弟卡片 (补上状态和出师按钮)
// [替换]
function renderApprenticeCard(apprentice) {
    const canGraduate = checkApprenticeGraduation(apprentice);
    
    let graduationConditionsHTML = '';
    if (apprentice.state !== 'graduated') {
        const masterProfession = gameState.career.path || 'default';
        const requirements = APPRENTICE_GRADUATION_REQUIREMENTS[masterProfession] || APPRENTICE_GRADUATION_REQUIREMENTS['default'];
        
        graduationConditionsHTML = `<div style="font-size: 0.8em; margin-top: 8px; color: var(--text-comment);"><strong>出师目标: ${requirements.desc}</strong><ul>`;
        
        for (const attr in requirements) {
            if (attr === 'desc') continue;
            const currentVal = Math.floor(apprentice.attributes[attr] || 0);
            const targetVal = requirements[attr];
            const met = currentVal >= targetVal;
            graduationConditionsHTML += `<li style="color: ${met ? 'green' : 'inherit'};">${ATTR_MAP[attr] || attr}: ${currentVal} / ${targetVal}</li>`;
        }
        graduationConditionsHTML += `</ul></div>`;
    }
  return `
        <div class="apprentice-card">
            <div class="avatar-wrapper" style="width: 80px; height: 80px; flex-shrink:0;">
                <img src="${apprentice.avatar}" class="avatar-image" style="display:block;">
            </div>
            <div class="apprentice-details">
                <div class="apprentice-name">
                    <i class="fas fa-${apprentice.gender === 'male' ? 'male' : 'female'}"></i> 
                    ${apprentice.name} (${Math.floor(apprentice.age)}岁)
                    <span style="font-size:0.8em; color:#666; margin-left:10px;">${apprentice.type}</span>
                </div>
                <p><strong>状态:</strong> ${apprentice.state === 'learning' ? '修习中' : '已出师'}</p>
                <p><strong>好感度:</strong> ${apprentice.favor}</p>
                <div class="attributes-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top:10px; gap: 5px 15px;">
                    ${Object.keys(ATTR_MAP).map(attr => {
                        const iconMap = {talent:'fa-pencil-alt', etiquette:'fa-hands-helping', wisdom:'fa-lightbulb', virtue:'fa-leaf', charm:'fa-grin-stars', martial:'fa-khanda', health:'fa-heart', reputation:'fa-star'};
                        const classMap = {talent:'talent-fill', etiquette:'etiquette-fill', wisdom:'wisdom-fill', virtue:'virtue-fill', charm:'charm-fill', martial:'martial-fill', health:'health-fill', reputation:'virtue-fill'};
                        if(apprentice.attributes[attr] === undefined) return '';
                        return renderAttributeBar(ATTR_MAP[attr], apprentice.attributes[attr], classMap[attr], iconMap[attr], 100);
                    }).join('')}
                </div>
                ${graduationConditionsHTML}
            </div>
            <div class="apprentice-btn-group">
                ${apprentice.state !== 'graduated' ? `<button class="apprentice-interact-btn" onclick="interactWithApprentice('${apprentice.id}')">互动</button>` : ''}
                ${canGraduate ? `<button class="apprentice-interact-btn" style="background:linear-gradient(135deg, #a7c957, #6a9ac9);" onclick="graduateApprentice('${apprentice.id}')">出师</button>` : ''}
            </div>
        </div>
    `;
}
function takeNewApprentice() {
    if (!canTakeApprentice()) {
        showToast("收徒条件未满足或名额已满");
        return;
    }
    
    // 生成三位候选人供玩家选择
    const candidates = [
        generateRandomApprentice(),
        generateRandomApprentice(),
        generateRandomApprentice()
    ];

    let optionsHTML = candidates.map(candidate => {
        const candidateInfoString = JSON.stringify(candidate).replace(/'/g, "\\'");
        return {
            htmlContent: `
                <div class="suitor" style="cursor:pointer; margin-bottom:0;">
                    <div class="suitor-avatar-wrapper" style="width:50px; height:50px;">
                         <img src="${candidate.avatar}" class="suitor-avatar">
                    </div>
                    <div class="suitor-details" style="text-align:left;">
                        <div class="suitor-name">${candidate.name}</div>
                        <div class="suitor-desc">${candidate.type}</div>
                    </div>
                </div>`,
            style: `padding:10px; height:auto;`,
            callback: () => {
                const chosen = JSON.parse(candidateInfoString);
                gameState.apprentices.push(chosen);
                showEventCard('喜收门徒', 'fa-graduation-cap', `你收下了 <strong class="value">${chosen.name}</strong> 为徒，从此有了传承之人。`);
                closeAllOverlays();
                showApprenticeSystem();
            }
        };
    });

    showDecisionCard(
        "择徒授业",
        "fa-users",
        "<p>你放出消息要收徒，前来拜师的少年络绎不绝。经过筛选，你留下了三位候选人：</p>",
        optionsHTML
    );
}
// 【已修复】与徒弟互动 (恢复检查金钱的逻辑)
function interactWithApprentice(apprenticeId) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;
    
    let html = `
        <div class="overlay-content">
            <h4>与徒弟 <strong class="value">${apprentice.name}</strong> 的互动</h4>
            <p>选择互动方式 (本回合剩余培养次数: ${2 - (gameState.flags.actionUsed_apprentice || 0)})</p>
            <div id="apprentice-interactions-container">
    `;
    
    apprenticeData.interactions.forEach(interaction => {
        let canInteract = true;
        let costText = '';
        
        if (interaction.cost.action && (gameState.flags.actionUsed_apprentice || 0) >= 2) {
            canInteract = false;
        }
        
        if (interaction.cost.wealth && gameState.finances.wealth < interaction.cost.wealth) {
            canInteract = false;
            costText += `银两不足(${interaction.cost.wealth}) `;
        }
        
        // 修改 "指派工作" 的 onclick 事件
        const clickAction = interaction.id === 'assign_work' 
            ? `showAssignWorkOptions('${apprentice.id}')` 
            : `performApprenticeInteraction('${apprentice.id}', '${interaction.id}')`;

        html += `
            <button class="apprentice-option" ${!canInteract ? 'disabled' : ''} onclick="${clickAction}">
                <i class="fas fa-${interaction.id === 'teach' ? 'book' : interaction.id === 'practice' ? 'running' : interaction.id === 'socialize' ? 'hands-helping' : 'tasks'}"></i>
                <span class="option-text"><strong>${interaction.name}</strong> - ${interaction.desc}</span>
                ${costText ? `<br><small style="color:red;">${costText}</small>` : ''}
            </button>
        `;
    });
    
    html += `</div></div>`;
    
    document.getElementById('apprenticeSystemContent').innerHTML = html;
    showOverlay('apprenticeSystemOverlay');
}
// [用这个新版本替换] performApprenticeInteraction 函数
function performApprenticeInteraction(apprenticeId, interactionId) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    const interaction = apprenticeData.interactions.find(i => i.id === interactionId);

    if (!apprentice || !interaction) return;

    if (interaction.cost.action && (gameState.flags.actionUsed_apprentice || 0) >= 2) {
        showToast("本回合培养徒弟次数已用尽");
        return;
    }

    if (interaction.cost.wealth && gameState.finances.wealth < interaction.cost.wealth) {
        showToast("银两不足");
        return;
    }

    if (interaction.cost.action) {
        gameState.flags.actionUsed_apprentice = (gameState.flags.actionUsed_apprentice || 0) + 1; 
    }

    if (interaction.cost.wealth) {
        applyEffects({ wealth: -interaction.cost.wealth });
    }

    let apprenticeEffectsLog = [];
    let masterEffectsLog = [];

    if (interaction.effect.apprentice) {
        if (interaction.effect.apprentice.attributes) {
            for (const [attr, value] of Object.entries(interaction.effect.apprentice.attributes)) {
                apprentice.attributes[attr] = (apprentice.attributes[attr] || 0) + value; // [修复] 移除了200的上限
                apprenticeEffectsLog.push(`${ATTR_MAP[attr]} +${value}`);
            }
        }
        if (interaction.effect.apprentice.favor) {
            apprentice.favor = Math.min(100, apprentice.favor + interaction.effect.apprentice.favor);
            apprenticeEffectsLog.push(`好感 +${interaction.effect.apprentice.favor}`);
        }
    }

    if (interaction.effect.master) {
        if (interaction.effect.master.attributes) {
            applyEffects({ attributes: interaction.effect.master.attributes });
            for (const [attr, value] of Object.entries(interaction.effect.master.attributes)) {
                masterEffectsLog.push(`${ATTR_MAP[attr]} +${value}`);
            }
        }
    }

    let resultText = `你对徒弟 <strong class="value">${apprentice.name}</strong> 进行了 <strong>${interaction.name}</strong>。<br>`;
    if(apprenticeEffectsLog.length > 0) resultText += `<p><strong>${apprentice.name}:</strong> ${apprenticeEffectsLog.join('，')}。</p>`;
    if(masterEffectsLog.length > 0) resultText += `<p><strong>你:</strong> ${masterEffectsLog.join('，')}。</p>`;

    // 【修复】回调函数中增加了 renderGame()，确保主界面和徒弟界面都刷新
    showEventCard('师徒互动', 'fa-users', resultText, [
        { text: '好的', callback: () => { renderGame(); showApprenticeSystem(); } }
    ]);
}
function checkForApprenticeEvents() {
    const activeApprentices = gameState.apprentices.filter(a => a.state === 'learning');
    if (activeApprentices.length === 0) return;
    
    // 每回合有25%的几率触发一个徒弟事件
    if (Math.random() < 0.25) {
        const apprentice = getRandomElement(activeApprentices);
        const event = getRandomElement(apprenticeSpecialEvents);
        
        let eventDesc = event.desc.replace('你的徒弟', `你的徒弟 <strong class="value">${apprentice.name}</strong>`);
        
        let options = event.options.map(option => {
            let canSelect = true;
            let costText = "";
            
            if (option.cost) {
                if (option.cost.action && gameState.flags.actionUsed_apprentice >= 2) {
                    canSelect = false;
                    costText += "培养次数已用尽 ";
                }
                if (option.cost.wealth && gameState.finances.wealth < option.cost.wealth) {
                    canSelect = false;
                    costText += `银两不足(${option.cost.wealth}) `;
                }
            }
            
            return {
                htmlContent: `<span class="option-text">${option.text}${costText ? `<br><small style="color:red;">${costText}</small>` : ""}</span>`,
                disabled: !canSelect,
                callback: () => handleApprenticeEvent(apprentice.id, event, option)
            };
        });
        
        // 使用事件队列来显示，防止与其他弹窗冲突
        eventQueue.push(() => {
            showDecisionCard(event.title, 'fa-user-graduate', eventDesc, options);
        });
    }
}// 添加处理徒弟事件的函数
// [替换]
function handleApprenticeEvent(apprenticeId, event, option) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if(!apprentice) return;

    // 支付成本
    if (option.cost) {
        if (option.cost.action) {
            gameState.flags.actionUsed_apprentice++;
        }
        if (option.cost.wealth) {
            // 注意：如果cost是负数，则为增加财富
            applyEffects({ wealth: -option.cost.wealth });
        }
    }
    
    const effects = option.effects || {};
    
    // 应用对徒弟的效果
    if (effects.apprentice) {
        if (effects.apprentice.attributes) {
            Object.entries(effects.apprentice.attributes).forEach(([attr, value]) => {
                apprentice.attributes[attr] = (apprentice.attributes[attr] || 0) + value; // [修复] 移除了200的上限
            });
        }
        if (effects.apprentice.favor) {
            apprentice.favor = Math.max(0, Math.min(100, apprentice.favor + effects.apprentice.favor));
        }
    }
    
    // 应用对师傅的效果
    if (effects.master) {
        if (effects.master.attributes) {
            applyEffects({ attributes: effects.master.attributes });
        }
        if (effects.master.reputation) {
            applyEffects({ reputation: effects.master.reputation });
        }
    }
    
    showEventCard(event.title, 'fa-user-graduate', option.result_text);
    renderGame();
}
function checkApprenticeGraduation(apprentice) {
    if (apprentice.state === 'graduated' || apprentice.age < 18) return false;

    const masterProfession = gameState.career.path || 'default';
    const requirements = APPRENTICE_GRADUATION_REQUIREMENTS[masterProfession] || APPRENTICE_GRADUATION_REQUIREMENTS['default'];
    
    for (const attr in requirements) {
        if (attr === 'desc') continue;
        if ((apprentice.attributes[attr] || 0) < requirements[attr]) {
            return false;
        }
    }
    return true;
}
// [用这个新版本替换] graduateApprentice 函数
function graduateApprentice(apprenticeId) {
    const apprenticeIndex = gameState.apprentices.findIndex(a => a.id === apprenticeId);
    if (apprenticeIndex === -1) return;

    const apprentice = gameState.apprentices[apprenticeIndex];
    if (!checkApprenticeGraduation(apprentice)) return;

    const totalAttributes = Object.values(apprentice.attributes).reduce((sum, val) => sum + val, 0);
    const reward = {
        wealth: 1000 + Math.floor(totalAttributes * 5) + Math.floor(apprentice.favor * 20),
        reputation: 50 + Math.floor(totalAttributes / 20)
    };

    // [新增] 将徒弟转换成NPC
    const newNpc = generateNPC({
        id: apprentice.id, // 使用原ID确保唯一性
        name: apprentice.name,
        gender: apprentice.gender,
        age: apprentice.age,
        avatar: apprentice.avatar,
        attributes: apprentice.attributes,
        favor: apprentice.favor + 20, // 出师后好感更高
        relationship: 'former_apprentice',
        role: '出师弟子'
    });

    // 在社交关系中建立联系
    gameState.social.relationships[newNpc.id] = {
        type: 'former_apprentice', // 自定义一个关系类型
        favor: newNpc.favor,
        trust: 80,
        emotionValue: 150,
        level: 3
    };

    // 从徒弟列表中移除
    gameState.apprentices.splice(apprenticeIndex, 1);

    applyEffects({ wealth: reward.wealth, reputation: reward.reputation });
    addItemToInventory('ming_shi_bian_e', 1);

    const apprenticeTypeData = apprenticeData.types.find(t => t.name === apprentice.type);
    let attributeBonusText = '';
    if (apprenticeTypeData && apprenticeTypeData.assistBonus) {
        applyEffects({ attributes: apprenticeTypeData.assistBonus });
        attributeBonusText = `<p>因材施教，你对${Object.keys(apprenticeTypeData.assistBonus).map(k => ATTR_MAP[k]).join('与')}的理解也更深了。</p>`;
    }

    const eventContent = `
        <p>你的徒弟 <strong class="value">${apprentice.name}</strong> 已学有所成，今日含泪拜别，正式出师！</p>
        <p>TA为你送上<strong class="value">【名师匾额】</strong>与<strong class="value">谢师礼(${reward.wealth}两)</strong>。</p>
        ${attributeBonusText}
        <p>你的声望也因此提升了 <span class="value">${reward.reputation}</span> 点。</p>
        <p class="comment">“师父大恩，弟子永世不忘。” 从此，TA将作为你的弟子在京城行走，你们仍可时时互动。</p>
    `;

    showEventCard('高徒出师', 'fa-user-graduate', eventContent, [
        { text: '挥手作别', callback: () => {
            closeAllOverlays();
            showApprenticeSystem();
        }}
    ]);
    renderGame();
}
function calculateGraduationReward(apprentice) {
  // 根据徒弟属性和类型计算奖励
  const baseReward = 2000;
  const attributeBonus = Object.values(apprentice.attributes).reduce((sum, val) => sum + val, 0) * 10;
  
  return {
    wealth: baseReward + attributeBonus,
    reputation: 50 + Math.floor(attributeBonus / 100)
  };
}
// 【新增】显示指派工作选项的函数
function showAssignWorkOptions(apprenticeId) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;
    if ((gameState.flags.actionUsed_apprentice || 0) >= 2) {
        showToast("本回合培养次数已用尽");
        return;
    }

    const hasProperty = gameState.merchant.investments.length > 0 || gameState.merchant.ownedLand.length > 0;
    
    const options = [
        {
            htmlContent: `<strong>辅助本职</strong><div><small>提升职业核心资源</small></div>`,
            callback: () => handleWorkAssignment(apprenticeId, 'assist')
        },
        {
            htmlContent: `<strong>派往商会</strong><div><small>可能带回金钱或货物</small></div>`,
            callback: () => handleWorkAssignment(apprenticeId, 'guild')
        },
        {
            htmlContent: `<strong>打理私产</strong><div><small>提升产业/农田收益</small></div>`,
            disabled: !hasProperty,
            callback: () => handleWorkAssignment(apprenticeId, 'property')
        }
    ];

    showDecisionCard('指派工作', 'fa-tasks', `你打算让 ${apprentice.name} 去做什么？`, options);
}

// 【新增】处理指派工作结果的函数
function handleWorkAssignment(apprenticeId, workType) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;
    
    gameState.flags.actionUsed_apprentice = (gameState.flags.actionUsed_apprentice || 0) + 1;
    let resultText = '';
    
    switch(workType) {
        case 'assist':
            const profession = PROFESSION_DATA[gameState.career.path];
            if (profession && profession.core_resources.length > 0) {
                const resourceToBoost = getRandomElement(profession.core_resources);
                const boostAmount = getRandomInt(1, 3);
                gameState.career.core_resources[resourceToBoost] += boostAmount;
                resultText = `${apprentice.name} 帮你处理公务，你的 ${resourceToBoost} 提升了 ${boostAmount} 点。`;
            } else {
                resultText = `${apprentice.name} 帮你处理了些杂事，让你轻松不少。`;
            }
            break;
        case 'guild':
            if (Math.random() < 0.2) { // 20% 几率拿回物品
                const good = getRandomElement(Object.values(TRADING_GOODS_DATA));
                // 简化处理，直接给钱
                const profit = Math.floor(good.basePrice[0] * 0.5);
                applyEffects({ wealth: profit });
                resultText = `${apprentice.name} 在商会学到不少，还为你赚回了 <span class="value">${profit}</span> 两。`;
            } else {
                const profit = getRandomInt(20, 50);
                applyEffects({ wealth: profit });
                resultText = `${apprentice.name} 在商会帮工，为你赚回 <span class="value">${profit}</span> 两。`;
            }
            break;
        case 'property':
             // 在这里可以设置一个 flag，在年度结算时给与加成
            gameState.flags.apprenticeManagedProperty = true;
            resultText = `你派 ${apprentice.name} 去巡视田产和店铺，TA干得不错，想必今年的收成会更好。`;
            break;
    }
    
    showEventCard('工作成果', 'fa-briefcase', resultText);
}
function applyPassiveBonuses() {
    // 检查名师匾额
    if (gameState.inventory.some(item => item.id === 'ming_shi_bian_e')) {
        const reputationGain = 5 * gameState.inventory.filter(item => item.id === 'ming_shi_bian_e').length;
        applyEffects({ reputation: reputationGain });
        logEvent(`你的<strong class="value">【名师匾额】</strong>为你带来了 ${reputationGain} 点声望。`, true);
    }
}
// 每回合更新徒弟状态
// 【已修复】更新徒弟状态 (使用正确的成长率)
function updateApprentices() {
    if (!gameState.apprentices || gameState.apprentices.length === 0) return;
    
    gameState.apprentices.forEach(apprentice => {
        if (apprentice.state !== 'graduated') {
            apprentice.age += 0.5;
            
            // 使用正确的成长率
            if (apprentice.growthRates) {
                for (const [attr, rate] of Object.entries(apprentice.growthRates)) {
                    const growth = Math.random() * rate;
                    apprentice.attributes[attr] = Math.min(100, (apprentice.attributes[attr] || 0) + growth);
                }
            }

            if (apprentice.state === 'working' && gameState.career.path) {
                const performanceGain = getRandomInt(3, 8);
                gameState.career.performance += performanceGain;
                logEvent(`徒弟 <strong class="highlight-npc">${apprentice.name}</strong> 协助你工作，功绩+${performanceGain}。`);
            }
        }
    });
}

// 在社交标签页中显示徒弟
function renderApprenticesInSocialTab() {
    if (!gameState.apprentices || gameState.apprentices.length === 0) return '';
    
    let html = `<div class="section-header"><i class="fas fa-user-graduate"></i> 我的徒弟</div>`;
    gameState.apprentices.forEach(apprentice => {
        html += renderApprenticeCard(apprentice);
    });
    
    return html;
}


// 触发师徒试炼
function triggerApprenticeTrial(apprenticeId, attribute) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;
    
    const trial = apprenticeTrials[attribute];
    if (!trial) return;
    
    let options = trial.options.map((option, index) => {
        let canAttempt = true;
        let costText = '';
        
        // 检查选项成本
        if (option.cost.action && gameState.flags.actionUsed_study) {
            canAttempt = false;
            costText += '本回合已进行过修身 ';
        }
        
        if (option.cost.wealth && gameState.finances.wealth < option.cost.wealth) {
            canAttempt = false;
            costText += `银两不足(${option.cost.wealth}) `;
        }
        
        return {
            htmlContent: `<span class="option-text"><strong>${option.text}</strong>
                ${costText ? `<br><small style="color:red;">${costText}</small>` : ''}
            </span>`,
            disabled: !canAttempt,
            callback: () => handleApprenticeTrial(apprentice.id, attribute, index)
        };
    });
    
    showDecisionCard(
        trial.title,
        'fa-graduation-cap',
        trial.desc,
        options
    );
}
// 新增函数：显示美观的改名弹窗
// [新增]
// 新增函数：显示美观的改名弹窗
function showRenameChildOverlay(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // 安全地获取孩子的姓氏和旧名（不含姓）
    const oldGivenName = child.name ? child.name.slice(1) : '未命名';

    // 填充弹窗内容
    document.getElementById('renameChildOldName').textContent = child.name || '这个孩子';
    document.getElementById('renameChildInput').value = oldGivenName === '未命名' ? '' : oldGivenName;

    // 动态设置确认按钮的事件
    const confirmBtn = document.getElementById('confirmRenameBtn');
    confirmBtn.onclick = () => {
        confirmNewName(childId);
    };

    // 显示改名弹窗
    showOverlay('renameChildOverlay');
}

// [新增]
// 新增函数：确认新名字的逻辑
function confirmNewName(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const newNameInput = document.getElementById('renameChildInput');
    let newGivenName = newNameInput.value.trim();

    if (newGivenName.length === 0) {
        const namePool = child.gender === 'female' ? nameData.girlNames : nameData.boyNames;
        newGivenName = getRandomElement(namePool);
        showToast("你未给孩子命名，便随口取了一个。");
    }

    if (newGivenName.length > 3) {
        showToast("请输入1-3个字的新名。");
        return;
    }

    // [修复核心] 确保总能找到正确的姓氏
    let surname = '';
    // 优先使用合法父亲的姓
    const legalFather = child.fatherId ? (gameState.npcs[child.fatherId] || (child.fatherId === 'player' ? gameState.player : null)) : null;
    if (legalFather && legalFather.name) {
        surname = legalFather.name.slice(0, 1);
    } 
    // 其次使用孩子自己已有的姓（如果有的话）
    else if (child.name) {
        surname = child.name.slice(0, 1);
    } 
    // 最后使用玩家的姓作为备用
    else {
        surname = gameState.player.name.slice(0, 1);
    }

    const finalName = surname + newGivenName;

    if (gameState.flags.allNames.has(finalName) && finalName !== child.name) {
        showToast("这个名字已经有人用啦，换一个吧。");
        return;
    }

    if (child.name) {
        gameState.flags.allNames.delete(child.name);
    }

    const oldName = child.name || "这个孩子";
    child.name = finalName;
    gameState.flags.allNames.add(finalName);

    showEventCard('改名成功', 'fa-pen-fancy', `你将 <strong class="value">${oldName}</strong> 的名字改为了 <strong class="value">${finalName}</strong>。`);

    closeAllOverlays();
    renderGame();
}
// 处理师徒试炼结果
function handleApprenticeTrial(apprenticeId, attribute, optionIndex) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    const trial = apprenticeTrials[attribute];
    const option = trial.options[optionIndex];
    
    if (!apprentice || !trial || !option) return;
    
    // 支付成本
    if (option.cost.action) {
        gameState.flags.actionUsed_study = true;
    }
    
    if (option.cost.wealth) {
        applyEffects({ wealth: -option.cost.wealth });
    }
    
    // 判断成功与否
    const success = Math.random() <= option.successRate;
    let resultText = '';
    
    if (success) {
        // 应用成功效果
        if (option.effect.apprentice) {
            if (option.effect.apprentice.attributes) {
                for (const [attr, value] of Object.entries(option.effect.apprentice.attributes)) {
                    apprentice.attributes[attr] = Math.min(100, (apprentice.attributes[attr] || 0) + value);
                }
            }
        }
        
        if (option.effect.master) {
            if (option.effect.master.attributes) {
                applyEffects({ attributes: option.effect.master.attributes });
            }
        }
        
        if (option.effect.favor) {
            apprentice.favor = Math.min(100, apprentice.favor + option.effect.favor);
        }
        
        if (option.effect.reward) {
            if (option.effect.reward.wealth) {
                applyEffects({ wealth: option.effect.reward.wealth });
            }
            
            if (option.effect.reward.reputation) {
                applyEffects({ reputation: option.effect.reward.reputation });
            }
        }
        
        resultText = `试炼成功！`;
    } else {
        // 应用失败效果
        if (option.failureEffect) {
            if (option.failureEffect.apprentice) {
                if (option.failureEffect.apprentice.attributes) {
                    for (const [attr, value] of Object.entries(option.failureEffect.apprentice.attributes)) {
                        apprentice.attributes[attr] = Math.max(0, (apprentice.attributes[attr] || 0) + value);
                    }
                }
                
                if (option.failureEffect.apprentice.growthRate) {
                    for (const [attr, value] of Object.entries(option.failureEffect.apprentice.growthRate)) {
                        apprentice.growthRates[attr] = Math.max(0, (apprentice.growthRates[attr] || 0) + value);
                    }
                }
            }
            
            if (option.failureEffect.favor) {
                apprentice.favor = Math.max(0, apprentice.favor + option.failureEffect.favor);
            }
        }
        
        resultText = `试炼失败！`;
    }
    
    showEventCard('师徒试炼', 'fa-graduation-cap', `
        <p>${resultText}</p>
        <p>徒弟 <strong class="value">${apprentice.name}</strong> 的${ATTR_MAP[attribute]} ${success ? '提升' : '下降'}了。</p>
    `);
}

// 检查并触发徒弟社交事件
// 修改后的 checkForApprenticeSocialEvents 函数
// 【修改为以下代码】
// 找到 checkForApprenticeSocialEvents 函数
// 找到 checkForApprenticeSocialEvents 函数 (大约 6980行)
// 将其替换为以下代码：

function checkForApprenticeSocialEvents() {
    // 1. 先筛选出所有正在学习的徒弟
    const activeApprentices = gameState.apprentices.filter(a => a.state === 'learning');
    
    // 2. 如果没有正在学习的徒弟，就直接返回
    if (activeApprentices.length === 0) return;
    
    // 3. 在有正在学习的徒弟的前提下，再进行随机判断
    if (Math.random() < 0.2) { // 20%的几率触发事件
        // 4. 从 activeApprentices 池中随机选择一个
        const randomApprentice = getRandomElement(activeApprentices);
        const event = getRandomElement(apprenticeSpecialEvents);
        
        let eventDesc = event.desc.replace('你的徒弟', `你的徒弟 <strong class="value">${randomApprentice.name}</strong>`);
        
        // ... 后续的生成选项和显示 showDecisionCard 的代码不变 ...
        // 确保你已经有 handleApprenticeSocialEvent 这个函数来处理后续逻辑
        
        let optionsHTML = event.options.map(option => {
            // ... (你原来的选项生成逻辑) ...
            return {
                htmlContent: `<span class="option-text">${option.text}</span>`,
                callback: () => handleApprenticeSocialEvent(randomApprentice.id, event, option)
            };
        });

        // 队列化事件，防止弹窗冲突
        eventQueue.push(() => {
            showDecisionCard(event.title, 'fa-users', eventDesc, optionsHTML);
        });
    }
}
function triggerApprenticeSocialEvent(apprenticeId, event) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;
    
    let options = event.options.map((option, index) => {
        return {
            htmlContent: `<span class="option-text">${option.text}</span>`,
            callback: () => handleApprenticeSocialEvent(apprentice.id, event, option)
        };
    });
    
    showDecisionCard(
        event.title,
        'fa-users',
        event.desc,
        options
    );
}

// 处理徒弟社交事件
function handleApprenticeSocialEvent(apprenticeId, event, option) {
    const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
    if (!apprentice) return;

    if (option.effect.favor) {
        apprentice.favor = Math.min(100, Math.max(0, apprentice.favor + option.effect.favor));
    }
    
    if (option.effect.attributes) {
        for (const [attr, value] of Object.entries(option.effect.attributes)) {
            apprentice.attributes[attr] = Math.min(200, Math.max(0, (apprentice.attributes[attr] || 0) + value));
        }
    }
    
    if (option.effect.wealth) {
        applyEffects({ wealth: option.effect.wealth });
    }
    
    showEventCard('徒弟事件', 'fa-users', `
        <p>${option.result}</p>
        <p>徒弟 <strong class="value">${apprentice.name}</strong> 的好感度${option.effect.favor >= 0 ? '增加' : '减少'}了。</p>
    `);
}
// =======================================================================
// ===================== [新增] 暗中调查事件库 ===========================
// =======================================================================
const INVESTIGATION_EVENTS = [
    // --- 6个正面事件 ---
    {
        type: 'positive',
        title: '仁心善举',
        desc: '你的眼线回报，曾见【对象姓名】在济世堂前为流民施粥，城中百姓无不称赞其仁善之心。',
        effect_text: '你对TA的品德颇为欣赏。'
    },
    {
        type: 'positive',
        title: '才情出众',
        desc: '探子来报，【对象姓名】近日在兰亭雅集上拔得头筹，一首七言绝句引得满堂喝彩，被誉为“京城第一才子/才女”。',
        effect_text: '如此才华，与你的孩儿正是绝配。'
    },
    {
        type: 'positive',
        title: '家风清正',
        desc: '经过多方打探，你了解到【对象姓名】家中长辈皆是品行端正之人，家风清廉，在朝中口碑甚好。',
        effect_text: '与这样的家族结亲，对你家大有裨益。'
    },
    {
        type: 'positive',
        title: '仗义疏财',
        desc: '你的人发现，【对象姓名】曾为一位落难的同乡倾囊相助，助其渡过难关，为人十分仗义。',
        effect_text: '你认为此人重情重义，值得托付。'
    },
    {
        type: 'positive',
        title: '隐藏产业',
        desc: '调查发现，【对象姓名】表面上只是普通官宦子弟，实则在江南还经营着数家绸缎庄，财力远超外人所想。',
        effect_text: '这门亲事，真是锦上添花。'
    },
    {
        type: 'positive',
        title: '武艺高强',
        desc: '你的护院在与城中武师切磋时，听闻【对象姓名】曾一人一剑挑了黑风寨，是位深藏不露的武林高手。',
        effect_text: '文武双全，实乃良配。'
    },
    // --- 9个负面/抓马事件 ---
    {
        type: 'negative',
        title: '已有心上人',
        desc: '你的眼线发现，【对象姓名】似乎与另一位门当户对的异性往来甚密，两人青梅竹马，情投意合。',
        options: [
            { text: '【告知孩儿，放弃此人】', log: '你的孩子虽然失落，但也感谢你避免了一段无果的感情。' },
            { text: '【强行提亲，横刀夺爱】', log: '你决定利用家族权势强行促成这门婚事，但这真的会幸福吗？' }
        ]
    },
    {
        type: 'negative',
        title: '未婚先孕/已有私生子',
        desc: '一个惊天秘密被你发现：【对象姓名】在乡下竟有一个尚未公开的私生子/女！',
        options: [
            { text: '【以此为把柄，压低聘礼/嫁妆】', log: '对方家族为遮掩丑闻，同意了你的无理要求。' },
            { text: '【断然拒婚】', log: '你无法接受此事，立即中断了议亲。' }
        ]
    },
    {
        type: 'negative',
        title: '性格暴躁',
        desc: '你买通了对方府上的一个下人，得知【对象姓名】私下里性格暴躁，稍有不顺便会对下人拳打脚踢。',
        effect_text: '此人表里不一，绝非良配！'
    },
    {
        type: 'negative',
        title: '身有隐疾',
        desc: '你花重金从太医院的故人处得知，【对象姓名】身患遗传隐疾，恐有碍子嗣。',
        options: [
            { text: '【为了联姻，隐瞒此事】', log: '你选择了家族利益，但此事未来可能会成为巨大的隐患。' },
            { text: '【告知孩儿，由其定夺】', log: '你将决定权交给了孩子，无论结果如何，你们的亲情都更深了。' }
        ]
    },
    {
        type: 'negative',
        title: '家有巨额债务',
        desc: '调查发现，【对象姓名】的家族表面风光，实则早已被掏空，在外欠下巨额债务，正指望靠联姻来填补窟窿。',
        effect_text: '你识破了对方的图谋，庆幸没有掉入陷阱。'
    },
    {
        type: 'negative',
        title: '风流成性',
        desc: '你的眼线回报，【对象姓名】是风月鉴的常客，与多位红尘女子关系匪浅，名声不佳。',
        effect_text: '此等浪荡之人，怎能托付终身！'
    },
    {
        type: 'negative',
        title: '断袖之癖/磨镜之好',
        desc: '一个绝对的秘密被你发现：【对象姓名】对异性毫无兴趣，其真实喜好与世俗相悖。',
        effect_text: '你震惊不已，为了孩子的幸福，这门亲事绝不能成。'
    },
    {
        type: 'negative',
        title: '实为庶出',
        desc: '你发现【对象姓名】对外宣称是嫡出，实则是被扶正的庶子/庶女，其地位并不稳固。',
        effect_text: '这门亲事的价值，需要重新评估了。'
    },
    {
        type: 'negative',
        title: '与长辈不睦',
        desc: '你了解到，【对象姓名】与家中长辈关系极为紧张，被认为“不孝”，在族中饱受排挤。',
        effect_text: '一个连自己长辈都无法和睦相处的人，想必也难以维系好你们的姻亲关系。'
    }
];
// ===================== 【新增】行动点计数器函数 END =====================
// =======================================================================
// ========================= UTILITY FUNCTIONS ===========================
// =======================================================================
// ===================== 【新功能代码】子女培养与婚嫁数据 START ======================

const CHILD_CULTIVATION_STAGES = {
    // 0-5岁 启蒙期
    infancy: {
        male: [
            { id: 'play_infant', name: '陪伴玩耍', desc: '+魅力, +亲子关系', effects: { charm: 0.5, favor: 2 } },
            { id: 'care_infant', name: '悉心照料', desc: '+健康, +亲子关系', effects: { health: 1, favor: 2 } },
        ],
        female: [
            { id: 'play_infant', name: '陪伴玩耍', desc: '+魅力, +亲子关系', effects: { charm: 0.5, favor: 2 } },
            { id: 'sing_infant', name: '轻声哼唱', desc: '+才情, +亲子关系', effects: { talent: 0.5, favor: 2 } },
        ]
    },
    // 6-15岁 成学期
    childhood: {
        male: [
            { id: 'focus_wisdom', name: '主修经史', desc: '智慧与品德大幅成长', focus: { wisdom: 2.0, virtue: 1.5, martial: 0.5 } },
            { id: 'focus_martial', name: '主修武艺', desc: '武学与健康大幅成长', focus: { martial: 2.0, health: 1.5, talent: 0.5 } },
            { id: 'focus_business', name: '主修商道', desc: '智慧与魅力大幅成长', focus: { wisdom: 1.8, charm: 1.5, virtue: 0.5 } },
        ],
        female: [
            { id: 'focus_art', name: '主修才艺', desc: '才情与魅力大幅成长', focus: { talent: 2.0, charm: 1.5, wisdom: 0.5 } },
            { id: 'focus_etiquette', name: '主修礼法', desc: '礼仪与品德大幅成长', focus: { etiquette: 2.0, virtue: 1.5, charm: 0.5 } },
            { id: 'focus_management', name: '主修内务', desc: '智慧与品德大幅成长', focus: { wisdom: 1.8, virtue: 1.5, talent: 0.5 } },
        ]
    },
    // 16-18岁 及笄/冠礼期
    teenager: {
        common: [
            { id: 'socialize', name: '参加宴会', desc: '花费100两，提升声望', cost: 100, effects: { reputation: 5, charm: 1 } },
            { id: 'discuss_future', name: '探讨未来', desc: '提升智慧与亲子关系', effects: { wisdom: 2, favor: 5 } },
        ]
    }
};

// [替换]
const childSpousePools = {
    male: [ // 女孩的结婚对象
        { desc: "家道中落的书生，才华横溢但穷困潦倒。", family: 20, attributes: { talent: 75, wisdom: 70, charm: 60, martial: 20, virtue: 50, health: 60, etiquette: 55 }, hidden_trait: { positive: "潜力股", negative: "性格固执" } },
        { desc: "县令之子，为人稳重，前途光明。", family: 60, attributes: { talent: 60, wisdom: 65, virtue: 70, martial: 40, charm: 55, health: 70, etiquette: 65 }, hidden_trait: { positive: "有责任心", negative: "略显无趣" } },
        { desc: "富商的庶子，精于算计，善于交际。", family: 70, attributes: { talent: 50, wisdom: 80, charm: 75, martial: 30, virtue: 40, health: 65, etiquette: 60 }, hidden_trait: { positive: "慷慨大方", negative: "风流成性" } },
        { desc: "边关校尉，勇武过人但性格粗犷。", family: 55, attributes: { martial: 80, health: 85, virtue: 60, talent: 30, wisdom: 50, charm: 45, etiquette: 40 }, hidden_trait: { positive: "为人正直", negative: "不解风情" } },
        { desc: "安国公府的远房亲戚，家世显赫但游手好闲。", family: 85, attributes: { charm: 80, etiquette: 70, martial: 50, talent: 45, wisdom: 55, virtue: 50, health: 75 }, hidden_trait: { positive: "出手阔绰", negative: "家有巨额债务" } }
    ],
    female: [ // 男孩的结婚对象
        { desc: "小家碧玉，温柔贤淑，擅长女红。", family: 30, attributes: { talent: 65, virtue: 75, charm: 65, martial: 25, wisdom: 55, health: 70, etiquette: 60 }, hidden_trait: { positive: "勤俭持家", negative: "眼界狭窄" } },
        { desc: "官宦嫡女，知书达理，颇有主见。", family: 75, attributes: { talent: 70, wisdom: 70, etiquette: 80, martial: 40, charm: 75, virtue: 65, health: 65 }, hidden_trait: { positive: "聪慧敏锐", negative: "性格强势" } },
        { desc: "江南绣商之女，活泼可爱，嫁妆丰厚。", family: 65, attributes: { charm: 80, wisdom: 60, talent: 70, martial: 35, virtue: 60, health: 70, etiquette: 65 }, hidden_trait: { positive: "善于理财", negative: "花钱如流水" } },
        { desc: "名门之后，才情与容貌闻名京城。", family: 80, attributes: { talent: 85, charm: 85, etiquette: 75, martial: 45, wisdom: 70, virtue: 70, health: 65 }, hidden_trait: { positive: "交际广泛", negative: "身有隐疾" } },
        { desc: "武林世家的小姐，性格直爽，不拘小节。", family: 50, attributes: { martial: 70, virtue: 65, health: 80, talent: 40, wisdom: 50, charm: 60, etiquette: 50 }, hidden_trait: { positive: "坚韧不拔", negative: "性格暴躁" } }
    ]
};
// =======================================================================
// ===================== 【新增】情人与金兰系统核心数据 =====================
// =======================================================================

const POETRY_QUIZ_DATA = [
    { question: "身无彩凤双飞翼", answer: "心有灵犀一点通", options: ["天涯何处觅知音", "此事古难全"] },
    { question: "天涯何处无芳草", answer: "何必单恋一枝花", options: ["春风又绿江南岸", "只是当时已惘然"] },
    { question: "两情若是久长时", answer: "又岂在朝朝暮暮", options: ["便胜却人间无数", "此恨绵绵无绝期"] },
    { question: "曾经沧海难为水", answer: "除却巫山不是云", options: ["但愿人长久", "此时此夜难为情"] },
    { question: "在天愿作比翼鸟", answer: "在地愿为连理枝", options: ["此情可待成追忆", "为伊消得人憔悴"] }
];

// 扩充后的情人事件库 (节选了文档中的代表性事件)
const LOVER_EVENTS_EXPANDED = {
    // 约会地点事件
    'moon_drink': { title: '月下对酌', desc: '你们在湖心亭赏月小酌，对方借着酒意，向你吐露了一段不为人知的往事。', options: [
        { text: '安慰并分享你的秘密', effects: { favor: 15, devotion: 10 }, log: '你们交换了彼此最深的秘密，心与心贴得更近了。' },
        { text: '默默倾听', effects: { favor: 8 }, log: '你的倾听给了对方莫大的安慰。' }
    ]},
    'boat_serenade': { title: '画舫惊鸿', desc: '一艘画舫经过，上面的歌妓唱起一首哀婉的曲子，触动了对方的心事。', options: [
        { text: '为其赋诗一首', req: { talent: 80 }, effects: { favor: 20 }, log: '你的诗才令对方深深折服。' },
        { text: '邀其共舞一曲', req: { charm: 70 }, effects: { favor: 20 }, log: '你们在月光下共舞，身姿翩跹，情意绵绵。' }
    ]},
    'buy_for_lover': { title: '市集赠礼', desc: '对方看上了一件昂贵的首饰/兵器，但囊中羞涩。', options: [
        { text: '豪掷千金，买下相赠', req: { wealth: 1000 }, effects: { wealth: -1000, favor: 25, devotion: 15 }, log: '你的慷慨让对方感动不已。' },
        { text: '囊中羞涩，婉言拒绝', effects: { favor: -10 }, log: '你的拒绝让对方有些失落。' }
    ]},
    // 随机触发事件
    'late_visit': { title: '深夜探访', condition: (gs, npc) => npc.favor > 60, desc: '夜深人静，你的情人突然到访，只为能见你一面。', effects: { favor: 5 } },
    'rival_appears': { title: '情敌出现', condition: (gs, npc) => npc.favor > 70, desc: '一位新的、条件优秀的NPC开始追求你的情人。', options: [
        { text: '私下警告情敌', effects: { favor: 5, devotion: -5 }, log: '你的占有欲让情人有些不安，但也没说什么。' },
        { text: '加倍对TA好', effects: { favor: 10, devotion: 10 }, log: '你的行动让情人感受到了你的真心。' },
        { text: '相信情人，顺其自然', effects: { favor: -5, devotion: 15 }, log: '你的信任让情人很感动，但内心也有一丝不确定。' }
    ]},
    'family_disapproval': { title: '家庭的阻力', condition: (gs, npc) => npc.favor > 80, desc: '对方的家人发现了你们的关系，表示强烈反对。', options: [
        { text: '亲自拜访，努力说服', req: { charm: 80 }, effects: { favor: 10 }, log: '你的诚意和谈吐暂时稳住了对方的家人。' },
        { text: '劝说情人不要与家人闹翻', effects: { devotion: 10 }, log: '你的体谅让情人更加依赖你。' }
    ]},
    'sickness_care': { title: '生病照料', desc: '你的情人生病了，你前去悉心照料。', effects: { favor: 15, devotion: 20 } },
    // 特殊身份事件
    'affair_exposed': { title: '东窗事发', condition: (gs, npc) => gs.marriage.isMarried, desc: '你与情人的关系被你的正妻/正夫发现！一场风暴即将来临。', options: [
        { text: '花费巨额金钱平息', req: { wealth: 10000 }, effects: { favor: -30, wealth: -10000 }, log: '你用钱暂时平息了事端，但夫妻关系已降至冰点。' },
        { text: '和离', callback: (npcId) => { confirmDivorce(); } }
    ]},
    'secret_child_decision': { title: '私生子的抉择', condition: (gs, npc) => gs.player.gender === 'female' && gs.player.isPregnant && gs.player.isSecretPregnancy, desc: '你怀上了情人的孩子，这是一个足以颠覆一切的秘密。', options: [
        { text: '秘密生下，送往远方', effects: { virtue: -20 }, log: '你悄悄生下孩子，送往乡下抚养，从此母子分离。' },
        { text: '狠心打掉', effects: { health: -20, virtue: -15 }, log: '你喝下了堕胎药，腹中剧痛，孩子没了，你的身体和品德都受到了极大损害。' }
    ]}
};

const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
const formatNumber = (num, isFloat=false) => {
    num = Number(num);
    if(isNaN(num)) return "0";
    if (num >= 10000 && !isFloat) return (num / 10000).toFixed(1) + '万';
    return isFloat ? num.toFixed(2) : Math.floor(num).toString();
};

function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
};

function generateRandomName(gender, existingNames) {
    let name;
    let attempts = 0;
    const namePool = gender === 'female' ? nameData.girlNames : nameData.boyNames;
    do {
        const surname = getRandomElement(nameData.surnames);
        const givenName = getRandomElement(namePool);
        name = surname + givenName;
        attempts++;
    } while (existingNames.has(name) && attempts < 50);
    if(attempts >= 50) name = name + '·' + getRandomElement(['甲', '乙', '丙', '丁', '戊', '己']); // fallback for large npc counts
    existingNames.add(name);
    return name;
};

const NPC_BACKGROUND_DESCRIPTIONS = [
 "据说是位家道中落的贵族后裔，眉宇间总带着一抹挥之不去的忧郁。",
    "常年在江湖行走的侠客，眼神锐利，腰间总是配着一把不起眼的短剑。",
    "京城有名的才子/才女，诗画双绝，引得无数名门子弟/闺秀倾心。",
    "看似天真烂漫的年轻人，但偶尔流露出的眼神却深邃得不像其年纪。",
    "一位沉默寡言的武人，据说曾在边关立下赫赫战功。",
    "出身江南水乡的富商，谈吐风雅，精于算计，是商场上的厉害角色。",
    "总是在酒楼独自买醉的失意文人，似乎怀才不遇，满腹牢骚。",
    "医术高超但性格古怪的医师，只救看得顺眼的人。",
    "来自异域的神秘舞者，一舞动京城，无人知其来历。",
    "表面上是国子监的普通学子，暗地里似乎与朝中某股势力有联系。",
"一位退隐山林的智者，偶尔会出现在市集上，没人知道其曾是威震一方的大侠。"
];
function generateNPC(options = {}) {
    const gender = options.gender || (Math.random() > 0.5 ? 'male' : 'female');
    const id = options.id || `npc_${Date.now()}_${getRandomInt(1000, 9999)}`;
    
    if (gameState.npcs[id]) {
        return gameState.npcs[id];
    }
    
    let name = options.name;
    if (!name) {
        name = generateRandomName(gender, gameState.flags.allNames);
    } else {
        if (gameState.flags.allNames.has(name)) {
            let uniqueName = name;
            let i = 2;
            do {
                uniqueName = `${name}·${i}`;
                i++;
            } while (gameState.flags.allNames.has(uniqueName));
            name = uniqueName;
        }
        gameState.flags.allNames.add(name);
    }
    
    const allPersonalities = [...personalityTraits.positive, ...personalityTraits.negative];
    
    const rarityRoll = Math.random();
    let rarity = 'common';
    if (rarityRoll > 0.9) rarity = 'legendary';
    else if (rarityRoll > 0.6) rarity = 'rare';
    
    const npc = {
        id: id,
        name: name,
        title: options.title || (gender === 'male' ? '公子' : '姑娘'),
        rarity: options.rarity || rarity,
        gender: gender,
        age: options.age || getRandomInt(16, 40),
        personality: options.personality ? [options.personality] : [getRandomElement(allPersonalities)],
        background: { desc: getRandomElement(NPC_BACKGROUND_DESCRIPTIONS) }, 
        favor: options.favor || 0,
        relationship: options.relationship || 'stranger',
        isDead: false,
        lastInteractedTurn: gameState.date.turn,
        avatar: options.avatar || getRandomElement(avatarPools[gender]),
        ...options,
        attributes: {
            talent: getRandomInt(20, 60),
            charm: getRandomInt(20, 60),
            wisdom: getRandomInt(20, 60),
            virtue: getRandomInt(20, 60),
            martial: getRandomInt(20,60),
            ...options.attributes
        }
    };
    
    // 【修复】为所有新生成的NPC添加喜好设定
    const allGoods = Object.keys(TRADING_GOODS_DATA);
    const shuffledGoods = allGoods.sort(() => 0.5 - Math.random());
    npc.preferences = {
        likes: shuffledGoods.slice(0, getRandomInt(1, 2)),
        dislikes: shuffledGoods.slice(2, 3),
        known: false
    };

    gameState.npcs[npc.id] = npc;
    return npc;
}
// =======================================================================
// ================= GAME INITIALIZATION & STATE MANAGEMENT ===============
// =======================================================================

function initGame() {
    const autoSave = localStorage.getItem(SAVE_SLOT_KEY_PREFIX + 'auto');
    if (autoSave) {
        if (confirm("检测到有自动存档，是否继续上一次的游戏？")) {
            loadGame('auto', true);
            document.getElementById('loadingOverlay').style.display = 'none';
            return;
        }
    }
    document.getElementById('loadingOverlay').style.display = 'none';
    showOverlay('genderSelectionOverlay');
}

function startNewGame(gender, inheritanceData = null, options = {}) {
    if (isProcessing) return;
    isProcessing = true;
    closeAllOverlays();
    document.getElementById('loadingOverlay').style.display = 'flex';

    setTimeout(() => {
        setupNewGame(gender, inheritanceData, options); // <--- 确保参数都传递
        document.getElementById('loadingOverlay').style.display = 'none';
        isProcessing = false;
    }, 500);
}
// 修改 setupNewGame 函数，增加 options 参数
// [替换]
function showGiftGivingOverlay(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return;

    const warehouseItems = gameState.tradingSystem.warehouse;
    // 【核心修改】同时读取藏宝阁（主物品栏）
    const inventoryItems = gameState.inventory || []; 

    // 【核心修改】判断两个地方都没有物品时才提示
    if (warehouseItems.length === 0 && inventoryItems.length === 0) {
        showToast("你的仓库和藏宝阁里都没有可以赠送的物品。");
        return;
    }

    let itemsHTML = '';

    // 【保留功能】显示商会仓库物品
    if (warehouseItems.length > 0) {
        itemsHTML += `<div class="section-header"><i class="fas fa-warehouse"></i> 商会仓库</div>`;
        itemsHTML += warehouseItems.map(item => {
            const itemDef = TRADING_GOODS_DATA[item.id];
            if (!itemDef) return '';
            return `
                <div class="marketplace-item">
                    <span>
                        <strong>${itemDef.name}</strong><br>
                        <small>购入价: ${item.buyPrice} 两</small>
                    </span>
                    <button class="control-btn" onclick="giveGift('${npcId}', '${item.id}', '${item.instanceId}', 'warehouse')">赠送</button>
                </div>
            `;
        }).join('');
    }

    // 【新增功能】显示藏宝阁物品
    if (inventoryItems.length > 0) {
        itemsHTML += `<div class="section-header" style="margin-top:15px;"><i class="fas fa-gem"></i> 藏宝阁</div>`;
        itemsHTML += inventoryItems.map(item => {
            const itemDef = ITEM_DATA[item.id];
            // 过滤掉情报等不适合赠送的物品
            if (!itemDef || itemDef.type === '文书') return ''; 
            return `
                <div class="marketplace-item">
                    <span>
                        <strong>${itemDef.name}</strong> (x${item.amount})<br>
                        <small>${itemDef.desc}</small>
                    </span>
                    <button class="control-btn" onclick="giveGift('${npcId}', '${item.id}', '${item.instanceId}', 'inventory')">赠送</button>
                </div>
            `;
        }).join('');
    }

    const content = `
        <p>选择一件物品送给 <strong class="highlight-npc">${npc.name}</strong>：</p>
        <div style="max-height: 50vh; overflow-y: auto;">${itemsHTML}</div>
    `;
    showDecisionCard(`赠送礼物`, 'fa-gift', content, []);
}
// 【新增】处理赠送礼物逻辑的函数
function giveGift(npcId, itemId, instanceIdStr, source) {
    const npc = gameState.npcs[npcId];
    if (!npc) {
        showToast("操作失败，人物不存在。");
        return;
    }

    let itemDef, favorChange, resultText;
    let itemRemoved = false;
    // 【核心修改】兼容字符串和数字类型的 instanceId
    const instanceId = isNaN(parseInt(instanceIdStr)) ? instanceIdStr : parseInt(instanceIdStr);

    // 【核心修改】根据来源（source）决定从哪里移除物品
    if (source === 'warehouse') {
        const itemIndex = gameState.tradingSystem.warehouse.findIndex(i => i.instanceId === instanceId);
        if (itemIndex > -1) {
            gameState.tradingSystem.warehouse.splice(itemIndex, 1);
            itemDef = TRADING_GOODS_DATA[itemId];
            itemRemoved = true;
        }
    } else if (source === 'inventory') {
        if (removeItemFromInventory(itemId, 1, instanceId)) {
            itemDef = ITEM_DATA[itemId];
            itemRemoved = true;
        }
    }

    if (!itemRemoved || !itemDef) {
        showToast("操作失败，物品不存在。");
        return;
    }

    // 【新增逻辑】判断好感度变化，为亲手制作的信物增加特殊加成
    if (itemDef.sincerity) { 
        favorChange = 10 + Math.floor(itemDef.sincerity / 2);
        resultText = `这份亲手制作的礼物饱含心意，对方感动不已！`;
    } else if (npc.preferences && npc.preferences.likes.includes(itemId)) {
        favorChange = getRandomInt(15, 25);
        resultText = `这正是TA心头所好！对方看起来欣喜若狂。`;
    } else if (npc.preferences && npc.preferences.dislikes.includes(itemId)) {
        favorChange = -getRandomInt(5, 10);
        resultText = `TA的脸色沉了下来，似乎并不喜欢这个礼物。`;
    } else {
        favorChange = getRandomInt(1, 5); // 普通礼物
        resultText = `收下了你的礼物，对你表示感谢。`;
    }
    
    applyEffects({ relationship: { targetId: npcId, favor: favorChange } });

    // 显示结果
    showEventCard('赠礼结果', 'fa-gift',
        `你将【${itemDef.name}】送给了 ${npc.name}。<br>${resultText}<br>好感度 ${favorChange > 0 ? '+' : ''}${favorChange}。`
    );

    // 刷新可能打开的NPC界面
    if (document.getElementById('npcDetailOverlay').style.display === 'flex') {
        showNPCDetails(npcId);
    }
}
// 【新增】NPC回礼的检查函数
function checkForNpcGifting() {
    if (!gameState.social.relationships) return;

    Object.keys(gameState.social.relationships).forEach(npcId => {
        const npc = gameState.npcs[npcId];
        if (npc && !npc.isDead && npc.favor > 70 && Math.random() < 0.05) { // 好感度>70, 5%几率
            const warehouse = gameState.tradingSystem.warehouse;
            if (warehouse.length >= gameState.tradingSystem.warehouseCapacity) return;

            const giftId = getRandomElement(Object.keys(TRADING_GOODS_DATA));
            const giftDef = TRADING_GOODS_DATA[giftId];

            warehouse.push({
                instanceId: Date.now(),
                id: giftId,
                buyPrice: 0, // 获赠的物品成本为0
                boughtAt: { ...gameState.date }
            });

            showEventCard('意外之喜', 'fa-gift', 
                `<strong class="highlight-npc">${npc.name}</strong>前来拜访，并为你带来了一件礼物【${giftDef.name}】，以感谢你一直以来的情谊。`
            );
        }
    });
}
function generateInitialNPCs() {
    gameState.suitors = [];
    // The initial 5 suitors are removed as per request.
    // New ones will be generated via events.
}

function getSweetheartEvents() {
    const sweetheart = gameState.npcs[gameState.flags.childhoodSweetheartId];
    if (!sweetheart) return [];

    return [
        {
            id: 'study_together',
            title: '书斋共读',
            description: `窗外细雨连绵，你与 <strong class="highlight-npc">${sweetheart.name}</strong> 正在书房一同温习功课。她有一处经义不解，向你请教。`,
            options: [
                { text: '【耐心讲解】', req: { wisdom: 40 }, effects: { favor: 5, bond: 10, player_wisdom: 1 }, log: '她对你的才学钦佩不已，你们的羁绊更深了。' },
                { text: '【借机调侃】', req: { charm: 40 }, effects: { favor: 8, bond: 5 }, log: '你打趣她，她佯怒捶你，气氛暧昧。' },
                { text: '【我也不懂】', req: {}, effects: { bond: 5 }, log: '你们相视一笑，决定一起去请教先生。' }
            ]
        },
        {
            id: 'lantern_festival',
            title: '元宵灯会',
            description: `元宵佳节，人潮汹涌，你与 <strong class="highlight-npc">${sweetheart.name}</strong> 不慎在灯会上走散。`,
            options: [
                { text: '【冷静寻找】', req: {}, effects: { favor: 10, bond: 10 }, log: '你最终在桥边找到了焦急的她，她扑入你的怀中。' },
                // This option requires an item system, for now we simplify it
                { text: '【大声呼喊】', req: {}, effects: { favor: 5, bond: 5 }, log: '你在人群中大声呼喊她的名字，终于找到了彼此。' }
            ]
        },
        {
            id: 'unjust_blame',
            title: '无妄之灾',
            description: `她因误会而被长辈责罚，独自在花园垂泪。`,
            options: [
                { text: '【挺身而出，为她辩解】', req: {}, effects: { favor: 15, bond: 20 }, log: '你为她承担了责任，她视你为唯一的依靠。' },
                { text: '【默默陪伴安慰】', req: {}, effects: { favor: 8, bond: 8 }, log: '你的陪伴给了她力量。' }
            ]
        }
    ];
}
// =======================================================================
// ===================== 【新增】情人专属随机事件触发器 ==================
// =======================================================================
function triggerLoverEvents() {
    if (!gameState.social.secretLovers || gameState.social.secretLovers.length === 0) return;

    // 每回合为每个情人计算一次触发几率
    gameState.social.secretLovers.forEach(loverId => {
        const npc = gameState.npcs[loverId];
        if (!npc || npc.isDead) return;

        // 基础触发率5%，好感度越高几率越大
        const triggerChance = 0.05 + (npc.favor / 500); 

        if (Math.random() < triggerChance) {
            const allEvents = Object.values(LOVER_EVENTS);
            const eventData = getRandomElement(allEvents);

            // 检查事件触发条件
            if (eventData.condition && !eventData.condition(gameState, npc)) {
                return; // 不满足条件则跳过
            }
            
            // 找到了一个可触发的事件
            let options = [];
            if (eventData.options) {
                options = eventData.options.map(opt => {
                    // 检查选项要求
                    let canSelect = true;
                    if (opt.req) {
                        for (const key in opt.req) {
                            if ((gameState.player.attributes[key] || gameState.finances[key] || 0) < opt.req[key]) {
                                canSelect = false;
                                break;
                            }
                        }
                    }
                    return {
                        htmlContent: `<span class="option-text">${opt.text}</span>`,
                        disabled: !canSelect,
                        callback: () => {
                            let resultLog = opt.log;
                            if (opt.effects) {
                                if (opt.effects.favor) applyEffects({ relationship: { targetId: loverId, favor: opt.effects.favor }});
                                if (opt.effects.devotion) {
                                    const rel = gameState.social.relationships[loverId];
                                    if (rel) rel.emotionValue = (rel.emotionValue || 0) + (opt.effects.devotion * 1.5);
                                }
                                if (opt.effects.wealth) applyEffects({ wealth: opt.effects.wealth });
                            }
                            if (opt.callback) {
                                opt.callback(loverId); // 处理特殊回调，如和离
                            }
                            showEventCard(eventData.title, 'fa-heart-broken', resultLog);
                        }
                    };
                });
            } else {
                 // 如果事件没有选项，只有一个默认结果
                 if (eventData.effects) {
                    if (eventData.effects.favor) applyEffects({ relationship: { targetId: loverId, favor: eventData.effects.favor }});
                 }
            }

            // 将事件推入队列，等待显示
            eventQueue.push(() => {
                if (eventData.options) {
                    showDecisionCard(eventData.title, 'fa-mask', eventData.desc, options);
                } else {
                    showEventCard(eventData.title, 'fa-mask', eventData.desc);
                }
            });
        }
    });
}
function triggerSweetheartEvent() {
    const playerAge = gameState.player.age;
    const bondValue = gameState.flags.bondValue || 0;
    const triggeredEvents = gameState.flags.triggeredSweetheartEvents || [];
    
    // [修改] 根据玩家性别选择不同的事件库
    const eventPool = gameState.player.gender === 'female' 
        ? CHILDHOOD_SWEETHEART_EVENTS_FEMALE_PERSPECTIVE 
        : CHILDHOOD_SWEETHEART_EVENTS;
    // 筛选出所有当前可触发的事件
    const availableEvents = Object.values(eventPool).filter(event => {
        const inAgeRange = playerAge >= event.age_range[0] && playerAge <= event.age_range[1];
        const notTriggered = !triggeredEvents.includes(event.id);
        const bondMet = !event.bond_req || bondValue >= event.bond_req;
        const careerMet = !event.is_career_related || (gameState.career.path && gameState.career.level > 0);
        return inAgeRange && notTriggered && bondMet && careerMet;
    });
    if (availableEvents.length === 0) return;
    let eventToTrigger = availableEvents.find(e => e.is_final);
    if (!eventToTrigger) {
        eventToTrigger = availableEvents.find(e => !e.is_random);
    }
    if (!eventToTrigger && Math.random() < 0.3) {
        eventToTrigger = getRandomElement(availableEvents.filter(e => e.is_random));
    }
    
    if (!eventToTrigger) return;
    
    gameState.flags.triggeredSweetheartEvents.push(eventToTrigger.id);
    
    let options = [];
    
    if (eventToTrigger.is_final) {
        const sweetheart = gameState.npcs[gameState.flags.childhoodSweetheartId];
        if (!gameState.marriage.isMarried) {
            options.push({
                text: `【前往提亲，立为正妻】`,
                req: { bond: 80, wealth: 5000 },
                effects: { proposal: 'wife' },
                log: `你决定不负韶华，前往${sweetheart.name}家中提亲。`
            });
        }
        if (gameState.marriage.isMarried && sweetheart.relationship !== 'spouse') {
            options.push({
                text: `【纳她为妾】`,
                req: { bond: 70 },
                effects: { proposal: 'concubine' },
                log: `你已娶妻，但仍放不下她，决定将她纳为妾室。`
            });
        }
        if (gameState.player.attributes.virtue > 60) {
            options.push({
                text: `【赠金祝福，此生为友】`,
                req: {},
                effects: { proposal: 'friend' },
                log: `你送上一份厚礼，祝福她觅得良人。你们将成为一生的知己。`
            });
        }
        if(gameState.marriage.isMarried && sweetheart.relationship === 'spouse') {
             showEventCard("命运弄人", "fa-cloud-rain", "某个雨夜，你与她在街角偶遇，彼此已是他人夫/妇。你们相视一笑，感叹命运弄人，从此关系固定为“知己”，不再有爱情后续。");
             return;
        }
    } else {
        options = eventToTrigger.options;
    }
    
    let decisionOptions = options.map(opt => {
        let canSelect = true;
        let reqText = "";
        if (opt.req) {
            for (const attr in opt.req) {
                const requiredValue = opt.req[attr];
                const playerValue = attr === 'wealth' ? gameState.finances.wealth : (gameState.player.attributes[attr] || 0);
                if (playerValue < requiredValue) {
                    canSelect = false;
                    reqText += `${attr === 'wealth' ? '财富' : ATTR_MAP[attr]}≥${requiredValue} `;
                }
            }
        }
        return {
            htmlContent: `<span class="option-text">${opt.text}${reqText ? `<div><small>(要求: ${reqText})</small></div>` : ''}</span>`,
            disabled: !canSelect,
            callback: () => handleSweetheartEventResult(eventToTrigger.id, opt)
        };
    });
    eventQueue.push(() => {
        showDecisionCard('青梅竹马', 'fa-hand-holding-heart', eventToTrigger.description, decisionOptions);
    });
}

// [替换] 找到这个函数并用下面的代码完整替换
// [替换此函数]
function handleSweetheartEventResult(eventId, option) {
    const sweetheartId = gameState.flags.childhoodSweetheartId;
    let effects = { ...option.effects }; // 复制效果对象
    // 处理随机效果
    if (effects.random) {
        let roll = Math.random();
        let cumulativeChance = 0;
        for (const outcome of effects.random) {
            cumulativeChance += outcome.chance;
            if (roll < cumulativeChance) {
                effects.bond = (effects.bond || 0) + outcome.bond;
                option.log = outcome.log;
                break;
            }
        }
    }

    if (effects.bond) {
        gameState.flags.bondValue = (gameState.flags.bondValue || 0) + effects.bond;
    }
    if (effects.attributes) {
        applyEffects({ attributes: effects.attributes });
    }
    if (effects.wealth) {
        applyEffects({ wealth: effects.wealth });
    }
    if (effects.flag) {
        gameState.flags[effects.flag] = true;
    }
    if (effects.item) {
        addItemToInventory(effects.item.id, 1, effects.item);
    }

    if (effects.proposal) {
        const sweetheart = gameState.npcs[sweetheartId];
        const proposalType = effects.proposal;

        if (gameState.player.gender === 'female') {
            let successChance = 0.5 + (gameState.flags.bondValue / 250); 
            if (sweetheart.personality.includes('果敢')) successChance += 0.2;
            if (sweetheart.personality.includes('内敛')) successChance -= 0.1;
            if (Math.random() < successChance) {
                option.log = `你多年的等待终有结果，${sweetheart.name}带着厚礼前来提亲，你欣然应允。`;
                marrySuitor(sweetheartId);
                return; 
            } else {
                option.log = `${sweetheart.name}虽对你有意，但因种种原因未能前来提亲，你们终是有缘无分。`;
                // 【核心修复】从可追求列表中移除
                gameState.suitors = gameState.suitors.filter(id => id !== sweetheartId); 
            }
        } 
        else { // 男性玩家逻辑
            switch(proposalType) {
                case 'wife':
                    let successChance = 0.6 + (gameState.flags.bondValue / 200);
                    if (gameState.flags.proposal_bonus) successChance += 0.1;
                    if (gameState.flags.mother_support) successChance += 0.15;
                    if (gameState.family.reputation > 100) successChance += 0.1;

                    if (Math.random() < successChance) {
                        marrySuitor(sweetheartId); 
                        option.log = `提亲成功！你与${sweetheart.name}的爱情修成正果。`;
                        return; 
                    } else {
                        option.log = `提亲失败，${sweetheart.name}被许配给了他人，你们有缘无分。`;
                        gameState.suitors = gameState.suitors.filter(id => id !== sweetheartId);
                    }
                    break;
                case 'concubine':
                    if (gameState.flags.bondValue > 70) {
                        option.log = `${sweetheart.name}委身于你，但内心充满委屈。`;
                        acquireConcubine(sweetheartId);
                        applyEffects({ relationship: { targetId: sweetheartId, favor: -30 } });
                    } else {
                        option.log = `${sweetheart.name}拒绝了你的请求，不愿为妾。`;
                    }
                    break;
                case 'friend':
                    applyEffects({wealth: -1000}); 
                    option.log = `你送上厚礼，从此你们成为一生的知己。`;
                    if(gameState.social.relationships[sweetheartId]) {
                        gameState.social.relationships[sweetheartId].type = 'red_confidante';
                        gameState.social.relationships[sweetheartId].level = 4;
                    }
                    break;
            }
        }
    }

    showEventCard('青梅竹马', 'fa-hand-holding-heart', option.log);
}
// [新增] 检查并触发徒弟试炼事件的函数
function checkForApprenticeTrials() {
    const activeApprentices = gameState.apprentices.filter(a => a.state === 'learning');
    if (activeApprentices.length === 0) return;

    // 每回合只检查一个徒弟，避免事件过多
    const apprentice = getRandomElement(activeApprentices);

    // 15% 的几率触发试炼事件
    if (Math.random() < 0.15) {
        let potentialTrials = [];
        // 如果徒弟才情遇到瓶颈
        if (apprentice.attributes.talent < 60 && apprentice.age > 15) {
            potentialTrials.push('talent');
        }
        // 如果徒弟武学遇到瓶颈
        if (apprentice.attributes.martial < 60 && apprentice.age > 15) {
            potentialTrials.push('martial');
        }

        if (potentialTrials.length > 0) {
            const trialType = getRandomElement(potentialTrials);
            // 使用事件队列来显示，防止与其他弹窗冲突
            eventQueue.push(() => {
                triggerApprenticeTrial(apprentice.id, trialType);
            });
        }
    }
}
// [替换]
// [用这个新版本替换]
// [新增此函数]
function applyPassiveBonuses() {
    // 检查御赐文房四宝
    if (hasItemInInventory('yu_ci_wen_fang_si_bao')) {
        const talentGain = 5;
        const reputationGain = 10;
        applyEffects({ attributes: { talent: talentGain }, reputation: reputationGain });
        logEvent(`你的<strong class="value">【御赐文房四宝】</strong>让你文思泉涌，名声远扬，才情+${talentGain}，声望+${reputationGain}。`, true);
    }
    // 检查名师匾额
    if (gameState.inventory.some(item => item.id === 'ming_shi_bian_e')) {
        const reputationGain = 5 * gameState.inventory.filter(item => item.id === 'ming_shi_bian_e').length;
        applyEffects({ reputation: reputationGain });
        logEvent(`你的<strong class="value">【名师匾额】</strong>为你带来了 ${reputationGain} 点声望。`, true);
    }
}
// [替换此函数]
function advanceTime() {
    checkForApprenticeTrials();
    checkForApprenticeSocialEvents();
    // ▼▼▼ 海运修复点 ▼▼▼
    processMaritimeTradeCycle(); // 新增此行，以在每回合推进海运周期
    // ▲▲▲ 修复结束 ▲▲▲
    delete gameState.flags.ateGoldenFriesThisTurn;
    gameState.player.age += 0.5;
    gameState.date.turn = gameState.date.turn === 1 ? 2 : 1;
    if (gameState.date.turn === 1) {
        gameState.date.year++;
        // Yearly events
        let annualIncome = gameState.family.annualIncome;
        if(gameState.career.path && gameState.career.level > -1) {
            annualIncome += careerPaths[gameState.player.gender][gameState.career.path].levels[gameState.career.level].salary * 2;
        }
        // 【新增】检查两淮盐引的年收益
        if (hasItemInInventory('liang_huai_yan_yin')) {
            const saltIncome = 50000; // 每年五十万两的巨额财富
            annualIncome += saltIncome;
            logEvent(`你持有的<strong class="value">【两淮盐引】</strong>为你带来了 <span class="value">${saltIncome}</span> 两的巨额年收益。`, true);
        }

        // ▼▼▼ 俸禄修复点 ▼▼▼
        // 原代码: applyEffects({wealth: annualIncome});
        // 修改为:
        gameState.career.unclaimedSalary = (gameState.career.unclaimedSalary || 0) + annualIncome;
        // ▲▲▲ 修复结束 ▲▲▲

        applyPassiveBonuses();
        logEvent(`年初结算，你的待领取俸禄增加了 <span class="value">${annualIncome}</span> 两。`);
        processAssetAppreciation();
        processInvestmentReturns();
        updateNPCs();
        updateFriendships();
    }
    // Half-yearly events
    processCropGrowth();
    if(gameState.merchant.seaExplorationCooldown > 0) gameState.merchant.seaExplorationCooldown--;
    // Reset flags
    gameState.flags.actionUsed_study = 0;
    gameState.flags.actionUsed_apprentice = 0;
    gameState.flags.actionUsed_family = false;
    gameState.flags.actionUsed_work = 0;
    gameState.flags.wishingWellThisTurn = false;
    gameState.flags.npcInteractionCounts = {}; 
    delete gameState.flags.confessionAttemptedThisTurn;
}

// ===================== 【新增】NPC互动计数器函数 START =====================
/**
 * 检查并消耗指定NPC的一个行动点
 * @param {string} npcId - 要检查的NPC的ID
 * @param {number} limit - 该NPC的互动上限，默认为2
 * @returns {boolean} - 是否可以执行该行动
 */
function checkAndUseNpcActionPoint(npcId, limit = 2) {
// 确保计数器对象存在
if (gameState.flags.debug_unlimitedActions) {
        return true;
    }

    if (!gameState.flags.npcInteractionCounts) {
        gameState.flags.npcInteractionCounts = {};
    }
    
    const currentCount = gameState.flags.npcInteractionCounts[npcId] || 0;
    
    if (currentCount >= limit) {
        const npc = gameState.npcs[npcId];
        showToast(`本回合与 ${npc.name} 的互动次数已用尽。`);
        return false;
    }
    
    // 次数加一并记录
    gameState.flags.npcInteractionCounts[npcId] = currentCount + 1;
    return true;
}
// ===================== 【新增】NPC互动计数器函数 END =====================

// =======================================================================
// ========================= MAIN GAME LOOP ==============================
// =======================================================================
let eventQueue = [];
let isProcessingEvent = false;

// [替换]
function nextTurn() {
if (isProcessing) return;
checkLowHealthWarning(); // <--- 在这里添加这一行代码
    isProcessing = true;
    
    eventQueue = [];
    pendingEvents = [];

    let birthHappened = false;
    // 检查所有可能的怀孕和分娩事件
    if (pregnancyCheck('player', gameState.player.isSecretPregnancy)) birthHappened = true;
    if (gameState.player.gender === 'male') {
        if (gameState.marriage.isMarried && gameState.marriage.spouseId) {
            if (pregnancyCheck(gameState.marriage.spouseId, false)) birthHappened = true;
        }
        (gameState.marriage.concubines || []).map(id => gameState.npcs[id]).forEach(conc => {
            if (conc && pregnancyCheck(conc.id, false)) birthHappened = true;
        });
        (gameState.social.secretLovers || []).map(id => gameState.npcs[id]).forEach(lover => {
            if (lover && pregnancyCheck(lover.id, true)) birthHappened = true;
        });
    }

    // [修改核心] 只有在没有分娩的正常回合，才触发其他随机事件
    if (!birthHappened) {
        // 1. 专门生成 HUB 事件，并推送到 pendingEvents 数组
        generateAndQueueHubEvents();
        
        // 2. 触发其他非 HUB 类型的事件，并将它们推送到 eventQueue 队列
        if (gameState.flags.childhoodSweetheartId) {
            triggerSweetheartEvent();
        }
        triggerLoverEvents(LOVER_EVENTS_EXPANDED);
        checkForFatedLoverEvent();
        checkForApprenticeTrials();
        checkForApprenticeSocialEvents();
        triggerInnerCourtEvent(); // 宅斗事件会推送到 eventQueue
        
        if (gameState.player.gender === 'male') {
            triggerHaremEvent();
        }
        if (gameState.marriage.isMarried) {
            triggerSpouseEvent();
            checkForSecretLoverDiscovery();
            updateInfidelityRisk();
            updateHusbandSuspicion();
        }

        // 3. 女性玩家掌家权自动增长逻辑
        if (gameState.player.gender === 'female' && gameState.marriage.isMarried && gameState.marriage.householdAuthority.progress < 100) {
            const authority = gameState.marriage.householdAuthority;
            const favor = gameState.marriage.favor;
            const wisdom = gameState.player.attributes.wisdom;
            if (favor > 60 && wisdom > 70 && Math.random() < 0.15) {
                const authorityTypes = ['personnel', 'finance', 'procurement'];
                const randomAuthority = getRandomElement(authorityTypes);
                if ((authority[randomAuthority] || 0) < 100) {
                    authority[randomAuthority] = (authority[randomAuthority] || 0) + 1;
                    authority.progress = Math.floor(((authority.personnel||0) + (authority.finance||0) + (authority.procurement||0)) / 3);
                    logEvent(`你持家有道，在潜移默化中对夫家的${{personnel:'人事', finance:'财务', procurement:'采办'}[randomAuthority]}事务有了更多了解。`);
                }
            }
        }
    }
    
    // Buff 持续时间减少
    if (gameState.buffs) {
        for (const buffId in gameState.buffs) {
            gameState.buffs[buffId].duration--;
            if (gameState.buffs[buffId].duration <= 0) {
                delete gameState.buffs[buffId];
                logEvent(`你的【${{partner_luck:'姻缘', career_luck:'功名', wealth_luck:'财运'}[buffId] || '祝福'}】效果已结束。`);
            }
        }
    }

    const nextTurnButton = document.querySelector('.control-btn[onclick="nextTurn()"]');
    if (nextTurnButton) nextTurnButton.classList.add('button-loading');

    // ================== 时间推进 & 状态更新 ==================
    advanceTime();

    if (gameState.date.turn === 1) {
        updateMarketStatus();
    } else {
        gameState.tradingSystem.isTradingPeriod = false;
    }

    gameState.player.health = Math.max(0, gameState.player.health - getRandomInt(0, 1));
    if (gameState.player.age > 40) gameState.player.attributes.charm -= getRandomInt(0, 1);

    handleDisease();
    updateApprentices();
childrenGrowUp();
checkHusbandTakesConcubine();
    updateHusbandState();
    updateHaremStatus();
    checkForAuthorityTransfer_Male();
    checkForInvestigationCompletion();
    
    updateFriendships();
    checkRelationshipBreakup();
    checkForNpcGifting();
    checkForNpcInitiatedEvents();
    checkForPromotion();
    checkMilestoneEvent();

    if (gameState.date.turn === 2) {
        calculateAndDeductExpenses();
        updateFinancialTier();
    }

    updateRankings();

    if (checkEndGame()) {
        isProcessing = false;
        if (nextTurnButton) nextTurnButton.classList.remove('button-loading');
        return;
    }

    gameState.flags.autoSaveCounter++;
    if (gameState.flags.autoSaveCounter >= 2) {
        gameState.flags.autoSaveCounter = 0;
        autoSaveGame();
        showToast("游戏已自动存档。");
    }

    // 如果有待处理的 HUB 事件，并且本回合没有分娩，则插入打开信息中心的指令
    if (pendingEvents.length > 0 && !birthHappened) {
        eventQueue.unshift(() => {
            openEventHub();
        });
    }

    // 最后，处理整个事件队列
    processEventQueue(nextTurnButton);
}

function generateAndQueueHubEvents() {
    let potentialEvents = [];
    const gs = gameState;

    // 1. 只从 HUB_EVENTS 中筛选符合条件的事件
    for (const eventKey in HUB_EVENTS) {
        const eventTemplate = HUB_EVENTS[eventKey];
        if (eventTemplate.condition(gs)) {
            potentialEvents.push(eventTemplate);
        }
    }
    
    // 2. 为了保证多样性，按类型分组
    const groupedEvents = potentialEvents.reduce((acc, event) => {
        acc[event.type] = acc[event.type] || [];
        acc[event.type].push(event);
        return acc;
    }, {});

    let selectedEvents = [];
    // 3. 每种类型最多选一个
    for(const type in groupedEvents) {
        selectedEvents.push(getRandomElement(groupedEvents[type]));
    }
    
    // 4. 打乱并限制数量，然后生成最终事件
    selectedEvents.sort(() => 0.5 - Math.random());
    const eventCount = Math.min(selectedEvents.length, 2); // 每回合最多生成2个信息中心事件
    
    selectedEvents.slice(0, eventCount).forEach(eventTemplate => {
        // 5. 确保只对有 .generate 方法的对象调用它
        if (eventTemplate && typeof eventTemplate.generate === 'function') {
            const finalEvent = eventTemplate.generate(gs);
            addPendingEvent(finalEvent); // 添加到信息中心待办列表
        } else {
            console.warn("一个HUB事件模板缺少 generate 函数:", eventTemplate);
        }
    });
}
// ▲▲▲ 替换结束 ▲▲▲
function processEventQueue(nextTurnButton) {
    if (eventQueue.length > 0 && !isProcessingEvent) {
        isProcessingEvent = true;
        const eventCallback = eventQueue.shift();

        if (gameState.flags.isBatchProcessing) {
            // 在批量模式下，直接执行回调，不显示UI
            eventCallback();
            isProcessingEvent = false;
            processEventQueue(nextTurnButton); // 立即处理下一个
        } else {
            // 正常模式，显示UI
            if (document.getElementById('eventHubOverlay').style.display !== 'flex') {
                closeAllOverlays(); 
            }
            setTimeout(() => { 
                eventCallback();
                isProcessingEvent = false;
                if (document.getElementById('eventHubOverlay').style.display !== 'flex' || eventQueue.length > 0) {
                    processEventQueue(nextTurnButton); 
                } else {
                    if (nextTurnButton) nextTurnButton.classList.remove('button-loading');
                    isProcessing = false;
                    renderGame();
                }
            }, 300);
        }
    } else if (eventQueue.length === 0 && !isProcessingEvent) {
        // 队列处理完毕
        if (!gameState.flags.isBatchProcessing) {
             if (nextTurnButton) nextTurnButton.classList.remove('button-loading');
             renderGame();
        }
        // 【核心修复】无论是否在批量模式，处理完一个完整回合的事件队列后，
        // 都必须将 isProcessing 状态重置为 false，
        // 这样 skipTurns 函数的下一次循环才能成功调用 nextTurn()。
        isProcessing = false;
    }
}
function updateNPCs() {
    if (!gameState.npcs) return;
    Object.keys(gameState.npcs).forEach(npcId => {
        const npc = gameState.npcs[npcId];
        if (!npc || npc.id === 'player' || npc.isDead) return;

        npc.age += 1;

        let deathChance = 0;
        if (npc.age > 90) deathChance = 0.5;
        else if (npc.age > 80) deathChance = 0.2;
        else if (npc.age > 70) deathChance = 0.05;

        if (Math.random() < deathChance) {
            npc.isDead = true;
     
            let role = npc.role || '友人';
            if(npc.relationship === 'suitor') role = '一位故人';
            showEventCard('故人西辞', '🕯️', `岁月无情，你的${role} <strong class="highlight-npc">${npc.name}</strong> 寿终正寝，你感到十分悲伤。`);
            applyEffects({attributes: {virtue: -5}});
        }
    });
}
// 新增函数：处理分娩事件（包括难产判定）
// 新增函数：处理分娩事件（包括难产判定）
function handleBirthEvent(motherId, isSecret) {
    const motherNPC = motherId === 'player' ? gameState.player : gameState.npcs[motherId];

    const motherAge = motherNPC.age;
    let miscarriageChance = 0;
    if (motherAge >= 40 && motherAge < 50) miscarriageChance = 0.08;
    else if (motherAge >= 50 && motherAge < 60) miscarriageChance = 0.18;
    else if (motherAge >= 60) miscarriageChance = 0.28;

    if (Math.random() < miscarriageChance) {
        const motherName = motherNPC.name;
        const isPlayerMother = (motherId === 'player');

        const decisionText = `你的${isPlayerMother && gameState.player.gender === 'female' ? '' : (gameState.npcs[motherId]?.role || '妾室')} <strong class="highlight-npc">${motherName}</strong> 难产了，情况危急！你决定...`;
        const options = [
            { htmlContent: '<i class="fas fa-baby"></i> 保孩子', callback: () => handleChildbirthDecision(true, motherId, isSecret) },
            { htmlContent: '<i class="fas fa-heart"></i> 保大人', callback: () => handleChildbirthDecision(false, motherId, isSecret) }
        ];

        showDecisionCard('生死抉择', 'fa-heartbeat', decisionText, options);
    } else {
        handleChildbirthSuccess(motherId, isSecret);
    }
}

function handleChildbirthSuccess(motherId, isSecret) {
    const motherNPC = motherId === 'player' ? gameState.player : gameState.npcs[motherId];
    let fatherNPC, biologicalFatherId;

    if (motherId === 'player') { // 如果母亲是玩家
        fatherNPC = gameState.marriage.isMarried ? gameState.npcs[gameState.marriage.spouseId] : null; // 合法父亲是丈夫
        biologicalFatherId = motherNPC.biologicalFatherOfUnborn || (fatherNPC ? fatherNPC.id : null); // 生物学父亲是情人或丈夫
        delete motherNPC.biologicalFatherOfUnborn; // 清理标记
    } else { // 如果母亲是NPC（玩家为男性）
        fatherNPC = gameState.player;
        biologicalFatherId = fatherNPC.id; // 生物学父亲就是玩家
    }

    const gender = Math.random() > 0.5 ? 'male' : 'female';
    const newChild = {
        id: `child_${Date.now()}`, gender: gender, age: 0, isDead: false,
        motherId: motherId, 
        fatherId: fatherNPC ? fatherNPC.id : null, // 合法父亲
        biologicalFatherId: biologicalFatherId, // [新增] 生物学父亲
        isSecret: isSecret,
        attributes: {}, personality: [], cultivationLog: [],
        marriage: { isMarried: false, spouseId: null },
        education: null, allowance: 0, career: null,
        avatar: getRandomElement(avatarPools[gender])
    };

    const p1_attrs = motherNPC.id === 'player' ? gameState.player.attributes : (motherNPC.attributes || {});
    // 如果是私生子且没有合法父亲，则使用生物学父亲的属性
    const p2_source = fatherNPC || gameState.npcs[biologicalFatherId];
    const p2_attrs = p2_source ? (p2_source.id === 'player' ? gameState.player.attributes : (p2_source.attributes || {})) : { talent: 20, wisdom: 20, charm: 20 };

    newChild.attributes = {
        talent: Math.floor(((p1_attrs.talent || 20) + (p2_attrs.talent || 20)) / 10) + getRandomInt(1, 5),
        wisdom: Math.floor(((p1_attrs.wisdom || 20) + (p2_attrs.wisdom || 20)) / 10) + getRandomInt(1, 5),
        charm: Math.floor(((p1_attrs.charm || 20) + (p2_attrs.charm || 20)) / 10) + getRandomInt(1, 5),
        health: 100, etiquette: 0, virtue: 0, martial: 0
    };

    gameState.children.push(newChild);

    if (motherNPC.relationship === 'concubine' && isSecret) {
        showNameChildOverlay(newChild.id, motherNPC.name, true);
    } else {
        showNameChildOverlay(newChild.id, motherNPC.name, false);
    }
}
function handleChildbirthDecision(saveChild, motherId, isSecret) {
    const motherNPC = motherId === 'player' ? gameState.player : gameState.npcs[motherId];
    const motherName = motherNPC.name;

    if (saveChild) {
        motherNPC.isDead = true;
        showEventCard('保住孩子', 'fa-baby-carriage', `你决定保住孩子。孩子平安降生，但母亲${motherName}却香消玉殒...你悲痛万分。`);
        handleChildbirthSuccess(motherId, isSecret); // 孩子存活，继续后续流程
        // 从配偶或妾室列表中移除
        if(motherId !== 'player') {
            if(gameState.marriage.spouseId === motherId) {
                gameState.marriage.isMarried = false;
                gameState.marriage.spouseId = null;
            }
            gameState.marriage.concubines = gameState.marriage.concubines.filter(id => id !== motherId);
        }
    } else {
        // 保大人
        showEventCard('保住大人', 'fa-heart', `你决定保住大人。在医官的努力下，母亲${motherName}脱离了危险，但孩子未能保住。`);
        motherNPC.health = Math.max(0, motherNPC.health - 20); // 母亲健康下降
    }
    closeAllOverlays();
    renderGame();
}
// 【新增】关系破裂检查函数
function checkRelationshipBreakup() {
    if (!gameState.social.relationships) return;
    
    for (const npcId in gameState.social.relationships) {
        const rel = gameState.social.relationships[npcId];
        const npc = gameState.npcs[npcId];
        if (!npc || npc.isDead) continue;
        
        let shouldBreak = false;
        let breakReason = "";
        
        // 条件1: 好感度低于-50
        if (npc.favor <= -50) {
            shouldBreak = true;
            breakReason = "你们之间已无情分可言。";
        }
        
        // 条件2: 长期不互动，情感值降为0
        const currentTurn = gameState.date.year * 2 + gameState.date.turn;
        if (currentTurn - (npc.lastInteractedTurn || 0) > 6) { // 超过3年未互动
            rel.emotionValue = Math.max(0, (rel.emotionValue || 0) - 10); // 每年情感值下降
            if (rel.emotionValue <= 0 && rel.level <= 1) { // 关系不深时才会因不联系而破裂
                shouldBreak = true;
                breakReason = "由于长期不联系，你们的情谊已渐渐消散。";
            }
        }
        
        if (shouldBreak) {
            const oldRelName = RELATIONSHIP_DATA[rel.type]?.name || "旧友";
            showEventCard('关系破裂', 'fa-user-slash', `你与 <strong class="highlight-npc">${npc.name}</strong>（${oldRelName}）的关系走到了尽头。${breakReason}`);
            
            // 从关系对象中删除
            delete gameState.social.relationships[npcId];
            
            // 从具体的分类列表中也移除
            gameState.social.friends = (gameState.social.friends || []).filter(id => id !== npcId);
            gameState.social.secretLovers = (gameState.social.secretLovers || []).filter(id => id !== npcId);
            // ...可以为其他关系类型添加类似的清理逻辑...
        }
    }
}
function checkForNpcInitiatedEvents() {
    Object.values(gameState.npcs).forEach(npc => {
        if (npc && !npc.isDead && npc.id !== 'player' && Math.random() < 0.05) { // 每回合5%几率触发
            const rel = gameState.social.relationships[npc.id];
            if (rel && (rel.level || 0) >= 3) { // 只有亲密关系以上才会主动找你
                eventQueue.push(() => {
                     showEventCard('友人来访', 'fa-envelope-open-text', `<strong class="highlight-npc">${npc.name}</strong>前来拜访，与你闲聊家常，你们的关系更加亲密了。`);
                     applyEffects({relationship: {targetId: npc.id, favor: 5, trust: 2}});
                });
            }
        }
    });
}
function updateFriendships() {
    if (!gameState.social || !gameState.social.relationships) return;

    // 从新的 relationships 对象中获取所有需要维护关系的人的ID
    const allRelationshipIds = Object.keys(gameState.social.relationships);

    allRelationshipIds.forEach(id => {
        const npc = gameState.npcs[id];
        if (npc && !npc.isDead) {
            const currentTurnCount = (gameState.date.year * 2) + gameState.date.turn;
            const lastInteraction = npc.lastInteractedTurn || 0;
            const rel = gameState.social.relationships[id];

            // 长期不互动，情感值会下降
            if (currentTurnCount - lastInteraction > 4) { // 超过2年
                if (rel) {
                    rel.emotionValue = Math.max(0, (rel.emotionValue || 0) - 5);
                    // 情感值归零后，关系等级也可能下降
                    updateRelationshipLevel(id); 
                }
            }
        }
    });
}
// =======================================================================
// ====================== UI RENDERING FUNCTIONS =========================
// =======================================================================
function renderGame() {
    if (!gameState.flags || !gameState.flags.gameStarted) return;
    const container = document.getElementById('game-container');
    if (!container) return;

    const currentTheme = document.body.dataset.theme || 'spring';

    container.innerHTML = `
        <div class="theme-switcher">
            <div id="theme-spring" class="theme-icon" onclick="setTheme('spring')">春</div>
            <div id="theme-summer" class="theme-icon" onclick="setTheme('summer')">夏</div>
            <div id="theme-autumn" class="theme-icon" onclick="setTheme('autumn')">秋</div>
            <div id="theme-winter" class="theme-icon" onclick="setTheme('winter')">冬</div>
            <div id="theme-night" class="theme-icon" onclick="setTheme('night')"><i class="fas fa-moon"></i></div>
        </div>
        <div class="game-block character-card">
            ${renderCharacterInfo()}
            ${renderAttributes()}
        </div>
        <div class="game-block status-card">
            ${renderStatusBar()}
        </div>
        <div class="game-block main-content-card">
            <div class="tab-container" id="tabContainer"></div>
            <div id="tabContentContainer"></div>
        </div>
        <div class="game-block controls-card">
            <div class="controls">
                <button class="control-btn" onclick="nextTurn()"><i class="fas fa-hourglass-half"></i> 下一回合</button>
                <button class="control-btn" onclick="showRestartOptions()"><i class="fas fa-feather-alt"></i> 下一人生</button>
                <button class="control-btn" onclick="showSaveLoadOverlay(true)"><i class="fas fa-save"></i> 存档</button>
                <button class="control-btn" onclick="showSaveLoadOverlay(false)"><i class="fas fa-folder-open"></i> 读档</button>
            </div>
        </div>`;
    
    setTheme(currentTheme); 
    
    renderTabs();
    updateActiveTab(gameState.flags.activeTab || 'main');
}
function showRestartOptions() {
    const heirs = gameState.children.filter(c => c.age >= 16 && !c.isDead);
    let options = [];
    if(heirs.length > 0) {
        options.push({htmlContent: `<i class="fas fa-child"></i> 从子嗣继承`, callback: () => handleChildInheritance()});
    }
    options.push(
        {htmlContent: `<i class="fas fa-redo"></i> 重新开始`, callback: () => startNewGame(gameState.player.gender, null)},
        {htmlContent: `<i class="fas fa-times"></i> 我再想想`, style: `background:var(--control-bg);`, callback: () => closeAllOverlays()}
    );

    showDecisionCard(
        '人生抉择', '🔄', '<p>你确定要结束当前的人生吗？</p>', options
    );
}

function renderCharacterInfo() {
    const p = gameState.player;
    let avatarContent = `
        <img class="avatar-image" src="${p.avatar || ''}" style="${p.avatar ? 'display:block;' : 'display:none;'}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <svg class="avatar-svg" viewBox="0 0 100 100" style="${p.avatar ? 'display:none;' : 'display:block;'}">
            <defs>
                <linearGradient id="avatarGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="var(--avatar-bg)" />
                    <stop offset="100%" stop-color="var(--highlight-strong)" />
                </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="48" fill="url(#avatarGradient)" />
            <text x="50" y="65" font-family="'Ma Shan Zheng', cursive" font-size="50" fill="white" text-anchor="middle">${p.name.slice(0, 1)}</text>
        </svg>`;

    return `
    <div class="character-info">
        <div class="avatar-wrapper" onclick="handleAvatarClick()">
            ${avatarContent}
        </div>
        <div class="info-details">
            <div class="info-row">
                <span class="info-label"><i class="fas fa-user"></i> 姓名:</span>
                <span class="value">${p.name}</span>
            </div>
            <div class="info-row">
                <span class="info-label"><i class="fas fa-birthday-cake"></i> 年龄:</span>
                <span class="value">${Math.floor(p.age)} 岁</span>
            </div>
            <div class="info-row">
                <span class="info-label"><i class="fas fa-heartbeat"></i> 健康:</span>
                <span class="value">${p.health} / 100</span>
            </div>
            <div class="info-row">
                <span class="info-label"><i class="fas fa-home"></i> 出身:</span>
                <span class="value">${gameState.family.title}</span>
            </div>
        </div>
    </div>`;
}
function renderAttributes() {
    const attrs = gameState.player.attributes;
    return `
    <div class="attributes-grid">
        ${renderAttributeBar('才情', attrs.talent, 'talent-fill', 'fa-pencil-alt')}
        ${renderAttributeBar('礼仪', attrs.etiquette, 'etiquette-fill', 'fa-hands-helping')}
        ${renderAttributeBar('智慧', attrs.wisdom, 'wisdom-fill', 'fa-lightbulb')}
        ${renderAttributeBar('品德', attrs.virtue, 'virtue-fill', 'fa-leaf')}
        ${renderAttributeBar('魅力', attrs.charm, 'charm-fill', 'fa-grin-stars')}
        ${renderAttributeBar('武学', attrs.martial, 'martial-fill', 'fa-khanda')}
${gameState.player.gender === 'male' ?
            renderAttributeBar('权谋', attrs.strategy, 'wisdom-fill', 'fa-chess') +
            renderAttributeBar('家威', attrs.prestige, 'etiquette-fill', 'fa-crown') :
            renderAttributeBar('心计', attrs.scheming, 'wisdom-fill', 'fa-brain')
        }
    </div>
    `;
}
function showNameChildOverlay(childId, motherName, isSecret) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;
    
    // 获取父母姓名，用于显示
    let fatherName = '你';
    if (gameState.player.gender === 'female') {
        // 如果玩家是女性，合法父亲是丈夫，生物学父亲可能是情人
        const legalFather = gameState.marriage.isMarried ? gameState.npcs[gameState.marriage.spouseId] : null;
        fatherName = legalFather ? legalFather.name : '未知';
    }
    const genderText = child.gender === 'male' ? '麟儿' : '千金';
    const parentNameText = isSecret ? `你` : `${motherName}和${fatherName}`;
    
    // 更新弹窗内容
    document.getElementById('birthResultContent').innerHTML = `
        <p>恭喜，${parentNameText}喜得一${genderText}！</p>
        <p>这是你的第 <strong class="value">${gameState.children.filter(c => !c.isSecret && !c.isDead).length}</strong> 个子嗣。</p>`;
    
    const namingSection = document.getElementById('childNamingSection');
    const secretDecision = document.getElementById('secretChildDecision');
    const closeBtn = document.getElementById('closeBirthOverlayBtn');
    
    // 隐藏关闭按钮，实现强制选择
    closeBtn.style.display = 'none';
    
    if (isSecret) {
        // 私生子的处理流程
        namingSection.style.display = 'none';
        secretDecision.style.display = 'block';
        secretDecision.innerHTML = `
            <p class="comment">此子身份特殊，你决定如何处置？</p>
            <button class="option" onclick="handleSecretChildDecision('${childId}', 'keep')"><i class="fas fa-hand-holding-heart"></i> 认领并养育</button>
            <button class="option" onclick="handleSecretChildDecision('${childId}', 'abandon')"><i class="fas fa-user-times"></i> 遗弃</button>
        `;
    } else {
        // 正常的孩子出生，显示新的命名UI，不再是二选一
        secretDecision.style.display = 'none';
        namingSection.style.display = 'block';
        namingSection.innerHTML = `
            <p><strong>请为新生儿定名：</strong></p>
            <div class.input-group">
                 <input type="text" id="newChildNameInput" placeholder="请输入1-3个字的名..." maxlength="3" style="width: calc(100% - 20px); padding: 12px; margin: 15px auto; display: block; border-radius: 10px; border: 1px solid var(--border-color-light); font-size: 1.1rem; color: var(--text-color); text-align: center;">
            </div>
            <div class="options" style="flex-direction:row; justify-content:center; gap: 15px;">
                <button class="option" onclick="confirmPlayerNaming('${childId}')">
                    <i class="fas fa-check"></i> 确认此名
                </button>
                <button class="option" onclick="autoNameBySpouse('${childId}')">
                    <i class="fas fa-user-graduate"></i> 交由配偶
                </button>
            </div>
        `;
    }
    showOverlay('nameChildOverlay');
}// [新增]
function promptPlayerForChildName(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // 使用 prompt 弹窗强制玩家输入
    const newGivenName = prompt(`请为你的${child.gender === 'male' ? '儿子' : '女儿'}输入一个名字（1-3个字，不含姓氏）：`);

    if (newGivenName === null) {
        // 如果玩家点击了“取消”，则视为交由配偶命名
        autoNameBySpouse(childId);
        return;
    }

    let trimmedName = newGivenName.trim();
    if (trimmedName.length === 0 || trimmedName.length > 3) {
        showToast("名字长度不合规，已交由配偶命名。");
        autoNameBySpouse(childId);
        return;
    }

    // 名字合规，调用原有的确认命名逻辑
    // 为了复用，我们把原 confirmChildName 的核心逻辑提取出来
    finalizeChildName(childId, trimmedName, '你');
}
// [新增]
function autoNameBySpouse(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    let namerName = '你';
    if (gameState.player.gender === 'female') {
        const husband = gameState.marriage.isMarried ? gameState.npcs[gameState.marriage.spouseId] : null;
        namerName = husband ? husband.name : "你";
    }

    const namePool = child.gender === 'female' ? nameData.girlNames : nameData.boyNames;
    const newGivenName = getRandomElement(namePool);
    
    finalizeChildName(childId, newGivenName, namerName);
}// [新增]
function finalizeChildName(childId, givenName, namer) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    let surname = '';
    const legalFather = child.fatherId ? (gameState.npcs[child.fatherId] || (child.fatherId === 'player' ? gameState.player : null)) : null;
    const biologicalFather = child.biologicalFatherId ? gameState.npcs[child.biologicalFatherId] : null;

    if (legalFather && legalFather.name) {
        surname = legalFather.name.slice(0, 1);
    } else if (biologicalFather && biologicalFather.name) {
        surname = biologicalFather.name.slice(0, 1);
    } else {
        surname = gameState.player.name.slice(0, 1);
    }

    let finalName = surname + givenName;
    
    // 查重，如果重复则在后面加“二”、“三”等
    let i = 2;
    while (gameState.flags.allNames.has(finalName)) {
        finalName = surname + givenName + (i === 2 ? '二' : '三');
        i++;
    }

    child.name = finalName;
    gameState.flags.allNames.add(finalName);
    
    const message = namer === '你'
        ? `你为新生儿取名为 <strong class="value">${child.name}</strong>。`
        : `${namer}思索片刻，为孩子取名为 <strong class="value">${child.name}</strong>。`;

    showEventCard('天赐佳名', 'fa-pen-fancy', message);

    closeAllOverlays();
    renderGame();
}

function renderAttributeBar(name, value, className, icon, maxVal = 200) {
    const numericValue = Number(value) || 0;
    return `
    <div class="attribute">
        <div class="attribute-name">
            <span><i class="fas ${icon}"></i> ${name}</span>
            <span>${Math.floor(numericValue)}</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill ${className}" style="width: ${Math.min(100, (numericValue / maxVal) * 100)}%;"></div>
        </div>
    </div>`;
}

function renderStatusBar() {
    const tier = financialTiers.find(t => t.level === gameState.finances.financialTier) || { name: '未知' };
    const dateText = `${gameState.date.year}年${gameState.date.turn === 1 ? '上半年' : '下半年'}`;
    let statusHTML = `
        <div class="status-item"><i class="fas fa-calendar-alt"></i> ${dateText}</div>
        <div class="status-item"><i class="fas fa-coins"></i> 私产: ${formatNumber(gameState.finances.wealth)}</div>
        <div class="status-item"><i class="fas fa-wallet"></i> 财力: ${tier.name}</div>
        <div class="status-item"><i class="fas fa-star"></i> 声望: ${gameState.family.reputation}</div>`;
    if (gameState.status.disease) {
        const diseaseName = diseases[gameState.status.disease.id]?.name || '未知疾病';
        statusHTML += `<div class="status-item disease"><i class="fas fa-lungs-virus"></i> 状态: ${diseaseName}</div>`;
    }
    return `<div class="status-bar">${statusHTML}</div>`;
}
function updateActiveTab(tabId) {
    gameState.flags.activeTab = tabId;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');

    const contentContainer = document.getElementById('tabContentContainer');
    let content = '';

    switch (tabId) {
        case 'main': content = renderMainTab(); break;
        case 'social': content = renderSocialTab(); break;
        case 'career': content = renderCareerTab(); break;
        case 'marriage': content = renderMarriageTab(); break;
        case 'children': content = renderChildrenTab(); break;
        case 'merchant': content = renderMerchantTab(); break;
        case 'log': content = renderLogTab(); break;
        case 'eventHub': // 点击按钮时，打开信息中心
            openEventHub(); 
            // 因为内容在悬浮窗里，所以主界面内容可以为空
            content = `<p class="comment" style="text-align:center; padding-top: 50px;">请在信息中心处理待办事项。</p>`; 
            break; 
    }
    contentContainer.innerHTML = `<div class="tab-content active">${content}</div>`;
}
function renderTabs() {
    const isMale = gameState.player.gender === 'male';
    const marriageTabName = isMale ? '府邸' : '内府';
    const canAccessMarriage = gameState.marriage.isMarried || (isMale && gameState.marriage.concubines.length > 0);
    const hasChildren = gameState.children.filter(c=>!c.isDead).length > 0;

    const tabs = [
        { id: 'main', name: '日常', icon: 'fa-home' },
        { id: 'social', name: '人际', icon: 'fa-users' },
        { id: 'career', name: '事业', icon: 'fa-briefcase' },
        { id: 'marriage', name: marriageTabName, icon: 'fa-heart', disabled: !canAccessMarriage },
        { id: 'children', name: '子嗣', icon: 'fa-baby-carriage', disabled: !hasChildren },
        { id: 'merchant', name: '商会', icon: 'fa-store-alt' }
    ];
    
    // 【核心修改】将记事和信息中心按钮与其他按钮分开处理
    const utilityTabs = [
        { id: 'log', name: '记事', icon: 'fa-book-open' },
        { id: 'eventHub', name: '信息中心', icon: 'fa-envelope-open-text' },
    ];

    const tabContainer = document.getElementById('tabContainer');
    
    // 生成主要标签页
    let mainTabsHTML = tabs.map(tab => `
        <div class="tab ${tab.disabled ? 'disabled' : ''}" data-tab="${tab.id}" onclick="${tab.disabled ? '' : `updateActiveTab('${tab.id}')`}">
            <i class="fas ${tab.icon}"></i> ${tab.name}
        </div>
    `).join('');
    
    // 生成工具类标签页（记事和信息中心）
    let utilityTabsHTML = utilityTabs.map(tab => `
        <div class="tab ${tab.disabled ? 'disabled' : ''}" data-tab="${tab.id}" onclick="${tab.disabled ? '' : `updateActiveTab('${tab.id}')`}">
            <i class="fas ${tab.icon}"></i> ${tab.name}
        </div>
    `).join('');

    // 【核心修改】使用新的HTML结构，将两组按钮分开，以便用CSS控制布局
    tabContainer.innerHTML = `
        <div class="main-tabs-group">${mainTabsHTML}</div>
        <div class="utility-tabs-group">${utilityTabsHTML}</div>
    `;
    
    // 动态添加样式以实现布局
    const mainGroup = tabContainer.querySelector('.main-tabs-group');
    const utilityGroup = tabContainer.querySelector('.utility-tabs-group');
    if(mainGroup) {
        mainGroup.style.display = 'flex';
        mainGroup.style.flexWrap = 'wrap'; // 允许换行
    }
    if(utilityGroup) {
        utilityGroup.style.display = 'flex';
        utilityGroup.style.flexDirection = 'column'; // 设置为垂直排列
        utilityGroup.style.marginLeft = 'auto'; // 将其推到最右边
        utilityGroup.style.paddingBottom = '4px'; // 调整对齐
    }
}
function updateActiveTab(tabId) {
    gameState.flags.activeTab = tabId;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');

    const contentContainer = document.getElementById('tabContentContainer');
    let content = '';

    switch (tabId) {
        case 'main': content = renderMainTab(); break;
        case 'social': content = renderSocialTab(); break;
        case 'career': content = renderCareerTab(); break;
        case 'marriage': content = renderMarriageTab(); break;
        case 'children': content = renderChildrenTab(); break;
        case 'merchant': content = renderMerchantTab(); break;
        case 'log': content = renderLogTab(); break;
case 'eventHub': openEventHub(); content = ``; break; 
    }
    contentContainer.innerHTML = `<div class="tab-content active">${content}</div>`;

}

function renderMainTab() {
    const isMale = gameState.player.gender === 'male';
    const studyDisabled = gameState.flags.actionUsed_study >= 2 ? 'disabled' : '';

    const mainActionLearning = isMale ?
    `<button class="option" onclick="performAction('martial')" ${studyDisabled}>
        <i class="fas fa-khanda"></i><span class="option-text">修习武艺 <div><small>+武学/健康</small></div></span>
    </button>` :
    `<button class="option" onclick="performAction('needlework')" ${studyDisabled}>
        <i class="fas fa-cut"></i><span class="option-text">练习女红 <div><small>+才情/品德</small></div></span>
    </button>`;
 
    return `
    <h3 class="card-header">${isMale ? '公子' : '闺阁'}日常</h3>
    <div class="section-header"><i class="fas fa-book-reader"></i>修身 (本回合剩余 ${2 - (gameState.flags.actionUsed_study || 0)} 次)</div>
    <div class="options">
        <button class="option" onclick="performAction('study')" ${studyDisabled}><i class="fas fa-book"></i><span class="option-text">研习诗书 <div><small>+智慧/才情</small></div></span></button>
        <button class="option" onclick="performAction('art')" ${studyDisabled}><i class="fas fa-palette"></i><span class="option-text">琴棋书画 <div><small>+才情/魅力</small></div></span></button>
        <button class="option" onclick="performAction('etiquette')" ${studyDisabled}><i class="fas fa-pray"></i><span class="option-text">学习礼法 <div><small>+礼仪/品德</small></div></span></button>
        ${mainActionLearning}
    </div>
 
    <div class="section-header"><i class="fas fa-shoe-prints"></i>外出</div>
    <div class="options">
        <button class="option" onclick="handleOuting('market')"><i class="fas fa-shopping-bag"></i> 逛市集</button>
        <button class="option" onclick="handleOuting('restaurant')"><i class="fas fa-utensils"></i> 去食肆</button>
        <button class="option" onclick="handleOuting('temple')"><i class="fas fa-gopuram"></i> 参拜寺庙</button>
        <button class="option" onclick="handleOuting('clinic')"><i class="fas fa-clinic-medical"></i> 前往医馆</button>
        ${isMale && gameState.player.age >= 16 ? `<button class="option" onclick="handleOuting('fengyuejian')"><i class="fas fa-fan"></i> 风月鉴</button>`: ''}
    </div>
 
    <div class="section-header"><i class="fas fa-home"></i>家族事务</div>
      <div class="options">
        <button class="option" onclick="showAssetsOverlay()"><i class="fas fa-landmark"></i> 查看资产</button>
        ${renderFamilyActions()}
      </div>
 
<div class="section-header"><i class="fas fa-hand-sparkles"></i> 巧手制作</div>
    <div class="options">
        <button class="option" onclick="showCraftingUI()">
            <i class="fas fa-cut"></i><span class="option-text">制作信物<div><small>使用职业材料制作特殊物品</small></div></span>
        </button>
</div>

     <div class="section-header"><i class="fas fa-user-graduate"></i> 师徒系统</div>
        <div class="options">
            <button class="option" onclick="showApprenticeSystem()">
                <i class="fas fa-graduation-cap"></i> 收徒系统
            </button>
        </div>
    `;
}

/**
 * 【新增函数】显示巧手制作界面
 */
function showCraftingUI() {
    let content = '<p class="comment">你可以利用职业相关的特殊材料，制作能够增进情谊的信物。</p>';
    content += '<div class="inventory-container">';

    Object.entries(TOKEN_DATA).forEach(([id, data]) => {
        const requiredItemId = data.req.item;
        const requiredItemDef = ITEM_DATA[requiredItemId];
        const canCraft = hasItemInInventory(requiredItemId); // 检查背包里是否有材料

        content += `
        <div class="inventory-item">
            <div class="inventory-item-icon"><i class="fas fa-gift"></i></div>
            <div class="inventory-item-details">
                <div class="inventory-item-name">${data.name}</div>
                <div class="inventory-item-desc">需要材料: <strong class="value">${requiredItemDef ? requiredItemDef.name : '未知材料'}</strong></div>
            </div>
            <button class="control-btn" style="padding: 8px 12px; font-size: 0.9rem;" ${!canCraft ? 'disabled' : ''} onclick="craftSpecialItem('${id}')">
                ${canCraft ? '制作' : '材料不足'}
            </button>
        </div>
        `;
    });

    content += '</div>';
    showDecisionCard('巧手制作', 'fa-hand-sparkles', content, []);
}

/**
 * 【新增函数】处理制作特殊物品的逻辑
 */
function craftSpecialItem(tokenId) {
    const data = TOKEN_DATA[tokenId];
    if (!data) return;

    const requiredItemId = data.req.item;
    // 1. 消耗材料
    if (!removeItemFromInventory(requiredItemId, 1)) {
        showToast("制作失败，材料不足！");
        return;
    }

    // 2. 计算心意值
    const qualityBonus = Math.floor((gameState.player.attributes[data.quality_attr] || 0) / 10);
    const finalSincerity = (data.stats.sincerity || 0) + qualityBonus;
    
    // 3. 将制作好的信物添加到主物品栏 (gameState.inventory)
    addItemToInventory(tokenId, 1, {
        name: data.name,
        desc: `一份你亲手制作的信物，蕴含着 ${finalSincerity} 点心意。`,
        type: '珍品',
        icon: 'fa-gift',
        sincerity: finalSincerity // 保存心意值，赠送时可以用
    });

    showEventCard('制作成功', 'fa-check', `你消耗了【${ITEM_DATA[requiredItemId].name}】，成功制作了<strong class="value">【${data.name}】</strong>，并放入了你的藏宝阁。`);
    
    // 刷新制作界面
    showCraftingUI();
}

function renderFamilyActions() {
    const isMale = gameState.player.gender === 'male';
    if (!gameState.marriage.isMarried && isMale && gameState.marriage.concubines.length === 0) {
        return `<p class="comment">你尚未成家，暂无家事可理。</p>`;
    }
    if (!gameState.marriage.isMarried && !isMale) {
        return `<p class="comment">待嫁闺中，暂无家事可理。</p>`;
    }

    let html = `<button class="option" onclick="manageFamilyChest()"><i class="fas fa-donate"></i> 管理家库</button>`;

    if(!isMale) {
        const spouse = gameState.npcs[gameState.marriage.spouseId];
        if (spouse) {
            html += `
            <button class="option" onclick="askForMoney()" ${gameState.flags.actionUsed_family ? 'disabled' : ''}>
                <i class="fas fa-hand-holding-usd"></i><span class="option-text">索要家用<div><small>增加家库资金，可能影响恩爱值</small></div></span>
            </button>`;
            if (spouse.concubines && spouse.concubines.length > 0) {
                 html += `<button class="option" onclick="handleSpouseConcubines()" ${gameState.flags.actionUsed_family ? 'disabled' : ''}><i class="fas fa-user-times"></i> 处理妾室</button>`;
            }
        }
    }
    return html;

}

function renderNpcCard(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return ''; // 如果NPC不存在，直接返回空字符串

    // 如果NPC已故，特殊处理
    if (npc.isDead) {
        // 判断是否为父母
        const isParent = npc.id === gameState.family.members.fatherId || npc.id === gameState.family.members.motherId;
        const clickAction = isParent ? `showMemorialInteraction('${npc.id}')` : `showToast('斯人已逝，无法互动。')`;
        
        return `
        <div class="suitor" style="opacity: 0.6; cursor: pointer;" onclick="${clickAction}">
            <div class="suitor-avatar-wrapper" style="background-color:#7f8c8d;">
                <div class="suitor-avatar-text" style="line-height:60px;">${npc.name.slice(0, 1)}</div>
            </div>
            <div class="suitor-details">
                <div class="suitor-name">[已故] ${npc.role || ''}: ${npc.name}</div>
                <div class="suitor-desc">享年 ${Math.floor(npc.age)} 岁</div>
            </div>
        </div>`;
    }

    // --- 以下为原有的、NPC存活时的渲染逻辑 ---
    const relationshipType = npc.relationship || 'stranger';
    const colorMap = {
        'suitor': '#e06c9e', 'friend': '#a7c957', 'sworn': '#f4a261', 'lover': '#c0392b',
        'family': npc.gender === 'male' ? '#6a9ac9' : '#e06c9e', 'spouse': '#d84381',
        'concubine': '#d84381', 'courtesan': '#9b59b6', 'supervisor': '#778899'
    };
    const avatarColor = npc.color || colorMap[relationshipType] || '#ccc';

    const avatarContent = npc.avatar
        ? `<img src="${npc.avatar}" class="suitor-avatar" alt="${npc.name} avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
           <div class="suitor-avatar-text" style="display:none; line-height:60px;">${npc.name.slice(0, 1)}</div>`
        : `<div class="suitor-avatar-text" style="line-height:60px;">${npc.name.slice(0, 1)}</div>`;

    return `
    <div class="suitor" onclick="showNPCDetails('${npc.id}')">
        <div class="suitor-avatar-wrapper" style="background-color:${avatarColor};">${avatarContent}</div>
        <div class="suitor-details">
            <div class="suitor-name">${npc.role ? `${npc.role}: ` : ''}${npc.name} (${Math.floor(npc.age)}岁)</div>
            <div class="suitor-desc">好感: ${npc.favor}</div>
        </div>
    </div>`;
}
function showMemorialInteraction(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc || !npc.isDead) return;

    const options = [
        {
            htmlContent: `<i class="fas fa-praying-hands"></i> 扫墓/祭拜`,
            callback: () => {
                let logText = `清明时节，你来到${npc.name}的墓前，焚香祭拜，追忆往昔。`;
                if (Math.random() < 0.5) {
                    const repGain = getRandomInt(2, 5);
                    applyEffects({ reputation: repGain });
                    logText += `\n你的孝行被乡邻看在眼里，交口称赞。声望+${repGain}。`;
                }
                showEventCard('追思故人', '🕯️', logText);
            }
        },
        {
            htmlContent: `<i class="fas fa-times"></i> 离开`,
            callback: () => closeAllOverlays()
        }
    ];

    showDecisionCard(`缅怀 ${npc.name}`, '🕯️', `看着冰冷的墓碑，往事历历在目...`, options);
}
// [用这个新版本替换]
function renderSocialTab() {
    // 按关系类型对所有NPC进行分组
    const relationships = gameState.social.relationships || {};
    const groupedNpcs = {
        family: Object.values(gameState.family.members).filter(id => id),
        spouse: [], // 修复点：初始化为空，让循环来填充
        concubine: gameState.player.gender === 'male' ? gameState.marriage.concubines : [],
        confidante: [], // 闺蜜
        brother: [], // 兄弟
        blue_confidante: [], // 蓝颜
        red_confidante: [], // 红颜
        lover: [], // 情人
        sworn_sibling: [], // 义结金兰分组
        former_apprentice: []
    };
    const processedIds = new Set(groupedNpcs.family); // 防止家人也被重复添加
    for (const npcId in relationships) {
        if (processedIds.has(npcId)) continue;
        const rel = relationships[npcId];
        if (rel.type && groupedNpcs.hasOwnProperty(rel.type)) {
            if (!groupedNpcs[rel.type].includes(npcId)) {
                groupedNpcs[rel.type].push(npcId);
                processedIds.add(npcId);
            }
        }
    }
    
    // Fallback: 如果配偶不在relationships里（理论上不应该），也确保能显示
    if (gameState.marriage.isMarried && gameState.marriage.spouseId && !processedIds.has(gameState.marriage.spouseId)) {
        groupedNpcs.spouse.push(gameState.marriage.spouseId);
    }
    
    // 生成每个分组的HTML
    const renderGroup = (title, icon, npcIdList) => {
        if (!Array.isArray(npcIdList) || npcIdList.length === 0) return '';
        // 【核心修复】在这里增加了一层过滤，确保 npc 对象真实存在
        const validNpcs = npcIdList.filter(id => gameState.npcs[id]); 
        if (validNpcs.length === 0) return '';
        
        let html = `<div class="section-header"><i class="fas ${icon}"></i> ${title}</div>`;
        html += validNpcs.map(id => renderNpcCard(id)).join('');
        return html;
    };
    
    let html = `
    <h3 class="card-header">人际关系</h3>
    <div class="options">
        <button class="option" onclick="strollForEncounters()"><i class="fas fa-walking"></i><span class="option-text">京城闲逛<div><small>主动结识新朋友</small></div></span></button>
        <button class="option" onclick="showMatchmaker()"><i class="fas fa-user-friends"></i><span class="option-text">拜访媒婆<div><small>通过媒人介绍对象</small></div></span></button>
        <button class="option" onclick="showRankings()"><i class="fas fa-trophy"></i><span class="option-text">查看${gameState.player.gender === 'male' ? '才俊榜' : '贵女榜'}</span></button>
    </div>
    <div style="max-height: 50vh; overflow-y: auto; padding: 5px;">
        ${renderGroup('家人', 'fa-users', groupedNpcs.family)}
        ${renderGroup('配偶', 'fa-heart', groupedNpcs.spouse)}
        ${renderGroup('妾室', 'fa-female', groupedNpcs.concubine)}
        ${renderGroup('义结金兰', 'fa-hands-helping', groupedNpcs.sworn_sibling)}
        ${renderGroup('闺中密友', 'fa-comments', groupedNpcs.confidante)}
        ${renderGroup('兄弟同袍', 'fa-fist-raised', groupedNpcs.brother)}
        ${renderGroup('蓝颜知己', 'fa-paint-brush', groupedNpcs.blue_confidante)}
        ${renderGroup('红颜知己', 'fa-wine-glass', groupedNpcs.red_confidante)}
        ${renderGroup('秘密情人', 'fa-mask', groupedNpcs.lover)}
        ${renderGroup('出师弟子', 'fa-user-graduate', groupedNpcs.former_apprentice)}
        ${renderApprenticesInSocialTab()}
    </div>`;
    
    const knownNpcIds = new Set(Object.keys(relationships).concat(groupedNpcs.family, groupedNpcs.spouse, groupedNpcs.concubine));
    const potentialFriends = gameState.suitors.filter(id => !knownNpcIds.has(id));
    if (potentialFriends.length > 0) {
        html += renderGroup('可结交对象', 'fa-user-plus', potentialFriends);
    }
    
    return html;
}

function performReputationWork() {
    if (gameState.flags.actionUsed_work >= 2) {
        showToast("你今天已经很累了。");
        return;
    }
    const cost = 200;
    if (gameState.finances.wealth < cost) {
        showToast(`经营声望需要花费${cost}两，你的资金不足。`);
        return;
    }

    gameState.flags.actionUsed_work++;
    const reputationGain = getRandomInt(5, 10);
    applyEffects({ wealth: -cost, reputation: reputationGain });
    showEventCard('经营声望', 'fa-bullhorn', `你花费 ${cost} 两，通过一系列运作（如结交名士、公开演说等），成功提升了 ${reputationGain} 点声望。`);
    renderGame();
}
function renderCareerTab() {
    const c = gameState.career;
    // 当没有选择职业时，显示选择界面
    if (!c.path) {
        const availableCareers = Object.entries(PROFESSION_DATA)
            .filter(([key, value]) => value.gender === gameState.player.gender)
            .map(([key, value]) => ({ id: key, ...value }));
        const canStartCareer = gameState.player.age >= 16;
        let optionsHTML = availableCareers.map(career => {
            return `
                <button class="option" ${!canStartCareer ? 'disabled' : ''} onclick="startCareer('${career.id}')">
                    <i class="fas ${career.icon}"></i>
                    <span class="option-text">
                        ${career.name}
                        ${!canStartCareer ? '<div><small>需年满16岁</small></div>' : ''}
                    </span>
                </button>
            `;
        }).join('');
        return `
            <h3 class="card-header">选择你的事业</h3>
            <p class="comment">一旦选定，将开启全新的人生篇章。</p>
            <div class="options">${optionsHTML}</div>
        `;
    }
    // 当已经选择职业时，显示职业面板
    const currentPathData = PROFESSION_DATA[c.path];
    const currentPathLevels = careerPaths[gameState.player.gender][c.path];
    if (!currentPathData || !currentPathLevels) {
        return `<p class="comment">职业数据加载错误。</p>`;
    }
    const currentLevel = currentPathLevels.levels[c.level];
    const nextLevel = c.level < currentPathLevels.levels.length - 1 ? currentPathLevels.levels[c.level + 1] : null;
    const supervisor = c.supervisorId ? gameState.npcs[c.supervisorId] : null;
    let supervisorHTML = '';
    if (supervisor) {
        supervisorHTML = `
            <div class="section-header"><i class="fas fa-user-tie"></i> 直属上司</div>
            ${renderNpcCard(c.supervisorId)}
            <div class="options" style="margin-top:10px; flex-direction:row; flex-wrap:wrap;justify-content:center;gap:10px;">
                <button class="control-btn" style="min-width: calc(50% - 10px); background:var(--option-bg);" onclick="interactWithSupervisor('chat')"><i class="fas fa-comments"></i> 汇报工作</button>
                <button class="control-btn" style="min-width: calc(50% - 10px); background:var(--option-bg);" onclick="interactWithSupervisor('gift')"><i class="fas fa-gift"></i> 赠送礼物</button>
            </div>`;
    }
    let promotionReqHTML = '';
    if (nextLevel) {
        const reqs = Object.entries(nextLevel.req).map(([attr, val]) => {
            const playerVal = gameState.player.attributes[attr] || gameState.family[attr] || 0;
            const attrName = ATTR_MAP[attr] || attr;
            return `<span style="color:${playerVal >= val ? 'green' : 'red'};">${attrName}≥${val}</span>`;
        }).join(', ');
        promotionReqHTML = `<p><strong>晋升要求:</strong> ${reqs}</p>`;
    } else {
        promotionReqHTML = `<p><strong>已是最高职位，名扬天下。</strong></p>`;
    }
    const promotionProgress = nextLevel ? Math.min(100, (c.performance / nextLevel.promotion_points) * 100) : 100;
    
    const unclaimedSalary = gameState.career.unclaimedSalary || 0;
    let salaryHTML = `
        <div class="section-header"><i class="fas fa-coins"></i> 俸禄</div>
        <div class="trading-info-box" style="margin-bottom: 10px;">
            <h4>待领取俸禄</h4>
            <div class="value">${formatNumber(unclaimedSalary)} 两</div>
        </div>
        <div class="options">
             <button class="option" ${unclaimedSalary <= 0 ? 'disabled' : ''} onclick="claimSalary()">
                <i class="fas fa-hand-holding-usd"></i> 领取俸禄
            </button>
        </div>
    `;
    return `
        <h3 class="card-header">${currentPathData.dashboard_name || '我的事业'}</h3>
        <p><strong>职业:</strong> ${currentPathData.name}</p>
        <p><strong>职位:</strong> ${currentLevel.title}</p>
        <p><strong>每半年俸禄:</strong> ${currentLevel.salary} 两</p>
        ${promotionReqHTML}
        <div class="attribute" style="margin-top:20px;">
            <div class="attribute-name"><span><i class="fas fa-chart-line"></i> 功绩</span><span>${c.performance} / ${nextLevel ? nextLevel.promotion_points : 'MAX'}</span></div>
            <div class="progress-bar"><div class="progress-fill charm-fill" style="width: ${promotionProgress}%;"></div></div>
        </div>
        
        <div class="section-header"><i class="fas fa-briefcase"></i> 日常公务 (剩余 ${2 - gameState.flags.actionUsed_work} 次)</div>
        <div class="options">
             <button class="option" onclick="triggerProfessionEvent()">
                <i class="fas fa-scroll"></i>
                <span class="option-text">处理公务<div><small>触发随机职业事件</small></div></span>
            </button>
            <button class="option" onclick="performReputationWork()">
                <i class="fas fa-bullhorn"></i>
                <span class="option-text">经营声望<div><small>消耗金钱与精力，提升声望</small></div></span>
            </button>
        </div>
        
        ${salaryHTML}
        ${supervisorHTML}
        <div class="section-header"><i class="fas fa-gem"></i> 藏宝阁</div>
        ${renderInventoryTab()}
    `;
}

// REPLACE the existing renderMarriageTab function

// =======================================================================
// ===================== 【替换】全新的府邸/内府标签页 =====================
// =======================================================================

function renderMarriageTab() {
    const isMale = gameState.player.gender === 'male';
    
    // 维系信任通用HTML
    const trustActionsHTML = `
        <div class="section-header"><i class="fas fa-shield-alt"></i> 维系信任 (剩余 ${2 - (gameState.flags.actionUsed_trustActions || 0)} 次)</div>
        <div class="options">
            <button class="option" ${ (gameState.flags.actionUsed_trustActions || 0) >= 2 ? 'disabled' : ''} onclick="triggerTrustEvent('gift')">
                <i class="fas fa-gift"></i><span class="option-text">赠送礼物<div><small>精心准备一份礼物，表达心意</small></div></span>
            </button>
            <button class="option" ${ (gameState.flags.actionUsed_trustActions || 0) >= 2 ? 'disabled' : ''} onclick="triggerTrustEvent('talk')">
                <i class="fas fa-comments"></i><span class="option-text">坦诚交谈<div><small>分享彼此的心事，增进了解</small></div></span>
            </button>
            <button class="option" ${ (gameState.flags.actionUsed_trustActions || 0) >= 2 ? 'disabled' : ''} onclick="triggerTrustEvent('accompany')">
                <i class="fas fa-walking"></i><span class="option-text">共度时光<div><small>陪伴是最长情的告白</small></div></span>
            </button>
        </div>
    `;

    // ==================== 女性玩家界面 ==========================
    if (!isMale) {
        const husband = gameState.npcs[gameState.marriage.spouseId];
        let husbandHTML = '';
        if (gameState.marriage.isMarried && husband && !husband.isDead) {
            let suspicionDesc = "风平浪静";
            if(husband.suspicionValue > 80) suspicionDesc = "信任崩塌";
            else if(husband.suspicionValue > 50) suspicionDesc = "暗流涌动";
            else if(husband.suspicionValue > 20) suspicionDesc = "偶有微词";

            husbandHTML = `
            <div class="section-header"><i class="fas fa-male"></i> 我的夫君</div>
            ${renderNpcCard(husband.id)}
            <div class="attribute" style="margin-top:15px;">
                ${renderAttributeBar('恩爱值', gameState.marriage.favor, 'charm-fill', 'fa-heart', 100)}
            </div>
            <div class="attribute">
                ${renderAttributeBar('疑心值', husband.suspicionValue || 0, 'martial-fill', 'fa-eye', 100)}
                <p class="comment" style="text-align:center;">当前阶段: ${suspicionDesc}</p>
            </div>
            `;

            husbandHTML += `
            <div class="options" style="margin-top:10px;">
                <button class="option" onclick="showHusbandInteractionUI()">
                    <i class="fas fa-user-friends"></i><span class="option-text">与夫君互动<div><small>经营感情，影响决策</small></div></span>
                </button>
                <button class="option" onclick="handleIntimateInteraction('${husband.id}')" style="background: linear-gradient(135deg, #ff9ebf, #d84381);">
                    <i class="fas fa-moon"></i><span class="option-text">鱼水之欢<div><small>提升情感，可能孕育子嗣</small></div></span>
                </button>
            </div>
            `;
        }
        
        // 掌家权管理部分
        let managementHTML = `<div class="section-header"><i class="fas fa-chess-queen"></i> 内宅管理</div>`;
        const authority = gameState.marriage.householdAuthority;
        managementHTML += `<div class="attribute">${renderAttributeBar('掌家权总览', authority.progress, 'virtue-fill', 'fa-key', 100)}</div>`;
        
        let authorityBreakdown = `
            <div class="attributes-grid" style="grid-template-columns: 1fr 1fr; margin: 10px 0;">
                <div class="status-item" style="flex-direction:column; align-items:center; text-align:center;"><i class="fas fa-users-cog"></i> 人事权: ${authority.personnel}%</div>
                <div class="status-item" style="flex-direction:column; align-items:center; text-align:center;"><i class="fas fa-file-invoice-dollar"></i> 财务权: ${authority.finance}%</div>
                <div class="status-item" style="flex-direction:column; align-items:center; text-align:center;"><i class="fas fa-shopping-basket"></i> 采办权: ${authority.procurement}%</div>
            </div>`;
        managementHTML += authorityBreakdown;
        
        if(authority.progress >= 100){
             managementHTML += `<div class="options">
                <button class="option" onclick="showAdvancedMatronUI()"><i class="fas fa-crown"></i> 当家主母决策</button>
             </div>`;
        } else {
            managementHTML += `<div class="options">
                <button class="option" onclick="showHouseholdAuthorityTasks()"><i class="fas fa-tasks"></i> 协理家务 (提升掌家权)</button>
            </div>`;
        }

        // 妾室列表
        let concubineHTML = '';
        const rivalConcubines = (husband && husband.concubines) ? husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead) : [];
        if (rivalConcubines.length > 0) {
             concubineHTML += `<div class="section-header"><i class="fas fa-users"></i> 夫君的妾室</div>`;
             concubineHTML += rivalConcubines.map(conc => renderNpcCard(conc.id)).join('');
             concubineHTML += `
                <div class="options" style="margin-top:15px;">
                    <button class="option" onclick="showConcubineManagementUI_Female()">
                        <i class="fas fa-users-cog"></i><span class="option-text">管理妾室<div><small>赏罚禁足，重塑后宅秩序</small></div></span>
                    </button>
                </div>`;
        }

        return `
        <h3 class="card-header">我的内府</h3>
        <div style="max-height: 70vh; overflow-y: auto; padding: 5px;">
            ${husbandHTML}
            ${trustActionsHTML}
            ${concubineHTML}
            ${managementHTML}
        </div>`;
    }
    
    // ==================== 男性玩家界面 ==========================
    else {
        const wife = gameState.npcs[gameState.marriage.spouseId];
        let wifeHTML = '';
        if (gameState.marriage.isMarried && wife && !wife.isDead) {
            let suspicionDesc = "风平浪静";
            if(wife.suspicionValue > 80) suspicionDesc = "信任崩塌";
            else if(wife.suspicionValue > 50) suspicionDesc = "暗流涌动";
            else if(wife.suspicionValue > 20) suspicionDesc = "偶有微词";

            wifeHTML = `
            <div class="section-header"><i class="fas fa-chess-queen"></i> 正妻</div>
            ${renderNpcCard(wife.id)}
            <div class="attribute" style="margin-top:15px;">
                ${renderAttributeBar('疑心值', wife.suspicionValue || 0, 'martial-fill', 'fa-eye', 100)}
                <p class="comment" style="text-align:center;">当前阶段: ${suspicionDesc}</p>
            </div>
            `;
        }

        let concubinesHTML = `<div class="section-header"><i class="fas fa-female"></i> 妾室</div>`;
        const aliveConcubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
        if (aliveConcubines.length > 0) {
            concubinesHTML += aliveConcubines.map(conc => renderNpcCard(conc.id)).join('');
        } else {
            concubinesHTML += `<p class="comment">后院尚无妾室。</p>`;
        }
        
        let authorityHolderName = "你";
        if(gameState.marriage.householdAuthorityHolder === 'wife' && wife) {
            authorityHolderName = wife.name;
        } else if (gameState.marriage.householdAuthorityHolder === 'mother') {
            const mother = gameState.npcs[gameState.family.members.motherId];
            if(mother) authorityHolderName = mother.name;
        }

        // 【核心修改】温存选项现在有了独立的计数器和显示
        const intimacyActionsLeft = 3 - (gameState.flags.intimacyActionsUsedThisTurn || 0);
        let intimateOptions = `
            <div class="section-header"><i class="fas fa-moon"></i> 温存 (本回合剩余 ${intimacyActionsLeft} 次)</div>
            <div class="options">
        `;
        if (wife && !wife.isDead) {
             intimateOptions += `<button class="option" ${intimacyActionsLeft <= 0 ? 'disabled' : ''} onclick="handleIntimateInteraction('${wife.id}')"><i class="fas fa-ring"></i> 与 ${wife.name} 温存</button>`;
        }
        aliveConcubines.forEach(conc => {
             intimateOptions += `<button class="option" ${intimacyActionsLeft <= 0 ? 'disabled' : ''} onclick="handleIntimateInteraction('${conc.id}')"><i class="fas fa-feather"></i> 与 ${conc.name} 温存</button>`;
        });
        intimateOptions += `</div>`;

        let managementOptions = `
            <div class="section-header"><i class="fas fa-gavel"></i> 家主决策</div>
            <div class="options">
                <button class="option" onclick="showHouseholdManagement_Male()">
                    <i class="fas fa-key"></i><span class="option-text">行使掌家权<div><small>处理人事、财务与采办</small></div></span>
                </button>
                <button class="option" onclick="showConcubineManagementUI()">
                    <i class="fas fa-users-cog"></i><span class="option-text">管理妾室<div><small>升降位份、赏罚禁足</small></div></span>
                </button>
                <button class="option" onclick="showMatchmaker(true)"><i class="fas fa-plus-circle"></i> 纳妾</button>
            </div>`;

        return `
        <h3 class="card-header">内帷管理</h3>
        <div style="max-height: 70vh; overflow-y: auto; padding: 5px;">
            <div class="attributes-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 15px;">
                <div class="status-item" style="padding: 10px 15px; border-radius: 12px; flex-direction: column; align-items: center; text-align: center;">
                    <div><i class="fas fa-key"></i> 掌事者</div><strong class="value" style="margin-top:5px;">${authorityHolderName}</strong>
                </div>
                <div class="status-item" style="padding: 10px 15px; border-radius: 12px; flex-direction: column; align-items: center; text-align: center;">
                    <div><i class="fas fa-users"></i> 内宅和谐</div><strong class="value" style="margin-top:5px;">${Math.floor(gameState.marriage.familyHarmony)}</strong>
                </div>
            </div>
            ${wifeHTML}
            ${concubinesHTML}
            ${intimateOptions}
            ${trustActionsHTML}
            ${managementOptions}
        </div>
        `;
    }
}
function showHouseholdManagement_Male() {
    const options = [
        {
            htmlContent: `<i class="fas fa-users-cog"></i><span class="option-text"><strong>人事权</strong><div><small>安插眼线、收买/调离下人</small></div></span>`,
            callback: () => showAuthorityActions_Male('personnel')
        },
        {
            htmlContent: `<i class="fas fa-file-invoice-dollar"></i><span class="option-text"><strong>财务权</strong><div><small>设立私库、混淆账目、增加月例</small></div></span>`,
            callback: () => showAuthorityActions_Male('finance')
        },
        {
            htmlContent: `<i class="fas fa-shopping-basket"></i><span class="option-text"><strong>采办权</strong><div><small>借故采办、投其所好</small></div></span>`,
            callback: () => showAuthorityActions_Male('procurement')
        }
    ];
    showDecisionCard('行使掌家权', 'fa-key', '作为一家之主，你可以通过手中的权力来管理内宅，维护稳定或掩盖秘密。', options);
}

/**
 * 【男性玩家】显示具体权力下的指令
 * @param {string} type - 'personnel', 'finance', 'procurement'
 */
// =======================================================================
// ===================== 【新增】当家主母高阶玩法核心函数 =====================
// =======================================================================

/**
 * 【主入口】显示当家主母决策界面
 */
function showAdvancedMatronUI() {
    const options = [
        {
            htmlContent: `<i class="fas fa-chart-line"></i><span class="option-text"><strong>家族影响力投资</strong><div><small>辅佐夫君、规划子嗣</small></div></span>`,
            callback: () => showFamilyInvestmentUI()
        },
        {
            htmlContent: `<i class="fas fa-theater-masks"></i><span class="option-text"><strong>后宅秩序重塑</strong><div><small>敲山震虎、恩威并施、釜底抽薪</small></div></span>`,
            callback: () => showHaremReshapingUI()
        },
        {
            htmlContent: `<i class="fas fa-user-secret"></i><span class="option-text"><strong>秘密网络深化</strong><div><small>暗度陈仓，资助情人</small></div></span>`,
            callback: () => showSecretNetworkUI()
        }
    ];
    showDecisionCard('当家主母决策', 'fa-crown', '你已是家族的核心决策者，玩法将从“生存”转向“经营与布局”。', options);
}
/**
 * 显示“家族影响力投资”界面
 */
function showFamilyInvestmentUI() {
    const options = [
        {
            htmlContent: `<i class="fas fa-user-tie"></i><span class="option-text"><strong>辅佐夫君</strong><div><small>为夫君的官场之路进行投资</small></div></span>`,
            callback: () => handleAssistHusband()
        },
        {
            htmlContent: `<i class="fas fa-users-cog"></i><span class="option-text"><strong>规划子嗣</strong><div><small>为已成年的子女铺路</small></div></span>`,
            callback: () => handlePlanOffspring()
        }
    ];
    showDecisionCard('家族影响力投资', 'fa-chart-line', '你不再仅仅是后宅的管理者，更是家族兴衰的操盘手。', options);
}
/**
 * 处理“辅佐夫君”的逻辑
 */
function handleAssistHusband() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband) return;

    const options = [
        {
            htmlContent: `<strong>打点上司</strong><div><small>花费2000-10000两，提升夫君功绩</small></div>`,
            callback: () => {
                const cost = getRandomInt(2000, 10000);
                if (gameState.family.moneyChest < cost) { showToast("家库资金不足！"); return; }
                gameState.family.moneyChest -= cost;
                if(husband.career) husband.career.performance = (husband.career.performance || 0) + 20;
                let log = `你花费 <span class="value">${cost}</span> 两家库资金为夫君的上司送去厚礼，夫君的功绩提升了。`;
                if ((husband.attributes.virtue || 50) > 80) {
                    applyEffects({marriage: {favor: -5}});
                    log += `但夫君品德高尚，对此举略有不满，恩爱值下降。`;
                }
                showEventCard('辅佐夫君', 'fa-user-tie', log);
            }
        },
        {
            htmlContent: `<strong>宴请同僚</strong><div><small>花费1000两，提升夫君声望</small></div>`,
            callback: () => {
                const cost = 1000;
                if (gameState.family.moneyChest < cost) { showToast("家库资金不足！"); return; }
                gameState.family.moneyChest -= cost;
                applyEffects({reputation: 15}); // 提升家族声望
                showEventCard('辅佐夫君', 'fa-user-tie', `你花费 <span class="value">${cost}</span> 两家库资金举办宴席，为夫君营造了良好的人际关系，家族声望提升。`);
            }
        },
        {
            htmlContent: `<strong>收集政敌黑料</strong><div><small>需要心计>90</small></div>`,
            disabled: (gameState.player.attributes.scheming || 0) < 90,
            callback: () => {
                 if (Math.random() < 0.2) {
                     showEventCard('调查失败', 'fa-user-secret', `你的心腹在调查时被对方反侦察，为夫君树立了强敌。`);
                 } else {
                     addItemToInventory('tan_fu_xian_suo', 1);
                     showEventCard('调查成功', 'fa-user-secret', `你的心腹成功获得了一份关于夫君政敌的<strong class="value">[贪腐线索]</strong>！`);
                 }
            }
        }
    ];
    showDecisionCard('辅佐夫君', 'fa-user-tie', `你查阅夫君的官场关系网，并选择性地进行投资。`, options);
}

/**
 * 处理“规划子嗣”的逻辑
 */
function handlePlanOffspring() {
    const adultChildren = gameState.children.filter(c => c.age >= 16 && !c.isDead);
    if (adultChildren.length === 0) {
        showToast("你暂无已成年的子女可规划。");
        return;
    }
    
    // 第一步：选择子女
    const childOptions = adultChildren.map(child => ({
        htmlContent: `<i class="fas fa-${child.gender}"></i> ${child.name} (${Math.floor(child.age)}岁)`,
        callback: () => showOffspringPlanningOptions(child.id)
    }));
    
    showDecisionCard('规划子嗣', 'fa-users-cog', '选择一位子女为其规划未来：', childOptions);
}

function showOffspringPlanningOptions(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    let options = [];

    if (child.gender === 'male') {
        options.push({
            htmlContent: `<strong>安排官职</strong><div><small>花费5000两，家族声望-20</small></div>`,
            disabled: gameState.family.moneyChest < 5000,
            callback: () => {
                applyEffects({reputation: -20});
                gameState.family.moneyChest -= 5000;
                // 简化处理，直接赋予职业
                child.career = { path: 'civilian', name: '文官', level: 0, performance: 0, salary: 200 };
                showEventCard('安排官职', 'fa-user-tie', `你为 ${child.name} 捐了一个官，他从此进入仕途，但起点较低且会被清流看不起。`);
            }
        });
    }

    options.push({
        htmlContent: `<strong>寻觅良缘</strong><div><small>举办赏花宴，进行战略联姻</small></div>`,
        callback: () => {
            // 直接调用已有的议亲界面
            openChildMarriageMenu(child.id);
        }
    });

    options.push({
        htmlContent: `<strong>投资产业</strong><div><small>花费3000两，为其购置产业</small></div>`,
        disabled: gameState.family.moneyChest < 3000,
        callback: () => {
            gameState.family.moneyChest -= 3000;
            // 简化处理，直接给孩子加钱
            child.personalWealth = (child.personalWealth || 0) + 5000;
            showEventCard('投资产业', 'fa-store', `你为 ${child.name} 购置了一间铺子，他/她从此有了独立的经济来源。`);
        }
    });

    showDecisionCard(`为 ${child.name} 规划`, 'fa-users-cog', '利用家族资源，为TA的未来铺路。', options);
}

function handleAssertDominance() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    
    // 选择惩罚对象
    const targetOptions = concubines.map(conc => ({
        htmlContent: conc.name,
        callback: () => {
            applyEffects({attributes: {prestige: 10}, marriage: {favor: -10}});
            concubines.forEach(c => {
                c.ambition = Math.max(0, (c.ambition || 30) - 5);
            });
            showEventCard('敲山震虎', 'fa-gavel', `你寻了个由头，公开惩罚了 ${conc.name}。所有妾室的野心暂时降低，你的家威提升，但夫君对你略有不满。`);
        }
    }));
    showDecisionCard('选择惩罚对象', 'fa-gavel', '选择一位妾室以儆效尤。', targetOptions);
}

function handleCarrotAndStick() {
    // 简化处理，暂时不做复杂的滑块UI
    showToast("功能开发中：调整妾室月例。");
}

function handleUndermine() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);

    const targetOptions = concubines.map(conc => ({
        htmlContent: conc.name,
        callback: () => {
            gameState.flags.investigatingConcubine = { targetId: conc.id, turnsLeft: 2 };
            showEventCard('开始调查', 'fa-search-minus', `你已派心腹暗中调查 ${conc.name} 的背景，预计2回合后会有结果。`);
        }
    }));
    showDecisionCard('选择调查对象', 'fa-search-minus', '选择一位妾室，深入调查她的背景，寻找她的弱点。', targetOptions);
}


/**
 * 显示“秘密网络深化”界面
 */
function showSecretNetworkUI() {
    const hasLover = gameState.social.secretLovers.length > 0;
    
    const options = [
        {
            htmlContent: `<i class="fas fa-box-open"></i><span class="option-text"><strong>暗度陈仓</strong><div><small>秘密将家库资金或物品转移给情人</small></div></span>`,
            disabled: !hasLover,
            callback: () => handleFunnelResources()
        }
    ];
    showDecisionCard('秘密网络深化', 'fa-user-secret', '掌家权将成为你们私情的最佳保护伞，甚至能助他平步青云。', options);
}

function handleFunnelResources() {
    const loverId = gameState.social.secretLovers[0]; // 简化为只处理第一个情人
    const lover = gameState.npcs[loverId];
    if (!lover) return;
    const husband = gameState.npcs[gameState.marriage.spouseId];

    const amountStr = prompt(`你打算从家库中挪用多少资金给 ${lover.name}？\n(当前家库: ${gameState.family.moneyChest} 两)`, "1000");
    const amount = parseInt(amountStr);
    
    if(isNaN(amount) || amount <= 0 || amount > gameState.family.moneyChest) {
        showToast("请输入有效金额且家库资金需足够。");
        return;
    }

    gameState.family.moneyChest -= amount;
    // 简化处理，直接给情人加钱
    lover.wealth = (lover.wealth || 0) + amount;

    let log = `你成功从家库中挪用 <span class="value">${amount}</span> 两，秘密转移给了 ${lover.name}。`;

    // 风险判定
    const discoveryChance = 0.1 + ((husband.suspicionValue || 0) / 1000);
    if ((husband.attributes.strategy || 50) > gameState.player.attributes.wisdom && Math.random() < discoveryChance) {
        log += `<br><strong style="color:red;">但此事被夫君察觉，直接触发了最终对峙！</strong>`;
        // 触发最终审判
        triggerInnerCourtEvent('一纸休书', true); // 第二个参数true表示强制触发
    }

    showEventCard('暗度陈仓', 'fa-box-open', log);
}

function showAuthorityActions_Male(type) {
    let title = '';
    let description = '';
    let options = [];
    const wife = gameState.npcs[gameState.marriage.spouseId];
    switch(type) {
        case 'personnel':
            title = '人事权指令';
            description = '控制信息流动，清除潜在威胁。';
            options = [
                { text: '安插眼线 (-200两)', cost: 200, action: () => { 
                    applyEffects({wealth: -200, attributes:{prestige: -2}}); 
                    // 此处可以添加一个buff，用于预警事件
                    return "你成功在府中安插了眼线，可以提前预警部分事件。";
                }},
                { text: '收买下人 (-100-500两)', cost: 100, action: () => { 
                    applyEffects({wealth: -getRandomInt(100,500), attributes:{virtue: -3}});
                    if(wife) wife.suspicionValue = Math.max(0, wife.suspicionValue - 5);
                    return "你成功收买了一位关键下人，暂时压下了一些对你不利的言论。";
                }},
                { text: '发卖/调离下人', cost: 0, action: () => {
                    applyEffects({attributes:{prestige: -5}});
                    if(wife && Math.random() < 0.2) wife.suspicionValue += 10;
                    return "你找了个由头将一个看不顺眼的下人调离了。频繁或无理由的调动可能引起怀疑。";
                }},
            ];
            break;
        case 'finance':
            title = '财务权指令';
            description = '掩盖花费，并为危机公关提供资金。';
            options = [
                { text: '设立私库', req: { wisdom: 80 }, action: () => {
                    const amount = Math.floor(gameState.family.moneyChest * 0.1);
                    gameState.family.moneyChest -= amount;
                    applyEffects({privateAssets: amount});
                    // FIX: Changed 'gs' to 'gameState'
                    gameState.flags.privateChestEstablished = true;
                    return `你从家库中挪用 ${amount} 两，建立了“小金库”，极大降低了风险。`;
                }},
                { text: '混淆账目', req: { strategy: 60 }, action: () => {
                    if(wife && (wife.attributes.wisdom || 60) > gameState.player.attributes.strategy && Math.random() < 0.3) {
                        gameState.flags.triggerLedgerScrutiny = true;
                        return "你的操作引起了妻子的怀疑，她可能会在年底彻查账目！";
                    }
                    return "你成功将一笔给情人的花销伪装成公账支出。";
                }},
                { text: '增加正妻月例', cost: 500, action: () => {
                    applyEffects({wealth: -500});
                    if(wife) { applyEffects({relationship: {targetId: wife.id, favor: 10}}); wife.suspicionValue -= 5; }
                    return "你增加了正妻的月钱，她十分高兴，对你的疑心也减少了。";
                }},
            ];
            break;
        case 'procurement':
            title = '采办权指令';
            description = '创造外出的合理借口，并通过采办安抚正妻。';
            options = [
                { text: '借故采办', action: () => {
                    // 增加一个buff，降低下次私会被发现的几率
                    gameState.flags.procurementExcuse = true;
                    return "你获得了一次合理的外出机会。在此期间与情人私会，被发现的几率降低50%。";
                }},
                { text: '投其所好 (-800两)', cost: 800, action: () => {
                    applyEffects({wealth: -800});
                    if(wife) { applyEffects({relationship: {targetId: wife.id, favor: 15}}); wife.suspicionValue -= 8; }
                    return "你借采办之名，购买了正妻心仪已久的物品，她惊喜不已。";
                }},
            ];
            break;
    }
    const decisionOptions = options.map(opt => ({
        htmlContent: `<span class="option-text">${opt.text}</span>`,
        disabled: (opt.cost && gameState.finances.wealth < opt.cost) || (opt.req && !checkSuccess(gameState.player.attributes[Object.keys(opt.req)[0]], Object.values(opt.req)[0])),
        callback: () => {
            const resultLog = opt.action();
            showEventCard(title, 'fa-key', resultLog);
        }
    }));
    showDecisionCard(title, 'fa-key', description, decisionOptions);
}
/**
 * 【男性玩家】显示管理妾室的界面
 */
function showConcubineManagementUI() {
    const concubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    if (concubines.length === 0) {
        showToast("你尚无妾室可管理。");
        return;
    }

    let html = concubines.map(conc => {
        return `
            <div class="concubine-card">
                <div class="concubine-name"><i class="fas fa-female"></i> ${conc.name} (${conc.rank || '侍妾'})</div>
                <div class="concubine-details">
                    <p>恩爱: ${conc.favor} | 野心: ${conc.ambition || 30} | 善妒: ${conc.jealousy || 30}</p>
                    <div class="options" style="flex-direction:row; flex-wrap:wrap; margin-top:10px;">
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction('${conc.id}', 'promote')">提升位份</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction('${conc.id}', 'demote')">降低位份</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction('${conc.id}', 'reward')">赏赐</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction('${conc.id}', 'punish')">罚俸</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction('${conc.id}', 'ground')">禁足</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    showDecisionCard('管理妾室', 'fa-users-cog', html, []);
}

/**
 * 【男性玩家】处理妾室管理指令
 */
function manageConcubineAction(concubineId, action) {
    const conc = gameState.npcs[concubineId];
    if(!conc) return;
    
    // 初始化妾室数据
    if (typeof conc.rankIndex === 'undefined') conc.rankIndex = 0;
    if (typeof conc.punishmentCount === 'undefined') conc.punishmentCount = 0;

    let resultLog = '';
    const currentRank = CONCUBINE_RANKS[conc.rankIndex];

    switch(action) {
        case 'promote':
            if (conc.rankIndex < CONCUBINE_RANKS.length - 1) {
                const nextRank = CONCUBINE_RANKS[conc.rankIndex + 1];
                const hasChild = gameState.children.some(c => c.motherId === conc.id);
                if (conc.favor >= currentRank.promotionFavorReq && (!currentRank.promotionChildReq || hasChild)) {
                    conc.rankIndex++;
                    conc.favor += nextRank.favorBonus; // 晋升增加好感
                    resultLog = `你将 ${conc.name} 的位份提升为 <strong class="value">${nextRank.name}</strong>，恩宠增加。`;
                } else {
                    let reason = '';
                    if (conc.favor < currentRank.promotionFavorReq) reason += `恩宠需达到${currentRank.promotionFavorReq} `;
                    if (currentRank.promotionChildReq && !hasChild) reason += `且需诞下子嗣`;
                    resultLog = `${conc.name} 的条件不足以晋升。(${reason.trim()})`;
                }
            } else {
                resultLog = `${conc.name} 已是最高位份。`;
            }
            break;
        case 'demote':
            if (conc.rankIndex > 0) {
                conc.rankIndex--;
                conc.punishmentCount++;
                applyEffects({ relationship: { targetId: conc.id, favor: -15 } });
                resultLog = `你将 ${conc.name} 的位份降低为 <strong class="value">${CONCUBINE_RANKS[conc.rankIndex].name}</strong>，她心怀怨怼。`;
            } else {
                resultLog = `${conc.name} 已是最低位份。`;
            }
            break;
        case 'reward':
            showRewardConcubineOverlay(conc.id);
            return; // 弹窗处理，不直接显示结果
        case 'punish': // 罚俸
            conc.isPunishedWithSalary = true;
            conc.punishmentCount++;
            applyEffects({relationship: {targetId: conc.id, favor: -10}});
            resultLog = `你罚没了 ${conc.name} 今年的份例，她对你好感下降。`;
            break;
        case 'ground': // 禁足
            conc.isGrounded = true;
            conc.groundedTurns = 2; // 禁足1年(2回合)
            conc.punishmentCount++;
            conc.ambition = Math.max(0, (conc.ambition || 30) - 10);
            resultLog = `你下令将 ${conc.name} 禁足一年，期间无法互动，她的野心有所收敛。`;
            break;
    }
    showEventCard('妾室管理', 'fa-users-cog', resultLog);
    showConcubineManagementUI();
}

// ===================== 【新增】所有新功能相关函数 =====================

// ------------------- 怀孕与温存逻辑 -------------------
function triggerBirth(partnerId, isSecret = false) {
    const partner = gameState.npcs[partnerId];
    if (!partner) return;

    // 【核心修改】检查全局怀孕标志
    if (gameState.flags.isAnyonePregnant) {
        logEvent('府中已有喜脉，未能有孕。');
        return;
    }

    logEvent(`<div class="intimate-scene"><i class="fas fa-moon"></i> 夜色深沉，红烛摇曳...</div>`);

    const totalCapacity = gameState.finances.assets.filter(c => c.type === 'residence').reduce((sum, r) => sum + r.capacity, 5);
    const currentOccupants = 1 + (gameState.marriage.isMarried ? 1 : 0) + gameState.marriage.concubines.length + gameState.children.filter(c=>!c.isDead).length;
    if (currentOccupants >= totalCapacity) { showToast("家中已无处可住，无法再添丁了。请先购置更大的府邸。"); return; }

    const motherNPC = gameState.player.gender === 'female' ? gameState.player : partner;
    const fatherNPC = gameState.player.gender === 'male' ? gameState.player : partner;

    const playerChildrenCount = gameState.children.filter(c => (c.motherId === 'player' || c.fatherId === 'player') && !c.isDead).length;

    if (playerChildrenCount >= 10) { showToast("你已育有十个孩子，难以再有孕。"); return; }
    if (gameState.player.gender === 'male' && partner.relationship === 'concubine' && gameState.children.filter(c => c.motherId === partnerId).length >= 3) { showToast(`妾室${partner.name}已诞下三胎，再难有孕。`); return; }
    if (motherNPC.isPregnant) {
        showToast(`${motherNPC.name}已身怀六甲，请耐心等待。`);
        return;
    }

    let baseConceptionChance = 0.35;
    if (motherNPC.age > 35) baseConceptionChance *= 0.5;
    if (motherNPC.age > 45) baseConceptionChance *= 0.3;
    if (motherNPC.age > 55) baseConceptionChance = 0.1;
    if (motherNPC.age >= 70) baseConceptionChance = 0;

    if (playerChildrenCount >= 7) baseConceptionChance *= 0.7;

    if (Math.random() < baseConceptionChance) {
        motherNPC.isPregnant = true;
        motherNPC.pregnancyTurnsLeft = 2; 
        motherNPC.isSecretPregnancy = isSecret;
        // 【核心修改】设置全局怀孕标志
        gameState.flags.isAnyonePregnant = true;
        logEvent(`<strong class="highlight-npc">${motherNPC.name}</strong>已身怀六甲，你对新生命的到来充满期待。`);
    } else {
        logEvent(`似乎天意未至，<strong class="highlight-npc">${motherNPC.name}</strong>本回合未能怀上。`);
    }
    renderGame();
}

function pregnancyCheck(motherId, isSecret) {
    const mother = motherId === 'player' ? gameState.player : gameState.npcs[motherId];
    if (mother && mother.isPregnant) {
        mother.pregnancyTurnsLeft--;
        if (mother.pregnancyTurnsLeft <= 0) {
            eventQueue.unshift(() => {
                handleBirthEvent(motherId, mother.isSecretPregnancy);
                // 【核心修改】分娩后重置全局标志
                gameState.flags.isAnyonePregnant = false;
            });
            delete mother.isPregnant;
            delete mother.pregnancyTurnsLeft;
            delete mother.miscarriageChance;
            delete mother.isSecretPregnancy;
            return true; 
        }
    }
    return false;
}

function handleIntimateInteraction(npcId) {
    // 【核心修改】使用新的全局计数器
    if ((gameState.flags.intimacyActionsUsedThisTurn || 0) >= 3) {
        showToast("你精力有限，本回合温存次数已用尽。");
        return;
    }
    gameState.flags.intimacyActionsUsedThisTurn = (gameState.flags.intimacyActionsUsedThisTurn || 0) + 1;

    const npc = gameState.npcs[npcId];
    if (!npc) return;

    // 【核心修改】检查禁足状态
    if (npc.isGrounded) {
        showToast(`${npc.name}正在禁足中，无法互动。`);
        // 把用掉的次数还回去
        gameState.flags.intimacyActionsUsedThisTurn--;
        return;
    }

    let text = "";
    let favorChange = 0;
    let healthChange = 0;
    let harmonyChange = 0;
    const personality = npc.personality && npc.personality.length > 0 ? npc.personality[0] : '温柔';
    const favor = npc.favor || 0;

    if (personality === '温顺' || personality === '温柔') {
        text = `夜色深沉，她为你端来一碗莲子羹，柔声道：“夫君辛苦了。”你心中一暖。`;
        favorChange = 3;
        healthChange = 2;
    } else if ((personality === '善妒' || personality === '活泼') && npc.jealousy > 50) {
        text = `你走进房中，她却冷着脸，言语间夹枪带棒，句句不离其他姐妹。`;
        favorChange = -2;
        harmonyChange = -1;
    } else if ((personality === '才情' || personality === '聪慧') && favor > 60) {
        text = `你们月下对弈，棋逢对手，相视一笑，只觉知己难觅。`;
        favorChange = 5;
        applyEffects({ attributes: { talent: 1 } });
    } else {
        text = `你们共度了一个平静的夜晚。`;
        favorChange = 2;
    }

    let resultText = `<div class="intimate-scene"><i class="fas fa-moon"></i> ${text}</div>`;
    applyEffects({ relationship: { targetId: npcId, favor: favorChange } });
    if (healthChange !== 0) applyEffects({ attributes: { health: healthChange } });
    gameState.marriage.familyHarmony = Math.max(0, Math.min(100, gameState.marriage.familyHarmony + harmonyChange));

    resultText += `</br>恩爱值 ${favorChange >= 0 ? '+' : ''}${favorChange}。`;
    if (healthChange > 0) resultText += `健康 +${healthChange}。`;
    if (harmonyChange !== 0) resultText += `家宅和谐度 ${harmonyChange}。`;

    triggerBirth(npcId, false);

    showEventCard('温存', 'fa-heart', resultText);
    renderGame();
}
/**
 * 【新增】为女性玩家处理妾室管理指令
 */
function manageConcubineAction_Female(concubineId, action) {
    const conc = gameState.npcs[concubineId];
    if(!conc) return;
    const authority = gameState.marriage.householdAuthority.progress || 0;
    let resultLog = '';
    
    // 检查权限
    if (authority < 30) {
        showToast("掌家权不足，你的指令无法生效。");
        return;
    }
    const ranks = ['侍妾', '良娣', '贵嫔'];
    let currentRankIndex = ranks.indexOf(conc.rank || '侍妾');
    switch(action) {
        case 'promote':
            if (authority < 80) { resultLog = `你的掌家权不足以册封位份 (需80点)。`; break; }
            if (currentRankIndex < ranks.length - 1) {
                conc.rank = ranks[currentRankIndex + 1];
                resultLog = `你将 ${conc.name} 的位份提升为 ${conc.rank}，以彰其德。`;
            } else {
                resultLog = `${conc.name} 已是最高位份。`;
            }
            break;
        case 'demote':
            if (authority < 90) { resultLog = `你的掌家权不足以褫夺位份 (需90点)。`; break; }
            if (currentRankIndex > 0) {
                conc.rank = ranks[currentRankIndex - 1];
                resultLog = `你将 ${conc.name} 的位份降低为 ${conc.rank}，以儆效尤。`;
            } else {
                resultLog = `${conc.name} 已是最低位份。`;
            }
            break;
        case 'reward':
            if (gameState.family.moneyChest < 100) { showToast("家库资金不足以赏赐。"); return; }
            gameState.family.moneyChest -= 100;
            applyEffects({relationship: {targetId: conc.id, favor: 5}});
            resultLog = `你从家库中支取100两赏赐了 ${conc.name}。`;
            break;
        case 'punish':
            if (authority < 50) { resultLog = `你的掌家权不足以罚俸，只是口头警告了 ${conc.name}。`; break; }
            applyEffects({relationship: {targetId: conc.id, favor: -8}});
            resultLog = `你下令罚没了 ${conc.name} 的月俸，她对你好感下降。`;
            break;
        case 'ground':
            if (authority < 70) { resultLog = `你的掌家权不足以禁足，${conc.name} 对你的命令阳奉阴违。`; break; }
            conc.ambition = Math.max(0, (conc.ambition || 30) - 8);
            resultLog = `你下令将 ${conc.name} 禁足一月，她的野心有所收敛。`;
            break;
    }
    showEventCard('妾室管理', 'fa-users-cog', resultLog);
    showConcubineManagementUI_Female(); // 刷新管理界面
}

/**
 * 【新增】为女性玩家显示管理妾室的界面
 */
function showConcubineManagementUI_Female() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband ? husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead) : [];
    if (concubines.length === 0) {
        showToast("夫君尚无妾室可管理。");
        return;
    }
    const authority = gameState.marriage.householdAuthority.progress || 0;
    
    let html = `<p class="comment" style="text-align:center;">你当前的掌家权为 <strong class="value">${authority}%</strong>，这决定了你指令的效力。</p>`;
    html += concubines.map(conc => {
        return `
            <div class="concubine-card">
                <div class="concubine-name"><i class="fas fa-female"></i> ${conc.name} (${conc.rank || '侍妾'})</div>
                <div class="concubine-details">
                    <p>恩宠: ${conc.favor} | 野心: ${conc.ambition || 30}</p>
                    <div class="options" style="flex-direction:row; flex-wrap:wrap; margin-top:10px;">
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'promote')">提升位份</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'demote')">降低位份</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'reward')">赏赐</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'punish')">罚俸</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'ground')">禁足</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    showDecisionCard('管理妾室', 'fa-users-cog', html, []);
}
// ------------------- 妾室管理与私逃逻辑 -------------------
function showRewardConcubineOverlay(concubineId) {
    const concubine = gameState.npcs[concubineId];
    if (!concubine) return;

    const ts = gameState.tradingSystem;
    const warehouse = ts.warehouse;
    if (warehouse.length === 0) {
        showToast("你的商会仓库中没有任何物品可以赏赐。");
        return;
    }

    // 随机挑选最多5件物品作为赏赐选项
    const shuffled = [...warehouse].sort(() => 0.5 - Math.random());
    const options = shuffled.slice(0, 5);

    let itemsHTML = options.map(item => {
        const itemDef = TRADING_GOODS_DATA[item.id];
        return `
            <div class="marketplace-item">
                <span><strong>${itemDef.name}</strong> <small>(${itemDef.type})</small></span>
                <button class="control-btn" style="padding: 8px 12px; font-size: 0.9rem;" 
                        onclick="confirmRewardConcubine('${concubineId}', '${item.instanceId}')">赏赐此物</button>
            </div>
        `;
    }).join('');

    const content = `
        <p>从你的商会仓库中选择一件物品赏赐给 <strong class="highlight-npc">${concubine.name}</strong>：</p>
        <div style="max-height: 50vh; overflow-y: auto;">${itemsHTML}</div>
    `;
    showDecisionCard(`赏赐 ${concubine.name}`, 'fa-gift', content, []);
}

function confirmRewardConcubine(concubineId, instanceIdStr) {
    const instanceId = parseInt(instanceIdStr);
    const concubine = gameState.npcs[concubineId];
    const itemIndex = gameState.tradingSystem.warehouse.findIndex(i => i.instanceId === instanceId);
    if (!concubine || itemIndex === -1) {
        showToast("操作失败，物品或人物不存在。");
        return;
    }

    const item = gameState.tradingSystem.warehouse[itemIndex];
    const itemDef = TRADING_GOODS_DATA[item.id];

    // 1. 从仓库移除物品
    gameState.tradingSystem.warehouse.splice(itemIndex, 1);

    // 2. 根据物品价值计算好感度
    const favorGain = Math.ceil(item.buyPrice / 15) + getRandomInt(3, 8);
    applyEffects({ relationship: { targetId: concubineId, favor: favorGain } });

    // 3. 显示结果
    showEventCard('赏赐成功', 'fa-gift', 
        `你将【${itemDef.name}】赏赐给了 ${concubine.name}，她喜不自胜，对你更加忠心。<br>好感度 +${favorGain}。`
    );

    // 刷新管理界面
    closeAllOverlays();
    showConcubineManagementUI();
}

function checkConcubineRunaway() {
    if (gameState.player.gender !== 'male' || gameState.marriage.concubines.length === 0) return;

    const concubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);

    for (const conc of concubines) {
        if (conc.isGrounded) {
            conc.groundedTurns--;
            if (conc.groundedTurns <= 0) {
                conc.isGrounded = false;
                logEvent(`妾室 ${conc.name} 的禁足已结束。`);
            }
        }

        // 计算私逃倾向
        let runawayChance = 0;
        if (conc.favor < 10) runawayChance += 0.1;
        if (conc.favor < -20) runawayChance += 0.15;
        if (conc.rankIndex === 0) runawayChance += 0.05; // 位份低
        if ((conc.punishmentCount || 0) > 5) runawayChance += 0.1 * (conc.punishmentCount - 5); // 惩罚次数越多，几率越大

        if (runawayChance > 0 && Math.random() < runawayChance) {
            // 触发私逃事件
            const stolenAmount = Math.floor(gameState.player.privateAssets * 0.1);
            applyEffects({ privateAssets: -stolenAmount });

            const childrenWithHer = gameState.children.filter(c => c.motherId === conc.id);
            const childrenNames = childrenWithHer.map(c => c.name).join('、');

            let eventText = `你发现妾室 <strong class="highlight-npc">${conc.name}</strong> 不堪受辱，已连夜逃离府邸，并卷走了你 <span class="value">${stolenAmount}</span> 两私产！`;
            if (childrenWithHer.length > 0) {
                eventText += ` 她还带走了自己的孩子 <strong class="highlight-npc">${childrenNames}</strong>。`;
            }

            // 从游戏中彻底移除
            gameState.marriage.concubines = gameState.marriage.concubines.filter(id => id !== conc.id);
            gameState.children = gameState.children.filter(c => c.motherId !== conc.id);
            delete gameState.npcs[conc.id];
            delete gameState.social.relationships[conc.id];

            // 使用事件队列显示，避免冲突
            eventQueue.push(() => {
                showEventCard('妾室私逃', 'fa-running', eventText);
            });
            
            // 一回合只处理一个私逃事件
            return;
        }
    }
}
/**
 * 【新增】为女性玩家显示管理妾室的界面
 */
function showConcubineManagementUI_Female() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband ? husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead) : [];

    if (concubines.length === 0) {
        showToast("夫君尚无妾室可管理。");
        return;
    }

    const authority = gameState.marriage.householdAuthority.progress || 0;
    
    let html = `<p class="comment" style="text-align:center;">你当前的掌家权为 <strong class="value">${authority}%</strong>，这决定了你指令的效力。</p>`;
    html += concubines.map(conc => {
        return `
            <div class="concubine-card">
                <div class="concubine-name"><i class="fas fa-female"></i> ${conc.name} (${conc.rank || '侍妾'})</div>
                <div class="concubine-details">
                    <p>恩宠: ${conc.favor} | 野心: ${conc.ambition || 30}</p>
                    <div class="options" style="flex-direction:row; flex-wrap:wrap; margin-top:10px;">
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'reward')">赏赐</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'punish')">罚俸</button>
                        <button class="control-btn" style="min-width:auto;" onclick="manageConcubineAction_Female('${conc.id}', 'ground')">禁足</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    showDecisionCard('管理妾室', 'fa-users-cog', html, []);
}

/**
 * 【新增】为女性玩家处理妾室管理指令
 */
function manageConcubineAction_Female(concubineId, action) {
    const conc = gameState.npcs[concubineId];
    if(!conc) return;

    const authority = gameState.marriage.householdAuthority.progress || 0;
    let resultLog = '';
    
    // 检查权限
    if (authority < 30) {
        showToast("掌家权不足，你的指令无法生效。");
        return;
    }

    switch(action) {
        case 'reward':
            if (gameState.family.moneyChest < 100) { showToast("家库资金不足以赏赐。"); return; }
            gameState.family.moneyChest -= 100;
            applyEffects({relationship: {targetId: conc.id, favor: 5}});
            resultLog = `你从家库中支取100两赏赐了 ${conc.name}。`;
            break;
        case 'punish':
            if (authority < 50) { resultLog = `你的掌家权不足以罚俸，只是口头警告了 ${conc.name}。`; break; }
            applyEffects({relationship: {targetId: conc.id, favor: -8}});
            resultLog = `你下令罚没了 ${conc.name} 的月俸，她对你好感下降。`;
            break;
        case 'ground':
            if (authority < 70) { resultLog = `你的掌家权不足以禁足，${conc.name} 对你的命令阳奉阴违。`; break; }
            conc.ambition = Math.max(0, (conc.ambition || 30) - 8);
            resultLog = `你下令将 ${conc.name} 禁足一月，她的野心有所收敛。`;
            break;
    }
    showEventCard('妾室管理', 'fa-users-cog', resultLog);
    showConcubineManagementUI_Female(); // 刷新管理界面
}
function handleHouseholdManagement(action) {
    const wife = gameState.npcs[gameState.marriage.spouseId];
    const authorityHolderId = gameState.marriage.householdAuthorityHolder;
    const manager = authorityHolderId === 'wife' ? wife : gameState.npcs[gameState.family.members.motherId];

    switch (action) {
        case 'check_ledger': {
            // 查阅账本
            const wisdomCheck = gameState.player.attributes.wisdom + gameState.player.attributes.strategy;
            let eventText = `你要求掌事者 <strong class="highlight-npc">${manager.name}</strong> 呈上账本。`;
            if (wisdomCheck > 100 && Math.random() < 0.3) {
                // 发现贪墨事件
                showDecisionCard('账目异常', 'fa-file-invoice-dollar',
                    '你发现账目上有一笔用于修缮花园的开支异常巨大，似乎远超实际所需。',
                    [
                        { htmlContent: '【不动声色，暗中调查】', callback: () => {
                            showEventCard('水落石出', 'fa-search', '你派心腹查明，是张管事与工匠勾结，中饱私囊。你掌握了证据，可以选择公开处置或私下敲打收为己用。');
                            gameState.marriage.servantLoyalty += 10;
                        }},
                        { htmlContent: '【直接质问掌事者】', callback: () => {
                            applyEffects({ relationship: { targetId: manager.id, favor: -10 } });
                            showEventCard('关系紧张', 'fa-angry', `你将账本摔在${manager.name}面前，她感到不被信任，你们的关系下降。`);
                        }},
                        { htmlContent: '【睁一只眼闭一只眼】', callback: () => {
                            applyEffects({ attributes: { virtue: -8 } });
                            gameState.marriage.householdEfficiency -= 5;
                            showEventCard('姑息养奸', 'fa-eye-slash', '你认为水至清则无鱼，但贪墨之风可能愈演愈烈。');
                        }}
                    ]
                );
            } else {
                eventText += ' 账目清晰，并无错漏。';
                showEventCard('查阅账本', 'fa-book-open', eventText);
            }
            break;
        }
        case 'inspect_servants': {
            // 考校下人
            const prestigeCheck = gameState.player.attributes.prestige;
            if (prestigeCheck > 60 && Math.random() < 0.35) {
                showDecisionCard('璞玉与奸细', 'fa-users-cog',
                    '在考校中，你发现一个洒扫小厮对答如流，颇有才智；同时，一个看似忠厚的老仆，眼神却总是躲闪。',
                    [
                        { htmlContent: '【提拔小厮，斥退老仆】', callback: () => {
                            showEventCard('慧眼识人', 'fa-user-plus', '你提拔了有才的小厮，并清除了可能是奸细的老仆，下人们对你的眼光更为敬畏。');
                            gameState.marriage.servantLoyalty += 5;
                        }},
                        { htmlContent: '【分别私下谈话】', req: { wisdom: 70 }, callback: () => {
                            showEventCard('洞察人心', 'fa-brain', '你通过话术套出了真相：小厮是家道中落的读书人，老仆则是因家人被政敌控制。你可以选择资助小厮或利用老仆传递假情报。');
                        }}
                    ]
                );
            } else {
                showEventCard('考校下人', 'fa-users-cog', '你对下人进行了一番考校，未发现异常，但你的家威让下人们更加敬畏。');
                applyEffects({ attributes: { prestige: 2 } });
            }
            break;
        }
        case 'convene_concubines': {
            // 召集妾室
            const concubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
            if (concubines.length === 0) {
                showToast("你尚无妾室可召集。");
                return;
            }
            showDecisionCard('召集妾室', 'fa-comments', '你将所有妾室召集到正厅，打算...',
                [
                    { htmlContent: '【训话】', req: { prestige: 60 }, callback: () => {
                        applyEffects({ attributes: { prestige: -5 } });
                        gameState.marriage.familyHarmony = Math.min(100, gameState.marriage.familyHarmony + 10);
                        showEventCard('家主之威', 'fa-gavel', '你的一番训话暂时压制了内宅的争斗，和谐度提升，但消耗了你的家威。');
                    }},
                    { htmlContent: '【赏赐】', callback: () => {
                        // 此处可以做一个更复杂的赏赐界面，暂时简化
                        applyEffects({ wealth: -500 });
                        concubines.forEach(c => applyEffects({ relationship: { targetId: c.id, favor: 5 } }));
                        showEventCard('雨露均沾', 'fa-gifts', '你花费500两平均赏赐了所有妾室，她们都很高兴。');
                    }},
                    { htmlContent: '【家宴】', callback: () => holdFamilyBanquet() }
                ]
            );
            break;
        }
        case 'chat_with_wife': {
            // 与妻闲聊
            if (!wife || wife.isDead) return;
            showDecisionCard('与妻闲聊', 'fa-coffee', `你来到正妻${wife.name}的院落，与她闲聊。你们聊些什么呢？`,
                [
                    { htmlContent: '【聊聊家事】', callback: () => {
                        applyEffects({ relationship: { targetId: wife.id, favor: 5 } });
                        showEventCard('家常闲话', 'fa-home', '她向你汇报了最近的家务琐事，你们的感情更加亲近了。恩爱值+5');
                    }},
                    { htmlContent: '【谈谈外界趣闻】', callback: () => {
                        applyEffects({ relationship: { targetId: wife.id, favor: 8 }, attributes: { talent: 1 } });
                        showEventCard('才情共鸣', 'fa-paint-brush', '你们从一首新诗聊到一幅古画，相谈甚欢。恩爱值+8，你的才情+1。');
                    }},
                    { htmlContent: '【说说你的事业】', callback: () => {
                        applyEffects({ relationship: { targetId: wife.id, favor: 12 } });
                        showEventCard('贤妻良言', 'fa-lightbulb', '分享你在事业上的得意或失意，她总能给出独特的建议。恩爱值大幅提升。');
                    }}
                ]
            );
            break;
        }
        case 'discuss_affairs': {
            // 商议家事
            if (!wife || wife.isDead || authorityHolderId !== wife.id) return;
            showDecisionCard('商议家事', 'fa-scroll', '你将正妻叫到书房，正式商议内宅的管理方针。',
                [
                    { htmlContent: '【指示：开源节流】', callback: () => {
                        // 简化逻辑，持家高则成功
                        if (wife.attributes.virtue > 70) {
                            showEventCard('持家有道', 'fa-coins', '在妻子的打理下，年底家库资产增加了10%。');
                            gameState.family.moneyChest = Math.floor(gameState.family.moneyChest * 1.1);
                        } else {
                            showEventCard('事与愿违', 'fa-frown', '妻子克扣过多导致下人忠诚下降，妾室公开抱怨。');
                            gameState.marriage.servantLoyalty -= 10;
                        }
                    }},
                    { htmlContent: '【授予“敲打妾室”之权】', callback: () => {
                        showEventCard('授予权力', 'fa-gavel', '这是一个双刃剑。能锻炼妻子的能力，但也可能让她与其他妾室关系彻底破裂。');
                        // 可以在此设置一个flag，影响后续内斗事件
                    }}
                ]
            );
            break;
        }
        case 'rectify_conduct': {
            // 整顿家风
            const cost = 1000;
            if (gameState.finances.wealth < cost || gameState.player.attributes.prestige < 80) {
                showToast("你的财富或家威不足以举行家庭会议。");
                return;
            }
            applyEffects({ wealth: -cost, attributes: { prestige: -10 } });
            gameState.marriage.familyHarmony = 60; // 强制提升到及格线
            showEventCard('雷霆手段', 'fa-bolt', `你花费巨资和家威举行了一次严肃的家庭会议，以雷霆手段整顿了家风，内宅暂时恢复平静。`);
            break;
        }
    }
    renderGame(); // 每次操作后刷新界面
}

// 【新增】检查并触发“权力交接”事件的函数
function checkForAuthorityTransfer_Male() {
    if (gameState.player.gender !== 'male' || gameState.marriage.householdAuthorityHolder !== 'mother_in_law') return;

    const wife = gameState.npcs[gameState.marriage.spouseId];
    if (!wife || wife.isDead) return;

    const hasHeir = gameState.children.some(c => c.motherId === wife.id && c.gender === 'male');
    const wifeSkill = (wife.attributes.virtue || 50) + (wife.attributes.wisdom || 50) + (wife.attributes.etiquette || 50);

    if (hasHeir || wifeSkill > 200) {
        const mother = gameState.npcs[gameState.family.members.motherId];
        eventQueue.push(() => {
            showDecisionCard('交接中馈', 'fa-key',
                `${mother.name}年事已高（或：见你嫡子已出/正妻贤惠），主动提出将掌家权交由正妻${wife.name}打理。`,
                [
                    { htmlContent: '【同意】', callback: () => {
                        gameState.marriage.householdAuthorityHolder = 'wife';
                        // 妻子的“持家”能力由其三项属性决定
                        gameState.marriage.managerSkill = Math.floor(wifeSkill / 3); 
                        showEventCard('权力交接', 'fa-key', `你同意了母亲的提议，从此府内中馈由正妻${wife.name}掌管。`);
                    }},
                    { htmlContent: '【挽留母亲】', callback: () => {
                        applyEffects({ relationship: { targetId: mother.id, favor: 10 } });
                        showEventCard('一片孝心', 'fa-heart', '你的挽留让母亲很感动，她决定再为你操劳几年。');
                    }}
                ]
            );
        });
    }
}
// [替换]
function triggerInnerCourtEvent() {
    // 如果未婚，则不触发
    if ((!gameState.marriage.isMarried && gameState.marriage.concubines.length === 0)) return;
    
    // 随机性，不是每回合都触发
    if (Math.random() > 0.4) return; // 每回合40%几率检定一次

    const struggles = INNER_COURT_STRUGGLES[gameState.player.gender];
    if (!struggles) return;
    
    // 获取配偶对象
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if(!spouse && gameState.player.gender === 'female') return; // 女性玩家必须有丈夫才能触发宅斗

    // 寻找所有可能触发的事件
    const possibleEvents = Object.values(struggles).filter(event => 
        event.trigger && event.trigger(gameState)
    );

    if (possibleEvents.length > 0) {
        // 随机选择一个触发
        const eventToTrigger = getRandomElement(possibleEvents);
        
        // [修复核心] 使用 .trigger() 而不是 .generate() 来获取事件实例
        const eventInstance = eventToTrigger.trigger(gameState);
        if (!eventInstance) return; // 如果trigger返回false，则不继续

        const options = eventToTrigger.options.map(opt => ({
            htmlContent: `<span class="option-text">${opt.text}</span>`,
            disabled: opt.req && (
                (opt.req.hasAuthority && gameState.marriage.householdAuthorityHolder !== 'player') ||
                !Object.entries(opt.req).every(([key, val]) => {
                    if (key === 'favor_gt') return spouse.favor > val;
                    // 兼容多种属性检查
                    return (gameState.player.attributes[key] || gameState.player[key] || 0) >= val;
                })
            ),
            callback: () => {
                // action现在应该只返回一个结果字符串
                const resultLog = opt.action(eventInstance.involved);
                // 如果不是最终审判事件，则显示普通结果
                if (!eventToTrigger.isFinal) { 
                    showEventCard(eventToTrigger.title, 'fa-theater-masks', resultLog);
                }
            }
        }));
        
        // 推入事件队列，防止弹窗冲突
        eventQueue.push(() => {
            showDecisionCard(eventToTrigger.title, 'fa-theater-masks', eventInstance.description, options);
        });
    }
}
// ==================== MALE PLAYER FUNCTIONS ====================
// "温存" (Flip Card) Interaction Logic
function handleIntimateInteraction(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return;
    let text = "";
    let favorChange = 0;
    let healthChange = 0;
    let harmonyChange = 0;
    const personality = npc.personality && npc.personality.length > 0 ? npc.personality[0] : '温柔';
    const favor = npc.favor || 0;
    if (personality === '温顺' || personality === '温柔') {
        text = `夜色深沉，她为你端来一碗莲子羹，柔声道：“夫君辛苦了。”你心中一暖。`;
        favorChange = 3;
        healthChange = 2;
    } else if ((personality === '善妒' || personality === '活泼') && npc.jealousy > 50) {
        text = `你走进房中，她却冷着脸，言语间夹枪带棒，句句不离其他姐妹。`;
        favorChange = -2;
        harmonyChange = -1;
    } else if ((personality === '才情' || personality === '聪慧') && favor > 60) {
        text = `你们月下对弈，棋逢对手，相视一笑，只觉知己难觅。`;
        favorChange = 5;
        applyEffects({ attributes: { talent: 1 } });
    } else {
        text = `你们共度了一个平静的夜晚。`;
        favorChange = 2;
    }
    let resultText = `<div class="intimate-scene"><i class="fas fa-moon"></i> ${text}</div>`;
    applyEffects({ relationship: { targetId: npcId, favor: favorChange } });
    if (healthChange !== 0) applyEffects({ attributes: { health: healthChange } });
    gameState.marriage.familyHarmony = Math.max(0, Math.min(100, gameState.marriage.familyHarmony + harmonyChange));
    resultText += `</br>恩爱值 ${favorChange >= 0 ? '+' : ''}${favorChange}。`;
    if (healthChange > 0) resultText += `健康 +${healthChange}。`;
    if (harmonyChange !== 0) resultText += `家宅和谐度 ${harmonyChange}。`;
    triggerBirth(npcId, false);
    showEventCard('温存', 'fa-heart', resultText);
    renderGame();
}
// ==================== FEMALE PLAYER FUNCTIONS ====================

// Show tasks to gain Household Authority
function showHouseholdAuthorityTasks() {
    const motherInLaw = gameState.npcs[gameState.family.members.motherId];
    if (!motherInLaw) {
        showToast("暂无家务可协理。");
        return;
    }

    const options = [
        {
            htmlContent: `<strong>协理采办</strong><div><small>考验你的精明与财力</small></div>`,
            callback: () => handleAuthorityTask('procurement')
        },
        {
            htmlContent: `<strong>协理人事</strong><div><small>考验你的心计与人脉</small></div>`,
            callback: () => handleAuthorityTask('personnel')
        },
        {
            htmlContent: `<strong>管理账目</strong><div><small>考验你的智慧</small></div>`,
            callback: () => handleAuthorityTask('finance')
        }
    ];

    showDecisionCard('协理家务', 'fa-tasks', `婆婆 <strong class="highlight-npc">${motherInLaw.name}</strong> 见你贤惠，打算交给你一些家务让你历练一番。`, options);
}

function handleAuthorityTask(taskType) {
    const eventPool = HOUSEHOLD_TASKS_EVENTS[taskType];
    if (!eventPool || eventPool.length === 0) {
        showToast("暂无相关家务可处理。");
        return;
    }

    const event = getRandomElement(eventPool);

    const options = event.options.map(opt => ({
        htmlContent: `<span class="option-text">${opt.text}</span>`,
        callback: () => {
            const authority = gameState.marriage.householdAuthority;
            const motherInLaw = gameState.npcs[gameState.family.members.motherId];

            // 应用效果
            const effect = opt.effects;
            if (effect.procurement) authority.procurement += effect.procurement;
            if (effect.personnel) authority.personnel += effect.personnel;
            if (effect.finance) authority.finance += effect.finance;

            // 应用对玩家属性的影响
            applyEffects({ attributes: { wisdom: effect.wisdom || 0, charm: effect.charm || 0, virtue: effect.virtue || 0, scheming: effect.scheming || 0 }});

            // 应用对婆婆好感的影响
            if(motherInLaw) {
                applyEffects({ relationship: { targetId: motherInLaw.id, favor: effect.favor_mil || 0 } });
            }

            // 更新总进度
            authority.progress = Math.floor((authority.personnel + authority.finance + authority.procurement + authority.access) / 4);

            showEventCard(event.title, 'fa-tasks', opt.result);
            renderGame();
        }
    }));

    showDecisionCard(event.title, 'fa-tasks', event.desc, options);
}
/**
 * 【新增函数】为玩家本人显示议亲候选人列表
 */
function showPlayerArrangedMarriage() {
    closeAllOverlays(); // 先关闭媒婆窗口
    const gender = gameState.player.gender;
    const partnerGender = gender === 'male' ? 'female' : 'male';
    let partnersHTML = `<h4>媒婆为你寻来了三位家世清白的候选人:</h4>`;
    let potentialPartners = [];

    for(let i=0; i < 3; i++) {
        const bg = getRandomElement(childSpousePools[partnerGender]);
        potentialPartners.push({
            name: generateRandomName(partnerGender, gameState.flags.allNames),
            desc: bg.desc,
            attributes: { ...bg.attributes, family: bg.family },
            isArranged: true,
            hiddenTrait: bg.hidden_trait,
            avatar: getRandomElement(avatarPools[partnerGender]),
            source: 'matchmaker' // 关键标记：指明此人由媒婆介绍
        });
    }

    partnersHTML += potentialPartners.map(p => renderPlayerCandidateCard(p)).join('');

    // 使用 arrangedMarriageOverlay 弹窗来显示
    document.getElementById('arrangedMarriageContent').innerHTML = `<div style="max-height: 70vh; overflow-y:auto; padding:5px;">${partnersHTML}</div>`;
    showOverlay('arrangedMarriageOverlay');
}

/**
 * 【新增函数】渲染玩家本人的议亲对象卡片
 */
function renderPlayerCandidateCard(partner) {
    const partnerScore = Object.values(partner.attributes).reduce((a, b) => a + b, 0);
    const playerScore = Object.values(gameState.player.attributes).reduce((a, b) => a + b, 0);
    const compatibility = Math.min(100, Math.max(10, 50 + (playerScore - partnerScore) / 5));
    const partnerInfoString = JSON.stringify(partner).replace(/'/g, "&apos;");

    return `<div class="suitor" style="cursor:pointer;" data-partner='${partnerInfoString}' onclick='proposeToPlayerPartner(this)'>
        <div class="suitor-avatar-wrapper">
            <img src="${partner.avatar}" class="suitor-avatar">
        </div>
        <div class="suitor-details">
            <div class="suitor-name">${partner.name} <small>(匹配度: ${Math.floor(compatibility)}%)</small></div>
            <div class="suitor-desc">${partner.desc}</div>
            <div class="suitor-stats">
                <span class="stat"><i class="fas fa-home"></i> 家世: ${partner.attributes.family}</span>
                <span class="stat"><i class="fas fa-grin-stars"></i> 魅力: ${partner.attributes.charm}</span>
                <span class="stat"><i class="fas fa-pencil-alt"></i> 才情: ${partner.attributes.talent}</span>
            </div>
            <button class="control-btn" style="padding: 5px 10px; font-size: 0.8em; margin-top: 8px; width: 120px;" 
                onclick="event.stopPropagation(); investigatePlayerCandidate(this.parentElement.parentElement)">
                <i class="fas fa-search"></i> 暗中调查
            </button>
        </div>
    </div>`;
}

/**
 * 【新增函数】处理对玩家本人的议亲对象的提亲逻辑
 */
function proposeToPlayerPartner(cardElement) {
    const partnerInfo = JSON.parse(cardElement.dataset.partner);
    // 生成一个临时的NPC对象用于结婚流程
    const newNpc = generateNPC({
        name: partnerInfo.name,
        gender: partnerInfo.gender,
        age: getRandomInt(gameState.player.age, gameState.player.age + 5),
        favor: 50,
        source: partnerInfo.source, // 继承 'matchmaker' 标记
        attributes: partnerInfo.attributes,
        relationship: 'suitor',
        avatar: partnerInfo.avatar
    });

    if (confirm(`你确定要向 ${newNpc.name} 提亲吗？`)) {
        marrySuitor(newNpc.id);
    }
}

/**
 * 【新增函数】处理对玩家本人的议亲对象的调查逻辑
 */
function investigatePlayerCandidate(cardElement) {
    const cost = 200;
    if(gameState.finances.wealth < cost) { 
        showToast("调查需要200两，当前私产不足"); 
        return;
    }
    const partnerData = JSON.parse(cardElement.dataset.partner);
    const button = cardElement.querySelector('.control-btn');
    button.disabled = true;
    button.classList.add('button-loading');

    setTimeout(() => {
        applyEffects({ wealth: -cost });
        const event = getRandomElement(INVESTIGATION_EVENTS);
        const desc = event.desc.replace(/【对象姓名】/g, `<strong class="highlight-npc">${partnerData.name}</strong>`);
        const finalDesc = `${desc}<br><br><strong>调查结果：</strong>${event.effect_text || '情况如上，请您定夺。'}`;

        const options = [
            {
                htmlContent: `<i class="fas fa-check"></i> 同意此门亲事`,
                callback: () => proposeToPlayerPartner(cardElement)
            },
            {
                htmlContent: `<i class="fas fa-times"></i> 拒绝此门亲事`,
                callback: () => {
                    showToast(`你决定不考虑 ${partnerData.name} 了。`);
                    closeAllOverlays();
                }
            }
        ];

        // 如果调查出的事件本身有选项（例如发现对方已有心上人），则优先显示事件选项
        if (event.options) {
            const eventOptions = event.options.map(opt => ({
                htmlContent: opt.text,
                callback: () => {
                    showEventCard(event.title, 'fa-user-secret', `${desc}<br><br><strong>你的决定：</strong>${opt.log}`);
                }
            }));
            showDecisionCard(event.title, 'fa-user-secret', desc, eventOptions);
        } else {
            // 否则显示通用的议亲决策
            showDecisionCard(event.title, 'fa-user-secret', finalDesc, options);
        }
        button.classList.remove('button-loading');
        button.innerHTML = '<i class="fas fa-check"></i> 已调查';
    }, 1000);
}
// Check for automatic authority transfer (e.g., birth of heir)
function checkAuthorityTransfer() {
    const player = gameState.player;
    if (player.gender !== 'female') return;
    
    const hasHeir = gameState.children.some(c => c.motherId === 'player' && c.gender === 'male');
    const motherInLaw = gameState.npcs[gameState.family.members.motherId];

    if (hasHeir && gameState.marriage.householdAuthority.progress < 100) {
        // Trigger event
        const options = [
             {
                htmlContent: `<strong>欣然接受</strong>`,
                callback: () => {
                    gameState.marriage.householdAuthority.progress = 100;
                    gameState.marriage.householdAuthorityHolder = 'player';
                    showEventCard('大权在握', 'fa-key', '你正式接管了府中所有掌家权，成为了真正的女主人！');
                }
            },
            {
                htmlContent: `<strong>谦虚推辞</strong>`,
                callback: () => {
                    gameState.marriage.householdAuthority.progress = Math.min(100, gameState.marriage.householdAuthority.progress + 50);
                    applyEffects({relationship: {targetId: motherInLaw.id, favor: 20}});
                    showEventCard('谦逊之德', 'fa-praying-hands', '你的谦逊让婆婆非常满意，她将大部分权力交给了你，但仍保留了核心人事权。');
                }
            }
        ];
        eventQueue.push(() => {
            showDecisionCard('权力交接', 'fa-key', '你成功诞下嫡子，婆婆喜不自胜，主动提出要将掌家权交给你。', options);
        });
    }
}


// =======================================================================
// ===================== 【新功能】宅斗系统函数 END ========================
// =======================================================================

// [用这个新版本替换]
function renderChildrenTab() {
    const aliveChildren = gameState.children.filter(c => !c.isDead);
    if (aliveChildren.length === 0) {
        return `<h3 class="card-header">子嗣</h3><p class="comment" style="text-align:center;">暂无子嗣。</p>`;
    }
    const childrenHTML = aliveChildren.map(child => {
        if (!child.attributes) return '';
        const mother = gameState.npcs[child.motherId] || (child.motherId === 'player' ? gameState.player : { name: '未知' });
        let fatherText = '';
        const legalFather = gameState.npcs[child.fatherId];
        const biologicalFather = gameState.npcs[child.biologicalFatherId];
        if (biologicalFather && biologicalFather.id !== (legalFather ? legalFather.id : null)) {
            fatherText = `<p><strong>生父:</strong> <span class="highlight-secret">${biologicalFather.name}</span></p>`;
        }
        let status = '';
        if (child.isSecret) {
            status = '<span class="highlight-secret">[私]</span>';
        } else if (mother.id === gameState.marriage.spouseId || mother.id === 'player') {
            status = ' <span style="color:var(--highlight-strong);">[嫡]</span>';
        } else {
            status = ' <span style="color:var(--text-comment);">[庶]</span>';
        }
        const childDisplayName = child.name || '未命名';
        const nameInitial = child.name ? child.name.slice(child.name.length - 1) : '？';
        
        let careerDisplay = '未成年';
        if (child.career) {
            if (child.career.path === 'unemployed') {
                careerDisplay = '待业';
            } else {
                const careerData = careerPaths[child.gender][child.career.path];
                if (careerData) {
                    const levelTitle = careerData.levels[child.career.level].title;
                    careerDisplay = `${child.career.name} - ${levelTitle}`;
                } else {
                    careerDisplay = child.career.name;
                }
            }
        }
        const avatarContent = `<div class="avatar-wrapper" style="width: 60px; height: 60px; flex-shrink: 0; border-width: 2px;">
            ${child.avatar ? `<img src="${child.avatar}" class="avatar-image" style="display:block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <svg class="avatar-svg" viewBox="0 0 100 100" style="display:none;">` :
            `<svg class="avatar-svg" viewBox="0 0 100 100" style="display:block;">`}
            <circle cx="50" cy="50" r="48" fill="${child.gender === 'male' ? '#add8e6' : '#ffc0cb'}" />
            <text x="50" y="65" font-family="'Ma Shan Zheng', cursive" font-size="50" fill="white" text-anchor="middle">${nameInitial}</text>
            </svg>
            </div>`;
        let marriageInfo = '';
        if (child.marriage.isMarried && child.marriage.spouseInfo) {
            const spouse = child.marriage.spouseInfo;
            marriageInfo = `<p><strong>配偶:</strong> ${spouse.name} (${spouse.desc.split('，')[0]})</p>`;
        }
        return `
        <div class="child-card">
            ${avatarContent}
            <div class="child-details">
                <div class="child-name"><i class="fas fa-${child.gender === 'male' ? 'male' : 'female'}"></i> ${childDisplayName} (${Math.floor(child.age)}岁)${status}</div>
                <p><strong>生母:</strong> ${mother.name}</p>
                ${fatherText}
                <p><strong>亲密度:</strong> ${child.favor || 50}</p>
                <p><strong>性格:</strong> ${(child.personality || []).join(', ') || '尚未显现'}</p>
                <p><strong>职业:</strong> ${careerDisplay}</p>
                ${marriageInfo}
            </div>
             <div class="child-btn-group">
                <button class="child-cultivate-btn" onclick="showChildRearing('${child.id}')">互动/培养</button>
                <button class="child-cultivate-btn" style="background:#555;" onclick="showRenameChildOverlay('${child.id}')">改名</button>
                ${child.age >= 16 && !child.marriage.isMarried ? `<button class="child-cultivate-btn" style="background:linear-gradient(135deg, #a7c957, #6a9ac9);" onclick="openChildMarriageMenu('${child.id}')">议亲</button>` : ''}
            </div>
        </div>
        `;
    }).join('');
    return `<h3 class="card-header">子嗣</h3><div class="children-container" style="max-height: 400px; overflow-y: auto; padding: 5px;">${childrenHTML}</div>`;
}
function renameChild(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // 弹窗提示输入新名字
    const oldName = child.name;
    const newNameGiven = prompt(`请为${oldName}输入新名字 (不含姓氏，1-4个字)`, oldName.slice(1));
    
    if (newNameGiven === null) return; // 用户取消

    let newName = newNameGiven.trim();

    if (newName.length === 0 || newName.length > 4) {
        showToast("请输入1-4个字的名字。");
        return;
    }
    
    const father = gameState.npcs[child.fatherId];
    if (!father) {
        showToast("无法获取父亲信息。");
        return;
    }
    const finalName = father.name.slice(0, 1) + newName;

    if (gameState.flags.allNames.has(finalName)) {
        showToast("这个名字已经有人用啦，换一个吧。");
        return;
    }

    // 移除旧名字，添加新名字
    if (child.name) {
        gameState.flags.allNames.delete(child.name);
    }
    child.name = finalName;
    gameState.flags.allNames.add(finalName);
    
    showEventCard('改名成功', 'fa-pen-fancy', `你将 <strong class="value">${oldName}</strong> 的名字改为了 <strong class="value">${finalName}</strong>。`);
    renderGame();
}
// [替换] 找到这个函数并用下面的代码完整替换
function showRenameChildOverlay(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // [修复] 增加了安全检查，防止 child.name 为 undefined 时调用 .slice() 出错
    const oldGivenName = child.name ? child.name.slice(1) : '未命名';

    document.getElementById('renameChildOldName').textContent = child.name || '这个孩子';
    document.getElementById('renameChildInput').value = oldGivenName === '未命名' ? '' : oldGivenName;

    const confirmBtn = document.getElementById('confirmRenameBtn');
    confirmBtn.onclick = () => {
        confirmNewName(childId);
    };

    showOverlay('renameChildOverlay');
}
// 新增函数：确认新名字的逻辑
function confirmNewName(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const newNameInput = document.getElementById('renameChildInput');
    const newGivenName = newNameInput.value.trim();

    if (newGivenName.length === 0 || newGivenName.length > 3) {
        showToast("请输入1-3个字的新名。");
        return;
    }

    const surname = child.name.slice(0, 1);
    const finalName = surname + newGivenName;

    if (gameState.flags.allNames.has(finalName) && finalName !== child.name) {
        showToast("这个名字已经有人用啦，换一个吧。");
        return;
    }
    
    // 从全局名字池中移除旧名字
    gameState.flags.allNames.delete(child.name);

    // 更新孩子的名字和全局名字池
    const oldName = child.name;
    child.name = finalName;
    gameState.flags.allNames.add(finalName);
    
    showEventCard('改名成功', 'fa-pen-fancy', `你将 <strong class="value">${oldName}</strong> 的名字改为了 <strong class="value">${finalName}</strong>。`);
    
    // 关闭所有弹窗并刷新界面
    closeAllOverlays();
    renderGame();
}
// 这是修复后的代码
function renderMerchantTab() {
    return `
    <h3 class="card-header">商会管理</h3>
    <p class="comment">运筹帷幄，方能富甲一方。</p>
    <div class="options">
        <button class="option" onclick="openTradingMainUI()">
            <i class="fas fa-handshake"></i><span class="option-text">进入商会交易<div><small>低买高卖，积累财富</small></div></span>
        </button>
        <button class="option" onclick="handleMerchantAction('invest')">
            <i class="fas fa-store"></i><span class="option-text">产业投资<div><small>购置商铺，获取稳定收益</small></div></span>
        </button>
        <button class="option" onclick="handleMerchantAction('farm')">
            <i class="fas fa-map-marked-alt"></i><span class="option-text">农事经营<div><small>购买土地，种植作物</small></div></span>
        </button>
        
        <button class="option" onclick="handleMerchantAction('explore')">
            <i class="fas fa-ship"></i><span class="option-text">远洋探索<div><small>探索未知海域，寻求巨额回报</small></div></span>
        </button>
        </div>
    <div class="section-header"><i class="fas fa-book"></i> 产业日志</div>
    <div class="event-log">${gameState.finances.merchantLog.length > 0 ? gameState.finances.merchantLog.map(e =>`<div class="event">${e}</div>` ).join('') : '<p class="comment">暂无记录。</p>'}</div>
    `;
}// 放置在您的商会交易系统函数区域
// 【替换】找到这个函数并用下面的代码完整替换
function openTradingMainUI() {
    if (!gameState.tradingSystem.isTradingPeriod) {
        showToast("现在是休市期间，无法交易。");
        return;
    }
    const ts = gameState.tradingSystem;
    const card = document.getElementById('tradingOverlayCard');
    
    // [核心修复] 采用与商会内部一致的实时计算逻辑
    let fluctuationsHTML = ts.marketStatus.fluctuations.length > 0
        ? ts.marketStatus.fluctuations.map(f => {
            const goodDef = TRADING_GOODS_DATA[f.id];
            const currentPrice = ts.marketStatus.prices[f.id];
            // 使用平均基础价进行计算，确保数据源统一
            const basePrice = goodDef.basePrice; 
            
            // 计算实际涨跌幅
            const change = (currentPrice - basePrice) / basePrice;
            const changePercent = (change * 100).toFixed(0);
            
            const trendClass = change > 0 ? 'text-gain' : 'text-loss';
            const icon = change > 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
            return `<li><i class="${icon} ${trendClass}"></i> ${f.name} <span class="${trendClass}">${changePercent}%</span> <small>(${f.reason})</small></li>`;
        }).join('')
        : '<li>市场平稳，暂无重大消息。</li>';

    const guilds = [
        { id: 'east', name: '东市商会' }, { id: 'west', name: '西市商会' },
        { id: 'south', name: '南洋商会' }, { id: 'north', name: '塞北商会' }
    ];
    card.innerHTML = `
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="overlay-header">   京城商会   </div>
        <div class="overlay-content-wrapper" style="padding: 0 5px;">
            <p style="text-align:center;">当前周期: <strong>${gameState.date.year}年 ${gameState.date.turn === 1 ? '上半年' : '下半年'}</strong></p>
            <div class="trading-main-grid">
                <div class="trading-info-box">
                    <h4><i class="fas fa-cash-register"></i> 钱柜资金</h4>
                    <div class="value">${formatNumber(ts.moneyChest)} 两</div>
                </div>
                <div class="trading-info-box">
                    <h4><i class="fas fa-boxes"></i> 仓库容量</h4>
                    <div class="value">${ts.warehouse.length} / ${ts.warehouseCapacity}</div>
                </div>
                <div class="trading-info-box market-fluctuation-card">
                    <h4><i class="fas fa-bullhorn"></i> 市场波动信息</h4>
                    <ul>${fluctuationsHTML}</ul>
                </div>
                ${guilds.map(guild => `
                    <div class="guild-button" onclick="openGuildTradeUI('${guild.id}')">
                        ${guild.name}
                        <div class="guild-favor-bar">
                            <div class="guild-favor-fill" style="width:${ts.guildFavor[guild.id]}%"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="trading-controls">
                <button class="control-btn" onclick="showWarehouseUI()"><i class="fas fa-warehouse"></i> 仓库管理/升级</button>
                <button class="control-btn" onclick="showTradeLogUI()"><i class="fas fa-history"></i> 交易记录</button>
                <button class="control-btn" onclick="showMoneyChestUI()"><i class="fas fa-exchange-alt"></i> 钱柜存取</button>
            </div>
        </div>
    `;
    showOverlay('tradingOverlay');
}

// 放置在您的商会交易系统函数区域
function openGuildTradeUI(guildId) {
    const ts = gameState.tradingSystem;
    const card = document.getElementById('tradingOverlayCard');
    const guildName = {east:'东市商会', west:'西市商会', south:'南洋商会', north:'塞北商会'}[guildId];

    let goodsHTML = Object.entries(TRADING_GOODS_DATA)
        .filter(([id, data]) => data.guild === guildId)
        .map(([id, data]) => {
            const currentPrice = ts.marketStatus.prices[id];
            const change = (currentPrice - data.basePrice) / data.basePrice;
            const changePercent = (change * 100).toFixed(0);
            const trendClass = change > 0 ? 'text-gain' : (change < 0 ? 'text-loss' : '');
            const icon = change > 0 ? '▲' : (change < 0 ? '▼' : '');
            
            return `
            <div class="marketplace-item">
                <span>
                    <strong>${data.name}</strong> (${data.type})<br>
                    <small>当前价格: <span class="${trendClass}">${currentPrice} 两</span> ${icon}${changePercent}%</small>
                </span>
                <div>
                    <button class="control-btn" style="padding: 8px 12px; font-size: 0.9rem;" onclick="showBuySellModal('${id}', 'buy')">买入</button>
                    <button class="control-btn" style="padding: 8px 12px; font-size: 0.9rem; background: var(--control-bg);" onclick="showBuySellModal('${id}', 'sell')">卖出</button>
                </div>
            </div>`;
        }).join('');

    card.innerHTML = `
        <button class="overlay-close-btn" onclick="openTradingMainUI()">‹ 返回</button>
        <div class="overlay-header">   ${guildName}   </div>
        <div class="overlay-content-wrapper">
             <div class="attribute" style="margin-top:10px;">
                ${renderAttributeBar('亲密度', ts.guildFavor[guildId], 'charm-fill', 'fa-heart', 100)}
             </div>
            ${goodsHTML}
        </div>
    `;
}// 放置在您的商会交易系统函数区域
function showBuySellModal(goodId, type) {
    const good = TRADING_GOODS_DATA[goodId];
    const ts = gameState.tradingSystem;
    const currentPrice = ts.marketStatus.prices[goodId];
    let contentHTML = '';

    if (type === 'buy') {
        const maxCanBuyByMoney = Math.floor(ts.moneyChest / currentPrice);
        const maxCanBuyBySpace = ts.warehouseCapacity - ts.warehouse.length;
        const maxCanBuy = Math.min(maxCanBuyByMoney, maxCanBuyBySpace);

        contentHTML = `
            <p>当前价格: <span class="value">${currentPrice}</span> 两</p>
            <p>钱柜余额: ${ts.moneyChest} 两 | 仓库剩余: ${maxCanBuyBySpace} 格</p>
            <p class="comment">最多可买: ${maxCanBuy} 件</p>
            <div class="quantity-slider-container">
                <input type="range" id="tradeQuantitySlider" value="1" min="1" max="${maxCanBuy}" oninput="this.nextElementSibling.value = this.value">
                <input type="number" id="tradeQuantityInput" value="1" min="1" max="${maxCanBuy}" oninput="this.previousElementSibling.value = this.value">
            </div>
        `;
        const options = [{
            htmlContent: '确认购买',
            disabled: maxCanBuy <= 0,
            callback: () => {
                const quantity = parseInt(document.getElementById('tradeQuantityInput').value);
                if (isNaN(quantity) || quantity <= 0 || quantity > maxCanBuy) {
                    showToast("请输入有效的购买数量。"); return;
                }
                processTrade(goodId, 'buy', quantity, currentPrice);
            }
        }];
        showDecisionCard(`购买 ${good.name}`, 'fa-shopping-cart', contentHTML, options);

    } else { // sell
        const itemsToSell = ts.warehouse.filter(item => item.id === goodId);
        const totalQuantity = itemsToSell.length;
        if (totalQuantity === 0) {
            showToast(`你的仓库里没有 ${good.name}。`); return;
        }

        const totalValue = totalQuantity * currentPrice;

        contentHTML = `
            <p>当前售价: <span class="value">${currentPrice}</span> 两</p>
            <p>你共持有: ${totalQuantity} 件 (总价值: ${totalValue} 两)</p>
            <div class="quantity-slider-container">
                <input type="range" id="tradeQuantitySlider" value="1" min="1" max="${totalQuantity}" oninput="this.nextElementSibling.value = this.value">
                <input type="number" id="tradeQuantityInput" value="1" min="1" max="${totalQuantity}" oninput="this.previousElementSibling.value = this.value">
            </div>
        `;
        const options = [{
            htmlContent: '确认出售',
            callback: () => {
                const quantity = parseInt(document.getElementById('tradeQuantityInput').value);
                if (isNaN(quantity) || quantity <= 0 || quantity > totalQuantity) {
                    showToast("请输入有效的出售数量。"); return;
                }
                processTrade(goodId, 'sell', quantity, currentPrice);
            }
        }];
        showDecisionCard(`出售 ${good.name}`, 'fa-tag', contentHTML, options);
    }
}
// 核心交易处理函数
function processTrade(goodId, type, quantity, price, instanceId = null) {
    const ts = gameState.tradingSystem;
    const good = TRADING_GOODS_DATA[goodId];
    let finalPrice = price; 

    if (type === 'buy') {
        const totalCost = finalPrice * quantity;
        ts.moneyChest -= totalCost;
        for (let i = 0; i < quantity; i++) {
            ts.warehouse.push({
                instanceId: Date.now() + i,
                id: goodId,
                buyPrice: finalPrice,
                boughtAt: { ...gameState.date }
            });
        }
        ts.tradeLog.unshift(`买入 ${quantity} 件 ${good.name}，花费 ${totalCost} 两。`);
        showToast(`成功购买 ${quantity} 件 ${good.name}。`);
    } else { // sell
        let totalProfit = 0;
        let itemsToRemove = [];
        // 找到所有该物品的实例
        const allMatchingItems = ts.warehouse.filter(item => item.id === goodId);
        // 默认按先进先出（FIFO）卖出，也就是移除数组前面的元素
        itemsToRemove = allMatchingItems.slice(0, quantity);

        itemsToRemove.forEach(item => {
            totalProfit += (finalPrice - item.buyPrice);
        });

        // 从仓库中移除这些物品
        itemsToRemove.forEach(itemToRemove => {
            const index = ts.warehouse.findIndex(item => item.instanceId === itemToRemove.instanceId);
            if (index > -1) {
                ts.warehouse.splice(index, 1);
            }
        });

        const totalIncome = finalPrice * quantity;
        ts.moneyChest += totalIncome;

        const profitText = totalProfit > 0 ? `盈利 ${totalProfit}` : (totalProfit < 0 ? `亏损 ${-totalProfit}` : `不赚不亏`);
        ts.tradeLog.unshift(`卖出 ${quantity} 件 ${good.name}，获得 ${totalIncome} 两，${profitText}。`);
        showToast(`成功卖出 ${quantity} 件 ${good.name}。`);
    }

    const guildId = good.guild;
    const favorGain = Math.ceil((finalPrice * quantity) / 200);
    ts.guildFavor[guildId] = Math.min(100, (ts.guildFavor[guildId] || 0) + favorGain);

    closeAllOverlays();
    openGuildTradeUI(guildId); // 刷新当前商会界面
}
function showWarehouseUI() {
    const ts = gameState.tradingSystem;
    const currentLevelIndex = WAREHOUSE_LEVELS.findIndex(l => l.capacity === ts.warehouseCapacity);
    const currentLevel = WAREHOUSE_LEVELS[currentLevelIndex] || WAREHOUSE_LEVELS[0];
    const nextLevel = WAREHOUSE_LEVELS[currentLevelIndex + 1];
    
    const groupedItems = ts.warehouse.reduce((acc, item) => {
        if (!acc[item.id]) {
            acc[item.id] = { items: [], total: 0, totalCost: 0 };
        }
        acc[item.id].items.push(item);
        acc[item.id].total++;
        acc[item.id].totalCost += item.buyPrice;
        return acc;
    }, {});

    let itemsHTML = Object.keys(groupedItems).length > 0
        ? Object.entries(groupedItems).map(([goodId, data]) => {
            const good = TRADING_GOODS_DATA[goodId];
            const avgCost = (data.totalCost / data.total).toFixed(2);
            // 【新增】获取当前市价
            const currentPrice = ts.marketStatus.prices[goodId] || good.basePrice;
            const potentialProfit = (currentPrice - avgCost) * data.total;
            const profitClass = potentialProfit > 0 ? 'text-gain' : (potentialProfit < 0 ? 'text-loss' : '');

            return `
            <div class="event" style="margin-bottom: 10px; padding: 12px;">
                <div class="inventory-item-name" style="font-size: 1.1em; display:flex; justify-content:space-between; align-items:center;">
                    ${good.name} <span style="font-weight:normal;">(共 ${data.total} 件)</span>
                    
                </div>
                <div class="inventory-item-desc">
                    平均成本: ${avgCost} 两 | <strong>当前市价: ${currentPrice} 两</strong>
                    <br>
                    <span class="${profitClass}">预计总利润: ${potentialProfit.toFixed(0)} 两</span>
                </div>
                <button class="control-btn" style="padding: 8px 12px; font-size: 0.9rem; margin-top: 10px; background: var(--control-shadow-hover);" 
                        onclick="showSellFromWarehouseModal('${goodId}')">
                     <i class="fas fa-tag"></i> 卖出
                </button>
            </div>`;
        }).join('')
        : '<p class="comment" style="text-align:center; padding: 20px 0;">你的仓库空空如也。</p>';

    let upgradeHTML = '';
    if (nextLevel) {
        upgradeHTML = `
            <div class="section-header" style="margin-top:20px;"><i class="fas fa-arrow-up"></i> 仓库升级</div>
            <div class="event">
                <p>下一等级: <strong>${nextLevel.name}</strong></p>
                <p>容量提升至: <span class="value">${nextLevel.capacity}</span></p>
                <p>升级费用: <span class="value">${nextLevel.upgradeCost}</span> 两</p>
                <button class="option" style="width:100%; margin-top:10px;" 
                    ${gameState.finances.wealth < nextLevel.upgradeCost ? 'disabled' : ''}
                    onclick="upgradeWarehouse(${currentLevelIndex + 1})">
                    <i class="fas fa-hammer"></i> 支付升级
                </button>
            </div>
        `;
    } else {
        upgradeHTML = `<p class="comment" style="text-align:center; margin-top:20px;">仓库已是最高等级。</p>`;
    }

    const content = `
        <p style="text-align:center;">当前等级: <strong>${currentLevel.name}</strong> | 容量: ${ts.warehouse.length} / ${ts.warehouseCapacity}</p>
        <div class="overlay-content-wrapper" style="margin-top: 15px; max-height: 40vh;">${itemsHTML}</div>
        ${upgradeHTML}
    `;
    
    showDecisionCard('仓库管理', 'fa-warehouse', content, []);
}// ===================== 【新增】showSellFromWarehouseModal 函数 START =====================
function showSellFromWarehouseModal(goodId) {
    const good = TRADING_GOODS_DATA[goodId];
    const ts = gameState.tradingSystem;
    const currentPrice = ts.marketStatus.prices[goodId];
    
    const itemsToSell = ts.warehouse.filter(item => item.id === goodId);
    const totalQuantity = itemsToSell.length;
    if (totalQuantity === 0) {
        showToast(`你的仓库里没有 ${good.name}。`); return;
    }

    const totalValue = totalQuantity * currentPrice;

    const contentHTML = `
        <p>当前售价: <span class="value">${currentPrice}</span> 两</p>
        <p>你共持有: ${totalQuantity} 件 (总价值: ${totalValue} 两)</p>
        <div class="quantity-slider-container">
            <input type="range" id="tradeQuantitySlider" value="${totalQuantity}" min="1" max="${totalQuantity}" oninput="this.nextElementSibling.value = this.value">
            <input type="number" id="tradeQuantityInput" value="${totalQuantity}" min="1" max="${totalQuantity}" oninput="this.previousElementSibling.value = this.value">
        </div>
    `;
    const options = [{
        htmlContent: '确认出售',
        callback: () => {
            const quantity = parseInt(document.getElementById('tradeQuantityInput').value);
            if (isNaN(quantity) || quantity <= 0 || quantity > totalQuantity) {
                showToast("请输入有效的出售数量。");
                return;
            }
            processTradeFromWarehouse(goodId, 'sell', quantity, currentPrice);
        }
    }];
    showDecisionCard(`出售 ${good.name}`, 'fa-tag', contentHTML, options);
}
// ===================== 【新增】showSellFromWarehouseModal 函数 END =====================
// ===================== 【新增】processTradeFromWarehouse 函数 START =====================
function processTradeFromWarehouse(goodId, type, quantity, price) {
    const ts = gameState.tradingSystem;
    const good = TRADING_GOODS_DATA[goodId];
    
    let totalProfit = 0;
    // 找到所有该物品的实例
    const allMatchingItems = ts.warehouse.filter(item => item.id === goodId);
    // 按先进先出（FIFO）卖出
    const itemsToRemove = allMatchingItems.slice(0, quantity);

    itemsToRemove.forEach(item => {
        totalProfit += (price - item.buyPrice);
    });

    // 从仓库中移除这些物品
    itemsToRemove.forEach(itemToRemove => {
        const index = ts.warehouse.findIndex(item => item.instanceId === itemToRemove.instanceId);
        if (index > -1) {
            ts.warehouse.splice(index, 1);
        }
    });

    const totalIncome = price * quantity;
    ts.moneyChest += totalIncome;

    const profitText = totalProfit > 0 ? `盈利 ${totalProfit}` : (totalProfit < 0 ? `亏损 ${-totalProfit}` : `不赚不亏`);
    ts.tradeLog.unshift(`卖出 ${quantity} 件 ${good.name}，获得 ${totalIncome} 两，${profitText}。`);
    showToast(`成功卖出 ${quantity} 件 ${good.name}。`);

    closeAllOverlays();
    // 刷新仓库界面
    showWarehouseUI();
}
// ===================== 【新增】processTradeFromWarehouse 函数 END =====================
function upgradeWarehouse(levelIndex) {
    const ts = gameState.tradingSystem;
    const levelData = WAREHOUSE_LEVELS[levelIndex];
    if (!levelData) return;
    if (gameState.finances.wealth < levelData.upgradeCost) {
        showToast("升级资金不足！");
        return;
    }
    applyEffects({ wealth: -levelData.upgradeCost });
    ts.warehouseCapacity = levelData.capacity;
    showEventCard('仓库升级成功', 'fa-hammer', `你花费 ${levelData.upgradeCost} 两，将仓库升级为【${levelData.name}】，容量扩大至 ${levelData.capacity}！`);
    // 升级后刷新仓库管理界面
    showWarehouseUI();
}
function showTradeLogUI() {
    const ts = gameState.tradingSystem;
    const card = document.getElementById('tradingOverlayCard');

    let logHTML = ts.tradeLog.length > 0
        ? ts.tradeLog.map(log => `<div class="event-content" style="padding: 5px 0; border-bottom: 1px dashed var(--border-color-light);">${log}</div>`).join('')
        : '<p class="comment">暂无交易记录。</p>';

    card.innerHTML = `
        <button class="overlay-close-btn" onclick="openTradingMainUI()">‹ 返回</button>
        <div class="overlay-header">   交易记录   </div>
        <div class="overlay-content-wrapper event-log">${logHTML}</div>
    `;
}

function showMoneyChestUI() {
    const ts = gameState.tradingSystem;
    const card = document.getElementById('tradingOverlayCard');

    card.innerHTML = `
        <button class="overlay-close-btn" onclick="openTradingMainUI()">‹ 返回</button>
        <div class="overlay-header">   钱柜存取   </div>
        <div class="overlay-content-wrapper">
            <div class="trading-main-grid">
                <div class="trading-info-box"><h4><i class="fas fa-wallet"></i> 私产</h4><div class="value">${formatNumber(gameState.finances.wealth)}</div></div>
                <div class="trading-info-box"><h4><i class="fas fa-cash-register"></i> 钱柜</h4><div class="value">${formatNumber(ts.moneyChest)}</div></div>
            </div>
            <p class="comment" style="text-align:center;">资金互转需缴纳1%的手续费。</p>
            <div class="input-group" style="margin: 15px 0;">
                <input type="number" id="transferAmountInput" placeholder="输入转移金额" style="width: 100%;">
            </div>
            <div class="controls">
                <button class="control-btn" onclick="transferMoney('toChest')">存入钱柜 →</button>
                <button class="control-btn" onclick="transferMoney('fromChest')">← 取出私产</button>
            </div>
        </div>
    `;
}

function transferMoney(direction) {
    const amount = parseInt(document.getElementById('transferAmountInput').value);
    if (isNaN(amount) || amount <= 0) {
        showToast("请输入有效的金额。");
        return;
    }

    const fee = Math.ceil(amount * 0.01);
    const ts = gameState.tradingSystem;

    if (direction === 'toChest') {
        if (gameState.finances.wealth < amount + fee) {
            showToast("私产不足以支付金额和手续费。");
            return;
        }
        gameState.finances.wealth -= (amount + fee);
        ts.moneyChest += amount;
        showToast(`成功存入 ${amount} 两，手续费 ${fee} 两。`);
    } else { // fromChest
        if (ts.moneyChest < amount) {
            showToast("钱柜资金不足。");
            return;
        }
        if (gameState.finances.wealth < fee) {
            showToast("私产不足以支付手续费。");
            return;
        }
        ts.moneyChest -= amount;
        gameState.finances.wealth += (amount - fee);
        showToast(`成功取出 ${amount} 两，手续费 ${fee} 两。`);
    }

    // 刷新钱柜界面
    showMoneyChestUI();
}
function renderLogTab() {
    if (gameState.log.length === 0) {
        return '<h3 class="card-header">记事簿</h3><p class="comment" style="text-align:center;">尚未有任何记录。</p>';
    }
    return `
    <h3 class="card-header">记事簿</h3>
    <div class="event-log">
        ${gameState.log.map(e =>`
        <div class="event" ${e.isYear ? `style="text-align:center; border-left-color: var(--highlight-strong);"` : ''}>
            <div class="event-content">${e.content}</div>
        </div>
        `).join('')}
    </div>`;
}

// =======================================================================
// ====================== PLAYER ACTION & CAREER =========================
// =======================================================================
function performAction(actionType) {
 if (gameState.flags.debug_unlimitedActions) {
        gameState.flags.actionUsed_study = 0;
    }
    let effects = {};
    let logText = '';
    const studyActions = ['study', 'art', 'etiquette', 'martial', 'needlework'];

    if (studyActions.includes(actionType)) {
        if (gameState.flags.actionUsed_study >= 2) {
            showToast("本回合修身次数已用尽。");
            return;
        }
        gameState.flags.actionUsed_study++;

        const isInspired = Math.random() < 0.1;
        const multiplier = isInspired ? 3 : 1;
        let inspirationText = isInspired ? '<strong class="value">你今日文思泉涌，竟有所顿悟！</strong><br>' : '';

        switch (actionType) {
            case 'study':
                effects = { wisdom: getRandomInt(6, 8) * multiplier, talent: getRandomInt(3, 6) * multiplier };
                logText = '你静心研读诗书，颇有心得。';
                break;
            case 'art':
                effects = { talent: getRandomInt(6, 8) * multiplier, charm: getRandomInt(3, 6) * multiplier };
                logText = '你沉浸在琴棋书画的世界里，陶冶了情操。';
                break;
            case 'etiquette':
                effects = { etiquette: getRandomInt(6, 8) * multiplier, virtue: getRandomInt(3, 6) * multiplier };
                logText = '你学习待人接物的礼法，言行举止更加得体。';
                break;
            case 'martial':
                effects = { martial: getRandomInt(6, 8) * multiplier, health: getRandomInt(3, 6) * multiplier };
                logText = '你勤练武艺，感觉身手更加矫健了。';
                break;
            case 'needlework':
                effects = { talent: getRandomInt(6, 8) * multiplier, virtue: getRandomInt(3, 6) * multiplier };
                logText = '飞针走线之间，你的绣工又精进了不少。';
                break;
        }
        applyEffects({ attributes: effects });
        
        // 【核心修改】在弹窗的回调函数中加入 renderGame()，关闭弹窗后立刻刷新主界面
        showEventCard("修身有成", "fa-book-reader", `${inspirationText}${logText}<br/>${Object.entries(effects).map(([k,v]) => `${ATTR_MAP[k]}+${v}`).join('，')}`);
        
        // 【核心修改】直接调用 renderGame() 立即刷新背景数值
        renderGame();
    }
}
function startCareer(pathId) {
    if (gameState.career.path) {
        showToast("你已经选择了职业，无法更改。");
        return;
    }
    if (gameState.player.age < 16) {
        showToast("需年满16岁方可选择职业。");
        return;
    }

    const careerData = PROFESSION_DATA[pathId];
    if (!careerData) return;

    gameState.career.path = pathId;
    // 【修复】职业等级从0开始
    gameState.career.level = 0; 
    gameState.career.currentAct = 0;
    gameState.career.performance = 0;
    
    // 初始化核心资源
    careerData.core_resources.forEach(res => {
        gameState.career.core_resources[res] = 0;
    });

    showEventCard('开启事业', careerData.icon, `你的人生翻开了新的篇章，正式踏上了【${careerData.name}】之路！`);
    renderGame();
    updateActiveTab('career');
}
function work(type) {
    const { path, level } = gameState.career;
    if (!path) return;

    if(type==='regular') {
        if (gameState.flags.actionUsed_work >= 2) { showToast("你今天已经很累了。"); return; }
        gameState.flags.actionUsed_work++;
        const currentLevelData = careerPaths[gameState.player.gender][path].levels[level];
        const earnings = Math.floor(currentLevelData.salary * (getRandomInt(5, 15) / 100));
        const performanceGain = getRandomInt(3, 8);
        applyEffects({ wealth: earnings, attributes: { health: -1 } });
        gameState.career.performance += performanceGain;
        showEventCard('潜心工作', 'fa-pencil-ruler', `你勤奋工作，业绩提升。功绩+${performanceGain}，并赚取了 <span class="value">${earnings}</span> 两。`);
        logEvent(logText);
        
        showEventCard('潜心工作', 'fa-pencil-ruler', logText);
checkForPromotion();
    } else { // challenge
        const allChallenges = careerChallenges[path] || careerChallenges[Object.keys(careerChallenges)[0]]; // Fallback
        const availableChallenges = allChallenges.filter(c => c.level <= level);
        if (availableChallenges.length === 0) {
            showToast("当前暂无合适的挑战。");
            return;
        }
        const challenge = getRandomElement(availableChallenges);
        let challengeOptions = challenge.options.map((opt, index) => {
             const canAttempt = Object.entries(opt.req).every(([attr, val]) => (gameState.player.attributes[attr] || 0) >= val);
             const reqText = Object.entries(opt.req).map(([attr, val]) => `${ATTR_MAP[attr] || attr}≥${val}`).join(', ');
             return {
                htmlContent: `<i class="fas fa-hand-pointer"></i><span class="option-text">${opt.text} <div><small>要求: ${reqText}</small></div></span>`,
                disabled: !canAttempt,
                callback: () => handleCareerChallengeResult(opt)
             };
        });
        
        const card = document.getElementById('careerChallengeOverlay');
        card.querySelector('#careerChallengeHeader').innerText = challenge.title;
        card.querySelector('#careerChallengeAnimation').innerHTML = '⚔️';
        card.querySelector('#careerChallengeContent').innerHTML = challenge.desc;
        showDecisionCard(challenge.title, '⚔️', challenge.desc, challengeOptions)
    }
}
function handleCareerChallengeResult(option) {
    const success = Object.entries(option.req).every(([attr, val]) => (gameState.player.attributes[attr] || 0) >= val * (0.8 + Math.random()*0.4));
    
     let resultText;
     let effectsToApply = {};
     if(success) {
        effectsToApply = option.success;
        resultText = "挑战成功！"
     } else {
        effectsToApply = option.failure;
        resultText = "挑战失败..."
     }
     
     if (effectsToApply.performance) {
        gameState.career.performance += effectsToApply.performance;
        resultText += `功绩${effectsToApply.performance > 0 ? '+' : ''}${effectsToApply.performance}。`;
        delete effectsToApply.performance;
     }

     if (Object.keys(effectsToApply).length > 0) {
        applyEffects({attributes: effectsToApply});
        resultText += Object.entries(effectsToApply).map(([k,v]) => `${ATTR_MAP[k] || k}${v > 0 ? '+' : ''}${v}`).join(', ');
     }
    
     // [核心修改] 将 checkForPromotion 作为回调函数传入
     showEventCard('职业挑战', '⚔️', resultText, [{ text: '知道了', callback: checkForPromotion }]);
}

function interactWithSupervisor(actionType) {
    const supervisor = gameState.npcs[gameState.career.supervisorId];
    if (!supervisor) return;
    supervisor.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;

    if (actionType === 'chat') {
        const favorGain = getRandomInt(2, 5) + (gameState.player.attributes.charm > 50 ? 2 : 0);
        applyEffects({relationship: {targetId: supervisor.id, favor: favorGain}});
        showEventCard('汇报工作', 'fa-comments', `你向上司${supervisor.name}汇报了工作，对方对你印象不错，好感+${favorGain}`);
    } else if (actionType === 'gift') {
        const costStr = prompt("请输入赠礼金额 (金额越高效果越好)", "100");
        const cost = parseInt(costStr);
        if(isNaN(cost) || cost <= 0) return;
        if(gameState.finances.wealth < cost) { showToast("资金不足"); return; }
        
        const favorGain = Math.floor(cost / 20) + getRandomInt(1,5);
        applyEffects({wealth: -cost, relationship: {targetId: supervisor.id, favor: favorGain}});
        if(cost > 1000 && gameState.player.attributes.virtue < 50) {
            applyEffects({attributes: {virtue: -10}});
            showEventCard('赠送重礼', 'fa-gift', `你花费${cost}两为上司送上重礼，对方欣然收下，好感+${favorGain}。但此举有损官德，品德-10。`);
        } else {
            showEventCard('赠送礼物', 'fa-gift', `你花费${cost}两为上司送上薄礼，对方对你的好感+${favorGain}。`);
        }
    }
    renderGame();
}

// ===================== 【新增】濒死提醒函数 START =====================
function checkLowHealthWarning() {
    if (gameState.player.health < 20 && !gameState.flags.lowHealthWarnedThisTurn) {
        gameState.flags.lowHealthWarnedThisTurn = true; // 标记本回合已警告过，防止重复弹窗
        eventQueue.unshift(() => { // 使用 unshift 确保此事件最先触发
            const options = [
                { htmlContent: `<i class="fas fa-clinic-medical"></i> 前往医馆`, callback: () => showClinic() },
                { htmlContent: `<i class="fas fa-shopping-bag"></i> 逛市集购买补品`, callback: () => showMarket() },
                { htmlContent: `<i class="fas fa-bed"></i> 静心休养`, callback: () => {
                    applyEffects({attributes: {health: 5}});
                    showEventCard('静心休养', 'fa-bed', '你决定静心休养，恢复了5点健康。');
                }}
            ];
            showDecisionCard(
                '生命垂危警告',
                'fa-heartbeat',
                '你的健康状况已极差，有性命之虞！请立刻设法调理：<br>- 前往医馆寻医问药<br>- 在市集购买人参等补品<br>- 通过修身养性恢复',
                options
            );
        });
    } else if (gameState.player.health >= 20) {
        delete gameState.flags.lowHealthWarnedThisTurn; // 健康恢复后，重置警告标记
    }
}
// ===================== 【新增】濒死提醒函数 END =====================
// 新代码
// [替换] 找到这个函数并用下面的代码完整替换
function checkForPromotion() {
    const c = gameState.career;
    if (!c.path) return;
    
    const currentPath = careerPaths[gameState.player.gender][c.path];
    if (!currentPath || c.level >= currentPath.levels.length - 1) return;

    const nextLevel = currentPath.levels[c.level + 1];

    // <<< 这里是修复点：增加功绩上限检查
    if (c.performance > nextLevel.promotion_points) {
        c.performance = nextLevel.promotion_points;
    }
    // >>> 修复结束

    if (c.performance >= nextLevel.promotion_points) {
        const canPromote = Object.entries(nextLevel.req).every(([attr, val]) => (gameState.player.attributes[attr] || gameState.family[attr] || 0) >= val);
        
        let headerText, contentText;
        if (canPromote) {
            headerText = '晋升挑战';
            contentText = `你的功绩已经达到要求，但要更进一步，还需要通过一个挑战。你是否接受这个挑战？<br><br><strong>挑战成功：</strong> 成功晋升，声望大涨。<br><strong>挑战失败：</strong> 功绩清零，留守原职，但会获得一笔安抚金。`;
        } else {
            headerText = '能力不足';
            contentText = `你的功绩已经达到要求，但能力尚有不足，无法挑战晋升。你将获得一笔加薪作为奖励。`;
            const salaryGain = Math.floor(currentPath.levels[c.level].salary * 0.05);
            applyEffects({ wealth: salaryGain });
            c.performance = nextLevel.promotion_points - 20;
            showEventCard('功绩卓著', 'fa-award', contentText + `获得加薪 <span class="value">${salaryGain * 2}</span> 两。`);
            renderGame();
            return;
        }

        const options = [
            {
                htmlContent: '<i class="fas fa-gavel"></i> 接受挑战',
                callback: () => handlePromotionChallenge(canPromote)
            },
            {
                htmlContent: '<i class="fas fa-times"></i> 拒绝挑战',
                callback: () => {
                    if (canPromote) {
                        showEventCard('谨慎行事', 'fa-arrow-down', '你选择暂时不挑战晋升，功绩被清零，但你保住了当前的一切。');
                        c.performance = 0;
                    }
                    closeAllOverlays();
                    renderGame();
                }
            }
        ];

        showDecisionCard(headerText, 'fa-arrow-up', contentText, options);
    }
}
// 新增函数：处理晋升挑战的实际逻辑
// [替换此函数]
function handlePromotionChallenge(canPromote) {
    const c = gameState.career;
    const currentPath = careerPaths[gameState.player.gender][c.path];
    const nextLevel = currentPath.levels[c.level + 1];

    // 【核心修复】根据职业核心属性计算成功率
    const coreStats = CAREER_CORE_STATS[c.path] || ['wisdom']; // 默认使用智慧
    let totalCoreStatValue = 0;
    coreStats.forEach(attr => {
        totalCoreStatValue += (gameState.player.attributes[attr] || 0);
    });

    // 成功率公式：基础40% + (核心属性平均值 / 200)
    let successRate = 0.4 + (totalCoreStatValue / coreStats.length) / 200;
    successRate = Math.min(0.95, successRate); // 最高95%

    if (Math.random() < successRate) {
        // 成功晋升
        c.level++;
        c.performance = 0;
        const newTitle = currentPath.levels[c.level].title;
        const salaryGain = currentPath.levels[c.level].salary - currentPath.levels[c.level - 1].salary;
        applyEffects({ wealth: salaryGain, reputation: 20 });
        const msg = `恭喜！你成功通过晋升挑战，晋升为<strong class="value">${newTitle}</strong>！俸禄提升，并获得奖励 <span class="value">${salaryGain * 2}</span> 两。`;
        showEventCard(' 晋升之喜 ', 'fa-crown', msg);
    } else {
        // 挑战失败
        const salaryGain = Math.floor(currentPath.levels[c.level].salary * 0.1);
        applyEffects({ wealth: salaryGain });
        c.performance = 0;
        const msg = `挑战失败！你留守原职，功绩清零，但获得了一笔 <span class="value">${salaryGain * 2}</span> 两的安抚金。`;
        showEventCard('挑战失败', 'fa-frown', msg);
    }
    renderGame();
}
function showAssetsOverlay() {
    let html = ``;
    const residenceData = [
        { id: 'small_courtyard', name: '小巧庭院', cost: 20000, capacity: 5, type: 'residence' },
        { id: 'three_entry_mansion', name: '三进府邸', cost: 100000, capacity: 15, type: 'residence' },
        { id: 'prince_manor', name: '亲王规制宅邸', cost: 500000, capacity: 30, type: 'residence' },
    ];
    html += `<div class="section-header"><i class="fas fa-home"></i> 房产</div>`;
    const ownedResidences = gameState.finances.assets.filter(c => c.type === 'residence');
    if (ownedResidences.length > 0) {
        html += ownedResidences.map(r => `<div class="marketplace-item"><span>${r.name} (可容纳${r.capacity}人)</span><span>已购置</span></div>`).join('');
    } else {
        html += `<p class="comment" style="padding-left:15px;">暂未购置府邸。</p>`;
    }
    const currentOccupants = 1 + (gameState.marriage.isMarried ? 1 : 0) + gameState.marriage.concubines.length + gameState.children.filter(c=>!c.isDead).length;
    const totalCapacity = ownedResidences.reduce((sum, r) => sum + r.capacity, 5);
    html += `<p class="comment" style="padding-left:15px;">当前居住: ${currentOccupants}人 / 总容量: ${totalCapacity}人</p>`;
    html += `<div class="options" style="flex-direction: column; gap: 10px;">`;
    residenceData.forEach(r => {
            html += `<button class="option" ${gameState.finances.wealth < r.cost ? 'disabled' : ''} onclick="buyAsset('${r.id}')"><i class="fas fa-key"></i>${r.name} (-${formatNumber(r.cost)}两)</button>`;
    });
    html += `</div>`;
    html += `<div class="section-header"><i class="fas fa-gem"></i> 藏品</div>`;
    const collectibles = gameState.finances.assets.filter(c => c.type === 'collectible');
    if (collectibles.length > 0) {
        html += collectibles.map(item => `
        <div class="marketplace-item">
            <span>${item.name}</span>
            <span>购入: ${formatNumber(item.purchasePrice)} | 现值: ${formatNumber(item.currentValue)}</span>
        </div>`).join('');
    } else {
        html += `<p class="comment" style="padding-left:15px;">暂无收藏。</p>`;
    }
    html += `<p class="comment" style="padding-left:15px; margin-top:10px;">可前往市集搜罗古董字画。</p>`;

    document.getElementById('assetsContent').innerHTML = html;
    showOverlay('assetsOverlay');

}
function buyAsset(assetId) {
    const allItems = [
        ...marketItems.common, ...marketItems.female, ...marketItems.male,
        { id: 'small_courtyard', name: '小巧庭院', cost: 20000, capacity: 5, type: 'residence' },
        { id: 'three_entry_mansion', name: '三进府邸', cost: 100000, capacity: 15, type: 'residence' },
        { id: 'prince_manor', name: '亲王规制宅邸', cost: 500000, capacity: 30, type: 'residence' },
    ];
    const item = allItems.find(i => i.id === assetId);
    if (!item) return;

    const cost = item.price || item.cost;
    if (gameState.finances.wealth < cost) { showToast("资金不足。"); return; }
    if (item.type !== 'residence' && gameState.finances.assets.some(c => c.id === assetId)) { showToast("你已经拥有此物。"); return; }

    applyEffects({ wealth: -cost });
    let newAsset;
if (item.type === 'residence') {
    newAsset = { id: `residence_${item.id}_${Date.now()}`, name: item.name, type: item.type, purchasePrice: cost, currentValue: cost, baseAppreciation: item.baseAppreciation || 0, capacity: item.capacity || 0 };
} else {
    newAsset = { id: item.id, name: item.name, type: item.type, purchasePrice: cost, currentValue: cost, baseAppreciation: item.baseAppreciation || 0, capacity: item.capacity || 0 };
}
    gameState.finances.assets.push(newAsset);
    showEventCard('购置成功', 'fa-key', `你花费 <span class='value'>${cost}</span> 两，购入了${item.name}。`);
    showAssetsOverlay();

}
function processAssetAppreciation() {
    gameState.finances.assets.forEach(asset => {
        if (asset.type === 'collectible') {
            const eventRoll = Math.random();
            let multiplier = 1.0 + asset.baseAppreciation;
            if (eventRoll < 0.1) { multiplier = 0.7; logEvent(`市场动荡，你的${asset.name}贬值了。`, true); }
            else if (eventRoll > 0.9) { multiplier = 1.2; logEvent(`市场景气，你的${asset.name}大幅增值了。`, true);}
            asset.currentValue = Math.floor(asset.currentValue * multiplier);
        } else if (asset.type === 'residence') {
            asset.currentValue = Math.floor(asset.currentValue * 1.02);
        }
    });
}
function updateFinancialTier() {
    const totalAssets = gameState.finances.wealth + gameState.finances.assets.reduce((sum, c) => sum + (c.currentValue || 0), 0);
    let newTier = financialTiers[0];
    for (const tier of financialTiers) {
        if (totalAssets >= tier.threshold) {
            newTier = tier;
        } else {
            break;
        }
    }

    if (!gameState.finances.financialTier || gameState.finances.financialTier !== newTier.level) {
        gameState.finances.financialTier = newTier.level;
        // 只有在游戏已经开始，并且DOM元素存在时，才显示事件卡片
        if (document.getElementById('eventCardOverlay')) {
            showEventCard('财力变化', 'fa-chart-line', `你的家族财力变更为 <strong class="value">${newTier.name}</strong>！日常开销将随之调整。`);
        }
    }
}
function calculateAndDeductExpenses() {
    const tier = financialTiers.find(t => t.level === gameState.finances.financialTier);
    if (!tier) return;
    const exp = tier.expenses;
    let totalExpenses = 0;
    let breakdown = [];
    const isMale = gameState.player.gender === 'male';

    // 1. 个人开销
    totalExpenses += exp.personal;
    breakdown.push(`个人: ${exp.personal}`);

    // 2. 配偶与妾室开销 (仅限男玩家)
    if (isMale) {
        if (gameState.marriage.isMarried && gameState.npcs[gameState.marriage.spouseId] && !gameState.npcs[gameState.marriage.spouseId].isDead) {
            totalExpenses += exp.spouse;
            breakdown.push(`配偶: ${exp.spouse}`);
        }
        
        const concubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
        if (concubines.length > 0) {
            let concubineExpenses = 0;
            concubines.forEach(conc => {
                // 【核心修改】检查罚俸标记
                if (conc.isPunishedWithSalary) {
                    logEvent(`妾室 ${conc.name} 因被罚俸，本年度不计开销。`);
                    conc.isPunishedWithSalary = false; // 重置标记
                } else {
                    const rankData = CONCUBINE_RANKS[conc.rankIndex || 0];
                    concubineExpenses += rankData.allowance;
                }
            });
            if (concubineExpenses > 0) {
                totalExpenses += concubineExpenses;
                breakdown.push(`妾室: ${concubineExpenses}`);
            }
        }
    }

    // 3. 父母赡养费
    if (gameState.player.age >= 15) {
        const livingParents = [gameState.family.members.fatherId, gameState.family.members.motherId].filter(id => id && gameState.npcs[id] && !gameState.npcs[id].isDead).length;
        if (livingParents > 0) {
            const parentExpenses = livingParents * exp.parent;
            totalExpenses += parentExpenses;
            breakdown.push(`父母: ${parentExpenses}`);
        }
    }

    // 4. 子女抚养费
    const childrenToSupport = gameState.children.filter(c => !c.isDead && c.age < 18 && !c.isSecret && (isMale || c.motherId === 'player'));
    if (childrenToSupport.length > 0) {
        let childTotal = 0;
        childrenToSupport.forEach(child => {
            const edu = child.education || { cost: 0 };
            childTotal += exp.child_base + edu.cost;
        });
        if (childTotal > 0) {
            totalExpenses += childTotal;
            breakdown.push(`子女: ${childTotal}`);
        }
    }

    // 5. 最终结算
    applyEffects({ wealth: -totalExpenses });
    if (totalExpenses > 0) {
        logEvent(`年度开销结算：总计支出 <span class="value">${totalExpenses}</span> 两。<br><small>(${breakdown.join(', ')})</small>`, true);
    }
}
function manageFamilyChest() {
    const action = prompt(`家库目前有 ${gameState.family.moneyChest} 两。\n请输入要存入(+)或取出(-)的金额：`, '100');
    const amount = parseInt(action);
    if (isNaN(amount) || amount === 0) return;

    if(amount > 0) {
        if(gameState.finances.wealth < amount) { showToast("你的私产不足。"); return; }
        applyEffects({wealth: -amount});
        gameState.family.moneyChest += amount;
        if(gameState.player.gender === 'female' && gameState.marriage.isMarried) applyEffects({relationship: { targetId: gameState.marriage.spouseId, favor: Math.floor(amount/100) }});
        showEventCard('存入家库', 'fa-donate', `你向家库中存入了 ${amount} 两。${gameState.player.gender === 'female' && gameState.marriage.isMarried ? '夫妻恩爱值略有提升。':''}`);
    } else {
        if(gameState.family.moneyChest < -amount) { showToast("家库中没有这么多钱。"); return; }
        applyEffects({wealth: -amount});
        gameState.family.moneyChest += amount;
        if(gameState.player.gender === 'female' && gameState.marriage.isMarried) applyEffects({relationship: { targetId: gameState.marriage.spouseId, favor: -Math.floor(-amount/100) }});
        showEventCard('取自家库', 'fa-hand-holding-usd', `你从家库中取出了 ${-amount} 两。${gameState.player.gender === 'female' && gameState.marriage.isMarried ? '夫妻恩爱值略有下降。':''}`);
    }
    renderGame();
}
function askForMoney() {
    if (gameState.flags.actionUsed_family) { showToast("本回合已处理过家事。"); return; }
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if(!spouse) return;

    gameState.flags.actionUsed_family = true;
    const favor = gameState.marriage.favor;
    const amount = getRandomInt(100, 300) + Math.floor(favor * 2);
    gameState.family.moneyChest += amount;
    applyEffects({relationship: { targetId: spouse.id, favor: -getRandomInt(1, 4) }});

    showEventCard('索要家用', 'fa-hand-holding-usd', `你向夫君索要家用，他给了你 <span class="value">${amount}</span> 两，但似乎有些不快。恩爱值下降。`);
    renderGame();
}
function handleSpouseConcubines() {
    if (gameState.flags.actionUsed_family) { showToast("本回合已处理过家事。"); return; }
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    const concubines = spouse.concubines.filter(id => gameState.npcs[id] && !gameState.npcs[id].isDead);
    if (!concubines || concubines.length === 0) return;

    const target = getRandomElement(concubines.map(id => gameState.npcs[id]));
    const options = [
        { text: "敲打一番", action: {favor: -10, virtue: -2}, log: `你敲打了妾室${target.name}一番，立了主母的威严，但显得有些刻薄。`},
        { text: "赏赐拉拢", action: {favor: 5, wealth: -100}, log: `你花费100两赏赐了${target.name}，她对你更加恭顺。`},
        { text: "置之不理", action: {}, log: "你决定后宅之事，多一事不如少一事。"}
    ];

    let optionObjects = options.map((opt, i) => {
        return {
            htmlContent: `<span class="option-text">${opt.text}</span>`,
            callback: () => handleConcubineAction(opt, target.id)
        };
    });

    showDecisionCard('处理妾室', 'fa-user-times', `你正想着如何处理夫君的妾室 <strong class="highlight-npc">${target.name}</strong>...`, optionObjects);

}
function handleConcubineAction(option, targetId) {
    gameState.flags.actionUsed_family = true;

     if(option.action.wealth && gameState.finances.wealth < -option.action.wealth) {
         showToast("银钱不足。");
         return;
     }

     if(option.action.wealth) applyEffects({wealth: option.action.wealth});
     if(option.action.favor) applyEffects({relationship: {targetId:targetId, favor: option.action.favor}});
     if(option.action.virtue) applyEffects({attributes: {virtue: option.action.virtue}});
     
     showEventCard('后宅风云', 'fa-users', option.log);
     renderGame();
}
// =======================================================================
// ========================== MARRIAGE & FAMILY ==========================
// =======================================================================
// ADD THESE NEW FUNCTIONS

function updateHaremStatus() {
    // This function is called every turn to update moods, harmony, etc.
    if (gameState.player.gender !== 'male' || (!gameState.marriage.isMarried && gameState.marriage.concubines.length === 0)) return;

    const allLadies = [gameState.npcs[gameState.marriage.spouseId], ...gameState.marriage.concubines.map(id => gameState.npcs[id])].filter(Boolean);
    if (allLadies.length <= 1) {
        gameState.marriage.familyHarmony = Math.min(100, gameState.marriage.familyHarmony + 2);
        if(allLadies.length === 1) allLadies[0].mood = '平和';
        return;
    }

    // 1. Distribute Favor & Update Moods
    // Simple system: find the most favored one
    let mostFavored = null;
    let highestFavor = -101;
    allLadies.forEach(lady => {
        if (lady.favor > highestFavor) {
            highestFavor = lady.favor;
            mostFavored = lady;
        }
    });

    let totalFavorDiff = 0;
    allLadies.forEach(lady => {
        if (lady === mostFavored) {
            lady.mood = lady.favor > 80 ? '得意' : '平和';
        } else {
            const favorDifference = mostFavored.favor - lady.favor;
            totalFavorDiff += favorDifference;
            if (favorDifference > 50) {
                lady.mood = '哀怨';
                lady.jealousy = (lady.jealousy || 0) + 5;
            } else if (favorDifference > 20) {
                lady.mood = '嫉妒';
                lady.jealousy = (lady.jealousy || 0) + 2;
            } else {
                lady.mood = '平和';
                lady.jealousy = Math.max(0, (lady.jealousy || 0) - 1);
            }
        }
    });

    // 2. Calculate Family Harmony
    // Harmony is high when favor differences are low
    gameState.marriage.familyHarmony = Math.max(0, 100 - Math.floor(totalFavorDiff / allLadies.length));
}

function triggerHaremEvent() {
    if (gameState.player.gender !== 'male' || Math.random() > 0.3) return; // 30% chance per turn

    const wife = gameState.npcs[gameState.marriage.spouseId];
    const concubines = gameState.marriage.concubines.map(id => gameState.npcs[id]).filter(Boolean);

    let triggeredEvent = null;
    let eventData = null;
    let involvedConcubine = null;

    // Check for high-intensity scheming events first
    for (const concubine of concubines) {
        if (triggeredEvent) break;
        for (const event of HAREM_EVENT_DATA.scheming) {
            if (event.trigger(concubine, wife)) {
                triggeredEvent = event;
                eventData = event;
                involvedConcubine = concubine;
                break;
            }
        }
    }

    // If no scheming, check for low-intensity jealousy events
    if (!triggeredEvent) {
        for (const concubine of concubines) {
            if (triggeredEvent) break;
            for (const event of HAREM_EVENT_DATA.jealousy) {
                if (event.trigger(concubine)) {
                    triggeredEvent = event;
                    eventData = event;
                    involvedConcubine = concubine;
                    break;
                }
            }
        }
    }

    if (triggeredEvent && eventData && involvedConcubine) {
        const description = eventData.description(involvedConcubine, wife);
        const options = eventData.options.map(opt => ({
            htmlContent: `<span class="option-text">${opt.text}</span>`,
            callback: () => opt.action(involvedConcubine, wife)
        }));
        showDecisionCard(eventData.title, 'fa-theater-masks', description, options);
    }
}

function holdFamilyBanquet() {
    const cost = 200;
    if (gameState.family.moneyChest < cost) {
        showToast(`家库资金不足${cost}两，无法举办家宴。`);
        return;
    }
    gameState.family.moneyChest -= cost;
    
    const allFamily = [
        gameState.npcs[gameState.family.members.motherId],
        gameState.npcs[gameState.marriage.spouseId],
        ...gameState.marriage.concubines.map(id => gameState.npcs[id])
    ].filter(Boolean);

    allFamily.forEach(member => {
        applyEffects({ relationship: { targetId: member.id, favor: getRandomInt(2, 5) } });
    });

    gameState.marriage.familyHarmony = Math.min(100, gameState.marriage.familyHarmony + 10);
    showEventCard('家宴', 'fa-users', `你举办了一场家宴，阖家欢乐，家庭和谐度提升。`);
    renderGame();
}
// [替换] 原有的 triggerSpouseEvent 函数
function triggerSpouseEvent() {
    if (!gameState.marriage.isMarried || !gameState.npcs[gameState.marriage.spouseId]) return;

    if (Math.random() < 0.25) { // 每回合有25%几率触发
        const spouse = gameState.npcs[gameState.marriage.spouseId];
        const isMalePlayer = gameState.player.gender === 'male';

        const eventTypes = ['daily', 'crisis', 'child_edu'];
        const randomEventType = getRandomElement(eventTypes);
        
        let decisionTitle, decisionDesc, decisionOptions;

        switch (randomEventType) {
            case 'daily': // 日常问候
                decisionTitle = '日常问候';
                decisionDesc = isMalePlayer ? '夫人为你准备了早膳，含情脉脉地看着你。' : '夫君见你夜读辛劳，特地为你披上外衣，陪伴在侧。';
                decisionOptions = [
                    { htmlContent: '【温情回应】', callback: () => {
                        showEventCard('岁月静好', 'fa-sun', '你们相视一笑，一切尽在不言中。夫妻情感+5，健康+5。');
                        applyEffects({ marriage: { emotionValue: 5 }, attributes: { health: 5 } });
                    }},
                    { htmlContent: '【漠然处之】', callback: () => {
                        showEventCard('漠不关心', 'fa-snowflake', '你的冷淡让对方有些失落。夫妻情感-5。');
                        applyEffects({ marriage: { emotionValue: -5 } });
                    }},
                    { htmlContent: '【赠送小礼】', callback: () => {
                        if (gameState.finances.wealth >= 100) {
                            showEventCard('甜蜜惊喜', 'fa-gift', '你送上的小礼物让对方惊喜不已。夫妻情感+10。');
                            applyEffects({ wealth: -100, marriage: { emotionValue: 10, favor: 2 } });
                        } else {
                            showToast("你的私产不足100两。");
                        }
                    }}
                ];
                break;

            case 'crisis': // 家庭危机
                 if ((gameState.career.core_resources.jia_zu_sheng_wang || gameState.family.reputation) < 30) return; // 声望太低不触发
                 decisionTitle = '家庭危机';
                 const isFinanceCrisis = Math.random() < 0.5;
                 decisionDesc = isFinanceCrisis ? '家中遭遇意外，财务上出现了巨大的缺口，周转困难。' : '因一桩丑闻，家族声望受损，在京中备受非议。';
                 decisionOptions = [
                    { htmlContent: '【共同承担】', callback: () => {
                        showEventCard('同舟共济', 'fa-hands-helping', '你们决定共同面对，患难见真情。夫妻情感+20。');
                        applyEffects({ marriage: { emotionValue: 20, favor: 5 } });
                    }},
                    { htmlContent: '【责备对方】', callback: () => {
                        showEventCard('互相指责', 'fa-angry', '你们互相指责，将责任推给对方，关系出现裂痕。夫妻情感-20。');
                        applyEffects({ marriage: { emotionValue: -20, favor: -10 } });
                    }},
                    { htmlContent: '【寻求外援】', callback: () => {
                        // 简化处理，人脉越高成功率越高
                        if ((gameState.player.attributes.charm + gameState.player.attributes.reputation) > 150) {
                            showEventCard('贵人相助', 'fa-user-friends', '你凭借人脉，成功化解了此次危机。夫妻情感+10。');
                            applyEffects({ marriage: { emotionValue: 10 } });
                        } else {
                            showEventCard('求助无门', 'fa-door-closed', '你的人脉不足以解决问题，危机依然存在。');
                        }
                    }}
                 ];
                 break;

            case 'child_edu': // 子女教育分歧
                const children = gameState.children.filter(c => !c.isDead && c.age >= 6 && c.age < 16);
                if (children.length === 0) return; // 没有学龄儿童则不触发
                const child = getRandomElement(children);
                decisionTitle = '子嗣教育分歧';
                decisionDesc = `关于 <strong class="highlight-npc">${child.name}</strong> 的教育问题，你与配偶产生了分歧。`;
                decisionOptions = [
                    { htmlContent: '【妥协】', callback: () => {
                        showEventCard('以和为贵', 'fa-handshake', `你选择妥协，${spouse.name}对你的退让表示感激。孩子属性获得随机提升。`);
                        applyEffects({ marriage: { favor: 5 } });
                        const randomAttr = getRandomElement(['talent', 'wisdom', 'etiquette', 'virtue']);
                        child.attributes[randomAttr] += 5;
                    }},
                    { htmlContent: '【坚持己见】', callback: () => {
                        showEventCard('坚持己见', 'fa-gavel', '你坚持了自己的看法，但配偶对此感到不满。');
                        applyEffects({ marriage: { favor: -10 } });
                         // 假设玩家倾向于智慧
                         child.attributes['wisdom'] += 8;
                    }},
                    { htmlContent: '【请长辈定夺】', callback: () => {
                        const father = gameState.npcs[gameState.family.members.fatherId];
                        if (father && father.favor > 50) {
                            showEventCard('长辈的智慧', 'fa-user-tie', '在长辈的调解下，你们达成了共识。');
                            applyEffects({ marriage: { favor: 5 } });
                            child.attributes['wisdom'] += 4;
                            child.attributes['virtue'] += 4;
                        } else {
                            showEventCard('无人可依', 'fa-times-circle', '长辈不愿插手你们的家事。');
                        }
                    }}
                ];
                break;
        }

        if (decisionTitle) {
            // 使用事件队列，防止弹窗覆盖
            eventQueue.push(() => {
                showDecisionCard(decisionTitle, 'fa-users', decisionDesc, decisionOptions);
            });
        }
    }
}
// REPLACE THIS ENTIRE FUNCTION
// [替换] marrySuitor 函数
// [替换] marrySuitor 函数
// [用这个新版本替换] marrySuitor 函数
function marrySuitor(suitorId) {
    const suitor = gameState.npcs[suitorId];
    if (!suitor) return;

    if(gameState.player.age < 16) { showToast("你尚未及笄/行冠礼，不可成婚。"); return; }
    if(gameState.marriage.isMarried) { showToast("你已成婚。"); return; }

    // 根据结识来源决定聘礼/嫁妆基础开销
    const cost = suitor.source === 'matchmaker' ? 3000 : 5000 + Math.floor(Math.random() * (100000 / (suitor.attributes.family || 20)));

    if (gameState.finances.wealth < cost) { showToast("你的财力不足以支撑这门婚事。"); return; }
    applyEffects({wealth: -cost});

    // --- 通用结婚逻辑 ---
    suitor.relationship = 'spouse';
    gameState.marriage.isMarried = true;
    gameState.marriage.spouseId = suitor.id;
    suitor.suspicionValue = 0; // 初始化疑心值

    // 从其他关系列表中清理
    gameState.suitors = gameState.suitors.filter(id => id !== suitorId);
    gameState.social.friends = gameState.social.friends.filter(id => id !== suitorId);
    gameState.social.secretLovers = gameState.social.secretLovers.filter(id => id !== suitorId);
    if (gameState.social.relationships[suitorId]) {
        delete gameState.social.relationships[suitorId];
    }
    // 正式建立配偶关系
    gameState.social.relationships[suitorId] = {
        type: 'spouse',
        favor: 50,
        emotionValue: 100,
        level: 1,
    };
    
    // --- 性别差异化逻辑 ---
    if (gameState.player.gender === 'female') {
        suitor.dynamicState = '闲情逸致'; // 夫君初始状态

        // **【核心修改】根据结婚方式决定有无妾室**
        if (suitor.source === 'matchmaker') {
            // 通过媒人成婚，夫君自带妾室，开启“博弈开局”
            logEvent(`你通过媒人嫁入高门，开启了“博弈开局”，一进门就要面对两位虎视眈眈的妾室。`);
            gameState.marriage.favor = 30; // 感情基础较弱
            
            const standardAllowance = financialTiers.find(t => t.level === gameState.finances.financialTier)?.expenses.concubine || 50;

            const zhao = generateNPC({
                gender: 'female', age: suitor.age - 2,
                name: '赵' + getRandomElement(nameData.girlNames), role: '赵姨娘',
                relationship: 'concubine', favor: 40, personality: ['笑里藏刀', '腹黑'],
                ambition: 75, jealousy: 60, monthlyAllowance: standardAllowance,
                background: {desc: '婆婆的远房侄女，深得婆婆信任。'}
            });
            
            const li = generateNPC({
                gender: 'female', age: suitor.age - 1,
                name: '李' + getRandomElement(nameData.girlNames), role: '李姨娘',
                relationship: 'concubine', favor: 60, personality: ['刁蛮泼辣', '善妒'],
                ambition: 50, jealousy: 80, monthlyAllowance: standardAllowance,
                background: {desc: '夫君的昔日丫鬟，恃宠而骄。'}
            });
            
            suitor.concubines = [zhao.id, li.id];
        } else {
            // 自由恋爱/青梅竹马成婚，后院清净，开启“蜜月开局”
            logEvent(`你与心上人喜结连理，开启了“蜜月开局”，初始恩宠值很高，且夫君后院暂无她人。`);
            gameState.marriage.favor = 80; // 感情基础深厚
            suitor.concubines = []; // 初始没有妾室
        }

    } else { // 男性玩家
         gameState.marriage.favor = 50;
    }
    
    const groom = gameState.player.gender === 'male' ? gameState.player.name : suitor.name;
    const bride = gameState.player.gender === 'female' ? gameState.player.name : suitor.name;

    showWeddingOverlay(groom, bride);
    logEvent(`你花费 <span class="value">${Math.floor(cost)}</span> 两，与 <strong class="highlight-npc">${suitor.name}</strong> 喜结连理。`);
    renderGame(); 
}
function checkHusbandTakesConcubine() {
    // 仅对已婚的女玩家生效
    if (gameState.player.gender !== 'female' || !gameState.marriage.isMarried) {
        return;
    }

    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || husband.isDead) {
        return;
    }

    // 检查府邸容量是否已满
    const totalCapacity = (gameState.finances.assets.find(a => a.type === 'residence')?.capacity || 5);
    const currentOccupants = 1 + 1 + (husband.concubines ? husband.concubines.length : 0);
    if (currentOccupants >= totalCapacity) {
        return; // 府邸住不下了
    }

    const favor = gameState.marriage.favor;
    let chance = 0;

    // 根据恩爱值决定纳妾几率
    if (favor < 30) chance = 0.15; // 感情不睦，有15%几率
    if (favor < 10) chance = 0.30; // 感情破裂，有30%几率

    if (Math.random() < chance) {
        // 触发纳妾事件
        const newConcubine = generateNPC({
            gender: 'female',
            age: husband.age - getRandomInt(3, 8),
            role: '新纳侍妾',
            relationship: 'concubine',
            favor: 50,
            personality: [getRandomElement(personalityTraits.positive)],
            ambition: getRandomInt(20, 50),
            jealousy: getRandomInt(20, 50)
        });

        if (!husband.concubines) {
            husband.concubines = [];
        }
        husband.concubines.push(newConcubine.id);

        // 使用事件队列，确保弹窗在所有回合结算后显示
        eventQueue.push(() => {
            showEventCard('后院起火', 'fa-sad-cry', `因你与夫君 <strong class="highlight-npc">${husband.name}</strong> 感情不睦，他从外面带回一位女子 <strong class="highlight-npc">${newConcubine.name}</strong>，纳为妾室。`);
        });
    }
}
function handleCarrotAndStick() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    const currentTier = financialTiers.find(t => t.level === gameState.finances.financialTier);
    const standardAllowance = currentTier?.expenses.concubine || 50; // 获取当前财力等级下的标准月例

    let contentHTML = `<p class="comment">你可以调整妾室们的月例份例，以达到拉拢或打压的目的。标准月例为 <span class="value">${standardAllowance}</span> 两。</p>`;

    concubines.forEach(conc => {
        // 如果妾室没有月例属性，则初始化
        if (typeof conc.monthlyAllowance === 'undefined') {
            conc.monthlyAllowance = standardAllowance;
        }
        contentHTML += `
            <div style="margin: 20px 0; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color-light);">
                <strong>${conc.name}</strong> (恩爱: ${conc.favor})
                <div class="quantity-slider-container">
                    <input type="range" id="allowance_slider_${conc.id}" value="${conc.monthlyAllowance}" min="0" max="${standardAllowance * 2}" step="10"
                           oninput="document.getElementById('allowance_input_${conc.id}').value = this.value">
                    <input type="number" id="allowance_input_${conc.id}" value="${conc.monthlyAllowance}" min="0" max="${standardAllowance * 2}"
                           oninput="document.getElementById('allowance_slider_${conc.id}').value = this.value">
                </div>
            </div>
        `;
    });
    
    const options = [{
        htmlContent: `<i class="fas fa-check"></i> 确认调整`,
        callback: () => confirmAllowanceAdjustments()
    }];

    showDecisionCard('恩威并施', 'fa-balance-scale', contentHTML, options);
}

/**
 * 确认并应用月例调整
 */
function confirmAllowanceAdjustments() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    const currentTier = financialTiers.find(t => t.level === gameState.finances.financialTier);
    const standardAllowance = currentTier?.expenses.concubine || 50;
    
    let logParts = [];

    concubines.forEach(conc => {
        const oldAllowance = conc.monthlyAllowance;
        const newAllowance = parseInt(document.getElementById(`allowance_input_${conc.id}`).value);
        
        if (isNaN(newAllowance) || newAllowance < 0) return;

        conc.monthlyAllowance = newAllowance;

        if (newAllowance > oldAllowance) {
            const favorGain = Math.floor((newAllowance - oldAllowance) / 20);
            applyEffects({relationship: {targetId: conc.id, favor: favorGain}});
            logParts.push(`<strong class="highlight-npc">${conc.name}</strong>的月例增加，她对你更加恭顺。`);
        } else if (newAllowance < oldAllowance) {
            const favorLoss = Math.floor((oldAllowance - newAllowance) / 15);
            applyEffects({relationship: {targetId: conc.id, favor: -favorLoss}});
            logParts.push(`<strong class="highlight-npc">${conc.name}</strong>的月例被削减，她心怀不满。`);
        }
    });

    if (logParts.length > 0) {
        showEventCard('调整份例', 'fa-balance-scale', '你重新调整了后宅的份例：<br> - ' + logParts.join('<br> - '));
    } else {
        showToast("未做任何调整。");
    }
}

// ===================== 【替换】interactWithSpouse 函数 START =====================
function interactWithSpouse(action) {
    if (!gameState.marriage.isMarried) return;
    const spouseId = gameState.marriage.spouseId;
    if(!spouseId) return;

    if (action === 'chat') {
        const events = gameState.player.gender === 'male' ? wifeInteractionEvents : husbandInteractionEvents;
        const event = getRandomElement(events);
        applyEffects({ relationship: { targetId: spouseId, favor: event.favor_change } });
        showEventCard('夫妻闲聊', 'fa-comments', event.text + ` 恩爱值${event.favor_change > 0 ? '+' : ''}${event.favor_change}。`);
    } 
    else if (action === 'sleep') {
        // 新增行动点检
        const motherId = gameState.player.gender === 'female' ? 'player' : spouseId;
        triggerBirth(motherId, false);
        applyEffects({ relationship: { targetId: spouseId, favor: getRandomInt(5, 12) } });
    } 
    else if (action === 'accompany') {
        logEvent("你为正在读书的夫君红袖添香，他抬眼望你，眼中满是柔情。");
        applyEffects({ relationship: { targetId: spouseId, favor: 2 } });
        showToast("恩爱值+2");
    }
    renderGame();
}
// ===================== 【替换】interactWithSpouse 函数 END =====================

function showConcubineAcquisition() {
    if (gameState.marriage.concubines.length >= 5) {
        showToast("妾室名额已满。"); return;
    }
    showMatchmaker(true);
}
// =======================================================================
// ================== 【新增】女性视角-夫君互动核心函数 ==================
// =======================================================================

function updateHusbandState() {
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (!spouse || gameState.player.gender !== 'female') return;

    // 优先处理负面状态
    if (spouse.health < 50) {
        spouse.dynamicState = '身心俱疲';
        return;
    }
    const rel = gameState.social.relationships[spouse.id];
    if (rel && rel.trust < 30) {
        spouse.dynamicState = '疑窦丛生';
        return;
    }
    
    // 根据事业状况判断
    const career = spouse.career; // 假设丈夫也有简化的career对象
    if (career && career.performance > 150) { // 假设功绩高
        spouse.dynamicState = '意气风发';
    } else if (career && career.performance < 20) { // 假设功绩低
        spouse.dynamicState = '心烦意乱';
    } else {
        spouse.dynamicState = '闲情逸致';
    }
}

function showHusbandInteractionUI() {
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (!spouse) return;

    updateHusbandState(); // 每次打开都刷新状态
    
    const renderCategory = (category) => {
        let html = '';
        HUSBAND_INTERACTION_DATA[category].forEach(action => {
            let disabled = false;
            let reason = '';
            
            // 检查状态要求
            if (action.req.state && !action.req.state.includes(spouse.dynamicState)) {
                disabled = true;
                reason += `(夫君需${action.req.state.join('/')}) `;
            }
            if (action.req.state_not && action.req.state_not.includes(spouse.dynamicState)) {
                disabled = true;
                reason += `(夫君不可${action.req.state_not.join('/')}) `;
            }
            // 检查属性要求
            if (action.req.wisdom && gameState.player.attributes.wisdom < action.req.wisdom) {
                disabled = true;
                reason += `(智慧≥${action.req.wisdom}) `;
            }
            if (action.req.charm && gameState.player.attributes.charm < action.req.charm) {
                disabled = true;
                reason += `(魅力≥${action.req.charm}) `;
            }
            // 检查恩宠值要求
            if (action.req.favor && gameState.marriage.favor < action.req.favor) {
                disabled = true;
                reason += `(恩宠值≥${action.req.favor}) `;
            }
            // ▼▼▼ 核心修改 ▼▼▼
            // 检查掌家权要求
            if (action.req.authority && (gameState.marriage.householdAuthority.progress || 0) < action.req.authority) {
                disabled = true;
                reason += `(掌家权≥${action.req.authority}) `;
            }
            // 检查证据要求
            if (action.req.has_evidence && !gameState.flags.hasConcubineEvidence) {
                disabled = true;
                reason += `(缺少罪证) `;
            }
            // ▲▲▲ 修改结束 ▲▲▲

            html += `
                <button class="option" ${disabled ? 'disabled' : ''} onclick="handleHusbandInteraction('${category}', '${action.id}')">
                    <i class="fas fa-hand-holding-heart"></i>
                    <span class="option-text"><strong>${action.name}</strong><div><small>${action.desc} ${reason.trim()}</small></div></span>
                </button>
            `;
        });
        return html;
    };
    
    const content = `
        <div class="status-item" style="justify-content:center; margin-bottom:15px;">夫君当前状态: <strong class="value">${spouse.dynamicState}</strong></div>
        <div style="max-height: 50vh; overflow-y: auto; padding-right:5px;">
            <div class="section-header"><i class="fas fa-heart"></i> 日常情感</div>
            ${renderCategory('daily_affection')}
            <div class="section-header"><i class="fas fa-briefcase"></i> 事业辅佐</div>
            ${renderCategory('career_support')}
            <div class="section-header"><i class="fas fa-gavel"></i> 内宅议事</div>
            ${renderCategory('household_discussion')}
        </div>
    `;

    showDecisionCard(`与夫君 (${spouse.name}) 互动`, 'fa-user-friends', content, []);
}

function handleHusbandInteraction(category, actionId) {
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (!spouse) return;

    // 【核心修改】使用新的 per-NPC 计数器
    if (!checkAndUseNpcActionPoint(spouse.id)) {
        return;
    }

    const action = HUSBAND_INTERACTION_DATA[category]?.find(a => a.id === actionId);

    if (!action) {
        console.error("无法找到互动项:", actionId);
        return;
    }

    if (action.req) {
        if (action.req.favor && gameState.marriage.favor < action.req.favor) {
            showToast(`恩宠值不足 ${action.req.favor}`); return;
        }
        if (action.req.authority && (gameState.marriage.householdAuthority.progress || 0) < action.req.authority) {
            showToast(`掌家权不足 ${action.req.authority}`); return;
        }
        if (action.req.has_evidence && !gameState.flags.hasConcubineEvidence) {
            showToast("缺少关键罪证"); return;
        }
    }

    let resultText = '';

    switch(actionId) {
        case 'care_inquiry':
            if (spouse.dynamicState === '心烦意乱') {
                resultText = `他叹了口气，向你抱怨工作的烦恼。你轻柔地为他按揉太阳穴，劝他放宽心。`;
                applyEffects({ marriage: { favor: 5 }});
            } else {
                resultText = `他笑着与你分享今日的趣事，并称赞你的关怀备至。`;
                applyEffects({ marriage: { favor: 3 }});
            }
            break;
        case 'red_sleeve':
            resultText = `你在书房为他红袖添香，他读书之余，抬头望你，眼中满是柔情。`;
            applyEffects({ marriage: { favor: 4 }, attributes: { talent: 1 }});
            break;
        case 'drink_chess':
            if (gameState.player.attributes.talent > (spouse.attributes.talent || 50)) {
                resultText = `你们棋逢对手，酣畅淋漓。他对你的棋艺大加赞赏。`;
                applyEffects({ marriage: { favor: 8 }, attributes: { talent: 2 }});
            } else {
                resultText = `你虽败了半子，但过程精彩，亦是乐事。`;
                applyEffects({ marriage: { favor: 4 }});
            }
            break;
        case 'give_gift':
            if (gameState.player.privateAssets < 100) { showToast("你的私产不足100两。"); return; }
            applyEffects({ privateAssets: -100, marriage: { favor: 6 }});
            resultText = '你用私产为他准备了一份贴心的礼物，他十分欢喜。';
            break;
        case 'manage_network':
            if (gameState.player.privateAssets < 500) { showToast("私产不足。"); return; }
            applyEffects({ privateAssets: -500, marriage: { favor: 15 }});
            if (spouse.career) spouse.career.performance = (spouse.career.performance || 0) + 20;
            resultText = `你花费500两私产，以你的名义为夫君的上司送去厚礼。夫君的事业因此顺遂不少，对你感激不尽。`;
            break;
        case 'analyze_situation':
            resultText = '你为他分析了朝堂上的利害关系，并提出了应对之策，他茅塞顿开，成功化解危机。';
            applyEffects({ marriage: { favor: 20 }, attributes: { scheming: 2 } });
            break;
        case 'pillow_talk':
            showDecisionCard('吹枕边风', 'fa-bed', '夜深人静，你打算向夫君暗示些什么？', [
                {htmlContent: '【暗示掌家权】', callback: () => {
                    resultText = '“母亲大人年纪大了，掌管这么大的家业实在辛劳。妾身真希望能为母亲分忧。”你的话语巧妙地提醒了夫君。';
                    gameState.flags.authorityTransferHint = (gameState.flags.authorityTransferHint || 0) + 1;
                    showEventCard('枕边风', 'fa-bed', resultText);
                }},
                {htmlContent: '【抱怨妾室】', callback: () => {
                    const concubines = spouse.concubines.map(id => gameState.npcs[id]).filter(Boolean);
                    if (concubines.length > 0) {
                        const target = getRandomElement(concubines);
                        resultText = `你巧妙地抱怨了${target.name}的某些行为，夫君虽未多言，但已记在心里。`;
                        applyEffects({relationship: { targetId: target.id, favor: -5 }});
                    } else {
                        resultText = '你并无妾室可抱怨。';
                    }
                    showEventCard('枕边风', 'fa-bed', resultText);
                }}
            ]);
            return; 
        case 'expel_concubine':
            triggerExpelConcubineEvent();
            return;
        default:
            resultText = `你与夫君进行了一次深入的交流。`;
            break;
    }

    showEventCard(action.name, 'fa-users', resultText);
    renderGame();
}

function acquireConcubine(npcId) {
    const npc = gameState.npcs[npcId];
    const wife = gameState.marriage.isMarried ? gameState.npcs[gameState.marriage.spouseId] : null;

    if(gameState.marriage.concubines.length >= 5) { showToast("妾室名额已满。"); return; }

    const cost = { 'fyj': 10000, 'matchmaker': 1500, 'friend': 5000 }[npc.source] || 1500;
    if(gameState.finances.wealth < cost) { showToast("纳妾费用不足。"); return; }

    if (wife && wife.favor < 50 && Math.random() < 0.3) {
        const bribeStr = prompt(`${wife.name}对此事颇有微词，你愿意花费多少来安抚她？（当前私产：${gameState.finances.wealth}）`, '1000');
        const bribeCost = parseInt(bribeStr);
        if (isNaN(bribeCost) || bribeCost <= 0) {
            showEventCard('纳妾失败', 'fa-times-circle', `${wife.name}见你毫无诚意，坚决不同意纳妾。`); return;
        }
        if (gameState.finances.wealth < cost + bribeCost) { showToast("你的私产不足以支付纳妾及安抚费用。"); return; }
        
        applyEffects({wealth: -bribeCost, relationship: {targetId: wife.id, favor: -20 + Math.floor(bribeCost / 100)}});
        showEventCard('后宅风波', 'fa-donate', `你花费 <span class='value'>${bribeCost}</span> 两安抚了${wife.name}，她最终同意你纳${npc.name}为妾。`);
    }

    applyEffects({wealth: -cost});
    gameState.marriage.concubines.push(npcId);
    npc.relationship = 'concubine';

    ["suitors", "friends", "secretLovers"].forEach(listName => {
        gameState.social[listName] = gameState.social[listName]?.filter(id => id !== npcId);
    });

    showEventCard('喜得新妇', 'fa-user-plus', `你花费<span class='value'>${cost}</span>两，将 <strong class="highlight-npc">${npc.name}</strong> 纳为妾室。`);
    closeAllOverlays();
    renderGame();
    updateActiveTab('marriage');
}

function handleDivorce() {
    const spouse = gameState.npcs[gameState.marriage.spouseId];

    if (!spouse || spouse.isDead) {
        showToast("斯人已逝，尘缘已了。");
        renderGame();
        return;
    }

    const warningText = `和离乃人生大事，你真的决定要与 <strong class="highlight-npc">${spouse.name}</strong> 一别两宽吗？<br><br>
                         <small>此举将严重影响你的声誉与事业，家库财产会被分割，你还可能失去部分子女的抚养权。</small>`;
    
    const options = [
        {
            htmlContent: `<i class="fas fa-heart-broken"></i> 确认和离`,
            style: 'background:linear-gradient(135deg, #e74c3c, #c0392b);',
            callback: () => confirmDivorce()
        },
        {
            htmlContent: `<i class="fas fa-times"></i> 我再想想`,
            callback: () => closeAllOverlays()
        }
    ];

    showDecisionCard('决意和离', '💔', warningText, options);
}
// [替换]
// [新增此函数]
function triggerPunishment_Female(gs, type) {
    const husband = gs.npcs[gs.marriage.spouseId];
    const motherInLaw = gs.npcs[gs.family.members.motherId];
    let content = `你与情人之事东窗事发，夫家震怒，<strong class="highlight-npc">${husband.name}</strong>将一纸休书（或一杯毒酒）摆在你面前。在这生死关头，你决定...`;
    let options = [];

    // 选项1: 求助婆婆 (需要与婆婆关系好)
    if (motherInLaw && motherInLaw.favor > 60) {
        options.push({
            htmlContent: `<i class="fas fa-praying-hands"></i> 向婆婆求情`,
            callback: () => {
                // 婆婆出面，惩罚降级
                showEventCard('婆婆出面', 'fa-shield-alt', '在婆婆的力保之下，你免于一死，但仍被休弃，净身出户。');
                gs.flags.playerStatus = 'divorced';
                // 清理婚姻状态
                gameState.marriage.isMarried = false;
                gameState.marriage.spouseId = null;
                gameState.children = gs.children.filter(c => c.fatherId !== husband.id);
                renderGame();
            }
        });
    }

    // 选项2: 用掌家权博弈
    if ((gs.marriage.householdAuthority.progress || 0) >= 100) {
        options.push({
            htmlContent: `<i class="fas fa-key"></i> 动用掌家权`,
            callback: () => {
                showEventCard('鱼死网破', 'fa-bomb', '你以掌家权和府中秘密相要挟，夫家投鼠忌器，最终此事不了了之，但你们的夫妻关系已名存实亡。');
                applyEffects({ marriage: { favor: -100 } }); // 恩爱值降到最低
                husband.suspicionValue = 100;
            }
        });
    }

    // 选项3: 栽赃陷害 (高心计)
    if (gs.player.attributes.scheming > 120) {
        options.push({
            htmlContent: `<i class="fas fa-theater-masks"></i> 栽赃妾室`,
            callback: () => {
                const concubines = husband.concubines.map(id=>gs.npcs[id]).filter(c=>c&&!c.isDead);
                if(concubines.length > 0) {
                    const scapegoat = getRandomElement(concubines);
                    scapegoat.isDead = true; // 成为替罪羊
                     husband.concubines = husband.concubines.filter(id => id !== scapegoat.id);
                    showEventCard('栽赃陷害', 'fa-user-secret', `你用高明手段，将一切栽赃给妾室<strong class="highlight-npc">${scapegoat.name}</strong>，她成了你的替罪羊。你暂时安全了，但品德大损。`);
                    applyEffects({ attributes: { virtue: -30 } });
                } else {
                     showEventCard('无计可施', 'fa-times', `后院并无她人，你找不到可以栽赃的对象。`);
                }
            }
        });
    }

    // 默认选项
    options.push({
        htmlContent: `<i class="fas fa-gavel"></i> 束手就擒`,
        callback: () => {
             if (type === '休弃') {
                showEventCard('一纸休书', 'fa-file-signature', '你被净身出户，失去所有子女，声望尽毁，但总算保住了性命。');
                gs.flags.playerStatus = 'divorced';
                gameState.marriage.isMarried = false;
                gameState.marriage.spouseId = null;
                gameState.children = gs.children.filter(c => c.fatherId !== husband.id);
            } else if (type === '赐死') {
                showEndGame({ title: "红颜薄命", text: `你因“不贞”被夫家赐死，年仅${Math.floor(gs.player.age)}岁。` });
            }
        }
    });

    showDecisionCard('生死关头', 'fa-heartbeat', content, options);
}
function confirmDivorce() {
    const exSpouseId = gameState.marriage.spouseId;
    const exSpouse = gameState.npcs[exSpouseId];

    applyEffects({attributes: {reputation: -50, virtue: -20}});
    if(gameState.career.path) {
        gameState.career.performance = Math.max(0, gameState.career.performance - 50);
        applyEffects({relationship:{targetId: gameState.career.supervisorId, favor: -20}});
    }

    const moneyToKeep = Math.floor(gameState.family.moneyChest * (gameState.player.gender === 'female' ? 0.7 : 0.3));
    gameState.family.moneyChest = 0;
    applyEffects({ wealth: moneyToKeep });

    const childrenOfMarriage = gameState.children.filter(c => (c.motherId === exSpouseId || (c.fatherId === 'player' && c.motherId === exSpouse.id)));
    let childrenWithPlayer = gameState.children.filter(c => !childrenOfMarriage.includes(c));
    let childrenWithSpouse = [];

    childrenOfMarriage.forEach(child => {
        (gameState.player.attributes.virtue > exSpouse.attributes.virtue || Math.random() < 0.7 ? childrenWithPlayer : childrenWithSpouse).push(child);
    });
    gameState.children = childrenWithPlayer;
    
    const lostChildrenNames = childrenWithSpouse.length > 0 ? `你的孩子 ${childrenWithSpouse.map(c => c.name).join('、')} 将由对方抚养。` : '';
    const breakupLog = `你与<strong class="highlight-npc">${exSpouse.name}</strong>和离，分割家产后你分得 <span class='value'>${moneyToKeep}</span> 两。${lostChildrenNames}此事在京中引起议论，你的声望受到影响。`;
    
    showEventCard('一别两宽', 'fa-heart-broken', breakupLog);
    
    gameState.marriage.isMarried = false;
    gameState.marriage.spouseId = null;
    gameState.marriage.favor = 0;
    applyEffects({relationship: { targetId: exSpouseId, favor: -100 }});
    exSpouse.relationship = 'stranger';

    if (gameState.player.gender === 'male' && gameState.marriage.concubines.length > 0) {
        const concubineToPromote = gameState.marriage.concubines.map(id => gameState.npcs[id]).sort((a,b) => b.favor - a.favor)[0];
        if (concubineToPromote) {
            const options = [
                {htmlContent: `扶为正妻`, callback: () => promoteConcubine(concubineToPromote.id)},
                {htmlContent: `暂不考虑`, callback: () => closeAllOverlays()}
            ];
            showDecisionCard('扶正妾室', 'fa-chess-queen', `你如今孑然一身，是否要将妾室${concubineToPromote.name}扶为正妻？`, options);
        }
    }
    renderGame();
}
/**
 * 【新增】触发“维系信任”随机事件的核心函数
 * @param {string} type - 'gift', 'talk', 'accompany'
 */
function triggerTrustEvent(type) {
    // [修复] 检查独立的信任互动计数器
    if ((gameState.flags.actionUsed_trustActions || 0) >= 2) {
        showToast("本回合维系信任的次数已用尽。");
        return;
    }

    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (!spouse) {
        showToast("你尚未成家。");
        return;
    }

    // 根据玩家性别选择事件库
    const eventPool = gameState.player.gender === 'male' ? MALE_TRUST_EVENTS[type] : FEMALE_TRUST_EVENTS[type];
    if (!eventPool || eventPool.length === 0) {
        showToast("暂无此类互动事件。");
        return;
    }

    const event = getRandomElement(eventPool);

    const options = event.options.map(opt => {
        let canChoose = true;
        let reason = '';
        if (opt.cost) {
            if (opt.cost.wealth && gameState.finances.wealth < opt.cost.wealth) {
                canChoose = false;
                reason = `(私产不足 ${opt.cost.wealth} 两)`;
            }
        }
        if (opt.req) {
            for (const attr in opt.req) {
                if ((gameState.player.attributes[attr] || 0) < opt.req[attr]) {
                    canChoose = false;
                    reason = `(${ATTR_MAP[attr]}需≥${opt.req[attr]})`;
                    break;
                }
            }
        }

        return {
            htmlContent: `<span class="option-text">${opt.text} ${reason}</span>`,
            disabled: !canChoose,
            callback: () => {
                // [修复] 在回调函数内部，先增加使用次数
                gameState.flags.actionUsed_trustActions = (gameState.flags.actionUsed_trustActions || 0) + 1;

                // 扣除成本
                if (opt.cost && opt.cost.wealth) {
                    applyEffects({ wealth: -opt.cost.wealth });
                }

                // 应用效果
                if (opt.effects) {
                    if (opt.effects.suspicion) {
                        spouse.suspicionValue = Math.max(0, (spouse.suspicionValue || 0) + opt.effects.suspicion);
                    }
                    if (opt.effects.favor) {
                        applyEffects({ marriage: { favor: opt.effects.favor }});
                    }
                    if (opt.effects.reputation) {
                        applyEffects({ reputation: opt.effects.reputation });
                    }
                }

                showEventCard(event.title, 'fa-shield-alt', opt.log);
                renderGame();
            }
        };
    });

    showDecisionCard(event.title, 'fa-shield-alt', event.desc, options);
}
function promoteConcubine(concubineId) {
    const concubineToPromote = gameState.npcs[concubineId];
    gameState.marriage.isMarried = true;
    gameState.marriage.spouseId = concubineToPromote.id;
    applyEffects({ relationship: { targetId: concubineId, favor: 20 } });
    gameState.marriage.concubines = gameState.marriage.concubines.filter(cid => cid !== concubineId);
    concubineToPromote.relationship = 'spouse';

    gameState.children.forEach(child => {
        if(child.motherId === concubineId) child.isSecret = false; 
    });

    showEventCard('喜结连理', 'fa-ring', `你将<strong class="highlight-npc">${concubineToPromote.name}</strong>扶为正妻。她的孩子们也成为了嫡出。`);
    renderGame();
}
function updateInfidelityRisk() {
    if (gameState.player.gender !== 'male' || !gameState.marriage.isMarried) return;
    const wife = gameState.npcs[gameState.marriage.spouseId];
    if(!wife) return;

    if (gameState.flags.brothelVisitCount > 30 && Math.random() < 0.3) {
        showEventCard('后宅不宁', '💔', `你流连风月场所之事终究传到了夫人<strong class="highlight-npc">${wife.name}</strong>耳中，她心灰意冷，向你提出和离。`);
        confirmDivorce();
        return;
    }

    const mostFavoredConcubine = gameState.marriage.concubines
        .map(id => gameState.npcs[id])
        .filter(c => c && !c.isDead)
        .sort((a, b) => b.favor - a.favor)[0];

    if (mostFavoredConcubine && mostFavoredConcubine.favor > wife.favor + 20 && wife.favor < 60) {
        wife.infidelityRisk = (wife.infidelityRisk || 0) + 1; // 1 turn is half a year
        if (wife.infidelityRisk >= 6) { // 3 years
            wife.infidelityRisk = 0;
            showEventCard('后宅起火', '😱', `你发现正妻${wife.name}因被冷落，与人有染！恩爱值大幅下降。`);
            applyEffects({relationship:{targetId: wife.id, favor: -50}, attributes: {reputation: -20}});
        }

        if(wife.infidelityRisk >= 30) { // 15 years...
            const targetChild = gameState.children.find(c => c.motherId === wife.id && c.age >= 16);
            if(targetChild) {
                targetChild.fatherId = `unknown_${Date.now()}`;
                showEventCard('惊天秘闻', '😱', `你偶然发现，你抚养多年的嫡子/女 <strong class="highlight-npc">${targetChild.name}</strong> 竟非你亲生！`);
                applyEffects({attributes: {health: -20}});
                wife.infidelityRisk = -999; // event triggered
            }
        }
    } else {
        if(wife.infidelityRisk > 0) wife.infidelityRisk--;
    }
}

// ================= 【最终决定版·宅斗系统完整模块】 =================
function hasAnyConcubineKeyEvidence() {
    // 优先检查官方的逻辑标记
    if (gameState.flags.hasConcubineEvidence) {
        return true;
    }
    // 如果逻辑标记不存在（比如通过旧的开发者模式生成），则检查所有妾室是否有“显示标记”
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || !husband.concubines) return false;
    
    return husband.concubines
        .map(id => gameState.npcs[id])
        .some(c => c && !c.isDead && c.keyEvidence);
}
function updateExpelButtonState() {
    const expelButton = document.getElementById('expel-concubine-btn');
    const expelButtonDesc = document.getElementById('expel-concubine-desc');
    if (!expelButton || !expelButtonDesc) return;

    // 【核心修改】使用新的、更可靠的检查函数
    const canExpel = hasAnyConcubineKeyEvidence();

    if (canExpel) {
        expelButton.disabled = false;
        expelButtonDesc.innerHTML = '证据确凿，可以处置了！';
    } else {
        expelButton.disabled = true;
        expelButtonDesc.innerHTML = '需: 合成关键罪证';
    }
}

/**
 * 【修复后的开发者函数】
 * 修复了您之前版本只改显示、不改逻辑的问题。
 * 注意：hasConcubineEvidence 标记一次只能指向一个人。
 */
function debug_generateAllEvidence() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || !husband.concubines || husband.concubines.length === 0) {
        showToast("错误：夫君不存在或尚无妾室。");
        return;
    }
    
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    if (concubines.length === 0) {
        showToast("没有妾室可以生成证据。");
        return;
    }

    let names = [];
    concubines.forEach((conc, index) => {
        // 1. 设置UI显示属性
        conc.keyEvidence = '罪证确凿，已整理成册 (由开发者模式生成)';
        names.push(conc.name);
        
        // 2. 【核心修复】同时设置后台逻辑标记！
        // 默认将标记指向第一个被处理的妾室
        if (index === 0) {
            gameState.flags.hasConcubineEvidence = conc.id;
        }
    });

    showToast(`已为 ${names.join(' 和 ')} 生成了关键罪证！`);
    
    // 3. 【核心修复】生成证据后，立刻调用检查机制刷新按钮！
    updateExpelButtonState();
    closeAllOverlays();
    renderGame();
}

function showHaremReshapingUI() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband ? husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead) : [];

    const options = [
        {
            htmlContent: `<i class="fas fa-gavel"></i><span class="option-text"><strong>敲山震虎</strong><div><small>公开惩罚一位妾室以立威</small></div></span>`,
            disabled: concubines.length === 0,
            callback: () => handleAssertDominance()
        },
        {
            htmlContent: `<i class="fas fa-balance-scale"></i><span class="option-text"><strong>恩威并施</strong><div><small>调整妾室们的月例份例</small></div></span>`,
            disabled: concubines.length === 0,
            callback: () => handleCarrotAndStick()
        },
        {
            htmlContent: `<i class="fas fa-search-minus"></i><span class="option-text"><strong>釜底抽薪</strong><div><small>暗中调查妾室，收集零散证据</small></div></span>`,
            disabled: concubines.length === 0 || (gameState.player.attributes.scheming || 0) < 60,
            callback: () => startInvestigation()
        },
        {
            htmlContent: `<i class="fas fa-folder-open"></i><span class="option-text"><strong>罪证管理</strong><div><small>查看并整合你收集到的所有证据</small></div></span>`,
            callback: () => showEvidenceManagementUI()
        },
        {
            // 为按钮和描述添加了ID，以便JS可以精确控制它们
            htmlContent: `<button id="expel-concubine-btn" class="option" style="width:100%; padding:0; border:none; background:transparent; color:white;" onclick="triggerExpelConcubineEvent()">
                            <i class="fas fa-user-times"></i><span class="option-text"><strong>驱赶恶妾</strong>
                            <div id="expel-concubine-desc"><small>需: 合成关键罪证</small></div></span>
                         </button>`
        }
    ];
    
    let optionsHTML = '';
    options.forEach(opt => {
        if(opt.callback) {
            optionsHTML += `<button class="option" ${opt.disabled ? 'disabled' : ''} onclick="this.disabled=true; (${opt.callback.toString()})()">${opt.htmlContent}</button>`;
        } else {
            optionsHTML += opt.htmlContent;
        }
    });

    showDecisionCard('后宅秩序重塑', 'fa-theater-masks', '你手握生杀大权，后宅的每一个角落都必须在你的掌控之中。', optionsHTML);

    // 【核心检查点1】界面显示后，立刻调用检查机制更新按钮初始状态
    setTimeout(updateExpelButtonState, 50);
}
function compileKeyEvidence(concubineId) {
    const target = gameState.npcs[concubineId];
    if (!target) return;
    
    // 同时设置后台逻辑flag和UI显示属性，确保统一
    gameState.flags.hasConcubineEvidence = target.id;
    target.keyEvidence = '罪证确凿，已整理成册';
    
    if (target.evidence) { target.evidence = { morality: [], finance: [], background: [] }; }
    
    showEventCard('罪证确凿', 'fa-gavel', `你已将所有关于 <strong class="highlight-npc">${target.name}</strong> 的零散证据整理成册，形成了足以定罪的关键证据！`);
    showEvidenceManagementUI();
    updateExpelButtonState();
}

function showEvidenceManagementUI() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || !husband.concubines || husband.concubines.length === 0) {
        showToast("后宅尚无妾室可管理罪证。");
        return;
    }
    let contentHTML = `<p class="comment" style="text-align:center;">此处陈列着你暗中收集的、关于各位妾室的证据。集齐三类罪证，方可合成关键证据，将其定罪。</p>`;
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    concubines.forEach(conc => {
        if (!conc.evidence) conc.evidence = { morality: [], finance: [], background: [] };
        const evidence = conc.evidence;
        const canCompile = evidence.morality.length > 0 && evidence.finance.length > 0 && evidence.background.length > 0;
        contentHTML += `<div class="section-header" style="margin-top:20px;">${conc.name}</div>`;
        if (conc.keyEvidence) {
            contentHTML += `<div class="inventory-container" style="max-height:none;"><div class="inventory-item" style="border-left: 4px solid #c0392b;"><div class="inventory-item-icon"><i class="fas fa-gavel"></i></div><div class="inventory-item-details"><div class="inventory-item-name">关键罪证</div><div class="inventory-item-desc">${conc.keyEvidence}</div></div></div></div>`;
        } else {
            contentHTML += `<div class="inventory-container" style="max-height:none;"><div class="inventory-item"><div class="inventory-item-icon"><i class="fas fa-theater-masks"></i></div><div class="inventory-item-details"><div class="inventory-item-name">私德不端 <span class="inventory-item-type">${evidence.morality.length}/1</span></div><div class="inventory-item-desc">${evidence.morality.join('、') || '暂无'}</div></div></div><div class="inventory-item"><div class="inventory-item-icon"><i class="fas fa-file-invoice-dollar"></i></div><div class="inventory-item-details"><div class="inventory-item-name">贪墨财物 <span class="inventory-item-type">${evidence.finance.length}/1</span></div><div class="inventory-item-desc">${evidence.finance.join('、') || '暂无'}</div></div></div><div class="inventory-item"><div class="inventory-item-icon"><i class="fas fa-user-secret"></i></div><div class="inventory-item-details"><div class="inventory-item-name">背景不纯 <span class="inventory-item-type">${evidence.background.length}/1</span></div><div class="inventory-item-desc">${evidence.background.join('、') || '暂无'}</div></div></div></div>${!conc.keyEvidence && canCompile ? `<button class="option" style="margin-top:10px; background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="compileKeyEvidence('${conc.id}')"><i class="fas fa-gavel"></i> 合成关键罪证</button>` : ''}`;
        }
    });
    showDecisionCard('罪证管理', 'fa-folder-open', contentHTML, []);
}

/**
 * 触发驱逐妾室的最终弹窗 (保持最新)
 */
function triggerExpelConcubineEvent() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || !husband.concubines) return;

    let targetConcubine = null;

    // 优先通过官方的逻辑标记查找
    if (gameState.flags.hasConcubineEvidence) {
        targetConcubine = gameState.npcs[gameState.flags.hasConcubineEvidence];
    } 
    // 如果找不到，则通过“显示标记”进行后备查找
    else {
        targetConcubine = husband.concubines
            .map(id => gameState.npcs[id])
            .find(c => c && !c.isDead && c.keyEvidence);
    }
    
    if (!targetConcubine) {
        showToast("错误：未找到持有关键罪证的目标。请重新进入此界面。");
        delete gameState.flags.hasConcubineEvidence;
        updateExpelButtonState();
        return;
    }
    
    const options = [
        {
            htmlContent: `【驱逐】`, 
            style: 'background: linear-gradient(135deg, #e74c3c, #c0392b);', 
            callback: () => {
                const motherInLaw = gameState.npcs[gameState.family.members.motherId];
                let resultText;
                if (motherInLaw && (motherInLaw.favor || 50) < 0) {
                    resultText = `铁证如山，但婆婆却坚决维护${targetConcubine.name}。在她的阻挠下，最终${targetConcubine.name}仅被送往家庙，终身监禁。`;
                } else {
                    resultText = `铁证如山，${targetConcubine.name}被剥夺身份，逐出家门，永不许回。`;
                }
                husband.concubines = husband.concubines.filter(id => id !== targetConcubine.id);
                targetConcubine.isDead = true; 
                gameState.marriage.familyHarmony = Math.min(100, gameState.marriage.familyHarmony + 20);
                applyEffects({ reputation: 10 });
                delete gameState.flags.hasConcubineEvidence;
                targetConcubine.keyEvidence = null;
                showEventCard('清理门户', 'fa-gavel', resultText);
                updateActiveTab('marriage');
            }
        },
        {
            htmlContent: '【宽恕】', 
            callback: () => {
                showEventCard('妇人之仁', 'fa-hand-holding-heart', '你选择了再给她一次机会，但她未必会感恩。你销毁了证据。');
                delete gameState.flags.hasConcubineEvidence;
                targetConcubine.keyEvidence = null;
                showHaremReshapingUI();
            }
        }
    ];

    showDecisionCard(`处置 ${targetConcubine.name}`, 'fa-gavel', `你已掌握妾室<strong class="highlight-npc">${targetConcubine.name}</strong>的致命罪证。你决定如何处置她？`, options);
}
/**
 * 启动调查流程 (保持最新)
 */
function startInvestigation() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);

    if (gameState.flags.investigatingConcubine) {
        const target = gameState.npcs[gameState.flags.investigatingConcubine.targetId];
        showToast(`你已经在调查 ${target.name} 了，请耐心等待结果。`);
        return;
    }

    const options = concubines.map(conc => ({
        htmlContent: `<div class="suitor" style="padding:5px; margin-bottom:0; cursor:pointer;"><div class="suitor-details" style="text-align:left;"><strong>${conc.name}</strong><br><small>恩宠:${conc.favor} | 野心:${conc.ambition}</small></div></div>`,
        style: `padding:10px; height:auto;`,
        callback: () => chooseInvestigationMethod(conc.id)
    }));

    showDecisionCard('选择调查对象', 'fa-search-minus', '你要对谁进行深入调查？', options);
}


/**
 * 选择调查方式 (保持最新)
 */
function chooseInvestigationMethod(concubineId) {
    const target = gameState.npcs[concubineId];

    const content = `
        <p>你决定暗中调查 <strong class="highlight-npc">${target.name}</strong>。请选择你的调查方式与方向：</p>
        
        <div class="section-header" style="margin-top:15px; font-size:1rem;">选择眼线 (决定成功率)</div>
        <select id="investigation_spy" class="self-compose-input">
            <option value="maid" data-cost="200">普通丫鬟 (花费200两，成功率较低)</option>
            <option value="mommy" data-cost="500">心腹嬷嬷 (花费500两，成功率中等)</option>
            <option value="betrayer" data-cost="1000" ${gameState.player.attributes.scheming < 80 ? 'disabled' : ''}>收买对方的丫鬟 (花费1000两，心计≥80，风险高回报高)</option>
        </select>

        <div class="section-header" style="margin-top:15px; font-size:1rem;">选择调查方向 (决定罪证类型)</div>
        <select id="investigation_direction" class="self-compose-input">
            <option value="morality">调查私德 (通奸, 虐仆)</option>
            <option value="finance">调查财务 (偷盗, 贪墨)</option>
            <option value="background">调查身世 (伪造背景, 隐藏过往)</option>
        </select>
    `;

    const options = [{
        htmlContent: `<i class="fas fa-check"></i> 开始布局`,
        callback: () => confirmInvestigation(concubineId)
    }];

    showDecisionCard('布局调查', 'fa-users-cog', content, options);
}


/**
 * 确认调查 (保持最新)
 */
function confirmInvestigation(concubineId) {
    const spySelect = document.getElementById('investigation_spy');
    const directionSelect = document.getElementById('investigation_direction');

    const spyType = spySelect.value;
    const direction = directionSelect.value;
    const cost = parseInt(spySelect.options[spySelect.selectedIndex].getAttribute('data-cost'));
    
    if (gameState.player.privateAssets < cost) {
        showToast("你的私产不足以支付眼线的费用！");
        return;
    }

    applyEffects({ privateAssets: -cost });

    gameState.flags.investigatingConcubine = {
        targetId: concubineId,
        spyType: spyType,
        direction: direction,
        turnsLeft: 2, 
        progress: 0,
        alertness: 0 
    };

    showEventCard('开始调查', 'fa-search-minus', `你花费 <span class="value">${cost}</span> 两私产，派出了眼线暗中调查。预计2回合后会有结果。`);
    renderGame();
}


/**
 * 每回合检查调查进度 (保持最新)
 */
function checkForInvestigationCompletion() {
    const investigation = gameState.flags.investigatingConcubine;
    if (!investigation) return;

    investigation.turnsLeft--;
    const target = gameState.npcs[investigation.targetId];
    if (!target) {
        delete gameState.flags.investigatingConcubine;
        return;
    }

    let eventText = null;
    const roll = Math.random();
    if (roll < 0.2) { 
        if (investigation.spyType === 'betrayer' && Math.random() < 0.3) {
            investigation.alertness += 50; 
            const husband = gameState.npcs[gameState.marriage.spouseId];
            husband.suspicionValue = (husband.suspicionValue || 0) + 15;
            eventText = `你的眼线竟是个双面间谍！她将你的计划告知了<strong class="highlight-npc">${target.name}</strong>，对方在你夫君面前哭诉你妒忌贤能，夫君对你的疑心增加了！`;
            eventQueue.push(() => showEventCard('反间计', 'fa-exclamation-triangle', eventText));
        } else {
            investigation.alertness += 20;
            eventText = `你的眼线行事不密，似乎惊动了<strong class="highlight-npc">${target.name}</strong>，她最近警惕了许多。`;
            eventQueue.push(() => showEventCard('打草惊蛇', 'fa-eye', eventText));
        }
    }

    if (investigation.turnsLeft <= 0) {
        let successRate = 0;
        switch (investigation.spyType) {
            case 'maid': successRate = 0.4; break;
            case 'mommy': successRate = 0.65; break;
            case 'betrayer': successRate = 0.85; break;
        }
        successRate -= investigation.alertness / 100;

        let resultTitle, resultIcon, resultContent;
        if (Math.random() < successRate) {
            const secrets = {
                morality: ["一封与护院的私信", "虐待粗使丫鬟的证词", "一个写有嫡子生辰八字的巫蛊娃娃"],
                finance: ["一张她私藏的当票", "一份她克扣下人月钱的账本"],
                background: ["一封证明她伪造出身的信件", "一份她曾与人有过婚约的旧凭证"]
            };
            const foundSecret = getRandomElement(secrets[investigation.direction]);
            
            resultTitle = '釜底抽薪';
            resultIcon = 'fa-file-signature';
            resultContent = `调查有了结果！你成功获得了关于 <strong class="highlight-npc">${target.name}</strong> 的一份证据：<strong class="value">【${foundSecret}】</strong>。`;
            
            if (!target.evidence) {
                target.evidence = { morality: [], finance: [], background: [] };
            }
            target.evidence[investigation.direction].push(foundSecret);
        } else {
            resultTitle = '一无所获';
            resultIcon = 'fa-times-circle';
            resultContent = `你的眼线回报，<strong class="highlight-npc">${target.name}</strong> 行事滴水不漏，未能找到任何把柄。`;
        }

        eventQueue.push(() => {
            showEventCard(resultTitle, resultIcon, resultContent);
        });

        delete gameState.flags.investigatingConcubine;
    }
}
// ================= 【最终决定版·宅斗系统完整模块】 END =================// ========================= CHILDREN & HEIRS ============================
// =======================================================================
// [用这个新版本替换]
function setChildEducation(childId, eduName, eduCost) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;
    
    // 【核心修改】为孩子对象增加“抚养成本”属性并累加
    if (!child.upbringingCost) {
        child.upbringingCost = 0;
    }
    child.upbringingCost += eduCost;
    // --- 修改结束 ---

    child.education = {
        name: eduName,
        cost: eduCost
    };
    
    showToast(`${child.name}的教育方针已设定为【${eduName}】。`);
    // 刷新界面以显示最新选择
    showChildRearing(childId);
}
function triggerBirth(partnerId, isSecret = false) {
    const partner = gameState.npcs[partnerId];
    if (!partner) return;

    // 添加日志，让玩家知道发生了什么
    logEvent(`<div class="intimate-scene"><i class="fas fa-moon"></i> 夜色深沉，红烛摇曳...</div>`);

    const totalCapacity = gameState.finances.assets.filter(c => c.type === 'residence').reduce((sum, r) => sum + r.capacity, 5);
    const currentOccupants = 1 + (gameState.marriage.isMarried ? 1 : 0) + gameState.marriage.concubines.length + gameState.children.filter(c=>!c.isDead).length;
    if (currentOccupants >= totalCapacity) { showToast("家中已无处可住，无法再添丁了。请先购置更大的府邸。"); return; }

    const motherNPC = gameState.player.gender === 'female' ? gameState.player : partner;
    const fatherNPC = gameState.player.gender === 'male' ? gameState.player : partner;

    const playerChildrenCount = gameState.children.filter(c => (c.motherId === 'player' || c.fatherId === 'player') && !c.isDead).length;

    if (playerChildrenCount >= 10) { showToast("你已育有十个孩子，难以再有孕。"); return; }
    if (gameState.player.gender === 'male' && partner.relationship === 'concubine' && gameState.children.filter(c => c.motherId === partnerId).length >= 3) { showToast(`妾室${partner.name}已诞下三胎，再难有孕。`); return; }
    if (motherNPC.isPregnant) {
        showToast(`${motherNPC.name}已身怀六甲，请耐心等待。`);
        return;
    }

    let baseConceptionChance = 0.35;
    if (motherNPC.age > 35) baseConceptionChance *= 0.5;
    if (motherNPC.age > 45) baseConceptionChance *= 0.3;
    if (motherNPC.age > 55) baseConceptionChance = 0.1;
    if (motherNPC.age >= 70) baseConceptionChance = 0; // 70岁不能怀孕

    if (playerChildrenCount >= 7) baseConceptionChance *= 0.7;

    if (Math.random() < baseConceptionChance) {
        // 怀孕成功，只设置状态，不立即生产！
        motherNPC.isPregnant = true;
        motherNPC.pregnancyTurnsLeft = 2; 
        motherNPC.isSecretPregnancy = isSecret;
        logEvent(`<strong class="highlight-npc">${motherNPC.name}</strong>已身怀六甲，你对新生命的到来充满期待。`);
    } else {
        logEvent(`似乎天意未至，<strong class="highlight-npc">${motherNPC.name}</strong>本回合未能怀上。`);
    }
    renderGame();
}
function triggerBirthSuccess(motherId, isSecret) {
    const motherNPC = motherId === 'player' ? gameState.player : gameState.npcs[motherId];
    const fatherNPC = gameState.player.gender === 'male' ? gameState.player : gameState.npcs[partnerId];

    const gender = Math.random() > 0.5 ? 'male' : 'female';
    const newChild = {
        id: `child_${Date.now()}`, gender: gender, age: 0, isDead:false,
        motherId: motherId, fatherId: fatherNPC.id,
        isSecret: isSecret,
        attributes: {}, personality: [], cultivationLog: [],
        marriage: { isMarried: false, spouseId: null },
        education: null, allowance: 0, career: null,
        avatar: getRandomElement(avatarPools[gender])
    };
    // ... 孩子属性生成代码 ...
    gameState.children.push(newChild);
    showNameChildOverlay(newChild.id, motherNPC.name, newChild.isSecret);
}

// 新增函数：处理难产抉择
// [替换] 找到这个函数并用下面的代码完整替换
function pregnancyCheck(motherId, isSecret) {
    const mother = motherId === 'player' ? gameState.player : gameState.npcs[motherId];
    if (mother && mother.isPregnant) {
        mother.pregnancyTurnsLeft--;
        if (mother.pregnancyTurnsLeft <= 0) {
            // 将分娩事件推入事件队列的最前端，确保它最先执行
            eventQueue.unshift(() => {
                handleBirthEvent(motherId, mother.isSecretPregnancy);
            });
            
            // 清理怀孕状态
            delete mother.isPregnant;
            delete mother.pregnancyTurnsLeft;
            delete mother.miscarriageChance;
            delete mother.isSecretPregnancy;
            
            // 返回true，告诉主循环本回合有重大事件发生
            return true; 
        }
    }
    // 没有分娩事件发生
    return false;
}
// [用这个新版本替换] childrenGrowUp 函数
// ===================== 【新功能】子女职业规划函数 =====================
function triggerChildCareerChoice(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const careerList = childCareerAssignment[child.gender];
    let optionsHTML = [];

    for (const pathId in careerList) {
        if (pathId === "待业") continue;
        const careerData = careerList[pathId];
        const reqText = Object.entries(careerData.req).map(([attr, val]) => `${ATTR_MAP[attr]}≥${val}`).join(', ');

        // [修复] 修正了获取职业图标的错误路径
        const careerIcon = PROFESSION_DATA[pathId] ? PROFESSION_DATA[pathId].icon : 'fa-question-circle';

        optionsHTML.push({
            htmlContent: `
                <i class="fas ${careerIcon}"></i>
                <span class="option-text">
                    <strong>${pathId}</strong>
                    <div><small>要求: ${reqText}</small></div>
                </span>`,
            callback: () => {
                child.careerPathChosen = pathId;
                showEventCard('立下志向', 'fa-flag', `你为${child.name}定下了成为一名【${pathId}】的目标，TA将在接下来的几年里为此努力。`);
                renderGame();
            }
        });
    }

    showDecisionCard(
        '前路抉择', 
        'fa-graduation-cap', 
        `你的孩子 <strong class="value">${child.name}</strong> 已经15岁，到了规划未来的年纪。你希望TA向哪个方向发展？<br><small>（这会影响TA未来三年的属性成长侧重）</small>`,
        optionsHTML
    );
}
function childrenGrowUp() {
    gameState.children.forEach(child => {
        if(child.isDead) return;
        child.age += 0.5;
        // --- 属性成长逻辑 ---
        let growthRates = { wisdom: 1, talent: 1, charm: 1, health: 1, etiquette: 1, virtue: 1, martial: 1, reputation: 0.1 };
        if (child.education) {
            const currentTier = financialTiers.find(t => t.level === gameState.finances.financialTier);
            const eduOption = currentTier.expenses.child_edu.find(e => e.name === child.education.name);
            if (eduOption && eduOption.effect) {
                for (const attr in eduOption.effect) {
                    growthRates[attr] = (growthRates[attr] || 1) + (eduOption.effect[attr] || 0);
                }
            }
        }
        if (child.careerPathChosen && child.careerPathChosen !== 'pending') {
            const careerReq = childCareerAssignment[child.gender][child.careerPathChosen].req;
            for (const attr in careerReq) {
                growthRates[attr] = (growthRates[attr] || 1) * 2;
            }
        }
        for (const attr in growthRates) {
            const growth = Math.random() * growthRates[attr];
            child.attributes[attr] = (child.attributes[attr] || 0) + growth;
            child.attributes[attr] = Math.max(0, child.attributes[attr]);
        }
        child.attributes.health = Math.min(100, (child.attributes.health || 100) + 1);
        // --- 夭折、事件、成年等逻辑 ---
        if (child.age < 5 && child.attributes.health < 80 && Math.random() < 0.02) {
            child.isDead = true;
            showEventCard('天有不测', '🕯️', `天有不测风云，你的孩子 <strong class="highlight-npc">${child.name}</strong> 不幸夭折了...你悲痛万分。`);
            applyEffects({attributes: {virtue: -10}});
            return;
        }
        const ageMilestone = Math.floor(child.age);
        if (!child.triggeredEvents) child.triggeredEvents = [];
        if (CHILD_LIFE_EVENTS[ageMilestone] && !child.triggeredEvents.includes(ageMilestone)) {
            child.triggeredEvents.push(ageMilestone);
            const eventPool = CHILD_LIFE_EVENTS[ageMilestone];
            const event = getRandomElement(eventPool);
            eventQueue.push(() => {
                const eventDesc = event.desc.replace(/{childName}/g, `<strong class="value">${child.name}</strong>`);
                const options = event.options.map((opt, index) => ({
                    htmlContent: `<span class="option-text">${opt.text}</span>`,
                    callback: () => handleChildLifeEventResult(child.id, event.id, index)
                }));
                showDecisionCard(event.title, 'fa-child', eventDesc, options);
            });
        }
        
        if (child.age >= 15 && !child.careerPathChosen) {
            child.careerPathChosen = 'pending';
            eventQueue.push(() => triggerChildCareerChoice(child.id));
        }
        if (child.age >= 18 && child.careerPathChosen && child.careerPathChosen !== 'pending' && !child.career) {
            assignChildCareer(child);
        }
        
        // --- 子女职业晋升与赡养费逻辑 ---
        if (child.age >= 18 && child.career && child.career.path && child.career.path !== 'unemployed') {
            const careerData = careerPaths[child.gender][child.career.path];
            
            // 职业晋升
            if (child.career.level < careerData.levels.length - 1) {
                const nextLevel = careerData.levels[child.career.level + 1];
                const coreAttr = Object.keys(nextLevel.req)[0] || 'wisdom';
                const performanceGain = getRandomInt(5, 15) + Math.floor((child.attributes[coreAttr] || 0) / 10);
                child.career.performance = (child.career.performance || 0) + performanceGain;
                if (child.career.performance >= nextLevel.promotion_points) {
                    const meetsAttrReqs = Object.entries(nextLevel.req).every(([attr, val]) => (child.attributes[attr] || 0) >= val);
                    if (meetsAttrReqs) {
                        child.career.level++;
                        child.career.performance = 0;
                        child.career.salary = careerData.levels[child.career.level].salary;
                        logEvent(`你的孩子 <strong class="highlight-npc">${child.name}</strong> 勤勉能干，晋升为 <strong class="value">${careerData.levels[child.career.level].title}</strong>！`);
                    } else {
                        child.career.performance = nextLevel.promotion_points - 10;
                    }
                }
            }
            
            // 【核心修改】计算并支付赡养费 (每年结算一次)
            if (gameState.date.turn === 1 && child.career.salary > 0) {
                 // 基础赡养费为孩子年薪的10%
                 const baseSupport = Math.floor(child.career.salary * 2 * 0.1); 
                 // 亲密度加成：每10点亲密度增加1%的额外支付意愿
                 const favorBonus = Math.floor(baseSupport * ((child.favor || 50) / 1000));
                 // 抚养成本回报：将总抚养成本分20年（40回合）返还
                 const costReturn = Math.floor((child.upbringingCost || 0) / 20);
                 
                 const totalSupport = baseSupport + favorBonus + costReturn;
                 
                 if (totalSupport > 0) {
                    applyEffects({ wealth: totalSupport });
                    logEvent(`你的孩子 <strong class="highlight-npc">${child.name}</strong> 送来了 <span class="value">${totalSupport}</span> 两赡养费，以报答你的养育之恩。`);
                 }
            }
        }
        
        if (child.age >= 16 && !child.marriage.isMarried && (!child.marriage.lastProposalTurn || (gameState.date.year * 2 + gameState.date.turn) > child.marriage.lastProposalTurn + 4) && Math.random() < 0.2) {
            child.marriage.lastProposalTurn = (gameState.date.year * 2 + gameState.date.turn);
            triggerChildInitiatedMarriage(child.id);
        }
        if(child.marriage.isMarried && child.marriage.grandchildTimer > 0) {
            child.marriage.grandchildTimer--;
            if(child.marriage.grandchildTimer <= 0 && Math.random() < 0.5) {
                showEventCard('开枝散叶', 'fa-baby', `喜报！你的孩子${child.name}为你添了一个孙辈，家族香火得以延续！`);
                applyEffects({reputation:10});
                child.marriage.grandchildTimer = -1;
            }
        }
    });

    // ================== 【新增逻辑】触发青梅竹马正式结识事件 ==================
    const playerAge = Math.floor(gameState.player.age);
    const sweetheartId = gameState.flags.childhoodSweetheartId;
    // 检查条件：玩家年满12岁，且青梅竹马尚未在社交关系中
    if (playerAge === 12 && sweetheartId && !gameState.social.relationships[sweetheartId]) {
        const sweetheart = gameState.npcs[sweetheartId];
        if (sweetheart) {
            eventQueue.push(() => {
                showDecisionCard(
                    '总角之交', 
                    'fa-child', 
                    `你已十二岁，与邻家的 <strong class="highlight-npc">${sweetheart.name}</strong> 一同玩耍长大，可以说是最要好的朋友。今日，你们在后山捉迷藏，约定了彼此的专属昵称。`, 
                    [{
                        htmlContent: '“以后我们就是一辈子的朋友啦！”',
                        callback: () => {
                            const relType = sweetheart.gender === 'male' ? 'blue_confidante' : 'red_confidante';
                            gameState.social.relationships[sweetheart.id] = {
                                type: relType,
                                favor: 60,
                                trust: 70,
                                emotionValue: 100,
                                level: 2, // 直接从“友好”等级开始
                            };
                            showEventCard('青梅之约', 'fa-hand-holding-heart', `你与 <strong class="highlight-npc">${sweetheart.name}</strong> 正式成为了知己好友，你们的羁绊更加深厚了。`);
                        }
                    }]
                );
            });
        }
    }
}
function handleChildLifeEventResult(childId, eventId, optionIndex) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const age = Math.floor(child.age);
    const event = CHILD_LIFE_EVENTS[age].find(e => e.id === eventId);
    if (!event) return;

    const choice = event.options[optionIndex];
    if (!choice) return;

    // 应用效果
    if (choice.effects) {
        Object.entries(choice.effects).forEach(([key, value]) => {
            if (key === 'favor') {
                child.favor = (child.favor || 50) + value;
            } else {
                child.attributes[key] = (child.attributes[key] || 0) + value;
            }
        });
    }

    const logText = choice.log.replace(/{childName}/g, `<strong class="value">${child.name}</strong>`);
    showEventCard(event.title, 'fa-child', logText);
    renderGame();
}
// [替换]
// [替换] 找到这个函数并用下面的代码完整替换
// [用这个新版本替换]
function assignChildCareer(child) {
    const careerList = childCareerAssignment[child.gender];
    const chosenPathName = child.careerPathChosen;
    const pathData = careerList[chosenPathName];

    if (!pathData || pathData.path === 'unemployed') {
        child.career = { path: 'unemployed', name: '待业', level: 0, performance: 0, salary: 50 };
        showEventCard('子嗣成年', 'fa-user-graduate', `你的孩子<strong class="value">${child.name}</strong>未能确定志向，暂时待业家中。`);
        return;
    }
    
    const careerPathId = pathData.path;
    const careerLevels = careerPaths[child.gender][careerPathId].levels;
    let startingLevelIndex = 0;

    // 从第2级开始向下检查，看孩子的能力能胜任哪个初始职位
    for (let i = 1; i < careerLevels.length; i++) {
        const levelData = careerLevels[i];
        let meetsAllReqs = true;
        for (const attr in levelData.req) {
            if ((child.attributes[attr] || 0) < levelData.req[attr]) {
                meetsAllReqs = false;
                break;
            }
        }
        if (meetsAllReqs) {
            startingLevelIndex = i; // 记录符合条件的最高等级
        } else {
            break; // 一旦不满足，就不再向上检查
        }
    }

    const initialLevelData = careerLevels[startingLevelIndex];
    child.career = {
        path: careerPathId,
        name: chosenPathName,
        level: startingLevelIndex,
        performance: 0,
        salary: initialLevelData.salary
    };

    if (startingLevelIndex > 0) {
        showEventCard('子嗣成年', 'fa-user-graduate', `天资卓越！你的孩子<strong class="value">${child.name}</strong>凭借出色的能力，直接被授予了<strong class="value">${initialLevelData.title}</strong>的职位，前途无量！`);
    } else {
        showEventCard('子嗣成年', 'fa-user-graduate', `你的孩子<strong class="value">${child.name}</strong>成功入职【${chosenPathName}】，被授予了<strong class="value">${initialLevelData.title}</strong>的职位！`);
    }
}
function showChildRearing(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    let cultivationHTML = '';
    const age = Math.floor(child.age);
    const isMale = child.gender === 'male';
    const currentTier = financialTiers.find(t => t.level === gameState.finances.financialTier) || financialTiers[0];
    const eduOptions = currentTier.expenses.child_edu;

    cultivationHTML += `
        <div class="section-header">教育方针</div>
        <p class="comment">当前教育: ${child.education ? child.education.name : '基础教养'}</p>
        <div class="options" style="flex-wrap: wrap; flex-direction: row; justify-content: center;">
    `;
    
    if (age >= 6 && age < 18) {
        eduOptions.forEach(opt => {
            const canAfford = gameState.finances.wealth >= opt.cost;
            const isCurrent = child.education && child.education.name === opt.name;
            const buttonStyle = isCurrent ? `background: ${isMale ? 'linear-gradient(135deg, #6a9ac9, #4169e1)' : 'linear-gradient(135deg, #ff9ebf, #ff69b4)'};` : '';
            
            cultivationHTML += `
                <button class="control-btn" style="min-width: 150px; ${buttonStyle}"
                    ${!canAfford && !isCurrent ? 'disabled' : ''} 
                    onclick="setChildEducation('${child.id}', '${opt.name}', ${opt.cost})">
                    <i class="fas fa-book"></i>
                    <span class="option-text">${opt.name}
                        <div><small>${opt.cost > 0 ? `(${opt.cost}两/年)` : ''}</small></div>
                    </span>
                </button>
            `;
        });
    } else if (age < 6) {
        cultivationHTML += `<p class="comment" style="width:100%; text-align:center;">${child.name}尚在启蒙期，请通过日常互动培养。</p>`;
    } else {
        cultivationHTML += `<p class="comment" style="width:100%; text-align:center;">${child.name}已经成年，可以独立生活了。</p>`;
    }

    cultivationHTML += '</div>';

    const attributesHTML = `
        <div class="section-header">当前属性</div>
        <div class="attributes-grid" style="grid-template-columns: 1fr 1fr;">
            ${Object.entries(child.attributes).filter(([k,v])=> ATTR_MAP[k]).map(([key, value]) => {
                const iconMap = {talent:'fa-pencil-alt', etiquette:'fa-hands-helping', wisdom:'fa-lightbulb', virtue:'fa-leaf', charm:'fa-grin-stars', martial:'fa-khanda', health:'fa-heart'};
                const classMap = {talent:'talent-fill', etiquette:'etiquette-fill', wisdom:'wisdom-fill', virtue:'virtue-fill', charm:'charm-fill', martial:'martial-fill', health:'health-fill'};
                return renderAttributeBar(ATTR_MAP[key], value, classMap[key], iconMap[key]);
            }).join('')}
        </div>`;
    
    // 【新增】检查互动是否已被使用
    const interactionsUsed = gameState.flags.childInteractionsUsed || {};
    const allowanceUsed = interactionsUsed[child.id + '_allowance'];
    const careUsed = interactionsUsed[child.id + '_care'];
    const playUsed = interactionsUsed[child.id + '_play'];

    document.getElementById('childRearingContent').innerHTML = `
        <h4>与 <strong class="value">${child.name}</strong> 的互动</h4>
        <div style="max-height: 60vh; overflow-y: auto; padding: 5px;">
            ${cultivationHTML}
            <div class="section-header">日常互动</div>
            <div class="options">
                <button class="option" ${allowanceUsed ? 'disabled' : ''} onclick="interactWithChild('${childId}', 'allowance')"><i class="fas fa-coins"></i> 给零花钱</button>
                <button class="option" ${careUsed ? 'disabled' : ''} onclick="interactWithChild('${childId}', 'care')"><i class="fas fa-hand-holding-heart"></i> 关心学业/生活</button>
                <button class="option" ${playUsed ? 'disabled' : ''} onclick="interactWithChild('${childId}', 'play')"><i class="fas fa-puzzle-piece"></i> 陪伴游玩</button>
            </div>
            ${attributesHTML}
        </div>`;
    showOverlay('childRearingOverlay');
}
function setChildCultivationFocus(childId, focusId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;
    
    const isMale = child.gender === 'male';
    const focusOptions = isMale ? CHILD_CULTIVATION_STAGES.childhood.male : CHILD_CULTIVATION_STAGES.childhood.female;
    const focus = focusOptions.find(o => o.id === focusId);

    if (focus) {
        child.cultivationFocus = focus.focus;
        child.cultivationFocusName = focus.name;
        showToast(`${child.name}的培养方针已设定为【${focus.name}】。`);
    } else {
        // 默认选项
        child.cultivationFocus = null;
        child.cultivationFocusName = '基础教养';
        showToast(`已取消${child.name}的培养方针，恢复为基础教养。`);
    }

    showChildRearing(childId);
}
function cultivateChild(childId, actionId, cost = 0) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;
    if(cost > 0 && gameState.finances.wealth < cost) { showToast("你的私产不足。"); return;}

    let logText = '';
    let appliedEffects = false;
    
    // 查找所有阶段的培养选项
    const allOptions = [
        ...CHILD_CULTIVATION_STAGES.infancy.male,
        ...CHILD_CULTIVATION_STAGES.infancy.female,
        ...CHILD_CULTIVATION_STAGES.childhood.male,
        ...CHILD_CULTIVATION_STAGES.childhood.female,
        ...CHILD_CULTIVATION_STAGES.teenager.common,
    ];
    const action = allOptions.find(opt => opt.id === actionId);

    if (action) {
        if(cost > 0) applyEffects({ wealth: -cost });
        
        if (action.effects) {
            for(const [key, value] of Object.entries(action.effects)) {
                child.attributes[key] = (child.attributes[key] || 0) + value;
            }
             logText = `你对 ${child.name} 进行了【${action.name}】，TA的属性获得了提升。`;
        }
        if (action.focus) {
            child.cultivationFocus = action.focus;
            child.cultivationFocusName = action.name;
            logText = `你为 ${child.name} 设定了新的教育方针：【${action.name}】。`;
        }
        showEventCard('悉心教养', 'fa-graduation-cap', logText);
        appliedEffects = true;
    }

    if(appliedEffects) {
        showChildRearing(childId); // 刷新界面
    }
}
function interactWithChild(childId, type) {
    const child = gameState.children.find(c => !c.isDead && c.id === childId);
    if(!child) return;

    // 【新增】检查并设置互动标记
    if (!gameState.flags.childInteractionsUsed) gameState.flags.childInteractionsUsed = {};
    const interactionKey = child.id + '_' + type;
    if (gameState.flags.childInteractionsUsed[interactionKey]) {
        showToast("本回合已进行过此项互动。");
        return;
    }
    gameState.flags.childInteractionsUsed[interactionKey] = true;

    let log = '';
    child.favor = (child.favor || 50);

    if(type==='allowance') {
        const amountStr = prompt(`给${child.name}多少零花钱？`, '10');
        const amount = parseInt(amountStr);
        if(isNaN(amount) || amount <= 0) {
             // 如果输入无效，把互动次数还回去
             delete gameState.flags.childInteractionsUsed[interactionKey];
             return;
        }
        if(gameState.finances.wealth < amount) {
            showToast('私产不足');
            delete gameState.flags.childInteractionsUsed[interactionKey];
            return;
        }
        applyEffects({wealth: -amount});
        child.favor += Math.floor(amount/10);
        if (amount > 100) child.attributes.virtue = Math.max(0, child.attributes.virtue -1);
        log = `你给了${child.name} ${amount} 两零花钱。`;
    } else if(type === 'care') {
        child.favor += 8;
        child.attributes.wisdom = (child.attributes.wisdom || 0) + getRandomInt(2, 4);
        child.attributes.virtue = (child.attributes.virtue || 0) + getRandomInt(2, 4);
        gameState.player.attributes.virtue += 1;
        log = `你关心了${child.name}的学业与生活，TA有所感悟。`;
    } else if (type === 'play') {
        child.favor += 15;
        child.attributes.charm = (child.attributes.charm || 0) + getRandomInt(2, 4);
        gameState.player.attributes.health += 2;
        log = `你放下事务，陪${child.name}痛快地玩了一个下午，亲子关系更加融洽了。`;
    }
    child.favor = Math.min(100, child.favor);
    showEventCard('亲子时光', 'fa-child', log);
    // 刷新互动窗口以显示按钮的禁用状态
    showChildRearing(childId);
}
function openChildMarriageMenu(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const options = [
        {htmlContent: `<i class="fas fa-heart"></i> 询问TA的心上人`, callback: () => triggerChildInitiatedMarriage(child.id, true)},
        {htmlContent: `<i class="fas fa-users"></i> 为TA安排议亲`, callback: () => showChildArrangedMarriage(child.id)},
        {htmlContent: `<i class="fas fa-times"></i> 稍后再说`, style: `background:var(--control-bg);`, callback: () => closeAllOverlays()}
    ];
    showDecisionCard('子女婚事', '', `<p>你正在为${child.name}的婚事操心，你打算...</p>`, options);
}

function triggerChildInitiatedMarriage(childId, fromMenu = false) {
    const child = gameState.children.find(c => c.id === childId);
    if(!child) return;

    if (fromMenu && Math.random() < 0.3){ 
        showToast(`${child.name}害羞地表示，自己尚无意中人。`); 
        setTimeout(() => showChildArrangedMarriage(childId), 1500); // 自动转到安排议亲
        return; 
    }

    const partnerGender = child.gender === 'male' ? 'female' : 'male';
    const bg = getRandomElement(childSpousePools[partnerGender]);

    const partner = {
        name: generateRandomName(partnerGender, gameState.flags.allNames),
        desc: bg.desc, attributes: { ...bg.attributes, family: bg.family },
        isArranged: false,
        hiddenTrait: bg.hidden_trait,
        avatar: getRandomElement(avatarPools[partnerGender])
    };

    let content = `${child.name}前来找你，满面羞红地告诉你，TA有了心上人，名为 <strong class="value">${partner.name}</strong>。<br>`;
    content += renderSpouseCandidateCard(partner, child, true); // true表示这是孩子自己选的
    content += `<p>你是否同意这门亲事？</p>`;

    const options = [
        {htmlContent: `<i class="fas fa-check"></i> 同意`, callback: () => handleChildMarriageDecision(true, child.id, JSON.stringify(partner))},
        {htmlContent: `<i class="fas fa-times"></i> 拒绝`, style: `background:linear-gradient(135deg, #e74c3c, #c0392b);`, callback: () => handleChildMarriageDecision(false, child.id, JSON.stringify(partner))}
    ];
    showDecisionCard(`子女情事`, '', content, options);
}
function triggerChildInitiatedMarriage(childId, fromMenu = false) {
    const child = gameState.children.find(c => c.id === childId);
    if(!child) return;

    if (fromMenu && Math.random() < 0.2){ showToast(`${child.name}表示自己尚无意中人。`); return; }

    const partnerGender = child.gender === 'male' ? 'female' : 'male';
    const backgrounds = partnerGender === 'female' ? ladyBackgrounds : suitorBackgrounds;
    const bg = getRandomElement(backgrounds);

    const partner = {
        name: generateRandomName(partnerGender, gameState.flags.allNames),
        desc: bg.desc, attributes: { ...bg.attributes, family: bg.family },
        isArranged: false
    };

    let content = `${child.name}前来找你，满面羞红地告诉你，TA有了心上人，名为 <strong class="value">${partner.name}</strong>。<br>`;
    content += `<div class="suitor" style="cursor:default; margin-top:15px;"><div class="suitor-details" style="text-align:left;">${partner.desc}<br>魅力: ${partner.attributes.charm} | 才情: ${partner.attributes.talent} | 家世: ${partner.attributes.family}</div></div>`;
    content += `<p>你是否同意这门亲事？</p>`;

    const options = [
        {htmlContent: `<i class="fas fa-check"></i> 同意`, callback: () => handleChildMarriageDecision(true, child.id, JSON.stringify(partner))},
        {htmlContent: `<i class="fas fa-times"></i> 拒绝`, style: `background:var(--control-shadow-hover);`, callback: () => handleChildMarriageDecision(false, child.id)}
    ];
    showDecisionCard(`子女情事`, '💖', content, options);

}
// 【新增的函数】处理玩家为孩子做的性格养成选择
function handleChildPersonalityChoice(childId, eventData, choiceData) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // 应用选项效果
    if (choiceData.effects && choiceData.effects.attributes) {
        for (const [attr, value] of Object.entries(choiceData.effects.attributes)) {
            child.attributes[attr] = (child.attributes[attr] || 0) + value;
        }
    }

    // 添加性格特质
    if (!child.personality) child.personality = [];
    if (!child.personality.includes(choiceData.trait)) {
        child.personality.push(choiceData.trait);
    }

    // 标记此年龄段的事件已触发
    const ageMilestone = Math.floor(child.age);
    child.personalityEventTriggered = ageMilestone;

    // 显示结果弹窗
    let resultText = `在你的引导下（“${choiceData.text}”），你的孩子 ${child.name} 的性格中增添了 <strong class="value">${choiceData.trait}</strong> 的特质。`;
    showEventCard('悉心教导', 'fa-child', resultText);

    renderGame();
}
function handleChildMarriageDecision(agreed, childId, partnerInfoStr) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;
    const partnerInfo = JSON.parse(partnerInfoStr);

    if (agreed) {
        // 【核心修改】不再调用带有随机性的 proposeToChildsPartner 函数
        // 而是直接进入准备聘礼/嫁妆的流程
        const isDichu = !child.isSecret && child.motherId === gameState.marriage.spouseId;
        const minCost = isDichu ? 1000 : 200;

        let promptText = `对方家族欣然应允！请为${child.name}准备${child.gender === 'male' ? '聘礼' : '嫁妆'} (最低${minCost}两):`;
        const dowryInput = prompt(promptText, minCost * 5);
        if (dowryInput === null) return;
        const dowryAmount = parseInt(dowryInput);

        if (isNaN(dowryAmount) || dowryAmount < minCost) { 
            showToast(`金额无效或低于最低要求。`); 
            return; 
        }
        if (gameState.finances.wealth < dowryAmount) { 
            showToast("你的财力不足以支撑这门婚事。"); 
            return; 
        }

        // 所有检查通过后，调用最终的成婚函数
        finalizeChildMarriage(childId, partnerInfo, dowryAmount);

    } else {
        // 拒绝的逻辑保持不变
        child.favor = Math.max(0, (child.favor || 50) - 30);
        if (child.favor < 20 && (child.personality.includes('叛逆') || child.personality.includes('果敢')) && Math.random() < 0.3) {
            child.marriage.isMarried = true;
            child.marriage.spouseInfo = partnerInfo;
            child.isDead = true; 
            showEventCard('子女私奔', 'fa-running', `你强硬地拒绝了${child.name}的请求。数日后，你发现TA与心上人${partnerInfo.name}一同私奔，从此杳无音信！你的家族声望因此大跌。`);
            applyEffects({ reputation: -50 });
        } else {
            showEventCard('棒打鸳鸯', 'fa-heart-broken', `你拒绝了${child.name}的请求，TA看起来伤心欲绝。亲子关系大幅下降。`);
        }
    }
    closeAllOverlays();
}
function showChildArrangedMarriage(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const partnerGender = child.gender === 'male' ? 'female' : 'male';
    let partnersHTML = `<h4>媒婆为你寻来了几位不错的候选人:</h4>`;
    let potentialPartners = [];

    for(let i=0; i < 3; i++) {
        const bg = getRandomElement(childSpousePools[partnerGender]);
        potentialPartners.push({
            name: generateRandomName(partnerGender, gameState.flags.allNames),
            desc: bg.desc, attributes: { ...bg.attributes, family: bg.family }, 
            isArranged: true,
            hiddenTrait: bg.hidden_trait,
            avatar: getRandomElement(avatarPools[partnerGender])
        });
    }

    partnersHTML += potentialPartners.map(p => renderSpouseCandidateCard(p, child, false)).join('');

    document.getElementById('childMarriageContent').innerHTML = `
        <p>你正在为<strong class="value">${child.name}</strong>的婚事操心。</p>
        <div style="max-height: 60vh; overflow-y:auto; padding:5px;">${partnersHTML}</div>`;
    showOverlay('childMarriageOverlay');
}
function renderSpouseCandidateCard(partner, child, isFreeChoice) {
    const partnerScore = Object.values(partner.attributes).reduce((a, b) => a + b, 0);
    const childScore = Object.values(child.attributes).reduce((a, b) => a + b, 0);
    const compatibility = Math.min(100, Math.max(10, 50 + (childScore - partnerScore) / 5 + (child.favor || 50) / 2 - 25));

    // [修复] 将复杂的 partner 对象数据存储在HTML的 data-* 属性中，而不是混乱地放在 onclick 里
    const partnerInfoString = JSON.stringify(partner).replace(/'/g, "&apos;");

    return `<div class="suitor" style="cursor:pointer;" data-partner='${partnerInfoString}' onclick='proposeToChildsPartner(this, "${child.id}")'>
        <div class="suitor-avatar-wrapper" style="background-color: ${isFreeChoice ? '#ffdab9' : '#e0f7fa'}">
            <img src="${partner.avatar}" class="suitor-avatar">
        </div>
        <div class="suitor-details">
            <div class="suitor-name">${partner.name} <small>(匹配度: ${Math.floor(compatibility)}%)</small></div>
            <div class="suitor-desc">${partner.desc}</div>
            <div class="suitor-stats">
                <span class="stat"><i class="fas fa-home"></i> 家世: ${partner.attributes.family}</span>
                <span class="stat"><i class="fas fa-grin-stars"></i> 魅力: ${partner.attributes.charm}</span>
                <span class="stat"><i class="fas fa-pencil-alt"></i> 才情: ${partner.attributes.talent}</span>
            </div>
            <button class="control-btn" style="padding: 5px 10px; font-size: 0.8em; margin-top: 8px; width: 120px;" 
                onclick="event.stopPropagation(); investigateSpouseCandidate(this.parentElement.parentElement, '${child.id}')">
                <i class="fas fa-search"></i> 暗中调查
            </button>
        </div>
    </div>`;
}
function investigateSpouseCandidate(cardElement, childId) {
    // [修复] 增加调查成本
    const cost = 200;
    if(gameState.finances.wealth < cost) { 
        showToast("调查需要200两，当前私产不足"); 
        return;
    }

    const partnerData = JSON.parse(cardElement.dataset.partner);
    const button = cardElement.querySelector('.control-btn');

    button.disabled = true;
    button.classList.add('button-loading');

    setTimeout(() => {
        applyEffects({ wealth: -cost }); // [修复] 扣除金钱

        const event = getRandomElement(INVESTIGATION_EVENTS);
        const desc = event.desc.replace(/【对象姓名】/g, `<strong class="highlight-npc">${partnerData.name}</strong>`);

        // [修复] 将结果展示在决策弹窗中，并提供议亲选项
        const finalDesc = `${desc}<br><br><strong>调查结果：</strong>${event.effect_text || '情况如上，请您定夺。'}`;

        const options = [
            {
                htmlContent: `<i class="fas fa-check"></i> 同意此门亲事`,
                callback: () => {
                    // 由于proposeToChildsPartner需要一个DOM元素，我们直接传递元素和孩子ID
                    proposeToChildsPartner(cardElement, childId);
                }
            },
            {
                htmlContent: `<i class="fas fa-times"></i> 拒绝此门亲事`,
                callback: () => {
                    showToast(`你决定不考虑 ${partnerData.name} 了。`);
                    closeAllOverlays();
                }
            }
        ];
        
        // 如果事件本身有选项（比如发现已有心上人），则优先处理事件选项
        if (event.options) {
             const eventOptions = event.options.map(opt => ({
                htmlContent: opt.text,
                callback: () => {
                    showEventCard(event.title, 'fa-user-secret', `${desc}<br><br><strong>你的决定：</strong>${opt.log}`);
                }
            }));
            showDecisionCard(event.title, 'fa-user-secret', desc, eventOptions);
        } else {
            // 否则显示议亲决策
            showDecisionCard(event.title, 'fa-user-secret', finalDesc, options);
        }

        button.classList.remove('button-loading');
        button.innerHTML = '<i class="fas fa-check"></i> 已调查';

    }, 1000); 
}
// [替换] 找到这个函数并用下面的代码完整替换
function proposeToChildsPartner(cardElement, childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // [修复] 从元素的 data-partner 属性中安全地读取数据
    const partnerInfo = JSON.parse(cardElement.dataset.partner);

    let successChance = 0.7;
    successChance += (gameState.family.reputation / 1000);
    const partnerScore = Object.values(partnerInfo.attributes).reduce((a, b) => a + b, 0);
    const childScore = Object.values(child.attributes).reduce((a, b) => a + b, 0);
    successChance += (childScore - partnerScore) / 500;

    if (partnerInfo.revealedTrait && partnerInfo.revealedTrait.type === 'negative') {
        successChance += 0.2;
    }

    if (Math.random() > successChance) {
        showEventCard('议亲失败', 'fa-times-circle', `对方家族经过考量，婉拒了这门亲事。或许是觉得你们门不当户不对。`);
        return;
    }

    const isDichu = !child.isSecret && child.motherId === gameState.marriage.spouseId;
    const minCost = isDichu ? 1000 : 200;

    let promptText = `对方同意了这门亲事！请为${child.name}准备${child.gender === 'male' ? '聘礼' : '嫁妆'} (最低${minCost}两):`;
    const dowryInput = prompt(promptText, minCost * 5);
    if (dowryInput === null) return;
    const dowryAmount = parseInt(dowryInput);

    if (isNaN(dowryAmount) || dowryAmount < minCost) { showToast(`金额无效或低于最低要求。`); return; }
    if (gameState.finances.wealth < dowryAmount) { showToast("你的财力不足以支撑这门婚事。"); return; }

    finalizeChildMarriage(childId, partnerInfo, dowryAmount);
}
function finalizeChildMarriage(childId, partnerInfo, cost) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    // 扣除财物
    applyEffects({ wealth: -cost });

    // 标记孩子已婚
    child.marriage.isMarried = true;
    child.marriage.spouseInfo = partnerInfo; // <--- 这里存储了配偶信息
    child.marriage.grandchildTimer = 4; // 2年后开始可能添孙

    // 家族声望增益
    const familyRepGain = Math.floor(cost / 100) + Math.floor(partnerInfo.attributes.family / 20);
    applyEffects({ reputation: familyRepGain });

    const isDichu = !child.isSecret && child.motherId === gameState.marriage.spouseId;

    let eventText = '';
    if (child.gender === 'female') {
        const hasHouseForDowry = gameState.finances.assets.some(a => a.type === 'residence' && !a.isOccupiedByChild);
        if (isDichu && hasHouseForDowry && cost >= 200) {
            // 嫡女且有房产
            const house = gameState.finances.assets.find(a => a.type === 'residence' && !a.isOccupiedByChild);
            house.isOccupiedByChild = child.id;
            eventText = `你为嫡女<strong class="value">${child.name}</strong>置办了丰厚的嫁妆，其中不仅有<span class="value">${cost}</span>两现银，还陪送了一套<span class="value">${house.name}</span>作为她的新家。这门婚事传为佳话，两家结为姻亲，声望大振。`;
        } else if (isDichu && !hasHouseForDowry) {
            // 嫡女但没房产
            eventText = `你为嫡女<strong class="value">${child.name}</strong>准备了<span class="value">${cost}</span>两嫁妆。虽然没有房产，但丰厚的嫁妆依然让对方十分满意。`;
        } else {
            // 庶女
            eventText = `你为庶女<strong class="value">${child.name}</strong>准备了<span class="value">${cost}</span>两嫁妆。对方看在你的面子上，应下了这门亲事。`;
        }
    } else {
        // 男孩的婚事
        eventText = `你为儿子<strong class="value">${child.name}</strong>向<strong class="value">${partnerInfo.name}</strong>家送去了<span class="value">${cost}</span>两聘礼。对方欣然应允，从此两家结为姻亲。`;
    }

    eventText += `<br>家族声望因此提升了<span class="value">${familyRepGain}</span>点。`;

    showEventCard('喜结良缘', 'fa-ring', eventText);
    renderGame();
}
function arrangeChildMarriage(childId, partnerInfo) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    if(partnerInfo.isArranged) {
        const partnerScore = Object.values(partnerInfo.attributes).reduce((a, b) => a + b, 0);
        const childScore = Object.values(child.attributes).reduce((a, b) => a + b, 0);
        const acceptanceChance = Math.min(0.95, 0.5 + (childScore - partnerScore) / 200);
        if(Math.random() > acceptanceChance) {
            showEventCard('议亲失败', 'fa-times-circle', `${partnerInfo.name}的家族对这门亲事并不满意，拒绝了。`);
            return;
        }
        if (Math.random() < 0.2) {
             showEventCard('子女拒婚', 'fa-hand-paper', `${child.name}对这门亲事并不满意，也拒绝了。`);
            return;
        }
    }

    const isSecretChild = child.isSecret;
    const mother = gameState.npcs[child.motherId];
    const isShuchu = !isSecretChild && mother && gameState.marriage.isMarried && mother.id !== gameState.marriage.spouseId;

    const isDichu = !isSecretChild && !isShuchu;
    let minCost = isShuchu ? 50 : 200;

    let promptText = `为${child.name}准备${child.gender === 'male' ? '聘礼' : '嫁妆'} (最低${minCost}两):`;
    let hasHouseForDowry = false;
    if(isDichu && child.gender === 'female') {
        const availableHouse = gameState.finances.assets.find(a => a.type === 'residence' && !a.isOccupiedByChild);
        if(availableHouse) {
             promptText += ` (已备好一套房产)`;
             hasHouseForDowry = true;
        } else {
             promptText += ` (需另备一套房产, 但你没有闲置房产)`;
        }
    }

    let dowryInput = prompt(promptText, minCost*2);
    if (dowryInput === null) return;
    const dowryAmount = parseInt(dowryInput);

    if (isNaN(dowryAmount) || dowryAmount < minCost) { showToast(`金额无效或低于最低要求。`); return; }
    if (gameState.finances.wealth < dowryAmount) { showToast("你的财力不足以支撑这门婚事。"); return; }
    if(isDichu && child.gender === 'female' && !hasHouseForDowry) { showToast("你没有闲置的房产作为嫡女嫁妆。"); return; }

    applyEffects({wealth: -dowryAmount});
    if(isDichu && child.gender === 'female' && hasHouseForDowry) {
        const house = gameState.finances.assets.find(a => a.type === 'residence' && !a.isOccupiedByChild);
        house.isOccupiedByChild = child.id;
        showEventCard('陪送嫁妆', 'fa-key', `你将${house.name}作为嫁妆，陪嫁给了${child.name}。`);
    }

    child.marriage.isMarried = true;
    child.marriage.spouseInfo = partnerInfo;
    child.marriage.grandchildTimer = 4;

    showEventCard('喜结良缘', 'fa-ring', `你为孩子<strong class="value">${child.name}</strong>与<strong class="value">${partnerInfo.name}</strong>定下了一门亲事，花费了<span class="value">${dowryAmount}</span>两。`);
    renderGame();
}
// =======================================================================
// ============================= MERCHANT GUILD ==========================
// =======================================================================
function logMerchantEvent(text) {
    gameState.finances.merchantLog.unshift(text);
    if (gameState.finances.merchantLog.length > 20) gameState.finances.merchantLog.pop();
}

let voyageChoices = {
    captain: null,
    route: null,
    cargo: {},
    investment: 0
};
function handleMerchantSpecialEvent(event, choice) {
    const outcome = choice.outcome;
    let finalEffects = { ...outcome.effects };

    // 应用成本
    if (finalEffects.cost) {
        if (gameState.finances.wealth < finalEffects.cost) {
            showToast("资金不足，无法执行此选项！");
            return;
        }
        applyEffects({ wealth: -finalEffects.cost });
    }

    // 应用其他效果
    if (finalEffects.wealth) {
        applyEffects({ wealth: finalEffects.wealth });
    }
    if (finalEffects.reputation) {
        applyEffects({ reputation: finalEffects.reputation });
    }
    if (finalEffects.virtue) {
        applyEffects({ attributes: { virtue: finalEffects.virtue } });
    }
    // ...可以添加更多效果类型

    showEventCard(event.title, 'fa-exclamation-triangle', outcome.text);

    // 返回一个效果对象，让调用者可以修改收益
    return finalEffects;
}
// [用这个新版本替换]
function handleMerchantAction(type) {
    let content;
    switch(type) {
        case 'explore':
            // 核心修改：现在这个按钮会打开新的主界面
            showMaritimeTradeUI();
            break;
        case 'trade':
            startTradeSim();
            break;
        case 'invest':
             showInvestmentDashboard();
             break;
        case 'farm':
            content = `<p>管理你的田地，进行播种。</p>`;
            const ownedLands = gameState.merchant.ownedLand;
            const activeCrops = gameState.merchant.activeCrops;
            const ownedLandEntries = Object.entries(ownedLands);
            if(ownedLandEntries.length > 0) {
                ownedLandEntries.forEach(([landType, totalAcres]) => {
                    const landInfo = landData.find(l => l.id === landType);
                    const plantedCropsOnType = activeCrops.filter(c => c.landType === landType);
                    const plantedAcres = plantedCropsOnType.reduce((sum, crop) => sum + crop.acres, 0);
                    const availableAcres = totalAcres - plantedAcres;
                    content += `
                        <div class="marketplace-item" style="display: block; border-bottom: 1px dashed var(--border-color-light); padding-bottom: 10px; margin-bottom: 10px;">
                            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span>${landInfo.icon} <strong>${landInfo.name}</strong> (共 ${totalAcres} 亩)</span>
                                ${availableAcres > 0 ? `<button class="control-btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="showPlantCropOverlay('${landType}')">播种 (${availableAcres}亩可用)</button>` : '<span class="comment">已种满</span>'}
                            </div>
                    `;
                    if (plantedCropsOnType.length > 0) {
                        content += '<ul>';
                        plantedCropsOnType.forEach(crop => {
                            const cropInfo = cropData.find(cd => cd.id === crop.cropId);
                            content += `<li>${cropInfo.icon} ${cropInfo.name} (x${crop.acres}亩) - ${crop.cycleLeft}回合后成熟</li>`;
                        });
                        content += '</ul>';
                    }
                    content += `</div>`;
                });
            } else { 
                content += `<p class="comment">你还没有土地。</p>`; 
            }
            content += `<div class="options"><button class="option" onclick="showBuyLandOverlay()"><i class="fas fa-plus"></i> 购置新地契</button></div>`;
            document.getElementById('merchantGuildContent').innerHTML = content;
            showOverlay('merchantGuildOverlay');
            break;
    }
}
// [新增这个函数] 产业投资面板核心函数
function showInvestmentDashboard() {
    let html = `<div class="section-header"><i class="fas fa-store"></i> 我的产业</div>`;

    if (gameState.merchant.investments.length > 0) {
        gameState.merchant.investments.forEach(invest => {
            const type = merchantInvestmentData.types.find(t => t.id === invest.typeId);
            const level = type.levels[invest.level];
            html += `
                <div class="suitor" onclick="showInvestmentDetails('${invest.instanceId}')">
                    <div class="suitor-details">
                        <div class="suitor-name">${level.name} (Lv.${invest.level + 1})</div>
                        <div class="suitor-desc">掌柜: ${merchantInvestmentData.managers.find(m => m.id === invest.managerId).name}</div>
                    </div>
                </div>
            `;
        });
    } else {
        html += `<p class="comment">你名下尚无任何产业。</p>`;
    }

    html += `<div class="section-header"><i class="fas fa-plus-circle"></i> 开设新产业</div>`;
    html += `<div class="options">`;
    merchantInvestmentData.types.forEach(type => {
        const isOwned = gameState.merchant.investments.some(i => i.typeId === type.id);
        if (!isOwned) {
            const canAfford = gameState.finances.wealth >= type.levels[0].cost;
            html += `<button class="option" ${!canAfford ? 'disabled' : ''} onclick="makeInvestment('${type.id}')">
                <i class="fas fa-building"></i>
                <span class="option-text"><strong>开设${type.name}</strong><div><small>成本: ${type.levels[0].cost} 两</small></div></span>
            </button>`;
        }
    });
    html += `</div>`;

    // 使用 showDecisionCard 来显示构建好的内容
    showDecisionCard("产业投资", "fa-store-alt", html, []);
}
// ===================== 【新增】全新远洋商路核心函数 =====================
/**
 * 显示远洋商路主界面
 */
function showMaritimeTradeUI() {
    const merchant = gameState.merchant;
    const fleetInfo = MARITIME_TRADE_DATA.fleetLevels[merchant.fleetLevel];
    let html = '';

    // 显示当前舰队状态和升级选项
    html += `<div class="section-header"><i class="fas fa-ship"></i> 我的舰队</div>`;
    if (merchant.fleetLevel === 0) {
        // 还未组建舰队
        html += `<p class="comment">你尚未拥有自己的船队，无法进行远洋贸易。</p>
                 <div class="options">
                     <button class="option" ${gameState.finances.wealth < fleetInfo.upgradeCost || gameState.family.reputation < fleetInfo.req.reputation ? 'disabled' : ''} onclick="assembleFleet()">
                         <i class="fas fa-anchor"></i>
                         <span class="option-text"><strong>组建${MARITIME_TRADE_DATA.fleetLevels[1].name}</strong><div><small>花费: ${fleetInfo.upgradeCost} 两 | 要求声望: ${fleetInfo.req.reputation}</small></div></span>
                     </button>
                 </div>`;
    } else {
        // 已有舰队，显示信息和升级按钮
        html += `<div class="trading-info-box" style="margin-bottom: 10px;">
                    <h4>当前舰队等级</h4>
                    <div class="value">${fleetInfo.name} (Lv.${merchant.fleetLevel})</div>
                 </div>`;
        const nextLevel = MARITIME_TRADE_DATA.fleetLevels[merchant.fleetLevel];
        if (nextLevel && nextLevel.upgradeCost > 0) {
            const canUpgrade = gameState.finances.wealth >= nextLevel.upgradeCost && gameState.family.reputation >= nextLevel.req.reputation;
            html += `<div class="options">
                        <button class="option" ${!canUpgrade ? 'disabled' : ''} onclick="upgradeFleet()">
                            <i class="fas fa-arrow-up"></i>
                            <span class="option-text"><strong>升级为${nextLevel.name}</strong><div><small>花费: ${nextLevel.upgradeCost} 两 | 要求声望: ${nextLevel.req.reputation}</small></div></span>
                        </button>
                     </div>`;
        }
    }

    // 显示投资项目
    html += `<div class="section-header" style="margin-top: 20px;"><i class="fas fa-route"></i> 开启商路</div>`;
    if (merchant.voyageCycle && merchant.voyageCycle.isOnVoyage) {
        // 如果正在航行中
        html += `<p class="comment">你的 <strong class="value">${merchant.voyageCycle.tierName}</strong> 船队正在航行中，将于 <strong class="value">${merchant.voyageCycle.turnsLeft}</strong> 回合后归来。</p>`;
    } else if (merchant.fleetLevel > 0) {
        // 如果空闲，显示可投资的商路
        html += `<div class="options">`;
        MARITIME_TRADE_DATA.investmentTiers.forEach(tier => {
            if (merchant.fleetLevel >= tier.level) {
                const canAfford = gameState.finances.wealth >= tier.investment;
                html += `<button class="option" ${!canAfford ? 'disabled' : ''} onclick="startMaritimeTradeCycle(${tier.level})">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="option-text"><strong>${tier.name}</strong><div><small>投入: ${tier.investment} 两 | 周期: ${tier.cycle} 回合</small></div></span>
                         </button>`;
            }
        });
        html += `</div>`;
    } else {
        html += `<p class="comment">请先组建你的舰队。</p>`;
    }

    showDecisionCard("远洋商路", "fa-anchor", html, []);
}

/**
 * 组建/升级舰队
 */
function assembleFleet() {
    const currentLevel = gameState.merchant.fleetLevel;
    const targetLevelInfo = MARITIME_TRADE_DATA.fleetLevels[currentLevel];
    if (gameState.finances.wealth < targetLevelInfo.upgradeCost) { showToast("资金不足！"); return; }
    if (gameState.family.reputation < targetLevelInfo.req.reputation) { showToast("声望不足！"); return; }

    applyEffects({ wealth: -targetLevelInfo.upgradeCost });
    gameState.merchant.fleetLevel = 1;
    showEventCard("舰队组建成功！", "fa-anchor", `你花费 ${targetLevelInfo.upgradeCost} 两，成功组建了你的第一支【${MARITIME_TRADE_DATA.fleetLevels[1].name}】！`);
    showMaritimeTradeUI();
}

function upgradeFleet() {
    const currentLevel = gameState.merchant.fleetLevel;
    const nextLevelInfo = MARITIME_TRADE_DATA.fleetLevels[currentLevel];
    if (!nextLevelInfo || nextLevelInfo.upgradeCost === 0) { showToast("已是最高等级舰队。"); return; }
    if (gameState.finances.wealth < nextLevelInfo.upgradeCost) { showToast("资金不足！"); return; }
    if (gameState.family.reputation < nextLevelInfo.req.reputation) { showToast("声望不足！"); return; }

    applyEffects({ wealth: -nextLevelInfo.upgradeCost });
    gameState.merchant.fleetLevel++;
    showEventCard("舰队升级成功！", "fa-arrow-up", `你花费 ${nextLevelInfo.upgradeCost} 两，成功将舰队升级为【${MARITIME_TRADE_DATA.fleetLevels[gameState.merchant.fleetLevel].name}】！`);
    showMaritimeTradeUI();
}

/**
 * 开始一个新的航行周期
 */
function startMaritimeTradeCycle(tierLevel) {
    const tier = MARITIME_TRADE_DATA.investmentTiers.find(t => t.level === tierLevel);
    if (!tier) return;
    if (gameState.finances.wealth < tier.investment) { showToast("投资本金不足！"); return; }

    applyEffects({ wealth: -tier.investment });
    gameState.merchant.voyageCycle = {
        isOnVoyage: true,
        turnsLeft: tier.cycle,
        tierName: tier.name,
        investment: tier.investment,
        roi_range: tier.roi_range
    };
    showEventCard("开启新航路", "fa-route", `你投入 ${tier.investment} 两开启了【${tier.name}】商路，船队已出发，预计 ${tier.cycle} 回合后归来。`);
    showMaritimeTradeUI();
}

/**
 * 每回合处理航行周期
 */
function processMaritimeTradeCycle() {
    const cycle = gameState.merchant.voyageCycle;
    if (cycle && cycle.isOnVoyage) {
        cycle.turnsLeft--;
        // 每回合有小概率触发一个简单的过程事件，增加代入感
        if (cycle.turnsLeft > 0 && Math.random() < 0.3) {
            const event = getRandomElement([...VOYAGE_EVENTS.positive, ...VOYAGE_EVENTS.negative, ...VOYAGE_EVENTS.neutral]);
            logEvent(`你的远洋商队传来消息：${event.desc}`);
            showToast(`航行消息：${event.name}`);
        }
        if (cycle.turnsLeft <= 0) {
            finalizeMaritimeTrade();
        }
    }
}

/**
 * 结算航行收益
 */
function finalizeMaritimeTrade() {
    const cycle = gameState.merchant.voyageCycle;
    if (!cycle) return;

    const roi = cycle.roi_range[0] + Math.random() * (cycle.roi_range[1] - cycle.roi_range[0]);
    let profit = Math.floor(cycle.investment * roi);
    
    // 应用财运祝福
    if (gameState.buffs && gameState.buffs.wealth_luck) {
        profit = Math.floor(profit * 1.2);
        logEvent("在【财运】祝福的影响下，你的远洋贸易收益增加了。");
    }
    
    const totalReturn = cycle.investment + profit;
    applyEffects({ wealth: totalReturn });

    const resultText = profit >= 0 
        ? `为你带来了 <strong class="value">${profit}</strong> 两的净利润！`
        : `不幸亏损了 <strong class="value">${-profit}</strong> 两。`;
    
    showEventCard(`商路归来：${cycle.tierName}`, "fa-ship", `你投资的【${cycle.tierName}】商队已平安归来，本次航行${resultText}`);
    logMerchantEvent(`【${cycle.tierName}】商路结算，获得 ${totalReturn} 两，净利润为 ${profit} 两。`);

    // 重置航行状态
    gameState.merchant.voyageCycle = null;
}
// 新增一个辅助函数用于航海结算
// [替换此函数]
function showDecisionCard(header, icon, content, options) {
    if (gameState.flags.isBatchProcessing) {
        console.log(`[跳过回合] 决策: ${header} - 自动选择第一项`);
        const firstOption = options.find(opt => !opt.disabled);
        if (firstOption && firstOption.callback) {
            firstOption.callback();
        }
        return;
    }
    closeAllOverlays();
    const card = document.getElementById('decisionCardOverlay');
    if (!card) {
        console.error("Error: Could not find 'decisionCardOverlay' element.");
        return;
    }
    const headerEl = card.querySelector('#decisionCardHeader');
    const animationEl = card.querySelector('#decisionCardAnimation');
    const contentEl = card.querySelector('#decisionCardContent');
    const optionsContainer = card.querySelector('#decisionCardOptions');
    if (headerEl) headerEl.innerHTML = header;
    if (animationEl) animationEl.innerHTML = icon.startsWith('fa-') ? `<i class="fas ${icon}"></i>` : icon;
    if (contentEl) contentEl.innerHTML = content;

    if (optionsContainer) {
        optionsContainer.innerHTML = ''; 

        if (Array.isArray(options)) {
            options.forEach(opt => {
                const button = document.createElement('button');
                button.className = 'option';

                if (opt.htmlContent) {
                    button.innerHTML = opt.htmlContent;
                }

                if (opt.style) {
                    button.setAttribute('style', opt.style);
                }
                button.disabled = opt.disabled || false;
                if (opt.callback) {
                    button.onclick = () => {
                        if (opt.keepOpen !== true) {
                            closeAllOverlays();
                        }
                        opt.callback();
                        if (opt.keepOpen !== true && !isProcessing) {
                            renderGame();
                        }
                    };
                }

                optionsContainer.appendChild(button);
            });
        } else if (typeof options === 'string') {
            optionsContainer.innerHTML = options;
        }
    }
    showOverlay('decisionCardOverlay');
}

function startGuildTrade(guildName) {
    // 关闭当前的决策弹窗
    closeAllOverlays();

    // 使用setTimeout确保旧弹窗完全关闭后再执行新操作
    setTimeout(() => {
        // 先清空商会内容区域，为小游戏做准备
        const contentWrapper = document.getElementById('merchantGuildContent');
        if (contentWrapper) {
            contentWrapper.innerHTML = `
                <div id="miniGameContainer" style="display: none;">
                    </div>
            `;
        } else {
            console.error("无法找到 merchantGuildContent 元素!");
            return; // 如果找不到容器，则不继续执行
        }

        // 然后显示包含了空白容器的商会弹窗
        showOverlay('merchantGuildOverlay');
        
        // 最后，在这个可见的、准备好的容器里启动小游戏
        startMiniGame(guildName); 
    }, 300); // 300毫秒延迟确保过渡流畅
}
function makeInvestment(key) {
    const investment = merchantInvestmentData.find(i => i.id === key);
    if (!investment || gameState.finances.wealth < investment.cost) return;

    applyEffects({ wealth: -investment.cost });
    gameState.merchant.investments.push({ ...investment, purchaseDate: gameState.date.year });
    logMerchantEvent(`你投资 <span class='value'>${investment.cost}</span> 两，开设了一家 <strong class='value'>${investment.name}</strong>。`);
    handleMerchantAction('invest');

}
  function makeInvestment(typeId) {
    const investmentType = merchantInvestmentData.types.find(t => t.id === typeId);
    if (!investmentType) return;

    const initialLevel = investmentType.levels[0];
    if (gameState.finances.wealth < initialLevel.cost) {
        showToast("资金不足");
        return;
    }

    applyEffects({ wealth: -initialLevel.cost });
    const newInvestment = {
        instanceId: `invest_${Date.now()}`,
        typeId: typeId,
        level: 0,
        managerId: 'frugal', // 默认雇佣最便宜的伙计
        strategy: 'stable' // 默认稳健经营
    };
    gameState.merchant.investments.push(newInvestment);
    
    logMerchantEvent(`你投资 <span class='value'>${initialLevel.cost}</span> 两，开设了一家 <strong class='value'>${initialLevel.name}</strong>。`);
    closeAllOverlays();
    showInvestmentDashboard();
}
function processInvestmentReturns() {
    // 如果没有任何产业，则直接返回，不执行任何操作
    if (!gameState.merchant.investments || gameState.merchant.investments.length === 0) {
        return;
    }

    // ▼▼▼ 新增的特殊事件触发逻辑 ▼▼▼
    // 每年有40%的几率触发一个特殊事件
    if (Math.random() < 0.4) { // [语法错误修复] 在这里补上了缺失的 ')'
        const event = getRandomElement(INVESTMENT_EVENTS); // 从新的事件库中随机抽取一个事件
        eventQueue.push(() => {
            // 生成事件的选项按钮
            const options = event.options.map(opt => ({
                htmlContent: `<span class="option-text">${opt.text}</span>`,
                // 检查玩家是否有足够的钱来执行这个选项
                disabled: opt.req && opt.req.wealth && gameState.finances.wealth < opt.req.wealth,
                callback: () => {
                    // 玩家做出选择后，先处理特殊事件的结果
                    const outcomeEffects = handleMerchantSpecialEvent(event, opt);
                    // 然后带着事件的结果（比如收益倍率），去执行最终的年度结算
                    finalizeInvestmentReturns(outcomeEffects.multiplier || 1.0);
                }
            }));
            // 显示决策弹窗，让玩家对特殊事件做出选择
            showDecisionCard(event.title, 'fa-store-alt', event.desc, options);
        });
    } else {
        // ▲▲▲ 如果没有触发特殊事件，则直接进行正常的年度结算 ▲▲▲
        finalizeInvestmentReturns();
    }
}
// 这个函数是结算的核心，保留了您所有的原有逻辑
function finalizeInvestmentReturns(eventMultiplier = 1.0) {
if (gameState.buffs && gameState.buffs.wealth_luck) {
    eventMultiplier *= 1.2; // 投资基础收益提升20%
    logEvent("在【财运】祝福的影响下，你的产业投资回报更高了。");
}
    let totalProfit = 0;
    let yearlyLog = '产业年度结算：<ul>';

    gameState.merchant.investments.forEach(invest => {
        const type = merchantInvestmentData.types.find(t => t.id === invest.typeId);
        const level = type.levels[invest.level];
        const manager = merchantInvestmentData.managers.find(m => m.id === invest.managerId);
        const strategy = merchantInvestmentData.strategies.find(s => s.id === invest.strategy);

        // 【保留】扣除掌柜薪酬
        applyEffects({ wealth: -manager.salary });

        // 【保留】计算基础收益，并应用掌柜和策略的收益修正
        let profit = level.base_return;
        profit *= manager.effect.return_mod;
        profit *= strategy.effect.return_mod;

        // 【保留】计算风险
        let riskFactor = Math.random() * 2; // 0.0 to 2.0
        riskFactor *= manager.effect.risk_mod;
        riskFactor *= strategy.effect.risk_mod;

        // 【保留】根据风险调整最终收益
        profit *= (riskFactor * 0.5 + 0.5); // 使收益在50% - 150%之间波动

        // ▼▼▼ 新增逻辑：应用特殊事件的收益倍率 ▼▼▼
        profit *= eventMultiplier;
        profit = Math.floor(profit);
        // ▲▲▲ 新增逻辑结束 ▲▲▲

        // 【保留】策略的其他效果
        if (strategy.id === 'promote') {
            applyEffects({ wealth: -strategy.cost, reputation: strategy.effect.reputation });
        }
        applyEffects({ reputation: manager.effect.reputation });

        totalProfit += profit;
        yearlyLog += `<li>${level.name}: <span class="value">${profit >= 0 ? '+' : ''}${profit}</span> 两</li>`;
    });

    yearlyLog += `</ul>总计收益 <strong class='value'>${totalProfit}</strong> 两。`;
    applyEffects({ wealth: totalProfit });
    if(gameState.merchant.investments.length > 0) {
        logMerchantEvent(yearlyLog);
    }
    renderGame();
}
function showBuyLandOverlay() {
    let options = landData.map(land => {
        const canAfford = gameState.finances.wealth >= land.cost;
        const meetsReq = isRequirementMet({reputation: land.reputation_req});
        
        const buttonHTML = `
            <div class="marketplace-item" style="border:none; padding: 5px 0;">
                <span>${land.icon} <strong>${land.name}</strong> - ${land.cost}两/亩<br>
                <small>${land.desc}</small>
                ${!meetsReq ? `<br><small style="color:red;">需要声望: ${land.reputation_req}</small>` : ''}
                </span>
            </div>
        `;
            
        return {
            htmlContent: buttonHTML,
            style: `height:auto; padding: 10px 22px;`,
            disabled: !canAfford || !meetsReq,
            // 【修改】这里不再直接调用 buyLand，而是打开一个数量选择弹窗
            callback: () => showBuyLandQuantityModal(land.id)
        };
    });
    
    showDecisionCard('购置地契', 'fa-map-marked-alt', '选择要购买的土地类型：', options);
}
// ===================== 【新增】showBuyLandQuantityModal 函数 START =====================
function showBuyLandQuantityModal(landType) {
    const landInfo = landData.find(l => l.id === landType);
    if (!landInfo) return;

    const maxCanBuy = Math.floor(gameState.finances.wealth / landInfo.cost);
    if (maxCanBuy <= 0) {
        showToast("你的资金不足以购买一亩该类土地。");
        return;
    }

    const contentHTML = `
        <p>购置地契: <strong class="value">${landInfo.name}</strong></p>
        <p>单价: ${landInfo.cost} 两/亩 | 私产: ${gameState.finances.wealth} 两</p>
        <p class="comment">最多可购买: ${maxCanBuy} 亩</p>
        <div class="quantity-slider-container">
            <input type="range" id="quantitySlider" value="1" min="1" max="${maxCanBuy}" oninput="this.nextElementSibling.value = this.value">
            <input type="number" id="quantityInput" value="1" min="1" max="${maxCanBuy}" oninput="this.previousElementSibling.value = this.value">
        </div>
    `;

    const options = [{
        htmlContent: '确认购置',
        callback: () => {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (isNaN(quantity) || quantity <= 0 || quantity > maxCanBuy) {
                showToast("请输入有效的购买数量。");
                return;
            }
            // 调用修改后的 buyLand 函数
            buyLand(landType, quantity);
        }
    }];
    showDecisionCard(`购置${landInfo.name}`, 'fa-map-marked-alt', contentHTML, options);
}
// ===================== 【新增】showBuyLandQuantityModal 函数 END =====================
// ===================== 【替换】buyLand 函数 START =====================
function buyLand(landType, quantity) {
    const landInfo = landData.find(l => l.id === landType);
    if (!landInfo) return;

    const totalCost = landInfo.cost * quantity;

    if (gameState.finances.wealth < totalCost) {
        showToast("资金不足");
        return;
    }

    if (!isRequirementMet({reputation: landInfo.reputation_req})) {
        showToast("声望不足");
        return;
    }

    applyEffects({ wealth: -totalCost });
    gameState.merchant.ownedLand[landType] = (gameState.merchant.ownedLand[landType] || 0) + quantity;

    logMerchantEvent(`你花费 <span class='value'>${totalCost}</span> 两，购置了 ${quantity} 亩 <strong class='value'>${landInfo.name}</strong>。`);
    showEventCard('购置成功', 'fa-map-marked-alt', `你成功购置了 ${quantity} 亩${landInfo.name}！`);

    closeAllOverlays();
    // 延迟一点再打开，确保UI流畅
    setTimeout(() => handleMerchantAction('farm'), 300);
}
// ===================== 【替换】buyLand 函数 END =====================
// ===================== 【替换】showPlantCropOverlay 函数 START =====================
function showPlantCropOverlay(landType) {
    const ownedAcres = gameState.merchant.ownedLand[landType] || 0;
    const plantedAcres = gameState.merchant.activeCrops
        .filter(c => c.landType === landType)
        .reduce((sum, crop) => sum + crop.acres, 0);
    const availableAcres = ownedAcres - plantedAcres;

    if (availableAcres <= 0) {
        showToast("这片土地已经没有可用的地方了。");
        return;
    }

    const landInfo = landData.find(l => l.id === landType);
    const wisdom = gameState.player.attributes.wisdom;

    let options = cropData.map(crop => {
        const canAfford = gameState.finances.wealth >= crop.cost;
        let hint = "";
        const adaptation = adaptationMatrix[landType]?.[crop.id] ?? 1;
        if (wisdom > 70) {
            if (adaptation > 1.2) hint = `<span style='color:green;'>[绝配]</span>`;
            else if (adaptation < 1) hint = `<span style='color:red;'>[不适]</span>`;
            else hint = `[适宜]`;
        }

        const buttonHTML = `
            ${crop.icon} 
            <span class="option-text">
                <strong>${crop.name}</strong> (-${crop.cost}两/亩) ${hint}
                <div><small>${crop.desc} (周期: ${crop.cycle}回合)</small></div>
            </span>`;

        return {
            htmlContent: buttonHTML,
            disabled: !canAfford,
            // 【修改】这里不再使用 prompt，而是调用新的弹窗函数
            callback: () => {
                showPlantCropQuantityModal(landType, crop.id);
            }
        };
    });

    showDecisionCard(`为${landInfo.name}选择作物`, 'fa-seedling', `你目前有 ${availableAcres} 亩可用土地。`, options);
}
function plantCrop(landType, cropId, acres) {
    const cropInfo = cropData.find(c => c.id === cropId);
    const totalCost = cropInfo.cost * acres;

    if (!cropInfo || gameState.finances.wealth < totalCost) {
        showToast("资金不足以种植这么多土地。");
        return;
    }

    applyEffects({ wealth: -totalCost });
    gameState.merchant.activeCrops.push({
        id: `crop_${Date.now()}`,
        landType: landType,
        cropId: cropId,
        acres: acres,
        cycleLeft: cropInfo.cycle
    });

    logMerchantEvent(`你在 ${acres} 亩土地上播下了 <strong class='value'>${cropInfo.name}</strong> 的种子。`);

    closeAllOverlays();
    // 延迟一点再打开，确保UI流畅
    setTimeout(() => handleMerchantAction('farm'), 300);
}
// ===================== 【新增】showPlantCropQuantityModal 函数 START =====================
function showPlantCropQuantityModal(landType, cropId) {
    const ownedAcres = gameState.merchant.ownedLand[landType] || 0;
    const plantedAcres = gameState.merchant.activeCrops
        .filter(c => c.landType === landType)
        .reduce((sum, crop) => sum + crop.acres, 0);
    const availableAcres = ownedAcres - plantedAcres;
    
    const cropInfo = cropData.find(c => c.id === cropId);
    if (!cropInfo) return;

    const maxCanPlantByMoney = Math.floor(gameState.finances.wealth / cropInfo.cost);
    const maxCanPlant = Math.min(availableAcres, maxCanPlantByMoney);

    if (maxCanPlant <= 0) {
        showToast("你没有足够的土地或资金来种植此作物。");
        return;
    }

    const contentHTML = `
        <p>种植作物: <strong class="value">${cropInfo.name}</strong></p>
        <p>播种成本: ${cropInfo.cost} 两/亩 | 私产: ${gameState.finances.wealth} 两</p>
        <p class="comment">最多可种植: ${maxCanPlant} 亩</p>
        <div class="quantity-slider-container">
            <input type="range" id="quantitySlider" value="1" min="1" max="${maxCanPlant}" oninput="this.nextElementSibling.value = this.value">
            <input type="number" id="quantityInput" value="1" min="1" max="${maxCanPlant}" oninput="this.previousElementSibling.value = this.value">
        </div>
    `;

    const options = [{
        htmlContent: '确认播种',
        callback: () => {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (isNaN(quantity) || quantity <= 0 || quantity > maxCanPlant) {
                showToast("请输入有效的亩数。");
                return;
            }
            plantCrop(landType, cropId, quantity);
        }
    }];
    showDecisionCard(`播种${cropInfo.name}`, 'fa-seedling', contentHTML, options);
}
// ===================== 【新增】showPlantCropQuantityModal 函数 END =====================
function processCropGrowth() {
    if (!gameState.merchant.activeCrops) return;

    for (let i = gameState.merchant.activeCrops.length - 1; i >= 0; i--) {
        const crop = gameState.merchant.activeCrops[i];
        crop.cycleLeft--;

        if (crop.cycleLeft <= 0) {
            if (Math.random() < 0.4) { // [频率修复] 将这里的 0.15 提升到 0.4
                const event = getRandomElement(FARMING_EVENTS);
                eventQueue.push(() => {
                    const options = event.options.map(opt => ({
                        htmlContent: `<span class="option-text">${opt.text}</span>`,
                        disabled: opt.req.wealth && gameState.finances.wealth < opt.req.wealth,
                        callback: () => {
                            const outcomeEffects = handleMerchantSpecialEvent(event, opt);
                            finalizeHarvest(crop, i, outcomeEffects.multiplier || 1.0);
                        }
                    }));
                    showDecisionCard(event.title, 'fa-seedling', event.desc, options);
                });
            } else {
                finalizeHarvest(crop, i);
            }
        }
    }
}
// 新增一个辅助函数用于收获结算，避免代码重复
// ===================== 【替换】finalizeHarvest 函数 START =====================
function finalizeHarvest(crop, cropIndex, multiplier = 1.0) {
    if (gameState.buffs && gameState.buffs.wealth_luck) {
        multiplier *= 1.2; // 农事基础收益提升20%
        logEvent("在【财运】祝福的影响下，你的田地收成更好了。");
    }
    const landType = crop.landType;
    const cropInfo = cropData.find(c => c.id === crop.cropId);
    const adaptation = adaptationMatrix[landType]?.[crop.cropId] ?? 1;

    // 核心修改：收益乘以种植的亩数
    const finalYield = Math.floor(cropInfo.yield * adaptation * crop.acres * (0.8 + Math.random()*0.4) * multiplier);

    applyEffects({ wealth: finalYield });
    if(cropInfo.effect) {
        let totalEffects = {};
        for (const attr in cropInfo.effect) {
            totalEffects[attr] = cropInfo.effect[attr] * crop.acres; // 属性加成也乘以亩数
        }
        applyEffects({attributes: totalEffects});
    }

    const harvestMsg = `你种植在${landData.find(l=>l.id===landType).name}的 ${crop.acres} 亩 ${cropInfo.name} 成熟了，最终收获 <strong class='value'>${finalYield}</strong> 两。`;

    // 【新增的核心代码】在这里将收获信息记录到记事本
    logEvent(harvestMsg);

    // 保留原有的弹窗提示逻辑
    eventQueue.push(() => {
        showEventCard(`🌱 收获之时 🌱`, cropInfo.icon, harvestMsg);
    });

    // 从activeCrops数组中移除已收获的作物
    gameState.merchant.activeCrops.splice(cropIndex, 1);
}
// ===================== 【替换】finalizeHarvest 函数 END =====================
// =======================================================================
// ===================== 【新增】主动结识新朋友功能 ========================
// =======================================================================
function strollForEncounters() {
    const cost = 50;
    if (gameState.finances.wealth < cost) {
        showToast(`闲逛需要 ${cost} 两盘缠，你的钱不够。`);
        return;
    }
    applyEffects({ wealth: -cost, attributes: { health: -1 } });

    const roll = Math.random();
    // 60% 的高几率遇到新朋友
    if (roll < 0.60) {
        triggerNewEncounter();
    } 
    // 30% 的几率听到一些趣闻
    else if (roll < 0.90) {
        const gossip = getRandomElement(GOSSIP_DATA);
        showEventCard('街谈巷议', 'fa-comments', `你在街上闲逛，无意间听到一则趣闻：<br><p class="comment" style="margin-top:10px;">“${gossip}”</p>`);
        applyEffects({ attributes: { wisdom: 1 } });
    } 
    // 10% 的几率只是放松了心情
    else {
        showEventCard('京城闲逛', 'fa-walking', '你在京城的街巷中漫步了一个下午，并未遇到什么特别的人和事，但心情放松了不少。');
        applyEffects({ attributes: { health: 2 } });
    }
    // 每次闲逛后都刷新一下游戏界面，以防万一
    renderGame();
}
function handleOuting(location) {
    if (isProcessing) return;

    if(!gameState.flags.wishingWellThisTurn && Math.random() < 0.03) {
        gameState.flags.wishingWellThisTurn = true;
        showWishingWell(); return;
    }
    if (Math.random() < 0.1) {
        triggerNewEncounter();
        return;
    }

    switch (location) {
        case 'market': showMarket(); return;
        case 'restaurant': showRestaurant(); return;
        case 'temple':
            const templeOptions = [
                {htmlContent:`<i class="fas fa-users"></i> 拜祭先祖`, callback: () => handleTempleVisit('ancestors')},
                {htmlContent:`<i class="fas fa-praying-hands"></i> 求神拜佛`, callback: () => handleTempleVisit('buddha')}
            ];
            showDecisionCard('参拜寺庙', 'fa-gopuram', '你来到香火鼎盛的寺庙，打算...', templeOptions);
            return;
        case 'clinic': showClinic(); return;
        case 'fengyuejian': showFengYueJian(); return;
    }
}
// [用这个新版本替换] handleTempleVisit 函数
function handleTempleVisit(type) {
    if (type === 'ancestors') {
        const effect = { virtue: 2 };
        const logText = "你虔诚地拜祭了列祖列宗，家族声望提升，内心感到一片宁静。";
        applyEffects({ reputation: 5, attributes: effect });
        logEvent(logText + " 声望+5, 品德+2。");
        showEventCard('寺庙祈福', 'fa-gopuram', logText);
    } else { // 'buddha'
        const cost = 100; // 许愿的香火钱
        if (gameState.finances.wealth < cost) {
            showToast("你的香火钱不足100两，佛祖未理会你的祈求。");
            return;
        }

        const options = [
            {
                htmlContent: `<i class="fas fa-ring"></i> <strong>求姻缘</strong><div><small>提升遇到高属性对象的几率</small></div>`,
                callback: () => grantBuff('partner_luck', '姻缘', cost)
            },
            {
                htmlContent: `<i class="fas fa-arrow-up"></i> <strong>求功名</strong><div><small>提升工作获取功绩的效率</small></div>`,
                callback: () => grantBuff('career_luck', '功名', cost)
            },
            {
                htmlContent: `<i class="fas fa-coins"></i> <strong>求财运</strong><div><small>提升投资和农事的收益</small></div>`,
                callback: () => grantBuff('wealth_luck', '财运', cost)
            }
        ];
        showDecisionCard('虔诚许愿', 'fa-praying-hands', `你花费 <span class="value">${cost}</span> 两香火钱，在佛前虔诚祈祷，你希望求得...`, options);
    }
}

// [新增] 授予Buff的辅助函数
function grantBuff(buffId, buffName, cost) {
    applyEffects({ wealth: -cost, attributes: { virtue: 2 } });
    gameState.buffs[buffId] = { duration: 4 }; // Buff持续4回合(2年)
    const logText = `你花费 ${cost} 两香火钱，虔诚祈祷，求得了【${buffName}】的祝福。`;
    logEvent(logText);
    showEventCard('佛光普照', 'fa-praying-hands', logText);
}
function triggerNewEncounter() {
    let encounterChance = (gameState.player.attributes.charm || 0) / 150 + 0.3;
    if(Math.random() > encounterChance) { showToast("你今日外出并未遇到什么特别的人。"); return; }

    const gender = Math.random() < 0.5 ? 'male' : 'female';

    let npcOptions = { gender: gender, age: getRandomInt(gameState.player.age - 2, gameState.player.age + 5) };
if (gameState.buffs && gameState.buffs.partner_luck) {
    npcOptions.attributes = { talent: 20, wisdom: 20, charm: 20 }; // 增加基础属性
    logEvent("在【姻缘】祝福的影响下，你似乎遇到了一个特别的人。");
}
npcOptions.favor = getRandomInt(20, 40);
const newNpc = generateNPC(npcOptions);
    const bg = getRandomElement(gender === 'male' ? suitorBackgrounds : ladyBackgrounds);

    let description = (gameState.player.attributes.charm > 80) ? `你的风姿吸引了对方的注意，TA主动前来与你结交。` : `你们在人群中偶然相遇，相谈甚欢。`;
    description += `<br><br>对方名为 <strong class="value">${newNpc.name}</strong>，${bg.desc}`;

    let options = [
        {htmlContent:`<i class="fas fa-user-plus"></i> 与TA结交`, callback:() => befriendNpc(newNpc.id)},
        {htmlContent:`<i class="fas fa-times"></i> 婉言谢绝`, style:`background:linear-gradient(135deg, #e74c3c, #c0392b);`, callback:() => closeAllOverlays()}
    ];
    document.getElementById('newFriendEncounterHeader').innerText = `萍水相逢`;
    document.getElementById('newFriendEncounterContent').innerHTML = description;
    showDecisionCard('萍水相逢', 'fa-handshake', description, options);
}
// [用这个新版本替换]
function befriendNpc(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return;

    npc.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;
    const isOppositeGender = npc.gender !== gameState.player.gender;
    const isMalePlayer = gameState.player.gender === 'male';

    const relType = isOppositeGender
        ? (isMalePlayer ? 'red_confidante' : 'blue_confidante')
        : (isMalePlayer ? 'brother' : 'confidante');

    if (!gameState.social.relationships[npcId]) {
        gameState.social.relationships[npcId] = {
            type: relType,
            favor: npc.favor,
            trust: 10,      
            influence: 0,   
            emotionValue: 20,
            level: 0,        
        };
        
        // ▼▼▼ 核心修复：确保NPC被添加到正确的分类列表中 ▼▼▼
        if (relType === 'brother' || relType === 'confidante') {
            if (!gameState.social.friends) gameState.social.friends = [];
            gameState.social.friends.push(npcId);
        }
        // ▲▲▲ 修复结束 ▲▲▲
    }

    gameState.suitors = gameState.suitors.filter(id => id !== npcId);

    const relData = RELATIONSHIP_DATA[relType];
    showEventCard('喜得知己', 'fa-user-friends', `你结识了新的友人 <strong class="highlight-npc">${npc.name}</strong>，你们成为了${relData ? relData.name : '朋友'}。`);
    renderGame();
}
function showMarket() {
    const itemsForSale = [...marketItems.common, ...(marketItems[gameState.player.gender] || [])];
    // 【新增】获取本回合已购买物品列表
    const boughtThisTurn = gameState.flags.marketItemsBoughtThisTurn || [];
    
    let html = `<p>市集上人来人往，热闹非凡。你可以买到各种物品。</p>`;
    html += itemsForSale.map(item => {
        const canAfford = gameState.finances.wealth >= item.price;
        // 【新增】检查是否已购买
        const isBought = boughtThisTurn.includes(item.id);
        const isDisabled = !canAfford || isBought;
        
        return ` <div class="marketplace-item"> 
                    <span><strong>${item.name}</strong>: ${item.desc}</span> 
                    <button class="control-btn" ${isDisabled ? 'disabled' : ''} onclick="buyMarketItem('${item.id}')">
                        ${isBought ? '本回合已购' : `购买 (-${item.price}两)`}
                    </button> 
                 </div>`;
    }).join('');

    document.getElementById('marketContent').innerHTML = html;
    showOverlay('marketOverlay');
}
function buyMarketItem(itemId) {
    const allItems = [...marketItems.common, ...marketItems.female, ...marketItems.male];
    const item = allItems.find(i => i.id === itemId);
    if (!item) return;

    const cost = item.price || item.cost;
    if (gameState.finances.wealth < cost) {
        showToast("资金不足。");
        return;
    }

    if (item.type === 'collectible') {
        buyAsset(item.id);
    } else {
        // 【新增】将物品ID添加到已购列表
        if (!gameState.flags.marketItemsBoughtThisTurn) gameState.flags.marketItemsBoughtThisTurn = [];
        gameState.flags.marketItemsBoughtThisTurn.push(itemId);

        applyEffects({ wealth: -cost });
        if (item.effect) {
            applyEffects({ attributes: item.effect });
        }
        
        let effectText = item.effect ? Object.entries(item.effect).map(([k,v]) => `${ATTR_MAP[k]}+${v}`).join('，') : '';
        
        showEventCard(
            '收入囊中', 
            'fa-shopping-bag', 
            `你花费 <span class='value'>${cost}</span> 两，在市集购买了 <strong class='value'>${item.name}</strong>。<br>${effectText}`,
            // 【修改】回调函数现在会刷新市集界面，以显示按钮的禁用状态
            [{ text: '心满意足', callback: showMarket }]
        );
    }
}
function showRestaurant() {
    let html = `<h4><i class="fas fa-user-friends"></i> 宴请他人</h4>`;
    let peopleToInvite = [
    // 先把配偶加进来
    gameState.marriage.isMarried ? gameState.npcs[gameState.marriage.spouseId] : null, 
    ...Object.values(gameState.family.members).map(id => gameState.npcs[id]),
    ...gameState.social.friends.map(id => gameState.npcs[id]),
    ...gameState.suitors.map(id => gameState.npcs[id])
].filter(p => p && !p.isDead);

// 为了防止重复，使用Set去重
const uniqueIds = new Set(peopleToInvite.map(p => p.id));
peopleToInvite = Array.from(uniqueIds).map(id => gameState.npcs[id]).slice(0, 5);

    if (peopleToInvite.length > 0) {
        html += `<div class="options">`;
        peopleToInvite.forEach(person => {
            html += `<button class="option" onclick="treatToMeal('${person.id}')"><i class="fas fa-user"></i> 宴请 ${person.role || ''} ${person.name}</button>`;
        });
        html += `</div>`;
    } else { html += `<p class="comment">暂无可宴请之人。</p>`; }

    html += `<h4 style="margin-top:20px;"><i class="fas fa-utensils"></i> 点菜自用</h4>`;
    html += restaurantMenu.map(item => {
        const canAfford = gameState.finances.wealth >= item.price;
        return `<div class="marketplace-item">
            <span><strong>${item.name}</strong>: ${item.desc}</span>
            <button class="control-btn" ${!canAfford ? 'disabled' : ''} onclick="buyRestaurantItem('${item.id}')">点菜 (-${item.price}两)</button>
        </div>`;
    }).join('');

    document.getElementById('restaurantContent').innerHTML = html;
    showOverlay('restaurantOverlay');
}
function treatToMeal(npcId) {
    const person = gameState.npcs[npcId];
    if(!person) return;
    const cost = restaurantMenu.find(m=>m.id==='banquet').price;
    if (gameState.finances.wealth < cost) { showToast("资金不足。"); return; }

    person.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;
    applyEffects({ wealth: -cost, relationship: { targetId: person.id, favor: getRandomInt(5, 10) } });

    let relationshipText = `你与 ${person.name} 宾主尽欢，好感提升了。`;
    if(person.role && (person.role.includes('父') || person.role.includes('母'))) {
        relationshipText = `你孝敬父母，他们的好感提升了。`;
        applyEffects({attributes: {virtue: 2}});
    }
    showEventCard('宴请宾客', 'fa-utensils', `你花费 <span class='value'>${cost}</span> 两举办宴席。${relationshipText}`);
renderGame(); 
    showRestaurant();
}
// [替换] 找到这个函数并用下面的代码完整替换
function buyRestaurantItem(itemId) {
    const item = restaurantMenu.find(i => i.id === itemId);
    if (!item || gameState.finances.wealth < item.price) { 
        showToast("资金不足。"); 
        return; 
    }

    // [新增] 黄金薯条的特殊逻辑
    if (itemId === 'golden_fries') {
        if (gameState.flags.ateGoldenFriesThisTurn) {
            showToast("此物虽好，不可贪多，下回合再来吧。");
            return;
        }
        gameState.flags.ateGoldenFriesThisTurn = true;
        // 为职业功绩加成
        if (gameState.career.path) {
            gameState.career.performance = (gameState.career.performance || 0) + item.effect.performance;
        }
        // 为基础属性加成
        applyEffects({ wealth: -item.price, attributes: { talent: item.effect.talent, martial: item.effect.martial } });
        showEventCard('异域珍馐', 'fa-utensils', `你享用了黄金薯条，感觉浑身充满了力量！功绩+${item.effect.performance}，才情+${item.effect.talent}，武学+${item.effect.martial}。`);

    } else {
        // 原有的普通菜品逻辑
        applyEffects({ wealth: -item.price, attributes: item.effect });
        showEventCard('一饱口福', 'fa-utensils', `你享用了${item.name}，心情愉悦。`);
    }
}
function showClinic() {
    let html = ``;
    if (gameState.status.disease) {
        const d = diseases[gameState.status.disease.id];
        html += `<h4><i class="fas fa-procedures"></i> 当前病情</h4>
                <p>你患上了<strong style="color:red;">${d.name}</strong>，还剩 ${gameState.status.disease.duration} 回合痊愈。每回合健康-${d.health_decline}。</p>
                <h4><i class="fas fa-user-md"></i> 寻医问药</h4>`;
        html += famousDoctors.map(doc => {
            const canAfford = gameState.finances.wealth >= doc.fee;
            return `<div class="marketplace-item">
                <span><strong>${doc.name}</strong>: ${doc.desc}</span>
                <button class="control-btn" ${!canAfford ? 'disabled' : ''} onclick="seekTreatment('${doc.name}')">求诊 (-${doc.fee}两)</button>
            </div>`;
        }).join('');
    } else {
        html += `<h4><i class="fas fa-stethoscope"></i> 健康检查</h4>
                <p>你目前身体康健，但也可以花费 <span class='value'>50</span> 两进行一次健康检查，巩固元气。</p>
                <button class="option" onclick="healthCheck()"><i class="fas fa-heartbeat"></i> 进行健康检查</button>`;
    }
    document.getElementById('clinicContent').innerHTML = html;
    showOverlay('clinicOverlay');
}
function healthCheck() {
    const cost = 50;
    if (gameState.finances.wealth < cost) { showToast("资金不足。"); return; }
    applyEffects({ wealth: -cost, attributes: { health: 5 } });
    showEventCard('身体康健', 'fa-heartbeat', '你进行了健康检查，感觉身体更加硬朗了。');
}
function seekTreatment(doctorName) {
    const doctor = famousDoctors.find(d => d.name === doctorName);
    const diseaseInfo = gameState.status.disease;
    if (!doctor || !diseaseInfo || gameState.finances.wealth < doctor.fee) { showToast("资金不足。"); return; }

    applyEffects({ wealth: -doctor.fee });
    const disease = diseases[diseaseInfo.id];
    const cureChance = disease.initial_cure_chance + doctor.success_rate_bonus - ((gameState.player.age-20)*0.005);
    let resultText = '';
    if (Math.random() < cureChance) {
        resultText = `<strong class='value'>${doctor.name}</strong>果然名不虚传，药到病除！你的<strong class='value'>${disease.name}</strong>已被治愈。`;
        gameState.status.disease = null;
    } else {
        resultText = `连<strong class='value'>${doctor.name}</strong>也对你的病症束手无策，只是开了一些缓解症状的药物。`;
    }
    showEventCard("🩺 诊疗结果 🩺", "fa-file-medical", `你花费 <span class='value'>${doctor.fee}</span> 两求医。<br>${resultText}`);
    renderGame();
}
function handleDisease() {
    if (!gameState.status.disease && Math.random() < 0.05) {
        const diseaseKeys = Object.keys(diseases).filter(k => diseases[k].source !== 'intimate');
        const randomDiseaseKey = getRandomElement(diseaseKeys);
        gameState.status.disease = { id: randomDiseaseKey, duration: diseases[randomDiseaseKey].duration };
        showEventCard('身体抱恙', 'fa-thermometer-half', `你近来感到身体不适，似乎是染上了<strong style="color:red;">${diseases[randomDiseaseKey].name}</strong>。`);
        return;
    }

    if (!gameState.status.disease) return;
    const dInfo = gameState.status.disease;
    const d = diseases[dInfo.id];
    dInfo.duration--;
    applyEffects({ attributes: { health: -d.health_decline, charm: -1 } });
    showToast(`${d.name}使你感到虚弱, 健康-${d.health_decline}`);

    const deathChance = d.death_chance + (gameState.player.health < 20 ? 0.1 : 0);
    if (deathChance > 0 && Math.random() < deathChance) {
        logEvent(`你终究没能扛过<strong class='value'>${d.name}</strong>的折磨，病故了。`);
        showEndGame({ title: "贫病交加", text: `你因病去世，年仅${Math.floor(gameState.player.age)}岁。` });
        return;
    }

    if (dInfo.duration <= 0) {
        showEventCard('大病初愈', 'fa-sun', `你的<strong class='value'>${d.name}</strong>终于自愈了，但身体还是虚弱了不少。`);
        gameState.status.disease = null;
    }
}
function showWishingWell() {
    const options = [
        {htmlContent:`<i class="fas fa-leaf"></i> 进入秘境`, callback: () => enterWishingWell()},
        {htmlContent:`<i class="fas fa-times"></i> 转身离开`, style:`background: linear-gradient(135deg, #e74c3c, #c0392b);`, callback: () => closeAllOverlays()}
    ];
    showDecisionCard("仙池秘境", "✨", `<p>你无意中步入一处仙气缭绕的秘境，中央有一口古井，似乎散发着奇异的光芒。井边石碑上刻着字：“投汝三成之财，圆汝一愿。”</p>`, options);
}
function enterWishingWell() {
    const cost = Math.floor(gameState.finances.wealth * 0.3);
    if (gameState.finances.wealth < 100) { showToast("你的财富不足以引起仙池的注意。"); closeAllOverlays(); return; }

    let options = wishingWellItems.map(item => {
        return {
            htmlContent:`<span class="option-text"><strong>${item.name}</strong><div><small>${item.desc}</small></div></span>`,
            callback: () => buyWishingWellItem(item.id)
        };
    });

    showDecisionCard(
        '仙池献礼', '✨',
        `你向井中投入了 <span class='value'>${cost}</span> 两，井水泛起涟漪，浮现出几样宝物。请选择你的愿望：`,
        options
    );
}

function buyWishingWellItem(itemId) {
    const item = wishingWellItems.find(i => i.id === itemId);
    if (!item) return;
    const cost = Math.floor(gameState.finances.wealth * 0.3);
    applyEffects({ wealth: -cost });
    let logText = `你花费 <span class='value'>${cost}</span> 两，从许愿池中获得了 <strong class='value'>${item.name}</strong>！`;

    if (item.effect.career_progress) {
        if (gameState.career.path) {
            gameState.career.performance += item.effect.career_progress;
            logText += " 一股神秘的力量加持在你身上，你的功绩大幅提升了。";
            checkForPromotion();
        } else {
            logText += " 你还未投身事业，符咒的力量暂时储存了起来。";
        }
    } else if (item.effect.partner_favor) {
        const targetId = gameState.marriage.isMarried ? gameState.marriage.spouseId : (gameState.suitors.map(id => gameState.npcs[id]).sort((a, b) => b.favor - a.favor)[0]?.id || null);
        if (targetId) {
            applyEffects({
                relationship: {
                    targetId: targetId,
                    favor: item.effect.partner_favor
                }
            });
            logText += ` 你将同心结赠予了 <strong class="highlight-npc">${gameState.npcs[targetId].name}</strong>，对方好感大增！`;
        } else {
            logText += " 你目前没有心上人，同心结被你珍藏了起来。";
        }
    }
    // ===================== 【核心修改区域】 START =====================
    else if (item.effect.reputation) {
        // 【新增代码】专门处理声望
        applyEffects({
            reputation: item.effect.reputation
        });
        logText += ` 你的家族声望大幅提升了！`;
    }
    // ===================== 【核心修改区域】 END =====================
    else {
        applyEffects({
            attributes: item.effect
        });
        logText += ` 你的${Object.keys(item.effect).map(k => ATTR_MAP[k]).join('')}属性大幅提升了！`;
    }
    showEventCard('仙池赐福', '✨', logText);
}
// =======================================================================
// ============================= SECRET RELATIONSHIPS ====================
// =======================================================================
function interactWithNpc(npcId, action) {
    const npc = gameState.npcs[npcId];
    if (!npc || npc.isDead) return;


    npc.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;
    let favorChange = 0; 
    let emotionValueChange = 0;
    let logText = '';

    switch (action) {
        case 'chat':
            favorChange = getRandomInt(1, 4);
            emotionValueChange = getRandomInt(5, 8);
            logText = `你与${npc.name}闲聊片刻，相談甚欢。`;
            break;
        case 'date':
            if(gameState.finances.wealth < 100) { showToast("资金不足以安排一次像样的约会"); return; }
            applyEffects({wealth: -100});
            showDateScene(npc);
            return; 
    }

    if (favorChange !== 0 || emotionValueChange !== 0) {
        applyEffects({ 
            relationship: { 
                targetId: npcId, 
                favor: favorChange, 
                emotionValue: emotionValueChange
            } 
        });
        logText += ` 好感+${favorChange}。`;
    }

    if (logText) showEventCard('人际互动', 'fa-users', logText);

    showNPCDetails(npcId);
}

// ▼▼▼ 请在interactWithNpc函数后，【新增】以下所有函数 ▼▼▼
function handleSocialInteraction(npcId, relType, interactionId) {
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    const relData = RELATIONSHIP_DATA[relType];
    const interaction = relData ? relData.interactions.find(i => i.id === interactionId) : null;
    
    if (!npc || !interaction) {
        showToast("互动数据错误");
        return;
    }

    const rel = gameState.social.relationships[npcId];
    if (rel) {
        rel.emotionValue = (rel.emotionValue || 0) + getRandomInt(5, 10);
        rel.eventsExperienced = (rel.eventsExperienced || 0) + 1;
    }

    switch (interactionId) {
        case 'moon_drink': {
            showDecisionCard('月下对饮', 'fa-wine-glass-alt',
                `明月当空，<strong class="highlight-npc">${npc.name}</strong>邀你小酌，席间谈及人生理想与遗憾。`,
                [
                    { htmlContent: '【倾诉心声】', callback: () => {
                        showEventCard('推心置腹', 'fa-heart', '你的真诚打动了对方。好感+10，情感值+15。');
                        if(rel) rel.emotionValue += 15;
                        applyEffects({ relationship: { targetId: npcId, favor: 10 } });
                    }},
                    { htmlContent: '【借酒调侃】', callback: () => {
                        if (player.attributes.charm >= 70) {
                            showEventCard('风趣的回应', 'fa-grin-wink', '你风趣的调侃让对方莞尔一笑。好感+15。');
                            applyEffects({ relationship: { targetId: npcId, favor: 15 } });
                        } else {
                            showEventCard('尴尬的玩笑', 'fa-meh', '你的调侃略显轻浮，对方皱了皱眉。好感-5。');
                            applyEffects({ relationship: { targetId: npcId, favor: -5 } });
                        }
                    }}
                ]
            );
            break;
        }
        case 'become_lover': {
     showDecisionCard('跨越界线', 'fa-fire',
        `在一个气氛暧昧的夜晚，你与 <strong class="highlight-npc">${npc.name}</strong> 之间似乎有什么东西将要改变...`,
        [
            { htmlContent: '【顺其自然】', callback: () => {
                rel.type = 'lover';
                rel.level = 0;
                rel.emotionValue = 50;
                showEventCard('情愫暗生', 'fa-heart-broken', '你们跨越了知己的界线，成为秘密情人。');
                showNPCDetails(npcId); // <<-- 新增这一行，用于在状态更新后立刻刷新NPC详情卡
            }},
                    { htmlContent: '【悬崖勒马】', callback: () => {
                        showEventCard('坚守底线', 'fa-hand-paper', '你及时克制住了自己。好感-10，品德+10。');
                        applyEffects({ relationship: { targetId: npcId, favor: -10 }, attributes: { virtue: 10 } });
                    }}
                ]
            );
            break;
        }
        case 'rendezvous':
            showEventCard('月下之约', 'fa-kiss-wink-heart', '你们在月影花香中互诉衷肠，情意更浓。好感+20。');
            applyEffects({ relationship: { targetId: npcId, favor: 20 } });
            if(Math.random() < 0.2) triggerBirth(npcId, true);
            break;
    }

    updateRelationshipLevel(npcId);
    showNPCDetails(npcId);
}

// ===================== 【第一步(2/2)：替换此函数】修复关系等级判定逻辑 =====================
function updateRelationshipLevel(npcId, forceUpgrade = false) {
    const rel = gameState.social.relationships[npcId];
    if (!rel) return;
    
    // [修改] 根据关系类型动态选择正确的等级数据，并增加安全检查
    const relDataDefinition = RELATIONSHIP_DATA[rel.type];
    if (!relDataDefinition) {
        // 如果关系类型未在 RELATIONSHIP_DATA 中定义，则直接返回，避免错误
        return; 
    }
    
    const levelDataType = relDataDefinition.type;
    const levelData = RELATIONSHIP_LEVELS[levelDataType] || RELATIONSHIP_LEVELS.friendship;

    let newLevel = rel.level || 0;

    for (let i = levelData.length - 1; i >= 0; i--) {
        if ((rel.emotionValue || 0) >= levelData[i].threshold) {
            newLevel = i;
            break;
        }
    }

    if (forceUpgrade) {
        newLevel = Math.min(levelData.length - 1, (rel.level || 0) + 1);
    }
    
    if (newLevel > (rel.level || 0)) {
        rel.level = newLevel;
        // [修改] 确保能从正确的定义中获取等级名称
        const newLevelName = (relDataDefinition.levelNames && relDataDefinition.levelNames[newLevel]) || levelData[newLevel].name;
        showEventCard('关系升华', 'fa-level-up-alt', `你与 <strong class="highlight-npc">${gameState.npcs[npcId].name}</strong> 的关系提升为 <strong class="value">${newLevelName}</strong>！`);
    } else if (newLevel < (rel.level || 0)) {
        rel.level = newLevel;
        const newLevelName = (relDataDefinition.levelNames && relDataDefinition.levelNames[newLevel]) || levelData[newLevel].name;
        showEventCard('关系降级', 'fa-level-down-alt', `你与 <strong class="highlight-npc">${gameState.npcs[npcId].name}</strong> 的关系降级为 <strong class="value">${newLevelName}</strong>。`);
    }
}

function checkForSecretLoverDiscovery() {
    if (gameState.social.secretLovers.length === 0 || !gameState.marriage.isMarried) return;
    const discoveryChance = 0.05 * gameState.social.secretLovers.length;
    if (Math.random() < discoveryChance) {
        const lover = getRandomElement(gameState.social.secretLovers.map(id => gameState.npcs[id]));
        const spouse = gameState.npcs[gameState.marriage.spouseId];
        let content = `你与 <strong class="highlight-npc">${lover.name}</strong> 的私情不慎被府内丫鬟撞见告密， <strong class="highlight-npc">${spouse.name}</strong> 伤心落泪！`;
        let options = [
            {htmlContent:`<i class="fas fa-money-bill-wave"></i> 花钱安抚`, callback: () => handleConfrontation('bribe', lover.id)},
            {htmlContent:`<i class="fas fa-heart-broken"></i> 决绝和离`, callback: () => handleConfrontation('divorce', lover.id)},
        ];
        showDecisionCard('⚡️ 东窗事发 ⚡️', '💔', content, options);
    }
}
// =======================================================================
// ===================== 【新功能】社交互动生成函数 START =====================
// =======================================================================
// =======================================================================
// ===================== 【新功能代码】社交玩法函数 START =====================
// =======================================================================
// ===================== 【替换】generateNpcActionButtons 函数 START =====================
function generateNpcActionButtons(npc) {
    const { id: npcId, favor } = npc;
    const player = gameState.player;
    const rel = gameState.social.relationships[npcId];
    let actions = [];

    // --- 互动条件判断 ---
    // 只有在关系为“知己”类，且不是配偶/情人/义兄妹/家人时，才能结拜
    const canSwearOath = rel && player.gender === npc.gender && ['brother', 'confidante', 'red_confidante', 'blue_confidante'].includes(rel.type) && favor >= 80 && player.attributes.virtue >= 20 && !npc.personality.some(p => ['凉薄', '腹黑'].includes(p));
    // 只有在关系为“知己”类，且不是配偶/情人/义兄妹/家人时，才能表白
    const canConfess = rel && player.gender !== npc.gender && ['red_confidante', 'blue_confidante'].includes(rel.type) && favor >= 60;
    // 只有对方是“可追求对象”（suitor）或满足条件的知己，且玩家未婚时，才能提亲
    const canPropose = player.gender !== npc.gender && favor >= 80 && player.age >= 16 && !gameState.marriage.isMarried && (gameState.suitors.includes(npcId) || canConfess);

    // --- 根据条件生成按钮 ---
    if (canConfess) {
        actions.push({ id: 'start_confession', name: '红笺寄情', icon: 'fa-pen-fancy', available: true });
    }

    // 基础互动按钮
    actions.push({ id: 'chat', name: '交谈', icon: 'fa-comments', available: true });
    actions.push({ id: 'giveGift', name: '赠礼', icon: 'fa-gift', available: true });
    
    if (favor >= 50) {
        actions.push({ id: 'conversation_game', name: '促膝长谈', icon: 'fa-heart', available: true });
        if (npc.attributes.wisdom >= 60) {
            actions.push({ id: 'go_game', name: '手谈对弈', icon: 'fa-chess', available: true });
        }
        if (player.attributes.talent >= 50) {
            actions.push({ id: 'guzheng_game', name: '抚琴一曲', icon: 'fa-music', available: true });
        }
    }
    
    const friendsCount = Object.keys(gameState.social.relationships).filter(id => id !== npcId && gameState.npcs[id] && !gameState.npcs[id].isDead).length;
    actions.push({ id: 'gathering', name: '发起聚会', icon: 'fa-users', available: friendsCount > 0 && favor > 40 });
    
    actions.push({ 
        id: 'askPreference', 
        name: player.gender === 'male' ? '打听消息' : '旁敲侧击', 
        icon: 'fa-search', 
        available: npc.preferences && !npc.preferences.known && favor > 20 
    });

    if (canSwearOath) {
        actions.push({ id: 'become_sworn_sibling', name: '义结金兰', icon: 'fa-hands-helping', available: true, relType: rel.type });
    }
     
    if (canPropose) {
        actions.push({ id: 'propose', name: '提亲', icon: 'fa-ring', available: true, style: 'background: linear-gradient(135deg, #e74c3c, #c0392b);' });
    }

    if (gameState.marriage.isMarried && gameState.marriage.spouseId === npcId) {
        actions.push({ id: 'divorce', name: '和离', icon: 'fa-heart-broken', available: true, style: 'background: linear-gradient(135deg, #a9a9a9, #696969);' });
    }

// 【新增】情报首领专属互动
if (gameState.career.path === 'spy_master' && gameState.career.level >= 2) { // <<< 这里是修复点
    // 检查物品栏是否有任何“文书”类物品
    const hasIntelligence = gameState.inventory.some(item => {
        const itemDef = ITEM_DATA[item.id];
        return itemDef && itemDef.type === '文书';
    });
    if (hasIntelligence) {
        actions.unshift({ // unshift会把按钮放在最前面
            id: 'use_intelligence', 
            name: '运用情报', 
            icon: 'fa-user-secret', 
            available: true,
            style: 'background: linear-gradient(135deg, #8e44ad, #9b59b6);' // 特殊颜色
        });
    }
}
    return actions.slice(0, 9);
}
// ===================== 【替换】generateNpcActionButtons 函数 END ===========

// ===================== 【新功能代码】社交玩法函数 END =======================
function handleConfrontation(choice, loverId) {
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (choice === 'bribe') {
        const bribeAmount = Math.floor(gameState.finances.wealth * 0.5);
        if (gameState.finances.wealth < bribeAmount || bribeAmount < 1000) {
            showEventCard('东窗事发', '', "你试图花钱了事，但财力不足，对方不为所动，坚决要与你和离。");
            confirmDivorce();
        } else {
            // 修复: 确保 favor 在 0 到 100 之间
            applyEffects({ wealth: -bribeAmount, relationship: {targetId: spouse.id, favor: Math.max(0, spouse.favor - 50)} });
            showEventCard('破财消灾', 'fa-shield-alt', `你花费了 <span class="value">${bribeAmount}</span> 两巨款，总算将此事压下，但你与 <strong class="highlight-npc">${spouse.name}</strong> 的感情已名存实亡。`);
        }
    } else { confirmDivorce(); }
}
// =======================================================================
// ============================= FENG YUE JIAN ===========================
// =======================================================================
// 【修复 & 替换】showFengYueJian 函数
function showFengYueJian() {
    const content = document.getElementById('fengYueJianContent');
    let html = '';
    const canInteract = (npc) => !npc.isDead && npc.relationship > 20 && !gameState.social.secretLovers.includes(npc.id) && npc.id !== gameState.marriage.spouseId;

    if (gameState.player.gender === 'female') {
        html += '<p class="comment">身为贵女，在此处结交异性知己，需得万分谨慎，以免引火烧身。</p>';
        const potentialLovers = Object.values(gameState.npcs).filter(npc => npc.gender === 'male' && canInteract(npc));
        if (potentialLovers.length > 0) {
            potentialLovers.forEach(npc => {
                html += `
                    <div class="suitor" onclick="proposeSecretLover('${npc.id}')">
                        <div class="suitor-avatar-wrapper" style="background:${getAvatarGradient(npc.id)}"><span class="suitor-avatar-text">${npc.name.charAt(0)}</span></div>
                        <div class="suitor-details">
                            <div class="suitor-name">${npc.name}</div>
                            <div class="suitor-desc">${npc.title || '身份神秘'}</div>
                            <div class="suitor-stats">
                                <span class="stat"><i class="fas fa-heart"></i> 好感: ${npc.relationship}</span>
                                <span class="stat"><i class="fas fa-user-secret"></i> 魅力: ${npc.attributes.charm}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p class="comment">暂无可互动的知己。</p>';
        }
    } else { // 男性角色逻辑
        html += '<p class="comment">身为男子，出入风月场所需花费甚巨，还需谨慎。</p>';
        const potentialLovers = Object.values(gameState.npcs).filter(npc => npc.gender === 'female' && canInteract(npc));
        if (potentialLovers.length > 0) {
            potentialLovers.forEach(npc => {
                 // 为男性玩家增加金钱判定
                const cost = 100 + Math.floor(npc.attributes.charm * 2);
                html += `
                    <div class="suitor" onclick="if(gameState.finances.wealth >= ${cost}) { proposeSecretLover('${npc.id}', ${cost}); } else { showToast('银钱不足！'); }">
                        <div class="suitor-avatar-wrapper" style="background:${getAvatarGradient(npc.id)}"><span class="suitor-avatar-text">${npc.name.charAt(0)}</span></div>
                        <div class="suitor-details">
                            <div class="suitor-name">${npc.name}</div>
                            <div class="suitor-desc">${npc.title || '身份神秘'}</div>
                            <div class="suitor-stats">
                                <span class="stat"><i class="fas fa-heart"></i> 好感: ${npc.relationship}</span>
                                <span class="stat"><i class="fas fa-user-secret"></i> 魅力: ${npc.attributes.charm}</span>
                                <span class="stat"><i class="fas fa-money-bill-wave"></i> 花费: ${cost}两</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p class="comment">暂无可互动的红颜。</p>';
        }
    }
    content.innerHTML = html;
    showOverlay('fengYueJianOverlay');
}

function proposeSecretLover(npcId, cost = 0) {
    const npc = gameState.npcs[npcId];
    const successChance = (gameState.player.attributes.charm + npc.relationship) / 200;

    if (gameState.player.gender === 'male') {
        applyEffects({ wealth: -cost });
        logEvent(`你为 ${npc.name} 掷下千金（-${cost}两），以博红颜一笑。`);
    }

    if (Math.random() < successChance) {
        gameState.social.secretLovers.push(npcId);
        npc.relationship += 20; // 成为情人增加好感
        logEvent(`你与 <strong class="highlight-npc">${npc.name}</strong> 互生情愫，成为秘密情人。`, true);
        showEventCard("情投意合", "fa-heart", `你与 ${npc.name} 的关系更进一步，你们成为了秘密情人。`);
    } else {
        npc.relationship -= 10;
        logEvent(`你试图与 <strong class="highlight-npc">${npc.name}</strong> 发展更深的关系，但被婉拒了。`, true);
        showEventCard("缘分未到", "fa-heart-broken", `${npc.name} 婉拒了你的心意，或许你们的缘分还未到。`);
    }
    closeAllOverlays();
    renderGame();
}
// 【修复一】请用此代码块完整替换您文件中的 showFengYueJian 函数
// 
function showFengYueJian(isForGossip = false, targetNpcId = null) {
    if (gameState.player.gender !== 'male') {
        // 为女性玩家保留原有的“结交知己”逻辑
        openFengYueJian();
        return;
    }
    if (gameState.finances.wealth < fengYueJianData.entry_cost && !isForGossip) {
        showToast("囊中羞涩，连门都进不去。");
        return;
    }
    // 如果不是为了打听消息，才扣门票费
    if (!isForGossip) {
        applyEffects({ wealth: -fengYueJianData.entry_cost });
        gameState.flags.brothelVisitCount = (gameState.flags.brothelVisitCount || 0) + 1;
    }
    // 如果只是为了打听消息，直接调用互动函数并返回，不显示风月鉴界面
    if (isForGossip && targetNpcId) {
        interactWithHongYi('gossip', targetNpcId);
        return;
    }
    
    let html = `<p>朱漆大门，鎏金牌匾，上书‘风月鉴’三字。甫一踏入，暖香扑面，丝竹管弦之声不绝于耳。管事红姨满面堆笑地迎上前来：‘哟，这位公子，快里边请！’</p>`;
    html += `<div class="section-header"><i class="fas fa-comments"></i> 与红姨交谈</div>
             <div class="options">
                <button class="option" onclick="interactWithHongYi('gossip')"><i class="fas fa-comment-dots"></i> <span class="option-text">打听消息<div><small>-30两</small></div></span></button>
                <button class="option" onclick="interactWithHongYi('recommend')"><i class="fas fa-user-check"></i> <span class="option-text">引荐佳人<div><small>-100两</small></div></span></button>
                 <button class="option" onclick="interactWithHongYi('drink')"><i class="fas fa-wine-glass-alt"></i> <span class="option-text">浅酌听曲<div><small>-20两</small></div></span></button>
             </div>`;
    html += `<div class="section-header"><i class="fas fa-fan"></i> 邀约佳人</div>`;
    
    const courtesans = fengYueJianData.courtesans.map(c => gameState.npcs[c.id]).filter(c => c && !c.isRedeemed);
    
    if (courtesans.length > 0) {
        // ▼▼▼ 核心修复点 ▼▼▼
        // 此处将原有的 renderNpcCard 调用，改为直接生成带正确点击事件的卡片HTML
        html += courtesans.map(c => {
            const courtesanData = c.baseData; // 从NPC对象中获取基础定义
            const cost = 100 + Math.floor(c.attributes.charm * 2);
            // 直接使用 renderNpcCard 来保持样式统一，但为其包裹一个带正确 onclick 的 div
            return `<div onclick="showCourtesanDetails('${c.id}')">${renderNpcCard(c.id)}</div>`;
        }).join('');
        // ▲▲▲ 修复结束 ▲▲▲
    } else {
        html += `<p class="comment">风月鉴的佳人们都已名花有主。</p>`;
    }
    
    document.getElementById('fengYueJianContent').innerHTML = html;
    
    const overlay = document.getElementById('fengYueJianOverlay');
    if (!overlay.style.display || overlay.style.display === 'none') {
        showOverlay('fengYueJianOverlay');
    }
}
// [用这个新版本替换] interactWithHongYi 函数
function interactWithHongYi(action, targetNpcId = null) {
    let cost = 0, logText = "", icon = "fa-comments", title = "红姨闲谈";
    switch (action) {
        case 'gossip':
            cost = 30;
            if (gameState.finances.wealth < cost) {
                showToast("打听消息需要30两，你的钱不够。");
                return;
            }

            if (targetNpcId && gameState.npcs[targetNpcId]) {
                const targetNpc = gameState.npcs[targetNpcId];
                applyEffects({ wealth: -cost });
                targetNpc.preferences.known = true;
                showEventCard('打探成功', 'fa-check', `你花费 ${cost} 两，从红姨口中成功探知了 ${targetNpc.name} 的喜好。`);
                closeAllOverlays();
                showNPCDetails(targetNpcId);
                return;
            } else {
                // 【修复】从八卦库中随机获取一条八卦
                logText = `你从红姨那儿听到了一则八卦： “${getRandomElement(GOSSIP_DATA)}”`;
                applyEffects({ attributes: { wisdom: 1 } });
            }
            break;
        case 'recommend':
            cost = 100;
            if (gameState.finances.wealth < cost) { showToast("引荐佳人需要100两，你的钱不够。"); return; }
            const available = fengYueJianData.courtesans.map(c=>gameState.npcs[c.id]).filter(c => c && !c.isRedeemed);
            if(available.length > 0) {
                const npc = getRandomElement(available);
                applyEffects({relationship:{targetId:npc.id, favor:5}});
                logText = `红姨为你引荐了 <strong class="highlight-npc">${npc.name}</strong>，你们相谈甚欢，TA对你的好感提升了。`;
                title="得遇佳人"; icon="fa-user-check";
            } else {
                logText = "红姨说，如今楼里的姑娘们都忙着呢，让你稍后再来。";
                cost = 0; // 没推荐人，不收费
            }
            break;
        case 'drink':
            cost = 20;
            if (gameState.finances.wealth < cost) { showToast("浅酌听曲需要20两，你的钱不够。"); return; }
            logText = "你浅酌听曲，丝竹悦耳，心情舒畅。";
            applyEffects({attributes:{charm:1, talent:1}});
            title="浅酌听曲"; icon="fa-wine-glass-alt";
            break;
    }

    if (cost > 0) {
        applyEffects({ wealth: -cost });
        showEventCard(title, icon, logText);
    }
}
function showCourtesanDetails(courtesanId) {
    const courtesan = gameState.npcs[courtesanId];
    const data = courtesan.baseData;
    if (!courtesan || !data) return;

    let interactionsHTML = `<div class="section-header"><i class="fas fa-hand-holding-heart"></i> 深入交流</div><div class="options">`;
    fengYueJianData.interactions.forEach(inter => {
        interactionsHTML += `<button class="option" ${gameState.finances.wealth<inter.cost ? 'disabled' : ''} onclick="interactWithCourtesan('${courtesan.id}', '${inter.id}')">
            <i class="fas fa-hand-holding-heart"></i> <span class="option-text">${inter.name}<div><small>-${inter.cost}两</small></div></span>
        </button>`;
    });

    if (courtesan.favor >= fengYueJianData.sleep.unlock_favor) {
        const cost = courtesan.firstIntimateCost;
        interactionsHTML += `<button class="option" ${gameState.finances.wealth<cost ? 'disabled' : ''} style="background:linear-gradient(135deg, #e74c3c, #c0392b);" onclick="interactWithCourtesan('${courtesan.id}', 'sleep')">
            <i class="fas fa-moon"></i> <span class="option-text">共度良宵<div><small>-${cost}两</small></div></span>
        </button>`;
    }
    if (courtesan.favor >= fengYueJianData.redeem.unlock_favor) {
        interactionsHTML += `<button class="option" ${gameState.finances.wealth<data.redemption_cost ? 'disabled' : ''} onclick="interactWithCourtesan('${courtesan.id}', 'redeem')">
            <i class="fas fa-file-invoice-dollar"></i><span class="option-text">为她赎身<div><small>-${data.redemption_cost}两</small></div></span>
        </button>`;
    }
    interactionsHTML += `</div>`;

    document.getElementById('fengYueJianContent').innerHTML = `
        <button class="control-btn" style="margin-bottom:20px;" onclick="showFengYueJian()"> <i class="fas fa-arrow-left"></i> 返回列表</button>
        ${renderNpcCard(courtesanId)}
        <div class="attribute" style="margin-top:20px;">
            ${renderAttributeBar('好感度', courtesan.favor, 'charm-fill', 'fa-heart', 100)}
        </div>
        ${interactionsHTML}
    `;
    showOverlay('fengYueJianOverlay'); // Re-show overlay
}

function interactWithCourtesan(courtesanId, action) {
    const courtesan = gameState.npcs[courtesanId];
    if (!courtesan) return;

    const a = fengYueJianData.interactions.find(i => i.id === action);
    if(a) {
        if(gameState.finances.wealth < a.cost) { showToast("资金不足"); return; }
        applyEffects({wealth: -a.cost, relationship:{targetId:courtesanId, favor: getRandomInt(a.favor[0], a.favor[1])}});
        showToast(`${courtesan.name}对你的好感提升了。`);
    } else if (action === 'sleep') {
        const cost = courtesan.firstIntimateCost;
        if(gameState.finances.wealth < cost) { showToast("资金不足"); return;}
        applyEffects({wealth: -cost, relationship:{targetId:courtesanId, favor: getRandomInt(10,20)}});
        courtesan.firstIntimateCost = Math.floor(cost * fengYueJianData.sleep.subsequent_cost_factor);
        showEventCard('春宵一刻', 'fa-moon', `你与 <strong class="highlight-npc">${courtesan.name}</strong> 共度良宵，情谊更深。`);
        
        if (Math.random() < 0.3) {
            gameState.status.disease = { id: 'syphilis', duration: diseases['syphilis'].duration };
            showEventCard('身体抱恙', 'fa-thermometer-half', '你感到身体不适，似乎染上了难以启齿的<strong style="color:red;">梅病</strong>...');
        }
    } else if (action === 'redeem') {
        const cost = courtesan.baseData.redemption_cost;
        if(gameState.finances.wealth < cost) { showToast("资金不足"); return; }
        applyEffects({wealth: -cost});
        courtesan.isRedeemed = true;
        
        let options = [{htmlContent:`<i class="fas fa-home"></i> 金屋藏娇`, callback: () => handleRedemptionChoice(courtesan.id, 'hide')}];
        if (gameState.marriage.isMarried && gameState.marriage.concubines.length < 5) {
            options.unshift({htmlContent:`<i class="fas fa-users"></i> 纳为妾室`, callback: () => handleRedemptionChoice(courtesan.id, 'concubine')});
        } else if (!gameState.marriage.isMarried) {
            options.unshift({htmlContent:`<i class="fas fa-ring"></i> 迎娶为妻`, callback: () => handleRedemptionChoice(courtesan.id, 'marry')});
        }
        
        showDecisionCard('金钗脱籍', '', `你花费巨资为 <strong class="highlight-npc">${courtesan.name}</strong> 脱去了贱籍。接下来，你打算...`, options);
        return;
    }
    showCourtesanDetails(courtesanId);
}
// [替换]
// [替换此函数]
function handleRedemptionChoice(courtesanId, choice) {
    const courtesan = gameState.npcs[courtesanId];
    courtesan.source = 'fyj'; 
    if (choice === 'concubine') {
        acquireConcubine(courtesanId);
    } else if (choice === 'marry') {
        marrySuitor(courtesanId);
    } else { // hide
        // 【核心修复】重写背叛判定逻辑
        let betrayalChance = 0.35; // 基础35%背叛率
        betrayalChance -= (gameState.player.attributes.charm / 500); // 玩家魅力越高，越不容易背叛 (最高-0.4)
        betrayalChance += ((courtesan.ambition || 40) / 200); // 对方野心越高，越容易背叛 (最高+0.5)
        betrayalChance -= (courtesan.favor / 250); // 好感度越高，越不容易背叛 (最高-0.4)
        betrayalChance = Math.max(0.05, betrayalChance); // 最低仍有5%的风险

        if (Math.random() < betrayalChance) {
            const loss = Math.floor(gameState.finances.wealth * 0.5);
            applyEffects({wealth: -loss});
            showEventCard('人去楼空', 'fa-heart-broken', `你将${courtesan.name}安置在别院，但不久后她便人去楼空，还卷走了你 <span class='value'>${loss}</span> 两。`);
            courtesan.isDead = true;
        } else {
            gameState.social.secretLovers.push(courtesanId);
            courtesan.relationship = 'lover';
            showEventCard('金屋藏娇', 'fa-home', `你将${courtesan.name}安置在城外别院，时常前去私会。`);

            if (gameState.marriage.isMarried && gameState.marriage.spouseId) {
                const spouse = gameState.npcs[gameState.marriage.spouseId];
                if (spouse) {
                    spouse.suspicionValue = (spouse.suspicionValue || 0) + 15; 
                    logEvent(`你金屋藏娇的行为让你配偶的疑心大幅增加了。`);
                }
            }
        }
        closeAllOverlays(); 
    }
    renderGame();
}
function interactWithConcubine(concubineId, action) {
    const concubine = gameState.npcs[concubineId];
    if (!concubine || concubine.isDead) return;

    concubine.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;

   if (action === 'chat') {
        const favorGain = getRandomInt(2, 5);
        // 使用 applyEffects 统一处理
        applyEffects({ relationship: { targetId: concubineId, favor: favorGain } }); // <--- 修改为此行
        showEventCard('妾室闲谈', 'fa-comments', `你与妾室${concubine.name}闲聊片刻，她看起来很开心。好感+${favorGain}`);
    } else if (action === 'gift') {
        const giftCostStr = prompt(`请输入要赠予${concubine.name}的金额：`, "100");
        const cost = parseInt(giftCostStr);
        if(isNaN(cost) || cost <= 0) return;
        if(gameState.finances.wealth < cost) {
            showToast("你的私产不足。");
            return;
        }
        const favorGain = Math.floor(cost / 15) + getRandomInt(1, 3);
        applyEffects({ wealth: -cost, relationship: { targetId: concubineId, favor: favorGain } });
        showEventCard('赠礼', 'fa-gift', `你花费 ${cost} 两为妾室${concubine.name}送上礼物，她对你更亲近了。好感+${favorGain}`);
    } else if (action === 'sleep') {
        applyEffects({ relationship: { targetId: concubineId, favor: getRandomInt(5, 12) } });
        triggerBirth(concubineId);
    }
    showNPCDetails(concubineId);
}

function handleBecomeSwornSibling(npcId) {
    const cost = 200;
    if (gameState.finances.wealth < cost) {
        showToast("结拜仪式需要200两，你的钱不够。");
        return;
    }
    applyEffects({ wealth: -cost });
    const swornType = gameState.player.gender === 'male' ? '义兄弟' : '义姐妹';
    gameState.social.relationships[npcId].type = 'sworn_sibling';
    if (!gameState.social.swornSiblings) {
        gameState.social.swornSiblings = [];
    }
    if (!gameState.social.swornSiblings.includes(npcId)) {
        gameState.social.swornSiblings.push(npcId);
    }
    showEventCard('义结金兰', 'fa-hands-helping', `你与 <strong class="highlight-npc">${npc.name}</strong> 焚香结拜，从此祸福与共，成为生死不离的${swornType}！`);
    showNPCDetails(npcId);
}

// =======================================================================
// ===================== 【已修复】特殊互动核心逻辑 =======================
// =======================================================================

// [用这个新版本完整替换旧的 handleSpecialInteraction 函数]
function handleSpecialInteraction(npcId, actionId) {
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    if (!npc) return;

    switch(actionId) {
        case 'love_token': // 定情信物
            if (gameState.finances.wealth < 500) { showToast("你没有足够的钱准备一份像样的信物。"); return; }
            applyEffects({ wealth: -500 });
            const tokenName = `与${npc.name}的定情信物`;
            
            // 【错误已修复】下面这行代码的 { name tokenName ... } 之间缺少了冒号 :
            addItemToInventory(`token_${npcId}`, 1, { name: tokenName, desc: `见证你们情谊的信物。`, type: '珍品', icon: 'fa-gem' });
            
            showEventCard('交换信物', 'fa-gem', `你花费500两，与${npc.name}交换了信物。`);
            break;
        case 'dating_location': // 约会地点
            const locations = [
                { name: '湖心亭', eventKey: 'moon_drink' },
                { name: '繁华市集', eventKey: 'buy_for_lover' },
                { name: '幽静竹林', eventKey: 'boat_serenade' }, // 借用画舫事件
            ];
            let locationOptions = locations.map(loc => ({
                htmlContent: `<i class="fas fa-map-marker-alt"></i> ${loc.name}`,
                callback: () => triggerLoverEvent(npcId, loc.eventKey)
            }));
            showDecisionCard('选择约会地点', 'fa-map-signs', '你打算带TA去哪里？', locationOptions);
            break;
        case 'poetry_quiz': // 私密小游戏
            startPoetryMiniGame(npcId);
            break;
        case 'intimacy': // 缠绵
             if (player.gender === 'female') {
                showEventCard('缠绵悱恻', 'fa-moon', `你与${npc.name}共度良宵... 品德-2`);
                applyEffects({ attributes: { virtue: -2 }});
                // 怀孕逻辑
                const pregnancyChance = (player.health / 500) + (npc.favor / 1000); // 示例概率
                if (Math.random() < pregnancyChance) {
                    player.isPregnant = true;
                    player.isSecretPregnancy = true; // 标记为私生子
                    player.pregnancyTurnsLeft = 2;
                    // [新增] 记录生物学父亲
                    player.biologicalFatherOfUnborn = npcId;
                    showEventCard('珠胎暗结', 'fa-baby', '你发现自己有了身孕，这竟是情人的孩子！');
                }
            }
            break;
        case 'propose_marriage_lover': // (情人)提亲
            if (!gameState.marriage.isMarried) { marrySuitor(npcId); } 
            else { showToast("你已有家室。"); }
            break;
        case 'take_as_concubine_lover': // (情人)纳妾
            if (gameState.marriage.isMarried) { acquireConcubine(npcId); } 
            else { showToast("需先娶妻。"); }
            break;
        case 'secret_lover_status': // (情人)秘密情人
             if (!gameState.social.secretLovers.includes(npcId)) {
                 gameState.social.secretLovers.push(npcId);
             }
             showEventCard('秘密关系', 'fa-mask', '你们的关系更加隐秘而稳固，但也增加了被发现的风险。');
             const spouse = gameState.npcs[gameState.marriage.spouseId];
             if (spouse) {
                 spouse.suspicionValue = (spouse.suspicionValue || 0) + 10;
             }
             break;
        default:
            // 默认处理，防止没有匹配的 actionId 时出错
            showToast(`你与 ${npc.name} 进行了一次特别的互动。`);
            break;
    }
}

function handleSpecialInteraction(npcId, actionId) {
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    if (!npc) return;

    switch(actionId) {
        case 'love_token': // 定情信物
            // 简化处理：直接给予，不设置任务链
            if (gameState.finances.wealth < 500) { showToast("你没有足够的钱准备一份像样的信物。"); return; }
            applyEffects({ wealth: -500 });
            const tokenName = `与${npc.name}的定情信物`;
            addItemToInventory(`token_${npcId}`, 1, { name: tokenName, desc: `见证你们情谊的信物。`, type: '珍品', icon: 'fa-gem' });
            showEventCard('交换信物', 'fa-gem', `你花费500两，与${npc.name}交换了信物。`);
            break;
        case 'dating_location': // 约会地点
            const locations = [
                { name: '湖心亭', eventKey: 'moon_drink' },
                { name: '繁华市集', eventKey: 'buy_for_lover' },
                { name: '幽静竹林', eventKey: 'boat_serenade' }, // 借用画舫事件
            ];
            let locationOptions = locations.map(loc => ({
                htmlContent: `<i class="fas fa-map-marker-alt"></i> ${loc.name}`,
                callback: () => triggerLoverEvent(npcId, loc.eventKey)
            }));
            showDecisionCard('选择约会地点', 'fa-map-signs', '你打算带TA去哪里？', locationOptions);
            break;
        case 'poetry_quiz': // 私密小游戏
            startPoetryMiniGame(npcId);
            break;
        case 'intimacy': // 缠绵
             if (player.gender === 'female') {
                showEventCard('缠绵悱恻', 'fa-moon', `你与${npc.name}共度良宵... 品德-2`);
                applyEffects({ attributes: { virtue: -2 }});
                // 怀孕逻辑
                const pregnancyChance = (player.health / 500) + (npc.favor / 1000); // 示例概率
                if (Math.random() < pregnancyChance) {
                    player.isPregnant = true;
                    player.isSecretPregnancy = true; // 标记为私生子
                    player.pregnancyTurnsLeft = 2;
                    showEventCard('珠胎暗结', 'fa-baby', '你发现自己有了身孕，这竟是情人的孩子！');
                }
            }
            break;
        case 'propose_marriage_lover': // (情人)提亲
            if (!gameState.marriage.isMarried) { marrySuitor(npcId); } 
            else { showToast("你已有家室。"); }
            break;
        case 'take_as_concubine_lover': // (情人)纳妾
            if (gameState.marriage.isMarried) { acquireConcubine(npcId); } 
            else { showToast("需先娶妻。"); }
            break;
        case 'secret_lover_status': // (情人)秘密情人
             if (!gameState.social.secretLovers.includes(npcId)) {
                 gameState.social.secretLovers.push(npcId);
             }
             showEventCard('秘密关系', 'fa-mask', '你们的关系更加隐秘而稳固，但也增加了被发现的风险。');
             const spouse = gameState.npcs[gameState.marriage.spouseId];
             if (spouse) {
                 spouse.suspicionValue = (spouse.suspicionValue || 0) + 10;
             }
             break;
    }
}

function startPoetryMiniGame(npcId) {
    const quiz = getRandomElement(POETRY_QUIZ_DATA);
    document.getElementById('poetryQuestion').textContent = quiz.question;
    const optionsContainer = document.getElementById('poetryOptions');
    optionsContainer.innerHTML = '';

    const answers = [quiz.answer, ...quiz.options].sort(() => Math.random() - 0.5);
    answers.forEach(ans => {
        const button = document.createElement('button');
        button.className = 'option';
        button.textContent = ans;
        button.onclick = () => {
            if (ans === quiz.answer) {
                showEventCard('心有灵犀', 'fa-check-circle', '你答对了！对方眼中满是欣赏。情意+15, 痴情度+10。');
                applyEffects({ relationship: { targetId: npcId, favor: 15, devotion: 10 } });
            } else {
                showEventCard('稍有遗憾', 'fa-times-circle', '你答错了，不过对方并不在意。');
                applyEffects({ relationship: { targetId: npcId, favor: -2 } });
            }
            closeAllOverlays();
        };
        optionsContainer.appendChild(button);
    });
    showOverlay('poetryQuizOverlay');
}

function triggerLoverEvent(loverId, eventKey) {
    const eventData = LOVER_EVENTS_EXPANDED[eventKey];
    if (!eventData) return;

    const options = eventData.options.map(opt => {
        let canSelect = true;
        let reqText = '';
        if (opt.req) {
             for (const attr in opt.req) {
                const reqVal = opt.req[attr];
                const playerVal = gameState.player.attributes[attr] || gameState.finances[attr] || 0;
                if (playerVal < reqVal) {
                    canSelect = false;
                    reqText += `${ATTR_MAP[attr] || attr}≥${reqVal} `;
                }
             }
        }
        return {
            htmlContent: `<span class="option-text">${opt.text}${reqText ? `<div><small>(要求: ${reqText})</small></div>` : ''}</span>`,
            disabled: !canSelect,
            callback: () => {
                let log = opt.log;
                let effects = { ...opt.effects };
                if (effects.wealth) applyEffects({ wealth: effects.wealth });
                if (effects.favor || effects.devotion) {
                    applyEffects({ relationship: { targetId: loverId, favor: effects.favor || 0, devotion: effects.devotion || 0 } });
                }
                if (opt.callback) opt.callback(loverId);
                showEventCard(eventData.title, 'fa-heart-broken', log);
            }
        };
    });

    showDecisionCard(eventData.title, 'fa-mask', eventData.desc, options);
}

// 命定情人系统
function checkForFatedLoverEvent() {
    const fatedLoverId = gameState.flags.fatedLoverId;
    if (!fatedLoverId || !gameState.npcs[fatedLoverId]) return;

    const npc = gameState.npcs[fatedLoverId];
    // 1. 主动邀约
    if (Math.random() < 0.2) { // 20%几率主动邀约
        eventQueue.push(() => {
            showEventCard('意外之约', 'fa-envelope', `<strong class="highlight-npc">${npc.name}</strong> 派人送信，邀你一叙。你们度过了一个愉快的下午。情意+5。`);
            applyEffects({ relationship: { targetId: fatedLoverId, favor: 5 } });
        });
    }

    // 2. 专属剧情链 (示例)
    const questStep = gameState.flags.fatedLoverQuestStep;
    if (questStep === 0 && npc.role === '将军之子' && npc.favor > 50) {
        eventQueue.push(() => {
            showDecisionCard('沙场之忧', 'fa-shield-alt', `<strong class="highlight-npc">${npc.name}</strong>找到你，神色凝重：“父亲即将出征，我心中甚是担忧，却不知能为他做些什么。”`, [
                { htmlContent: '【为其求平安符】', callback: () => {
                    gameState.flags.fatedLoverQuestStep = 1;
                    showEventCard('求得平安', 'fa-praying-hands', '你前往寺庙为将军求得一枚平安符，并交予了对方。痴情度+15。');
                    applyEffects({ relationship: { targetId: fatedLoverId, devotion: 15 } });
                }},
                { htmlContent: '【分析军情】', callback: () => {
                    gameState.flags.fatedLoverQuestStep = 1;
                    showEventCard('纸上谈兵', 'fa-map-marked-alt', '你为他分析了军情利弊，对方对你的才智更为钦佩。情意+10。');
                    applyEffects({ relationship: { targetId: fatedLoverId, favor: 10 } });
                }}
            ]);
        });
    }
}

// 丈夫疑心值
function updateHusbandSuspicion() {
    if (gameState.player.gender !== 'female' || !gameState.marriage.isMarried) return;
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if (!spouse) return;

    spouse.suspicionValue = spouse.suspicionValue || 0;
    // 每次与情人互动，在互动函数里增加疑心值

    // 每回合有几率根据疑心值触发事件
    if (spouse.suspicionValue > 30 && Math.random() < 0.15) {
        eventQueue.push(() => {
            showDecisionCard('丈夫的质问', 'fa-question-circle', `“你最近似乎与那位...‘朋友’走得很近？” 夫君看似不经意地问道。`, [
                { htmlContent: '【从容应对】', req: { scheming: 70 }, callback: () => {
                    spouse.suspicionValue -= 10;
                    showEventCard('化解危机', 'fa-check-circle', '你从容不迫地应对过去，暂时打消了他的疑虑。');
                }},
                { htmlContent: '【慌张掩饰】', callback: () => {
                    spouse.suspicionValue += 10;
                    showEventCard('欲盖弥彰', 'fa-times-circle', '你的慌张让他更加怀疑。');
                }}
            ]);
        });
    }
}
// [替换此函数]
function applyEffects(effects, target = gameState.player) {
    if (!target) return;
    let harmonyModifier = 1.0;
    let attributeModifier = 1.0;
    let healthModifier = 0;
    if (target.id === 'player' && gameState.player.gender === 'male') {
        if (gameState.marriage.familyHarmony > 80) {
            harmonyModifier = 1.05;
        } else if (gameState.marriage.familyHarmony < 30) {
            attributeModifier = -5;
            healthModifier = -2;
            if (Math.random() < 0.1) {
                gameState.flags.exhausted = true;
            }
        }
    }
    if (effects.attributes) {
        for (const attr in effects.attributes) {
            let value = effects.attributes[attr];
            if (attr === 'health' && target.id === 'player') {
                target.health = Math.max(0, Math.min(100, (target.health || 0) + value + healthModifier));
            } else if (target.attributes) {
                let currentVal = (target.attributes[attr] || 0) + value;
                if(target.id === 'player' && attributeModifier < 0) {
                    currentVal += attributeModifier;
                }
                target.attributes[attr] = Math.max(0, currentVal); 
            }
        }
    }
    if (effects.wealth) {
        let value = effects.wealth;
        if (harmonyModifier > 1.0 && value > 0) {
            value = Math.floor(value * harmonyModifier);
        }
        gameState.finances.wealth = Math.floor(gameState.finances.wealth + value);
    }
    if(effects.privateAssets) {
        gameState.player.privateAssets = (gameState.player.privateAssets || 0) + effects.privateAssets;
    }
    if (effects.reputation) {
        let value = effects.reputation;
        gameState.family.reputation = (gameState.family.reputation || 0) + value;
    }
    if (effects.relationship && effects.relationship.targetId) {
        const npc = gameState.npcs[effects.relationship.targetId];
        const rel = gameState.social.relationships[effects.relationship.targetId];
        if (npc) {
            if (typeof effects.relationship.favor !== 'undefined') {
                npc.favor = Math.max(-100, Math.min(100, (npc.favor || 0) + effects.relationship.favor));
                if(npc.id === gameState.marriage.spouseId) gameState.marriage.favor = npc.favor;
            }
            if (typeof effects.relationship.devotion !== 'undefined' && rel) {
                rel.devotion = Math.max(0, Math.min(100, (rel.devotion || 0) + effects.relationship.devotion));
            }
            if (rel) {
                if (typeof effects.relationship.trust !== 'undefined') {
                    rel.trust = Math.max(0, Math.min(100, (rel.trust || 0) + effects.relationship.trust));
                }
                if (typeof effects.relationship.influence !== 'undefined') {
                    rel.influence = Math.max(0, Math.min(100, (rel.influence || 0) + effects.relationship.influence));
                }
                if (typeof effects.relationship.emotionValue !== 'undefined') {
                    rel.emotionValue = (rel.emotionValue || 0) + effects.relationship.emotionValue;
                }
                updateRelationshipLevel(effects.relationship.targetId);
            }
        }
    }
    if (effects.marriage) {
        if (effects.marriage.favor) {
            applyEffects({relationship: { targetId: gameState.marriage.spouseId, favor: effects.marriage.favor}});
        }
        if (effects.marriage.emotionValue) {
            const spouseRel = gameState.social.relationships[gameState.marriage.spouseId];
            if(spouseRel) {
                spouseRel.emotionValue = (spouseRel.emotionValue || 0) + effects.marriage.emotionValue;
                updateRelationshipLevel(gameState.marriage.spouseId);
            }
        }
    }
    // 【新增】处理游戏结束指令
    if (effects.end_game) {
        const age = Math.floor(gameState.player.age);
        const reasonMap = {
            'exile': { title: "流放边疆", text: `你因战败被定罪，流放三千里，最终客死异乡，年仅${age}岁。` },
            'execution': { title: "满门抄斩", text: `你在残酷的斗争中失败，被满门抄斩，年仅${age}岁。` },
            'bankruptcy': { title: "穷困潦倒", text: `你因经营不善而破产，最终穷困潦倒而逝，年仅${age}岁。` },
            'emperor': { title: "九五之尊", text: `你黄袍加身，登基为帝，开创了新的王朝！` },
            'peaceful_retirement': { title: "富贵闲人", text: `你放下权柄，从此远离纷扰，作为富贵闲人安度余生。` },
            'ascended': { title: "破碎虚空", text: `你勘破武道之极，破碎虚空而去，成为江湖不朽的传说。` },
            'imprisoned': { title: "阶下之囚", text: `你因触怒天颜被打入天牢，最终在狱中郁郁而终。` },
            'vanished_queen': { title: "无名之人", text: `你成功抹去了所有痕迹，从此消失于世间，成为一个无人知晓的影子。` },
            'faked_death': { title: "金蝉脱壳", text: `你成功“假死”脱身，携巨款远走高飞，获得了真正的自由。` },
            'healer_abroad': { title: "杏林无界", text: `你将医术带往了异国他乡，成为连接不同邦国的和平桥梁，名传千古。` }
        };
        showEndGame(reasonMap[effects.end_game] || { title: "人生落幕", text: "你走完了不凡的一生。" });
    }
}
function showOverlay(overlayId) {
    document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
    const overlay = document.getElementById(overlayId);
    if(overlay) overlay.style.display = 'flex';
}
// [替换] closeAllOverlays 函数
function closeAllOverlays() {
    document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
    // [新增] 停止所有背景音乐
    document.querySelectorAll('audio[id^="bgm-"]').forEach(audio => {
        if (!audio.paused) {
            audio.pause();
            audio.currentTime = 0;
        }
    });
    // 如果小游戏正在运行，也强制结束
    if (gameState.miniGame && gameState.miniGame.gameRunning) {
        gameState.miniGame.gameRunning = false;
    }
}
// [替换] showWeddingOverlay 函数
function showWeddingOverlay(groomName, brideName) {
    const groom = (gameState.player.name === groomName) ? gameState.player : gameState.npcs[gameState.marriage.spouseId];
    const bride = (gameState.player.name === brideName) ? gameState.player : gameState.npcs[gameState.marriage.spouseId];

    const guests = Object.values(gameState.social.relationships)
        .map(rel => gameState.npcs[Object.keys(gameState.social.relationships).find(key => gameState.social.relationships[key] === rel)])
        .filter(npc => npc && !npc.isDead && (gameState.social.relationships[npc.id]?.level || 0) >= 2)
        .slice(0, 4);

    let guestsHTML = guests.length > 0 ? guests.map(g => {
        const nameInitial = g.name ? g.name.slice(0, 1) : '?';
        return `
        <div class="wedding-guest">
            <div class="avatar-wrapper">
                <img src="${g.avatar}" class="avatar-image" style="display:block;" data-retries="0" onerror="handleAvatarError(this)">
                <svg class="avatar-svg" viewBox="0 0 100 100" style="display:none;">
                    <circle cx="50" cy="50" r="48" fill="#eee" />
                    <text x="50" y="65" font-family="'Ma Shan Zheng', cursive" font-size="50" fill="#333" text-anchor="middle">${nameInitial}</text>
                </svg>
            </div>
            <div>${g.name}</div>
        </div>`;
    }).join('') : '<p class="comment">暂无宾客观礼</p>';

    const weddingHTML = `
    <div class="overlay-card">
        <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
        <div class="wedding-stage">
            <div class="overlay-header">🌸 大婚之喜 🌸</div>
            <div class="overlay-animation" style="animation: float 2.5s infinite ease-in-out; font-size: 4rem;">囍</div>
            <div class="overlay-content-wrapper">
                <div class="wedding-couples">
                    <div class="wedding-person">
                        <div class="avatar-wrapper">
                            <img src="${groom.avatar}" class="avatar-image" style="display:block;" data-retries="0" onerror="handleAvatarError(this)">
                            <svg class="avatar-svg" viewBox="0 0 100 100" style="display:none;">
                                <circle cx="50" cy="50" r="48" fill="#add8e6" />
                                <text x="50" y="65" font-family="'Ma Shan Zheng', cursive" font-size="50" fill="white" text-anchor="middle">${groom.name.slice(0, 1)}</text>
                            </svg>
                        </div>
                        <div class="name">${groom.name}</div>
                    </div>
                    <div class="wedding-person">
                        <div class="avatar-wrapper">
                            <img src="${bride.avatar}" class="avatar-image" style="display:block;" data-retries="0" onerror="handleAvatarError(this)">
                             <svg class="avatar-svg" viewBox="0 0 100 100" style="display:none;">
                                <circle cx="50" cy="50" r="48" fill="#ffc0cb" />
                                <text x="50" y="65" font-family="'Ma Shan Zheng', cursive" font-size="50" fill="white" text-anchor="middle">${bride.name.slice(0, 1)}</text>
                            </svg>
                        </div>
                        <div class="name">${bride.name}</div>
                    </div>
                </div>
                <div class="overlay-content">
                    红烛高照，喜气盈门。在亲友的见证下，新人拜堂成亲，结为百年之好，从此琴瑟和鸣，共赴白首。
                </div>
                <div class="wedding-guests">
                    <h4>观礼宾客</h4>
                    <div class="guest-list">${guestsHTML}</div>
                </div>
            </div>
            <button class="control-btn" onclick="completeWedding(${guests.length})" style="margin-top: 20px; background: linear-gradient(135deg, #d84381, #c71585);">
                <i class="fas fa-check"></i> 礼成 · 开启新生活
            </button>
        </div>
    </div>`;

    document.getElementById('weddingOverlay').innerHTML = weddingHTML;
    showOverlay('weddingOverlay');
}

// [新增这个函数] 婚礼流程第二步：宾客展示
function showWeddingGuests(groomName, brideName, guestIdsJson) {
    const overlay = document.getElementById('weddingOverlay');
    const guestIds = JSON.parse(guestIdsJson);
    const guests = guestIds.map(id => gameState.npcs[id]).filter(Boolean);

    let guestsHTML = guests.length > 0 ? guests.map(g => {
        let specialNote = '';
        // 如果宾客是你的秘密情人，会有一段特殊描述
        if (gameState.social.secretLovers.includes(g.id)) {
            specialNote = `<small class="comment">(TA的眼神有些复杂...)</small>`;
        }
        return `
        <div class="wedding-guest">
            <div class="avatar-wrapper" style="width:50px; height:50px; border-width:2px;">
                <img src="${g.avatar}" class="avatar-image" style="display:block;">
            </div>
            <div>${g.name}<br>${specialNote}</div>
        </div>`;
    }).join('') : '<p class="comment">暂无宾客观礼</p>';

    const guestListHTML = `
        <div class="wedding-stage" id="wedding-stage-2">
            <div class="overlay-header">宾客盈门</div>
            <div class="overlay-content">亲友们纷纷前来道贺，送上祝福。</div>
            <div class="wedding-guests" style="height: 200px; overflow-y: auto; margin: 15px 0;">
                <div class="guest-list">${guestsHTML}</div>
            </div>
            <button class="control-btn" onclick="showWeddingBanquet('${groomName}', '${brideName}', '${guestIdsJson.replace(/"/g, '\\"')}')">
                <i class="fas fa-glass-cheers"></i> 开宴
            </button>
        </div>
    `;
    // 更新婚礼弹窗的内容到第二阶段
    overlay.querySelector('.overlay-card').innerHTML = guestListHTML;
}

// [新增这个函数] 婚礼流程第三步：喜宴与小游戏
function showWeddingBanquet(groomName, brideName, guestIdsJson) {
    const overlay = document.getElementById('weddingOverlay');
    const guestIds = JSON.parse(guestIdsJson);
    
    // 喜宴环节，包含一个简单的小游戏
    const banquetHTML = `
        <div class="wedding-stage" id="wedding-stage-3">
            <div class="overlay-header">喜宴</div>
            <p>宴席上宾主尽欢，你的好友们前来敬酒，并起哄让新人表演一个节目。</p>
            <div class="options" style="flex-direction: column;">
                <button class="option" onclick="handleWeddingPerformance('poem', ${guestIds.length})"><i class="fas fa-pen-fancy"></i> 共赋一诗 (考验才情)</button>
                <button class="option" onclick="handleWeddingPerformance('drink', ${guestIds.length})"><i class="fas fa-wine-glass-alt"></i> 连干三杯 (考验健康)</button>
            </div>
        </div>
    `;
    overlay.querySelector('.overlay-card').innerHTML = banquetHTML;
    
    // 在进入喜宴环节时，就结算贺礼
    const giftMoney = guestIds.length * getRandomInt(100, 300);
    if (giftMoney > 0) {
        applyEffects({ wealth: giftMoney });
        showToast(`收到宾客贺礼共计 ${giftMoney} 两。`);
    }
}

// [新增这个函数] 处理婚礼小游戏的结果
function handleWeddingPerformance(type, guestCount) {
    let logText = '';
    if (type === 'poem') {
        if (gameState.player.attributes.talent > 50) {
            logText = '你们珠联璧合，一首藏头诗引得满堂喝彩！';
            applyEffects({ reputation: 10 });
        } else {
            logText = '你们的诗作虽然平平，但情真意切，也赢得了祝福。';
        }
    } else { // drink
        if (gameState.player.health > 60) {
            logText = '你们豪饮三杯，尽显豪情，宾客们大声叫好！';
            applyEffects({ reputation: 5, attributes: { health: -5 } });
        } else {
            logText = '你们勉强喝完，已是头晕眼花，引得众人善意地哄笑。';
            applyEffects({ attributes: { health: -10 } });
        }
    }
    
    showEventCard('大婚之喜', '🎉', logText);
    closeAllOverlays();
}
function completeWedding(guestCount) {
    const giftMoney = guestCount * getRandomInt(100, 300);
    if (giftMoney > 0) {
        applyEffects({ wealth: giftMoney });
        const logText = `大婚之喜，收到宾客贺礼共计 <span class="value">${giftMoney}</span> 两。`;

        // 【新增的核心代码】将贺礼收入写入记事本
        logEvent(logText);
        
        // 保留原有的即时提示
        showToast(`收到宾客贺礼共计 ${giftMoney} 两。`);
    }
    closeAllOverlays();
}
// [替换此函数]
function showEventCard(header, icon, content, options = null) {
    if (gameState.flags.isBatchProcessing) {
        console.log(`[跳过回合] 事件: ${header} - ${content.replace(/<[^>]*>/g, "")}`);
        if (options && options[0] && options[0].callback) {
            options[0].callback();
        }
        return;
    }
    closeAllOverlays();
    const card = document.getElementById('eventCardOverlay');
    if (!card) {
        console.error("Error: Could not find 'eventCardOverlay' element.");
        return;
    }
    const headerEl = card.querySelector('#eventCardHeader');
    const animationEl = card.querySelector('#eventCardAnimation');
    const contentEl = card.querySelector('#eventCardContent');
    const button = card.querySelector('.control-btn');
    if (headerEl) headerEl.innerHTML = header;
    if (animationEl) animationEl.innerHTML = icon.startsWith('fa-') ? `<i class="fas ${icon}"></i>` : icon;
    if (contentEl) contentEl.innerHTML = content;

    if (button) {
        if (options && options.length > 0) {
            const opt = options[0];
            button.innerHTML = opt.text || `<i class="fas fa-check"></i> 知道了`;
            button.onclick = () => {
                closeAllOverlays();
                if (opt.callback) {
                    opt.callback();
                }
                if (!isProcessing) renderGame();
            };
        } else {
            button.innerHTML = `<i class="fas fa-check"></i> 知道了`;
            button.onclick = () => {
                closeAllOverlays();
                if (!isProcessing) renderGame();
            };
        }
    }
    showOverlay('eventCardOverlay');
}
function showDateScene(npc) {
    const event = getRandomElement(romanticEvents);
    document.getElementById('dateSceneHeader').innerText = `与${npc.name}的约会`;
    document.getElementById('dateSceneContent').innerText = event;
    showOverlay('dateSceneOverlay');
}

// =======================================================================
// ===================== 【新增】显示特殊关系互动弹窗的核心函数 =========
// =======================================================================
function showSpecialInteractionOverlay(npcId) {
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    const rel = gameState.social.relationships[npcId];
    if (!npc || !rel) return;

    const headerEl = document.getElementById('specialInteractionHeader');
    const contentEl = document.getElementById('specialInteractionContent');
    const optionsEl = document.getElementById('specialInteractionOptions');
    
    headerEl.innerHTML = '';
    contentEl.innerHTML = '';
    optionsEl.innerHTML = '';

    if (rel.type === 'lover') {
        headerEl.innerHTML = `<i class="fas fa-heart-pulse"></i> 情人私语`;
        contentEl.innerHTML = `夜色如水，你与 <strong class="highlight-npc">${npc.name}</strong> 的关系，是旁人不知的秘密。`;
        
        const loverInteractions = [
             { id: 'rendezvous', name: '私密约会', icon: 'fa-calendar-check', min_favor: 20 },
             { id: 'poetry_quiz', name: '心有灵犀', icon: 'fa-feather-alt', min_favor: 40 },
             // 【新增功能】女性玩家专属的缠绵选项
             { id: 'intimacy', name: '缠绵', icon: 'fa-moon', min_favor: 60, gender: 'female' },
             { id: 'take_as_concubine_lover', name: '纳为妾室', icon: 'fa-user-plus', min_favor: 80, gender: 'male' },
             { id: 'propose_marriage_lover', name: '求娶为妻', icon: 'fa-ring', min_favor: 90, gender: 'male' }
        ];

        loverInteractions.forEach(action => {
            let available = true;
            let reason = '';
            if (action.min_favor && npc.favor < action.min_favor) {
                available = false; reason = `(情意需≥${action.min_favor})`;
            }
            if (action.gender && action.gender !== player.gender) {
                available = false; 
            }
            if (action.id === 'propose_marriage_lover' && gameState.marriage.isMarried) {
                available = false; reason = `(你已成婚)`;
            }
            if (action.id === 'take_as_concubine_lover' && (!gameState.marriage.isMarried || gameState.marriage.concubines.length >= 5)) {
                available = false; reason = gameState.marriage.isMarried ? `(妾室已满)`: `(需先娶妻)`;
            }

            // 【核心修改】只显示可用的按钮
            if(available) {
                const button = document.createElement('button');
                button.className = 'option';
                // 【核心修改】为“缠绵”按钮增加特殊样式
                if (action.id === 'intimacy') {
                    button.style.background = 'linear-gradient(135deg, #ff9ebf, #d84381)';
                }
                button.innerHTML = `<i class="fas ${action.icon}"></i><span class="option-text">${action.name}<div><small>${reason}</small></div></span>`;
                button.onclick = () => handleLoverInteraction(npcId, action.id);
                optionsEl.appendChild(button);
            }
        });
    } 
    else if (rel.type === 'sworn_sibling') {
        const swornType = player.gender === 'male' ? '兄弟' : '姐妹';
        headerEl.innerHTML = `<i class="fas fa-fist-raised"></i> 金兰之义`;
        contentEl.innerHTML = `你们是生死与共的${swornType}，关系牢不可破。`;

        const siblingInteractions = [
             { id: 'teach_skill', name: '传授技能', icon: 'fa-user-graduate' },
             { id: 'overcome_difficulty', name: '共渡难关', icon: 'fa-hands-helping' },
             { id: 'ask_help', name: '两肋插刀', icon: 'fa-shield-alt' },
             { id: 'discuss_plan', name: '共商大事', icon: 'fa-comments' },
             { id: 'borrow_money', name: '倾囊相助', icon: 'fa-coins' }
        ];

        siblingInteractions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'option';
            button.innerHTML = `<i class="fas ${action.icon}"></i> ${action.name}`;
            button.onclick = () => handleSwornSiblingInteraction(npcId, action.id);
            optionsEl.appendChild(button);
        });
    }

    showOverlay('specialInteractionOverlay');
}// [用这个新版本替换]
function showNPCDetails(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) { showToast("查无此人。"); return; }
    if (npc.isDead) { showToast("斯人已逝。"); return; }

    const player = gameState.player;
    npc.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;

    const container = document.getElementById('npc-card-container');
    container.innerHTML = ''; 

    const rarity = npc.rarity || 'common';
    const rarityClass = `rarity-${rarity}`;

    const rel = gameState.social.relationships[npcId];
    
    // **【核心修复】在这里进行安全检查**
    const relData = rel ? RELATIONSHIP_DATA[rel.type] : null; 
    
    const isLover = rel && rel.type === 'lover';
    const isSwornSibling = rel && rel.type === 'sworn_sibling';

    const scrollStyle = isLover ? `
        background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg');
        border: 2px solid #ff85c1;
        color: #5a2d52;
    ` : (isSwornSibling ? `
        background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg');
        border: 2px solid #d35400;
        color: #4a3c2b;
    ` : `
        background-image: url('https://img.zcool.cn/community/01f66359e19a62a80120446342e472.jpg@1280w_1l_2o_100sh.jpg');
        border: 2px solid #bda27e;
        color: #4a3c2b;
    `);

    const favorName = isLover ? '情意值' : (isSwornSibling ? '情义值' : '好感度');
    const favorIcon = isLover ? 'fa-heart-pulse' : (isSwornSibling ? 'fa-fist-raised' : 'fa-heart');

    const favorPercent = Math.max(0, Math.min(100, npc.favor));

    let favorTag = "一面之缘";
    // **【核心修复】使用修复后的 relData 进行判断**
    if(rel && relData) { 
        const levelData = RELATIONSHIP_LEVELS[relData.type] || RELATIONSHIP_LEVELS.friendship;
        favorTag = relData.levelNames[rel.level || 0] || levelData[rel.level || 0].name;
    }

    const personalityColorMap = {
        '温柔': 'tag-温柔', '果敢': 'tag-果敢', '聪慧': 'tag-聪慧',
        '活泼': 'tag-活泼', '内敛': 'tag-内敛',
    };

   const topSectionHTML = `
    <div class="social-card-header">
        <div class="npc-avatar-container">
            <div class="npc-avatar-frame">
                <div class="npc-avatar-halo ${rarityClass}"></div>
                <img src="${npc.avatar}" alt="${npc.name}">
            </div>
   
            <div class="npc-identity-tag">${npc.role || npc.title || '江湖人士'}</div>
        </div>
        <div class="npc-info-basic">
            <h3 class="name">${npc.name}</h3>
            <p class="title">${npc.title || `年龄: ${Math.floor(npc.age)}岁`}</p>
            <p class="description">${npc.background ? npc.background.desc : '身世神秘，似乎有不为人知的故事。'}</p>
            <div class="personality-tags">
                ${(npc.personality || []).map(p => `<span class="personality-tag ${personalityColorMap[p] || ''}">${p}</span>`).join('')}
            </div>
        </div>
    </div>
`;

    const devotionHTML = isLover ? `
        <div class="relationship-container" style="margin-top: 15px;">
            <div class="heart-meter" style="color: #8e44ad;">
                 <div class="heart-fill" style="height: ${100 - (rel.devotion || 0)}%;"></div>
                 <i class="fas fa-hand-holding-heart heart-icon"></i>
            </div>
            <div class="relationship-tag">痴情度 (${rel.devotion || 0})</div>
        </div>
    ` : '';

    const middleSectionHTML = `
        <div class="social-card-middle">
            <div class="attributes-vertical-container">
                ${Object.entries(npc.attributes || {}).filter(([key,]) => ATTR_MAP[key]).map(([key, value]) => `
                    <div class="attribute-vertical">
                        <div class="progress-bar-vertical-wrapper">
                            <div class="progress-bar-vertical-fill ${key}-fill" style="height: ${Math.min(100, (value/150)*100)}%;"></div>
                        </div>
                        <span class="name">${ATTR_MAP[key]}</span>
                        <span class="value">${Math.floor(value)}</span>
                    </div>
                `).join('')}
            </div>
            <div class="relationship-container">
                <div class="heart-meter">
                    <div class="heart-fill" style="height: ${100 - favorPercent}%;"></div>
                    <i class="fas ${favorIcon} heart-icon"></i>
                </div>
                <div class="relationship-tag">${favorTag} (${npc.favor})</div>
                <div class="relationship-trend trend-stable"><i class="fas fa-minus"></i> 关系稳定</div>
                ${npc.status ? `<div class="special-status-display"><i class="fas fa-info-circle"></i> 状态: ${npc.status}</div>` : ''}
                ${devotionHTML}
            </div>
        </div>
    `;

    const actions = generateNpcActionButtons(npc);
    let bottomSectionHTML = `
        <div class="social-card-actions">
            ${actions.map(action => `
                <button class="action-button ${!action.available ? 'disabled' : ''}" 
                        style="${action.style || ''}"
                        onclick="${action.available ? `handleNpcInteraction('${npc.id}', '${action.id}', '${action.relType || ''}')` : ''}">
                    <i class="fas ${action.icon}"></i>
                    <span>${action.name}</span>
                </button>
            `).join('')}
        </div>
    `;

    let specialActionsHTML = '';
    if (isLover) {
        specialActionsHTML = `
            <div class="special-actions-card">
                <button class="option" style="background: linear-gradient(135deg, #c03b2b, #e74c3c);" onclick="showSpecialInteractionOverlay('${npcId}')">
                    <i class="fas fa-heart-pulse"></i>
                    <span class="option-text">情人私语<div><small>进行秘密互动</small></div></span>
                </button>
            </div>
        `;
    }
    else if (isSwornSibling) {
        specialActionsHTML = `
            <div class="special-actions-card">
                <button class="option" style="background: linear-gradient(135deg, #d35400, #f39c12);" onclick="showSpecialInteractionOverlay('${npcId}')">
                    <i class="fas fa-fist-raised"></i>
                    <span class="option-text">金兰之义<div><small>进行结义互动</small></div></span>
                </button>
            </div>
        `;
    }
    const expandablePanelHTML = `
        <div class="expand-info-toggle" onclick="this.nextElementSibling.classList.toggle('active')">
            查看更多信息 <i class="fas fa-chevron-down"></i>
        </div>
        <div class="expandable-panel">
            <h5><i class="fas fa-thumbs-up"></i> 喜好</h5>
            <ul><li>- ${npc.preferences.known ? npc.preferences.likes.map(id => TRADING_GOODS_DATA[id].name).join('、') : '暂未探知'}</li></ul>
            <h5><i class="fas fa-thumbs-down"></i> 厌恶</h5>
            <ul><li>- ${npc.preferences.known ? npc.preferences.dislikes.map(id => TRADING_GOODS_DATA[id].name).join('、') : '暂未探知'}</li></ul>
        </div>
    `;

    const finalHTML = `
        <div class="social-card-scroll" style="${scrollStyle}">
            <button class="overlay-close-btn" onclick="closeAllOverlays()">×</button>
            <div class="theme-decorator top-right"></div>
            <div class="theme-decorator bottom-left"></div>
            ${topSectionHTML}
            ${middleSectionHTML}
            ${bottomSectionHTML}
            ${specialActionsHTML} 
            ${expandablePanelHTML}
        </div>
    `;

    container.innerHTML = finalHTML;
    showOverlay('npcDetailOverlay');
}
function startGathering(initiatorNpcId) {
    const initiatorNpc = gameState.npcs[initiatorNpcId];
    const friends = Object.keys(gameState.social.relationships)
        .filter(id => id !== initiatorNpcId && gameState.npcs[id] && !gameState.npcs[id].isDead)
        .map(id => gameState.npcs[id]);

    if (friends.length === 0) {
        showToast("你还没有其他朋友可以邀请。");
        return;
    }

    let options = friends.map(friend => ({
        htmlContent: `<div class="suitor" style="margin-bottom:0; padding:5px;"><div class="suitor-avatar-wrapper" style="width:40px;height:40px;"><img src="${friend.avatar}" class="suitor-avatar"></div><div class="suitor-details"><div class="suitor-name">${friend.name}</div></div></div>`,
        style: `padding: 5px; height: auto;`,
        callback: () => {
            showGatheringOverlay(initiatorNpc, friend);
        }
    }));

    showDecisionCard('邀请何人？', 'fa-user-plus', `你打算邀请谁与 <strong class="highlight-npc">${initiatorNpc.name}</strong> 一同聚会？`, options);
}

function showGatheringOverlay(npc1, npc2) {
    closeAllOverlays();
    const overlay = document.getElementById('gatheringOverlay');
    const player = gameState.player;

    // 随机一个聚会背景
    const backgrounds = ['https://img.zcool.cn/community/01a43a59a76472a8012028a92a5482.jpg@1280w_1l_2o_100sh.jpg', 'https://img.zcool.cn/community/01f41d5970371fa8012193a34a3291.jpg@1280w_1l_2o_100sh.jpg'];
    overlay.style.backgroundImage = `url(${getRandomElement(backgrounds)})`;

    overlay.innerHTML = `
        <div class="gathering-container">
            <div class="gathering-npc" style="top: 30%; left: 15%;">
                <img src="${npc1.avatar}" alt="${npc1.name}">
                <div class="name">${npc1.name}</div>
            </div>
            <div class="gathering-npc" style="top: 50%; left: 45%;">
                <img src="${player.avatar}" alt="${player.name}">
                <div class="name">${player.name}</div>
            </div>
            <div class="gathering-npc" style="top: 30%; right: 15%;">
                <img src="${npc2.avatar}" alt="${npc2.name}">
                <div class="name">${npc2.name}</div>
            </div>

            <div class="gathering-ui">
                <div class="gathering-desc">你与 ${npc1.name}、${npc2.name} 在雅间小聚，气氛正好。</div>
                <div class="gathering-actions">
                    <button class="control-btn" onclick="handleGatheringAction('chat', ['${npc1.id}', '${npc2.id}'])"><i class="fas fa-comments"></i> 闲聊</button>
                    <button class="control-btn" onclick="handleGatheringAction('drink', ['${npc1.id}', '${npc2.id}'])"><i class="fas fa-wine-glass"></i> 饮酒</button>
                    <button class="control-btn" onclick="handleGatheringAction('game', ['${npc1.id}', '${npc2.id}'])"><i class="fas fa-chess"></i> 游戏</button>
                    <button class="control-btn" style="background:var(--control-shadow-hover);" onclick="closeAllOverlays()">结束聚会</button>
                </div>
            </div>
        </div>`;
    showOverlay('gatheringOverlay');
}

function handleGatheringAction(action, npcIds) {
    const npc1 = gameState.npcs[npcIds[0]];
    const npc2 = gameState.npcs[npcIds[1]];

    switch(action) {
        case 'chat':
            showEventCard('闲谈甚欢', 'fa-comments', `你们三人天南海北地闲聊，气氛十分融洽。<br>${npc1.name} 好感+3, ${npc2.name} 好感+3。`);
            applyEffects({ relationship: { targetId: npc1.id, favor: 3 } });
            applyEffects({ relationship: { targetId: npc2.id, favor: 3 } });
            break;
        case 'drink':
            showEventCard('推杯换盏', 'fa-wine-glass', `酒过三巡，你们都有些微醺，话也多了起来。<br>${npc1.name} 好感+5, ${npc2.name} 好感+5。`);
            applyEffects({ relationship: { targetId: npc1.id, favor: 5 } });
            applyEffects({ relationship: { targetId: npc2.id, favor: 5 } });
            break;
        case 'game':
            // 在这里可以重新调用你的小游戏
            const opponent = Math.random() > 0.5 ? npc1 : npc2;
            showToast(`你邀请 ${opponent.name} 来一局对弈。`);
            closeAllOverlays();
            setTimeout(() => startGoMiniGame(opponent.id), 300);
            break;
    }
}

// [替换]
function handleNpcInteraction(npcId, actionId, relType = '') {
    // 【核心修改】在函数开头加入新的检查
    if (!checkAndUseNpcActionPoint(npcId)) {
        return; // 如果互动次数已满，则直接退出函数
    }

    const npc = gameState.npcs[npcId];
    if (!npc) return;

    if (relType && RELATIONSHIP_DATA[relType] && RELATIONSHIP_DATA[relType].interactions.some(i => i.id === actionId)) {
        handleSocialInteraction(npcId, relType, actionId);
        return;
    }

    if (actionId === 'start_confession') {
        startConfessionProcess(npcId);
        return;
    }
    
    if (actionId === 'become_sworn_sibling') {
        triggerOathProposal(npcId);
        return;
    }
    
    switch (actionId) {
        case 'chat': interactWithNpc(npcId, 'chat'); break;
        case 'giveGift': showGiftGivingOverlay(npcId); break;
        case 'gathering': startGathering(npcId); break;
        case 'conversation_game': startConversationMiniGame(npcId); break;
        case 'go_game': startGoMiniGame(npcId); break;
        case 'guzheng_game': startGuzhengMiniGame(npcId); break;
        case 'askPreference':
            if (gameState.player.gender === 'male') {
                showFengYueJian(true, npcId);
            } else {
                if (gameState.player.attributes.charm > 40) {
                    npc.preferences.known = true;
                    showEventCard('旁敲侧击', 'fa-ear-listen', `在你的巧妙引导下，${npc.name}无意中透露了TA的喜好。`);
                    showNPCDetails(npcId);
                } else {
                    showEventCard('旁敲侧击', 'fa-times-circle', `你的问题有些直接，${npc.name}警觉地转移了话题。`);
                }
            }
            break;
        case 'propose': marrySuitor(npcId); break;
        case 'divorce': handleDivorce(); break;
        default: handleSpecialInteraction(npcId, actionId); break;
    }
    renderGame();
}

// ===================== 【新功能】重构NPC交互逻辑 =====================
// =======================================================================
// [替换] 原有的 generateNpcInteractionOptions 函数
// [替换] generateNpcInteractionOptions 函数
function generateNpcInteractionOptions(npc) {
    const { id: npcId, favor } = npc;
    let optionsHTML = '';

    // 基础互动
    optionsHTML += `<button class="option" onclick="interactWithNpc('${npcId}', 'chat')"><i class="fas fa-comments"></i> 闲聊</button>`;
    optionsHTML += `<button class="option" onclick="interactWithNpc('${npcId}', 'gift')"><i class="fas fa-gift"></i> 送礼</button>`;
    
    const rel = gameState.social.relationships[npcId];

    // 特殊邀约 -> 小游戏
    if (favor >= 50) {
        optionsHTML += `<button class="option" onclick="startConversationMiniGame('${npcId}')"><i class="fas fa-heart"></i> 促膝长谈</button>`;
        if(npc.attributes.wisdom >= 60) {
            optionsHTML += `<button class="option" onclick="startGoMiniGame('${npcId}')"><i class="fas fa-chess-go"></i> 手谈对弈</button>`;
        }
    }

    // 关系特定互动
    if (rel && RELATIONSHIP_DATA[rel.type]) {
        const relData = RELATIONSHIP_DATA[rel.type];
        relData.interactions.forEach(interaction => {
            if (favor >= interaction.min_favor && rel.level >= interaction.min_level) {
                optionsHTML += `<button class="option" onclick="handleSocialInteraction('${npcId}', '${rel.type}', '${interaction.id}')">
                    <i class="fas fa-handshake"></i> ${interaction.name}
                </button>`;
            }
        });
    }

    // 结婚/纳妾等逻辑
    if (npc.relationship === 'suitor' && favor > 80 && gameState.player.age >= 16 && !gameState.marriage.isMarried) {
        optionsHTML += `<button class="option" style="background:linear-gradient(135deg, #e74c3c, #c0392b);" onclick="marrySuitor('${npcId}')"><i class="fas fa-ring"></i> ${gameState.player.gender === 'male' ? '提亲' : '应允亲事'}</button>`;
    }
    
    return optionsHTML;
}
function handleSocialInteraction(npcId, relType, interactionId) {
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    const relData = RELATIONSHIP_DATA[relType];
    const interaction = relData ? relData.interactions.find(i => i.id === interactionId) : null;

    if (!npc || !interaction) {
        showToast("互动数据错误");
        return;
    }

    const rel = gameState.social.relationships[npcId];
    if (rel) {
        rel.emotionValue = (rel.emotionValue || 0) + getRandomInt(5, 10);
        rel.eventsExperienced = (rel.eventsExperienced || 0) + 1;
    }

    // ===================== 互动逻辑判断 (Switch..Case) =====================
    switch (interactionId) {
        // --- 红颜/蓝颜知己互动 ---
        case 'moon_drink': {
            showDecisionCard('月下对饮', 'fa-wine-glass-bottle',
                `明月当空，<strong class="highlight-npc">${npc.name}</strong>邀你小酌，席间谈及人生理想与遗憾。`,
                [
                    { htmlContent: '【倾诉心声】', callback: () => {
                        showEventCard('推心置腹', 'fa-heart', '你的真诚打动了对方。好感+10，情感值+15。');
                        applyEffects({ relationship: { targetId: npcId, favor: 10, emotionValue: 15 } });
                        // 你可以在这里添加一个获得“信任”特质的逻辑
                    }},
                    { htmlContent: '【笑而不语】', callback: () => {
                        showEventCard('静默的陪伴', 'fa-moon', '你静静地聆听，有时无声胜有声。好感+5，气质+2。');
                        applyEffects({ relationship: { targetId: npcId, favor: 5 }, attributes: { charm: 2 } });
                    }},
                    { htmlContent: '【借酒调侃】', callback: () => {
                        if (player.attributes.charm >= 70) {
                            showEventCard('风趣的回应', 'fa-grin-wink', '你风趣的调侃让对方莞尔一笑，气氛更加融洽。好感+15。');
                            applyEffects({ relationship: { targetId: npcId, favor: 15, emotionValue: 10 } });
                        } else {
                            showEventCard('尴尬的玩笑', 'fa-meh', '你的调侃略显轻浮，对方皱了皱眉。好感-5。');
                            applyEffects({ relationship: { targetId: npcId, favor: -5 } });
                        }
                    }}
                ]
            );
            break;
        }
        case 'receive_gift': {
             showDecisionCard('意外赠礼', 'fa-gift',
                `<strong class="highlight-npc">${npc.name}</strong>将一件贴身之物（如手帕、玉佩）赠予你，眼中似有万千言语。`,
                [
                    { htmlContent: '【欣然收下】', callback: () => {
                        addItemToInventory(`token_from_${npcId}`, 1, { name: `${npc.name}的信物`, desc: `来自${npc.name}的信物，见证着你们的情谊。`, type: '珍品', icon: 'fa-gem'});
                        showEventCard('情谊之证', 'fa-gem', '你收下了信物，对方看起来很高兴。好感+10。');
                        applyEffects({ relationship: { targetId: npcId, favor: 10, emotionValue: 10 } });
                    }},
                    { htmlContent: '【婉拒】', callback: () => {
                        showEventCard('坚守界线', 'fa-hand-paper', '你婉拒了这份过于亲密的礼物。好感-5，品德+5。');
                        applyEffects({ relationship: { targetId: npcId, favor: -5 }, attributes: { virtue: 5 } });
                    }},
                    { htmlContent: '【回赠更重之礼】', callback: () => {
                        if (gameState.finances.wealth >= 500) {
                            showEventCard('礼尚往来', 'fa-exchange-alt', '你的慷慨让对方大为感动，你们的关系升华为挚友！好感+20。');
                            applyEffects({ wealth: -500, relationship: { targetId: npcId, favor: 20, emotionValue: 25 } });
                            updateRelationshipLevel(npcId, true); // 强制提升等级
                        } else {
                            showToast("你的财富不足500两，无法回赠重礼。");
                        }
                    }}
                ]
            );
            break;
        }
        case 'be_rescued': {
            showDecisionCard('为君解围', 'fa-shield-alt',
                `在一次社交场合，你因一时失言陷入尴尬，<strong class="highlight-npc">${npc.name}</strong>几句巧妙的话语便为你化解了危机。`,
                [
                    { htmlContent: '【私下致谢】', callback: () => {
                        showEventCard('心照不宣', 'fa-user-secret', '你私下向对方致谢，彼此会心一笑。好感+10，魅力+5。');
                        applyEffects({ relationship: { targetId: npcId, favor: 10 }, attributes: { charm: 5 } });
                    }},
                    { htmlContent: '【公开赞扬】', callback: () => {
                        showEventCard('广而告之', 'fa-bullhorn', '你公开赞扬了对方的机智，令其在众人面前大有面子。好感+15，对方声望+10。');
                        applyEffects({ relationship: { targetId: npcId, favor: 15, emotionValue: 10 } });
                        // 此处可以添加提升NPC声望的逻辑
                    }},
                    { htmlContent: '【淡然处之】', callback: () => {
                        showEventCard('波澜不惊', 'fa-water', '你对此淡然处之，似乎一切尽在掌握。气质+3。');
                        applyEffects({ attributes: { charm: 3 } });
                    }}
                ]
            );
            break;
        }

        // --- 情人互动 ---
        case 'rendezvous': {
            showDecisionCard('私会邀约', 'fa-moon',
                `夜色已深，<strong class="highlight-npc">${npc.name}</strong>派人送信，邀你于花园相见。`,
                [
                    { htmlContent: '【欣然赴约】', callback: () => {
                        showEventCard('月下之约', 'fa-kiss-wink-heart', '你们在月影花香中互诉衷肠，情意更浓。好感+20。');
                        applyEffects({ relationship: { targetId: npcId, favor: 20, emotionValue: 20 } });
                        // 可以在这里触发更具体的亲密事件
                        if(Math.random() < 0.2) triggerBirth(npcId, true); // 20%怀孕几率
                    }},
                    { htmlContent: '【婉拒】', callback: () => {
                        showEventCard('理智战胜情感', 'fa-hand-paper', '你最终没有赴约。好感-10，品德+10。');
                        applyEffects({ relationship: { targetId: npcId, favor: -10 }, attributes: { virtue: 10 } });
                    }},
                    { htmlContent: '【带友人同去】', callback: () => {
                        showEventCard('大煞风景', 'fa-users-slash', '你带着朋友出现，对方的脸色瞬间变得很难看。关系降级。');
                        applyEffects({ relationship: { targetId: npcId, favor: -20, emotionValue: -50 } });
                        updateRelationshipLevel(npcId);
                    }}
                ]
            );
            break;
        }
        case 'jealousy': {
             // 防止事件过于频繁
            if (gameState.social.loverStats.jealousyCooldown > 0) {
                showToast(`${npc.name}目前心情尚好，并无醋意。`);
                return;
            }
            gameState.social.loverStats.jealousyCooldown = 4; // 冷却2年

            showDecisionCard('争风吃醋', 'fa-fire',
                `<strong class="highlight-npc">${npc.name}</strong>看到你与旁人谈笑风生，眼中流露出明显的不悦。`,
                [
                    { htmlContent: '【安抚解释】', callback: () => {
                        showEventCard('温柔安抚', 'fa-heart', '你的温柔解释化解了TA的醋意。好感+10，魅力+5。');
                        applyEffects({ relationship: { targetId: npcId, favor: 10 }, attributes: { charm: 5 } });
                    }},
                    { htmlContent: '【不予理会】', callback: () => {
                        showEventCard('关系冷却', 'fa-snowflake', '你的冷淡让TA更加伤心。好感-15。');
                        applyEffects({ relationship: { targetId: npcId, favor: -15, emotionValue: -20 } });
                    }},
                    { htmlContent: '【反客为主】', callback: () => {
                        if (player.attributes.charm >= 80) {
                            showEventCard('高明手段', 'fa-theater-masks', '你反过来调侃TA的醋意，几句蜜语就让TA转嗔为喜。好感+20。');
                            applyEffects({ relationship: { targetId: npcId, favor: 20, emotionValue: 15 } });
                        } else {
                            showEventCard('弄巧成拙', 'fa-meh-rolling-eyes', '你的反客为主显得过于强势，让TA更加不快。好感-10。');
                            applyEffects({ relationship: { targetId: npcId, favor: -10 } });
                        }
                    }}
                ]
            );
            break;
        }
        case 'propose_elopement': {
            showDecisionCard('请求私奔', 'fa-running',
                `<strong class="highlight-npc">${npc.name}</strong>含泪望着你，请求你与TA一同私奔，远离这世俗纷扰。`,
                [
                    { htmlContent: '【答应】', callback: () => {
                        if (gameState.finances.wealth >= 1000) {
                            showEndGame({ title: "为爱私奔", text: `你放弃了现有的一切，与${npc.name}一起远走高飞，开始了未知但自由的新生活。` });
                        } else {
                            showToast("你们连私奔的路费都凑不齐，只能无奈放弃。");
                        }
                    }},
                    { htmlContent: '【劝其冷静】', callback: () => {
                        showEventCard('回归现实', 'fa-cloud', '你劝说对方要冷静，私奔并非儿戏。好感-10，品德+10。');
                        applyEffects({ relationship: { targetId: npcId, favor: -10 }, attributes: { virtue: 10 } });
                    }},
                    { htmlContent: '【提出条件】', callback: () => {
                         if (player.attributes.wisdom >= 80) {
                            // 假设转为正式关系是纳为妾室
                            if (player.gender === 'male' && gameState.marriage.concubines.length < 5) {
                                showEventCard('谈判成功', 'fa-handshake', `你用智慧说服了对方，决定给TA一个名分。`);
                                acquireConcubine(npcId);
                            } else {
                                showToast("你无法给对方一个正式的名分。");
                            }
                        } else {
                             showToast("你的智慧不足以说服对方，TA对你的提议感到失望。");
                             applyEffects({ relationship: { targetId: npcId, favor: -15 } });
                        }
                    }}
                ]
            );
            break;
        }
        
        // --- 同袍/同事互动 ---
        case 'fight_together': {
            showDecisionCard('并肩作战', 'fa-fist-raised',
                `你与 <strong class="highlight-npc">${npc.name}</strong> 需共同应对一项棘手的任务。`,
                [
                    { htmlContent: '【全力配合】', callback: () => {
                        showEventCard('合作无间', 'fa-hands-helping', '你们配合默契，圆满完成了任务。关系得到升华。');
                        applyEffects({ relationship: { targetId: npcId, favor: 15, emotionValue: 20 } });
                        updateRelationshipLevel(npcId, true); // 强制升级
                    }},
                    { htmlContent: '【保留实力】', callback: () => {
                        showEventCard('明哲保身', 'fa-user-shield', '你保留了部分实力，虽然任务完成了，但对方似乎有所察觉。智慧+5，好感-5。');
                        applyEffects({ attributes: { wisdom: 5 }, relationship: { targetId: npcId, favor: -5 } });
                    }},
                    { htmlContent: '【临阵脱逃】', callback: () => {
                        showEventCard('背信弃义', 'fa-user-slash', '你选择了临阵脱逃，导致任务失败。你们的关系彻底破裂。');
                        applyEffects({ attributes: { reputation: -20, virtue: -15 } });
                        delete gameState.social.relationships[npcId];
                    }}
                ]
            );
            break;
        }
        
        // --- 特殊关系互动 ---
        case 'teach_skill': {
             showDecisionCard('传授技能', 'fa-graduation-cap',
                `<strong class="highlight-npc">${npc.name}</strong>见你骨骼清奇，欲传授你一项独门技艺。`,
                [
                    { htmlContent: '【虚心学习】', callback: () => {
                        const attrKeys = ['talent', 'wisdom', 'charm', 'martial'];
                        const randomAttr = getRandomElement(attrKeys);
                        showEventCard('得传真传', 'fa-book-reader', `你虚心学习，受益匪浅。${ATTR_MAP[randomAttr]}+10，好感+10。`);
                        applyEffects({ attributes: { [randomAttr]: 10 }, relationship: { targetId: npcId, favor: 10 } });
                    }},
                    { htmlContent: '【提出交换】', callback: () => {
                         showEventCard('互通有无', 'fa-exchange-alt', '你们互相交换心得，双方都有所精进。好感+15。');
                         const attrKeys1 = ['talent', 'wisdom', 'charm', 'martial'];
                         const randomAttr1 = getRandomElement(attrKeys1);
                         const randomAttr2 = getRandomElement(attrKeys1);
                         applyEffects({ attributes: { [randomAttr1]: 5 }, relationship: { targetId: npcId, favor: 15 } });
                         // 此处可以给NPC也增加属性
                    }},
                    { htmlContent: '【拒绝】', callback: () => {
                        showEventCard('婉拒好意', 'fa-hand-paper', '你拒绝了对方的好意。好感-5。');
                        applyEffects({ relationship: { targetId: npcId, favor: -5 } });
                    }}
                ]
            );
            break;
           }
        case 'become_sworn': {
            rel.type = 'sworn_sibling';
            const swornType = player.gender === 'male' ? '兄弟' : '姐妹';
            showEventCard('义结金兰', 'fa-hands-helping', `你与 <strong class="highlight-npc">${npc.name}</strong> 焚香结拜，从此祸福与共，成为生死不离的${swornType}！`);
            break;
        }
        // --- 情人互动 ---
        case 'rendezvous':
            showEventCard('月下之约', 'fa-kiss-wink-heart', '你们在月影花香中互诉衷肠，情意更浓。好感+20。');
            applyEffects({ relationship: { targetId: npcId, favor: 20 } });
            if (player.gender === 'female' && Math.random() < 0.2) { // 女性玩家有机会怀孕
                triggerBirth(npcId, true); 
            }
            break;
        // 更多情人事件可以加在这里...
        default:
            showToast(`你和${npc.name}进行了“${interaction.name}”互动，增进了感情。`);
            applyEffects({ relationship: { targetId: npcId, favor: 5 } });
            break;
    }

    updateRelationshipLevel(npcId);
    showNPCDetails(npcId);
}
// 【新增的缺失函数】处理私生子决定
// [替换此函数]
function handleSecretChildDecision(childId, decision, onComplete = () => {}) {
    const childIndex = gameState.children.findIndex(c => c.id === childId);
    if (childIndex === -1) {
        if(onComplete) onComplete();
        return;
    }
    const child = gameState.children[childIndex];
    if (decision === 'keep') {
        if(gameState.player.gender === 'female'){
            child.isLegitimate = false; // 标记为非婚生
            child.fatherId = null; // 合法父亲为空
        }
        child.isSecret = false; // 变为公开，但身份特殊
        const motherName = gameState.npcs[child.motherId] ? gameState.npcs[child.motherId].name : '你';
        showNameChildOverlay(childId, motherName, false); 
        logEvent(`你决定认下与<strong class="highlight-npc">${gameState.npcs[child.biologicalFatherId].name}</strong>的私生子，并将其带回府中抚养。`);
    } else { // abandon
        gameState.children.splice(childIndex, 1);
        applyEffects({ attributes: { virtue: -20 } });
        showEventCard('狠心遗弃', 'fa-user-times', '你狠下心，将这个无辜的孩子遗弃。你的品德大幅下降。');
        closeAllOverlays();
        if(onComplete) onComplete();
    }
}
function confirmPlayerNaming(childId) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    const newNameInput = document.getElementById('newChildNameInput');
    let trimmedName = newNameInput.value.trim();
    
    if (trimmedName.length === 0 || trimmedName.length > 3) {
        showToast("名字长度不合规（1-3个字），已交由配偶命名。");
        autoNameBySpouse(childId); // 如果输入不合规，自动让配偶取名
        return;
    }
    
    // 名字合规，调用最终命名逻辑
    finalizeChildName(childId, trimmedName, '你');
}

function finalizeChildName(childId, givenName, namer) {
    const child = gameState.children.find(c => c.id === childId);
    if (!child) return;

    let surname = '';
    // 优先使用合法父亲的姓
    const legalFather = child.fatherId ? (gameState.npcs[child.fatherId] || (child.fatherId === 'player' ? gameState.player : null)) : null;
    const biologicalFather = child.biologicalFatherId ? gameState.npcs[child.biologicalFatherId] : null;

    if (legalFather && legalFather.name) {
        surname = legalFather.name.slice(0, 1);
    } 
    // 其次使用生物学父亲的姓
    else if (biologicalFather && biologicalFather.name) {
        surname = biologicalFather.name.slice(0, 1);
    } 
    // 最后使用玩家的姓作为备用
    else {
        surname = gameState.player.name.slice(0, 1);
    }

    let finalName = surname + givenName;
    
    // 查重
    let i = 2;
    const originalGivenName = givenName;
    while (gameState.flags.allNames.has(finalName)) {
        givenName = originalGivenName + (i === 2 ? '二' : '三');
        finalName = surname + givenName;
        i++;
    }
    
    child.name = finalName;
    gameState.flags.allNames.add(finalName);
    
    const message = namer === '你'
        ? `你为新生儿取名为 <strong class="value">${child.name}</strong>。`
        : `${namer}思索片刻，为孩子取名为 <strong class="value">${child.name}</strong>。`;
        
    showEventCard('天赐佳名', 'fa-pen-fancy', message);
    closeAllOverlays();
    renderGame();
}
function checkRelationshipBreakup() {
    if (!gameState.social.relationships) return;

    for (const npcId in gameState.social.relationships) {
        const rel = gameState.social.relationships[npcId];
        const npc = gameState.npcs[npcId];
        if (!npc || npc.isDead) continue;

        let shouldBreak = false;
        let breakReason = "";

        if (npc.favor <= -50) {
            shouldBreak = true;
            breakReason = "你们之间已无情分可言。";
        }

        const currentTurn = gameState.date.year * 2 + gameState.date.turn;
        if (currentTurn - (npc.lastInteractedTurn || 0) > 6) { // 超过3年未互动
             rel.emotionValue = Math.max(0, (rel.emotionValue || 0) - 10); 
             if (rel.emotionValue <= 0 && rel.level <= 1) { 
                shouldBreak = true;
                breakReason = "由于长期不联系，你们的情谊已渐渐消散。";
             }
        }

        if (shouldBreak) {
            const oldRelName = RELATIONSHIP_DATA[rel.type]?.name || "旧友";
            eventQueue.push(() => {
                showEventCard('关系破裂', 'fa-user-slash', `你与 <strong class="highlight-npc">${npc.name}</strong>（${oldRelName}）的关系走到了尽头。${breakReason}`);
            });
            delete gameState.social.relationships[npcId];
            gameState.social.secretLovers = gameState.social.secretLovers.filter(id => id !== npcId);
        }
    }
}
function developRelationship(npcId, newType) {
    if (!gameState.social.relationships[npcId]) {
        gameState.social.relationships[npcId] = {
            type: newType,
            favor: gameState.npcs[npcId].favor,
            emotionValue: 0, // 新增
            level: 0,          // 新增
            eventsExperienced: 0, // 新增
            isSworn: false     // 新增
        };

        const relData = RELATIONSHIP_DATA[newType];
        if (relData) {
            showEventCard('关系升温', 'fa-heart', `你与 <strong class="highlight-npc">${gameState.npcs[npcId].name}</strong> 的关系更进一步，成为了${relData.name}！`);
        }
        
        // 从可结交对象中移除
        gameState.suitors = gameState.suitors.filter(id => id !== npcId);
    }
    showNPCDetails(npcId);
}
function giveAllowanceToParent(parentId) {
    const parent = gameState.npcs[parentId];
    if (gameState.player.age < 15) { showToast("你尚未成年，还无需承担赡养之责。"); return; }
    const amountStr = prompt(`请输入要孝敬${parent.name}的金额：`, "100");
    const amount = parseInt(amountStr);
    if(isNaN(amount) || amount <= 0) return;
    if(gameState.finances.wealth < amount) { showToast("私产不足。"); return; }

    parent.lastInteractedTurn = (gameState.date.year * 2) + gameState.date.turn;
    applyEffects({ wealth: -amount, relationship: { targetId: parentId, favor: Math.floor(amount / 20) }, attributes: { virtue: Math.floor(amount/50)} });
    showEventCard('拳拳孝心', 'fa-hand-holding-heart', `你孝敬了${parent.name} <span class='value'>${amount}</span> 两，他们对你赞不绝口。`);
    showNPCDetails(parentId);
}

// ===================== 【替换】showMatchmaker 函数 =====================
function showMatchmaker(forConcubine = false) {
    let content = forConcubine
    ? `<p>你正在为自己物色妾室人选... 你可以花费<span class="value">1500</span>两直接纳一位身家清白的姑娘为妾。</p>`
    : `<p>媒婆热情地接待了你，向你保证能介绍合适的伴侣。</p>`;
    let options = [];
    if (!forConcubine) {
        if(!gameState.marriage.isMarried && gameState.player.age >= 16) {
             // 【核心修改】这里的 callback 事件被替换了，现在会调用新的议亲流程
             options.push({
                htmlContent:`<i class="fas fa-ring"></i> 安排议亲 (-3000两)`, 
                disabled:gameState.finances.wealth<3000, 
                callback:() => {
                    if (gameState.finances.wealth < 3000) {
                        showToast("你的钱不够支付媒人费。");
                        return;
                    }
                    applyEffects({wealth: -3000});
                    showPlayerArrangedMarriage(); // 调用新函数，展示候选人列表
                }
             });
        }
    } else {
        if(gameState.marriage.concubines.length >= 5) {
            content += `<p class="comment">妾室名额已满。</p>`
        } else {
             options.push({htmlContent:`<i class="fas fa-user-plus"></i> 直接纳妾 (-1500两)`, disabled:gameState.finances.wealth<1500, callback:() => hireMatchmaker('female', true, false, 1500)});
        }
    }
    showDecisionCard("金牌媒婆", "🤝", content, options);
}

function hireMatchmaker(gender, forConcubine = false, forMarriage = false, cost) {
    if (gameState.finances.wealth < cost) { showToast("你的钱不够支付媒人费。"); return; }
    applyEffects({wealth: -cost});

    const backgrounds = gender === 'female' ? ladyBackgrounds : suitorBackgrounds;
    const bg = getRandomElement(backgrounds);
    const newNpc = generateNPC({ 
        gender: gender, age: getRandomInt(gameState.player.age, gameState.player.age + 5), 
        favor: 5, source: 'matchmaker',
        attributes: {...bg.attributes, family: bg.family},
        relationship: forMarriage ? 'spouse' : (forConcubine ? 'concubine' : 'suitor')
    });

    if (forMarriage) {
        marrySuitor(newNpc.id);
    } else if (forConcubine) {
        acquireConcubine(newNpc.id);
    } else {
        if(newNpc.gender !== gameState.player.gender) {
            gameState.suitors.push(newNpc.id)
        } else {
            gameState.social.friends.push(newNpc.id)
        }
        showEventCard('媒人引荐', 'fa-user-friends', `媒婆为你介绍了 <strong class="highlight-npc">${newNpc.name}</strong>，你们互换了名帖。`);
    }
    renderGame();
}

// =======================================================================
// ============================= THEME & VISUALS =========================
// =======================================================================
function setTheme(theme) {
    document.body.dataset.theme = theme;
    
    const themeIcons = document.querySelectorAll('.theme-icon');
    if (themeIcons.length > 0) {
        themeIcons.forEach(icon => icon.classList.remove('active'));
        const activeIcon = document.getElementById(`theme-${theme}`);
        if (activeIcon) { 
            activeIcon.classList.add('active');
        }
    }
    
    updateParticles(theme);
}
function updateParticles(theme) {
    const container = document.getElementById('particle-container');
    if(!container) return;
    container.innerHTML = '';
    const particleConfig = {
        spring: { content: '🌸', count: 15 },
        summer: { content: '🍃', count: 15 },
        autumn: { content: '🍂', count: 15 },
        winter: { content: '❄️', count: 20 },
        night: { content: '✨', count: 25 },
    };
    if (!particleConfig[theme]) return;
    const config = particleConfig[theme];
    for (let i = 0; i < config.count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.innerHTML = config.content;
        particle.style.left = `${Math.random() * 100}vw`;
        const delay = Math.random() * 5;
        const duration = Math.random() * 5 + 5;
        particle.style.animation = `fall ${duration}s ${delay}s linear forwards`;
        particle.style.fontSize = `${Math.random() * 10 + 10}px`;
        container.appendChild(particle);
    }
}
// =======================================================================
// ========================== END GAME & INHERITANCE =====================
// =======================================================================
function checkEndGame() {
    let reason = null;
    const age = Math.floor(gameState.player.age);
    if (gameState.player.health <= 0) reason = { title: "油尽灯枯", text: `你因健康耗尽而逝，年仅${age}岁。` };
    if (age >= 100) reason = { title: "寿终正寝", text: `你安详地走完了百岁人生，福寿双全。` };
    if (age >= 70 && Math.random() < ((age - 69) * 0.02) ) reason = { title: "寿终正寝", text: `你安详地走完了${age}岁的人生。` };
    if (gameState.finances.wealth < -20000) reason = { title: "倾家荡产", text: `你负债累累，最终凄凉离世，年仅${age}岁。` };

    if (reason) {
        showEndGame(reason);
        return true;
    }
    return false;
}
function showEndGame(reasonData) {
    // 游戏结束时，不再显示旧的继承界面，而是启动天命轮回录系统
    startDestinyCycle();
}
function handleChildInheritance() {
    const heirs = gameState.children.filter(c => c.age >= 16 && !c.isDead);
    if (heirs.length === 0) {
        showToast("你没有成年的子嗣可以继承。");
        return;
    }

    let options = heirs.map(heir => {
        return {
            htmlContent: `<i class="fas fa-user-graduate"></i> <strong>${heir.name}</strong> (${heir.career ? heir.career.name : '未就职'})`,
            callback: () => restartGame(heir)
        };
    });

    showDecisionCard('选择继承人', 'fa-crown', '请选择一位后代开启新的人生：', options);
}


function restartGame(heirData) {
    let inheritance = null;
    let options = { parents: {}, inheritedSpouse: null };

    if (heirData) {
        const isDichu = !heirData.isSecret && (
            (heirData.fatherId === 'player' && heirData.motherId === gameState.marriage.spouseId) ||
            (heirData.motherId === 'player' && heirData.fatherId === gameState.marriage.spouseId)
        );

        const inheritanceRatio = isDichu ? 1.0 : 0.5;
        const inheritableWealth = gameState.finances.wealth > 0 ? gameState.finances.wealth : 0;

        let inheritedCareer = {
            path: null, level: 0, currentAct: 0, performance: 0, 
            supervisorId: null, core_resources: {}, inventory: []
        };
        if (heirData.career && heirData.career.path && heirData.career.path !== 'unemployed') {
             inheritedCareer.path = heirData.career.path;
             inheritedCareer.level = heirData.career.level;

             const professionDef = PROFESSION_DATA[heirData.career.path];
             if(professionDef && professionDef.acts) {
                const numActs = professionDef.acts.length;
                const levelsPerAct = Math.ceil(careerPaths[heirData.gender][heirData.career.path].levels.length / numActs);
                inheritedCareer.currentAct = Math.min(numActs - 1, Math.floor(heirData.career.level / levelsPerAct));
             }
        }

        inheritance = {
            wealth: Math.floor(inheritableWealth * inheritanceRatio),
            attributes: { ...heirData.attributes },
            age: heirData.age,
            name: heirData.name,
            avatar: heirData.avatar,
            career: inheritedCareer,
            items: gameState.inventory.filter(item => {
                const itemDef = ITEM_DATA[item.id];
                return itemDef && (itemDef.type === '珍品' || itemDef.type === '文书');
            })
        };

        if (heirData.marriage.isMarried && heirData.marriage.spouseInfo) {
            const partnerInfo = heirData.marriage.spouseInfo;
            options.inheritedSpouse = generateNPC({
                name: partnerInfo.name,
                gender: partnerInfo.gender || (heirData.gender === 'male' ? 'female' : 'male'),
                age: heirData.age + getRandomInt(-2, 2),
                favor: 80,
                relationship: 'spouse',
                attributes: { ...partnerInfo.attributes },
                avatar: partnerInfo.avatar,
            });
        }
        
        // 核心修改：正确设置父母名字
        const motherNPC = gameState.npcs[heirData.motherId] || (heirData.motherId === 'player' ? gameState.player : null);
        const fatherNPC = gameState.npcs[heirData.fatherId] || (heirData.fatherId === 'player' ? gameState.player : null);
        
        options.parents = { 
            father: fatherNPC ? fatherNPC.name : '未知',
            mother: motherNPC ? motherNPC.name : '未知'
        };

    }

    const genderToStart = heirData ? heirData.gender : gameState.player.gender;
    startNewGame(genderToStart, inheritance, options);
}
// [替换]
// [替换]
function setupNewGame(gender, inheritanceData = null, options = {}) {
    const family = getRandomElement(familyTemplates);
    const allNames = new Set();
    
    // [核心修改] 处理继承数据
    let startAge = 10;
    let playerName, playerAvatar, initialAttributes;
    if (inheritanceData) {
        // 从继承包里解构数据
        const { name, age, avatar, baseAttributes, effects, previousCareerPath, previousWealth } = inheritanceData;
        
        startAge = age;
        playerName = name;
        playerAvatar = avatar;
        
        // 1. 应用基础属性
        initialAttributes = { ...baseAttributes };
        // 2. 应用天赋树加成
        for (const attr in effects.attributes) {
            initialAttributes[attr] = (initialAttributes[attr] || 0) + effects.attributes[attr];
        }
    } else { // 正常开局
        playerName = family.surname + (gender === 'female' ? getRandomElement(nameData.girlNames) : getRandomElement(nameData.boyNames));
        playerAvatar = getRandomElement(avatarPools[gender]);
        initialAttributes = {
            talent: getRandomInt(20, 35), etiquette: getRandomInt(20, 35),
            wisdom: getRandomInt(15, 30), virtue: getRandomInt(15, 30),
            charm: getRandomInt(20, 35), martial: getRandomInt(5, 20),
        };
    }
    allNames.add(playerName);
    if (gender === 'male') {
        initialAttributes.strategy = getRandomInt(10, 25);
        initialAttributes.prestige = getRandomInt(10, 25);
    } else {
        initialAttributes.scheming = getRandomInt(10, 25);
    }
    // 初始化 gameState (保留您原有的所有结构)
    gameState = {
        // ... 您原有的所有 gameState 属性都应该在这里 ...
        // 为了确保不遗漏，我将从您的文件中复制过来并整合
        tradingSystem: {
            isTradingPeriod: false, moneyChest: 1000, warehouse: [],
            // ▼▼▼ 这里是唯一的修改点 ▼▼▼
            warehouseCapacity: WAREHOUSE_LEVELS[0].capacity, // <-- 修复点：从 WAREHOUSE_LEVELS 读取初始容量，而不是写死的20
            // ▲▲▲ 修改结束 ▲▲▲
            tradeLog: [],
            guildFavor: { east: 0, west: 0, south: 0, north: 0 },
            marketStatus: { fluctuations: [], prices: {} }
        },
        version: 11.0,
        player: {
            id: 'player', name: playerName, gender: gender, age: startAge,
            health: 100, attributes: initialAttributes,
            avatar: playerAvatar, level: 1, privateAssets: 0, actionPoints: 1
        },
        family: {
            surname: inheritanceData ? playerName.slice(0,1) : family.surname, 
            title: family.title, reputation: family.reputation, annualIncome: family.annualIncome,
            color: family.color, members: {}, moneyChest: 0
        },
        finances: {
            wealth: family.wealth, // 初始财富
            financialTier: 1, assets: [], merchantLog: []
        },
        merchant: {
            investments: [], ownedLand: {}, activeCrops: [],
            seaExplorationCooldown: 0, 
            fleetLevel: 0, // 新增：初始舰队等级
            voyageCycle: null // 新增：用于跟踪航行周期
        },
        date: { year: Math.floor(startAge), turn: 1 }, log: [], npcs: {},
        social: {
            relationships: {}, friends: [], secretLovers: [], swornSiblings: [],
            friendshipStats: { confidanteCount: 0, swornSiblingCount: 0 },
            loverStats: { infidelityValue: 0, stimulationValue: 0, jealousyCooldown: 0 }
        },
        marriage: { 
            isMarried: false, spouseId: null, favor: 0, concubines: [],
            householdAuthorityHolder: 'mother', familyHarmony: 70, 
            householdAuthority: { progress: 0, personnel: 0, finance: 0, procurement: 0 }
        },
        children: [], suitors: [],
        career: {
            path: null, level: 0, currentAct: 0, performance: 0, 
            supervisorId: null, core_resources: {}
        },
        inventory: [],
        status: { disease: null },
        flags: {
            allNames: allNames, debug_unlimitedActions: false, actionUsed_study: 0, actionUsed_family: false, actionUsed_work: 0,
            activeTab: 'main', gameStarted: true, triggeredAge12Event: false, autoSaveCounter: 0,
            brothelVisitCount: 0, wishingWellThisTurn: false, actionUsed_apprentice: 0,
            childhoodSweetheartId: null, bondValue: 0, hasMetSweetheart: false,
            triggeredSweetheartEvents: [], proposal_bonus: false, mother_support: false,
            fatedLoverId: null, fatedLoverQuestStep: 0,
        },
        rankings: { list: [], playerRank: -1 }, buffs: {},
    };
    // [核心修改] 应用继承数据
    if (inheritanceData) {
        const { effects, previousCareerPath, previousWealth } = inheritanceData;
        gameState.finances.wealth += Math.floor(previousWealth * (effects.bonuses.wealthMultiplier || 0));
        gameState.player.privateAssets += (effects.privateAssets || 0);
        gameState.family.reputation += (effects.reputation || 0);
        Object.assign(gameState.flags, effects.flags);
        
        // 添加遗物
        effects.items.forEach(item => {
            if (item.type !== 'BUFF') {
                addItemToInventory(item.id, 1, item);
            }
        });
        
        // 【错误修复】这里是关键！将 heirData.career.name 修改为 inheritanceData.name
        // 同时增加了对 career 对象的安全检查
        const careerNameFromInheritance = inheritanceData.career ? inheritanceData.career.name : null;
        const chosenCareer = CAREER_CHINESE_TO_ENGLISH_MAP[careerNameFromInheritance];
        if(effects.bonuses.careerLevelBonus && chosenCareer && chosenCareer === previousCareerPath) {
            gameState.career.path = chosenCareer;
            gameState.career.level = 1; // 初始等级+1
        }
    }
    
    // 后续的初始化逻辑 (保留您原有的)
    initApprenticeSystem();
    initTradeSimState();
    gameState.npcs['player'] = gameState.player;
    const fatherName = options.parents?.father || (family.surname + "公");
    const motherName = options.parents?.mother || (getRandomElement(nameData.surnames) + "氏");
    const father = generateNPC({ id:'father', gender: 'male', age: gameState.player.age + 22, name: fatherName, role: '父亲', relationship: 'family', favor: 50 });
    const mother = generateNPC({ id:'mother', gender: 'female', age: gameState.player.age + 20, name: motherName, role: '母亲', relationship: 'family', favor: 50 });
    gameState.family.members['fatherId'] = father.id;
    gameState.family.members['motherId'] = mother.id;
    
// ================== 【新增青梅竹马逻辑】 START ==================
    const sweetheartGender = gender === 'male' ? 'female' : 'male';
    const sweetheartBg = getRandomElement(sweetheartGender === 'female' ? ladyBackgrounds : suitorBackgrounds);
    const sweetheart = generateNPC({
        gender: sweetheartGender,
        age: gameState.player.age,
        favor: 50, // 初始好感度仍然很高
        role: '青梅竹马',
        attributes: sweetheartBg.attributes
    });
    gameState.flags.childhoodSweetheartId = sweetheart.id;
    // 【逻辑修改】此处不再直接将青梅竹马加入社交关系，而是通过12岁的事件来正式结识
    // gameState.social.relationships[sweetheart.id] = { ... }; // 这段代码已被移除
// ================== 【新增青梅竹马逻辑】 END ====================

    if (inheritanceData) {
        logEvent(`你作为 <strong class="value">${playerName}</strong>，继承了先辈的遗志与部分财富，从${Math.floor(startAge)}岁开启了新的人生。`, true);
    } else {
        logEvent(`你出生在${gameState.family.title}之家，名为 <strong class="value">${gameState.player.name}</strong>，今年十岁。`, true);
    }
    
    generateInitialNPCs();
    updateFinancialTier();
    renderGame();
}
// ===================== 【新增】所有新功能函数 =====================

// ------------------- 俸禄领取功能 -------------------
function claimSalary() {
    const unclaimedSalary = gameState.career.unclaimedSalary || 0;
    if (unclaimedSalary <= 0) {
        showToast("没有可领取的俸禄。");
        return;
    }
    applyEffects({ wealth: unclaimedSalary });
    gameState.career.unclaimedSalary = 0;
    showEventCard('俸禄入库', 'fa-coins', `你领取了累积的俸禄，共计 <span class="value">${unclaimedSalary}</span> 两。`);
    renderGame(); // 刷新界面
}

// ------------------- 娶妻/嫁人选择功能 -------------------
function showMarriageCandidatesWrapper(cost) {
    if (gameState.finances.wealth < cost) {
        showToast("你的财富不足以支付媒人费用。");
        return;
    }
    
    const partnerGender = gameState.player.gender === 'male' ? 'female' : 'male';
    const candidates = [];
    for (let i = 0; i < 5; i++) {
        const backgrounds = partnerGender === 'female' ? ladyBackgrounds : suitorBackgrounds;
        const bg = getRandomElement(backgrounds);
        const npc = generateNPC({
            gender: partnerGender,
            age: getRandomInt(gameState.player.age, gameState.player.age + 5),
            favor: 10,
            attributes: { ...bg.attributes, family: bg.family },
            title: bg.desc // 使用背景描述作为头衔
        });
        candidates.push(npc);
    }

    let optionsHTML = candidates.map(npc => {
        const npcDataString = JSON.stringify(npc).replace(/'/g, "&apos;");
        return {
            htmlContent: renderMarriageCandidateCard(npc),
            style: `padding: 10px; height: auto; display: block;`, // 确保每个选项是块级元素
            callback: () => confirmMarriageChoice(npc.id, cost)
        }
    });

    showDecisionCard(
        '良缘自择',
        'fa-users',
        '媒婆为你寻来了五位家世背景各不相同的候选人，请君定夺：',
        optionsHTML
    );
}

function renderMarriageCandidateCard(npc) {
    const avatarContent = npc.avatar
        ? `<img src="${npc.avatar}" class="suitor-avatar" alt="${npc.name} avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
           <div class="suitor-avatar-text" style="display:none; line-height:60px;">${npc.name.slice(0, 1)}</div>`
        : `<div class="suitor-avatar-text" style="line-height:60px;">${npc.name.slice(0, 1)}</div>`;

    return `
    <div class="suitor" style="cursor: default; margin: 0;">
        <div class="suitor-avatar-wrapper">${avatarContent}</div>
        <div class="suitor-details" style="text-align: left;">
            <div class="suitor-name">${npc.name}</div>
            <div class="suitor-desc">${npc.title || '身世不凡'}</div>
            <div class="suitor-stats">
                <span class="stat"><i class="fas fa-home"></i> 家世: ${npc.attributes.family}</span>
                <span class="stat"><i class="fas fa-grin-stars"></i> 魅力: ${npc.attributes.charm}</span>
                <span class="stat"><i class="fas fa-pencil-alt"></i> 才情: ${npc.attributes.talent}</span>
                <span class="stat"><i class="fas fa-lightbulb"></i> 智慧: ${npc.attributes.wisdom}</span>
            </div>
        </div>
    </div>`;
}

function confirmMarriageChoice(npcId, cost) {
    if (gameState.finances.wealth < cost) {
        showToast("你的财富不足以支付媒人费用。");
        return;
    }
    applyEffects({ wealth: -cost });
    marrySuitor(npcId);
}

// ------------------- 纳妾选择功能 -------------------
function initiateConcubineSelection() {
    const financialTier = gameState.finances.financialTier || 1;
    if (financialTier < 5) {
        showEventCard('条件不足', 'fa-times-circle', '你的财力尚未达到“豪门巨富”，无法支撑纳妾的开销，此事暂且作罢。');
        return;
    }
    if(gameState.marriage.concubines.length >= 5) {
        showToast("妾室名额已满。"); return;
    }
    askWifeForConcubineApproval();
}

function askWifeForConcubineApproval() {
    if (!gameState.marriage.isMarried) {
         showToast("你需先有正妻，方可纳妾。");
         return;
    }
    const wife = gameState.npcs[gameState.marriage.spouseId];
    if (!wife) return;

    const options = [
        {
            htmlContent: `<i class="fas fa-comments"></i> 好言相商`,
            callback: () => {
                const successChance = 0.3 + (wife.favor / 200) + (gameState.player.attributes.charm / 300);
                if (Math.random() < successChance) {
                    showEventCard('正妻应允', 'fa-check-circle', '在你的劝说下，正妻点头应允了此事。');
                    showConcubineCandidates();
                } else {
                    applyEffects({ relationship: { targetId: wife.id, favor: -15 } });
                    showEventCard('后院起火', 'fa-fire', '正妻闻言大怒，坚决不同意你纳妾！你们大吵一架，恩爱值下降。');
                }
            }
        },
        {
            htmlContent: `<i class="fas fa-times"></i> 作罢`,
            callback: () => closeAllOverlays()
        }
    ];

    showDecisionCard('商议纳妾', 'fa-users', '纳妾之事，需先与正妻商议。', options);
}

function showConcubineCandidates() {
    const cost = 15000; // 昂贵的费用
    if (gameState.finances.wealth < cost) {
        showEventCard('财力不足', 'fa-coins', `纳妾需花费 <span class="value">${cost}</span> 两，你的财力不足。`);
        return;
    }
    
    const candidates = [];
    for (let i = 0; i < 3; i++) {
        const bg = getRandomElement(ladyBackgrounds);
        const npc = generateNPC({
            gender: 'female',
            age: getRandomInt(gameState.player.age - 5, gameState.player.age),
            favor: 20,
            attributes: { ...bg.attributes, family: bg.family },
            title: bg.desc
        });
        candidates.push(npc);
    }
    
    let optionsHTML = candidates.map(npc => {
        return {
            htmlContent: renderMarriageCandidateCard(npc),
            style: `padding: 10px; height: auto; display: block;`,
            callback: () => confirmConcubineChoice(npc.id, cost)
        }
    });

    showDecisionCard(
        '遴选妾室',
        'fa-user-plus',
        `你花费 <span class="value">${cost}</span> 两，请媒人为你寻来了三位合适的女子，请选择一位纳入后宅：`,
        optionsHTML
    );
}

function confirmConcubineChoice(npcId, cost) {
    if (gameState.finances.wealth < cost) {
        showToast("你的财富不足以支付费用。");
        return;
    }
    applyEffects({ wealth: -cost });
    acquireConcubine(npcId);
}
// =======================================================================
// ========================== SAVE/LOAD & DEBUG ==========================
// =======================================================================
function autoSaveGame() {
    try {
        localStorage.setItem(SAVE_SLOT_KEY_PREFIX + 'auto', JSON.stringify(gameState));
    } catch(e) { console.error("Auto-save failed", e); }
}
function showSaveLoadOverlay(isSaving) {
    document.getElementById('saveLoadHeader').innerText = isSaving ? '选择存档位置' : '选择读档文件';
    const contentEl = document.getElementById('saveLoadContent');
    contentEl.innerHTML = '';
    for (let i = 1; i <= TOTAL_SAVE_SLOTS; i++) {
        const slotData = localStorage.getItem(SAVE_SLOT_KEY_PREFIX + i);
        let slotHTML = '';
        if (slotData) {
            try {
                const data = JSON.parse(slotData);
                slotHTML = ` <div class="save-slot" onclick="${isSaving ?`saveGame(${i})`:`loadGame(${i})`}"> <div class="slot-info"> <div class="slot-title">存档 ${i}</div> <div class="slot-details">${data.player.name} | ${Math.floor(data.player.age)}岁 | 财富: ${formatNumber(data.finances.wealth)}</div> </div> <div class="slot-actions"><button onclick="event.stopPropagation(); deleteSave(${i})"><i class="fas fa-trash-alt"></i></button></div> </div>`;
            } catch(e) { slotHTML = `<div class="save-slot empty">存档 ${i} [损坏]</div>`; }
        } else {
            slotHTML = ` <div class="save-slot empty" onclick="${isSaving ?`saveGame(${i})` : ''}"> <div class="slot-info"><div class="slot-title">存档 ${i}</div><div class="slot-details">[ 空 ]</div></div> </div> `;
        }
        contentEl.innerHTML += slotHTML;
    }
    showOverlay('saveLoadOverlay');
}
function saveGame(slot) {
    if (confirm(`确定要覆盖存档 ${slot} 吗？`)) {
        try {
            // Convert Set to Array before saving
            const serializableGameState = { ...gameState, flags: { ...gameState.flags, allNames: Array.from(gameState.flags.allNames) } };
            localStorage.setItem(SAVE_SLOT_KEY_PREFIX + slot, JSON.stringify(serializableGameState));
            showToast(`游戏已成功保存至存档 ${slot}。`);
            closeAllOverlays();
        } catch (e) {
            showToast("存档失败，可能是存储空间已满。");
            console.error("Save failed: ", e);
        }
    }
}
function loadGame(slot, isAuto = false) {
    const saveData = localStorage.getItem(SAVE_SLOT_KEY_PREFIX + slot);
    if (saveData) {
        let loadedData;
        try {
            loadedData = JSON.parse(saveData);
            
            // [新增] 核心安全检查：验证存档文件的基本结构
            if (!loadedData || typeof loadedData.player === 'undefined' || typeof loadedData.flags === 'undefined') {
                // 如果存档缺少关键部分（如player对象），就认为它是损坏的
                throw new Error("存档文件结构不完整或已损坏。");
            }
            
            gameState = loadedData; // 验证通过后，才赋值给全局 gameState
            
            // 保留所有原有功能：重新生成Set，初始化系统
            gameState.flags.allNames = new Set(Array.from(gameState.flags.allNames || []));
            initApprenticeSystem(); 
            
            showToast(`已成功读取${isAuto ? '自动' :  `存档 ${slot}`}。`);
            closeAllOverlays();
            renderGame();

        } catch(e) {
            console.error("读取存档时出错:", e); // 在控制台打印详细错误，方便调试
            showToast("读取失败，存档文件可能已损坏，已自动清理。");
            localStorage.removeItem(SAVE_SLOT_KEY_PREFIX + slot); // 删除损坏的存档
            
            // [新增] 如果是自动存档读取失败，则引导玩家重新开始，避免卡住
            if (isAuto) {
                closeAllOverlays();
                document.getElementById('loadingOverlay').style.display = 'none';
                showOverlay('genderSelectionOverlay');
            }
        }
    } else { 
        showToast("读取失败，存档为空。"); 
        
        // [新增] 如果是自动存档为空，也直接进入新游戏流程
        if (isAuto) {
            closeAllOverlays();
            document.getElementById('loadingOverlay').style.display = 'none';
            showOverlay('genderSelectionOverlay');
        }
    }
}function deleteSave(slot) {
    if (confirm(`确定要删除存档 ${slot} 吗？此操作不可逆！`)) {
        localStorage.removeItem(SAVE_SLOT_KEY_PREFIX + slot);
        showToast(`存档 ${slot} 已删除。`);
        showSaveLoadOverlay(false);
    }
}

function handleAvatarClick() {
    const now = Date.now();
    if (now - lastAvatarClickTime < 300) avatarClickCount++;
    else avatarClickCount = 1;
    lastAvatarClickTime = now;
    if (avatarClickCount >= 5) {
        avatarClickCount = 0;
        const password = prompt("请输入密码：");
        if(password === "HQL") showDebugOverlay();
        else {if(password) showToast("密码错误。");}
    }
}	
/**
 * [新增] 开发者模式：为当前人生应用所有“承世书”中的天赋
 */
function debug_applyAllTalents(isSilent = false) {
    if (!isSilent && !confirm("确定要为当前人生应用所有天赋吗？")) {
        return;
    }

    let effects = { attributes: {}, flags: {}, items: [], bonuses: {} };
    const baseAttrPoints = 100; // 默认给每个基础属性加100点

    // 1. 遍历并合并所有天赋效果
    for (const branchKey in INHERITANCE_TALENT_TREE) {
        INHERITANCE_TALENT_TREE[branchKey].tiers.forEach(talent => {
            if (talent.isAttribute) {
                Object.keys(ATTR_MAP).forEach(attrKey => {
                    if (gameState.player.attributes.hasOwnProperty(attrKey)) {
                       effects.attributes[attrKey] = (effects.attributes[attrKey] || 0) + baseAttrPoints;
                    }
                });
            } else {
                Object.assign(effects.attributes, talent.effects.attributes || {});
                Object.assign(effects.flags, talent.effects.flags || {});
                if (talent.id === 'jiaxue') effects.bonuses.careerLevelBonus = 1;
                if (talent.id === 'yichan') effects.bonuses.wealthMultiplier = (effects.bonuses.wealthMultiplier || 0) + 0.02;
            }
        });
    }

    // 2. 应用效果到当前游戏
    applyEffects({ attributes: effects.attributes });
    Object.assign(gameState.flags, effects.flags);

    // 3. 处理特殊加成
    if (effects.bonuses.careerLevelBonus && gameState.career.path) {
        gameState.career.level = Math.min(gameState.career.level + 1, careerPaths[gameState.player.gender][gameState.career.path].levels.length - 1);
    }

    if (!isSilent) {
        showToast("所有天赋已应用至当前人生！");
        closeAllOverlays();
        renderGame();
    }
}
function showDebugOverlay() {
    // 玩家职业信息
    const paths = careerPaths[gameState.player.gender];
    let careerOptions = `<option value="">无职业</option>`;
    Object.keys(paths).forEach(id => {
        careerOptions += `<option value="${id}" ${gameState.career.path === id ? 'selected': ''}>${paths[id].name}</option>`;
    });
    let levelOptions = '';
    if(gameState.career.path) {
        paths[gameState.career.path].levels.forEach((level, index) => {
            levelOptions += `<option value="${index}" ${gameState.career.level === index ? 'selected':''}>${level.title}</option>`;
        });
    }

    // NPC 好感度选项
    let npcOptions = Object.values(gameState.npcs).filter(n => n.id !== 'player' && n.name).map(npc => `<option value="${npc.id}">${npc.name}</option>`).join('');

    // 徒弟属性选项
    let apprenticeOptions = gameState.apprentices.map(app => `<option value="${app.id}">${app.name}</option>`).join('');

    // 商会商品选项
    let goodsOptions = Object.keys(TRADING_GOODS_DATA).map(id => `<option value="${id}">${TRADING_GOODS_DATA[id].name}</option>`).join('');

    // 孩子属性选项
    let childOptions = gameState.children.filter(c => c && !c.isDead).map(child => `<option value="${child.id}">${child.name}</option>`).join('');

    document.getElementById('debugContent').innerHTML = `
    <div class="input-group" style="max-height:60vh; overflow-y:auto; padding-right: 10px;">
        <div class="section-header">快捷设置</div>
        <div class="controls" style="flex-direction: column;">
             <button class="control-btn" style="background: #c0392b;" onclick="setPreset('female')">女神开局 (女)</button>
             <button class="control-btn" style="background: #2980b9;" onclick="setPreset('male')">天神开局 (男)</button>
             <button class="control-btn" style="background: #8e44ad;" onclick="debug_generateAllEvidence()">一键生成两位妾室的关键证据</button>
             <button class="control-btn" style="background: #27ae60;" onclick="debug_applyAllTalents()">应用所有天赋 (当前人生)</button>
             <button class="control-btn" style="background: #f39c12;" onclick="toggleUnlimitedActions()">切换无限行动点</button>
             <button class="control-btn" style="background: #7f8c8d;" onclick="skipTurns(20)">跳过10年 (快速结束人生)</button>
        </div>
        <div class="section-header">玩家属性</div>
        <p>姓名: <input type="text" id="debug_name" value="${gameState.player.name}"></p>
        <p>年龄: <input type="number" id="debug_age" value="${gameState.player.age}"></p>
        <p>财富: <input type="number" id="debug_wealth" value="${gameState.finances.wealth}"></p>
        <p>健康: <input type="number" id="debug_health" value="${gameState.player.health}"></p>
        ${Object.keys(ATTR_MAP).map(attr => `<p>${ATTR_MAP[attr]}: <input type="number" id="debug_${attr}" value="${gameState.player.attributes[attr]||0}"></p>`).join('')}

        <div class="section-header">玩家职业</div>
        <p>职业: <select id="debug_career">${careerOptions}</select></p>
        <p>等级: <select id="debug_career_level">${levelOptions}</select></p>
        <p>职业业绩: <input type="number" id="debug_career_performance" value="${gameState.career.performance || 0}"></p>

        <div class="section-header">内府/婚姻</div>
        <p>掌家权进度: <input type="number" id="debug_authority_progress" value="${gameState.marriage.householdAuthority.progress || 0}"></p>

        <div class="section-header">孩子属性</div>
        <p><select id="debug_child_select">${childOptions}</select></p>
        <p>年龄: <input type="number" id="debug_child_age" placeholder="输入孩子年龄"></p>
        ${Object.keys(ATTR_MAP).map(attr => `<p>${ATTR_MAP[attr]}: <input type="number" id="debug_child_${attr}" placeholder="输入${ATTR_MAP[attr]}值"></p>`).join('')}

        <div class="section-header">NPC 好感度</div>
        <p><select id="debug_npc_select">${npcOptions}</select> 好感: <input type="number" id="debug_npc_favor" placeholder="输入好感值"></p>

        <div class="section-header">徒弟属性</div>
        <p><select id="debug_apprentice_select">${apprenticeOptions}</select></p>
        ${Object.keys(ATTR_MAP).map(attr => `<p>${ATTR_MAP[attr]}: <input type="number" id="debug_apprentice_${attr}" placeholder="输入属性值"></p>`).join('')}

        <div class="section-header">商会数据</div>
        <p>钱柜资金: <input type="number" id="debug_trade_money" value="${gameState.tradingSystem.moneyChest}"></p>
        <p>仓库容量: <input type="number" id="debug_trade_capacity" value="${gameState.tradingSystem.warehouseCapacity}"></p>
        <p>商品价格: <select id="debug_good_select">${goodsOptions}</select> 价格: <input type="number" id="debug_good_price" placeholder="输入新价格"></p>
    </div>
    `;
    showOverlay('debugOverlay');
}
/**
 * [新增] 开发者模式：一键设置天神/女神开局
 */
function setPreset(presetType) {
    if (!confirm(`【警告】\n此操作将立即放弃当前人生，并开启一个全新的【${presetType === 'male' ? '天神' : '女神'}】人生！\n\n确定要继续吗？`)) {
        return;
    }

    // 1. 构建一个完美的“继承数据包”
    let perfectAttributes = {};
    Object.keys(ATTR_MAP).forEach(attrKey => {
        perfectAttributes[attrKey] = 999;
    });

    let allTalentEffects = { attributes: {}, flags: {}, items: [], bonuses: {} };
    for (const branchKey in INHERITANCE_TALENT_TREE) {
        INHERITANCE_TALENT_TREE[branchKey].tiers.forEach(talent => {
            if (talent.effects) {
                Object.assign(allTalentEffects.attributes, talent.effects.attributes || {});
                Object.assign(allTalentEffects.flags, talent.effects.flags || {});
                if(talent.id === 'yichan') {
                    allTalentEffects.bonuses.wealthMultiplier = (allTalentEffects.bonuses.wealthMultiplier || 0) + 0.02;
                }
            }
        });
    }

    const inheritanceData = {
        name: presetType === 'male' ? '天神' : '女神', // 名字
        age: 16, // 年龄
        avatar: getRandomElement(avatarPools[presetType]), // 随机一个头像
        baseAttributes: perfectAttributes, // 基础属性999
        effects: allTalentEffects, // 所有天赋效果
        previousCareerPath: null,
        previousWealth: 100000000 // 财富1亿
    };

    // 2. 调用开启新游戏的函数，并传入这个完美的数据包
    // 第三个参数 options 用于覆盖默认的开局年龄
    startNewGame(presetType, inheritanceData, { startAge: 16 });
}
function debug_generateAllEvidence() {
    const husband = gameState.npcs[gameState.marriage.spouseId];
    if (!husband || !husband.concubines || husband.concubines.length === 0) {
        showToast("错误：夫君不存在或尚无妾室。");
        return;
    }
    
    const concubines = husband.concubines.map(id => gameState.npcs[id]).filter(c => c && !c.isDead);
    if (concubines.length === 0) {
        showToast("没有妾室可以生成证据。");
        return;
    }

    let names = [];
    concubines.forEach((conc, index) => {
        // 1. 设置UI显示属性
        conc.keyEvidence = '罪证确凿，已整理成册 (由开发者模式生成)';
        names.push(conc.name);
        
        // 2. 【核心修复】同时设置后台逻辑标记！
        // 默认将标记指向第一个被处理的妾室
        if (index === 0) {
            gameState.flags.hasConcubineEvidence = conc.id;
        }
    });

    showToast(`已为 ${names.join(' 和 ')} 生成了关键罪证！`);
    
    // 3. 【核心修复】生成证据后，立刻调用检查机制刷新按钮！
    updateExpelButtonState();
    closeAllOverlays();
    renderGame();
}
// [新增]
function skipTurns(numberOfTurns) {
    if (isProcessing) return;
    
    if (!confirm(`确定要跳过 ${numberOfTurns} 个回合吗？游戏将自动处理所有事件，这可能需要一些时间。`)) {
        return;
    }

    closeAllOverlays();
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.style.display = 'flex';
    loadingText.innerText = '光阴似箭，岁月如梭...';

    isProcessing = true;
    gameState.flags.isBatchProcessing = true; // 设置一个全局标志，让弹窗函数知道不要显示UI

    let turnsSkipped = 0;

    function processSingleTurn() {
        if (turnsSkipped >= numberOfTurns) {
            // 所有回合处理完毕
            gameState.flags.isBatchProcessing = false;
            isProcessing = false;
            loadingOverlay.style.display = 'none';
            showToast(`成功跳过了 ${numberOfTurns} 个回合！`);
            renderGame(); // 最后刷新一次游戏界面
            return;
        }

        // 调用你游戏中已有的下一回合函数
        // 这个函数包含了所有游戏逻辑，如时间推进、属性变化、事件等
        nextTurn();

        turnsSkipped++;
        loadingText.innerText = `光阴似箭... 正在处理第 ${turnsSkipped} / ${numberOfTurns} 回合`;

        // 使用 setTimeout 创建一个微小的延迟，以防止浏览器因密集计算而卡死，并允许UI更新
        setTimeout(processSingleTurn, 50); 
    }

    processSingleTurn();
}

function applyDebugChanges() {
    // 玩家属性
    gameState.player.name = document.getElementById('debug_name').value;
    gameState.player.age = parseFloat(document.getElementById('debug_age').value);
    gameState.finances.wealth = parseInt(document.getElementById('debug_wealth').value);
    gameState.player.health = parseInt(document.getElementById('debug_health').value);
    Object.keys(ATTR_MAP).forEach(attr => {
        const input = document.getElementById(`debug_${attr}`);
        if(input) gameState.player.attributes[attr] = parseInt(input.value);
    });

    // 玩家职业
    const careerPathValue = document.getElementById('debug_career').value;
    gameState.career.path = careerPathValue === "" ? null : careerPathValue;
    gameState.career.level = document.getElementById('debug_career_level').value !== '' ? parseInt(document.getElementById('debug_career_level').value) : -1;
    gameState.career.performance = parseInt(document.getElementById('debug_career_performance').value);

    // 内府/婚姻
    gameState.marriage.householdAuthority.progress = parseInt(document.getElementById('debug_authority_progress').value);

    // NPC 好感度
    const npcId = document.getElementById('debug_npc_select').value;
    const npcFavor = parseInt(document.getElementById('debug_npc_favor').value);
    if (npcId && !isNaN(npcFavor) && gameState.npcs[npcId]) {
        gameState.npcs[npcId].favor = npcFavor;
        // 如果是配偶，同步更新婚姻里的好感度
        if (gameState.marriage.spouseId === npcId) {
            gameState.marriage.favor = npcFavor;
        }
    }

    // 孩子属性
    const childId = document.getElementById('debug_child_select').value;
    if (childId) {
        const child = gameState.children.find(c => c.id === childId);
        if (child) {
            const childAgeInput = document.getElementById('debug_child_age');
            if (childAgeInput && childAgeInput.value !== '') {
                child.age = parseFloat(childAgeInput.value);
            }
            Object.keys(ATTR_MAP).forEach(attr => {
                const input = document.getElementById(`debug_child_${attr}`);
                if (input && input.value !== '') {
                    child.attributes[attr] = parseInt(input.value);
                }
            });
        }
    }

    // 徒弟属性
    const apprenticeId = document.getElementById('debug_apprentice_select').value;
    if (apprenticeId) {
        const apprentice = gameState.apprentices.find(a => a.id === apprenticeId);
        if (apprentice) {
            Object.keys(ATTR_MAP).forEach(attr => {
                const input = document.getElementById(`debug_apprentice_${attr}`);
                if (input && input.value !== '') {
                    apprentice.attributes[attr] = parseInt(input.value);
                }
            });
        }
    }

    // 商会数据
    gameState.tradingSystem.moneyChest = parseInt(document.getElementById('debug_trade_money').value);
    gameState.tradingSystem.warehouseCapacity = parseInt(document.getElementById('debug_trade_capacity').value);
    const goodId = document.getElementById('debug_good_select').value;
    const goodPrice = parseInt(document.getElementById('debug_good_price').value);
    if (goodId && !isNaN(goodPrice)) {
        gameState.tradingSystem.marketStatus.prices[goodId] = goodPrice;
    }

    showToast("属性修改成功！");
    closeAllOverlays();
    renderGame();
}
// =======================================================================
// ============================= RANKINGS ================================
// =======================================================================
function updateRankings() {
    let playerRankScore = Object.values(gameState.player.attributes).reduce((a, b) => a + b, 0);
    playerRankScore += gameState.family.reputation * 2 + gameState.finances.wealth / 100;

    if (!gameState.rankings.list || gameState.rankings.list.length < 10 || gameState.date.turn === 1) {
        let rankingList = [];
         for(let i=0; i<10; i++) {
            const score = Math.floor(playerRankScore * (0.9 + Math.random()*0.4));
            rankingList.push({name: generateRandomName(gameState.player.gender, new Set()), score: score});
        }
        gameState.rankings.list = rankingList;
    } else {
        gameState.rankings.list.forEach(npc => {
            if (!npc.isPlayer) {
                const fluctuation = (Math.random() - 0.5) * (npc.score * 0.05);
                npc.score = Math.max(0, Math.floor(npc.score + fluctuation));
            }
        });
    }

    const playerEntry = {name: gameState.player.name, score: Math.floor(playerRankScore), isPlayer: true};
    let combinedList = [...gameState.rankings.list.filter(r => !r.isPlayer), playerEntry];
    combinedList.sort((a,b) => b.score - a.score);
    
    gameState.rankings.list = combinedList.slice(0, 10);
    const playerRank = combinedList.findIndex(r => r.isPlayer) + 1;
    gameState.rankings.playerRank = playerRank;

    // 【修改】每年年底结算奖励
    if (gameState.date.turn === 2 && !gameState.flags.annualRankingRewardGiven) {
        let reward = null;
        if (playerRank === 1) {
            reward = { reputation: 20, wealth: 1000, title: '榜首' };
        } else if (playerRank === 2) {
            reward = { reputation: 10, wealth: 500, title: '榜眼' };
        } else if (playerRank === 3) {
            reward = { reputation: 5, wealth: 300, title: '探花' };
        }

        if (reward) {
            gameState.flags.annualRankingRewardGiven = true;
            applyEffects({ reputation: reward.reputation, wealth: reward.wealth });
            const logText = `你在今年的京城${gameState.player.gender === 'male' ? "才俊" : "贵女"}榜中荣登<strong class="value">${reward.title}</strong>之位！获得奖励：声望+${reward.reputation}，财富+${reward.wealth}两。`;
            
            // 【新增的核心代码】将奖励信息写入记事本
            logEvent(logText);

            // 保留原有的弹窗提示逻辑
            eventQueue.push(() => {
                showEventCard('年度殊荣', 'fa-trophy', logText);
            });
        }
    }
}
function showRankings() {
    let listHTML = gameState.rankings.list.map((item, index) => {
        const isPlayer = item.isPlayer;
        return ` <div class="ranking-item ${isPlayer ? 'player' : ''}"> <span class="rank-num">#${index + 1}</span> <span>${item.name}</span> <span>${Math.floor(item.score)}</span> </div>`
    }).join('');

    document.getElementById('rankingsHeader').innerText = `🏆 京城${gameState.player.gender === 'male' ? "才俊" : "贵女"}榜 🏆`;
    document.getElementById('rankingsContent').innerHTML = listHTML;
    showOverlay('rankingsOverlay');
}

function isRequirementMet(reqObject) {
    if (!reqObject) return true;

    for (const key in reqObject) {
        const requiredValue = reqObject[key];
        let playerValue = 0;

        if (key === 'reputation') {
            playerValue = gameState.family.reputation || 0;
        } else {
            playerValue = gameState.player.attributes[key] || 0;
        }

        if (playerValue < requiredValue) {
            return false;
        }
    }
    
    return true;
}


   // 【检查并添加】拖拽功能所需的辅助函数
function allowDrop(ev) { 
    ev.preventDefault(); 
}

function drag(ev) { 
    ev.dataTransfer.setData("text", ev.target.textContent); 
}

function drop(ev, targetElement) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    if (targetElement && !targetElement.classList.contains('filled')) {
        targetElement.textContent = data;
        targetElement.classList.add('filled');
    }
}
      // =======================================================================
// ======================= 产业投资（新版经营界面）=========================
// =======================================================================

function showInvestmentDetails(instanceId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    if (!investment) return;
    
    const type = merchantInvestmentData.types.find(t => t.id === investment.typeId);
    const currentLevel = type.levels[investment.level];
    const nextLevel = type.levels[investment.level + 1];

    let options = [];

    // 1. 升级店铺选项
    if (nextLevel) {
        options.push({
            htmlContent: `<i class="fas fa-arrow-up"></i><span class="option-text"><strong>升级为 ${nextLevel.name}</strong><div><small>成本: ${nextLevel.upgrade_cost} 两</small></div></span>`,
            disabled: gameState.finances.wealth < nextLevel.upgrade_cost,
            callback: () => upgradeInvestment(instanceId)
        });
    }

    // 2. 更换掌柜选项
    options.push({
        htmlContent: `<i class="fas fa-user-cog"></i><span class="option-text"><strong>更换掌柜</strong><div><small>当前: ${merchantInvestmentData.managers.find(m => m.id === investment.managerId).name}</small></div></span>`,
        callback: () => showManagerSelection(instanceId)
    });

    // 3. 调整经营方针选项
    options.push({
        htmlContent: `<i class="fas fa-scroll"></i><span class="option-text"><strong>调整经营方针</strong><div><small>当前: ${merchantInvestmentData.strategies.find(s => s.id === investment.strategy).name}</small></div></span>`,
        callback: () => showStrategySelection(instanceId)
    });
    
    // 4. 变卖产业选项
    const sellPrice = Math.floor(currentLevel.cost * (0.8 + Math.random() * 0.4));
    options.push({
        htmlContent: `<i class="fas fa-dollar-sign"></i><span class="option-text"><strong>变卖产业</strong><div><small>预计可得: ${sellPrice} 两</small></div></span>`,
        style: `background:linear-gradient(135deg, #e74c3c, #c0392b);`,
        callback: () => sellInvestment(instanceId, sellPrice)
    });
    
    let content = `<p>管理你的 <strong class="value">${currentLevel.name}</strong>。</p>`;
    showDecisionCard(`经营 ${currentLevel.name}`, "fa-store", content, options);
}

function upgradeInvestment(instanceId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    const type = merchantInvestmentData.types.find(t => t.id === investment.typeId);
    const nextLevel = type.levels[investment.level + 1];

    if (gameState.finances.wealth < nextLevel.upgrade_cost) {
        showToast("资金不足以升级。");
        return;
    }
    
    applyEffects({ wealth: -nextLevel.upgrade_cost, reputation: 10 });
    investment.level++;
    
    showEventCard('产业升级', 'fa-arrow-up', `你花费巨资将店铺升级为 <strong class="value">${type.levels[investment.level].name}</strong>，声名远扬！`);
    showInvestmentDashboard();
}

function showManagerSelection(instanceId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    let options = merchantInvestmentData.managers.map(manager => {
        return {
            htmlContent: `<i class="fas fa-user-tie"></i><span class="option-text"><strong>${manager.name}</strong><div><small>薪酬: ${manager.salary} 两/年</small></div></span>`,
            disabled: investment.managerId === manager.id,
            callback: () => changeManager(instanceId, manager.id)
        };
    });
     showDecisionCard('招聘掌柜', 'fa-users', '慧眼识人，方能财源滚滚。', options);
}

function changeManager(instanceId, managerId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    investment.managerId = managerId;
    const managerName = merchantInvestmentData.managers.find(m=>m.id === managerId).name;
    showEventCard('更换掌柜', 'fa-user-cog', `你为店铺更换了掌柜，新任的是 <strong class="value">${managerName}</strong>。`);
    showInvestmentDashboard();
}

function showStrategySelection(instanceId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    let options = merchantInvestmentData.strategies.map(strategy => {
        const canAfford = !strategy.cost || gameState.finances.wealth >= strategy.cost;
        return {
            htmlContent: `<i class="fas fa-compass"></i><span class="option-text"><strong>${strategy.name}</strong><div><small>${strategy.desc}${strategy.cost ? `(-${strategy.cost}两)` : ''}</small></div></span>`,
            disabled: investment.strategy === strategy.id || !canAfford,
            callback: () => changeStrategy(instanceId, strategy.id)
        };
    });
    showDecisionCard('调整方针', 'fa-scroll', '审时度势，方能立于不败之地。', options);
}

function changeStrategy(instanceId, strategyId) {
    const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
    investment.strategy = strategyId;
    const strategyName = merchantInvestmentData.strategies.find(s=>s.id === strategyId).name;
    showEventCard('调整方针', 'fa-scroll', `你将店铺的经营方针调整为“<strong class="value">${strategyName}</strong>”。`);
    showInvestmentDashboard();
}

function sellInvestment(instanceId, sellPrice) {
    if (confirm("确定要变卖这份产业吗？此操作不可逆。")) {
        const investment = gameState.merchant.investments.find(i => i.instanceId === instanceId);
        if (!investment) return;
        const type = merchantInvestmentData.types.find(t => t.id === investment.typeId);
        const currentLevel = type.levels[investment.level];
        const investmentName = currentLevel.name;

        gameState.merchant.investments = gameState.merchant.investments.filter(i => i.instanceId !== instanceId);
        applyEffects({ wealth: sellPrice });
        
        const logText = `你成功变卖了产业 <strong class="value">${investmentName}</strong>，获得资金 <span class="value">${sellPrice}</span> 两。`;
        
        // 【新增的核心代码】将变卖产业的收入写入记事本
        logEvent(logText);

        showEventCard('变卖产业', 'fa-dollar-sign', logText);
        showInvestmentDashboard();
    }
}
// =======================================================================
// =====================  【新功能代码】 物品管理核心函数 START  =========================
/**
 * 检查物品栏中是否存在指定物品
 * @param {string} itemId - 物品的ID
 * @returns {boolean} - 是否拥有该物品
 */
function hasItemInInventory(itemId) {
    if (!gameState.inventory) return false;
    return gameState.inventory.some(item => item.id === itemId && item.amount > 0);
}

/**
 * 向物品栏添加物品（处理堆叠）
 * @param {string} itemId - 物品的ID
 * @param {number} amount - 添加的数量
 * @param {object} itemData - 物品的详细数据（仅在首次添加时需要）
 */
function addItemToInventory(itemId, amount = 1, itemData = null) {
    if (!gameState.inventory) gameState.inventory = [];
    
    const existingItem = gameState.inventory.find(i => i.id === itemId);

    if (existingItem) {
        existingItem.amount += amount;
    } else {
        // 如果ITEM_DATA里没有，就用传入的itemData（主要用于信物材料）
        if (!ITEM_DATA[itemId] && itemData) {
            ITEM_DATA[itemId] = itemData;
        }
        gameState.inventory.push({ id: itemId, amount: amount, instanceId: `item_${Date.now()}` });
    }
}

/**
 * 从物品栏移除物品
 * @param {string} itemId - 物品的ID
 * @param {number} amount - 移除的数量
 * @param {string} instanceId - [可选] 如果提供了，则精确移除该实例
 * @returns {boolean} - 是否移除成功
 */
function removeItemFromInventory(itemId, amount = 1, instanceId = null) {
    if (!gameState.inventory) return false;

    // 优先使用 instanceId 精确查找
    if (instanceId) {
         const itemIndex = gameState.inventory.findIndex(i => i.instanceId === instanceId);
         if (itemIndex > -1) {
             gameState.inventory.splice(itemIndex, 1);
             return true;
         }
    }

    // 如果没有 instanceId 或没找到，则按 itemId 查找
    const item = gameState.inventory.find(i => i.id === itemId);
    if (item && item.amount >= amount) {
        item.amount -= amount;
        if (item.amount <= 0) {
            gameState.inventory = gameState.inventory.filter(i => i.id !== itemId);
        }
        return true;
    }

    return false;
}
// [用这个替换掉原来的 renderInventoryTab 函数]
function renderInventoryTab() {
    // 兼容旧存档，gameState.inventory 是新的，gameState.career.inventory 是旧的
    let inventory = gameState.inventory || gameState.career.inventory;
    if (!inventory) inventory = [];

    if (inventory.length === 0) {
        return `<p class="comment" style="text-align:center;">你的行囊空空如也。</p>`;
    }

    let html = '<div class="inventory-container">';
    inventory.forEach((itemInstance, index) => {
        // 为每个物品实例生成一个唯一的ID，用于精确删除
        itemInstance.instanceId = itemInstance.instanceId || `item_${Date.now()}_${index}`;
        const itemDef = ITEM_DATA[itemInstance.id];

        if (itemDef) {
            let useButtonHTML = '';
            // 如果物品定义了 performance_boost，则显示“使用”按钮
            if (itemDef.performance_boost) {
                useButtonHTML = `<button class="control-btn" style="padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;" 
                                    onclick="useInventoryItemForCareer('${itemInstance.id}', '${itemInstance.instanceId}')">
                                 <i class="fas fa-arrow-up"></i> 使用
                               </button>`;
            }

            html += `
            <div class="inventory-item">
                <div class="inventory-item-icon"><i class="fas ${itemDef.icon || 'fa-question-circle'}"></i></div>
                <div class="inventory-item-details">
                    <div class="inventory-item-name">
                        ${itemDef.name} 
                        <span class="inventory-item-type">${itemDef.type}</span>
                        ${itemInstance.amount > 1 ? ` (x${itemInstance.amount})` : ''}
                    </div>
                    <div class="inventory-item-desc">${itemDef.desc}</div>
                </div>
                ${useButtonHTML}
            </div>`;
        }
    });
    html += '</div>';

    return html;
}
function addItemToInventory(itemId, amount = 1) {
    if (!ITEM_DATA[itemId]) {
        console.error(`尝试添加不存在的物品: ${itemId}`);
        return;
    }

    const existingItem = gameState.inventory.find(i => i.id === itemId);

    if (existingItem) {
        existingItem.amount += amount;
    } else {
        gameState.inventory.push({ id: itemId, amount: amount });
    }
    
    const itemDef = ITEM_DATA[itemId];
    showToast(`获得物品：${itemDef.name} x${amount}`);
    logEvent(`你获得了物品：<strong class="value">${itemDef.name}</strong> x${amount}。`);
}


// --- 新增: 职业系统核心逻辑 ---
function triggerProfessionEvent() {
    const c = gameState.career;
    if (!c.path) return;
    if (gameState.flags.actionUsed_work >= 2) {
        showToast("本回合公务处理次数已用尽");
        return;
    }
    gameState.flags.actionUsed_work++;
    
    // 获取当前职业的事件数据
    const professionData = PROFESSION_DATA[c.path];
    const currentAct = professionData.acts[c.currentAct];
    if (!currentAct || !currentAct.events.length) {
        showEventCard("暂无公务", "fa-file-alt", "当前阶段暂无公务可处理，可尝试其他操作");
        return;
    }
    
    // 随机选择一个事件
    const randomEvent = getRandomElement(currentAct.events);
    let eventHTML = `<p>${randomEvent.desc}</p>`;
    let optionsHTML = [];
    
    // 生成事件选项
    randomEvent.options.forEach((opt, index) => {
        // 检查选项是否满足条件
        let canSelect = true;
        let reqText = "";
        if (opt.requirements) {
            reqText = Object.entries(opt.requirements).map(([attr, val]) => {
                const playerVal = gameState.player.attributes[attr] || 0;
                if (playerVal < val) canSelect = false;
                return `${ATTR_MAP[attr] || attr}≥${val}`;
            }).join("，");
        }
        
        optionsHTML.push({
            htmlContent: `<span class="option-text">${opt.text}${reqText ? `<div><small>要求：${reqText}</small></div>` : ""}</span>`,
            disabled: !canSelect,
            callback: () => handleProfessionEventResult(randomEvent, index)
        });
    });
    
    // 显示事件弹窗
    showDecisionCard(randomEvent.title, "fa-scroll", eventHTML, optionsHTML);
}
// =======================================================================
// ===================== 【替换】古筝小游戏核心逻辑 (v3 音乐+曲目版) ======
// =======================================================================

// [新增] 曲目数据
const SONG_DATA = {
    'fengqiuhaung': {
        name: '凤求凰',
        difficulty: '简单',
        noteCount: 20,
        noteSpeed: 4.5, // 秒
        noteInterval: [800, 1300], // ms
        bgmId: 'bgm-fengqiuhaung'
    },
    'gaoshan': {
        name: '高山流水',
        difficulty: '普通',
        noteCount: 30,
        noteSpeed: 4.0,
        noteInterval: [600, 1000],
        bgmId: 'bgm-gaoshanliushui'
    },
    'shimian': {
        name: '十面埋伏',
        difficulty: '困难',
        noteCount: 45,
        noteSpeed: 3.5,
        noteInterval: [400, 700],
        bgmId: 'bgm-shimianmaifu'
    }
};

/**
 * 启动古筝小游戏的总入口，现在是曲目选择界面。
 * @param {string} npcId - 互动的NPC ID
 */
function startGuzhengMiniGame(npcId) {
    let songOptions = Object.entries(SONG_DATA).map(([id, song]) => {
        return {
            htmlContent: `<i class="fas fa-music"></i><span class="option-text"><strong>${song.name}</strong><div><small>难度: ${song.difficulty}</small></div></span>`,
            callback: () => _showGuzhengRules(npcId, id)
        };
    });
    
    showDecisionCard('为君抚琴', 'fa-music', '你打算为TA弹奏哪一首曲子？', songOptions);
}

/**
 * [新增] 显示游戏规则
 */
function _showGuzhengRules(npcId, songId) {
    const song = SONG_DATA[songId];
    const rulesContent = `
        <p style="text-align: center; margin-bottom: 15px;">即将弹奏: <strong class="value">${song.name}</strong></p>
        <div style="text-align: left; line-height: 1.8;">
            <i class="fas fa-info-circle"></i> <strong>玩法说明：</strong><br>
            - 🌸花瓣会从上方沿着五条琴弦下落。<br>
            - 当花瓣进入下方发光区域时，点击对应的琴弦按钮。<br>
            - 落点越接近金色判定线，得分越高！<br>
        </div>
    `;
    const options = [
        {
            htmlContent: `<i class="fas fa-play-circle"></i> 开始弹奏`,
            callback: () => _beginGuzhengGameplay(npcId, songId)
        }
    ];
    showDecisionCard('抚琴小叙', 'fa-music', rulesContent, options);
}


/**
 * [修改] 真正开始运行小游戏的内部函数
 */
function _beginGuzhengGameplay(npcId, songId) {
    const song = SONG_DATA[songId];
    const gameContainer = document.getElementById('guzheng-game-container');
    const buttonsContainer = document.getElementById('guzheng-hit-buttons-container');
    const scoreDisplay = document.getElementById('guzheng-score-display');

    document.getElementById('guzheng-song-name').textContent = song.name;
    gameContainer.innerHTML = '<div class="guzheng-perfect-zone"></div><div class="guzheng-hit-line"></div><div id="guzheng-feedback" class="guzheng-feedback"></div>';
    buttonsContainer.innerHTML = '';
    scoreDisplay.textContent = '得分: 0';

    const NUM_STRINGS = 5;

    gameState.miniGame = {
        score: 0,
        hits: { perfect: 0, good: 0, miss: 0 }, // 用于更精确的计分
        totalNotes: song.noteCount,
        noteSpeed: song.noteSpeed,
        opponentId: npcId,
        gameRunning: true,
        strings: Array(NUM_STRINGS).fill().map(() => []),
        bgm: document.getElementById(song.bgmId)
    };

    if (gameState.miniGame.bgm) {
        gameState.miniGame.bgm.currentTime = 0;
        gameState.miniGame.bgm.play().catch(e => console.error("BGM播放失败:", e));
    }

    for (let i = 0; i < NUM_STRINGS; i++) {
        const stringEl = document.createElement('div');
        stringEl.className = 'guzheng-string';
        stringEl.id = `string-${i}`;
        gameContainer.appendChild(stringEl);

        const buttonEl = document.createElement('div');
        buttonEl.className = 'guzheng-hit-button';
        buttonEl.onmousedown = () => { handleGuzhengHit(i); buttonEl.classList.add('active'); };
        buttonEl.onmouseup = () => buttonEl.classList.remove('active');
        buttonEl.ontouchstart = (e) => { e.preventDefault(); handleGuzhengHit(i); buttonEl.classList.add('active'); };
        buttonEl.ontouchend = (e) => { e.preventDefault(); buttonEl.classList.remove('active'); };
        buttonsContainer.appendChild(buttonEl);
    }

    // 生成音符的逻辑保持不变
    for (let i = 0; i < gameState.miniGame.totalNotes; i++) {
        setTimeout(() => {
            if (!gameState.miniGame.gameRunning) return;

            const stringIndex = getRandomInt(0, NUM_STRINGS - 1);
            const stringEl = document.getElementById(`string-${stringIndex}`);

            if (stringEl) {
                const note = document.createElement('div');
                note.className = 'guzheng-note';
                note.innerHTML = '🌸';
                note.style.animationDuration = `${gameState.miniGame.noteSpeed}s`;
                note.dataset.createdAt = performance.now();

                stringEl.appendChild(note);
                gameState.miniGame.strings[stringIndex].push(note);

                setTimeout(() => {
                    if (note.parentElement) {
                        note.remove();
                        showGuzhengFeedback('错过', 'grey');
                        gameState.miniGame.hits.miss++;
                        document.getElementById('sfx-miss')?.play();
                        const notesOnString = gameState.miniGame.strings[stringIndex];
                        const noteIndex = notesOnString.indexOf(note);
                        if (noteIndex > -1) notesOnString.splice(noteIndex, 1);
                    }
                }, gameState.miniGame.noteSpeed * 1000);
            }
        }, i * getRandomInt(song.noteInterval[0], song.noteInterval[1])); 
    }

    // 【修复核心】使用独立的函数处理游戏结束，而不是将所有逻辑放在setTimeout里
    const gameDuration = (gameState.miniGame.totalNotes * song.noteInterval[1]) + (gameState.miniGame.noteSpeed * 1000);
    setTimeout(() => _endGuzhengGame(npcId), gameDuration);

    showOverlay('guzhengGameOverlay');
}

// 【新增的辅助函数】请将这个新函数粘贴到 _beginGuzhengGameplay 函数的下方
function _endGuzhengGame(npcId) {
    if (!gameState.miniGame || !gameState.miniGame.gameRunning) return;
    gameState.miniGame.gameRunning = false;
    if (gameState.miniGame.bgm) gameState.miniGame.bgm.pause();

    // 使用更精确的计分方式
    const finalScore = gameState.miniGame.hits.perfect * 2 + gameState.miniGame.hits.good * 1;
    const successRate = finalScore / (gameState.miniGame.totalNotes * 2);

    let resultText, favorChange;

    if (successRate > 0.8) {
        resultText = '你的琴声如高山流水，听者无不陶醉！';
        favorChange = getRandomInt(15, 20);
    } else if (successRate > 0.5) {
        resultText = '一曲终了，虽有瑕疵，但也颇为动听。';
        favorChange = getRandomInt(5, 8);
    } else {
        resultText = '你的琴声...只能说还有很大的进步空间。';
        favorChange = -getRandomInt(1, 3);
    }

    applyEffects({ relationship: { targetId: npcId, favor: favorChange }, attributes: { talent: 2 } });

    const resultContent = `
        ${resultText}<br><br>
        <strong>最终成绩:</strong><br>
        完美: ${gameState.miniGame.hits.perfect} | 不错: ${gameState.miniGame.hits.good} | 错过: ${gameState.miniGame.hits.miss}<br>
        <strong class="value">${gameState.npcs[npcId].name} 好感 ${favorChange > 0 ? '+' : ''}${favorChange}</strong>，你的才情+2。
    `;

    showEventCard('一曲终了', 'fa-music', resultContent);
}

/**
 * 处理玩家点击琴弦的逻辑
 */
function handleGuzhengHit(stringIndex) {
    if (!gameState.miniGame || !gameState.miniGame.gameRunning) return;

    const notesOnString = gameState.miniGame.strings[stringIndex];
    // 判定区域的参数 (与您的代码保持一致)
    const hitLinePosition = 0.85; 
    const perfectRange = 0.05; // 判定范围缩小，更精确
    const goodRange = 0.15;

    let hit = false;
    if (notesOnString.length > 0) {
        for (let i = notesOnString.length - 1; i >= 0; i--) {
            const note = notesOnString[i];
            const elapsed = performance.now() - parseFloat(note.dataset.createdAt);
            const progress = elapsed / (gameState.miniGame.noteSpeed * 1000);
            
            // 只处理已经进入判定区的音符
            if (progress > hitLinePosition - goodRange && progress < 1.0) {
                const distance = Math.abs(progress - hitLinePosition);

                if (distance <= perfectRange) {
                    // 完美判定
                    gameState.miniGame.hits.perfect++; // 修复点1: 增加完美命中计数
                    showGuzhengFeedback('完美!', '#FFD700');
                    const sfx = document.getElementById('sfx-perfect-hit');
                    if(sfx) { sfx.currentTime = 0; sfx.play(); }
                } else if (distance <= goodRange) {
                    // 不错判定
                    gameState.miniGame.hits.good++; // 修复点2: 增加不错命中计数
                    showGuzhengFeedback('不错', '#90EE90');
                    const sfx = document.getElementById('sfx-good-hit');
                    if(sfx) { sfx.currentTime = 0; sfx.play(); }
                }
                
                note.remove();
                notesOnString.splice(i, 1);
                hit = true;
                break; // 每次点击只处理一个音符
            }
        }
    }
    
    if (!hit) {
        // 如果没有命中任何在判定区的音符，则算作失误
        showGuzhengFeedback('失误', '#F08080');
        const sfx = document.getElementById('sfx-miss');
        if(sfx) { sfx.currentTime = 0; sfx.play(); }
    }

    // 【修复核心】实时分数直接根据详细成绩计算，确保一致
    gameState.miniGame.score = gameState.miniGame.hits.perfect * 2 + gameState.miniGame.hits.good * 1;
    document.getElementById('guzheng-score-display').textContent = `得分: ${gameState.miniGame.score}`;
}

/**
 * 显示游戏反馈
 */
function showGuzhengFeedback(text, color) {
    const feedbackEl = document.getElementById('guzheng-feedback');
    if (!feedbackEl) return;
    feedbackEl.textContent = text;
    feedbackEl.style.color = color;
    feedbackEl.classList.remove('show');
    void feedbackEl.offsetWidth; 
    feedbackEl.classList.add('show');
}
// =======================================================================
// =====================  【新功能代码】 START  =========================
// =======================================================================
/**
 * 【新增函数】根据职业产出专属信物材料
 */
function grantCareerCraftingItem() {
    const careerPath = gameState.career.path;

    // ▼▼▼【核心修改】在这里 ▼▼▼
    // 将等级判断的数字从 2 修改为 1
    // 等级索引从0开始，所以 level < 1 意味着等级为1级(索引0)时无法获得，
    // 从2级(索引1)开始的所有更高等级都可以获得。
    if (!careerPath || gameState.career.level < 1) return;
    // ▲▲▲ 修改结束 ▲▲▲
    
    const itemData = CAREER_CRAFTING_ITEMS[careerPath];
    if (itemData && Math.random() < 0.05) { // 5%的几率获得
        addItemToInventory(itemData.id, 1, itemData); // 使用新的addItemToInventory函数
        logEvent(`在处理公务时，你意外获得了 <strong class="value">${itemData.name}</strong>，或许能在关键时刻派上用场。`);
    }
}
// 【新增函数】使用藏宝阁物品增加功绩
function useInventoryItemForCareer(itemId, instanceId) {
    const itemDef = ITEM_DATA[itemId];
    if (!itemDef || !itemDef.performance_boost) {
        showToast("此物无法用于提升功绩。");
        return;
    }

    if (removeItemFromInventory(itemId, 1, instanceId)) {
        const boost = itemDef.performance_boost;
        gameState.career.performance += boost;
        // [核心修改] 将 checkForPromotion 作为回调函数传入
        showEventCard('公务精进', itemDef.icon, `你使用了<strong class="value">【${itemDef.name}】</strong>，处理公务得心应手，功绩提升了 <strong class="value">${boost}</strong> 点！`, [{ text: '知道了', callback: checkForPromotion }]);
        renderGame();
    } else {
        showToast("使用物品失败，请重试。");
    }
}

// [用这个新版本替换]
function handleProfessionEventResult(event, optionIndex) {
    const opt = event.options[optionIndex];
    let resultText = opt.result_text || "操作完成";
    let effects = opt.effects || {};
    let outcome = { text: resultText, effects: effects };

    if (opt.getOutcome) {
        outcome = opt.getOutcome(gameState);
        resultText = outcome.text;
        effects = { ...effects, ...outcome.effects };
    }

    if (outcome.sub_decision) {
        const subDecision = outcome.sub_decision;
        const subOptions = subDecision.options.map(subOpt => {
            return {
                htmlContent: `<span class="option-text">${subOpt.text}</span>`,
                callback: () => {
                    let finalEffects = subOpt.effects || {};
                    let finalResultText = subOpt.result_text || "抉择完成。";

                    if (finalEffects.attributes) applyEffects({ attributes: finalEffects.attributes });
                    if (finalEffects.core_resources) {
                         Object.entries(finalEffects.core_resources).forEach(([key, val]) => {
                            gameState.career.core_resources[key] = (gameState.career.core_resources[key] || 0) + val;
                        });
                    }
                    if(finalEffects.item) {
                        addItemToInventory(finalEffects.item.id, finalEffects.item.amount || 1);
                    }
logEvent(`【${event.title}】: ${finalResultText}`);
                    // [修改点] 使用回调来检查晋升
                    showEventCard(event.title, "fa-check-circle", finalResultText, [{ text: '好的', callback: checkForPromotion }]);
                }
            };
        });
        showDecisionCard(event.title, "fa-scroll", subDecision.desc, subOptions);
        return;
    }

    if (effects.attributes) applyEffects({ attributes: effects.attributes });
    if (effects.wealth) applyEffects({ wealth: effects.wealth });
    if (effects.core_resources && gameState.career.core_resources) {
        Object.entries(effects.core_resources).forEach(([key, val]) => {
            gameState.career.core_resources[key] = (gameState.career.core_resources[key] || 0) + val;
        });
    }
    if (effects.item) {
        addItemToInventory(effects.item.id, effects.item.amount || 1);
    }

    let performanceGain = getRandomInt(5, 15);
    if (gameState.buffs && gameState.buffs.career_luck) {
        performanceGain = Math.floor(performanceGain * 1.5);
        logEvent("在【功名】祝福的影响下，你处理公务事半功倍！");
    }
    gameState.career.performance += performanceGain;
    resultText += `<br>功绩+${performanceGain}`;

    grantCareerCraftingItem();

    // [核心修改] 将 checkForPromotion 作为回调函数传入
    showEventCard("公务处理结果", "fa-check-circle", resultText, [{ text: '知道了', callback: checkForPromotion }]);
}

function checkMilestoneEvent() {
    if (!gameState.career.path) return;
    
    const career = PROFESSION_DATA[gameState.career.path];
    const act = career.acts[gameState.career.currentAct];
    const milestone = act.milestone_event;

    if (!milestone || (gameState.career.milestone_triggered && gameState.career.milestone_triggered > gameState.career.currentAct)) return;

    let canTrigger = false;
    if (milestone.trigger.career_level && gameState.career.level >= milestone.trigger.career_level) {
        if (milestone.trigger.condition) {
            if (milestone.trigger.condition(gameState)) canTrigger = true;
        } else {
            canTrigger = true;
        }
    }

    if (canTrigger) {
        gameState.career.milestone_triggered = gameState.career.currentAct + 1; // 标记已触发
        
        let options = [{
            htmlContent: `<i class="fas fa-gavel"></i> 面对挑战`,
            callback: () => {
                // 简化处理，直接判断成功失败
                const successRate = 0.6; // 基础成功率，可以根据属性调整
                if (Math.random() < successRate) {
                    showEventCard(milestone.title, 'fa-crown', milestone.success.text);
                    applyEffects(milestone.success.effects);
                    // 晋级到下一幕
                    if (gameState.career.currentAct < career.acts.length - 1) {
                        gameState.career.currentAct++;
                        logEvent(`你的人生进入了新的篇章：<strong class="value">${career.acts[gameState.career.currentAct].title}</strong>`);
                    }
                } else {
                    showEventCard(milestone.title, 'fa-skull-crossbones', milestone.failure.text);
                    applyEffects(milestone.failure.effects);
                }
            }
        }];

        showDecisionCard(`人生转折点：${milestone.title}`, 'fa-star', milestone.desc, options);
    }
}
// =======================================================================
// ======================= 新版商会交易玩法模块 ==========================
// =======================================================================

const WAREHOUSE_LEVELS = [
    { level: 1, name: "初始货架", capacity: 100, upgradeCost: 0 },
    { level: 2, name: "小型仓库", capacity: 300, upgradeCost: 5000 },
    { level: 3, name: "中型仓库", capacity: 600, upgradeCost: 20000 },
    { level: 4, name: "大型仓库", capacity: 900, upgradeCost: 80000 },
    { level: 5, name: "巨型货栈", capacity: 1500, upgradeCost: 200000 }
];

const TRADE_SIM_DATA = {
    // 仓库等级数据 (注：实际升级逻辑使用的是 WAREHOUSE_LEVELS)
    warehouses: [
        { name: "初始仓库", capacity: 100, cost: 0 },
        { name: "中型仓库", capacity: 300, cost: 50 },
        { name: "大型仓库", capacity: 600, cost: 120 }
    ],
    // 商品数据
    goods: {
        yunjin: { guild: "江南", name: "云锦", basePrice: [120, 180] },
        longjingcha: { guild: "江南", name: "龙井茶", basePrice: [80, 120] },
        zishahu: { guild: "江南", name: "紫砂壶", basePrice: [60, 100] },
        suxiu: { guild: "江南", name: "苏绣", basePrice: [90, 140] },
        hubi: { guild: "江南", name: "湖笔", basePrice: [40, 70] },
        huimo: { guild: "江南", name: "徽墨", basePrice: [50, 80] },
        xuanzhi: { guild: "江南", name: "宣纸", basePrice: [30, 50] },
        duanyan: { guild: "江南", name: "端砚", basePrice: [100, 200] },
        hetianyu: { guild: "西域", name: "和田玉", basePrice: [200, 400] },
        putaojiu: { guild: "西域", name: "葡萄酒", basePrice: [70, 110] },
        yeguangbei: { guild: "西域", name: "夜光杯", basePrice: [80, 130] },
        hutao: { guild: "西域", name: "胡桃", basePrice: [20, 40] },
        ziran: { guild: "西域", name: "孜然", basePrice: [25, 45] },
        xuelian: { guild: "西域", name: "雪莲", basePrice: [150, 250] },
        luotuo: { guild: "西域", name: "骆驼", basePrice: [300, 500] },
        ditan: { guild: "西域", name: "地毯", basePrice: [90, 150] },
        renshen: { guild: "北境", name: "人参", basePrice: [180, 280] },
        diaopi: { guild: "北境", name: "貂皮", basePrice: [130, 200] },
        lurong: { guild: "北境", name: "鹿茸", basePrice: [160, 240] },
        tiekuang: { guild: "北境", name: "铁矿", basePrice: [40, 70] },
        beidima: { guild: "北境", name: "北地马", basePrice: [250, 400] },
        xiongdan: { guild: "北境", name: "熊胆", basePrice: [120, 180] },
        songzi: { guild: "北境", name: "松子", basePrice: [30, 50] },
        lingzhi: { guild: "北境", name: "灵芝", basePrice: [200, 300] },
        shanhu: { guild: "海外", name: "珊瑚", basePrice: [250, 400] },
        zhenzhu: { guild: "海外", name: "珍珠", basePrice: [150, 250] },
        xiangya: { guild: "海外", name: "象牙", basePrice: [200, 350] },
        hujiao: { guild: "海外", name: "胡椒", basePrice: [60, 100] },
        xiyangzhong: { guild: "海外", name: "西洋钟", basePrice: [300, 500] },
        boliqi: { guild: "海外", name: "玻璃器", basePrice: [100, 180] },
        xiangliao: { guild: "海外", name: "香料", basePrice: [70, 120] },
        zimingzhong: { guild: "海外", name: "自鸣钟", basePrice: [400, 600] }
    },
    // 随机事件
    randomEvents: [
        { name: "江南水灾", desc: "江南突发水灾，本地商品供应短缺，价格上涨。", prob: 0.1, effect: { type: 'guild', guild: "江南", multiplier: 1.4 } },
        { name: "西域沙暴", desc: "西域商路因沙暴受阻，运输成本大增。", prob: 0.1, effect: { type: 'guild', guild: "西域", multiplier: 1.35 } },
        { name: "北境大雪", desc: "北境大雪封山，特产难以运出。", prob: 0.15, effect: { type: 'guild', guild: "北境", multiplier: 1.3 } },
        { name: "海上风暴", desc: "海上风暴来袭，海外商品到货延迟，价格飞涨。", prob: 0.1, effect: { type: 'guild', guild: "海外", multiplier: 1.5 } },
        { name: "边境战事", desc: "边境战事吃紧，军需物资价格飙升。", prob: 0.08, effect: { type: 'goods', goods: ['tiekuang', 'beidima'], multiplier: 2.0 } },
        { name: "科举大考", desc: "三年一度的科举开始，文房四宝需求大增。", prob: 0.15, effect: { type: 'goods', goods: ['hubi', 'huimo', 'xuanzhi', 'duanyan'], multiplier: 1.6 } },
        { name: "皇室庆典", desc: "宫中举办庆典，奢侈品与珍玩需求旺盛。", prob: 0.05, effect: { type: 'goods', goods: ['yunjin', 'suxiu', 'hetianyu', 'shanhu', 'zhenzhu', 'xiangya'], multiplier: 1.5 } },
        { name: "钱庄紧缩", desc: "钱庄收紧银根，市场流通的货币减少，商品价格普遍下跌。", prob: 0.1, effect: { type: 'all', multiplier: 0.85 } },
        { name: "流行风尚", desc: "某件商品突然在京城贵妇圈中流行起来！", prob: 0.08, effect: { type: 'random_good', multiplier: 1.8 } }
    ]
};
// =======================================================================
// ===================== 【新增】女性视角夫君互动系统核心数据 ==============
// =======================================================================
const SPOUSE_STATES = {
    ambitious: { id: 'ambitious', name: '意气风发', icon: 'fa-chart-line', desc: '事业顺利，心情愉悦。' },
    frustrated: { id: 'frustrated', name: '心烦意乱', icon: 'fa-cloud-showers-heavy', desc: '事业不顺，情绪低落。' },
    leisured: { id: 'leisured', name: '闲情逸致', icon: 'fa-leaf', desc: '无事一身轻，乐于陪伴。' },
    exhausted: { id: 'exhausted', name: '身心俱疲', icon: 'fa-bed', desc: '健康不佳，需要照料。' },
    suspicious: { id: 'suspicious', name: '疑窦丛生', icon: 'fa-user-secret', desc: '对你心存怀疑，言行敏感。' }
};

const FEMALE_SPOUSE_INTERACTIONS = {
    daily: [
        { id: 'care', name: '关心近况', desc: '维系感情的基础。' },
        { id: 'red_sleeve', name: '红袖添香', desc: '陪伴夜读，提升才情与恩宠。', cost: { action: 1 }, states: ['ambitious', 'frustrated'] },
        { id: 'drink_chess', name: '小酌对弈', desc: '风花雪月，增进感情。', states: ['leisured'] },
        { id: 'give_gift', name: '赠送礼物', desc: '用私产为他准备一份心意。' }
    ],
    support: [
        { id: 'manage_network', name: '打点人脉', desc: '动用私产，为他的事业铺路。', cost: { wealth: 500 } },
        { id: 'analyze_situation', name: '分析时局', desc: '用你的智慧为他排忧解难。', req: { wisdom: 60 }, states: ['frustrated'] },
        { id: 'solve_problem', name: '排忧解难', desc: '他会主动向你求助。', is_event: true }
    ],
    household: [
        { id: 'pillow_talk', name: '吹枕边风', desc: '影响他对内宅人事的看法。', req: { favor: 70, scheming: 50 }, states: ['ambitious', 'leisured', 'exhausted'] },
        { id: 'discuss_concubine', name: '商议妾室', desc: '提出对妾室的赏罚建议。' },
        { id: 'complain_mother_in_law', name: '请教婆婆之事', desc: '以退为进，巧妙地告状。', req: { charm: 70 } },
        { id: 'expel_concubine', name: '驱赶恶妾', desc: '满足终极条件后，可开宗祠，请家法。', req: { favor: 100, authority: 100, evidence: true } }
    ]
};

const HUSBAND_INTERACTION_DATA = {
    daily_affection: [
        {
            id: 'care_inquiry',
            name: '关心近况',
            desc: '维系感情的基础。',
            req: {}
        },
        {
            id: 'red_sleeve',
            name: '红袖添香',
            desc: '陪伴夜读，提升才情与恩宠。',
            req: { state: ['意气风发', '心烦意乱'] }
        },
        {
            id: 'drink_chess',
            name: '小酌对弈',
            desc: '风花雪月，增进感情。',
            req: { state: ['闲情逸致'] }
        },
        {
            id: 'give_gift',
            name: '赠送礼物',
            desc: '用私产为他准备一份心意。',
            req: {}
        }
    ],
    career_support: [
        {
            id: 'manage_network',
            name: '打点人脉',
            desc: '动用私产，为他的事业铺路。',
            cost: { privateAssets: 500 },
            req: {}
        },
        {
            id: 'analyze_situation',
            name: '分析时局',
            desc: '用你的智慧为他排忧解难。',
            req: { wisdom: 60, state: ['心烦意乱'] }
        }
    ],
    household_discussion: [
        {
            id: 'pillow_talk',
            name: '吹枕边风',
            desc: '影响他对内宅人事的看法。',
            req: { favor: 70, scheming: 50, state_not: ['疑窦丛生'] }
        },
        // [移除] 此处原有的 'expel_concubine' 选项已被安全移除。
    ]
}; 

const FAVOR_LEVEL_DATA = {
    0: { name: '相敬如冰', desc: '丈夫在所有内斗事件中，100%偏向婆婆或受宠妾室。' },
    21: { name: '平淡如水', desc: '丈夫在内斗中持中立态度，倾向于“息事宁人”。' },
    51: { name: '琴瑟和鸣', desc: '丈夫在内斗中70%的几率偏向于你。' },
    81: { name: '情深意笃', desc: '丈夫在内斗中95%的几率无条件支持你，并为你抵挡压力。' },
    100: { name: '心有灵犀', desc: '绝对信任，你的所有建议都将100%成功。' }
};

// =======================================================================
// ===================== 【新增】维系信任事件库 ==========================
// =======================================================================

// 男性玩家维系与妻子信任的事件库
const MALE_TRUST_EVENTS = {
    gift: [
        { title: "赠送珠钗", desc: "你路过首饰铺，想起妻子似乎很喜欢一支南海珍珠钗。", options: [
            { text: "买下相赠", cost: { wealth: 500 }, effects: { suspicion: -10, favor: 8 }, log: "妻子收到珠钗惊喜不已，你们的情感升温。" },
            { text: "囊中羞涩", effects: { favor: -2 }, log: "你最终没有购买，妻子似乎有些失落。" }
        ]},
        { title: "亲手制作", desc: "你捡到一块上好的楠木，打算亲手为她做一个小物件。", options: [
            { text: "制作木梳", req: { talent: 40 }, effects: { suspicion: -12, favor: 10 }, log: "你亲手打磨的木梳虽不贵重，却满含心意，妻子十分感动。" },
            { text: "制作发簪", req: { talent: 60 }, effects: { suspicion: -15, favor: 12 }, log: "你精巧的手艺让妻子赞不绝口，她立刻将发簪戴上。" }
        ]},
        // ... 此处为其他18个男性赠礼事件 ...
    ],
    talk: [
        { title: "坦诚公务", desc: "你主动与妻子谈起最近在公务上的烦心事。", options: [
            { text: "寻求她的建议", req: { wisdom: 50 }, effects: { suspicion: -8, favor: 5 }, log: "她的建议虽不专业，但让你感到温暖，疑虑也消解了些许。" },
            { text: "只是倾诉", effects: { suspicion: -6, favor: 3 }, log: "你的坦诚让她觉得受到了尊重。" }
        ]},
        { title: "赞美岳家", desc: "你在妻子面前称赞她娘家的家风与品行。", options: [
            { text: "真心实意地赞美", effects: { suspicion: -10, favor: 7 }, log: "妻子听后十分高兴，认为你尊重她的家人。" },
            { text: "顺便提及岳家助力", req: { charm: 60 }, effects: { suspicion: -5, favor: 5 }, log: "你的话语一语双关，妻子会心一笑。" }
        ]},
        // ... 此处为其他18个男性交谈事件 ...
    ],
    accompany: [
        { title: "陪伴回门", desc: "妻子想回娘家看看，你决定放下手头事务，陪她一同前往。", options: [
            { text: "欣然前往", effects: { suspicion: -15, favor: 10, reputation: 5 }, log: "你的陪伴让妻子在娘家非常有面子，你们的关系更加亲密。" },
            { text: "送到门口", effects: { suspicion: -5, favor: 2 }, log: "你将她送到岳家门口，也算尽到了礼数。" }
        ]},
        { title: "共赏风月", desc: "你提议与妻子一同去湖心亭赏月。", options: [
            { text: "月下对酌", effects: { suspicion: -12, favor: 8 }, log: "你们在月下小酌，相谈甚欢，仿佛回到了初识之时。" },
            { text: "即兴赋诗", req: { talent: 70 }, effects: { suspicion: -18, favor: 15 }, log: "你即兴赋诗一首，妻子眼中满是崇拜的光芒。" }
        ]},
        // ... 此处为其他18个男性陪伴事件 ...
    ]
};

// 女性玩家维系与夫君信任的事件库
const FEMALE_TRUST_EVENTS = {
    gift: [
        { title: "缝制外袍", desc: "天气转凉，你打算为夫君亲手缝制一件外袍。", options: [
            { text: "精心缝制", req: { talent: 50 }, effects: { suspicion: -12, favor: 10 }, log: "你的针线细密，夫君穿上后十分合身，对你的贤惠赞不绝口。" },
            { text: "购买现成", cost: { wealth: 300 }, effects: { suspicion: -8, favor: 5 }, log: "你买了一件上好的外袍，夫君也很高兴。" }
        ]},
        { title: "准备醒酒汤", desc: "夫君应酬晚归，醉意醺醺。", options: [
            { text: "亲手熬制", effects: { suspicion: -10, favor: 8 }, log: "你端上一碗热气腾腾的醒酒汤，夫君心中一暖，酒醒后对你充满感激。" },
            { text: "让下人准备", effects: { suspicion: -5, favor: 3 }, log: "你吩咐下人备好醒酒汤，也算尽到了妻子的本分。" }
        ]},
        // ... 此处为其他18个女性赠礼事件 ...
    ],
    talk: [
        { title: "主动问询", desc: "你见夫君面有愁容，主动上前询问是否遇到了烦心事。", options: [
            { text: "温柔开解", req: { charm: 60 }, effects: { suspicion: -10, favor: 8 }, log: "你的温柔让他放下了防备，向你倾诉了烦恼。" },
            { text: "提出建议", req: { wisdom: 70 }, effects: { suspicion: -15, favor: 12 }, log: "你独到的见解让他茅塞顿开，对你刮目相看。" }
        ]},
        { title: "提及子嗣", desc: "你与夫君谈论起孩子们的趣事。", options: [
            { text: "分享趣事", effects: { suspicion: -8, favor: 5 }, log: "谈及孩子，你们之间的话题多了起来，气氛融洽。" },
            { text: "规划未来", req: { wisdom: 60 }, effects: { suspicion: -12, favor: 8 }, log: "你们一同为孩子的未来做规划，让他感受到了家庭的温暖。" }
        ]},
        // ... 此处为其他18个女性交谈事件 ...
    ],
    accompany: [
        { title: "红袖添香", desc: "夫君在书房夜读，你决定前去陪伴。", options: [
            { text: "默默磨墨", effects: { suspicion: -10, favor: 7 }, log: "无声的陪伴胜过千言万语，夫君感到十分安心。" },
            { text: "抚琴一曲", req: { talent: 70 }, effects: { suspicion: -15, favor: 12 }, log: "你的琴声悠扬，为他驱散了疲惫，让他对你更添爱意。" }
        ]},
        { title: "共理家事", desc: "你邀请夫君一同核对家中账目。", options: [
            { text: "展现能力", req: { wisdom: 60 }, effects: { suspicion: -12, favor: 8 }, log: "你将账目整理得井井有条，让他看到了你的持家能力。" },
            { text: "共同商议", effects: { suspicion: -10, favor: 6 }, log: "你们一同商议家事，让他觉得你是在与他共同承担这个家。" }
        ]},
        // ... 此处为其他18个女性陪伴事件 ...
    ]
};

// ===================== 【新增】妾室位份系统核心数据 =====================
const CONCUBINE_RANKS = [
    { level: 0, name: '侍妾', allowance: 500, favorBonus: 0, promotionFavorReq: 60, promotionChildReq: false },
    { level: 1, name: '良娣', allowance: 1200, favorBonus: 5, promotionFavorReq: 80, promotionChildReq: true },
    { level: 2, name: '贵嫔', allowance: 3000, favorBonus: 10, promotionFavorReq: Infinity, promotionChildReq: false }
];

const HAREM_EVENT_DATA = {
    // Low-intensity jealousy events
    jealousy: [
        {
            id: 'fake_pregnancy',
            title: '假孕争宠',
            trigger: (concubine) => concubine.mood === 'jealous' && concubine.ambition > 50 && Math.random() < 0.2,
            description: (concubine) => `你的妾室 <strong class="highlight-npc">${concubine.name}</strong> 近日声称自己已有身孕，向你索要更多赏赐和照顾。`,
            options: [
                {
                    text: '【信以为真，大加赏赐】',
                    action: (concubine) => {
                        applyEffects({ wealth: -500 });
                        // 使用 applyEffects
                        applyEffects({ relationship: { targetId: concubine.id, favor: 10 } }); // <--- 修改为此行
                        concubine.mood = '得意';
                        logEvent(`你赏赐了声称有孕的${concubine.name}，但一个月后若无所出，你的声望会因“识人不明”而微降。`);
                        // We can add a flag to check this later
                        gameState.flags[`fake_preg_${concubine.id}`] = gameState.date.year;
                    }
                },
                {
                    text: '【暗中派人调查】',
                    action: (concubine) => {
                        const isFake = Math.random() < 0.7; // 70% chance it's fake
                        if (isFake) {
                            showEventCard('调查结果', 'fa-search', `心腹下人回报，${concubine.name}脉象平稳，并无身孕。此事是你处置的好时机。`);
                            // Here you could trigger another decision to expose or warn her
                        } else {
                            showEventCard('调查结果', 'fa-search', `太医诊断，${concubine.name}确有身孕！你险些冤枉了她。`);
                            applyEffects({ relationship: { targetId: concubine.id, favor: -10 } }); // <--- 修改为此行
                        }
                    }
                },
                {
                    text: '【请正妻处理】',
                    action: (concubine) => {
                        const wife = gameState.npcs[gameState.marriage.spouseId];
                        if (wife.attributes.wisdom > 70) {
                            showEventCard('主母之威', 'fa-chess-queen', `你的正妻三言两语便识破了${concubine.name}的伎俩，并罚她抄写女则，后宅威望提升。`);
                            wife.householdPrestige = (wife.householdPrestige || 0) + 10;
                        } else {
                            showEventCard('处置不当', 'fa-frown', '正妻未能处理好此事，反而被妾室倒打一耙。');
                            wife.householdPrestige = (wife.householdPrestige || 0) - 5;
                        }
                    }
                }
            ]
        },
        // More low-intensity events can be added here
    ],
    // High-intensity scheming events
    scheming: [
        {
            id: 'poisoned_bird_nest_soup',
            title: '一碗燕窝',
            trigger: (concubine, wife) => {
                return wife && wife.isPregnant && concubine.mood === 'jealous' && concubine.jealousy > 80 && Math.random() < 0.15;
            },
            description: (concubine, wife) => `你怀孕的正妻 <strong class="highlight-npc">${wife.name}</strong> 在喝下妾室 <strong class="highlight-npc">${concubine.name}</strong> 送来的燕窝后，突然腹痛不止！太医诊断为“动了胎气”，但似乎另有隐情。`,
            options: [
                {
                    text: '【彻查到底！】',
                    action: (concubine, wife) => {
                        showEventCard('后宅调查', 'fa-search', '你下令彻查此事，府中风声鹤唳。');
                        // This would trigger a more complex investigation mini-game in a full implementation
                        const foundEvidence = Math.random() < (gameState.player.attributes.wisdom / 150);
                        if (foundEvidence) {
                            showEventCard('水落石出', 'fa-gavel', `你找到了确凿证据，证明是${concubine.name}下的手！你可以决定如何处置她。`);
                            // Trigger another decision for punishment
                        } else {
                            showEventCard('调查无果', 'fa-times', '调查陷入僵局，没能找到证据。');
                        }
                    }
                },
                {
                    text: '【为了声誉，压下此事】',
                    action: (concubine, wife) => {
                        wife.favor -= 20;
                        concubine.ambition = (concubine.ambition || 50) + 10;
                        showEventCard('息事宁人', 'fa-shield-alt', '你选择压下此事，正妻对你感到失望，而下毒的妾室则更加有恃无恐。');
                    }
                }
            ]
        }
        // More high-intensity events can be added here
    ]
};
function triggerPunishment_Male(gs, type) {
    const wife = gs.npcs[gs.marriage.spouseId];
    if (type === '缴纳安抚费') {
        const fee = Math.floor((gs.finances.wealth + gs.family.moneyChest) * 0.3);
        applyEffects({ wealth: -fee });
        gs.marriage.householdAuthorityHolder = 'wife'; // 交出掌家权
        // 添加debuff
        if(!gs.player.debuffs) gs.player.debuffs = {};
        gs.player.debuffs['wife_supervision'] = { description: '妻族的监视，未来出轨败露风险增加20%' };
        showEventCard('风流的代价', 'fa-money-bill-wave', `你支付了 ${fee} 两作为“安抚费”，并交出了掌家权。`);
        // 与情人断绝关系
        gs.social.secretLovers = [];

    } else if (type === '和离') {
        const propertyLoss = Math.floor(gs.family.moneyChest * 0.5) + Math.floor(gs.player.privateAssets * 0.3);
        applyEffects({ wealth: -propertyLoss });
        gs.family.reputation = Math.floor(gs.family.reputation * 0.5);
        gs.player.attributes.reputation = 0;
        
        // 核心调整：岳家之怒
        if((wife.attributes.family || 50) >= (gs.family.reputation / 2)){
             gs.career.path = null; // 事业线被摧毁
             showEventCard('岳家之怒', 'fa-gavel', `你的前妻家族对你进行疯狂报复，你的事业被彻底摧毁！`);
        }
        
        // 子女抚养权
        gs.children = gs.children.filter(c => c.motherId !== wife.id);
        
        showEventCard('和离', 'fa-heart-broken', `你与${wife.name}和离，损失了大量家产，声望大跌。`);
        gameState.marriage.isMarried = false;
        gameState.marriage.spouseId = null;
    }
}

/**
 * 触发女性玩家宅斗惩罚的函数
 * @param {object} gs - gameState
 * @param {string} type - '休弃' 或 '赐死'
 */
function triggerPunishment_Female(gs, type) {
    const husband = gs.npcs[gs.marriage.spouseId];
    if (type === '休弃') {
        showEventCard('一纸休书', 'fa-file-signature', '你被净身出户，失去所有子女，声望尽毁，但总算保住了性命。');
        // 玩家游戏状态可以变为“弃妇”，开启新的生存线
        gs.flags.playerStatus = 'divorced';
    } else if (type === '赐死') {
        showEndGame({ title: "红颜薄命", text: `你因“不贞”被夫家赐死，年仅${Math.floor(gs.player.age)}岁。` });
    }
    // 清理婚姻状态
    gameState.marriage.isMarried = false;
    gameState.marriage.spouseId = null;
    gameState.children = gs.children.filter(c => c.fatherId !== husband.id);
}

// 一个通用的成功率判定函数
function checkSuccess(attributeValue, difficulty) {
    const successRate = Math.min(0.95, Math.max(0.05, (attributeValue / difficulty)));
    return Math.random() < successRate;
}
function triggerInnerCourtEvent() {
    // 如果未婚，则不触发
    if ((!gameState.marriage.isMarried && gameState.marriage.concubines.length === 0)) return;
    
    // 随机性，不是每回合都触发
    if (Math.random() > 0.4) return; // 每回合40%几率检定一次

    const struggles = INNER_COURT_STRUGGLES[gameState.player.gender];
    if (!struggles) return;
    
    // 获取配偶对象
    const spouse = gameState.npcs[gameState.marriage.spouseId];
    if(!spouse && gameState.player.gender === 'female') return; // 女性玩家必须有丈夫才能触发宅斗

    // 寻找所有可能触发的事件
    const possibleEvents = Object.values(struggles).filter(event => 
        event.trigger && event.trigger(gameState)
    );

    if (possibleEvents.length > 0) {
        // 随机选择一个触发
        const eventToTrigger = getRandomElement(possibleEvents);
        
        // [修复核心] 使用 .trigger() 而不是 .generate() 来获取事件实例
        const eventInstance = eventToTrigger.trigger(gameState);
        if (!eventInstance) return; // 如果trigger返回false，则不继续

        const options = eventToTrigger.options.map(opt => ({
            htmlContent: `<span class="option-text">${opt.text}</span>`,
            disabled: opt.req && (
                (opt.req.hasAuthority && gameState.marriage.householdAuthorityHolder !== 'player') ||
                !Object.entries(opt.req).every(([key, val]) => {
                    if (key === 'favor_gt') return spouse.favor > val;
                    // 兼容多种属性检查
                    return (gameState.player.attributes[key] || gameState.player[key] || 0) >= val;
                })
            ),
            callback: () => {
                // action现在应该只返回一个结果字符串
                const resultLog = opt.action(eventInstance.involved);
                // 如果不是最终审判事件，则显示普通结果
                if (!eventToTrigger.isFinal) { 
                    showEventCard(eventToTrigger.title, 'fa-theater-masks', resultLog);
                }
            }
        }));
        
        // 推入事件队列，防止弹窗冲突
        eventQueue.push(() => {
            showDecisionCard(eventToTrigger.title, 'fa-theater-masks', eventInstance.description, options);
        });
    }
}
// =======================================================================
// ===================== 【新增】女性视角夫君互动系统核心数据 ==============
// =======================================================================
// ===================== 【新增】职业名称转换工具 =====================
const CAREER_CHINESE_TO_ENGLISH_MAP = {};
for (const gender in careerPaths) {
    for (const key in careerPaths[gender]) {
        const careerInfo = careerPaths[gender][key];
        CAREER_CHINESE_TO_ENGLISH_MAP[careerInfo.name] = key;
    }
}
// ===================== 【第一步(1/2)：替换此对象】补充配偶关系等级名称 =====================
const RELATIONSHIP_DATA = {
'spouse': {
        name: '配偶', type: 'spouse', genderScope: 'opposite',
        levelNames: ['相敬如宾', '琴瑟和鸣', '情深意笃', '比翼连枝', '神仙眷侣'], // [新增]
        interactions: [] // 互动由专门的婚姻/府邸标签页处理
    },
    'concubine': {
        name: '妾室', type: 'romance', genderScope: 'opposite',
        levelNames: ['侍妾', '良娣', '贵嫔', '侧妃', '贵妃'],
        interactions: [] // 互动由专门的婚姻/府邸标签页处理
    },
    'family': {
        name: '家人', type: 'friendship', genderScope: 'any',
        levelNames: ['家人'], // 家人关系等级通常是固定的
        interactions: []
    },
    // ==================== 友谊关系 (Friendship) ====================
    'red_confidante': { // 男性玩家的异性知己
        name: '红颜知己', type: 'friendship', genderScope: 'opposite',
        levelNames: ['萍水相逢', '意气相投', '惺惺相惜', '红颜知己', '此生挚友'],
        interactions: [
            { id: 'moon_drink', name: '月下对饮', min_favor: 60, min_level: 2 },
            { id: 'receive_gift', name: '意外赠礼', min_favor: 65, min_level: 2 },
            { id: 'be_rescued', name: '为君解围', min_favor: 70, min_level: 3 },
            { id: 'become_lover', name: '转为情人', min_favor: 80, min_level: 3 }
        ]
    },
    'blue_confidante': { // 女性玩家的异性知己
        name: '蓝颜知己', type: 'friendship', genderScope: 'opposite',
        levelNames: ['萍水相逢', '意气相投', '惺惺相惜', '蓝颜知己', '此生挚友'],
        interactions: [
            { id: 'moon_drink', name: '月下对饮', min_favor: 60, min_level: 2 },
            { id: 'receive_gift', name: '意外赠礼', min_favor: 65, min_level: 2 },
            { id: 'be_rescued', name: '为君解围', min_favor: 70, min_level: 3 },
            { id: 'become_lover', name: '转为情人', min_favor: 80, min_level: 3 }
        ]
    },
    'brother': { // 兄弟/同袍
        name: '兄弟同袍', type: 'friendship', genderScope: 'same',
        levelNames: ['点头之交', '同僚', '战友', '心腹', '生死之交'],
        interactions: [
            { id: 'fight_together', name: '并肩作战', min_favor: 60, min_level: 2 }
        ]
    },
     'confidante': { // 闺蜜
        name: '闺中密友', type: 'friendship', genderScope: 'same',
        levelNames: ['初识', '手帕交', '知己', '闺中密友', '一生之交'],
        interactions: [
            { id: 'share_secret', name: '分享心事', min_favor: 60, min_level: 2 }
        ]
    },

    // ==================== 恋爱关系 (Romance) ====================
    'lover': {
        name: '秘密情人', type: 'romance', genderScope: 'any',
        levelNames: ['初识情愫', '情意渐浓', '鱼水之欢', '难舍难分', '刻骨铭心'],
        interactions: [
            { id: 'rendezvous', name: '私会邀约', min_favor: 40, min_level: 2 },
            { id: 'jealousy', name: '争风吃醋', min_favor: 60, min_level: 3 },
            { id: 'propose_elopement', name: '请求私奔', min_favor: 90, min_level: 4 },
        ]
    },

    // ==================== 特殊关系 (Special) ====================
    'sworn_sibling': {
        name: '义结金兰', type: 'special', genderScope: 'same',
        levelNames: ['义结金兰'], // 等级固定
        interactions: [
            { id: 'teach_skill', name: '传授技能', min_favor: 80 },
            { id: 'overcome_difficulty', name: '共渡难关', min_favor: 70 }
        ]
    },
    'master': {
        name: '师父',
        type: 'special',
        genderScope: 'any',
        levelNames: ['师徒'], // 等级固定
        interactions: [
             { id: 'teach_skill', name: '传授技能', desc: '师父欲传授你独门技艺。', min_favor: 80 }
        ]
    },
    'former_apprentice': { 
        name: '出师弟子',
        type: 'special',
        genderScope: 'any',
        levelNames: ['师徒情深'],
        interactions: [
             { id: 'ask_help', name: '寻求帮助', min_favor: 60, min_level: 0 }
        ]
    }
};

const RELATIONSHIP_LEVELS = {
    friendship: [ // 知己、同袍等
        { level: 0, name: '初识', threshold: 0 },
        { level: 1, name: '熟悉', threshold: 50 },
        { level: 2, name: '友好', threshold: 120 },
        { level: 3, name: '亲密', threshold: 250 },
        { level: 4, name: '挚友', threshold: 500 }
    ],
    romance: [ // 情人
        { level: 0, name: '初识', threshold: 0 },
        { level: 1, name: '暧昧', threshold: 60 },
        { level: 2, name: '亲密', threshold: 150 },
        { level: 3, name: '热恋', threshold: 300 },
        { level: 4, name: '挚爱', threshold: 600 }
    ],
    spouse: [ // 夫妻
        { level: 0, name: '相敬如宾', threshold: 0 },
        { level: 1, name: '琴瑟和鸣', threshold: 80 },
        { level: 2, name: '情深意笃', threshold: 200 },
        { level: 3, name: '比翼连枝', threshold: 400 },
        { level: 4, name: '神仙眷侣', threshold: 700 }
    ]
};
const LOVER_DATA = {
    interactions: [
        { id: 'choose_date_location', name: '私密约会', icon: 'fa-calendar-check', min_favor: 20 },
        { id: 'secret_lover', name: '金屋藏娇', icon: 'fa-home', min_favor: 70, gender: 'male' },
        { id: 'take_as_concubine', name: '纳为妾室', icon: 'fa-user-plus', min_favor: 80, gender: 'male' },
        { id: 'propose_marriage', name: '求娶为妻', icon: 'fa-ring', min_favor: 90, gender: 'male' }
    ],
    dateLocations: [
        { name: '湖心亭', events: ['moon_drink'] },
        { name: '画舫', events: ['boat_serenade'] }
    ]
};
const LOVER_EVENTS = {
    // 约会地点事件
    'moon_drink': { title: '月下对酌', desc: '你们在湖心亭赏月小酌，对方借着酒意，向你吐露了一段不为人知的往事。', options: [
        { text: '安慰并分享你的秘密', effects: { favor: 15, devotion: 10 }, log: '你们交换了彼此最深的秘密，心与心贴得更近了。' },
        { text: '默默倾听', effects: { favor: 8 }, log: '你的倾听给了对方莫大的安慰。' }
    ]},
    'boat_serenade': { title: '画舫惊鸿', desc: '一艘画舫经过，上面的歌妓唱起一首哀婉的曲子，触动了对方的心事。', options: [
        { text: '为其赋诗一首', req: { talent: 80 }, effects: { favor: 20 }, log: '你的诗才令对方深深折服。' },
        { text: '邀其共舞一曲', req: { charm: 70 }, effects: { favor: 20 }, log: '你们在月光下共舞，身姿翩跹，情意绵绵。' }
    ]},
    // ... 此处省略其他28个事件的完整定义，实际生成时会包含所有事件 ...
    // 其他随机事件
    'late_visit': { title: '深夜探访', condition: (npc) => npc.favor > 60, desc: '夜深人静，你的情人突然到访，只为能见你一面。', effects: { favor: 5 } },
    'rival_appears': { title: '情敌出现', condition: (npc) => npc.favor > 70, desc: '一位新的、条件优秀的NPC开始追求你的情人。', options: [
        { text: '私下警告情敌', effects: { favor: 5, devotion: -5 }, log: '你的占有欲让情人有些不安，但也没说什么。' },
        { text: '加倍对TA好', effects: { favor: 10, devotion: 10 }, log: '你的行动让情人感受到了你的真心。' },
        { text: '相信情人，顺其自然', effects: { favor: -5, devotion: 15 }, log: '你的信任让情人很感动，但内心也有一丝不确定。' }
    ]},
    // 特殊身份事件
    'affair_exposed': { title: '东窗事发', condition: (gs, npc) => gs.marriage.isMarried, desc: '你与情人的关系被你的正妻/正夫发现！一场风暴即将来临。', options: [
        { text: '花费巨额金钱平息', req: { wealth: 10000 }, effects: { favor: -30, wealth: -10000 }, log: '你用钱暂时平息了事端，但夫妻关系已降至冰点。' },
        { text: '和离', callback: (npcId) => { confirmDivorce(); } }
    ]}
};
const TRADING_GOODS_DATA = {
    // 东市商会
    'silk': { name: '江南丝绸', guild: 'east', type: '奢侈品', basePrice: 100, fluctuation: 0.25 },
    'porcelain': { name: '景德瓷器', guild: 'east', type: '工艺品', basePrice: 80, fluctuation: 0.20 },
    'tea_longjing': { name: '龙井新茶', guild: 'east', type: '饮品', basePrice: 70, fluctuation: 0.15, perishable: 2 }, // perishable: 2年保质期
    'stationery': { name: '文房四宝', guild: 'east', type: '文化品', basePrice: 140, fluctuation: 0.10 },
    'embroidery_su': { name: '苏绣精品', guild: 'east', type: '奢侈品', basePrice: 200, fluctuation: 0.30 },
    'brocade_hang': { name: '杭锦', guild: 'east', type: '纺织品', basePrice: 95, fluctuation: 0.18 },
    'bamboo_craft': { name: '竹制工艺品', guild: 'east', type: '工艺品', basePrice: 45, fluctuation: 0.12 },
    'wine_shaoxing': { name: '绍兴黄酒', guild: 'east', type: '饮品', basePrice: 60, fluctuation: 0.15, perishable: 3 },
    // 西市商会
    'jade_hetian': { name: '和田美玉', guild: 'west', type: '奢侈品', basePrice: 300, fluctuation: 0.35 },
    'carpet_persian': { name: '波斯地毯', guild: 'west', type: '奢侈品', basePrice: 250, fluctuation: 0.30 },
    'wine_xiyu': { name: '西域葡萄酒', guild: 'west', type: '饮品', basePrice: 90, fluctuation: 0.20, perishable: 5 },
    'horse_turkic': { name: '突厥骏马', guild: 'west', type: '坐骑', basePrice: 400, fluctuation: 0.40 },
    'lotus_tian': { name: '天山雪莲', guild: 'west', type: '药材', basePrice: 180, fluctuation: 0.25, perishable: 4 },
    'spice_hu': { name: '胡人香料', guild: 'west', type: '调料', basePrice: 120, fluctuation: 0.22, perishable: 2 },
    'glass_dashi': { name: '大食琉璃', guild: 'west', type: '工艺品', basePrice: 150, fluctuation: 0.28 },
    'yak_wool': { name: '吐蕃牦牛毛', guild: 'west', type: '纺织品', basePrice: 110, fluctuation: 0.15 },
    // 南洋商会
    'pearl_donghai': { name: '东海珍珠', guild: 'south', type: '奢侈品', basePrice: 220, fluctuation: 0.35 },
    'coral': { name: '珊瑚饰品', guild: 'south', type: '工艺品', basePrice: 190, fluctuation: 0.30 },
    'spice_nanyang': { name: '南洋香料', guild: 'south', type: '调料', basePrice: 130, fluctuation: 0.25, perishable: 2 },
    'ivory_carving': { name: '象牙雕刻', guild: 'south', type: '奢侈品', basePrice: 280, fluctuation: 0.40 },
    'rhino_horn_cup': { name: '犀角杯', guild: 'south', type: '药材', basePrice: 200, fluctuation: 0.30, perishable: 10 },
    'coconut_oil': { name: '椰子油', guild: 'south', type: '食品', basePrice: 70, fluctuation: 0.15, perishable: 1 },
    'hardwood': { name: '热带硬木', guild: 'south', type: '材料', basePrice: 85, fluctuation: 0.20 },
    'pearl_shell': { name: '珍珠贝', guild: 'south', type: '材料', basePrice: 65, fluctuation: 0.18 },
    // 塞北商会
    'horse_saibei': { name: '塞北良马', guild: 'north', type: '坐骑', basePrice: 350, fluctuation: 0.35 },
    'fur_coat': { name: '貂皮大衣', guild: 'north', type: '奢侈品', basePrice: 240, fluctuation: 0.30 },
    'ginseng_changbai': { name: '长白人参', guild: 'north', type: '药材', basePrice: 170, fluctuation: 0.25, perishable: 5 },
    'deer_antler': { name: '鹿茸', guild: 'north', type: '药材', basePrice: 160, fluctuation: 0.25, perishable: 5 },
    'cheese': { name: '草原奶酪', guild: 'north', type: '食品', basePrice: 60, fluctuation: 0.20, perishable: 1 },
    'yurt': { name: '毡帐', guild: 'north', type: '生活品', basePrice: 120, fluctuation: 0.15 },
    'bow_arrow': { name: '弓矢', guild: 'north', type: '武器', basePrice: 100, fluctuation: 0.20 },
    'stone_carving': { name: '冻石雕刻', guild: 'north', type: '工艺品', basePrice: 140, fluctuation: 0.22 }
};

const MARKET_EVENT_DATA = [
    // 原有事件 (已保留)
    { id:'flood_jiangnan', name: '江南水灾', effects: { 'silk': 0.25, 'tea_longjing': -0.15 } },
    { id:'snow_north', name: '北方大雪', effects: { 'fur_coat': 0.30, 'horse_saibei': -0.20 } },
    { id:'storm_donghai', name: '东海风浪', effects: { 'pearl_donghai': 0.40, 'coral': 0.25 } },
    { id:'border_conflict', name: '边境冲突', effects: { 'bow_arrow': 0.35, 'horse_turkic': 0.25 } },
    { id:'palace_purchase', name: '宫廷采购', effects: { 'silk': 0.30, 'porcelain': 0.20, 'embroidery_su': 0.40 } },
    { id:'exam_season', name: '科举考试', effects: { 'stationery': 0.35 } },
    { id:'noble_wedding', name: '贵族婚礼', effects: { 'jade_hetian': 0.30, 'pearl_donghai': 0.25 } },

    // 新增事件
    { id:'canal_blockage', name: '运河淤塞', effects: { 'silk': 0.20, 'porcelain': 0.18, 'tea_longjing': 0.15, 'stationery': 0.10 } },
    { id:'xiyu_peace', name: '西域和平条约', effects: { 'jade_hetian': -0.20, 'carpet_persian': -0.18, 'wine_xiyu': -0.15 } },
    { id:'saibei_trade_boom', name: '塞北通商繁荣', effects: { 'horse_saibei': -0.15, 'fur_coat': -0.10, 'ginseng_changbai': -0.12 } },
    { id:'nanyang_tribute', name: '南洋诸国来朝', effects: { 'pearl_donghai': 0.20, 'coral': 0.18, 'ivory_carving': 0.25, 'spice_nanyang': 0.15 } },
    { id:'folk_art_craze', name: '民间艺术风潮', effects: { 'embroidery_su': 0.20, 'bamboo_craft': 0.30, 'stone_carving': 0.25 } },
    { id:'plague_scare', name: '疫病传闻', effects: { 'lotus_tian': 0.40, 'ginseng_changbai': 0.35, 'deer_antler': 0.30, 'rhino_horn_cup': 0.25 } },
    { id:'noble_fashion', name: '贵族新风尚', effects: { 'silk': 0.22, 'jade_hetian': 0.18, 'pearl_donghai': 0.20, 'fur_coat': 0.15 } },
    { id:'military_demand', name: '军备需求大增', effects: { 'horse_turkic': 0.30, 'horse_saibei': 0.28, 'bow_arrow': 0.40, 'yak_wool': 0.15 } },
    { id:'drought_warning', name: '干旱预警', effects: { 'tea_longjing': 0.20, 'wine_shaoxing': 0.15, 'wine_xiyu': 0.18 } },
    { id:'good_harvest', name: '粮食丰收', effects: { 'cheese': -0.20, 'coconut_oil': -0.15 } },
    { id:'overseas_competition', name: '海外竞争加剧', effects: { 'spice_nanyang': -0.25, 'ivory_carving': -0.15, 'coral': -0.10 } },
    { id:'scholar_gathering', name: '文人雅集', effects: { 'stationery': 0.25, 'tea_longjing': 0.15, 'wine_shaoxing': 0.10 } },
    { id:'new_mine_found', name: '发现新玉矿', effects: { 'jade_hetian': -0.25 } },
    { id:'temple_construction', name: '大兴土木修寺庙', effects: { 'hardwood': 0.30, 'stone_carving': 0.20 } },
    { id:'luxury_tax', name: '朝廷征收奢侈品税', effects: { 'silk': 0.15, 'jade_hetian': 0.20, 'pearl_donghai': 0.18, 'fur_coat': 0.12, 'ivory_carving': 0.22 } }
];
// 初始化商会交易状态 (在setupNewGame中调用)
function initTradeSimState() {
    if (!gameState.tradeSim) {
        gameState.tradeSim = {
            turn: 0,
            warehouse: {}, // { yunjin: 10, ... }
            currentPrices: {}, // { yunjin: { price: 150, trend: 0 }, ... }
            marketNews: [],
            warehouseLevel: 0, // 0: 初始, 1: 中型, 2: 大型
            debt: 0
        };
        // 首次进入时，生成初始价格
        updateTradePrices(true);
    }
}

// 启动新版商会交易玩法
function startTradeSim() {
    initTradeSimState();
    renderTradeSimUI();
    showOverlay('tradeSimOverlay');
}

// 渲染交易界面
function renderTradeSimUI() {
    const sim = gameState.tradeSim;
    const warehouseInfo = TRADE_SIM_DATA.warehouses[sim.warehouseLevel];
    const currentCapacity = Object.values(sim.warehouse).reduce((sum, amount) => sum + amount, 0);

    let html = `
    <div class="trade-sim-container">
        <div class="trade-sim-header">
            <div class="trade-sim-header-item"><strong>第 ${sim.turn / 2 + 1} 年 ${sim.turn % 2 === 0 ? '上半年' : '下半年'}</strong></div>
            <div class="trade-sim-header-item">资金: <strong class="value">${formatNumber(gameState.finances.wealth)}</strong> 两</div>
            <div class="trade-sim-header-item">仓库: ${currentCapacity} / ${warehouseInfo.capacity} (${warehouseInfo.name})</div>
            <div class="trade-sim-header-item">欠款: <strong style="color:red;">${formatNumber(sim.debt)}</strong> 两</div>
        </div>
        <div class="trade-sim-news">
            <strong>市场情报:</strong>
            <ul>
                ${sim.marketNews.length > 0 ? sim.marketNews.map(news => `<li>${news}</li>`).join('') : '<li>风平浪静。</li>'}
            </ul>
        </div>
        <div class="trade-sim-body">
            <table class="trade-sim-table">
                <thead>
                    <tr>
                        <th>商品</th>
                        <th>库存</th>
                        <th>现价</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(TRADE_SIM_DATA.goods).map(id => renderTradeGoodRow(id)).join('')}
                </tbody>
            </table>
        </div>
        <div class="trade-sim-footer">
            <button class="control-btn" onclick="nextTradeTurn()">进入下半年</button>
            <button class="control-btn" onclick="manageWarehouse()">仓库管理/升级</button>
            <button class="control-btn" onclick="manageDebt()">钱庄借贷</button>
        </div>
    </div>
    `;
    document.getElementById('tradeSimContent').innerHTML = html;
}
// 放置在 merchant guild 相关的函数区域

function updateMarketStatus() {
    const ts = gameState.tradingSystem;
    ts.marketStatus.fluctuations = [];
    ts.marketStatus.prices = {};

    // 随机选择1-3个市场事件
    const eventCount = getRandomInt(1, 3);
    const selectedEvents = [];
    for (let i = 0; i < eventCount; i++) {
        selectedEvents.push(getRandomElement(MARKET_EVENT_DATA));
    }

    // 初始化所有商品的基础价格
    for (const goodId in TRADING_GOODS_DATA) {
        const good = TRADING_GOODS_DATA[goodId];
        // 基础价格上有一个小的随机波动
        ts.marketStatus.prices[goodId] = Math.floor(good.basePrice * (1 + (Math.random() - 0.5) * 0.4)); 
    }

    // 应用市场事件效果
    selectedEvents.forEach(event => {
        for (const goodId in event.effects) {
            if (TRADING_GOODS_DATA[goodId]) {
                const good = TRADING_GOODS_DATA[goodId];
                const change = event.effects[goodId];
                ts.marketStatus.prices[goodId] = Math.floor(ts.marketStatus.prices[goodId] * (1 + change));
                
                // 记录到波动信息卡中
                ts.marketStatus.fluctuations.push({
                    id: goodId,
                    name: good.name,
                    change: change,
                    reason: event.name
                });
            }
        }
    });

    // 标记交易期开始 (1-15日)
    ts.isTradingPeriod = true; 
    logEvent('<strong>京城各大商会开市，新一轮的交易开始了！</strong>');
}
// 渲染商品表格的每一行
function renderTradeGoodRow(goodId) {
    const good = TRADE_SIM_DATA.goods[goodId];
    const sim = gameState.tradeSim;
    const priceInfo = sim.currentPrices[goodId];
    const stock = sim.warehouse[goodId] || 0;
    
    let trendArrow = '';
    if (priceInfo.trend > 0) trendArrow = `<span class="price-up">↑</span>`;
    if (priceInfo.trend < 0) trendArrow = `<span class="price-down">↓</span>`;

    return `
    <tr>
        <td><strong>${good.name}</strong><br><small>${good.guild}</small></td>
        <td>${stock}</td>
        <td>${priceInfo.price} ${trendArrow}</td>
        <td>
            <button class="btn-buy" onclick="buyGood('${goodId}')">买入</button>
            <button class="btn-sell" onclick="sellGood('${goodId}')" ${stock === 0 ? 'disabled' : ''}>卖出</button>
        </td>
    </tr>
    `;
}

// 更新所有商品价格
function updateTradePrices(isInitial = false) {
    const sim = gameState.tradeSim;
    sim.marketNews = [];

    // 1. 触发随机事件
    const activeEvents = [];
    TRADE_SIM_DATA.randomEvents.forEach(event => {
        if (Math.random() < event.prob) {
            activeEvents.push(event);
            sim.marketNews.push(event.desc);
        }
    });

    // 2. 计算每个商品的新价格
    Object.keys(TRADE_SIM_DATA.goods).forEach(id => {
        const good = TRADE_SIM_DATA.goods[id];
        let price = getRandomInt(good.basePrice[0], good.basePrice[1]);

        // 应用事件影响
        activeEvents.forEach(event => {
            let applies = false;
            if (event.effect.type === 'all') applies = true;
            if (event.effect.type === 'guild' && event.effect.guild === good.guild) applies = true;
            if (event.effect.type === 'goods' && event.effect.goods.includes(id)) applies = true;
            if (event.effect.type === 'random_good' && !event.affectedGood) {
                event.affectedGood = getRandomElement(Object.keys(TRADE_SIM_DATA.goods));
            }
            if (event.effect.type === 'random_good' && event.affectedGood === id) applies = true;
            
            if (applies) {
                price *= event.effect.multiplier;
            }
        });
        
        price = Math.round(price);
        
        let trend = 0;
        if (!isInitial && sim.currentPrices[id]) {
            trend = price - sim.currentPrices[id].price;
        }

        sim.currentPrices[id] = { price, trend };
    });
}

// 买入商品
function buyGood(goodId) {
    const sim = gameState.tradeSim;
    const good = TRADE_SIM_DATA.goods[goodId];
    const price = sim.currentPrices[goodId].price;
    const warehouseInfo = TRADE_SIM_DATA.warehouses[sim.warehouseLevel];
    const currentCapacity = Object.values(sim.warehouse).reduce((sum, amount) => sum + amount, 0);
    const availableSpace = warehouseInfo.capacity - currentCapacity;
    const maxCanBuy = Math.floor(gameState.finances.wealth / price);

    if (availableSpace <= 0) {
        showToast("仓库已满！");
        return;
    }
    if (maxCanBuy <= 0) {
        showToast("资金不足！");
        return;
    }
    
    const amountStr = prompt(`买入 ${good.name} (单价: ${price}两)\n仓库剩余容量: ${availableSpace}, 你最多可买: ${Math.min(availableSpace, maxCanBuy)}`, '1');
    const amount = parseInt(amountStr);
    
    if (isNaN(amount) || amount <= 0) return;
    if (amount > availableSpace) { showToast("仓库容量不足！"); return; }
    if (amount > maxCanBuy) { showToast("资金不足！"); return; }

    applyEffects({ wealth: -amount * price });
    sim.warehouse[goodId] = (sim.warehouse[goodId] || 0) + amount;
    renderTradeSimUI();
}

// 卖出商品
function sellGood(goodId) {
    const sim = gameState.tradeSim;
    const good = TRADE_SIM_DATA.goods[goodId];
    const price = sim.currentPrices[goodId].price;
    const stock = sim.warehouse[goodId] || 0;

    const amountStr = prompt(`卖出 ${good.name} (单价: ${price}两)\n你当前持有: ${stock}`, `${stock}`);
    const amount = parseInt(amountStr);
    
    if (isNaN(amount) || amount <= 0) return;
    if (amount > stock) { showToast("库存不足！"); return; }

    applyEffects({ wealth: amount * price });
    sim.warehouse[goodId] -= amount;
    if (sim.warehouse[goodId] === 0) {
        delete sim.warehouse[goodId];
    }
    renderTradeSimUI();
}

// 进入下一回合
function nextTradeTurn() {
    const sim = gameState.tradeSim;
    sim.turn++;

    // 结算仓储费
    const warehouseInfo = TRADE_SIM_DATA.warehouses[sim.warehouseLevel];
    if (warehouseInfo.cost > 0) {
        applyEffects({ wealth: -warehouseInfo.cost });
        sim.marketNews.push(`支付仓库租金 ${warehouseInfo.cost} 两。`);
    }

    // 结算利息
    if (sim.debt > 0) {
        const interest = Math.ceil(sim.debt * 0.05); // 5% 利息
        applyEffects({ wealth: -interest });
        sim.debt += interest;
        sim.marketNews.push(`支付钱庄利息 ${interest} 两。`);
    }

    updateTradePrices();
    renderTradeSimUI();
}

// 管理仓库
function manageWarehouse() {
    const sim = gameState.tradeSim;
    const currentLevel = sim.warehouseLevel;
    if (currentLevel >= TRADE_SIM_DATA.warehouses.length - 1) {
        showToast("已是顶级仓库。");
        return;
    }
    const nextWarehouse = TRADE_SIM_DATA.warehouses[currentLevel + 1];
    
    if (confirm(`是否花费 ${nextWarehouse.cost * 10} 两升级为 ${nextWarehouse.name} (容量: ${nextWarehouse.capacity})？`)) {
        const upgradeCost = nextWarehouse.cost * 10;
        if (gameState.finances.wealth < upgradeCost) {
            showToast("资金不足以升级仓库！");
            return;
        }
        applyEffects({ wealth: -upgradeCost });
        sim.warehouseLevel++;
        showToast("仓库升级成功！");
        renderTradeSimUI();
    }
}

// 管理借贷
function manageDebt() {
    const sim = gameState.tradeSim;
    const maxLoan = gameState.family.reputation * 100;

    let content = `<p>当前欠款: ${sim.debt} 两。</p><p>以你的声望，最多可从钱庄借贷 ${maxLoan} 两。</p>`;
    let options = [];

    options.push({
        htmlContent: '借钱',
        callback: () => {
            const amountStr = prompt(`请输入要借入的金额 (最多可借 ${maxLoan - sim.debt})`);
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return;
            if (amount + sim.debt > maxLoan) { showToast("超出你的借贷上限！"); return; }
            applyEffects({ wealth: amount });
            sim.debt += amount;
            renderTradeSimUI();
        }
    });

    if (sim.debt > 0) {
        options.push({
            htmlContent: '还钱',
            callback: () => {
                const amountStr = prompt(`请输入要偿还的金额 (当前欠款 ${sim.debt})`, `${sim.debt}`);
                const amount = parseInt(amountStr);
                if (isNaN(amount) || amount <= 0) return;
                if (amount > gameState.finances.wealth) { showToast("资金不足以偿还！"); return; }
                const realAmount = Math.min(amount, sim.debt);
                applyEffects({ wealth: -realAmount });
                sim.debt -= realAmount;
                renderTradeSimUI();
            }
        });
    }

    showDecisionCard("钱庄业务", "fa-coins", content, options);
}
// =======================================================================
// ===================== 【新功能代码】社交玩法函数 START =====================
// =======================================================================

function showWeddingBanquet(groom, bride, guestIdsJson) {
    const overlay = document.getElementById('weddingOverlay');
    const guestIds = JSON.parse(guestIdsJson);
    
    let banquetHTML = `
        <div class="wedding-stage" id="wedding-stage-3">
            <div class="overlay-header">喜宴</div>
            <p>宴席上宾主尽欢，你的好友们纷纷前来敬酒道贺。</p>
            <div id="wedding-toasts">
            ${guestIds.map(id => {
                const guest = gameState.npcs[id];
                return `<p>${guest.name}: "恭贺新人，百年好合！" (送上贺礼)</p>`;
            }).join('')}
            </div>
            <button class="control-btn" style="margin-top:20px;" onclick="closeAllOverlays()">礼成</button>
        </div>
    `;
    overlay.innerHTML = banquetHTML;
    
    // 结算贺礼
    const giftMoney = guestIds.length * getRandomInt(100, 300);
    if(giftMoney > 0) {
        applyEffects({wealth: giftMoney});
        showToast(`收到宾客贺礼共计 ${giftMoney} 两。`);
    }
}

function startConversationMiniGame(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return;

    const dilemmas = [
        { desc: `最近总觉得心绪不宁，不知该如何是好。`, responses: { wisdom: "分析原因", charm: "温柔安慰", virtue: "鼓励振作"} },
        { desc: `我与一位友人产生了些许误会，正为此烦恼。`, responses: { wisdom: "建议沟通", charm: "表示理解", virtue: "劝说和解"} },
        { desc: `前路漫漫，时常会感到迷茫。`, responses: { wisdom: "探讨未来", charm: "给予信心", virtue: "强调坚持"} },
    ];
    const dilemma = getRandomElement(dilemmas);

    const options = [
        { htmlContent: `<i class="fas fa-lightbulb"></i> ${dilemma.responses.wisdom} (智慧)`, callback: () => handleConversationChoice(npcId, 'wisdom') },
        { htmlContent: `<i class="fas fa-grin-stars"></i> ${dilemma.responses.charm} (魅力)`, callback: () => handleConversationChoice(npcId, 'charm') },
        { htmlContent: `<i class="fas fa-leaf"></i> ${dilemma.responses.virtue} (品德)`, callback: () => handleConversationChoice(npcId, 'virtue') },
    ];

    showDecisionCard(`与 ${npc.name} 的交谈`, 'fa-heart', `<p>"${dilemma.desc}"</p>`, options);
}

function handleConversationChoice(npcId, choiceType) {
    const npc = gameState.npcs[npcId];
    // 简化逻辑：每个NPC有一种主要性格，对应一种最佳回应
    const personalityMap = { "聪慧": "wisdom", "敏锐": "wisdom", "温柔": "charm", "活泼": "charm", "端庄": "virtue", "坚韧": "virtue", "善良": "virtue" };
    const bestChoice = personalityMap[npc.personality[0]] || 'wisdom';

    if (choiceType === bestChoice) {
        showEventCard('知心之言', 'fa-heart-pulse', '你的话语说到了对方的心坎里，你们的关系更加亲近了。');
        applyEffects({ relationship: { targetId: npcId, trust: 15, favor: 5 }});
    } else {
        showEventCard('善意倾听', 'fa-ear-listen', '虽然未能完全解开对方心结，但你的善意倾听也让TA感到温暖。');
        applyEffects({ relationship: { targetId: npcId, trust: 5, favor: 2 }});
    }
}

function startGoMiniGame(npcId) {
    const cost = 20; 
    if (gameState.finances.wealth < cost) {
        showToast(`对弈需要 ${cost} 两茶水钱，你的资金不足。`);
        return;
    }

    const betAmountStr = prompt(`请输入本次对弈的赌金（输入0为切磋，赢了双倍返还，输了扣除）：`, "100");
    let betAmount = parseInt(betAmountStr);

    if (isNaN(betAmount) || betAmount < 0) {
        showToast("请输入有效的赌金。");
        return;
    }
    
    // 【新增】限制赌金上限
    if (betAmount > 50000) {
        showToast("赌金最高不得超过50000两，已自动为你调整。");
        betAmount = 50000;
    }

    if (gameState.finances.wealth < cost + betAmount) {
        showToast(`你的资金不足以支付茶水钱和赌金。`);
        return;
    }
    
    applyEffects({ wealth: -(cost + betAmount) });

    const container = document.getElementById('goGameContainer');
    let boardHTML = '<div class="go-board">';
    for (let i = 0; i < 25; i++) {
        boardHTML += `<div class="go-cell" onclick="placeGoStone(this, ${i}, '${npcId}', ${betAmount})"></div>`;
    }
    boardHTML += '</div>';
    container.innerHTML = boardHTML;
    document.getElementById('goGameStatus').textContent = `赌金：${betAmount} 两。你执黑子，请落子。`;
    
    gameState.miniGame = { 
        board: Array(25).fill(null), 
        turn: 'player', 
        opponent: npcId,
        bet: betAmount,
        gameOver: false
    };
    
    showOverlay('goGameOverlay');
}
function placeGoStone(cell, index, npcId, betAmount) {
    const game = gameState.miniGame;
    if (game.gameOver || game.turn !== 'player' || game.board[index] !== null) return;
    
    cell.textContent = '⚫';
    game.board[index] = 'player';
    
    const handleEndGame = (result) => {
        game.gameOver = true;
        let resultText = '';
        let favorChange = 0;

        if (result === 'win') {
            document.getElementById('goGameStatus').textContent = `你赢了！获得 ${betAmount * 2} 两赌金。`;
            applyEffects({ wealth: betAmount * 2 }); // 赢了双倍返还
            favorChange = 5;
            resultText = `你在棋局中战胜了${gameState.npcs[npcId].name}，对方对你刮目相看。`;
        } else if (result === 'lose') {
            document.getElementById('goGameStatus').textContent = '你输了。';
            // 赌金在开始时已扣除，这里无需再扣
            favorChange = 3;
            resultText = `虽然输了棋局，但也与${gameState.npcs[npcId].name}增进了感情。`;
        } else { // draw
            document.getElementById('goGameStatus').textContent = '平局！赌金退还。';
            applyEffects({ wealth: betAmount }); // 平局退还本金
            favorChange = 4;
            resultText = `一局终了，不分胜负，你们对彼此的棋艺都十分欣赏。`;
        }
        applyEffects({relationship: { targetId: npcId, influence: result === 'win' ? 10 : 0, favor: favorChange }});
        showEventCard('手谈对弈', 'fa-chess', resultText);
    };

    if (checkGoWin('player')) {
        handleEndGame('win');
        return;
    }
    if (game.board.every(s => s !== null)) {
        handleEndGame('draw');
        return;
    }
    
    game.turn = 'npc';
    document.getElementById('goGameStatus').textContent = '对方正在思考...';
    
    setTimeout(() => {
        if (game.gameOver) return;
        const npcMove = getNpcGoMove();
        if (npcMove === -1) { // 没有可落子的地方，平局
            handleEndGame('draw');
            return;
        }

        game.board[npcMove] = 'npc';
        document.querySelector(`.go-board .go-cell:nth-child(${npcMove + 1})`).textContent = '⚪';
        
        if (checkGoWin('npc')) {
            handleEndGame('lose');
            return;
        }
        if (game.board.every(s => s !== null)) {
            handleEndGame('draw');
            return;
        }

        game.turn = 'player';
        document.getElementById('goGameStatus').textContent = '轮到你了。';
    }, 1000);
}
function checkGoWin(player) {
    const board = gameState.miniGame.board;
    const size = 5; // 5x5 棋盘
    const winCount = 4; // 四子连珠

    for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
            const index = r * size + c;
            if (board[index] !== player) continue;

            // 检查水平方向
            if (c + winCount <= size) {
                let win = true;
                for (let i = 1; i < winCount; i++) {
                    if (board[index + i] !== player) {
                        win = false;
                        break;
                    }
                }
                if (win) return true;
            }

            // 检查垂直方向
            if (r + winCount <= size) {
                let win = true;
                for (let i = 1; i < winCount; i++) {
                    if (board[index + i * size] !== player) {
                        win = false;
                        break;
                    }
                }
                if (win) return true;
            }

            // 检查右下斜方向
            if (r + winCount <= size && c + winCount <= size) {
                let win = true;
                for (let i = 1; i < winCount; i++) {
                    if (board[index + i * (size + 1)] !== player) {
                        win = false;
                        break;
                    }
                }
                if (win) return true;
            }

            // 检查左下斜方向
            if (r + winCount <= size && c - (winCount - 1) >= 0) {
                let win = true;
                for (let i = 1; i < winCount; i++) {
                    if (board[index + i * (size - 1)] !== player) {
                        win = false;
                        break;
                    }
                }
                if (win) return true;
            }
        }
    }
    return false;
}// [替换]
function getNpcGoMove() {
    const board = gameState.miniGame.board;
    const size = 5;

    // 1. 检查NPC自己能否一步获胜
    for (let i = 0; i < size * size; i++) {
        if (board[i] === null) {
            board[i] = 'npc';
            if (checkGoWin('npc')) {
                board[i] = null; // 恢复棋盘
                return i;
            }
            board[i] = null; // 恢复棋盘
        }
    }

    // 2. 检查玩家能否一步获胜 (进行防守)
    for (let i = 0; i < size * size; i++) {
        if (board[i] === null) {
            board[i] = 'player';
            if (checkGoWin('player')) {
                board[i] = null; // 恢复棋盘
                return i;
            }
            board[i] = null; // 恢复棋盘
        }
    }

    // 3. 寻找一个随机的空位
    let availableMoves = [];
    for (let i = 0; i < size * size; i++) {
        if (board[i] === null) {
            availableMoves.push(i);
        }
    }

    // 4. 作为简单的进攻策略，优先选择棋盘中心区域
    const centerMoves = [6, 7, 8, 11, 12, 13, 16, 17, 18].filter(m => availableMoves.includes(m));
    if (centerMoves.length > 0) {
        return getRandomElement(centerMoves);
    }

    return availableMoves.length > 0 ? getRandomElement(availableMoves) : -1;
}

function handleLoverInteraction(npcId, actionId) {
    // 【核心修改】在函数开头加入新的检查
    if (!checkAndUseNpcActionPoint(npcId)) {
        return;
    }

    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    if (!npc) return;

    if (gameState.marriage.isMarried && gameState.marriage.spouseId) {
        const spouse = gameState.npcs[gameState.marriage.spouseId];
        if (spouse) {
            spouse.suspicionValue = (spouse.suspicionValue || 0) + getRandomInt(3, 7);
            logEvent(`你与<strong class="highlight-npc">${npc.name}</strong>的亲密互动让你有些心虚，你配偶的疑心增加了。`);
        }
    }

    switch(actionId) {
        case 'rendezvous':
            showEventCard('月下之约', 'fa-kiss-wink-heart', '你们在月影花香中互诉衷肠，情意更浓。情意+20。');
            applyEffects({ relationship: { targetId: npcId, favor: 20 } });
            if(Math.random() < 0.2) triggerBirth(npcId, true);
            break;
        case 'poetry_quiz':
            startPoetryMiniGame(npcId);
            break;
        case 'take_as_concubine_lover':
            acquireConcubine(npcId);
            break;
        case 'propose_marriage_lover':
            marrySuitor(npcId);
            break;
        case 'intimacy':
            if (gameState.player.gender === 'female') {
                showEventCard('缠绵悱恻', 'fa-moon', `你与${npc.name}共度良宵... 品德-2`);
                applyEffects({ attributes: { virtue: -2 }});
                triggerBirth(npc.id, true); 
            }
            break;
        default:
            showToast(`触发了未知的情人互动: ${actionId}`);
            break;
    }
}

function handleSwornSiblingInteraction(npcId, actionId) {
    // 【核心修改】在函数开头加入新的检查
    if (!checkAndUseNpcActionPoint(npcId)) {
        return;
    }

    const npc = gameState.npcs[npcId];
    if (!npc) return;

    const eventPool = SWORN_SIBLING_EVENTS[actionId];
    if (!eventPool || eventPool.length === 0) {
        showToast("暂无更多互动剧情。");
        return;
    }

    const event = getRandomElement(eventPool);

    const options = event.options.map(opt => ({
        htmlContent: `<span class="option-text">${opt.text}</span>`,
        callback: () => {
            if (opt.effects) {
                if (opt.effects.attributes) applyEffects({ attributes: opt.effects.attributes });
                if (opt.effects.wealth) applyEffects({ wealth: opt.effects.wealth });
                if (opt.effects.reputation) applyEffects({ reputation: opt.effects.reputation });
                if (opt.effects.career_performance) gameState.career.performance += opt.effects.career_performance;
                if (opt.effects.relationship) applyEffects({ relationship: { targetId: npcId, ...opt.effects.relationship } });
                if (opt.effects.item) addItemToInventory(opt.effects.item.id, opt.effects.item.amount || 1, ITEM_DATA[opt.effects.item.id]);
            }
            showEventCard(event.title, 'fa-hands-helping', opt.log);
        }
    }));

    showDecisionCard(event.title, 'fa-hands-helping', event.desc, options);
}

// =======================================================================
// ===================== 【新增】义结金兰仪式核心逻辑 =====================
// =======================================================================

/**
 * 启动结拜仪式的第一步：前置事件“金兰之约”
 * @param {string} npcId - 提议结拜的NPC ID
 */
function triggerOathProposal(npcId) {
    const npc = gameState.npcs[npcId];
    if (!npc) return;

    const proposalText = `
        <p>某日，<strong class="highlight-npc">${npc.name}</strong> 与你对坐饮酒，忽然举杯郑重说道：</p>
        <p class="comment" style="text-align:center;">“你我相识虽短，却意气相投，肝胆相照。若不嫌弃，愿与你结为异姓${gameState.player.gender === 'male' ? '兄弟' : '姐妹'}，从此祸福与共，生死不负。”</p>
    `;

    const options = [
        {
            htmlContent: `<i class="fas fa-handshake"></i> 欣然应允：“正合我意！”`,
            callback: () => startOathCeremony(npcId)
        },
        {
            htmlContent: `<i class="fas fa-clock"></i> 容我三思：“此事重大，需择良辰吉日。”`,
            callback: () => {
                showEventCard('三思而后行', 'fa-clock', `你认为结拜之事需郑重，决定稍后再议。`);
            }
        }
    ];

    showDecisionCard('金兰之约', '🤝', proposalText, options);
}

/**
 * 初始化仪式状态并开始第一步：选择地点
 * @param {string} npcId - 结拜的NPC ID
 */
function startOathCeremony(npcId) {
    oathCeremonyState = {
        npcId: npcId,
        location: null,
        item: null,
        bonuses: {}
    };
    showOathLocationChoice();
}

/**
 * 显示结拜地点的选择界面
 */
function showOathLocationChoice() {
    const locations = [
        { id: 'peach_blossom', name: '桃花树下', desc: '浪漫诗意', icon: 'fa-tree' },
        { id: 'mountain_top', name: '山巅观日台', desc: '豪迈壮阔', icon: 'fa-mountain' },
        { id: 'temple', name: '古寺禅院', desc: '庄重肃穆', icon: 'fa-gopuram' },
        { id: 'courtyard', name: '自家庭院', desc: '温馨私密', icon: 'fa-home' }
    ];

    const options = locations.map(loc => ({
        htmlContent: `<i class="fas ${loc.icon}"></i><span class="option-text"><strong>${loc.name}</strong><div><small>${loc.desc}</small></div></span>`,
        callback: () => {
            oathCeremonyState.location = loc.id;
            // 根据地点设置加成
            switch(loc.id) {
                case 'peach_blossom': oathCeremonyState.bonuses.attributes = { charm: 5 }; break;
                case 'mountain_top': oathCeremonyState.bonuses.attributes = { martial: 5 }; break;
                case 'temple': oathCeremonyState.bonuses.attributes = { virtue: 5 }; break;
                case 'courtyard': oathCeremonyState.bonuses.attributes = { reputation: 5 }; break;
            }
            showOathItemChoice(); // 进入下一步
        }
    }));

    showDecisionCard('选择结拜地点', 'fa-map-signs', '请选择一处合适的地点，以示郑重。', options);
}

/**
 * 显示结拜信物的选择界面
 */
function showOathItemChoice() {
    const items = [
        { id: 'blood_wine', name: '血酒盟誓', desc: '滴血入酒，共饮盟誓', cost: 100 },
        { id: 'golden_帖', name: '金兰帖文', desc: '亲手书写结拜帖文', cost: 150 },
        { id:'jade_pendant', name: '玉佩互赠', desc: '互换贴身玉佩', cost: 300 },
        { id: 'sword_tassel', name: '剑穗相系', desc: '将剑穗系于对方剑上', cost: 200 }
    ];

    const options = items.map(item => ({
        htmlContent: `<i class="fas fa-gem"></i><span class="option-text"><strong>${item.name}</strong><div><small>${item.desc} (花费: ${item.cost}两)</small></div></span>`,
        disabled: gameState.finances.wealth < item.cost,
        callback: () => {
            oathCeremonyState.item = item.id;
            oathCeremonyState.cost = item.cost;
            displayOathCeremony(); // 进入最终仪式
        }
    }));

    showDecisionCard('准备信物', 'fa-gift', '信物是情谊的见证，请选择一种仪式。', options);
}

/**
 * 显示最终的结拜仪式动画与文本
 */
function displayOathCeremony() {
    const npc = gameState.npcs[oathCeremonyState.npcId];
    const player = gameState.player;
    const genderTerm = player.gender === 'male' ? '兄弟' : '姐妹';

    const header = document.getElementById('oathCeremonyHeader');
    const animation = document.getElementById('oathCeremonyAnimation');
    const content = document.getElementById('oathCeremonyContent');
    const optionsContainer = document.getElementById('oathCeremonyOptions');
    const confirmBtn = document.getElementById('oathCeremonyConfirmBtn');
    
    header.textContent = '义结金兰 · 盟誓此生';
    animation.innerHTML = '🔥';
    content.innerHTML = `
        <p>香炉中青烟袅袅，你与 <strong class="highlight-npc">${npc.name}</strong> 跪于天地前，朗声诵读：</p>
        <blockquote>
            皇天在上，厚土为证。<br>
            今日我 <strong>${player.name}</strong> 与 <strong>${npc.name}</strong> 结为异姓${genderTerm}，<br>
            不求同年同月同日生，但求同年同月同日死。<br>
            肝胆相照，荣辱与共，如有违背，天人共戮！
        </blockquote>
        <p>诵读完毕，你二人相视一笑，将信物交换，仪式即将完成。</p>
    `;
    optionsContainer.style.display = 'none';
    confirmBtn.style.display = 'block';

    showOverlay('oathCeremonyOverlay');
}

/**
 * 完成结拜仪式，应用所有效果
 */
function completeOath() {
    const npcId = oathCeremonyState.npcId;
    const npc = gameState.npcs[npcId];
    const player = gameState.player;
    const rel = gameState.social.relationships[npcId];
    const genderTerm = player.gender === 'male' ? '兄弟' : '姐妹';

    // 1. 扣除费用
    if (oathCeremonyState.cost) {
        applyEffects({ wealth: -oathCeremonyState.cost });
    }

    // 2. 更新关系
    if (rel) {
        rel.type = 'sworn_sibling';
        rel.level = 4; // 直接提升到最高等级
        rel.emotionValue = (rel.emotionValue || 0) + 200; // 大幅增加情感值
    } else {
        gameState.social.relationships[npcId] = {
            type: 'sworn_sibling',
            favor: 100,
            emotionValue: 200,
            level: 4,
            eventsExperienced: (rel ? rel.eventsExperienced : 0) + 1,
            isSworn: true
        };
    }
    
    if (!gameState.social.swornSiblings) {
        gameState.social.swornSiblings = [];
    }
    if (!gameState.social.swornSiblings.includes(npcId)) {
        gameState.social.swornSiblings.push(npcId);
    }
    // 确保从其他列表中移除
    gameState.social.friends = (gameState.social.friends || []).filter(id => id !== npcId);
    
    // 3. 应用地点和信物加成
    if (oathCeremonyState.bonuses) {
        applyEffects(oathCeremonyState.bonuses);
    }
    
    // 4. 显示最终结果
    showEventCard('义结金兰', 'fa-hands-helping', `你与 <strong class="highlight-npc">${npc.name}</strong> 焚香结拜，从此祸福与共，成为生死不离的${genderTerm}！`);

    // 5. 清理状态并刷新界面
    oathCeremonyState = {};
    closeAllOverlays();
    renderGame();
    showNPCDetails(npcId);
}
// ===================== 【新功能代码】社交玩法函数 END =======================
// =======================================================================
// ======================= 新增：徒弟槽位升级数据与功能 =====================
// =======================================================================

/**
 * 定义徒弟槽位升级的条件和成本
 * slot: 目标槽位数
 * req.level: 需要达到的职业等级 (玩家看到的等级，不是索引)
 * cost: 需要花费的银两
 * desc: 显示在按钮下方的描述文本
 */
const APPRENTICE_SLOT_UPGRADES = [
    // 玩家初始拥有 1 个槽位
    { slot: 2, req: { level: 3 }, cost: 5000, desc: "解锁第二个徒弟位 (需职业等级达到3级)" },
    { slot: 3, req: { level: 5 }, cost: 20000, desc: "解锁第三个徒弟位 (需职业等级达到5级)" },
    { slot: 4, req: { level: 8 }, cost: 50000, desc: "解锁第四个徒弟位 (需职业等级达到8级)" }
];

/**
 * 处理升级徒弟槽位的核心函数
 */
function upgradeApprenticeSlot() {
    const nextSlotNumber = gameState.apprenticeSlots + 1;
    const upgradeInfo = APPRENTICE_SLOT_UPGRADES.find(u => u.slot === nextSlotNumber);

    if (!upgradeInfo) {
        showToast("已达到最大徒弟数量。");
        return;
    }

    // 玩家看到的职业等级是 career.level 索引 + 1
    const playerCareerLevel = gameState.career.level + 1;
    const meetsLevelReq = playerCareerLevel >= upgradeInfo.req.level;
    const meetsWealthReq = gameState.finances.wealth >= upgradeInfo.cost;

    if (!meetsLevelReq) {
        showEventCard('条件不足', 'fa-times-circle', `你的职业等级尚未达到 ${upgradeInfo.req.level} 级，无法扩充师门。`);
        return;
    }

    if (!meetsWealthReq) {
        showEventCard('条件不足', 'fa-times-circle', `升级需要花费 ${upgradeInfo.cost} 两，你的资金不足。`);
        return;
    }

    // 所有条件都满足，弹出确认窗口
    showDecisionCard(
        '扩充师门',
        'fa-user-plus',
        `你确定要花费 <span class="value">${upgradeInfo.cost}</span> 两来扩充师门，解锁第 ${nextSlotNumber} 个徒弟位吗？`,
        [
            {
                htmlContent: `<i class="fas fa-check"></i> 确认升级`,
                callback: () => {
                    applyEffects({ wealth: -upgradeInfo.cost });
                    gameState.apprenticeSlots = nextSlotNumber;
                    showEventCard('师门壮大', 'fa-users', `你成功扩充了师门，现在可以招收 ${nextSlotNumber} 名徒弟了！`);
                    // 升级后，立刻刷新徒弟系统界面
                    showApprenticeSystem();
                }
            },
            {
                htmlContent: `<i class="fas fa-times"></i> 稍后再说`,
                style: `background:var(--control-bg);`,
                callback: () => closeAllOverlays()
            }
        ]
    );
}

// =======================================================================
// ===================== 【新增】立绘加载失败处理函数 =====================
// =======================================================================
function handleAvatarError(imgElement) {
    const maxRetries = 2;
    let retries = parseInt(imgElement.getAttribute('data-retries') || '0', 10);

    if (retries < maxRetries) {
        // 稍等片刻后重试，防止网络波动
        setTimeout(() => {
            // 通过在URL后添加一个随机参数来强制浏览器重新加载，而不是使用缓存
            const originalSrc = imgElement.src.split('?')[0];
            imgElement.src = `${originalSrc}?retry=${new Date().getTime()}`;
        }, 500);
        imgElement.setAttribute('data-retries', retries + 1);
    } else {
        // 重试次数用尽后，显示备用头像
        imgElement.style.display = 'none';
        const fallbackSvg = imgElement.nextElementSibling;
        if (fallbackSvg && fallbackSvg.classList.contains('avatar-svg')) {
            fallbackSvg.style.display = 'block';
        }
    }
}
// =======================================================================
// =================== 【新增】天命轮回录系统 - 数据 START ==================
// =======================================================================

// [用这个新版本完整替换] DUSTY_MIRROR_CONFIG 数据对象
const DUSTY_MIRROR_CONFIG = {
    virtue: {
        name: "德行之碑",
        icon: "fa-leaf",
        getData: (gs) => ({
            virtue: gs.player.attributes.virtue || 0,
            goodDeeds: gs.flags.goodDeeds || 0,
            badDeeds: gs.flags.badDeeds || 0,
            abandonedChild: gs.flags.abandonedChild || false,
            murdered: gs.flags.murdered || false
        }),
        ratings: [
            { level: 'S', name: '德侔天地', threshold: (data) => data.virtue > 180 && data.goodDeeds > 20 && !data.abandonedChild && !data.murdered,
              desc: "汝之名，已非朱墙所能困。城中孤儿谓汝为亲，陌上饥民视汝为神。万家生佛，德彰四海。纵史笔如刀，亦只能为汝之仁善，书下最华美之篇章。" },
            { level: 'A', name: '怀瑾握瑜', threshold: (data) => data.virtue > 120 && data.goodDeeds > data.badDeeds,
              desc: "一生行事，磊落光明。于友，肝胆相照；于亲，关怀备至。虽未至普济众生，然内心之光华，已足照亮身边之人，堪为世家典范。" },
            { level: 'B', name: '恪守其身', threshold: (data) => data.virtue >= 60,
              desc: "于善恶之间，汝多择中庸之道。不曾行大善，亦未犯大恶。一生循规蹈矩，恪守本心，如世间大多数人，平凡而安稳。" },
            { level: 'C', name: '利己之心', threshold: (data) => data.virtue < 60 && !data.abandonedChild && !data.murdered,
              desc: "汝之天平，多向自身倾斜。偶有善举，亦不过权衡利弊之选。于德行一途，终究未能摆脱利己之念，略有缺憾。" },
            { level: 'D', name: '业报随行', threshold: (data) => true,
              desc: "一条由冷漠与自私铺就之路。那些因你而起的悲泣与怨怼，已化作业障，于轮回路上，声声不息。" }
        ]
    },
    accomplishment: {
        name: "功业之鼎",
        icon: "fa-gavel",
        getData: (gs) => ({
            level: gs.career.level || 0,
            path: gs.career.path,
            hasMilestone3: gs.flags.achievedFinalMilestone || false,
            endGameTitle: gs.flags.end_game_title || null 
        }),
        ratings: [
            { level: 'S', name: '功盖千秋', threshold: (data) => data.hasMilestone3 || !!data.endGameTitle,
              desc: "汝已立于所属领域之巅。于朝堂，则为定国安邦之柱石；于沙场，则为令敌丧胆之军魂；于商界，则为富可敌国之传奇。汝之名，已是此道之丰碑，百年之后，亦为人所传颂。" },
            { level: 'A', name: '显赫一方', threshold: (data) => data.level >= 8,
              desc: "凭借过人之才干，汝于事业上建树颇丰。官居高位，或名动一方，为家族带来了无上荣光。虽未至顶峰，然已是常人难以企及之高度。" },
            { level: 'B', name: '克勤克俭', threshold: (data) => data.level >= 4,
              desc: "一生兢兢业业，于本职之内，未曾有过大疏漏。虽无惊天动地之功，然亦凭己之力，安身立命，为家族挣得一份体面。" },
            { level: 'C', name: '怀才不遇', threshold: (data) => data.path && data.level >= 1,
              desc: "空有满腹才华，却时运不济，或困于人际，或囿于眼界，终究未能大展拳脚。午夜梦回，可曾为虚度之光阴而叹惋？" },
            { level: 'D', name: '碌碌无为', threshold: (data) => true,
              desc: "于事业一途，未曾踏出坚实一步。或安于现状，或志大才疏，一生光阴流转，未能在世间留下任何功业之痕迹。" }
        ]
    },
    // =======================================================================
    // ====================== 【核心修改区域】情缘之卷 START ===================
    // =======================================================================
    bonds: {
        name: "情缘之卷",
        icon: "fa-users",
        // [新增判定] getData函数现在会收集更丰富的数据用于“钟情”判定
        getData: (gs) => {
            const spouse = gs.marriage.isMarried ? gs.npcs[gs.marriage.spouseId] : null;
            const spouseRel = spouse ? gs.social.relationships[spouse.id] : null;
            return {
                lovers: (gs.social.secretLovers || []).length, // 情人数量
                spouseFavor: spouse ? spouse.favor : -1000, // 配偶好感度
                spouseRelLevel: spouseRel ? (spouseRel.level || 0) : 0, // 配偶关系等级
                divorced: gs.flags.hasDivorced || false, // 是否和离
                loverAffairExposed: gs.flags.loverAffairExposed || false, // 私情是否败露
            };
        },
        // [核心修改] 评级类目、判定逻辑和描述文本已全部重写，以“钟情”为核心
        ratings: [
            { level: 'S', name: '情深不渝', threshold: (data) => data.spouseFavor >= 95 && data.spouseRelLevel >= 4 && data.lovers === 0 && !data.divorced,
              desc: "一生一代一双人，争教两处销魂。汝之深情，坚如磐石，未曾为路边风光动摇分毫。于枕边人，汝付出了全部真心，成就了一段世间难觅的佳话。" },
            { level: 'A', name: '琴瑟和鸣', threshold: (data) => data.spouseFavor >= 80 && data.spouseRelLevel >= 2 && data.lovers <= 1 && !data.divorced && !data.loverAffairExposed,
              desc: "夫妻同心，其利断金。汝之一生，以家庭为重，与伴侣相濡以沫，虽偶有波澜，终是举案齐眉，共度白首。此等情缘，亦是人间之福。" },
            { level: 'D', name: '覆水难收', threshold: (data) => data.divorced || data.loverAffairExposed || data.spouseFavor <= -50,
              desc: "薄情寡义，终至覆水难收。或因私情败露而声名狼藉，或因夫妻反目而劳燕分飞。镜中孤影，形单影只，皆为汝亲手所造之因果。" },
            { level: 'B', name: '相敬如宾', threshold: (data) => data.spouseFavor >= 40,
              desc: "与枕边之人，汝做到了以礼相待，相敬如宾。虽少了几分痴缠爱恋，却也维系了家庭的体面与平和。一生波澜不惊，也无刻骨铭心。" },
            { level: 'C', name: '镜花水月', threshold: (data) => true,
              desc: "汝沉湎于镜花水月之情，流连于花丛之间，却忘了家中等待之人。真心几许，假意几分，终究是雾里看花，未能寻得一人心。" }
        ]
    },
    // ====================== 【核心修改区域】情缘之卷 END =====================
    // =======================================================================
    clan: {
        name: "家族之谱",
        icon: "fa-sitemap",
        getData: (gs) => ({
            children: gs.children.filter(c => c.age >= 16 && !c.isDead).length,
            grandchildren: gs.children.filter(c => c.marriage.isMarried && c.marriage.grandchildTimer === -1).length,
            successfulChildren: gs.children.filter(c => c.career && c.career.path !== 'unemployed' && c.career.level >= 4).length
        }),
        ratings: [
            { level: 'S', name: '兰桂齐芳', threshold: (data) => data.children >= 5 && data.successfulChildren >= 2 && data.grandchildren > 0,
              desc: "汝之血脉，已成参天大树。子孙或为朝堂新贵，或为商界巨子，皆为一时俊杰。开枝散叶，满门荣光。汝为家族之兴盛，立下了不世之功。" },
            { level: 'A', name: '子孙满堂', threshold: (data) => data.children >= 3,
              desc: "儿孙绕膝，共享天伦。虽非个个龙凤，然亦多有成才者，足以延续家族荣光。汝之膝下，人丁兴旺，福气绵延。" },
            { level: 'B', name: '延续香火', threshold: (data) => data.children >= 1,
              desc: "汝留有子嗣，使家族得以延续。孩子们平安成长，成家立业，虽无大富大贵，亦算尽了为人父母之责。" },
            { level: 'C', name: '子嗣凋零', threshold: (data) => data.children > 0 && data.successfulChildren === 0,
              desc: "或因子嗣稀少，或因教养不善，汝之下一代未能扛起家族重任。血脉虽存，然家族之未来，已现隐忧。" },
            { level: 'D', name: '后继无人', threshold: (data) => data.children === 0,
              desc: "一生蹉跎，未留半点血脉于世。家族之传承，于汝这一代，戛然而止。百年之后，无人再记汝之名姓。" }
        ]
    },
    wealth: {
        name: "财富之库",
        icon: "fa-coins",
        getData: (gs) => ({
            totalAssets: gs.finances.wealth + (gs.player.privateAssets || 0) + gs.family.moneyChest + gs.finances.assets.reduce((sum, a) => sum + (a.currentValue || 0), 0) + (gs.tradingSystem.moneyChest || 0),
            tier: gs.finances.financialTier
        }),
        ratings: [
            { level: 'S', name: '富可敌国', threshold: (data) => data.tier >= 6 && data.totalAssets > 500000,
              desc: "金玉满堂，富埒王侯。汝之财富，足以撼动国之经济。‘财神’之名，于汝而言，非是虚誉。" },
            { level: 'A', name: '豪门巨富', threshold: (data) => data.tier >= 5 && data.totalAssets > 100000,
              desc: "良田千顷，华屋万间。汝之一生，于财富之道上，经营有方，积累了惊人的家业，足以令子孙三代衣食无忧。" },
            { level: 'B', name: '殷实之家', threshold: (data) => data.tier >= 3,
              desc: "吃穿不愁，小有盈余。汝凭勤劳与智慧，过上了殷实富足的生活，于市井之中，亦是令人艳羡之家。" },
            { level: 'C', name: '勉强度日', threshold: (data) => data.tier >= 2,
              desc: "一生为生计所困，虽未至颠沛流离，然亦时常捉襟见肘。‘财’之一字，终究是汝心中挥之不去之愁云。" },
            { level: 'D', name: '债台高筑', threshold: (data) => data.totalAssets < 0,
              desc: "家徒四壁，债主盈门。汝非但未能积累财富，反而欠下累累巨债，为家族留下无尽之负担。" }
        ]
    },
    talents: {
        name: "才学之璧",
        icon: "fa-brain",
        getData: (gs) => {
            const attrs = gs.player.attributes;
            return {
                attributes: attrs,
                total: (attrs.talent || 0) + (attrs.wisdom || 0) + (attrs.charm || 0) + (attrs.etiquette || 0) + (attrs.martial || 0) + (attrs.health || 0)
            };
        },
        ratings: [
            { level: 'S', name: '文武双全', threshold: (data) => Object.values(data.attributes).filter(v => v > 180).length >= 2,
              desc: "汝乃不世出之奇才。上知天文，下晓地理，文能提笔安天下，武能上马定乾坤。汝之存在，本身便是一段传奇。" },
            { level: 'A', name: '颖悟绝伦', threshold: (data) => Object.values(data.attributes).some(v => v > 150),
              desc: "于某一道，汝有惊世之才。或为智计无双之谋士，或为风华绝代之名姝。汝之才华，足以令世人瞩目。" },
            { level: 'B', name: '颇有才干', threshold: (data) => data.total > 400,
              desc: "汝于修身养性上，小有成就。谈吐不俗，举止得体，于人前总能展现出良好风貌。" },
            { level: 'C', name: '资质平平', threshold: (data) => data.total <= 400 && data.total > 200,
              desc: "汝之才学，与常人无异。未曾有过人之处，亦无明显之短板。" },
            { level: 'D', name: '愚钝驽马', threshold: (data) => true,
              desc: "于才学之道，未曾用心。一生浑浑噩噩，与草木同朽。" }
        ]
    }
};
const POSTHUMOUS_TITLES_CONFIG = {
    rules: [
        { condition: (r) => r.virtue === 'S' && r.accomplishment === 'S', title: '德劭功勋' },
        { condition: (r) => r.wealth === 'S' && r.virtue === 'D', title: '为富不仁' },
        { condition: (r) => r.accomplishment === 'S' && r.bonds === 'D', title: '孤傲的巨匠' },
        { condition: (r) => r.clan === 'S', title: '兰桂齐芳' },
        { condition: (r) => r.bonds === 'A' && r.talents === 'A' && ['C','D'].includes(r.accomplishment), title: '雅士风流' },
        { condition: (r) => r.bonds === 'D' && r.clan === 'D', title: '一世伶仃' },
    ],
    defaults: {
        S: { virtue: '圣德', accomplishment: '武勋', bonds: '情圣', clan: '始祖', wealth: '财神', talents: '文宗' },
        A: { virtue: '仁善', accomplishment: '功业', bonds: '义气', clan: '兴家', wealth: '豪富', talents: '雅才' },
        C: { virtue: '薄德', accomplishment: '平庸', bonds: '寡情', clan: '凋零', wealth: '贫乏', talents: '浅薄' },
        D: { virtue: '无道', accomplishment: '无为', bonds: '孤僻', clan: '绝后', wealth: '赤贫', talents: '愚钝' },
        B: '平凡是福'
    }
};

const INHERITANCE_TALENT_TREE = {
    virtue: { name: '德行之荫', tiers: [
        { cost: 10, id: 'renxin', name: '仁心', desc: '初始品德+20', effects: { attributes: { virtue: 20 } } },
        { cost: 15, id: 'shanyuan', name: '善缘', desc: '初始与父母好感度+30', effects: {} }
    ]},
    accomplishment: { name: '功业之承', tiers: [
        { cost: 15, id: 'jiaxue', name: '家学渊源', desc: '若选择与上一代相同职业，初始职业等级+1', effects: {} },
        { cost: 20, id: 'xianbei', name: '先辈之名', desc: '初始声望+80', effects: { reputation: 80 } }
    ]},
    bonds: { name: '情缘之缘', tiers: [
        { cost: 10, id: 'taohua', name: '桃花运', desc: '提升遇到高魅力值NPC的几率', effects: { flags: { hasPeachBlossomLuck: true } } },
        { cost: 15, id: 'jiushi', name: '旧时相识', desc: '必定遇到上一代挚友的子嗣，并获得50点初始好感', effects: {} }
    ]},
    clan: { name: '家族之基', tiers: [
        { cost: 10, id: 'feng厚', name: '丰厚私产', desc: '初始个人私产增加5000两', effects: { privateAssets: 5000 } },
        { cost: 20, id: 'gaomen', name: '高门起点', desc: '新游戏开始时，家族声望额外+50', effects: { reputation: 50 } }
    ]},
    wealth: { name: '财富之源', tiers: [
        { cost: 5, id: 'yichan', name: '遗产继承', desc: '直接继承上一代最终财富的2% (可重复购买)', effects: {}, repeatable: true, multiplier: 0.02 },
        { cost: 20, id: 'shangye', name: '商业嗅觉', desc: '在商会交易和产业投资中，有更高几率触发正面事件', effects: { flags: { hasBusinessSense: true } } }
    ]},
    talents: { name: '才学之赋', tiers: [
        { cost: 2, id: 'jichu', name: '基础属性', desc: '任意选择一项基础六维属性+1 (可重复购买)', effects: {}, repeatable: true, isAttribute: true },
        { cost: 25, id: 'tianzi', name: '天资聪颖', desc: '所有通过“修身”获得的属性增加15%', effects: { flags: { isGifted: true } } }
    ]}
};

const WORLDLY_RELICS_DATA = {
    virtue: { id: 'wan_min_san', name: '万民伞', type: '珍品', icon: 'fa-umbrella', desc: '持有者品德每月自动+1，且在任何地区都不会被地痞骚扰。' },
    accomplishment: { id: 'xian_bei_yin_xin', name: '先辈印信', type: '珍品', icon: 'fa-stamp', desc: '根据上一代的职业，提供强大的被动加成。' },
    bonds: { id: 'zhi_jiao_ming_lu', name: '知交名录', type: '文书', icon: 'fa-address-book', desc: '必定触发“旧时相识”事件，且与故人之子（最多3位）初始关系为“惺惺相惜”。' },
    clan: { id: 'chuan_jia_yu_pei', name: '传家玉佩', type: '珍品', icon: 'fa-gem', desc: '佩戴者魅力+15, 礼仪+15，且子嗣诞生时，有更高几率获得正面性格特质。' },
    wealth: { id: 'ju_bao_pen_buff', name: '聚宝盆的传说', type: 'BUFF', icon: 'fa-magic', desc: '一个永久buff。所有非俸禄的金钱收入增加10%。' },
    talents: { id: 'wu_zi_tian_shu', name: '无字天书', type: '珍品', icon: 'fa-book-dead', desc: '每回合可进行一次“参悟”，随机提升一项基础属性5-10点。' }
};

let inheritanceState = {}; // 用于存储传承界面的临时状态

// =======================================================================
// =================== 【新增】天命轮回录系统 - 函数 START ==================
// =======================================================================

/**
 * 游戏结束时启动天命轮回录系统的总入口
 */
function startDestinyCycle() {
    const ratings = calculateDustyMirrorRatings();
    showDustyMirrorUI(ratings);
}

/**
 * 计算尘缘镜的六大维度评级
 * @returns {object} - 包含所有维度评级、数据和谥号的对象
 */
function calculateDustyMirrorRatings() {
    let results = {};
    for (const key in DUSTY_MIRROR_CONFIG) {
        const config = DUSTY_MIRROR_CONFIG[key];
        const data = config.getData(gameState);
        for (const rating of config.ratings) {
            if (rating.threshold(data)) {
                results[key] = {
                    level: rating.level,
                    name: rating.name,
                    desc: rating.desc,
                    config: config
                };
                break;
            }
        }
    }
    results.posthumousTitle = generatePosthumousTitle(results);
    return results;
}

/**
 * 生成谥号
 * @param {object} ratings - 六大维度的评级结果
 * @returns {string} - 最终的谥号
 */
function generatePosthumousTitle(ratings) {
    for (const rule of POSTHUMOUS_TITLES_CONFIG.rules) {
        if (rule.condition(Object.fromEntries(Object.entries(ratings).map(([k, v]) => [k, v.level])))) {
            return rule.title;
        }
    }
    const levels = Object.values(ratings).map(r => r.level);
    if (levels.every(l => l === 'B')) return POSTHUMOUS_TITLES_CONFIG.defaults.B;

    const highestLevel = ['S', 'A', 'B', 'C', 'D'].find(l => levels.includes(l));
    const highestRatedDimension = Object.keys(ratings).find(k => ratings[k].level === highestLevel);
    
    return POSTHUMOUS_TITLES_CONFIG.defaults[highestLevel][highestRatedDimension];
}

/**
 * 显示尘缘镜UI
 * @param {object} ratings - 评级结果
 */
function showDustyMirrorUI(ratings) {
    const overlay = document.getElementById('dustyMirrorOverlay');
    let gridHTML = '';

    for(const key in ratings) {
        if (key === 'posthumousTitle') continue;
        const data = ratings[key];
        gridHTML += `
            <div class="dimension-card">
                <div class="dimension-header">
                    <div class="dimension-rating rating-${data.level}">${data.level}</div>
                    <div class="dimension-name">${data.name}</div>
                </div>
                <div class="dimension-comment">“${data.desc}”</div>
            </div>
        `;
    }

    overlay.innerHTML = `
        <div class="overlay-card">
            <h2 class="mirror-title">尘缘镜</h2>
            <div class="posthumous-title">${ratings.posthumousTitle}</div>
            <div class="mirror-grid">${gridHTML}</div>
            <button class="control-btn" style="margin-top: 15px;" onclick='showInheritanceBookUI(${JSON.stringify(ratings)})'>
                <i class="fas fa-arrow-right"></i> 开启《承世书》
            </button>
        </div>
    `;
    showOverlay('dustyMirrorOverlay');
}

/**
 * 显示承世书（继承）UI
 * @param {object} ratings - 从尘缘镜传来的评级结果
 */
function showInheritanceBookUI(ratings) {
    const heirs = gameState.children.filter(c => c.age >= 16 && !c.isDead);
    if (heirs.length === 0) {
        showEventCard('后继无人', 'fa-sad-cry', '你没有成年的子嗣可以继承你的遗志，人生就此落幕。', [{
            text: '开启全新人生',
            callback: () => startNewGame(gameState.player.gender)
        }]);
        return;
    }
    
    // 计算承世点
    const ratingPoints = { S: 60, A: 40, B: 20, C: 10, D: 0 };
    let totalPoints = Object.values(ratings).reduce((sum, r) => sum + (ratingPoints[r.level] || 0), 0);
    const finalWealth = DUSTY_MIRROR_CONFIG.wealth.getData(gameState).totalAssets;
    totalPoints += Math.floor(finalWealth / 10000);
    // 谥号附加点 (简化)
    if (ratings.posthumousTitle === '德劭功勋') totalPoints += 50;
    if (ratings.posthumousTitle === '为富不仁') totalPoints -= 20;

    const relics = [];
    for (const key in ratings) {
        if (ratings[key].level === 'S' && WORLDLY_RELICS_DATA[key]) {
            relics.push(WORLDLY_RELICS_DATA[key]);
        }
    }

    inheritanceState = {
        totalPoints: totalPoints,
        spentPoints: 0,
        heirs: heirs,
        selectedHeirId: null,
        relics: relics,
        chosenTalents: {},
        baseAttributePoints: 0,
    };
    
    const overlay = document.getElementById('inheritanceBookOverlay');
    overlay.innerHTML = `
        <div class="overlay-card">
            <h2 class="mirror-title">承世书</h2>
            <div class="overlay-content-wrapper">
                <div class="heir-selection-container">
                    <h4>选择一位子嗣，继承你的遗志</h4>
                    <div class="heir-list" id="heir-list-container"></div>
                </div>
                <div id="talent-tree-wrapper" style="display:none;">
                     <div class="points-display">承世点: <span id="points-remaining">${totalPoints}</span></div>
                     <div class="talent-tree-container" id="talent-tree-container"></div>
                </div>
                <div class="relics-container" id="relics-container"></div>
            </div>
            <button class="control-btn" id="confirm-inheritance-btn" style="margin-top: 15px; display:none;" onclick="confirmInheritance()">
                <i class="fas fa-child"></i> 开启新的人生
            </button>
        </div>
    `;
    
    renderHeirSelection();
    renderRelics();
    showOverlay('inheritanceBookOverlay');
}

function renderHeirSelection() {
    const container = document.getElementById('heir-list-container');
    container.innerHTML = inheritanceState.heirs.map(heir => `
        <div class="heir-card" id="heir-${heir.id}" onclick="selectHeir('${heir.id}')">
            <div class="avatar-wrapper" style="width: 60px; height: 60px; margin: 0 auto 5px;">
                <img src="${heir.avatar}" class="avatar-image" style="display:block;">
            </div>
            <strong>${heir.name}</strong>
        </div>
    `).join('');
}

function selectHeir(heirId) {
    inheritanceState.selectedHeirId = heirId;
    document.querySelectorAll('.heir-card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`heir-${heirId}`).classList.add('selected');

    document.getElementById('talent-tree-wrapper').style.display = 'block';
    document.getElementById('confirm-inheritance-btn').style.display = 'block';
    renderTalentTree();
}

function renderTalentTree() {
    const container = document.getElementById('talent-tree-container');
    let html = '';
    for(const branchKey in INHERITANCE_TALENT_TREE) {
        const branch = INHERITANCE_TALENT_TREE[branchKey];
        html += `<div class="talent-branch"><div class="talent-branch-header">${branch.name}</div><div class="talent-tier">`;
        branch.tiers.forEach(talent => {
            const isBought = inheritanceState.chosenTalents[talent.id];
            const canAfford = inheritanceState.totalPoints - inheritanceState.spentPoints >= talent.cost;
            let buttonHTML = '';

            if(isBought) {
                buttonHTML = `<button class="btn-bought" disabled>已习得</button>`;
            } else if (canAfford) {
                buttonHTML = `<button class="btn-buy" onclick="buyTalent('${talent.id}', ${talent.cost})">学习 (${talent.cost}点)</button>`;
            } else {
                buttonHTML = `<button class="btn-locked" disabled>点数不足</button>`;
            }

            html += `
                <div class="talent-node">
                    <strong>${talent.name}</strong>
                    <small>${talent.desc}</small>
                    ${buttonHTML}
                </div>
            `;
        });
        html += `</div></div>`;
    }
    container.innerHTML = html;
}

function buyTalent(talentId, cost) {
    if (inheritanceState.totalPoints - inheritanceState.spentPoints < cost) return;
    
    const talentInfo = Object.values(INHERITANCE_TALENT_TREE).flatMap(b => b.tiers).find(t => t.id === talentId);
    
    // 特殊处理可重复购买的属性点
    if (talentInfo.isAttribute) {
        let attrToBoost = prompt("要为哪个属性+1？（请输入：才情, 智慧, 魅力, 礼仪, 武学, 健康, 品德）");
        const attrMapReverse = Object.fromEntries(Object.entries(ATTR_MAP).map(a => a.reverse()));
        const attrKey = attrMapReverse[attrToBoost];
        if (attrKey && gameState.player.attributes.hasOwnProperty(attrKey)) {
            inheritanceState.baseAttributePoints++;
            inheritanceState.chosenTalents[`${talentId}_${attrKey}_${inheritanceState.baseAttributePoints}`] = talentInfo.effects;
        } else {
            showToast("无效的属性名称！");
            return; // 购买失败，不扣点数
        }
    } else {
        inheritanceState.chosenTalents[talentId] = talentInfo.effects;
    }
    
    inheritanceState.spentPoints += cost;
    document.getElementById('points-remaining').textContent = inheritanceState.totalPoints - inheritanceState.spentPoints;
    renderTalentTree();
}

function renderRelics() {
    const container = document.getElementById('relics-container');
    if (inheritanceState.relics.length === 0) {
        container.style.display = 'none';
        return;
    }
    container.innerHTML = `<div class="talent-branch-header">旷世遗物 (S级维度奖励)</div>` + inheritanceState.relics.map(relic => `
        <div class="relic-item">
            <div class="relic-icon"><i class="fas ${relic.icon}"></i></div>
            <div class="relic-details">
                <strong>${relic.name}</strong>
                <div class="comment">${relic.desc}</div>
            </div>
        </div>
    `).join('');
}

/**
 * 确认继承，并开启新游戏
 */
function confirmInheritance() {
    if (!inheritanceState.selectedHeirId) {
        showToast("请先选择一位继承人。");
        return;
    }
    const heirData = inheritanceState.heirs.find(h => h.id === inheritanceState.selectedHeirId);
    
    let combinedEffects = {
        attributes: {},
        flags: {},
        items: [],
        bonuses: {} // 用于存储特殊加成
    };

    // 1. 合并天赋树效果
    for (const talentId in inheritanceState.chosenTalents) {
        const effects = inheritanceState.chosenTalents[talentId];
        if (!effects) continue;
        
        if (talentId.startsWith('jichu')) { // 基础属性点
             const attrKey = talentId.split('_')[1];
             combinedEffects.attributes[attrKey] = (combinedEffects.attributes[attrKey] || 0) + 1;
        } else {
            Object.assign(combinedEffects.attributes, effects.attributes || {});
            Object.assign(combinedEffects.flags, effects.flags || {});
            // 处理其他类型的效果...
            if(talentId === 'jiaxue') combinedEffects.bonuses.careerLevelBonus = 1;
            if(talentId === 'yichan') combinedEffects.bonuses.wealthMultiplier = (combinedEffects.bonuses.wealthMultiplier || 0) + 0.02;
        }
    }

    // 2. 添加旷世遗物
    inheritanceState.relics.forEach(relic => {
        combinedEffects.items.push(relic);
        // 如果是buff，直接加入flags
        if (relic.type === 'BUFF') {
            combinedEffects.flags[relic.id] = true;
        }
    });
    
    // 3. 准备启动新游戏的数据
    const inheritancePackage = {
        name: heirData.name,
        age: heirData.age,
        avatar: heirData.avatar,
        baseAttributes: heirData.attributes,
        effects: combinedEffects,
        previousCareerPath: gameState.career.path,
        previousWealth: DUSTY_MIRROR_CONFIG.wealth.getData(gameState).totalAssets
    };

    startNewGame(heirData.gender, inheritancePackage);
}
// =======================================================================
// ===================== 【新增】强大的开发者作弊功能 =====================
// =======================================================================

/**
 * 新增功能：为当前人生应用所有“承世书”中的天赋
 */
function debug_applyAllTalents() {
    if (!confirm("确定要为当前人生应用所有天赋吗？这会消耗大量承世点（模拟），并可能让游戏变得简单。")) {
        return;
    }

    let effects = { attributes: {}, flags: {}, items: [], bonuses: {} };
    const baseAttrPoints = parseInt(prompt("要为六维基础属性（才情、智慧等）各增加多少点？", "100")) || 0;

    // 1. 遍历并合并所有天赋效果
    for (const branchKey in INHERITANCE_TALENT_TREE) {
        INHERITANCE_TALENT_TREE[branchKey].tiers.forEach(talent => {
            if (talent.isAttribute) {
                // 为所有基础属性增加点数
                Object.keys(ATTR_MAP).forEach(attrKey => {
                    if(effects.attributes[attrKey] !== undefined) {
                       effects.attributes[attrKey] = (effects.attributes[attrKey] || 0) + baseAttrPoints;
                    }
                });
            } else {
                // 合并普通天赋
                Object.assign(effects.attributes, talent.effects.attributes || {});
                Object.assign(effects.flags, talent.effects.flags || {});
                if (talent.id === 'jiaxue') effects.bonuses.careerLevelBonus = 1;
                if (talent.id === 'yichan') effects.bonuses.wealthMultiplier = (effects.bonuses.wealthMultiplier || 0) + 0.02;
            }
        });
    }

    // 2. 应用效果到当前游戏
    applyEffects({ attributes: effects.attributes });
    Object.assign(gameState.flags, effects.flags);

    // 3. 处理特殊加成
    if (effects.bonuses.careerLevelBonus && gameState.career.path) {
        gameState.career.level = Math.min(gameState.career.level + 1, careerPaths[gameState.player.gender][gameState.career.path].levels.length - 1);
    }

    showToast("所有天赋已应用至当前人生！");
    closeAllOverlays();
    renderGame();
}

/**
 * 新增功能：切换无限行动点模式
 */
function toggleUnlimitedActions() {
    gameState.flags.debug_unlimitedActions = !gameState.flags.debug_unlimitedActions;
    const status = gameState.flags.debug_unlimitedActions ? "开启" : "关闭";
    showToast(`无限行动点模式已 ${status}！`);
    // 刷新主界面以显示正确的剩余次数
    if(gameState.flags.activeTab === 'main') {
        updateActiveTab('main');
    }
}

/**
 * 新增功能：跳过回合 (结束人生的快捷方式)
 */
function skipTurns(numberOfTurns) {
    if (isProcessing) return;
    
    if (!confirm(`确定要跳过 ${numberOfTurns} 个回合（10年）吗？游戏将自动处理所有事件，这可能需要一些时间。`)) {
        return;
    }

    closeAllOverlays();
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingOverlay.style.display = 'flex';
    loadingText.innerText = '光阴似箭，岁月如梭...';

    isProcessing = true;
    gameState.flags.isBatchProcessing = true; // 设置一个全局标志，让弹窗函数知道不要显示UI

    let turnsSkipped = 0;

    function processSingleTurn() {
        if (turnsSkipped >= numberOfTurns || checkEndGame()) { // 如果游戏已结束，也停止
            // 所有回合处理完毕
            gameState.flags.isBatchProcessing = false;
            isProcessing = false;
            loadingOverlay.style.display = 'none';
            if(!checkEndGame()){
                 showToast(`成功跳过了 ${turnsSkipped / 2} 年！`);
                 renderGame(); // 最后刷新一次游戏界面
            }
            return;
        }

        nextTurn();
        turnsSkipped++;
        loadingText.innerText = `光阴似箭... 正在处理第 ${turnsSkipped} / ${numberOfTurns} 回合`;

        // 使用 setTimeout 创建一个微小的延迟，以防止浏览器因密集计算而卡死
        setTimeout(processSingleTurn, 50); 
    }

    processSingleTurn();
}

// =======================================================================
// =================== 【新增】天命轮回录系统 - 函数 END ====================
// =======================================================================
window.onload = function() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    setTimeout(() => {
        initGame();
        if (!document.body.dataset.theme) {
             document.body.dataset.theme = 'spring';
        }
        updateParticles('spring');
    }, 1000);
};

</script>
</body>
</html>






